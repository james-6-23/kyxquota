<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - KYX API Refueling Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>âš™ï¸</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .refresh-spin {
      animation: spin 0.6s ease-in-out;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }
    
    /* ğŸ”¥ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* ä¾§è¾¹æ å¯¼èˆªé¡¹åŠ¨ç”» */
    .nav-link {
      position: relative;
      overflow: hidden;
      user-select: none; /* ç¦æ­¢æ–‡å­—è¢«é€‰ä¸­ */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    /* ç¦ç”¨æ–‡å­—é€‰æ‹©æ—¶çš„èƒŒæ™¯é«˜äº® */
    .nav-link::selection {
      background: transparent;
    }
    
    .nav-link::-moz-selection {
      background: transparent;
    }
    
    .nav-link *::selection {
      background: transparent;
    }
    
    .nav-link *::-moz-selection {
      background: transparent;
    }
    
    .nav-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, #6366f1, #8b5cf6);
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }
    
    .nav-link:hover::before,
    .nav-link.active::before {
      transform: scaleY(1);
    }
    
    /* æœç´¢é«˜äº® */
    .nav-link.search-highlight {
      background-color: #fef3c7 !important;
      animation: pulse 1s ease-in-out 2;
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  <!-- Loading Section -->
  <div id="loadingSection" class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-white text-lg">éªŒè¯ç™»å½•ä¸­...</p>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
      <div class="flex justify-center mb-6">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full blur-xl opacity-50 animate-pulse"></div>
          <div class="relative bg-gradient-to-br from-indigo-500 to-purple-600 p-4 rounded-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
        </div>
      </div>
      <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">ç®¡ç†å‘˜åå°</h1>
      <p class="text-center text-slate-600 mb-8 text-sm">âš™ï¸ ç³»ç»Ÿç®¡ç†æ§åˆ¶å°</p>
      <input type="password" id="password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " class="w-full px-4 py-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
      <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
        ç™»å½•
      </button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminSection" class="hidden min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <h1 class="text-xl font-bold text-slate-900">KYX API ç®¡ç†åå°</h1>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">ç®¡ç†å‘˜</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="flex">
      <!-- ğŸ”¥ å›ºå®šä¾§è¾¹æ  + è‡ªå®šä¹‰æ»šåŠ¨æ¡ -->
      <aside class="w-64 bg-white border-r border-slate-200 fixed left-0 top-16 bottom-0 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100">
        <!-- æœç´¢æ  -->
        <div class="p-4 border-b border-slate-200 bg-slate-50 sticky top-0 z-10">
          <div class="relative">
            <input type="text" 
                   id="sidebarSearch" 
                   placeholder="ğŸ” æœç´¢åŠŸèƒ½..." 
                   oninput="filterSidebar(this.value)"
                   class="w-full px-3 py-2 pr-8 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <button onclick="clearSidebarSearch()" class="absolute right-2 top-2 text-slate-400 hover:text-slate-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <nav class="p-3">
          <!-- ğŸ“Š åŸºç¡€ç®¡ç† -->
          <div class="mb-4">
            <div class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ“Š åŸºç¡€ç®¡ç†</div>
            <button onclick="showSection('dashboard')" data-search="ä»ªè¡¨æ¿ dashboard é¦–é¡µ" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 bg-indigo-100 text-indigo-700 font-semibold flex items-center gap-2 hover:bg-indigo-200 transition-all">
              <span>ğŸ“Š</span> <span>ä»ªè¡¨æ¿</span>
            </button>
            <button onclick="showSection('config')" data-search="ç³»ç»Ÿé…ç½® config è®¾ç½®" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
              <span>âš™ï¸</span> <span>ç³»ç»Ÿé…ç½®</span>
            </button>
            <button onclick="showSection('keys')" data-search="keys ç®¡ç†" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
              <span>ğŸ”‘</span> <span>Keys ç®¡ç†</span>
            </button>
            <button onclick="showSection('users')" data-search="ç”¨æˆ·åˆ—è¡¨ users ç”¨æˆ·ç®¡ç†" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
              <span>ğŸ‘¥</span> <span>ç”¨æˆ·åˆ—è¡¨</span>
            </button>
            <button onclick="showSection('bannedUsers')" data-search="å°ç¦è®°å½• banned é»‘åå•" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
              <span>ğŸš«</span> <span>å°ç¦è®°å½•</span>
            </button>
          </div>
          
          <!-- ğŸ“‹ è®°å½•æŸ¥è¯¢ -->
          <details class="mb-4 group" open>
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ“‹ è®°å½•æŸ¥è¯¢</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('claims')" data-search="é¢†å–è®°å½• claims é¢†å–" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ“¥</span> <span>é¢†å–è®°å½•</span>
              </button>
              <button onclick="showSection('donates')" data-search="æŠ•å–‚è®°å½• donates æŠ•å–‚" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ</span> <span>æŠ•å–‚è®°å½•</span>
              </button>
              <button onclick="showSection('slotRecords')" data-search="åˆçº§åœºè®°å½• slot è€è™æœº" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ°</span> <span>åˆçº§åœºè®°å½•</span>
              </button>
              <button onclick="showSection('advancedSlotRecords')" data-search="é«˜çº§åœºè®°å½• advanced é«˜çº§" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ”¥</span> <span>é«˜çº§åœºè®°å½•</span>
              </button>
              <button onclick="showSection('supremeRecords')" data-search="è‡³å°Šåœºè®°å½• supreme è‡³å°Š" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ†</span> <span>è‡³å°Šåœºè®°å½•</span>
              </button>
              <button onclick="showSection('ticketDropRecords')" data-search="å…¥åœºåˆ¸æ‰è½ ticket æ‰è½" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸŸï¸</span> <span>å…¥åœºåˆ¸æ‰è½</span>
              </button>
            </div>
          </details>
          
          <!-- ğŸ° æ¸¸æˆé…ç½® -->
          <details class="mb-4 group" open>
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ° æ¸¸æˆé…ç½®</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('slotConfig')" data-search="è€è™æœºé…ç½® slot åˆçº§åœº" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>âš™ï¸</span> <span>è€è™æœºé…ç½®</span>
              </button>
              <button onclick="showSection('advancedSlotConfig')" data-search="é«˜çº§åœºé…ç½® advanced é«˜çº§" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ”¥</span> <span>é«˜çº§åœºé…ç½®</span>
              </button>
              <button onclick="showSection('supremeConfig')" data-search="è‡³å°Šåœºé…ç½® supreme è‡³å°Š" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ’</span> <span>è‡³å°Šåœºé…ç½®</span>
              </button>
              <button onclick="showSection('weightConfigs')" data-search="æƒé‡é…ç½®ç®¡ç† weight æƒé‡" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>âš–ï¸</span> <span>æƒé‡é…ç½®</span>
              </button>
              <button onclick="showSection('rewardConfigs')" data-search="å¥–åŠ±é…ç½®ç®¡ç† reward å¥–åŠ±" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ</span> <span>å¥–åŠ±é…ç½®</span>
              </button>
              <button onclick="showSection('dropConfigs')" data-search="æ‰è½é…ç½®ç®¡ç† drop æ‰è½" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ²</span> <span>æ‰è½é…ç½®</span>
              </button>
            </div>
          </details>
          
          <!-- ğŸ“ˆ æ•°æ®åˆ†æ -->
          <details class="mb-4 group">
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ“ˆ æ•°æ®åˆ†æ</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('slotAnalytics')" data-search="æŠ½å¥–åˆ†æ analytics æ•°æ®" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ“ˆ</span> <span>æŠ½å¥–åˆ†æ</span>
              </button>
              <button onclick="showSection('profitLeaderboard')" data-search="ç›ˆåˆ©æ’è¡Œæ¦œ profit ç›ˆåˆ©" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ†</span> <span>ç›ˆåˆ©æ’è¡Œæ¦œ</span>
              </button>
              <button onclick="showSection('lossLeaderboard')" data-search="äºæŸæ’è¡Œæ¦œ loss äºæŸ" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ“‰</span> <span>äºæŸæ’è¡Œæ¦œ</span>
              </button>
            </div>
          </details>
          
          <!-- ğŸ” å¤å‘—ç³»ç»Ÿ -->
          <details class="mb-4 group">
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ” å¤å‘—ç³»ç»Ÿ</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('kunbeiManagement')" data-search="å¤å‘—è´·æ¬¾ç®¡ç† kunbei è´·æ¬¾" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ”</span> <span>è´·æ¬¾ç®¡ç†</span>
              </button>
              <button onclick="showSection('kunbeiRecords')" data-search="è´·æ¬¾è®°å½• kunbei records" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ“‹</span> <span>è´·æ¬¾è®°å½•</span>
              </button>
            </div>
          </details>
          
          <!-- ğŸ è¿è¥å·¥å…· -->
          <details class="mb-4 group">
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ è¿è¥å·¥å…·</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('grantFreeSpins')" data-search="å‘æ”¾å…è´¹æ¬¡æ•° grant å‘æ”¾" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ</span> <span>å‘æ”¾å…è´¹æ¬¡æ•°</span>
              </button>
              <button onclick="showSection('pendingRewards')" data-search="å¾…å‘æ”¾å¥–é‡‘ pending å¥–é‡‘" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ’°</span> <span>å¾…å‘æ”¾å¥–é‡‘</span>
              </button>
            </div>
          </details>

          <!-- ğŸ† æˆå°±ç³»ç»Ÿ -->
          <details class="mb-4 group">
            <summary class="px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-slate-700 flex items-center gap-2">
              <svg class="w-3 h-3 transform transition-transform group-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>ğŸ† æˆå°±ç³»ç»Ÿ</span>
            </summary>
            <div class="mt-1">
              <button onclick="showSection('achievementManagement')" data-search="æˆå°±ç®¡ç† achievement æˆå°±" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ†</span> <span>æˆå°±ç®¡ç†</span>
              </button>
              <button onclick="showSection('achievementLeaderboard')" data-search="æˆå°±æ’è¡Œæ¦œ achievement leaderboard æ’è¡Œ" class="nav-link w-full text-left px-4 py-2.5 rounded-lg mb-1 hover:bg-slate-100 text-slate-700 flex items-center gap-2 transition-all">
                <span>ğŸ…</span> <span>æˆå°±æ’è¡Œæ¦œ</span>
              </button>
            </div>
          </details>
        </nav>
      </aside>

      <!-- Main Content - æ·»åŠ å·¦è¾¹è·ä»¥é¿å…è¢«ä¾§è¾¹æ é®æŒ¡ -->
      <main class="flex-1 p-6 ml-64">
        <!-- Dashboard -->
        <div id="dashboardSection">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ä»ªè¡¨æ¿</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">ğŸ“¥</div>
                <div>
                  <p class="text-sm text-slate-600">é¢†å–è®°å½•æ€»æ•°</p>
                  <p id="claimCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">ğŸ</div>
                <div>
                  <p class="text-sm text-slate-600">æŠ•å–‚è®°å½•æ€»æ•°</p>
                  <p id="donateCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-2xl">ğŸ‘¥</div>
                <div>
                  <p class="text-sm text-slate-600">æ³¨å†Œç”¨æˆ·æ€»æ•°</p>
                  <p id="userCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">ğŸ’°</div>
                <div>
                  <p class="text-sm text-slate-600">å½“å‰é¢†å–é¢åº¦</p>
                  <p id="currentQuota" class="text-2xl font-bold text-slate-900">--</p>
                </div>
              </div>
            </div>
          </div>

          <!-- å½“å‰é…ç½®å¡ç‰‡ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-900">å½“å‰ç³»ç»Ÿé…ç½®</h3>
              </div>
              <button onclick="showSection('config')" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                <span>ç¼–è¾‘é…ç½®</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- æ¯æ—¥é¢†å–é¢åº¦ -->
              <div class="p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ’°</span>
                  <span class="text-sm font-semibold text-slate-700">æ¯æ—¥é¢†å–é¢åº¦</span>
                </div>
                <p id="dashboardQuota" class="text-2xl font-bold text-purple-700">--</p>
                <p class="text-xs text-slate-600 mt-1">â‰ˆ <span id="dashboardQuotaUSD">--</span> quota</p>
              </div>

              <!-- æ¯æ—¥æœ€å¤§é¢†å–æ¬¡æ•° -->
              <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border border-green-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ”¢</span>
                  <span class="text-sm font-semibold text-slate-700">æ¯æ—¥æœ€å¤§é¢†å–æ¬¡æ•°</span>
                </div>
                <p id="dashboardMaxClaims" class="text-2xl font-bold text-green-700">--</p>
                <p class="text-xs text-slate-600 mt-1">æ¬¡/å¤©</p>
              </div>

              <!-- API Session çŠ¶æ€ -->
              <div class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg border border-orange-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ”‘</span>
                  <span class="text-sm font-semibold text-slate-700">API Session</span>
                </div>
                <p id="dashboardSessionStatus" class="text-lg font-bold text-orange-700">--</p>
                <p class="text-xs text-slate-600 mt-1">KYX API è®¤è¯</p>
              </div>

              <!-- New-API-User -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ†”</span>
                  <span class="text-sm font-semibold text-slate-700">New-API-User</span>
                </div>
                <p id="dashboardNewApiUser" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">è¯·æ±‚å¤´å‚æ•°</p>
              </div>

              <!-- Keys API URL -->
              <div class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg border border-blue-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ”—</span>
                  <span class="text-sm font-semibold text-slate-700">Keys API URL</span>
                </div>
                <p id="dashboardKeysApi" class="text-sm font-mono text-blue-700 truncate" title="">--</p>
                <p class="text-xs text-slate-600 mt-1">éªŒè¯æœåŠ¡åœ°å€</p>
              </div>

              <!-- ModelScope Group ID -->
              <div class="p-4 bg-gradient-to-br from-pink-50 to-rose-50 rounded-lg border border-pink-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ‘¥</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope Group ID</span>
                </div>
                <p id="dashboardGroupId" class="text-2xl font-bold text-pink-700">--</p>
                <p class="text-xs text-slate-600 mt-1">ModelScope åˆ†ç»„</p>
              </div>

              <!-- iFlow Group ID -->
              <div class="p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg border border-emerald-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âœ¨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow Group ID</span>
                </div>
                <p id="dashboardIflowGroupId" class="text-2xl font-bold text-emerald-700">--</p>
                <p class="text-xs text-slate-600 mt-1">iFlow åˆ†ç»„</p>
              </div>

              <!-- Keys Authorization -->
              <div class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ”</span>
                  <span class="text-sm font-semibold text-slate-700">Keys Authorization</span>
                </div>
                <p id="dashboardKeysAuth" class="text-sm font-mono text-indigo-700 truncate" title="">--</p>
                <p id="dashboardKeysAuthStatus" class="text-xs text-slate-600 mt-1">--</p>
              </div>

              <!-- ModelScope æŠ•å–‚é™åˆ¶ -->
              <div class="p-4 bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg border border-amber-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">ğŸ</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope æŠ•å–‚é™åˆ¶</span>
                </div>
                <p id="dashboardMaxDonateModelscope" class="text-2xl font-bold text-amber-700">--</p>
                <p class="text-xs text-slate-600 mt-1">ä¸ª/å¤©</p>
              </div>

              <!-- iFlow æŠ•å–‚é™åˆ¶ -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-green-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âœ¨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow æŠ•å–‚é™åˆ¶</span>
                </div>
                <p id="dashboardMaxDonateIflow" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">ä¸ª/å¤©</p>
              </div>
            </div>

            <!-- æ›´æ–°æ—¶é—´ -->
            <div class="mt-4 pt-4 border-t border-slate-200">
              <p class="text-xs text-slate-500 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>æœ€åæ›´æ–°ï¼š<span id="dashboardUpdatedAt">--</span></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Config Section -->
        <div id="configSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ç³»ç»Ÿé…ç½®</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <!-- é¢åº¦è¯´æ˜ -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm text-blue-900">
                  <p class="font-semibold mb-1">ğŸ’° é¢åº¦å•ä½æ¢ç®—</p>
                  <p class="text-blue-800">500,000 quota = <strong>$1 ç¾å…ƒ</strong></p>
                  <p class="text-blue-700 text-xs mt-1">ç¤ºä¾‹ï¼š20,000,000 quota = $40</p>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ¯æ—¥é¢†å–é¢åº¦</label>
              <div class="flex gap-2 items-center">
                <div class="flex-1 relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">$</span>
                  <input type="number" id="claimQuotaUSD" placeholder="40" step="0.01" min="0" class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <span class="text-sm text-slate-600 whitespace-nowrap">â‰ˆ <span id="quotaValue">20,000,000</span> quota</span>
                <button onclick="updateQuota()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">è¾“å…¥ç¾å…ƒé‡‘é¢ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º quotaï¼ˆ$1 = 500,000 quotaï¼‰</p>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ¯æ—¥æœ€å¤§é¢†å–æ¬¡æ•°</label>
              <div class="flex gap-2 items-center">
                <input type="number" id="maxDailyClaims" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                <span class="text-sm text-slate-600">æ¬¡/å¤©</span>
                <button onclick="updateMaxDailyClaims()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">å»ºè®®è®¾ç½®ï¼š1-3æ¬¡ï¼ˆè®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´é¢åº¦æ»¥ç”¨ï¼‰</p>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">API Session</label>
              <div class="mb-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                <div class="text-xs text-slate-500 mb-1">å½“å‰ Session:</div>
                <div id="currentSession" class="text-sm font-mono text-slate-700 break-all">æœªé…ç½®</div>
              </div>
              <div class="flex gap-2">
                <input type="text" id="sessionValue" placeholder="è¾“å…¥æ–°çš„ Session" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg font-mono">
                <button onclick="updateSession()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">New-API-User</label>
              <div class="mb-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="text-xs text-blue-800">
                    <p>KYX API è¯·æ±‚å¤´å‚æ•°ï¼Œç”¨äºç”¨æˆ·æœç´¢å’Œé¢åº¦æ›´æ–°</p>
                    <p class="mt-1">é»˜è®¤å€¼ï¼š<code class="px-1 bg-blue-100 rounded">1</code>ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰</p>
                  </div>
                </div>
              </div>
              <div class="flex gap-2 items-center">
                <input type="text" id="newApiUserValue" placeholder="1" class="w-32 px-4 py-2 border border-slate-300 rounded-lg text-center font-mono">
                <span class="text-sm text-slate-600">å½“å‰å€¼: <code id="currentNewApiUser" class="px-2 py-1 bg-slate-100 rounded font-mono">1</code></span>
                <button onclick="updateNewApiUser()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys API URL</label>
              <div class="flex gap-2">
                <input type="text" id="keysApiUrl" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysApiUrl()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys Authorization</label>
              <div class="flex gap-2">
                <input type="text" id="keysAuthorization" placeholder="è¾“å…¥ Authorization Token" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysAuthorization()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="modelscopeGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateModelscopeGroupId()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="iflowGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateIflowGroupId()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">æ›´æ–°</button>
              </div>
            </div>
            
            <!-- æŠ•å–‚é™åˆ¶é…ç½® -->
            <div class="mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
              <h4 class="text-lg font-bold text-amber-900 mb-4 flex items-center gap-2">
                <span>ğŸ</span>
                <span>æ¯æ—¥æŠ•å–‚é™åˆ¶é…ç½®</span>
              </h4>
              <p class="text-sm text-amber-800 mb-4">æ§åˆ¶ç”¨æˆ·æ¯å¤©å¯ä»¥æŠ•å–‚çš„ Key æ•°é‡ï¼Œä¸åŒæ¸ é“å•ç‹¬é…ç½®</p>
              
              <!-- ModelScope æŠ•å–‚é™åˆ¶ -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope æ¯æ—¥æŠ•å–‚é™åˆ¶</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateModelscope" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">ä¸ª/å¤©</span>
                  <button onclick="updateMaxDailyDonateModelscope()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">å»ºè®®è®¾ç½®ï¼š1-3æ¬¡ï¼ˆè®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´é¢åº¦æ»¥ç”¨ï¼‰</p>
              </div>
              
              <!-- iFlow æŠ•å–‚é™åˆ¶ -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow æ¯æ—¥æŠ•å–‚é™åˆ¶</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateIflow" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">ä¸ª/å¤©</span>
                  <button onclick="updateMaxDailyDonateIflow()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 whitespace-nowrap">æ›´æ–°</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">å»ºè®®è®¾ç½®ï¼š1-3æ¬¡ï¼ˆè®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´é¢åº¦æ»¥ç”¨ï¼‰</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Keys Section -->
        <div id="keysSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">Keys ç®¡ç†</h2>
            <button onclick="refreshKeys()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="keysRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex gap-2">
                <button onclick="exportKeys()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰</button>
                <button onclick="copyAllKeys()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ğŸ“‹ å¤åˆ¶æ‰€æœ‰</button>
                <button onclick="testAllKeys()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ğŸ§ª ä¸€é”®æµ‹è¯•</button>
              </div>
              <button onclick="toggleKeysBatchMode()" id="keysBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">æ‰¹é‡æ“ä½œ</button>
            </div>
            <div id="keysBatchActions" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllKeys" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">å…¨é€‰ (<span id="selectedKeysCount">0</span> ä¸ªå·²é€‰)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="deleteSelectedKeys()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                  <button onclick="testSelectedKeys()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">ğŸ§ª æµ‹è¯•é€‰ä¸­</button>
                </div>
              </div>
            </div>
            <p class="text-sm text-slate-600">æ€»è®¡: <span id="totalKeysCount">0</span> ä¸ª Key</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="keysCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllKeysHeader" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Key</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ¸ é“</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æŠ•å–‚ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æŠ•å–‚æ—¶é—´</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æµ‹è¯•çŠ¶æ€</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="keysListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Claims Section -->
        <div id="claimsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">é¢†å–è®°å½•</h2>
            <button onclick="refreshClaims()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="claimsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                æ€»è®°å½•æ•°: <span id="claimsTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">æ¯é¡µæ˜¾ç¤º:</label>
                <select id="claimsPageSize" onchange="changeClaimsPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20æ¡</option>
                  <option value="50" selected>50æ¡</option>
                  <option value="100">100æ¡</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">ç±»å‹</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">é¢†å–é¢åº¦</th>
                  </tr>
                </thead>
                <tbody id="claimTableBody"></tbody>
              </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="claimPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  ç¬¬ <span id="claimCurrentPage">1</span> / <span id="claimTotalPages">1</span> é¡µï¼ˆå…± <span id="claimTotal">0</span> æ¡ï¼‰
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadClaimRecords(claimCurrentPage - 1)" id="claimPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>ä¸Šä¸€é¡µ</button>
                  <div id="claimPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadClaimRecords(claimCurrentPage + 1)" id="claimNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">ä¸‹ä¸€é¡µ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Donates Section -->
        <div id="donatesSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">æŠ•å–‚è®°å½•</h2>
            <button onclick="refreshDonates()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="donatesRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                æ€»è®°å½•æ•°: <span id="donatesTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">æ¯é¡µæ˜¾ç¤º:</label>
                <select id="donatesPageSize" onchange="changeDonatesPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20æ¡</option>
                  <option value="50" selected>50æ¡</option>
                  <option value="100">100æ¡</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ¸ é“</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">Key æ•°é‡</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å¢åŠ é¢åº¦</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ¨é€çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody id="donateTableBody"></tbody>
              </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="donatePagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  ç¬¬ <span id="donateCurrentPage">1</span> / <span id="donateTotalPages">1</span> é¡µï¼ˆå…± <span id="donateTotal">0</span> æ¡ï¼‰
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadDonateRecords(donateCurrentPage - 1)" id="donatePrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>ä¸Šä¸€é¡µ</button>
                  <div id="donatePageNumbers" class="flex gap-1"></div>
                  <button onclick="loadDonateRecords(donateCurrentPage + 1)" id="donateNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">ä¸‹ä¸€é¡µ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ğŸ”¥ Advanced Slot Records Section -->
        <div id="advancedSlotRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ”¥ é«˜çº§åœºæ¸¸æˆè®°å½•</h2>
            <button onclick="refreshAdvancedSlotRecords()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          
          <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-red-800">
              ğŸ’¡ <strong>é«˜çº§åœºç‰¹è‰²ï¼š</strong>æŠ•æ³¨é‡‘é¢$100-$1500å¯é€‰ï¼Œå¥–åŠ±å€ç‡Ã—4ï¼Œæƒ©ç½šé‡‘é¢Ã—2ï¼Œä¸¥æ ¼è¿ç»­åˆ¤å®š
            </p>
          </div>
          
          <!-- æœç´¢å’Œç­›é€‰æ  -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- æœç´¢ç”¨æˆ·å -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœç´¢ç”¨æˆ·å</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="advancedRecordSearchInput" 
                    placeholder="è¾“å…¥LinuxDoç”¨æˆ·åæˆ–å…¬ç›Šç«™ç”¨æˆ·å..." 
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                  >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- ä¸­å¥–ç±»å‹ç­›é€‰ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä¸­å¥–ç±»å‹</label>
                <select
                  id="advancedWinTypeFilter"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                >
                  <option value="all">å…¨éƒ¨ç±»å‹</option>
                  <!-- ğŸ”¥ åŠ¨æ€åŠ è½½è§„åˆ™é€‰é¡¹ -->
                </select>
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterAdvancedSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  ğŸ” æŸ¥è¯¢
                </button>
                <button 
                  onclick="refreshAdvancedSlotRecordsKeepFilter()" 
                  class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-1"
                  title="åˆ·æ–°æ•°æ®ï¼ˆä¿ç•™ç­›é€‰æ¡ä»¶ï¼‰"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  åˆ·æ–°
                </button>
                <button 
                  onclick="clearAdvancedRecordFilters()" 
                  class="flex-1 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors font-medium"
                >
                  ğŸ”„ é‡ç½®
                </button>
              </div>
            </div>
            
            <!-- ç­›é€‰ç»“æœæç¤º -->
            <div id="advancedFilterResultHint" class="text-sm text-slate-600 hidden"></div>
          </div>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-slate-600">æ€»è®°å½•æ•°</p>
                <p id="advancedSlotTotal" class="text-2xl font-bold text-slate-900">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">æ€»æŠ•æ³¨</p>
                <p id="advancedSlotTotalBet" class="text-2xl font-bold text-blue-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">æ€»è·å¥–</p>
                <p id="advancedSlotTotalWin" class="text-2xl font-bold text-green-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">å®é™…RTP</p>
                <p id="advancedSlotRTP" class="text-2xl font-bold text-purple-600">0%</p>
                <p class="text-xs text-slate-500 mt-1">è¿”è¿˜ç©å®¶ç‡ (æ€»èµ¢ Ã· æ€»æŠ•)</p>
              </div>
            </div>
            
            <!-- RTPè®¡ç®—å…¬å¼è¯´æ˜ -->
            <div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
              <div class="flex items-start gap-2">
                <span class="text-purple-600">ğŸ“Š</span>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-purple-900 mb-1">RTPè®¡ç®—å…¬å¼</p>
                  <p class="text-xs text-slate-700">
                    RTP (Return To Player) = (æ€»è·å¥– Ã· æ€»æŠ•æ³¨) Ã— 100%
                  </p>
                  <p class="text-xs text-slate-600 mt-1">
                    ç¤ºä¾‹ï¼šæ€»æŠ•æ³¨$1000ï¼Œæ€»è·å¥–$950 â†’ RTP = (950 Ã· 1000) Ã— 100% = 95%
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gradient-to-r from-red-50 to-orange-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æŠ•æ³¨é‡‘é¢</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ç¬¦å·</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ä¸­å¥–ç±»å‹</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">å€ç‡</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">å¥–é‡‘</th>
                  </tr>
                </thead>
                <tbody id="advancedSlotRecordsBody">
                  <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-slate-400">æš‚æ— é«˜çº§åœºæ¸¸æˆè®°å½•</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div id="advancedSlotRecordsPagination" class="hidden px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                å…± <span id="advancedSlotRecordsTotal">0</span> æ¡è®°å½•ï¼Œå½“å‰ç¬¬ <span id="advancedSlotCurrentPage">1</span> é¡µ
              </div>
              <div class="flex gap-2">
                <button onclick="advancedSlotPrevPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="advancedSlotPrevBtn">
                  ä¸Šä¸€é¡µ
                </button>
                <button onclick="advancedSlotNextPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="advancedSlotNextBtn">
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ğŸ”¥ Advanced Slot Config Section -->
        <div id="advancedSlotConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ”¥ é«˜çº§åœºé…ç½®</h2>
          
          <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-red-800">
              âš ï¸ <strong>æ³¨æ„ï¼š</strong>é…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œå½±å“æ‰€æœ‰ç”¨æˆ·çš„é«˜çº§åœºä½“éªŒ
            </p>
          </div>

          <!-- ğŸ§± é¡¶éƒ¨å›ºå®šåŒºï¼ˆåŸºç¡€è®¾ç½®ï¼‰-->
          <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl shadow-md border-2 border-slate-300 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                <span>åŸºç¡€è®¾ç½®</span>
                <button onclick="showRTPHelp()" class="text-blue-600 hover:text-blue-700 transition-colors" title="å€ç‡ä¸RTPè¯´æ˜">
                  ğŸ§ 
                </button>
              </h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- å¯ç”¨å¼€å…³ -->
              <div class="md:col-span-2 lg:col-span-3">
                <label class="flex items-center gap-3 cursor-pointer group">
                  <div class="relative">
                    <input type="checkbox" id="advancedEnabled" class="sr-only peer">
                    <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-red-600 peer-checked:to-orange-600"></div>
                  </div>
                  <span class="text-base font-semibold text-slate-900">å¯ç”¨é«˜çº§åœºåŠŸèƒ½</span>
                </label>
              </div>
              
              <!-- æŠ•æ³¨èŒƒå›´ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  æŠ•æ³¨èŒƒå›´ <span class="text-red-600">*</span>
                </label>
                <div class="flex items-center gap-2">
                  <input type="number" id="advancedBetMinUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold" placeholder="200">
                  <span class="text-slate-500 font-medium">è‡³</span>
                  <input type="number" id="advancedBetMaxUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold" placeholder="1500">
                </div>
                <p class="text-xs text-slate-500 mt-1">ç¾å…ƒ (å½“å‰: <span id="advancedBetMinQuota">50000000</span> èª è‡³ <span id="advancedBetMaxQuota">250000000</span> èª)</p>
              </div>
              
              <!-- âŒ å·²ç§»é™¤å¥–åŠ±å€æ•°å’Œæƒ©ç½šå€æ•°é…ç½® -->
              <!-- ç°åœ¨æ¯ä¸ªåœºæ¬¡ä½¿ç”¨ç‹¬ç«‹çš„å¥–åŠ±é…ç½®æ–¹æ¡ˆï¼Œä¸å†åŸºäºåˆçº§åœºç¿»å€ -->
              
              <!-- æ¯æ—¥æŠ•æ³¨ä¸Šé™ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  æ¯æ—¥æŠ•æ³¨ä¸Šé™ <span class="text-blue-500" title="å•ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šæŠ•æ³¨é‡‘é¢">ğŸ›ˆ</span>
                </label>
                <input type="number" id="advancedDailyBetLimitUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold text-orange-600" placeholder="10000">
                <p class="text-xs text-slate-500 mt-1">ç¾å…ƒ (å½“å‰: <span id="advancedDailyBetLimitQuota">5000000000</span> èª)</p>
              </div>
            </div>
          </div>

          <!-- â° æ—¶æ•ˆè®¾ç½®ï¼ˆå¯æŠ˜å ï¼‰-->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 group">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-900 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">â–¶</span>
                <span>â° æ—¶æ•ˆè®¾ç½®</span>
              </span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <!-- å…¥åœºåˆ¸æœ‰æ•ˆæœŸ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">å…¥åœºåˆ¸æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰</label>
                  <input type="number" id="advancedTicketValidHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="24">
                  <p class="text-xs text-slate-500 mt-1">å…¥åœºåˆ¸è¿‡æœŸæ—¶é—´</p>
                </div>
                
                <!-- é«˜çº§åœºåœç•™æ—¶é•¿ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">é«˜çº§åœºåœç•™æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                  <input type="number" id="advancedSessionValidHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="24">
                  <p class="text-xs text-slate-500 mt-1">è¿›å…¥é«˜çº§åœºåçš„æœ‰æ•ˆæ—¶é—´</p>
                </div>
                
                <!-- æç¤º -->
                <div class="md:col-span-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p class="text-xs text-blue-800">
                    ğŸ’¡ <strong>æç¤ºï¼š</strong>å‰©ä½™æœ‰æ•ˆæ—¶é—´ = min(å…¥åœºåˆ¸æœ‰æ•ˆæœŸ, åœç•™æ—¶é•¿)
                  </p>
                </div>
              </div>
            </div>
          </details>

          <!-- ğŸ² æ‰è½è®¾ç½®ï¼ˆå¯æŠ˜å ï¼‰-->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 group">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-900 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">â–¶</span>
                <span>ğŸ² æ‰è½ä¸èµ„æ ¼æœºåˆ¶</span>
              </span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <!-- åˆæˆæ‰€éœ€ç¢ç‰‡æ•° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">åˆæˆæ‰€éœ€ç¢ç‰‡æ•°é‡</label>
                  <input type="number" id="advancedFragmentsNeeded" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="5">
                  <p class="text-xs text-slate-500 mt-1">åˆæˆ1å¼ å…¥åœºåˆ¸éœ€è¦çš„ç¢ç‰‡</p>
                </div>
                
                <!-- æœ€å¤šæŒæœ‰åˆ¸æ•° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æœ€å¤šæŒæœ‰å…¥åœºåˆ¸æ•°</label>
                  <input type="number" id="advancedMaxTicketsHold" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">é˜²æ­¢å›¤åˆ¸</p>
                </div>
                
                <!-- æ¯æ—¥è¿›å…¥æ¬¡æ•°é™åˆ¶ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥è¿›å…¥é«˜çº§åœºæ¬¡æ•°é™åˆ¶</label>
                  <input type="number" id="advancedDailyEntryLimit" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">æ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šè¿›å…¥æ¬¡æ•°</p>
                </div>
                
                <!-- æ¯æ—¥å…¥åœºåˆ¸è·å¾—é™åˆ¶ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥è·å¾—å…¥åœºåˆ¸æ•°é‡é™åˆ¶</label>
                  <input type="number" id="advancedDailyTicketGrantLimit" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">æ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šè·å¾—å…¥åœºåˆ¸æ•°</p>
                </div>
              </div>
            </div>
          </details>

          <!-- ğŸ² ç¬¦å·æƒé‡é…ç½®æ–¹æ¡ˆ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">âš–ï¸ ç¬¦å·æƒé‡é…ç½®æ–¹æ¡ˆï¼ˆé«˜çº§åœºï¼‰</h3>
            </div>
            
            <div class="mb-4 p-4 bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg">
              <p class="text-sm text-red-800 mb-2">
                <strong>âœ¨ æ–°é…ç½®æ–¹å¼ï¼š</strong>ä»é…ç½®æ–¹æ¡ˆä¸­é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™ï¼
              </p>
              <p class="text-xs text-red-700">
                â€¢ åœ¨"æƒé‡é…ç½®ç®¡ç†"ä¸­åˆ›å»ºé«˜çº§åœºä¸“ç”¨æƒé‡æ–¹æ¡ˆ<br>
                â€¢ ä¿®æ”¹æ–¹æ¡ˆåç«‹å³ç”Ÿæ•ˆ<br>
                â€¢ å¯ä¸åˆçº§åœºä½¿ç”¨ä¸åŒçš„é…ç½®æ–¹æ¡ˆ
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©æƒé‡é…ç½®æ–¹æ¡ˆ *</label>
              <select id="advancedSlotWeightConfigId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" onchange="previewAdvancedWeightConfig()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ å¯ä¸åˆçº§åœºä½¿ç”¨ç›¸åŒæˆ–ä¸åŒçš„æƒé‡æ–¹æ¡ˆ</p>
            </div>
            
            <!-- é¢„è§ˆæƒé‡ -->
            <div id="advancedWeightPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ“Š å½“å‰é…ç½®é¢„è§ˆ</h4>
              <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ç¾(m)</div>
                  <div id="adv_preview_weight_m" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å¤(t)</div>
                  <div id="adv_preview_weight_t" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä½ (n)</div>
                  <div id="adv_preview_weight_n" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å¤ª(j)</div>
                  <div id="adv_preview_weight_j" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">é²¤é±¼(lq)</div>
                  <div id="adv_preview_weight_lq" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">èƒŒæ™¯(bj)</div>
                  <div id="adv_preview_weight_bj" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">çœŸç²‰å¤´(zft)</div>
                  <div id="adv_preview_weight_zft" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä¸æ‰“å·¥(bdk)</div>
                  <div id="adv_preview_weight_bdk" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-red-100 rounded border border-red-300">
                  <div class="text-red-700">å¾‹å¸ˆå‡½(lsh)</div>
                  <div id="adv_preview_weight_lsh" class="font-bold text-red-700">--</div>
                </div>
                <div class="text-center p-2 bg-green-100 rounded border border-green-300">
                  <div class="text-green-700">man</div>
                  <div id="adv_preview_weight_man" class="font-bold text-green-700">--</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">ğŸ ä¸­å¥–è§„åˆ™é…ç½®æ–¹æ¡ˆï¼ˆé«˜çº§åœºï¼‰</h3>
            </div>
            
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-purple-800 mb-2">
                <strong>âœ¨ æ–°é…ç½®æ–¹å¼ï¼š</strong>ä½¿ç”¨é¢„è®¾è§„åˆ™æ¨¡æ¿ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼
              </p>
              <p class="text-xs text-purple-700">
                â€¢ åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­åˆ›å»ºæ–¹æ¡ˆå¹¶æ·»åŠ é¢„è®¾è§„åˆ™<br>
                â€¢ å¯ä¸åˆçº§åœºä½¿ç”¨ç›¸åŒæˆ–ä¸åŒçš„å¥–åŠ±æ–¹æ¡ˆ<br>
                â€¢ æ”¯æŒä¸€é”®åº”ç”¨å¾‹å¸ˆå‡½æƒ©ç½š
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©å¥–åŠ±é…ç½®æ–¹æ¡ˆ *</label>
              <select id="advancedSlotRewardSchemeId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" onchange="previewAdvancedRewardScheme()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­å¯ä»¥åˆ›å»ºæ–°æ–¹æ¡ˆæˆ–ç¼–è¾‘è§„åˆ™</p>
            </div>
            
            <!-- é¢„è§ˆè§„åˆ™ -->
            <div id="advancedRewardPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ¯ åŒ…å«è§„åˆ™</h4>
              <div id="advancedRewardPreviewList" class="space-y-2 text-xs">
                <!-- åŠ¨æ€å¡«å…… -->
              </div>
            </div>
          </div>

          <!-- ğŸ“Š æ¦‚ç‡åˆ†æå¡ç‰‡ -->
          <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ“Š</span>
                </div>
                <div>
                  <h4 class="text-lg font-bold text-purple-900">æ¦‚ç‡åˆ†æä¸RTPè®¡ç®—</h4>
                  <p class="text-xs text-purple-700">æ ¹æ®é€‰æ‹©çš„é…ç½®å®æ—¶è®¡ç®—è§„åˆ™æ¦‚ç‡å’Œç©å®¶å›æŠ¥ç‡</p>
                </div>
              </div>
            </div>
            
            <!-- è®¡ç®—æ–¹å¼é€‰æ‹© -->
            <div class="mb-4">
              <div class="flex items-center justify-between mb-3">
                <label class="text-sm font-medium text-slate-700">è®¡ç®—æ–¹å¼:</label>
                <button onclick="calculateAdvancedProbability()" class="px-4 py-2 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                  ğŸ² å¼€å§‹è®¡ç®—
                </button>
              </div>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="advancedCalcMethod" value="fast" checked>
                  <span class="text-sm">âš¡ å¿«é€Ÿä¼°ç®— (æ¯«ç§’çº§)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="advancedCalcMethod" value="monte-carlo">
                  <span class="text-sm">ğŸ² ç²¾ç¡®æ¨¡æ‹Ÿ (è’™ç‰¹å¡æ´› 100ä¸‡æ¬¡, 2-3ç§’)</span>
                </label>
              </div>
            </div>
            
            <!-- æ¦‚ç‡æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="advancedProbabilityDisplay" class="hidden">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
          </div>

          <!-- ç»Ÿä¸€æ“ä½œåŒº -->
          <div class="bg-gradient-to-br from-red-50 via-orange-50 to-amber-50 border-2 border-red-300 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between mb-5">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-orange-500 rounded-xl flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ’¾</span>
                </div>
                <div>
                  <h4 class="text-lg font-bold text-red-900">ä¿å­˜é«˜çº§åœºé…ç½®</h4>
                  <p class="text-xs text-red-700">é…ç½®ä¿®æ”¹åè¯·ç‚¹å‡»ä¿å­˜</p>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- é…ç½®æ–¹æ¡ˆ -->
              <div class="bg-white rounded-lg p-5 border-2 border-red-200 hover:border-red-300 transition-all shadow-sm hover:shadow-md">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">ğŸ¯</span>
                  <h5 class="text-sm font-bold text-red-800">æ–¹æ¡ˆé…ç½®</h5>
                  <span class="ml-auto px-2 py-0.5 bg-gradient-to-r from-red-100 to-orange-100 text-red-700 rounded-full text-xs font-bold">â˜… æ¨è</span>
                </div>
                <p class="text-xs text-slate-600 mb-4">åº”ç”¨æƒé‡å’Œå¥–åŠ±é…ç½®æ–¹æ¡ˆ</p>
                <button onclick="saveAdvancedSlotConfigSchemes()" class="w-full px-5 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                  <span class="flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>ä¿å­˜æ–¹æ¡ˆé…ç½®</span>
                  </span>
                </button>
              </div>
              
              <!-- åŸºç¡€å‚æ•° -->
              <div class="bg-white rounded-lg p-5 border-2 border-blue-200 hover:border-blue-300 transition-all shadow-sm hover:shadow-md">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">âš™ï¸</span>
                  <h5 class="text-sm font-bold text-blue-800">åŸºç¡€å‚æ•°</h5>
                </div>
                <p class="text-xs text-slate-600 mb-4">æŠ•æ³¨èŒƒå›´ã€æ‰è½ç‡ç­‰</p>
                <button onclick="saveAdvancedSlotConfig()" class="w-full px-5 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                  <span class="flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>ä¿å­˜åŸºç¡€å‚æ•°</span>
                  </span>
                </button>
              </div>
            </div>
            
            <!-- é‡æ–°åŠ è½½æŒ‰é’® -->
            <div class="flex justify-end">
              <button onclick="loadAdvancedSlotConfig()" class="px-5 py-2 bg-white hover:bg-slate-50 text-slate-700 rounded-lg font-medium transition-all border border-slate-300 shadow-sm hover:shadow flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>é‡æ–°åŠ è½½é…ç½®</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ğŸŸï¸ Ticket Drop Records Section -->
        <div id="ticketDropRecordsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸŸï¸ å…¥åœºåˆ¸æ‰è½è®°å½•</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-slate-600">æ€»æ‰è½æ¬¡æ•°</p>
                <p id="ticketDropTotal" class="text-2xl font-bold text-slate-900">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">å…¥åœºåˆ¸æ‰è½</p>
                <p id="ticketDropCount" class="text-2xl font-bold text-purple-600">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">ç¢ç‰‡æ‰è½</p>
                <p id="fragmentDropCount" class="text-2xl font-bold text-blue-600">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">ä»Šæ—¥æ‰è½</p>
                <p id="todayDropCount" class="text-2xl font-bold text-green-600">0</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æ‰è½ç±»å‹</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æ•°é‡</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">è§¦å‘æ¡ä»¶</th>
                  </tr>
                </thead>
                <tbody id="ticketDropRecordsBody">
                  <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-slate-400">æš‚æ— æ‰è½è®°å½•</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div id="ticketDropPagination" class="hidden px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                å…± <span id="ticketDropRecordsTotal">0</span> æ¡è®°å½•ï¼Œå½“å‰ç¬¬ <span id="ticketDropCurrentPage">1</span> é¡µ
              </div>
              <div class="flex gap-2">
                <button onclick="ticketDropPrevPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="ticketDropPrevBtn">
                  ä¸Šä¸€é¡µ
                </button>
                <button onclick="ticketDropNextPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="ticketDropNextBtn">
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Slot Machine Config Section -->
        <div id="slotConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">âš™ï¸ è€è™æœºé…ç½®ï¼ˆåˆçº§åœºï¼‰</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">åŸºæœ¬é…ç½®</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  æŠ•æ³¨é‡‘é¢ (å•ä½: $, 500000 = $1)
                </label>
                <input type="number" step="0.01" id="slotBetAmountUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">å½“å‰ï¼š$<span id="slotBetAmountDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  æ¯æ—¥æ¸¸ç©æ¬¡æ•°
                </label>
                <input type="number" id="slotMaxDailySpins" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="5">
                <p class="text-xs text-slate-500 mt-1">æ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šå¯ç©çš„æ¬¡æ•°</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  æœ€ä½é¢åº¦è¦æ±‚ (å•ä½: $)
                </label>
                <input type="number" step="0.01" id="slotMinQuotaUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">å½“å‰ï¼š$<span id="slotMinQuotaDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  å¯ç”¨çŠ¶æ€
                </label>
                <select id="slotEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="1">å¯ç”¨</option>
                  <option value="0">ç¦ç”¨</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">ç¦ç”¨åç”¨æˆ·æ— æ³•è®¿é—®è€è™æœº</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  èƒŒæ™¯ç±»å‹
                </label>
                <select id="slotBackgroundType" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="default">é»˜è®¤æ¸å˜</option>
                  <option value="gif">åŠ¨æ€GIF</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">é€‰æ‹©è€è™æœºç•Œé¢çš„èƒŒæ™¯æ ·å¼</p>
              </div>
            </div>

            <!-- è´­ä¹°æ¬¡æ•°é…ç½® -->
            <div class="mt-6 p-4 bg-orange-50 border-2 border-orange-200 rounded-lg">
              <h4 class="text-md font-semibold text-orange-800 mb-3 flex items-center gap-2">
                <span>ğŸ’°</span>
                <span>è´­ä¹°æŠ½å¥–æ¬¡æ•°åŠŸèƒ½</span>
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    åŠŸèƒ½å¼€å…³
                  </label>
                  <select id="buySpinsEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <option value="0">å…³é—­</option>
                    <option value="1">å¼€å¯</option>
                  </select>
                  <p class="text-xs text-slate-500 mt-1">å¼€å¯åç”¨æˆ·å¯ä»¥è´­ä¹°æŠ½å¥–æ¬¡æ•°</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    è´­ä¹°ä»·æ ¼ (å•ä½: $)
                  </label>
                  <input type="number" step="0.01" id="buySpinsPriceUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="40">
                  <p class="text-xs text-slate-500 mt-1">å½“å‰ï¼š$<span id="buySpinsPriceDisplay">40.00</span></p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    æ¯æ—¥æœ€å¤§è´­ä¹°æ¬¡æ•°
                  </label>
                  <input type="number" id="maxDailyBuySpins" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="5">
                  <p class="text-xs text-slate-500 mt-1">ç”¨æˆ·æ¯å¤©æœ€å¤šå¯è´­ä¹°çš„æ¬¡æ•°</p>
                </div>

                <div class="flex items-end">
                  <div class="w-full p-3 bg-white rounded-lg border border-orange-200">
                    <p class="text-xs text-orange-700 font-medium mb-1">è¯´æ˜</p>
                    <p class="text-xs text-slate-600">è´­ä¹°çš„æ¬¡æ•°ä¼šå¢åŠ åˆ°å…è´¹æ¬¡æ•°ä¸­ï¼Œè´­ä¹°åä»éœ€æŠ•æ³¨æ‰èƒ½æŠ½å¥–</p>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900">âš–ï¸ ç¬¦å·æƒé‡é…ç½®æ–¹æ¡ˆ</h3>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-blue-800 mb-2">
                <strong>âœ¨ æ–°é…ç½®æ–¹å¼ï¼š</strong>ä»é…ç½®æ–¹æ¡ˆä¸­é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™æƒé‡å€¼ï¼
              </p>
              <p class="text-xs text-blue-700">
                â€¢ åœ¨"æƒé‡é…ç½®ç®¡ç†"ä¸­åˆ›å»ºå’Œç®¡ç†é…ç½®æ–¹æ¡ˆ<br>
                â€¢ ä¿®æ”¹æ–¹æ¡ˆåï¼Œæ‰€æœ‰ä½¿ç”¨è¯¥æ–¹æ¡ˆçš„åœºæ¬¡ç«‹å³ç”Ÿæ•ˆ<br>
                â€¢ æ”¯æŒå¤šåœºæ¬¡å…±ç”¨åŒä¸€é…ç½®æ–¹æ¡ˆ
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©æƒé‡é…ç½®æ–¹æ¡ˆ *</label>
              <select id="normalSlotWeightConfigId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="previewNormalWeightConfig(); calculateNormalProbability()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ åœ¨"æƒé‡é…ç½®ç®¡ç†"ä¸­å¯ä»¥åˆ›å»ºæ–°æ–¹æ¡ˆæˆ–ç¼–è¾‘ç°æœ‰æ–¹æ¡ˆ</p>
            </div>
            
            <!-- é¢„è§ˆæƒé‡ -->
            <div id="normalWeightPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ“Š å½“å‰é…ç½®é¢„è§ˆ</h4>
              <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ç¾(m)</div>
                  <div id="preview_weight_m" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å¤(t)</div>
                  <div id="preview_weight_t" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä½ (n)</div>
                  <div id="preview_weight_n" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å¤ª(j)</div>
                  <div id="preview_weight_j" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">é²¤é±¼(lq)</div>
                  <div id="preview_weight_lq" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">èƒŒæ™¯(bj)</div>
                  <div id="preview_weight_bj" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">çœŸç²‰å¤´(zft)</div>
                  <div id="preview_weight_zft" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä¸æ‰“å·¥(bdk)</div>
                  <div id="preview_weight_bdk" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-red-50 rounded border border-red-200">
                  <div class="text-red-600">å¾‹å¸ˆå‡½(lsh)</div>
                  <div id="preview_weight_lsh" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-green-50 rounded border border-green-200">
                  <div class="text-green-600">man</div>
                  <div id="preview_weight_man" class="font-bold text-green-600">--</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900">ğŸ ä¸­å¥–è§„åˆ™é…ç½®æ–¹æ¡ˆ</h3>
            </div>
            
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-purple-800 mb-2">
                <strong>âœ¨ æ–°é…ç½®æ–¹å¼ï¼š</strong>ä½¿ç”¨é¢„è®¾è§„åˆ™æ¨¡æ¿ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å¤æ‚å‚æ•°ï¼
              </p>
              <p class="text-xs text-purple-700">
                â€¢ åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­åˆ›å»ºæ–¹æ¡ˆå¹¶æ·»åŠ é¢„è®¾è§„åˆ™<br>
                â€¢ æ”¯æŒä¸€é”®åº”ç”¨å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®<br>
                â€¢ åŒä¸€æ–¹æ¡ˆå¯è¢«å¤šä¸ªåœºæ¬¡å¤ç”¨
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©å¥–åŠ±é…ç½®æ–¹æ¡ˆ *</label>
              <select id="normalSlotRewardSchemeId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="previewNormalRewardScheme()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­å¯ä»¥åˆ›å»ºæ–°æ–¹æ¡ˆæˆ–ç¼–è¾‘è§„åˆ™</p>
            </div>
            
            <!-- é¢„è§ˆè§„åˆ™ -->
            <div id="normalRewardPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ¯ åŒ…å«è§„åˆ™</h4>
              <div id="normalRewardPreviewList" class="space-y-2 text-xs">
                <!-- åŠ¨æ€å¡«å…… -->
              </div>
            </div>
          </div>
          
          <!-- ğŸ“Š æ¦‚ç‡åˆ†æå¡ç‰‡ (åˆçº§åœº) -->
          <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ“Š</span>
                </div>
                <div>
                  <h4 class="text-lg font-bold text-purple-900">æ¦‚ç‡åˆ†æä¸RTPè®¡ç®—</h4>
                  <p class="text-xs text-purple-700">æ ¹æ®é€‰æ‹©çš„é…ç½®å®æ—¶è®¡ç®—è§„åˆ™æ¦‚ç‡å’Œç©å®¶å›æŠ¥ç‡</p>
                </div>
              </div>
            </div>
            
            <!-- è®¡ç®—æ–¹å¼é€‰æ‹© -->
            <div class="mb-4">
              <div class="flex items-center justify-between mb-3">
                <label class="text-sm font-medium text-slate-700">è®¡ç®—æ–¹å¼:</label>
                <button onclick="calculateNormalProbability()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                  ğŸ² å¼€å§‹è®¡ç®—
                </button>
              </div>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="normalCalcMethod" value="fast" checked>
                  <span class="text-sm">âš¡ å¿«é€Ÿä¼°ç®— (æ¯«ç§’çº§)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="normalCalcMethod" value="monte-carlo">
                  <span class="text-sm">ğŸ² ç²¾ç¡®æ¨¡æ‹Ÿ (è’™ç‰¹å¡æ´› 100ä¸‡æ¬¡, 2-3ç§’)</span>
                </label>
              </div>
            </div>
            
            <!-- æ¦‚ç‡æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="normalProbabilityDisplay" class="hidden">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
          </div>
          
          <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <span class="text-2xl">ğŸ’¡</span>
              <div>
                <p class="text-sm font-semibold text-amber-900 mb-1">å¿«é€Ÿé…ç½®æŒ‡å—</p>
                <ol class="text-sm text-amber-800 space-y-1">
                  <li>1. åœ¨"æƒé‡é…ç½®ç®¡ç†"ä¸­åˆ›å»ºæƒé‡æ–¹æ¡ˆï¼ˆå¦‚ï¼šæ ‡å‡†åˆçº§åœºé…ç½®ï¼‰</li>
                  <li>2. åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­åˆ›å»ºå¥–åŠ±æ–¹æ¡ˆå¹¶æ·»åŠ é¢„è®¾è§„åˆ™æ¨¡æ¿</li>
                  <li>3. åœ¨æ­¤å¤„é€‰æ‹©åˆšåˆ›å»ºçš„æ–¹æ¡ˆ</li>
                  <li>4. ç‚¹å‡»ä¿å­˜é…ç½®ï¼Œç«‹å³ç”Ÿæ•ˆï¼</li>
                </ol>
              </div>
            </div>
          </div>
          
          <!-- ç»Ÿä¸€æ“ä½œåŒº -->
          <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 border-2 border-indigo-300 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between mb-5">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ’¾</span>
                </div>
                <div>
                  <h4 class="text-lg font-bold text-indigo-900">ä¿å­˜åˆçº§åœºé…ç½®</h4>
                  <p class="text-xs text-indigo-700">é…ç½®ä¿®æ”¹åè¯·ç‚¹å‡»ä¿å­˜</p>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- é…ç½®æ–¹æ¡ˆ -->
              <div class="bg-white rounded-lg p-5 border-2 border-indigo-200 hover:border-indigo-300 transition-all shadow-sm hover:shadow-md">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">ğŸ¯</span>
                  <h5 class="text-sm font-bold text-indigo-800">æ–¹æ¡ˆé…ç½®</h5>
                  <span class="ml-auto px-2 py-0.5 bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 rounded-full text-xs font-bold">â˜… æ¨è</span>
                </div>
                <p class="text-xs text-slate-600 mb-4">åº”ç”¨æƒé‡å’Œå¥–åŠ±é…ç½®æ–¹æ¡ˆ</p>
                <button onclick="saveNormalSlotConfigSchemes()" class="w-full px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                  <span class="flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>ä¿å­˜æ–¹æ¡ˆé…ç½®</span>
                  </span>
                </button>
              </div>
              
              <!-- åŸºç¡€å‚æ•° -->
              <div class="bg-white rounded-lg p-5 border-2 border-blue-200 hover:border-blue-300 transition-all shadow-sm hover:shadow-md">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-2xl">âš™ï¸</span>
                  <h5 class="text-sm font-bold text-blue-800">åŸºç¡€å‚æ•°</h5>
                </div>
                <p class="text-xs text-slate-600 mb-4">æŠ•æ³¨é‡‘é¢ã€æ¯æ—¥æ¬¡æ•°ç­‰</p>
                <button onclick="updateSlotConfig()" class="w-full px-5 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                  <span class="flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>ä¿å­˜åŸºç¡€å‚æ•°</span>
                  </span>
                </button>
              </div>
            </div>
            
            <!-- é‡æ–°åŠ è½½æŒ‰é’® -->
            <div class="flex justify-end">
              <button onclick="loadSlotConfig()" class="px-5 py-2 bg-white hover:bg-slate-50 text-slate-700 rounded-lg font-medium transition-all border border-slate-300 shadow-sm hover:shadow flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>é‡æ–°åŠ è½½é…ç½®</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Slot Analytics Section -->
        <div id="slotAnalyticsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ° æŠ½å¥–æ•°æ®åˆ†æ</h2>
            <button onclick="loadSlotAnalytics()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="analyticsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°æ•°æ®
            </button>
          </div>
          
          <!-- ğŸ”¥ åˆ†æç­›é€‰æ  -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- åˆ†æèŒƒå›´é€‰æ‹© -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ğŸ“Š åˆ†æèŒƒå›´</label>
                <select 
                  id="analyticsRecordCount" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  onchange="loadSlotAnalytics()"
                >
                  <option value="100">æœ€è¿‘100æ¬¡æ¸¸æˆ</option>
                  <option value="500" selected>æœ€è¿‘500æ¬¡æ¸¸æˆ</option>
                  <option value="1000">æœ€è¿‘1000æ¬¡æ¸¸æˆ</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">ä¿®æ”¹æƒé‡åé€‰æ‹©100æ¬¡å¯å¿«é€Ÿè§‚å¯Ÿæ•ˆæœ</p>
              </div>
              
              <!-- æ¸¸æˆæ¨¡å¼ç­›é€‰ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ğŸ® æ¸¸æˆæ¨¡å¼</label>
                <select 
                  id="analyticsSlotMode" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  onchange="loadSlotAnalytics()"
                >
                  <option value="all" selected>å…¨éƒ¨æ¨¡å¼</option>
                  <option value="normal">åˆçº§åœº</option>
                  <option value="advanced">é«˜çº§åœº</option>
                  <option value="supreme">è‡³å°Šåœº</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">å„åœºæ¬¡ä½¿ç”¨ç‹¬ç«‹çš„æƒé‡å’Œå¥–åŠ±é…ç½®</p>
              </div>
              
              <!-- è¯´æ˜ä¿¡æ¯ -->
              <div class="flex items-center">
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                  <p class="text-xs text-blue-800">
                    <strong>æç¤ºï¼š</strong> 
                    <br>â€¢ åˆçº§åœºï¼šä»»æ„ä½ç½®ç›¸åŒå³å¯
                    <br>â€¢ é«˜çº§åœºï¼šå¿…é¡»ç›¸é‚»è¿ç»­
                    <br>â€¢ è‡³å°Šåœºï¼šä½¿ç”¨ç‹¬ç«‹é…ç½®æ–¹æ¡ˆ
                    <br>â€¢ å»ºè®®åˆ†åˆ«æŸ¥çœ‹å„æ¨¡å¼æ•°æ®
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- æ¦‚è§ˆç»Ÿè®¡ -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">æ€»æ¸¸æˆæ¬¡æ•°</h3>
                <span class="text-2xl">ğŸ°</span>
              </div>
              <p id="analyticsTotal" class="text-3xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">ä¸­å¥–ç‡</h3>
                <span class="text-2xl">ğŸ¯</span>
              </div>
              <p id="analyticsWinRate" class="text-3xl font-bold text-green-600">0%</p>
              <p class="text-xs text-slate-500 mt-1">ä¸­å¥– <span id="analyticsWinCount">0</span> æ¬¡</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">æ€»æŠ•æ³¨</h3>
                <span class="text-2xl">ğŸ’°</span>
              </div>
              <p id="analyticsTotalBet" class="text-3xl font-bold text-red-600">$0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">å‡€ç›ˆäº</h3>
                <span class="text-2xl">ğŸ“Š</span>
              </div>
              <p id="analyticsNetProfit" class="text-3xl font-bold">$0</p>
              <p class="text-xs text-slate-500 mt-1">æ€»èµ¢å¾— <span id="analyticsTotalWin">$0</span></p>
            </div>
            
            <!-- ğŸ”¥ æ–°å¢ï¼šRTPç»Ÿè®¡ -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">å®é™…RTP</h3>
                <span class="text-2xl">ğŸ“ˆ</span>
              </div>
              <p id="analyticsRTP" class="text-3xl font-bold text-purple-600">0%</p>
              <p class="text-xs text-slate-500 mt-1">è¿”è¿˜ç©å®¶ç‡</p>
            </div>
          </div>
          
          <!-- ğŸ”¥ RTPè¯¦ç»†åˆ†æ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">ğŸ“ˆ RTPè¯¦ç»†åˆ†æ</h3>
            
            <!-- RTPè¯´æ˜ -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
              <div class="flex items-start gap-3">
                <div class="text-2xl">ğŸ’¡</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-purple-900 mb-2">ä»€ä¹ˆæ˜¯RTPï¼Ÿ</h4>
                  <p class="text-sm text-purple-800 mb-2">
                    RTP (Return to Player) = è¿”è¿˜ç©å®¶ç‡ï¼Œè¡¨ç¤ºç©å®¶é•¿æœŸæ¸¸æˆèƒ½æ‹¿å›çš„æŠ•æ³¨æ¯”ä¾‹
                  </p>
                  <p class="text-sm text-purple-700">
                    <strong>è®¡ç®—å…¬å¼ï¼š</strong> RTP = (æ€»èµ¢å¾— Ã· æ€»æŠ•æ³¨) Ã— 100%
                  </p>
                  <p class="text-xs text-purple-600 mt-2">
                    ä¾‹å¦‚ï¼šæ€»æŠ•æ³¨$1000ï¼Œæ€»èµ¢å¾—$880 â†’ RTP = 88%ï¼ˆç©å®¶æ‹¿å›88%ï¼Œç³»ç»Ÿæ”¶ç›Š12%ï¼‰
                  </p>
                </div>
              </div>
            </div>
            
            <!-- RTPç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- æ•´ä½“RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">æ•´ä½“RTP</span>
                  <span id="rtpOverall" class="text-2xl font-bold text-purple-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>æ€»æŠ•æ³¨:</span>
                    <span id="rtpTotalBet" class="font-semibold">$0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>æ€»èµ¢å¾—:</span>
                    <span id="rtpTotalWin" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
              
              <!-- ä¸­å¥–RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">ä¸­å¥–æ¸¸æˆRTP</span>
                  <span id="rtpWinGames" class="text-2xl font-bold text-green-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>ä¸­å¥–æ¬¡æ•°:</span>
                    <span id="rtpWinCount" class="font-semibold">0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>ä¸­å¥–æŠ•æ³¨:</span>
                    <span id="rtpWinBet" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
              
              <!-- æœªä¸­å¥–RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">æœªä¸­å¥–æŸå¤±ç‡</span>
                  <span id="rtpLossRate" class="text-2xl font-bold text-red-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>æœªä¸­å¥–æ¬¡æ•°:</span>
                    <span id="rtpLossCount" class="font-semibold">0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>æŸå¤±é‡‘é¢:</span>
                    <span id="rtpLossAmount" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- RTPè¶‹åŠ¿ï¼ˆæŒ‰ä¸­å¥–ç±»å‹ï¼‰ -->
            <div class="mt-6">
              <h4 class="font-semibold text-slate-900 mb-3">å„ä¸­å¥–ç±»å‹RTPè´¡çŒ®</h4>
              <div class="space-y-2" id="rtpByWinType">
                <!-- å°†é€šè¿‡JSå¡«å…… -->
              </div>
            </div>
          </div>

          <!-- ä¸­å¥–ç±»å‹åˆ†å¸ƒ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">ğŸ ä¸­å¥–ç±»å‹åˆ†å¸ƒ</h3>
            <div class="space-y-3" id="winTypesDistribution">
              <!-- å°†é€šè¿‡JSå¡«å…… -->
            </div>
          </div>

          <!-- æ¯æ—¥ç»Ÿè®¡ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">ğŸ“… æœ€è¿‘7å¤©ç»Ÿè®¡</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">æ¸¸æˆæ¬¡æ•°</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">æ€»æŠ•æ³¨</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">æ€»èµ¢å¾—</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">å‡€ç›ˆäº</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">RTP</th>
                  </tr>
                </thead>
                <tbody id="dailyStatsBody" class="divide-y divide-slate-100">
                  <!-- å°†é€šè¿‡JSå¡«å…… -->
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Profit Leaderboard Section -->
        <div id="profitLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ† ç›ˆåˆ©æ’è¡Œæ¦œ</h2>
            <button onclick="loadProfitLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="profitLeaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°æ’è¡Œ
            </button>
          </div>

          <!-- æ’è¡Œæ¦œè¯´æ˜ -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-green-800 mb-2">
              <strong>ğŸ“Š æ’è¡Œä¾æ®ï¼š</strong>æŒ‰ç”¨æˆ·æ€»ç›ˆäºæ’åºï¼ˆæ€»èµ¢å¾— - æ€»æŠ•æ³¨ï¼‰
            </p>
            <p class="text-xs text-green-700">
              â€¢ æ˜¾ç¤ºèµšé’±æœ€å¤šçš„ç”¨æˆ· TOP 20<br>
              â€¢ å®æ—¶æ›´æ–°ï¼Œæ¯æ¬¡æ¸¸æˆåè‡ªåŠ¨åˆ·æ–°
            </p>
          </div>

          <!-- ç›ˆåˆ©æ’è¡Œæ¦œè¡¨æ ¼ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-500 to-orange-500 px-4 py-3">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span>ğŸ†</span>
                <span>ç›ˆåˆ©æ’è¡Œæ¦œ TOP 20</span>
                <span class="text-sm font-normal text-white/80">ï¼ˆèµšæœ€å¤šï¼‰</span>
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">æ’å</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase">LinuxDo ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">æ¸¸æˆæ¬¡æ•°</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">æ€»æŠ•æ³¨</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">æ€»è·å¥–</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">å‡€ç›ˆäº</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">æœ€å¤§å•æ¬¡å¥–é‡‘</th>
                  </tr>
                </thead>
                <tbody id="profitLeaderboardTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Loss Leaderboard Section -->
        <div id="lossLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ“‰ äºæŸæ’è¡Œæ¦œ</h2>
            <button onclick="loadLossLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
              <svg id="lossLeaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°æ’è¡Œ
            </button>
          </div>

          <!-- æ’è¡Œæ¦œè¯´æ˜ -->
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-red-800 mb-2">
              <strong>ğŸ“Š æ’è¡Œä¾æ®ï¼š</strong>æŒ‰ç”¨æˆ·æ€»ç›ˆäºæ’åºï¼ˆæ€»èµ¢å¾— - æ€»æŠ•æ³¨ï¼‰
            </p>
            <p class="text-xs text-red-700">
              â€¢ æ˜¾ç¤ºäºæŸæœ€å¤šçš„ç”¨æˆ· TOP 20ï¼ˆè­¦ç¤ºä½œç”¨ï¼‰<br>
              â€¢ å®æ—¶æ›´æ–°ï¼Œæ¯æ¬¡æ¸¸æˆåè‡ªåŠ¨åˆ·æ–°
            </p>
          </div>
          
          <!-- äºæŸæ’è¡Œæ¦œè¡¨æ ¼ -->
          <div class="bg-white rounded-xl shadow-sm border-2 border-red-200 overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-rose-500 px-4 py-3">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span>ğŸ“‰</span>
                <span>äºæŸæ’è¡Œæ¦œ TOP 20</span>
                <span class="text-sm font-normal text-white/80">ï¼ˆäºæœ€å¤šï¼‰</span>
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-red-50 border-b border-red-200">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-red-700 uppercase">æ’å</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase">LinuxDo ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-red-700 uppercase">æ¸¸æˆæ¬¡æ•°</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">æ€»æŠ•æ³¨</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">æ€»è·å¥–</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">å‡€ç›ˆäº</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">äºæŸç‡</th>
                  </tr>
                </thead>
                <tbody id="lossLeaderboardTableBody" class="divide-y divide-red-100">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Slot Machine Records Section -->
        <div id="slotRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ° åˆçº§åœºæ¸¸æˆè®°å½•</h2>
            <button onclick="refreshSlotRecords()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="slotRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          
          <!-- æœç´¢å’Œç­›é€‰æ  -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- æœç´¢ç”¨æˆ·å -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœç´¢ç”¨æˆ·å</label>
                <div class="relative">
                <input 
                  type="text" 
                  id="adminRecordSearchInput" 
                  placeholder="è¾“å…¥LinuxDoç”¨æˆ·åæˆ–å…¬ç›Šç«™ç”¨æˆ·å..." 
                  class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- ä¸­å¥–ç±»å‹ç­›é€‰ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä¸­å¥–ç±»å‹</label>
                <select
                  id="adminWinTypeFilter"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="all">å…¨éƒ¨ç±»å‹</option>
                  <!-- ğŸ”¥ åŠ¨æ€åŠ è½½è§„åˆ™æ¨¡æ¿é€‰é¡¹ï¼ˆåœ¨é¡µé¢åˆå§‹åŒ–æ—¶å¡«å……ï¼‰-->
                </select>
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterAdminSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  ğŸ” æŸ¥è¯¢
                </button>
                <button 
                  onclick="refreshAdminSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-1"
                  title="åˆ·æ–°æ•°æ®ï¼ˆä¿ç•™ç­›é€‰æ¡ä»¶ï¼‰"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  åˆ·æ–°
                </button>
                <button 
                  onclick="clearAdminRecordFilters()" 
                  class="flex-1 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors font-medium"
                >
                  ğŸ”„ é‡ç½®
                </button>
              </div>
            </div>
            
            <!-- ç­›é€‰ç»“æœæç¤º -->
            <div id="adminFilterResultHint" class="text-sm text-slate-600 hidden"></div>
          </div>
          
          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                æ€»è®°å½•æ•°: <span id="slotTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="text-sm text-slate-600">
                ç­›é€‰ç»“æœ: <span id="slotFiltered" class="font-bold text-indigo-600">0</span>
              </div>
              <div class="flex items-center gap-2 ml-auto">
                <label class="text-sm text-slate-600">æ¯é¡µæ˜¾ç¤º:</label>
                <select id="slotPageSize" onchange="changeSlotPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20æ¡</option>
                  <option value="50" selected>50æ¡</option>
                  <option value="100">100æ¡</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Linux Do ID</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">ç»“æœç¬¦å·</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">ä¸­å¥–ç±»å‹</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">å€ç‡</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">æŠ•æ³¨</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">èµ¢å¾—</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">ç±»å‹</th>
                  </tr>
                </thead>
                <tbody id="slotTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="9" class="px-4 py-8 text-center text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
              <div class="flex items-center justify-between">
                <button onclick="loadSlotRecords(slotCurrentPage - 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotPrevBtn">
                  ä¸Šä¸€é¡µ
                </button>
                <span class="text-sm text-slate-600">
                  ç¬¬ <span id="slotCurrentPage" class="font-semibold">1</span> é¡µ / å…± <span id="slotTotalPages" class="font-semibold">1</span> é¡µ
                </span>
                <button onclick="loadSlotRecords(slotCurrentPage + 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotNextBtn">
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ç”¨æˆ·åˆ—è¡¨</h2>
            <button onclick="refreshUsers()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="usersRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          
          <!-- ğŸ” æœç´¢æ  -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- ç”¨æˆ·åæœç´¢ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœç´¢ç”¨æˆ·</label>
                <div class="relative">
                  <input
                    type="text"
                    id="usersSearchInput"
                    placeholder="è¾“å…¥LinuxDoç”¨æˆ·åæˆ–å…¬ç›Šç«™ç”¨æˆ·åï¼ˆlinuxdo_xxxï¼‰..."
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    onkeypress="if(event.key === 'Enter') filterUsers()"
                  >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterUsers()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  ğŸ” æœç´¢
                </button>
                <button 
                  onclick="clearUsersFilter()" 
                  class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors font-medium"
                >
                  ğŸ”„ é‡ç½®
                </button>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center gap-4">
                <div class="text-sm text-slate-600">
                  æ€»ç”¨æˆ·æ•°: <span id="usersTotal" class="font-bold text-slate-900">0</span>
                  <span id="usersFilteredInfo" class="hidden text-indigo-600 ml-2">ï¼ˆç­›é€‰å: <span id="usersFilteredCount">0</span>ï¼‰</span>
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-600">æ¯é¡µæ˜¾ç¤º:</label>
                  <select id="usersPageSize" onchange="changeUsersPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                    <option value="10">10æ¡</option>
                    <option value="20" selected>20æ¡</option>
                    <option value="50">50æ¡</option>
                    <option value="100">100æ¡</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="exportUsersData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ“¥ å¯¼å‡º</button>
                <button onclick="toggleUsersBatchMode()" id="usersBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">æ‰¹é‡æ“ä½œ</button>
              </div>
            </div>
            <div id="usersBatchActions" class="hidden mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">å…¨é€‰ (<span id="selectedUsersCount">0</span> ä¸ªå·²é€‰)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="batchBanUsers()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">ğŸš« æ‰¹é‡å°ç¦</button>
                  <button onclick="batchUnbindUsers()" class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold">ğŸ”“ æ‰¹é‡è§£ç»‘</button>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="usersCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllUsersHeader" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">#</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">LinuxDoç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æŠ•å–‚æ¬¡æ•°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">é¢†å–æ¬¡æ•°</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">æ€»è·å¾—é¢åº¦</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">ç®¡ç†</th>
                  </tr>
                </thead>
                <tbody id="usersListBody"></tbody>
              </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="usersPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  ç¬¬ <span id="usersCurrentPage">1</span> / <span id="usersTotalPages">1</span> é¡µ
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadUsersList(usersCurrentPage - 1)" id="usersPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>ä¸Šä¸€é¡µ</button>
                  <div id="usersPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadUsersList(usersCurrentPage + 1)" id="usersNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">ä¸‹ä¸€é¡µ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Grant Free Spins Section -->
        <div id="grantFreeSpinsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ å‘æ”¾å…è´¹æ¬¡æ•°</h2>
          
          <!-- å•ä¸ªç”¨æˆ·å‘æ”¾ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">å•ä¸ªç”¨æˆ·å‘æ”¾</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·æ ‡è¯† *</label>
                <div class="relative">
                  <input type="text" id="singleUserIdentifier" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–IDï¼Œå¦‚: linuxdo_123 æˆ– 123456" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onkeyup="searchUserDebounced()">
                  <div id="singleUserSearchResults" class="hidden absolute z-10 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <p class="text-xs text-slate-500 mt-1">æ”¯æŒç”¨æˆ·åï¼ˆlinuxdo_123ï¼‰æˆ– Linux Do IDï¼ˆ123456ï¼‰</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å…è´¹æ¬¡æ•° *</label>
                <input type="number" id="singleSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">æœ€å¤š100æ¬¡</p>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå› </label>
                <input type="text" id="singleReason" placeholder="ä¾‹å¦‚: bugè¡¥å¿ã€æ´»åŠ¨å¥–åŠ±ç­‰" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">é€‰å¡«ï¼Œè®°å½•å‘æ”¾åŸå› ä¾¿äºè¿½æº¯</p>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantSingleFreeSpin()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                å‘æ”¾
              </button>
              <button onclick="clearSingleForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                æ¸…ç©º
              </button>
            </div>
          </div>

          <!-- æ‰¹é‡å‘æ”¾ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">æ‰¹é‡å‘æ”¾</h3>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·åˆ—è¡¨ *</label>
                <textarea id="batchUserIdentifiers" rows="6" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–IDï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ï¼š&#10;linuxdo_123&#10;linuxdo_456&#10;123456&#10;789012" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"></textarea>
                <p class="text-xs text-slate-500 mt-1">æ”¯æŒç”¨æˆ·åï¼ˆlinuxdo_xxxï¼‰æˆ–Linux Do IDï¼Œæ¯è¡Œä¸€ä¸ªï¼Œæœ€å¤š5000ä¸ªç”¨æˆ·</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">å…è´¹æ¬¡æ•° *</label>
                  <input type="number" id="batchSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <p class="text-xs text-slate-500 mt-1">æ¯ä¸ªç”¨æˆ·è·å¾—çš„æ¬¡æ•°</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå› </label>
                  <input type="text" id="batchReason" placeholder="ä¾‹å¦‚: bugè¡¥å¿ã€æ´»åŠ¨å¥–åŠ±ç­‰" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantBatchFreeSpin()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                æ‰¹é‡å‘æ”¾
              </button>
              <button onclick="clearBatchForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                æ¸…ç©º
              </button>
            </div>
          </div>

          <!-- å…¨å‘˜å‘æ”¾ -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl shadow-sm border-2 border-orange-300 p-6 mb-6">
            <h3 class="text-lg font-semibold text-orange-900 mb-2 flex items-center gap-2">
              <span>âš ï¸</span> 
              <span>å…¨å‘˜å‘æ”¾ï¼ˆæ…ç”¨ï¼‰</span>
            </h3>
            <p class="text-sm text-orange-800 mb-4">æ­¤åŠŸèƒ½å°†ä¸ºæ‰€æœ‰æœªå°ç¦ç”¨æˆ·ï¼ˆçº¦2000+ï¼‰å‘æ”¾å…è´¹æ¬¡æ•°ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å…è´¹æ¬¡æ•° *</label>
                <input type="number" id="allSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">æ¯ä¸ªç”¨æˆ·è·å¾—çš„æ¬¡æ•°</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå›  *</label>
                <input type="text" id="allReason" placeholder="ä¾‹å¦‚: ç³»ç»Ÿç»´æŠ¤è¡¥å¿" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">å¿…å¡«ï¼Œè®°å½•å…¨å‘˜å‘æ”¾åŸå› </p>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantAllFreeSpin()" class="px-8 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                âš ï¸ ç»™æ‰€æœ‰ç”¨æˆ·å‘æ”¾
              </button>
              <button onclick="clearAllForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                æ¸…ç©º
              </button>
            </div>
          </div>

          <!-- æŸ¥è¯¢ç”¨æˆ·å…è´¹æ¬¡æ•° -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">æŸ¥è¯¢ç”¨æˆ·å…è´¹æ¬¡æ•°</h3>
            <div class="flex gap-3">
              <div class="flex-1">
                <input type="text" id="queryUserIdentifier" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆlinuxdo_123ï¼‰æˆ–Linux Do ID" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
              <button onclick="queryUserFreeSpins()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                æŸ¥è¯¢
              </button>
            </div>
            <div id="queryResult" class="mt-4 hidden">
              <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                  <div>
                    <p class="text-sm text-slate-600">ç”¨æˆ·å</p>
                    <p id="queryUsername" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">å…è´¹æ¬¡æ•°</p>
                    <p id="queryFreeSpins" class="text-lg font-bold text-purple-600 mt-1">0</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">ç¦æ­¢æŠ½å¥–è‡³</p>
                    <p id="queryBannedUntil" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">æ›´æ–°æ—¶é—´</p>
                    <p id="queryUpdatedAt" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Rewards Section -->
        <div id="pendingRewardsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ’° å¾…å‘æ”¾å¥–é‡‘ç®¡ç†</h2>
            <div class="flex gap-2">
              <button onclick="refreshPendingRewards()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg id="pendingRewardsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                åˆ·æ–°
              </button>
              <button onclick="processAllPendingRewards()" id="processAllBtn" class="flex items-center gap-2 px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all font-semibold shadow-lg">
                <span>ğŸš€</span> ä¸€é”®å‘æ”¾å…¨éƒ¨
              </button>
            </div>
          </div>

          <!-- ç»Ÿè®¡å¡ç‰‡ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">ğŸ“‹</div>
                <div>
                  <p class="text-sm text-slate-600">å¾…å‘æ”¾æ€»æ•°</p>
                  <p id="pendingTotal" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">ğŸ’µ</div>
                <div>
                  <p class="text-sm text-slate-600">å¾…å‘æ”¾æ€»é¢</p>
                  <p id="pendingTotalAmount" class="text-2xl font-bold text-green-600">$0.00</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">â³</div>
                <div>
                  <p class="text-sm text-slate-600">å¾…å¤„ç†</p>
                  <p id="pendingCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">âŒ</div>
                <div>
                  <p class="text-sm text-slate-600">å¤±è´¥</p>
                  <p id="failedCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- å·²å‘æ”¾ç»Ÿè®¡ -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-200 rounded-lg flex items-center justify-center text-2xl">âœ…</div>
                <div>
                  <p class="text-sm text-green-700 font-medium">å·²æˆåŠŸå‘æ”¾ï¼ˆæœ€è¿‘200æ¡ï¼‰</p>
                </div>
              </div>
              <div class="flex gap-6">
                <div class="text-right">
                  <p class="text-xs text-green-600">å‘æ”¾æ¬¡æ•°</p>
                  <p id="successCount" class="text-2xl font-bold text-green-700">0</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-green-600">å‘æ”¾é‡‘é¢</p>
                  <p id="successAmount" class="text-2xl font-bold text-green-700">$0.00</p>
                </div>
              </div>
            </div>
          </div>

          <!-- è¯´æ˜æç¤º -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <div class="text-2xl">â„¹ï¸</div>
              <div class="flex-1">
                <h3 class="font-semibold text-blue-900 mb-2">å…³äºå¾…å‘æ”¾å¥–é‡‘</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                  <li>â€¢ <strong>è‡ªåŠ¨å‘æ”¾</strong>ï¼šç³»ç»Ÿæ¯ 60 ç§’è‡ªåŠ¨å°è¯•å‘æ”¾ä¸€æ¬¡å¾…å¤„ç†çš„å¥–é‡‘</li>
                  <li>â€¢ <strong>ä¸€é”®å‘æ”¾</strong>ï¼šç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨è§¦å‘ç«‹å³å‘æ”¾ï¼Œä½œä¸ºè‡ªåŠ¨å‘æ”¾å¤±è´¥æ—¶çš„è¡¥å……</li>
                  <li>â€¢ <strong>é‡è¯•æœºåˆ¶</strong>ï¼šå¤±è´¥çš„è®°å½•å¯ä»¥é‡ç½®çŠ¶æ€ï¼Œè®©ç³»ç»Ÿé‡æ–°å°è¯•</li>
                  <li>â€¢ <strong>æœ€å¤§é‡è¯•</strong>ï¼šæ¯æ¡è®°å½•æœ€å¤šé‡è¯• 10 æ¬¡ï¼Œè¶…è¿‡åæ ‡è®°ä¸ºå¤±è´¥</li>
                  <li>â€¢ <strong>è®°å½•ä¿ç•™</strong>ï¼šæ‰€æœ‰è®°å½•åŒ…æ‹¬æˆåŠŸçš„éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œæ˜¾ç¤ºæœ€è¿‘200æ¡</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- å¥–é‡‘åˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å¥–é‡‘é‡‘é¢</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">åŸå› </th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">é‡è¯•æ¬¡æ•°</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">åˆ›å»ºæ—¶é—´</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="pendingRewardsTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ğŸ† Achievement Management Section -->
        <div id="achievementManagementSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ† æˆå°±ç®¡ç†</h2>
            <div class="flex gap-3">
              <button onclick="updateAchievementRewards()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold flex items-center gap-2">
                <span>ğŸ’°</span>
                <span>æ›´æ–°å¥–åŠ±é¢åº¦</span>
              </button>
              <button onclick="refreshAchievements()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg id="achievementRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                åˆ·æ–°
              </button>
            </div>
          </div>

          <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">ğŸ†</div>
                <div>
                  <p class="text-sm text-slate-600">æˆå°±æ€»æ•°</p>
                  <p id="totalAchievements" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">ğŸ‘¥</div>
                <div>
                  <p class="text-sm text-slate-600">å‚ä¸ç”¨æˆ·</p>
                  <p id="totalAchievementUsers" class="text-2xl font-bold text-green-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">ğŸ</div>
                <div>
                  <p class="text-sm text-slate-600">å¥–åŠ±æ± æ€»é¢</p>
                  <p id="totalRewardsPool" class="text-2xl font-bold text-purple-600">$0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-2xl">ğŸ’°</div>
                <div>
                  <p class="text-sm text-slate-600">å·²å‘æ”¾å¥–åŠ±</p>
                  <p id="totalRewardsDistributed" class="text-2xl font-bold text-orange-600">$0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ç­›é€‰å’Œæœç´¢ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
            <div class="flex flex-wrap gap-3">
              <select id="achievementCategoryFilter" onchange="filterAchievements()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">
                <option value="">å…¨éƒ¨ç±»åˆ«</option>
                <option value="æ–°æ‰‹æˆå°±">æ–°æ‰‹æˆå°±</option>
                <option value="æ¸¸æˆæˆå°±">æ¸¸æˆæˆå°±</option>
                <option value="ä¸­å¥–æˆå°±">ä¸­å¥–æˆå°±</option>
                <option value="æ¢ç´¢æˆå°±">æ¢ç´¢æˆå°±</option>
                <option value="ç¤¾äº¤æˆå°±">ç¤¾äº¤æˆå°±</option>
                <option value="æŒ‘æˆ˜æˆå°±">æŒ‘æˆ˜æˆå°±</option>
                <option value="å¤å‘—æˆå°±">å¤å‘—æˆå°±</option>
                <option value="æƒ©ç½šæˆå°±">æƒ©ç½šæˆå°±</option>
                <option value="æ”¶è—æˆå°±">æ”¶è—æˆå°±</option>
                <option value="è´¢å¯Œæˆå°±">è´¢å¯Œæˆå°±</option>
              </select>
              <select id="achievementRarityFilter" onchange="filterAchievements()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">
                <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
                <option value="common">æ™®é€š</option>
                <option value="rare">ç¨€æœ‰</option>
                <option value="epic">å²è¯—</option>
                <option value="legendary">ä¼ è¯´</option>
              </select>
              <input type="text" id="achievementSearchInput" oninput="filterAchievements()" placeholder="æœç´¢æˆå°±åç§°æˆ–æè¿°..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-sm">
            </div>
          </div>

          <!-- æˆå°±åˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">å›¾æ ‡</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æˆå°±åç§°</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç±»åˆ«</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç¨€æœ‰åº¦</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å¥–åŠ±é‡‘é¢</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">è§£é”äººæ•°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">è¾¾æˆç‡</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="achievementTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ğŸ… Achievement Leaderboard Section -->
        <div id="achievementLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ… æˆå°±æ’è¡Œæ¦œ</h2>
            <button onclick="refreshAchievementLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="leaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>

          <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ’å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å·²è§£é”</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å®Œæˆç‡</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">æ€»å¥–åŠ±</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å·²é¢†å–</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å¾½ç« </th>
                  </tr>
                </thead>
                <tbody id="leaderboardTableBody">
                  <tr>
                    <td colspan="7" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ğŸš« Banned Users Section -->
        <div id="bannedUsersSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸš« å°ç¦è®°å½•ç®¡ç†</h2>
            <div class="flex gap-3">
              <button onclick="batchUnbanAllUsers()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all shadow-sm font-semibold">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                </svg>
                ğŸ”“ ä¸€é”®è§£å°å…¨éƒ¨
              </button>
              <button onclick="refreshBannedUsers()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                åˆ·æ–°
              </button>
            </div>
          </div>

          <!-- ç»Ÿè®¡å¡ç‰‡ -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">ğŸš«</div>
                <div>
                  <p class="text-sm text-slate-600">å½“å‰å°ç¦ç”¨æˆ·</p>
                  <p id="bannedUsersCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">â±ï¸</div>
                <div>
                  <p class="text-sm text-slate-600">ä¸´æ—¶å°ç¦</p>
                  <p id="tempBannedCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl">ğŸ”’</div>
                <div>
                  <p class="text-sm text-slate-600">æ°¸ä¹…å°ç¦</p>
                  <p id="permBannedCount" class="text-2xl font-bold text-gray-700">0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- è¯´æ˜æç¤º -->
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <div class="text-2xl">âš ï¸</div>
              <div class="flex-1">
                <h3 class="font-semibold text-amber-900 mb-2">å…³äºå°ç¦ç³»ç»Ÿ</h3>
                <ul class="text-sm text-amber-800 space-y-1">
                  <li>â€¢ <strong>ä¸´æ—¶å°ç¦</strong>ï¼šè§¦å‘å¾‹å¸ˆå‡½æƒ©ç½šåè‡ªåŠ¨å°ç¦ï¼ˆæ—¶é•¿ç”±å¥–åŠ±é…ç½®æ–¹æ¡ˆä¸­çš„æƒ©ç½šé…ç½®å†³å®šï¼‰</li>
                  <li>â€¢ <strong>æ°¸ä¹…å°ç¦</strong>ï¼šç”±ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®çš„æ°¸ä¹…å°ç¦çŠ¶æ€</li>
                  <li>â€¢ <strong>è‡ªåŠ¨è§£å°</strong>ï¼šä¸´æ—¶å°ç¦åˆ°æœŸåç³»ç»Ÿä¼šè‡ªåŠ¨è§£å°</li>
                  <li>â€¢ <strong>æ‰‹åŠ¨è§£å°</strong>ï¼šç®¡ç†å‘˜å¯ä»¥æå‰è§£é™¤ä»»ä½•å°ç¦ï¼ˆåŒ…æ‹¬ä½¿ç”¨æ‰¹é‡è§£å°ï¼‰</li>
                  <li>â€¢ <strong>å°ç¦å½±å“</strong>ï¼šè¢«å°ç¦ç”¨æˆ·æ— æ³•è¿›è¡Œä»»ä½•æŠ½å¥–æ“ä½œ</li>
                  <li>â€¢ <strong>åœºæ¬¡æ ‡è®°</strong>ï¼šç³»ç»Ÿä¼šè®°å½•å°ç¦å‘ç”Ÿåœ¨å“ªä¸ªåœºæ¬¡ï¼ˆåˆçº§åœº/é«˜çº§åœº/è‡³å°Šåœºï¼‰</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- å°ç¦è®°å½•åˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-red-50 to-orange-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">LinuxDo</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">å°ç¦æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">è§£å°æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">å°ç¦åŸå› </th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">è§¦å‘åœºæ¬¡</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å°ç¦ç±»å‹</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="bannedUsersTableBody">
                  <tr>
                    <td colspan="10" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ğŸ” Kunbei Management Section -->
        <div id="kunbeiManagementSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ” å¤å‘—è´·æ¬¾ç®¡ç†</h2>
            <button onclick="refreshKunbeiData()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          
          <!-- é…ç½®å¡ç‰‡ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">âš™ï¸ å¤å‘—é…ç½®</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- å¯ç”¨çŠ¶æ€ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å¯ç”¨çŠ¶æ€</label>
                <select id="kunbeiEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="1">âœ… å¯ç”¨</option>
                  <option value="0">âŒ ç¦ç”¨</option>
                </select>
              </div>
              
              <!-- æœ€å¤§å€Ÿæ¬¾é¢åº¦ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœ€å¤§å€Ÿæ¬¾é¢åº¦</label>
                <input type="number" id="kunbeiMaxAmount" min="10" max="1000" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">å•ä½ï¼šç¾å…ƒ</p>
              </div>
              
              <!-- è¿˜æ¬¾å€æ•° -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">è¿˜æ¬¾å€æ•°</label>
                <input type="number" id="kunbeiRepayMultiplier" min="1" max="10" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">ä¾‹å¦‚ï¼š2.5è¡¨ç¤ºè¿˜2.5å€</p>
              </div>
              
              <!-- å€Ÿæ¬¾æœŸé™ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å€Ÿæ¬¾æœŸé™</label>
                <input type="number" id="kunbeiDuration" min="0.5" max="720" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">å•ä½ï¼šå°æ—¶ï¼Œæ”¯æŒå°æ•°ï¼ˆå¦‚2.5å°æ—¶ï¼‰</p>
              </div>
              
              <!-- æå‰è¿˜æ¬¾ä¼˜æƒ  -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æå‰è¿˜æ¬¾ä¼˜æƒ </label>
                <input type="number" id="kunbeiEarlyDiscount" min="0" max="0.5" step="0.001" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">ä¾‹å¦‚ï¼š0.025è¡¨ç¤ºå…é™¤2.5%</p>
              </div>
              
              <!-- é€¾æœŸæƒ©ç½šæ—¶é•¿ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">é€¾æœŸæƒ©ç½šæ—¶é•¿</label>
                <input type="number" id="kunbeiOverduePenalty" min="1" max="720" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">ç¦æ­¢é«˜çº§åœºçš„å°æ—¶æ•°</p>
              </div>
              
              <!-- é€¾æœŸæ‰£æ¬¾å€æ•° -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">é€¾æœŸæ‰£æ¬¾å€æ•°</label>
                <input type="number" id="kunbeiOverdueDeductMultiplier" min="1" max="10" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">é€¾æœŸæ—¶æ‰£é™¤æ¬ æ¬¾çš„å€æ•°ï¼ˆå¦‚2.5å€ï¼‰</p>
              </div>
              
              <!-- æ¯æ—¥å€Ÿæ¬¾æ¬¡æ•°é™åˆ¶ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥å€Ÿæ¬¾æ¬¡æ•°</label>
                <input type="number" id="kunbeiMaxDailyBorrows" min="1" max="20" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">ç”¨æˆ·æ¯å¤©æœ€å¤šå¯å€Ÿæ¬¾æ¬¡æ•°ï¼ˆé»˜è®¤3æ¬¡ï¼‰</p>
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button onclick="saveKunbeiConfig()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                ğŸ’¾ ä¿å­˜é…ç½®
              </button>
            </div>
          </div>
          
          <!-- æ¢¯åº¦é…ç½®å¡ç‰‡ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">ğŸ“Š æ¢¯åº¦é¢åº¦é…ç½®</h3>
              <button onclick="showGradientConfigModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                â• æ·»åŠ æ¢¯åº¦
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-slate-200">
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">é¢åº¦é˜ˆå€¼</th>
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">æœ€å¤§å¯å€Ÿé‡‘é¢</th>
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">çŠ¶æ€</th>
                    <th class="text-center py-3 px-4 font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="gradientConfigsTable">
                  <tr>
                    <td colspan="4" class="text-center py-8 text-slate-500">
                      <div class="text-4xl mb-2">ğŸ“‹</div>
                      <p>æš‚æ— æ¢¯åº¦é…ç½®</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <p class="text-sm text-amber-800">
                <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®ç”¨æˆ·é¢åº¦åŒ¹é…å€Ÿæ¬¾é¢åº¦ã€‚ç”¨æˆ·é¢åº¦ä½äºæ‰€æœ‰é˜ˆå€¼æ—¶ï¼Œä½¿ç”¨æœ€å°é˜ˆå€¼çš„å€Ÿæ¬¾é¢åº¦ã€‚
              </p>
              <p class="text-sm text-amber-800 mt-2">
                <strong>é…ç½®ç¤ºä¾‹ï¼š</strong><br>
                â€¢ é˜ˆå€¼ $5000ï¼Œå¯å€Ÿ $10 - é¢åº¦ < $5000 çš„ç”¨æˆ·å¯å€Ÿ $10<br>
                â€¢ é˜ˆå€¼ $100000ï¼Œå¯å€Ÿ $200 - é¢åº¦ â‰¥ $100000 çš„ç”¨æˆ·å¯å€Ÿ $200<br>
                â€¢ é˜ˆå€¼ $1000000ï¼Œå¯å€Ÿ $400 - é¢åº¦ â‰¥ $1000000 çš„ç”¨æˆ·å¯å€Ÿ $400
              </p>
              <p class="text-sm text-amber-700 mt-2">
                <strong>âš ï¸ é‡è¦ï¼š</strong>ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰é˜ˆå€¼æ’åºå¤„ç†ï¼Œæ— éœ€è®¾ç½®ä¼˜å…ˆçº§ã€‚
              </p>
            </div>
          </div>
          
          <!-- é€¾æœŸæ‰£é™¤é…ç½®è¯´æ˜ -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-bold text-orange-900 mb-4 flex items-center gap-2">
              <span class="text-2xl">âš¡</span>
              é€¾æœŸæ‰£æ¬¾è§„åˆ™è¯´æ˜
            </h3>
            
            <div class="space-y-3 text-sm">
              <div class="bg-white rounded-lg p-4 border border-orange-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ’¡</span>
                  <div class="flex-1">
                    <p class="font-semibold text-orange-900 mb-2">æ‰£æ¬¾è®¡ç®—å…¬å¼</p>
                    <p class="text-orange-800">
                      è‡ªåŠ¨æ‰£æ¬¾é‡‘é¢ = åº”è¿˜é‡‘é¢ Ã— é€¾æœŸæ‰£æ¬¾å€æ•°ï¼ˆé»˜è®¤2.5å€ï¼‰
                    </p>
                    <p class="text-orange-700 mt-2">
                      <strong>ç¤ºä¾‹ï¼š</strong>ç”¨æˆ·æ¬ æ¬¾ $400ï¼Œé€¾æœŸæ‰£æ¬¾å€æ•°ä¸º 2.5<br>
                      â†’ è‡ªåŠ¨æ‰£æ¬¾ = $400 Ã— 2.5 = $1000
                    </p>
                  </div>
                </div>
              </div>
              
              <div class="bg-white rounded-lg p-4 border border-orange-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ›¡ï¸</span>
                  <div class="flex-1">
                    <p class="font-semibold text-orange-900 mb-2">ä¿æŠ¤æœºåˆ¶</p>
                    <ul class="text-orange-800 space-y-1">
                      <li>â€¢ å¦‚æœç”¨æˆ·ä½™é¢ä¸è¶³ï¼Œåªæ‰£åˆ° $0ï¼Œä¸ä¼šæ‰£ä¸ºè´Ÿæ•°</li>
                      <li>â€¢ å¦‚æœç”¨æˆ·ä½™é¢ä¸º $0ï¼Œåˆ™ä¸æ‰£æ¬¾</li>
                      <li>â€¢ æ‰£æ¬¾è®°å½•ä¼šä¿å­˜åœ¨å€Ÿæ¬¾è®°å½•çš„"è‡ªåŠ¨æ‰£æ¬¾"åˆ—ä¸­</li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="bg-white rounded-lg p-4 border border-red-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ”’</span>
                  <div class="flex-1">
                    <p class="font-semibold text-red-900 mb-2">é€¾æœŸæƒ©ç½š</p>
                    <ul class="text-red-800 space-y-1">
                      <li>â€¢ é€¾æœŸåç¦æ­¢è¿›å…¥é«˜çº§åœºï¼ˆå¯åœ¨è´·æ¬¾è®°å½•ä¸­è§£å°ï¼‰</li>
                      <li>â€¢ ç¦å…¥æ—¶é•¿ç”±"é€¾æœŸæƒ©ç½šæ—¶é•¿"é…ç½®å†³å®š</li>
                      <li>â€¢ ç®¡ç†å‘˜å¯æ‰‹åŠ¨è§£å°ï¼ˆç‚¹å‡»"ğŸ”“ è§£å°"æŒ‰é’®ï¼‰</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ç»Ÿè®¡å¡ç‰‡ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">â³</div>
                <div>
                  <p class="text-sm text-slate-600">æ´»è·ƒå€Ÿæ¬¾</p>
                  <p id="kunbeiActiveCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">âš ï¸</div>
                <div>
                  <p class="text-sm text-slate-600">é€¾æœŸå€Ÿæ¬¾</p>
                  <p id="kunbeiOverdueCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">ğŸ’°</div>
                <div>
                  <p class="text-sm text-slate-600">æ€»å€Ÿå‡º</p>
                  <p id="kunbeiTotalLoan" class="text-2xl font-bold text-blue-600">$0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">âœ…</div>
                <div>
                  <p class="text-sm text-slate-600">æ€»å›æ”¶</p>
                  <p id="kunbeiTotalRepaid" class="text-2xl font-bold text-green-600">$0</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ğŸ“‹ Kunbei Records Section (ç‹¬ç«‹çš„è´·æ¬¾è®°å½•ç®¡ç†) -->
        <div id="kunbeiRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ“‹ è´·æ¬¾è®°å½•ç®¡ç†</h2>
            <div class="flex gap-2">
              <button onclick="exportKunbeiRecords()" class="flex items-center gap-2 px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                å¯¼å‡ºè®°å½•
              </button>
              <button onclick="refreshKunbeiRecords()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                åˆ·æ–°
              </button>
            </div>
          </div>

          <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <!-- æœç´¢æ¡† -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">æœç´¢ç”¨æˆ·</label>
                <div class="flex gap-2">
                  <div class="relative flex-1">
                    <input type="text" id="kunbeiRecordSearch"
                           placeholder="è¾“å…¥LinuxDoç”¨æˆ·åæˆ–å…¬ç›Šç«™ç”¨æˆ·å..."
                           class="w-full px-4 py-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                           onkeyup="searchKunbeiRecords(event)">
                    <svg class="absolute left-3 top-2.5 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </div>
                  <button onclick="triggerKunbeiSearch()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium whitespace-nowrap">
                    ğŸ” æŸ¥æ‰¾
                  </button>
                </div>
              </div>

              <!-- çŠ¶æ€ç­›é€‰ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">çŠ¶æ€ç­›é€‰</label>
                <select id="kunbeiStatusFilter" onchange="filterKunbeiRecords()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option value="active">â³ å€Ÿæ¬¾ä¸­</option>
                  <option value="repaid">âœ… å·²è¿˜æ¬¾</option>
                  <option value="overdue">âš ï¸ å·²é€¾æœŸ</option>
                  <option value="forgiven">ğŸ¤ å·²å…é™¤</option>
                </select>
              </div>

              <!-- æ—¶é—´èŒƒå›´ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ—¶é—´èŒƒå›´</label>
                <select id="kunbeiTimeFilter" onchange="filterKunbeiRecords()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="">å…¨éƒ¨æ—¶é—´</option>
                  <option value="today">ä»Šå¤©</option>
                  <option value="week">æœ€è¿‘7å¤©</option>
                  <option value="month">æœ€è¿‘30å¤©</option>
                  <option value="all">æ‰€æœ‰è®°å½•</option>
                </select>
              </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-200">
              <label class="flex items-center gap-2">
                <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords()" class="w-4 h-4 text-indigo-600 border-slate-300 rounded">
                <span class="text-sm text-slate-700">å…¨é€‰</span>
              </label>
              <span class="text-sm text-slate-500">å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡è®°å½•</span>
              
              <div class="ml-auto flex gap-2">
                <button onclick="batchForgiveLoans()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors text-sm font-medium disabled:opacity-50" disabled id="batchForgiveBtn">
                  ğŸ¤ æ‰¹é‡å…é™¤
                </button>
                <button onclick="batchSendReminders()" class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-lg transition-colors text-sm font-medium disabled:opacity-50" disabled id="batchReminderBtn">
                  ğŸ“§ æ‰¹é‡å‚¬æ”¶
                </button>
              </div>
            </div>
          </div>

          <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-xl">ğŸ“Š</div>
                <div>
                  <p class="text-xs text-slate-600">æ€»è®°å½•æ•°</p>
                  <p id="totalRecordsCount" class="text-xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center text-xl">â³</div>
                <div>
                  <p class="text-xs text-slate-600">å€Ÿæ¬¾ä¸­</p>
                  <p id="activeLoansCount" class="text-xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-xl">âœ…</div>
                <div>
                  <p class="text-xs text-slate-600">å·²è¿˜æ¬¾</p>
                  <p id="repaidLoansCount" class="text-xl font-bold text-green-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-xl">âš ï¸</div>
                <div>
                  <p class="text-xs text-slate-600">å·²é€¾æœŸ</p>
                  <p id="overdueLoansCount" class="text-xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-xl">ğŸ’¸</div>
                <div>
                  <p class="text-xs text-slate-600">æ€»å€Ÿå‡º</p>
                  <p id="totalLoanedAmount" class="text-xl font-bold text-indigo-600">$0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-xl">ğŸ’°</div>
                <div>
                  <p class="text-xs text-slate-600">æ€»å›æ”¶</p>
                  <p id="totalRepaidAmount" class="text-xl font-bold text-emerald-600">$0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- è®°å½•åˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center">
                      <input type="checkbox" id="selectAllHeader" onchange="toggleAllRecords()" class="w-4 h-4 text-indigo-600 border-slate-300 rounded">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">LinuxDoç”¨æˆ·</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">å…¬ç›Šç«™ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å€Ÿæ¬¾é‡‘é¢</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">åº”è¿˜é‡‘é¢</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">è‡ªåŠ¨æ‰£æ¬¾</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">å€Ÿæ¬¾æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">åˆ°æœŸæ—¶é—´</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">çŠ¶æ€</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="kunbeiRecordsTableBody">
                  <tr>
                    <td colspan="11" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                æ˜¾ç¤ºç¬¬ <span id="recordsStart">0</span> - <span id="recordsEnd">0</span> æ¡ï¼Œå…± <span id="recordsTotal">0</span> æ¡è®°å½•
              </div>
              <div class="flex gap-2">
                <button onclick="changeRecordsPage(-1)" id="prevPageBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50" disabled>
                  ä¸Šä¸€é¡µ
                </button>
                <span class="px-4 py-2 text-sm">
                  ç¬¬ <span id="currentPageNum">1</span> / <span id="totalPageNum">1</span> é¡µ
                </span>
                <button onclick="changeRecordsPage(1)" id="nextPageBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50" disabled>
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- âš–ï¸ Weight Configs Section -->
        <div id="weightConfigsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">âš–ï¸ ç¬¦å·æƒé‡é…ç½®ç®¡ç†</h2>
            <button onclick="showAddWeightConfigModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
              â• æ·»åŠ æ–°é…ç½®
            </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">é…ç½®åç§°</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ä½¿ç”¨åœºæ¬¡</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æè¿°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="weightConfigsTableBody">
                  <tr>
                    <td colspan="5" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <p class="text-sm text-amber-800">
              <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>æƒé‡é…ç½®æ–¹æ¡ˆå¯è¢«åˆçº§åœºã€é«˜çº§åœºã€è‡³å°Šåœºå¼•ç”¨ã€‚ä¿®æ”¹é…ç½®åï¼Œä½¿ç”¨è¯¥é…ç½®çš„æ‰€æœ‰åœºæ¬¡å°†ç«‹å³ç”Ÿæ•ˆã€‚
            </p>
          </div>
        </div>

        <!-- ğŸ Reward Configs Section -->
        <div id="rewardConfigsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ å¥–åŠ±é…ç½®ç®¡ç†</h2>
            <div class="flex gap-3">
              <button onclick="fixManRules()" class="px-4 py-2 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold flex items-center gap-2">
                <span>ğŸ”§</span>
                <span>ä¿®å¤Manè§„åˆ™</span>
              </button>
              <button onclick="showAddRewardSchemeModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                â• æ·»åŠ æ–°æ–¹æ¡ˆ
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ–¹æ¡ˆåç§°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">è§„åˆ™æ•°é‡</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ä½¿ç”¨åœºæ¬¡</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æè¿°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="rewardSchemesTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <p class="text-sm text-amber-800">
              <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>å¥–åŠ±é…ç½®æ–¹æ¡ˆåŒ…å«å¤šæ¡ä¸­å¥–è§„åˆ™å’Œå¾‹å¸ˆå‡½æƒ©ç½šé…ç½®ã€‚ä¿®æ”¹æ–¹æ¡ˆåï¼Œä½¿ç”¨è¯¥æ–¹æ¡ˆçš„æ‰€æœ‰åœºæ¬¡å°†ç«‹å³ç”Ÿæ•ˆã€‚
            </p>
          </div>
        </div>

        <!-- ğŸ² Drop Configs Section -->
        <div id="dropConfigsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ² æ‰è½é…ç½®ç®¡ç†</h2>
          <p class="text-sm text-slate-600 mb-6">ç»Ÿä¸€ç®¡ç†æ‰€æœ‰åœºæ¬¡çš„ç‰©å“æ‰è½è§„åˆ™ï¼Œæ”¯æŒè·¨åœºæ¬¡é…ç½®</p>
          
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-3xl">ğŸ’¡</span>
              <div>
                <h3 class="font-bold text-purple-900">åŠŸèƒ½è¯´æ˜</h3>
                <p class="text-sm text-purple-800 mt-1">
                  â€¢ å¯ä¸ºä»»æ„åœºæ¬¡çš„ä»»æ„ä¸­å¥–è§„åˆ™é…ç½®æ‰è½<br>
                  â€¢ æ”¯æŒæ‰è½ï¼šå…¥åœºåˆ¸ã€ç¢ç‰‡ã€è‡³å°Šä»¤ç‰Œã€è‡³å°Šç¢ç‰‡<br>
                  â€¢ ä¸€ä¸ªè§„åˆ™å¯é…ç½®æ‰è½å¤šç§ç‰©å“ï¼Œæ¯ç§ç‰©å“ç‹¬ç«‹æ¦‚ç‡åˆ¤å®š
                </p>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">æ‰è½è§„åˆ™åˆ—è¡¨</h3>
              <button onclick="openAddDropConfigModal()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg font-semibold shadow-lg transition-all">
                â• æ·»åŠ æ‰è½è§„åˆ™
              </button>
            </div>
            
            <div id="dropConfigsList" class="space-y-4">
              <div class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>

        <!-- ğŸ² æ·»åŠ /ç¼–è¾‘æ‰è½é…ç½®å¼¹çª— -->
        <div id="dropConfigModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-indigo-600 p-6 border-b border-purple-500">
              <div class="flex justify-between items-center">
                <h3 id="dropConfigModalTitle" class="text-2xl font-bold text-white">ğŸ² é…ç½®æ‰è½è§„åˆ™</h3>
                <button onclick="closeDropConfigModal()" class="text-white hover:text-gray-200 transition-colors">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="p-6 space-y-6">
              <!-- éšè—å­—æ®µï¼šå­˜å‚¨ç¼–è¾‘çš„é…ç½®ID -->
              <input type="hidden" id="dropConfigEditId" value="">
              <!-- é€‰æ‹©æ¸¸æˆåœºæ¬¡ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">1ï¸âƒ£ é€‰æ‹©æ¸¸æˆåœºæ¬¡</label>
                <div class="flex gap-3">
                  <label class="flex-1 cursor-pointer">
                    <input type="radio" name="dropSlotMode" value="normal" checked onchange="updateDropRulesList()" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-blue-500 peer-checked:bg-blue-50 rounded-lg text-center transition-all">
                      <div class="text-2xl mb-1">ğŸ°</div>
                      <div class="font-semibold">åˆçº§åœº</div>
                    </div>
                  </label>
                  <label class="flex-1 cursor-pointer">
                    <input type="radio" name="dropSlotMode" value="advanced" onchange="updateDropRulesList()" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-red-500 peer-checked:bg-red-50 rounded-lg text-center transition-all">
                      <div class="text-2xl mb-1">ğŸ”¥</div>
                      <div class="font-semibold">é«˜çº§åœº</div>
                    </div>
                  </label>
                  <label class="flex-1 cursor-pointer">
                    <input type="radio" name="dropSlotMode" value="supreme" onchange="updateDropRulesList()" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-purple-500 peer-checked:bg-purple-50 rounded-lg text-center transition-all">
                      <div class="text-2xl mb-1">ğŸ’</div>
                      <div class="font-semibold">è‡³å°Šåœº</div>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- é€‰æ‹©è§¦å‘è§„åˆ™ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">2ï¸âƒ£ é€‰æ‹©ä¸­å¥–è§„åˆ™</label>
                <select id="dropTriggerRule" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                  <option value="">åŠ è½½ä¸­...</option>
                </select>
                <p class="text-xs text-slate-500 mt-2">ğŸ’¡ è§„åˆ™åˆ—è¡¨æ¥è‡ªè¯¥åœºæ¬¡å½“å‰ä½¿ç”¨çš„å¥–åŠ±é…ç½®æ–¹æ¡ˆ</p>
              </div>
              
              <!-- é€‰æ‹©æ‰è½ç‰©å“ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">3ï¸âƒ£ é€‰æ‹©æ‰è½ç‰©å“ç±»å‹</label>
                <div class="grid grid-cols-2 gap-3">
                  <label class="cursor-pointer">
                    <input type="radio" name="dropItemType" value="ticket" checked class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-purple-500 peer-checked:bg-purple-50 rounded-lg text-center transition-all">
                      <div class="text-3xl mb-1">ğŸŸï¸</div>
                      <div class="font-semibold">å…¥åœºåˆ¸</div>
                      <div class="text-xs text-slate-500 mt-1">é«˜çº§åœºé—¨ç¥¨</div>
                    </div>
                  </label>
                  <label class="cursor-pointer">
                    <input type="radio" name="dropItemType" value="fragment" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-purple-500 peer-checked:bg-purple-50 rounded-lg text-center transition-all">
                      <div class="text-3xl mb-1">ğŸ€</div>
                      <div class="font-semibold">ç¢ç‰‡</div>
                      <div class="text-xs text-slate-500 mt-1">åˆæˆå…¥åœºåˆ¸</div>
                    </div>
                  </label>
                  <label class="cursor-pointer">
                    <input type="radio" name="dropItemType" value="supreme_token" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-purple-500 peer-checked:bg-purple-50 rounded-lg text-center transition-all">
                      <div class="text-3xl mb-1">ğŸ’</div>
                      <div class="font-semibold">è‡³å°Šä»¤ç‰Œ</div>
                      <div class="text-xs text-slate-500 mt-1">è‡³å°Šåœºé—¨ç¥¨</div>
                    </div>
                  </label>
                  <label class="cursor-pointer">
                    <input type="radio" name="dropItemType" value="supreme_fragment" class="peer hidden">
                    <div class="p-4 border-2 border-slate-300 peer-checked:border-purple-500 peer-checked:bg-purple-50 rounded-lg text-center transition-all">
                      <div class="text-3xl mb-1">ğŸ’ </div>
                      <div class="font-semibold">è‡³å°Šç¢ç‰‡</div>
                      <div class="text-xs text-slate-500 mt-1">åˆæˆè‡³å°Šä»¤ç‰Œ</div>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- è®¾ç½®æ‰è½æ¦‚ç‡ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">4ï¸âƒ£ è®¾ç½®æ‰è½æ¦‚ç‡</label>
                <input type="range" id="dropProbabilitySlider" min="0" max="100" step="1" value="50" 
                       class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                       oninput="updateDropProbabilityDisplay(this.value)">
                <div class="flex items-center justify-between mt-2">
                  <input type="number" id="dropProbability" min="0" max="100" step="1" value="50" 
                         class="w-24 px-3 py-2 border border-slate-300 rounded-lg text-center font-bold"
                         oninput="document.getElementById('dropProbabilitySlider').value = this.value; updateDropProbabilityDisplay(this.value)">
                  <div class="flex-1 ml-4">
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                      <div id="dropProbBar" class="h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all" style="width: 50%"></div>
                    </div>
                  </div>
                </div>
                <p class="text-xs text-slate-500 mt-2">ğŸ’¡ è§¦å‘è¯¥è§„åˆ™æ—¶æœ‰ <span id="dropProbPercent" class="font-bold text-purple-600">50</span>% æ¦‚ç‡æ‰è½</p>
              </div>
              
              <!-- è®¾ç½®æ‰è½æ•°é‡ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">5ï¸âƒ£ è®¾ç½®æ‰è½æ•°é‡</label>
                <input type="number" id="dropCount" min="1" max="10" value="1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-2">ğŸ’¡ æ¯æ¬¡æ‰è½æ—¶è·å¾—çš„æ•°é‡</p>
              </div>
              
              <!-- è¯´æ˜ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="dropDescription" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šäºŒè¿50%æ‰è½ç¢ç‰‡">
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="flex gap-3 pt-4 border-t">
                <button onclick="closeDropConfigModal()" class="flex-1 px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-semibold transition-all">
                  å–æ¶ˆ
                </button>
                <button onclick="saveDropConfig()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg font-semibold shadow-lg transition-all">
                  ç¡®è®¤æ·»åŠ 
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ğŸ’ Supreme Slot Config Section -->
        <div id="supremeConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ’ è‡³å°Šåœºé…ç½®</h2>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">âš™ï¸ åŸºç¡€é…ç½®</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å¯ç”¨çŠ¶æ€</label>
                <select id="supremeEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="1">âœ… å¯ç”¨</option>
                  <option value="0">âŒ ç¦ç”¨</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">åˆæˆæ‰€éœ€ç¢ç‰‡</label>
                <input type="number" id="supremeFragmentsToToken" min="1" max="100" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä»¤ç‰ŒæŒæœ‰ä¸Šé™</label>
                <input type="number" id="supremeMaxTokens" min="1" max="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰</label>
                <input type="number" id="supremeTokenValidHours" min="1" max="720" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä¼šè¯æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰</label>
                <input type="number" id="supremeSessionValidHours" min="1" max="24" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æŠ•æ³¨èŒƒå›´ï¼ˆç¾å…ƒï¼‰</label>
                <div class="flex gap-2">
                  <input type="number" id="supremeMinBet" placeholder="æœ€å°" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                  <input type="number" id="supremeMaxBet" placeholder="æœ€å¤§" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥è¿›å…¥é™åˆ¶</label>
                <input type="number" id="supremeDailyEntry" min="1" max="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥è·å¾—ä»¤ç‰Œé™åˆ¶</label>
                <input type="number" id="supremeDailyTokenGrant" min="1" max="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ¯æ—¥æŠ•æ³¨é™é¢ï¼ˆç¾å…ƒï¼‰</label>
                <input type="number" id="supremeDailyBetLimit" min="1000" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button onclick="saveSupremeConfig()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                ğŸ’¾ ä¿å­˜é…ç½®
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">âš–ï¸ ç¬¦å·æƒé‡æ–¹æ¡ˆ</h3>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©æƒé‡æ–¹æ¡ˆ</label>
              <select id="supremeWeightConfigId" class="w-full px-4 py-2 border border-slate-300 rounded-lg" onchange="previewSupremeWeightConfig()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ å¯åœ¨"æƒé‡é…ç½®ç®¡ç†"ä¸­åˆ›å»ºå’Œç¼–è¾‘æ–¹æ¡ˆ</p>
            </div>
            
            <!-- é¢„è§ˆæƒé‡ -->
            <div id="supremeWeightPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ“Š å½“å‰é…ç½®é¢„è§ˆ</h4>
              <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ç¾(m)</div>
                  <div id="sup_preview_weight_m" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å¤ª(t)</div>
                  <div id="sup_preview_weight_t" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä½ (n)</div>
                  <div id="sup_preview_weight_n" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">é¸¡(j)</div>
                  <div id="sup_preview_weight_j" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ç¯®çƒ(lq)</div>
                  <div id="sup_preview_weight_lq" class="font-bold text-orange-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">å†°æ¿€å‡Œ(bj)</div>
                  <div id="sup_preview_weight_bj" class="font-bold text-orange-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">çº¸é£æœº(zft)</div>
                  <div id="sup_preview_weight_zft" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">ä¸æ‰“å·¥(bdk)</div>
                  <div id="sup_preview_weight_bdk" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-red-100 rounded border border-red-300">
                  <div class="text-red-700">å¾‹å¸ˆå‡½(lsh)</div>
                  <div id="sup_preview_weight_lsh" class="font-bold text-red-700">--</div>
                </div>
                <div class="text-center p-2 bg-green-100 rounded border border-green-300">
                  <div class="text-green-700">man</div>
                  <div id="sup_preview_weight_man" class="font-bold text-green-700">--</div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">ğŸ å¥–åŠ±è§„åˆ™æ–¹æ¡ˆ</h3>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©å¥–åŠ±æ–¹æ¡ˆ</label>
              <select id="supremeRewardSchemeId" class="w-full px-4 py-2 border border-slate-300 rounded-lg" onchange="previewSupremeRewardScheme()">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">ğŸ’¡ å¯åœ¨"å¥–åŠ±é…ç½®ç®¡ç†"ä¸­åˆ›å»ºå’Œç¼–è¾‘æ–¹æ¡ˆ</p>
            </div>
            
            <!-- é¢„è§ˆè§„åˆ™ -->
            <div id="supremeRewardPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">ğŸ¯ åŒ…å«è§„åˆ™</h4>
              <div id="supremeRewardPreviewList" class="space-y-2 text-xs">
                <!-- åŠ¨æ€å¡«å…… -->
              </div>
            </div>
          </div>
          
          <!-- ğŸ“Š æ¦‚ç‡åˆ†æå¡ç‰‡ (è‡³å°Šåœº) -->
          <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ“Š</span>
                </div>
                <div>
                  <h4 class="text-lg font-bold text-purple-900">æ¦‚ç‡åˆ†æä¸RTPè®¡ç®—</h4>
                  <p class="text-xs text-purple-700">æ ¹æ®é€‰æ‹©çš„é…ç½®å®æ—¶è®¡ç®—è§„åˆ™æ¦‚ç‡å’Œç©å®¶å›æŠ¥ç‡</p>
                </div>
              </div>
            </div>
            
            <!-- è®¡ç®—æ–¹å¼é€‰æ‹© -->
            <div class="mb-4">
              <div class="flex items-center justify-between mb-3">
                <label class="text-sm font-medium text-slate-700">è®¡ç®—æ–¹å¼:</label>
                <button onclick="calculateSupremeProbability()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                  ğŸ² å¼€å§‹è®¡ç®—
                </button>
              </div>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="supremeCalcMethod" value="fast" checked>
                  <span class="text-sm">âš¡ å¿«é€Ÿä¼°ç®— (æ¯«ç§’çº§)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="supremeCalcMethod" value="monte-carlo">
                  <span class="text-sm">ğŸ² ç²¾ç¡®æ¨¡æ‹Ÿ (è’™ç‰¹å¡æ´› 100ä¸‡æ¬¡, 2-3ç§’)</span>
                </label>
              </div>
            </div>
            
            <!-- æ¦‚ç‡æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="supremeProbabilityDisplay" class="hidden">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
          </div>
        </div>

        <!-- ğŸ’ Supreme Slot Records Section -->
        <div id="supremeRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">ğŸ’ è‡³å°Šåœºæ¸¸æˆè®°å½•</h2>
            <button onclick="refreshSupremeRecords()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 hover:from-purple-700 hover:via-pink-700 hover:to-amber-600 text-white rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-purple-800">
              ğŸ’¡ <strong>è‡³å°Šåœºç‰¹è‰²ï¼š</strong>æŠ•æ³¨é‡‘é¢$2000-$5000å¯é€‰ï¼Œè¶…é«˜å€ç‡ï¼Œå°Šäº«ä½“éªŒï¼Œè‡³å°Šä»¤ç‰Œé™æ—¶å…¥åœº
            </p>
          </div>
          
          <!-- æœç´¢å’Œç­›é€‰æ  -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- æœç´¢ç”¨æˆ·å -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœç´¢ç”¨æˆ·å</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="supremeRecordSearchInput" 
                    placeholder="è¾“å…¥LinuxDoç”¨æˆ·åæˆ–å…¬ç›Šç«™ç”¨æˆ·å..." 
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- ä¸­å¥–ç±»å‹ç­›é€‰ -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ä¸­å¥–ç±»å‹</label>
                <select
                  id="supremeWinTypeFilter"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
                  <option value="all">å…¨éƒ¨ç±»å‹</option>
                  <!-- ğŸ”¥ åŠ¨æ€åŠ è½½è§„åˆ™é€‰é¡¹ -->
                </select>
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterSupremeSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  ğŸ” æŸ¥è¯¢
                </button>
                <button 
                  onclick="refreshSupremeRecordsKeepFilter()" 
                  class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-1"
                  title="åˆ·æ–°æ•°æ®ï¼ˆä¿ç•™ç­›é€‰æ¡ä»¶ï¼‰"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  åˆ·æ–°
                </button>
                <button 
                  onclick="clearSupremeRecordFilters()" 
                  class="flex-1 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors font-medium"
                >
                  ğŸ”„ é‡ç½®
                </button>
              </div>
            </div>
            
            <!-- ç­›é€‰ç»“æœæç¤º -->
            <div id="supremeFilterResultHint" class="text-sm text-slate-600 hidden"></div>
          </div>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-slate-600">æ€»è®°å½•æ•°</p>
                <p id="supremeSlotTotal" class="text-2xl font-bold text-slate-900">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">æ€»æŠ•æ³¨</p>
                <p id="supremeSlotTotalBet" class="text-2xl font-bold text-blue-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">æ€»è·å¥–</p>
                <p id="supremeSlotTotalWin" class="text-2xl font-bold text-green-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">å®é™…RTP</p>
                <p id="supremeSlotRTP" class="text-2xl font-bold text-purple-600">0%</p>
                <p class="text-xs text-slate-500 mt-1">è¿”è¿˜ç©å®¶ç‡</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-purple-50 to-gold-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">LINUX DO ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">ç»“æœç¬¦å·</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">ä¸­å¥–ç±»å‹</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å€ç‡</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">æŠ•æ³¨</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">èµ¢å¾—</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">å¥–æƒ©</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">ç±»å‹</th>
                  </tr>
                </thead>
                <tbody id="supremeRecordsTableBody">
                  <tr>
                    <td colspan="10" class="text-center py-8 text-slate-500">åŠ è½½ä¸­...</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- ç­›é€‰ç»“æœæç¤º -->
            <div id="supremeFilterResultHint" class="hidden text-center py-3 text-sm text-purple-700 font-semibold bg-purple-50 rounded-lg mb-4">
              ç­›é€‰ç»“æœæç¤º
            </div>

            <!-- åˆ†é¡µæ§åˆ¶ -->
            <div class="flex items-center justify-between py-4">
              <div class="text-sm text-slate-600">
                ç¬¬ <span id="supremeCurrentPage" class="font-semibold text-purple-600">1</span> /
                <span id="supremeTotalPages" class="font-semibold text-purple-600">1</span> é¡µ
              </div>
              <div class="flex gap-2">
                <button
                  id="supremePrevBtn"
                  onclick="loadSupremeRecords(supremeCurrentPage - 1)"
                  class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  disabled
                >
                  ä¸Šä¸€é¡µ
                </button>
                <button
                  id="supremeNextBtn"
                  onclick="loadSupremeRecords(supremeCurrentPage + 1)"
                  class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                >
                  ä¸‹ä¸€é¡µ
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Grant Free Spins Modal -->
  <div id="grantFreeSpinsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">ğŸ å‘æ”¾å…è´¹æ¬¡æ•°</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·</label>
          <input type="text" id="modalUsername" readonly class="w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700">
          <input type="hidden" id="modalLinuxDoId">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">å…è´¹æ¬¡æ•° *</label>
          <input type="number" id="modalSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå› </label>
          <input type="text" id="modalReason" placeholder="ä¾‹å¦‚: bugè¡¥å¿" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmGrantFreeSpin()" class="flex-1 px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
          ç¡®è®¤å‘æ”¾
        </button>
        <button onclick="closeGrantFreeSpinsModal()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸŸï¸ Grant Tickets Modal -->
  <div id="grantTicketsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">ğŸŸï¸ å‘æ”¾å…¥åœºåˆ¸</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·</label>
          <input type="text" id="ticketModalUsername" readonly class="w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700">
          <input type="hidden" id="ticketModalLinuxDoId">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">å…¥åœºåˆ¸æ•°é‡ *</label>
          <input type="number" id="ticketModalCount" min="1" max="10" value="1" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <p class="text-xs text-slate-500 mt-1">æ¯æ¬¡æœ€å¤šå‘æ”¾10å¼ </p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå› </label>
          <input type="text" id="ticketModalReason" placeholder="ä¾‹å¦‚: æ´»åŠ¨å¥–åŠ±" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-xs text-blue-800">
            ğŸ’¡ <strong>æç¤ºï¼š</strong>å…¥åœºåˆ¸æœ‰æ•ˆæœŸ24å°æ—¶ï¼Œç”¨æˆ·æœ€å¤šæŒæœ‰2å¼ ï¼ˆå¯åœ¨é«˜çº§åœºé…ç½®ä¸­è°ƒæ•´ï¼‰
          </p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmGrantTickets()" class="flex-1 px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
          ç¡®è®¤å‘æ”¾
        </button>
        <button onclick="closeGrantTicketsModal()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ’ Grant Supreme Tokens Modal -->
  <div id="grantSupremeTokensModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-2xl max-w-md w-full p-6 border-2 border-purple-300">
      <h3 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4 flex items-center gap-2">
        <span>ğŸ’</span>
        <span>å‘æ”¾è‡³å°Šä»¤ç‰Œ</span>
      </h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·</label>
          <input type="text" id="supremeTokenModalUsername" readonly class="w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700">
          <input type="hidden" id="supremeTokenModalLinuxDoId">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">è‡³å°Šä»¤ç‰Œæ•°é‡</label>
          <input type="number" id="supremeTokenModalTokens" min="0" max="10" value="0" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
          <p class="text-xs text-slate-500 mt-1">æœ€å¤š10ä¸ªï¼Œç”¨æˆ·æœ€å¤šæŒæœ‰3ä¸ªï¼ˆè¶…å‡ºéƒ¨åˆ†ä¸å‘æ”¾ï¼‰</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">è‡³å°Šç¢ç‰‡æ•°é‡</label>
          <input type="number" id="supremeTokenModalFragments" min="0" max="100" value="0" class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
          <p class="text-xs text-slate-500 mt-1">æœ€å¤š100ä¸ª</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">å‘æ”¾åŸå› </label>
          <input type="text" id="supremeTokenModalReason" placeholder="ä¾‹å¦‚: æ´»åŠ¨å¥–åŠ±" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-3">
          <p class="text-xs text-purple-800">
            ğŸ’¡ <strong>æç¤ºï¼š</strong>è‡³å°Šä»¤ç‰Œæœ‰æ•ˆæœŸ168å°æ—¶ï¼ˆ7å¤©ï¼‰ï¼Œä»¤ç‰Œå’Œç¢ç‰‡å¯åŒæ—¶å‘æ”¾
          </p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmGrantSupremeTokens()" class="flex-1 px-6 py-2 bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
          ç¡®è®¤å‘æ”¾
        </button>
        <button onclick="closeGrantSupremeTokensModal()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      let bgColor, icon;
      if (type === 'success') {
        bgColor = 'bg-gradient-to-r from-green-500 to-emerald-600';
        icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
      } else if (type === 'warning') {
        bgColor = 'bg-gradient-to-r from-amber-500 to-orange-600';
        icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
      } else {
        bgColor = 'bg-gradient-to-r from-red-500 to-pink-600';
        icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
      }
      
      toast.className = `toast px-6 py-4 rounded-xl ${bgColor} text-white min-w-[300px]`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${icon}
            </svg>
          </div>
          <span class="font-medium">${message}</span>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ä¿ç•™æ—§çš„ showMessage å‡½æ•°ç”¨äºå…¼å®¹
    function showMessage(text, type) {
      showToast(text, type);
    }

    async function adminLogin() {
      const password = document.getElementById('password').value;
      if (!password) {
        showToast('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          showToast('ç™»å½•æˆåŠŸ', 'success');
          await loadAdminData();
        } else {
          showToast(data.message || 'å¯†ç é”™è¯¯', 'error');
        }
      } catch (e) {
        showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    async function loadAdminData() {
      await loadConfig();
      await loadClaimRecords();
      await loadDonateRecords();
      await loadKeysList();
      await loadUsersCount();
      initializeRuleFilterOptions();  // ğŸ”¥ åˆå§‹åŒ–ç­›é€‰ä¸‹æ‹‰æ¡†é€‰é¡¹
    }

    // ğŸ”¥ åŠ¨æ€åŠ è½½è§„åˆ™ç­›é€‰ä¸‹æ‹‰æ¡†é€‰é¡¹
    function initializeRuleFilterOptions() {
      // ğŸ”¥ åˆå§‹åŒ–æ‰€æœ‰åœºæ¬¡çš„ç­›é€‰ä¸‹æ‹‰æ¡†
      initializeSingleFilterSelect('adminWinTypeFilter');
      initializeSingleFilterSelect('advancedWinTypeFilter');
      initializeSingleFilterSelect('supremeWinTypeFilter');
    }

    // ğŸ”¥ é€šç”¨å‡½æ•°ï¼šåˆå§‹åŒ–å•ä¸ªç­›é€‰ä¸‹æ‹‰æ¡†
    function initializeSingleFilterSelect(selectId) {
      const filterSelect = document.getElementById(selectId);
      if (!filterSelect) return;

      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨ç±»å‹"ï¼‰
      filterSelect.innerHTML = '<option value="all">å…¨éƒ¨ç±»å‹</option>';

      // æŒ‰åˆ†ç±»ç»„ç»‡è§„åˆ™
      const categories = {
        'jackpot': [],
        'special': [],
        'high': [],
        'medium': [],
        'normal': []
      };

      RULE_TEMPLATES.forEach(template => {
        const category = template.category || 'normal';
        if (categories[category]) {
          categories[category].push(template);
        }
      });

      // æ·»åŠ åˆ†ç±»é€‰é¡¹
      const categoryLabels = {
        'jackpot': 'ğŸ† è¶…çº§å¤§å¥–',
        'special': 'ğŸ’ª ç‰¹æ®Šç¬¦å·',
        'high': 'ğŸ° é«˜çº§å¥–åŠ±',
        'medium': 'âœ¨ ä¸­çº§å¥–åŠ±',
        'normal': 'ğŸ æ™®é€šå¥–åŠ±'
      };

      Object.entries(categories).forEach(([category, templates]) => {
        if (templates.length > 0) {
          // æ·»åŠ åˆ†ç±»æ ‡ç­¾
          const optgroup = document.createElement('optgroup');
          optgroup.label = categoryLabels[category] || category;

          templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.name;
            option.textContent = template.name;
            optgroup.appendChild(option);
          });

          filterSelect.appendChild(optgroup);
        }
      });

      // æ·»åŠ ç‰¹æ®ŠçŠ¶æ€
      const specialGroup = document.createElement('optgroup');
      specialGroup.label = 'âš¡ ç‰¹æ®ŠçŠ¶æ€';

      const punishmentOption = document.createElement('option');
      punishmentOption.value = 'punishment';
      punishmentOption.textContent = 'âš¡ å¾‹å¸ˆå‡½æƒ©ç½š';
      specialGroup.appendChild(punishmentOption);

      const noneOption = document.createElement('option');
      noneOption.value = 'none';
      noneOption.textContent = 'âŒ æœªä¸­å¥–';
      specialGroup.appendChild(noneOption);

      filterSelect.appendChild(specialGroup);
    }

    async function loadUsersCount() {
      try {
        const res = await fetch('/api/admin/users?page=1&pageSize=1');
        const data = await res.json();
        if (data.success) {
          document.getElementById('userCount').textContent = data.pagination.total;
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·æ•°å¤±è´¥', e);
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/admin/config');
        const data = await res.json();

        if (data.success) {
          const claimQuota = data.data.claim_quota;
          const usdValue = (claimQuota / 500000).toFixed(2);
          const maxDailyClaims = data.data.max_daily_claims || 1;
          const session = data.data.session || '';
          const newApiUser = data.data.new_api_user || '1';
          const keysApiUrl = data.data.keys_api_url || '';
          const keysAuthorization = data.data.keys_authorization || '';
          const modelscopeGroupId = data.data.modelscope_group_id || 26;
          const iflowGroupId = data.data.iflow_group_id || 26;
          const keysAuthConfigured = data.data.keys_authorization_configured;
          const updatedAt = data.data.updated_at;
          const maxDailyDonateModelscope = data.data.max_daily_donate_modelscope || 1;
          const maxDailyDonateIflow = data.data.max_daily_donate_iflow || 1;
          
          // æ›´æ–°é…ç½®é¡µé¢
          document.getElementById('claimQuotaUSD').value = usdValue;
          document.getElementById('currentQuota').textContent = '$' + usdValue;
          document.getElementById('quotaValue').textContent = claimQuota.toLocaleString();
          document.getElementById('maxDailyClaims').value = maxDailyClaims;
          
          // æ˜¾ç¤ºå½“å‰ session
          document.getElementById('currentSession').textContent = session || 'æœªé…ç½®';
          document.getElementById('currentSession').className = session 
            ? 'text-sm font-mono text-slate-700 break-all' 
            : 'text-sm font-mono text-slate-400 break-all';
          
          // æ˜¾ç¤ºå½“å‰ new_api_user
          document.getElementById('currentNewApiUser').textContent = newApiUser;
          
          document.getElementById('keysApiUrl').value = keysApiUrl;
          document.getElementById('modelscopeGroupId').value = modelscopeGroupId;
          document.getElementById('iflowGroupId').value = iflowGroupId;
          document.getElementById('maxDailyDonateModelscope').value = maxDailyDonateModelscope;
          document.getElementById('maxDailyDonateIflow').value = maxDailyDonateIflow;
          
          // æ›´æ–°ä»ªè¡¨æ¿é…ç½®å¡ç‰‡
          document.getElementById('dashboardQuota').textContent = '$' + usdValue;
          document.getElementById('dashboardQuotaUSD').textContent = claimQuota.toLocaleString();
          document.getElementById('dashboardMaxClaims').textContent = maxDailyClaims;
          document.getElementById('dashboardSessionStatus').textContent = session ? 'å·²é…ç½® âœ“' : 'æœªé…ç½®';
          document.getElementById('dashboardSessionStatus').className = session 
            ? 'text-lg font-bold text-green-600' 
            : 'text-lg font-bold text-orange-600';
          
          document.getElementById('dashboardNewApiUser').textContent = newApiUser;
          document.getElementById('dashboardKeysApi').textContent = keysApiUrl || 'æœªé…ç½®';
          document.getElementById('dashboardKeysApi').title = keysApiUrl || 'æœªé…ç½®';
          document.getElementById('dashboardGroupId').textContent = modelscopeGroupId;
          document.getElementById('dashboardIflowGroupId').textContent = iflowGroupId;
          document.getElementById('dashboardMaxDonateModelscope').textContent = maxDailyDonateModelscope;
          document.getElementById('dashboardMaxDonateIflow').textContent = maxDailyDonateIflow;
          
          // æ˜¾ç¤º Keys Authorizationï¼ˆå‰20ä¸ªå­—ç¬¦ï¼‰
          if (keysAuthorization) {
            const displayAuth = keysAuthorization.length > 20 
              ? keysAuthorization.substring(0, 20) + '...' 
              : keysAuthorization;
            document.getElementById('dashboardKeysAuth').textContent = displayAuth;
            document.getElementById('dashboardKeysAuth').title = keysAuthorization;
            document.getElementById('dashboardKeysAuthStatus').textContent = 'å·²é…ç½® âœ“';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-green-600 mt-1 font-semibold';
          } else {
            document.getElementById('dashboardKeysAuth').textContent = 'æœªé…ç½®';
            document.getElementById('dashboardKeysAuth').title = '';
            document.getElementById('dashboardKeysAuthStatus').textContent = 'æœªé…ç½®';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-orange-600 mt-1 font-semibold';
          }

          // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
          if (updatedAt) {
            const date = new Date(updatedAt);
            document.getElementById('dashboardUpdatedAt').textContent = date.toLocaleString('zh-CN', { hour12: false });
          }
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
      }
    }

    // å®æ—¶è®¡ç®— quota æ˜¾ç¤º
    document.addEventListener('DOMContentLoaded', () => {
      const claimQuotaUSDInput = document.getElementById('claimQuotaUSD');
      if (claimQuotaUSDInput) {
        claimQuotaUSDInput.addEventListener('input', (e) => {
          const usd = parseFloat(e.target.value) || 0;
          const quota = Math.round(usd * 500000);
          const quotaEl = document.getElementById('quotaValue');
          if (quotaEl) {
            quotaEl.textContent = quota.toLocaleString();
          }
        });
      }
    });

    async function updateQuota() {
      const usd = parseFloat(document.getElementById('claimQuotaUSD').value);
      if (!usd || usd <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¾å…ƒé‡‘é¢', 'error');
        return;
      }
      const quota = Math.round(usd * 500000);
      try {
        const res = await fetch('/api/admin/config/quota', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ claim_quota: quota }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateMaxDailyClaims() {
      const maxClaims = parseInt(document.getElementById('maxDailyClaims').value);
      if (!maxClaims || maxClaims <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢†å–æ¬¡æ•°', 'error');
        return;
      }
      if (maxClaims > 10) {
        showMessage('æ¯æ—¥é¢†å–æ¬¡æ•°ä¸èƒ½è¶…è¿‡10æ¬¡', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-claims', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_claims: maxClaims }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateSession() {
      const session = document.getElementById('sessionValue').value.trim();
      try {
        const res = await fetch('/api/admin/config/session', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('sessionValue').value = '';
          await loadConfig();  // é‡æ–°åŠ è½½é…ç½®ä»¥åˆ·æ–°æ˜¾ç¤º
        }
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateNewApiUser() {
      const new_api_user = document.getElementById('newApiUserValue').value.trim();
      if (!new_api_user) {
        showMessage('è¯·è¾“å…¥ New-API-User å€¼', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/new-api-user', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_api_user }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('newApiUserValue').value = '';
          await loadConfig();  // é‡æ–°åŠ è½½é…ç½®ä»¥åˆ·æ–°æ˜¾ç¤º
        }
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateKeysApiUrl() {
      const keys_api_url = document.getElementById('keysApiUrl').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-api-url', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_api_url }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateKeysAuthorization() {
      const keys_authorization = document.getElementById('keysAuthorization').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-authorization', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_authorization }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) document.getElementById('keysAuthorization').value = '';
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateModelscopeGroupId() {
      const modelscope_group_id = parseInt(document.getElementById('modelscopeGroupId').value);
      try {
        const res = await fetch('/api/admin/config/modelscope-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelscope_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateIflowGroupId() {
      const iflow_group_id = parseInt(document.getElementById('iflowGroupId').value);
      try {
        const res = await fetch('/api/admin/config/iflow-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ iflow_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateMaxDailyDonateModelscope() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateModelscope').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•å–‚é™åˆ¶æ¬¡æ•°', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('ModelScope æ¯æ—¥æŠ•å–‚é™åˆ¶ä¸èƒ½è¶…è¿‡10æ¬¡', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-modelscope', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_modelscope: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateMaxDailyDonateIflow() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateIflow').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•å–‚é™åˆ¶æ¬¡æ•°', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('iFlow æ¯æ—¥æŠ•å–‚é™åˆ¶ä¸èƒ½è¶…è¿‡10æ¬¡', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-iflow', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_iflow: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    // åˆ·æ–°æŒ‰é’®åŒ…è£…å‡½æ•°
    async function refreshKeys() {
      const icon = document.getElementById('keysRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadKeysList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('Keys åˆ—è¡¨å·²åˆ·æ–°', 'success');
      }, 600);
    }

    async function refreshClaims() {
      const icon = document.getElementById('claimsRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadClaimRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('é¢†å–è®°å½•å·²åˆ·æ–°', 'success');
      }, 600);
    }

    async function refreshDonates() {
      const icon = document.getElementById('donatesRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadDonateRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('æŠ•å–‚è®°å½•å·²åˆ·æ–°', 'success');
      }, 600);
    }

    async function refreshUsers() {
      const icon = document.getElementById('usersRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadUsersList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('ç”¨æˆ·åˆ—è¡¨å·²åˆ·æ–°', 'success');
      }, 600);
    }

    async function loadKeysList() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          document.getElementById('totalKeysCount').textContent = data.data.length;
          const tbody = document.getElementById('keysListBody');

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">æš‚æ— Keys</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((item, index) => {
            const keyType = item.key_type || 'modelscope';
            const keyTypeTag = keyType === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>âœ¨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>ğŸ</span><span>ModelScope</span></span>';
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50" data-key="${item.key}" data-key-type="${keyType}">
                <td class="keysCheckboxCell hidden px-4 py-3 text-center align-middle">
                  <input type="checkbox" class="key-checkbox w-4 h-4 rounded border-slate-300" value="${item.key}" data-key-type="${keyType}" onchange="updateSelectedCount()">
                </td>
                <td class="px-4 py-3 font-mono text-xs align-middle break-all">${item.key}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 align-middle">${item.username || '-'}</td>
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(item.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="key-status-${index}">-</span>
                </td>
                <td class="px-4 py-3 text-center align-middle">
                  <button onclick="copyKey('${item.key}')" class="p-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors" title="å¤åˆ¶ Key">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½Keyså¤±è´¥', e);
      }
    }

    // å¤åˆ¶å•ä¸ª Key
    function copyKey(key) {
      navigator.clipboard.writeText(key).then(() => {
        showToast('Key å·²å¤åˆ¶', 'success');
      }).catch(() => {
        showToast('å¤åˆ¶å¤±è´¥', 'error');
      });
    }

    // Keys æ‰¹é‡æ“ä½œåŠŸèƒ½
    let keysBatchMode = false;

    function toggleKeysBatchMode() {
      keysBatchMode = !keysBatchMode;
      const btn = document.getElementById('keysBatchBtn');
      const batchActions = document.getElementById('keysBatchActions');
      const checkboxCells = document.querySelectorAll('.keysCheckboxCell');
      const checkboxHeader = document.getElementById('keysCheckboxHeader');
      
      if (keysBatchMode) {
        btn.textContent = 'âœ“ é€€å‡ºæ‰¹é‡';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = 'æ‰¹é‡æ“ä½œ';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        // æ¸…é™¤æ‰€æœ‰é€‰ä¸­
        document.querySelectorAll('.key-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
      }
    }

    function toggleSelectAllKeys() {
      const selectAll = document.getElementById('selectAllKeys');
      const selectAllHeader = document.getElementById('selectAllKeysHeader');
      const checkboxes = document.querySelectorAll('.key-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const selected = document.querySelectorAll('.key-checkbox:checked');
      document.getElementById('selectedKeysCount').textContent = selected.length;
    }

    function getSelectedKeys() {
      return Array.from(document.querySelectorAll('.key-checkbox:checked')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
    }

    async function deleteSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ Keys', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedKeys.length} ä¸ª Keys å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      
      try {
        const res = await fetch('/api/admin/keys/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys: selectedKeys }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(data.message, 'success');
          await loadKeysList();
        } else {
          showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (e) {
        showMessage('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    async function testSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦æµ‹è¯•çš„ Keys', 'error');
        return;
      }
      
      showMessage(`æ­£åœ¨æµ‹è¯• ${selectedKeys.length} ä¸ª Keys...`, 'success');
      await testKeys(selectedKeys);
    }

    async function testAllKeys() {
      const allKeys = Array.from(document.querySelectorAll('.key-checkbox')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
      if (allKeys.length === 0) {
        showMessage('æš‚æ—  Keys å¯æµ‹è¯•', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦æµ‹è¯•å…¨éƒ¨ ${allKeys.length} ä¸ª Keys å—ï¼Ÿ`)) return;
      
      showMessage(`æ­£åœ¨æµ‹è¯•å…¨éƒ¨ ${allKeys.length} ä¸ª Keys...`, 'success');
      await testKeys(allKeys);
    }

    async function testKeys(keys) {
      let validCount = 0;
      let invalidCount = 0;
      
      // ä¸€ä¸ªæ¥ä¸€ä¸ªæµ‹è¯•
      for (let index = 0; index < keys.length; index++) {
        const keyItem = keys[index];
        const statusSpan = document.querySelector(`.key-status-${index}`);
        
        if (statusSpan) {
          // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
          statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span>æµ‹è¯•ä¸­</span></span>';
        }
        
        try {
          // å•ä¸ªæµ‹è¯•
          const res = await fetch('/api/admin/keys/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keys: [keyItem] }),
          });
          const data = await res.json();
          
          if (statusSpan && data.success && data.data.length > 0) {
            const result = data.data[0];
            if (result.valid) {
              validCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg><span>æˆåŠŸ</span></span>';
            } else {
              invalidCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>å¤±è´¥</span></span>';
            }
          }
        } catch (e) {
          if (statusSpan) {
            invalidCount++;
            statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>å¤±è´¥</span></span>';
          }
        }
        
        // æ·»åŠ å°å»¶è¿Ÿï¼Œè®©åŠ¨ç”»æ›´æ˜æ˜¾
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      showMessage(`æµ‹è¯•å®Œæˆï¼šæœ‰æ•ˆ ${validCount} ä¸ªï¼Œå¤±æ•ˆ ${invalidCount} ä¸ª`, 'success');
    }

    async function exportKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // æŒ‰æ¸ é“åˆ†ç±»
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let exportContent = '';
          
          if (modelscopeKeys.length > 0) {
            exportContent += `=== ModelScope Keys (${modelscopeKeys.length}ä¸ª) ===\n`;
            exportContent += modelscopeKeys.map(item => item.key).join('\n');
            exportContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            exportContent += `=== iFlow Keys (${iflowKeys.length}ä¸ª) ===\n`;
            exportContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          const blob = new Blob([exportContent], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `donated-keys-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          showMessage(`æˆåŠŸå¯¼å‡º ${data.data.length} ä¸ª Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    async function copyAllKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // æŒ‰æ¸ é“åˆ†ç±»
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let copyContent = '';
          
          if (modelscopeKeys.length > 0) {
            copyContent += `=== ModelScope Keys (${modelscopeKeys.length}ä¸ª) ===\n`;
            copyContent += modelscopeKeys.map(item => item.key).join('\n');
            copyContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            copyContent += `=== iFlow Keys (${iflowKeys.length}ä¸ª) ===\n`;
            copyContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          await navigator.clipboard.writeText(copyContent);
          showMessage(`æˆåŠŸå¤åˆ¶ ${data.data.length} ä¸ª Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('å¤åˆ¶å¤±è´¥', 'error');
      }
    }

    let claimCurrentPage = 1;
    let claimPageSize = 50;

    async function loadClaimRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/claim?page=${page}&pageSize=${claimPageSize}`);
        const data = await res.json();

        if (data.success) {
          claimCurrentPage = data.pagination.page;
          const tbody = document.getElementById('claimTableBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('claimCount').textContent = data.pagination.total;
          document.getElementById('claimsTotal').textContent = data.pagination.total;
          document.getElementById('claimTotal').textContent = data.pagination.total;
          document.getElementById('claimCurrentPage').textContent = data.pagination.page;
          document.getElementById('claimTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('claimPrevBtn').disabled = page === 1;
          document.getElementById('claimNextBtn').disabled = !data.pagination.hasMore;

          // ç”Ÿæˆé¡µç 
          renderClaimPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">æš‚æ— æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const quotaUSD = (r.quota_added / 500000).toFixed(2);
            const isBindingBonus = r.quota_added === 50000000; // ç»‘å®šå¥–åŠ±æ˜¯ $100
            
            const typeLabel = isBindingBonus 
              ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-semibold">ğŸ ç»‘å®šå¥–åŠ±</span>'
              : '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">ğŸ“… æ¯æ—¥é¢†å–</span>';

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 font-semibold">${r.username}</td>
                <td class="px-4 py-3 font-mono text-xs">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${typeLabel}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">$${quotaUSD}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½é¢†å–è®°å½•å¤±è´¥', e);
      }
    }

    let donateCurrentPage = 1;
    let donatePageSize = 50;

    async function loadDonateRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/donate?page=${page}&pageSize=${donatePageSize}`);
        const data = await res.json();

        if (data.success) {
          donateCurrentPage = data.pagination.page;
          const tbody = document.getElementById('donateTableBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('donateCount').textContent = data.pagination.total;
          document.getElementById('donatesTotal').textContent = data.pagination.total;
          document.getElementById('donateTotal').textContent = data.pagination.total;
          document.getElementById('donateCurrentPage').textContent = data.pagination.page;
          document.getElementById('donateTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('donatePrevBtn').disabled = page === 1;
          document.getElementById('donateNextBtn').disabled = !data.pagination.hasMore;

          // ç”Ÿæˆé¡µç 
          renderDonatePageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">æš‚æ— æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const keyTypeTag = r.key_type === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>âœ¨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>ğŸ</span><span>ModelScope</span></span>';

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 align-middle">${r.username}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 text-center align-middle">${r.keys_count}</td>
                <td class="px-4 py-3 text-right font-semibold align-middle">$${(r.total_quota_added / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="inline-block px-2 py-1 rounded text-xs ${r.push_status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${r.push_status === 'success' ? 'âœ“ æˆåŠŸ' : 'âœ• å¤±è´¥'}
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½æŠ•å–‚è®°å½•å¤±è´¥', e);
      }
    }

    let usersCurrentPage = 1;
    let usersPageSize = 20;
    let usersSearchFilter = '';  // æœç´¢è¿‡æ»¤æ¡ä»¶

    async function loadUsersList(page = 1) {
      if (page < 1) return;

      try {
        // ğŸš€ ä¼˜åŒ–ï¼šä½¿ç”¨åç«¯æœç´¢ï¼Œè€Œä¸æ˜¯å‰ç«¯è¿‡æ»¤
        let url = `/api/admin/users?page=${page}&pageSize=${usersPageSize}`;
        if (usersSearchFilter) {
          url += `&search=${encodeURIComponent(usersSearchFilter)}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          usersCurrentPage = data.pagination.page;
          const tbody = document.getElementById('usersListBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('userCount').textContent = data.pagination.total;
          document.getElementById('usersTotal').textContent = data.pagination.total;

          // ğŸ”¥ æ˜¾ç¤ºç­›é€‰ä¿¡æ¯
          if (usersSearchFilter) {
            document.getElementById('usersFilteredInfo').classList.remove('hidden');
            document.getElementById('usersFilteredCount').textContent = data.pagination.total;
          } else {
            document.getElementById('usersFilteredInfo').classList.add('hidden');
          }

          document.getElementById('usersCurrentPage').textContent = data.pagination.page;
          document.getElementById('usersTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('usersPrevBtn').disabled = page === 1;
          document.getElementById('usersNextBtn').disabled = !data.pagination.hasMore;

          // ç”Ÿæˆé¡µç 
          renderUsersPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-slate-500">æš‚æ— ç”¨æˆ·</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((user, index) => {
            const globalIndex = (page - 1) * usersPageSize + index + 1;
            const isBanned = user.is_banned === 1;
            const statusHtml = isBanned
              ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">ğŸš« å·²å°ç¦</span>`
              : `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ“ æ­£å¸¸</span>`;

            const actionButtons = isBanned
              ? `<button onclick="unbanUser('${user.linux_do_id}', '${user.username}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold transition-colors">è§£å°</button>`
              : `
                <div class="flex gap-1 justify-center flex-wrap">
                  <button onclick="showGrantFreeSpinsModal('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs font-semibold transition-colors" title="å‘æ”¾å…è´¹æ¬¡æ•°">ğŸ</button>
                  <button onclick="showGrantTicketsModal('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition-colors" title="å‘æ”¾å…¥åœºåˆ¸">ğŸŸï¸</button>
                  <button onclick="showGrantSupremeTokensModal('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded text-xs font-semibold transition-colors" title="å‘æ”¾è‡³å°Šä»¤ç‰Œ">ğŸ’</button>
                  <button onclick="banUser('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold transition-colors" title="å°ç¦ç”¨æˆ·">ğŸš«</button>
                  <button onclick="unbindUser('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-semibold transition-colors" title="è§£ç»‘ç”¨æˆ·">ğŸ”“</button>
                </div>
              `;

            // æ˜¾ç¤º LinuxDo ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º "-"
            const linuxDoUsername = user.linux_do_username ? `@${user.linux_do_username}` : '-';

            return `
              <tr class="border-b border-slate-100 ${isBanned ? 'bg-red-50' : 'hover:bg-slate-50'}">
                <td class="usersCheckboxCell hidden px-4 py-3 text-center">
                  <input type="checkbox" class="user-checkbox w-4 h-4 rounded border-slate-300" value="${user.linux_do_id}" data-username="${user.username}" onchange="updateSelectedUsersCount()">
                </td>
                <td class="px-4 py-3">${globalIndex}</td>
                <td class="px-4 py-3 font-semibold">${user.username}</td>
                <td class="px-4 py-3 font-mono text-sm text-indigo-600">${linuxDoUsername}</td>
                <td class="px-4 py-3 font-mono text-xs">${user.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${user.donate_count}</td>
                <td class="px-4 py-3 text-center">${user.claim_count}</td>
                <td class="px-4 py-3 text-right font-semibold">$${(user.total_quota / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">${statusHtml}</td>
                <td class="px-4 py-3 text-center">${actionButtons}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', e);
      }
    }

    function renderUsersPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('usersPageNumbers');
      const maxVisible = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªé¡µç 
      let pages = [];

      if (totalPages <= maxVisible) {
        // æ€»é¡µæ•°å°‘ï¼Œæ˜¾ç¤ºå…¨éƒ¨
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        // æ€»é¡µæ•°å¤šï¼Œæ™ºèƒ½æ˜¾ç¤º
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadUsersList(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function renderClaimPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('claimPageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadClaimRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeClaimsPageSize() {
      claimPageSize = parseInt(document.getElementById('claimsPageSize').value);
      loadClaimRecords(1);
    }

    function renderDonatePageNumbers(currentPage, totalPages) {
      const container = document.getElementById('donatePageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadDonateRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeDonatesPageSize() {
      donatePageSize = parseInt(document.getElementById('donatesPageSize').value);
      loadDonateRecords(1);
    }

    function changeUsersPageSize() {
      usersPageSize = parseInt(document.getElementById('usersPageSize').value);
      loadUsersList(1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    }
    
    // ğŸ”¥ æœç´¢ç”¨æˆ·
    function filterUsers() {
      usersSearchFilter = document.getElementById('usersSearchInput').value.trim();
      usersCurrentPage = 1;
      loadUsersList(1);
    }
    
    // ğŸ”¥ æ¸…é™¤ç­›é€‰
    function clearUsersFilter() {
      document.getElementById('usersSearchInput').value = '';
      usersSearchFilter = '';
      usersCurrentPage = 1;
      loadUsersList(1);
    }

    async function exportUsersData() {
      try {
        const link = document.createElement('a');
        link.href = '/api/admin/export/users';
        link.download = `users_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => showMessage('ç”¨æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success'), 500);
      } catch (e) {
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    async function banUser(linuxDoId, username) {
      const reason = prompt(`ç¡®å®šè¦å°ç¦ç”¨æˆ· "${username}" å—ï¼Ÿ\n\nè¯·è¾“å…¥å°ç¦åŸå› ï¼ˆå¯é€‰ï¼‰ï¼š`, 'è¿è§„è¡Œä¸º');
      if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/ban`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || 'è¿è§„è¡Œä¸º' }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`ç”¨æˆ· "${username}" å·²è¢«å°ç¦`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || 'å°ç¦å¤±è´¥', 'error');
        }
      } catch (e) {
        showMessage('å°ç¦å¤±è´¥', 'error');
      }
    }

    async function unbanUser(linuxDoId, username) {
      if (!confirm(`ç¡®å®šè¦è§£å°ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unban`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`ç”¨æˆ· "${username}" å·²è§£å°`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || 'è§£å°å¤±è´¥', 'error');
        }
      } catch (e) {
        showMessage('è§£å°å¤±è´¥', 'error');
      }
    }

    async function unbindUser(linuxDoId, username) {
      if (!confirm(`âš ï¸ ç¡®å®šè¦è§£é™¤ç”¨æˆ· "${username}" çš„ç»‘å®šå—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤è¯¥ç”¨æˆ·çš„ç»‘å®šä¿¡æ¯\nâ€¢ æ¸…é™¤æ‰€æœ‰ç›¸å…³è®°å½•\nâ€¢ ç”¨æˆ·éœ€è¦é‡æ–°ç»‘å®šæ‰èƒ½ä½¿ç”¨\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unbind`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`ç”¨æˆ· "${username}" çš„ç»‘å®šå·²è§£é™¤`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || 'è§£ç»‘å¤±è´¥', 'error');
        }
      } catch (e) {
        showMessage('è§£ç»‘å¤±è´¥', 'error');
      }
    }

    // ç”¨æˆ·åˆ—è¡¨æ‰¹é‡æ“ä½œåŠŸèƒ½
    let usersBatchMode = false;

    function toggleUsersBatchMode() {
      usersBatchMode = !usersBatchMode;
      const btn = document.getElementById('usersBatchBtn');
      const batchActions = document.getElementById('usersBatchActions');
      const checkboxCells = document.querySelectorAll('.usersCheckboxCell');
      const checkboxHeader = document.getElementById('usersCheckboxHeader');
      
      if (usersBatchMode) {
        btn.textContent = 'âœ“ é€€å‡ºæ‰¹é‡';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = 'æ‰¹é‡æ“ä½œ';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
        updateSelectedUsersCount();
      }
    }

    function toggleSelectAllUsers() {
      const selectAll = document.getElementById('selectAllUsers');
      const selectAllHeader = document.getElementById('selectAllUsersHeader');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedUsersCount();
    }

    function updateSelectedUsersCount() {
      const selected = document.querySelectorAll('.user-checkbox:checked');
      document.getElementById('selectedUsersCount').textContent = selected.length;
    }

    function getSelectedUsers() {
      return Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => ({
        linuxDoId: cb.value,
        username: cb.dataset.username
      }));
    }

    async function batchBanUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦å°ç¦çš„ç”¨æˆ·', 'error');
        return;
      }
      
      const reason = prompt(`ç¡®å®šè¦æ‰¹é‡å°ç¦ ${selectedUsers.length} ä¸ªç”¨æˆ·å—ï¼Ÿ\n\nè¯·è¾“å…¥å°ç¦åŸå› ï¼š`, 'è¿è§„è¡Œä¸º');
      if (reason === null) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason }),
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`æ‰¹é‡å°ç¦å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    async function batchUnbindUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦è§£ç»‘çš„ç”¨æˆ·', 'error');
        return;
      }
      
      if (!confirm(`âš ï¸ ç¡®å®šè¦æ‰¹é‡è§£ç»‘ ${selectedUsers.length} ä¸ªç”¨æˆ·å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/unbind`, {
            method: 'POST',
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`æ‰¹é‡è§£ç»‘å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    // ğŸ”¥ ä¾§è¾¹æ æœç´¢åŠŸèƒ½
    function filterSidebar(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const allNavLinks = document.querySelectorAll('.nav-link[data-search]');
      const allGroups = document.querySelectorAll('details');
      
      if (!term) {
        // æ¸…ç©ºæœç´¢ï¼šæ˜¾ç¤ºæ‰€æœ‰
        allNavLinks.forEach(link => {
          link.classList.remove('hidden', 'search-highlight');
          link.style.display = '';
        });
        return;
      }
      
      let hasMatch = false;
      
      allNavLinks.forEach(link => {
        const searchData = link.getAttribute('data-search') || '';
        const matches = searchData.toLowerCase().includes(term);
        
        if (matches) {
          link.classList.remove('hidden');
          link.classList.add('search-highlight');
          link.style.display = '';
          hasMatch = true;
          
          // å±•å¼€åŒ…å«åŒ¹é…é¡¹çš„åˆ†ç»„
          let parent = link.closest('details');
          if (parent) {
            parent.setAttribute('open', 'true');
          }
        } else {
          link.classList.add('hidden');
          link.classList.remove('search-highlight');
        }
      });
      
      // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œæ˜¾ç¤ºæç¤º
      if (!hasMatch) {
        console.log('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŠŸèƒ½');
      }
    }
    
    // ğŸ”¥ æ¸…ç©ºæœç´¢
    function clearSidebarSearch() {
      document.getElementById('sidebarSearch').value = '';
      filterSidebar('');
    }

    function showSection(section) {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold', 'active');
        link.classList.add('text-slate-700');
      });
      
      // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰æŒ‰é’®
      event.target.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold', 'active');
      event.target.classList.remove('text-slate-700');

      ['dashboard', 'config', 'keys', 'claims', 'donates', 'slotRecords', 'advancedSlotRecords', 'slotConfig', 'advancedSlotConfig', 'ticketDropRecords', 'slotAnalytics', 'profitLeaderboard', 'lossLeaderboard', 'users', 'grantFreeSpins', 'pendingRewards', 'bannedUsers', 'kunbeiManagement', 'kunbeiRecords', 'weightConfigs', 'rewardConfigs', 'supremeConfig', 'supremeRecords', 'dropConfigs', 'achievementManagement', 'achievementLeaderboard'].forEach(s => {
        document.getElementById(s + 'Section').classList.add('hidden');
      });
      document.getElementById(section + 'Section').classList.remove('hidden');

      if (section === 'users') loadUsersList(1);
      if (section === 'slotRecords') loadSlotRecords(1);
      if (section === 'advancedSlotRecords') loadAdvancedSlotRecords(1);
      if (section === 'ticketDropRecords') loadTicketDropRecords(1);
      if (section === 'achievementManagement') refreshAchievements();
      if (section === 'achievementLeaderboard') refreshAchievementLeaderboard();
      if (section === 'slotConfig') {
        loadSlotConfig();
        // æ—§ç‰ˆæ‰‹åŠ¨é…ç½®å·²ç§»é™¤ï¼Œä¸å†åŠ è½½
      }
      if (section === 'advancedSlotConfig') {
        loadAdvancedSlotConfig();
        // æ—§ç‰ˆæ‰‹åŠ¨é…ç½®å·²ç§»é™¤ï¼Œä¸å†åŠ è½½
      }
      if (section === 'slotAnalytics') loadSlotAnalytics();
      if (section === 'profitLeaderboard') loadProfitLeaderboard();
      if (section === 'lossLeaderboard') loadLossLeaderboard();
      if (section === 'pendingRewards') loadPendingRewards();
      if (section === 'bannedUsers') loadBannedUsers();
      if (section === 'kunbeiManagement') loadKunbeiManagement();
      if (section === 'kunbeiRecords') loadKunbeiRecords();
      if (section === 'weightConfigs') loadWeightConfigs();
      if (section === 'rewardConfigs') loadRewardConfigs();
      if (section === 'supremeConfig') loadSupremeConfig();
      if (section === 'supremeRecords') loadSupremeRecords();
      if (section === 'dropConfigs') loadDropConfigs();
    }

    // è€è™æœºé…ç½®ç®¡ç†
    async function loadSlotConfig() {
      try {
        const res = await fetch('/api/admin/slot/config');
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          // å°†èªè½¬æ¢ä¸ºç¾å…ƒæ˜¾ç¤º
          const betAmountUSD = (config.bet_amount / 500000).toFixed(2);
          const minQuotaUSD = (config.min_quota_required / 500000).toFixed(2);
          const buySpinsPriceUSD = ((config.buy_spins_price || 20000000) / 500000).toFixed(2);

          document.getElementById('slotBetAmountUSD').value = betAmountUSD;
          document.getElementById('slotMaxDailySpins').value = config.max_daily_spins;
          document.getElementById('slotMinQuotaUSD').value = minQuotaUSD;
          document.getElementById('slotEnabled').value = config.enabled;
          document.getElementById('slotBackgroundType').value = config.background_type || 'default';

          // è´­ä¹°æ¬¡æ•°é…ç½®
          document.getElementById('buySpinsEnabled').value = config.buy_spins_enabled || 0;
          document.getElementById('buySpinsPriceUSD').value = buySpinsPriceUSD;
          document.getElementById('maxDailyBuySpins').value = config.max_daily_buy_spins || 5;

          // æ›´æ–°æ˜¾ç¤º
          document.getElementById('slotBetAmountDisplay').textContent = betAmountUSD;
          document.getElementById('slotMinQuotaDisplay').textContent = minQuotaUSD;
          document.getElementById('buySpinsPriceDisplay').textContent = buySpinsPriceUSD;
        }
        
        // åŠ è½½æƒé‡é…ç½®æ–¹æ¡ˆåˆ—è¡¨
        await loadNormalWeightConfigOptions();
        // åŠ è½½å¥–åŠ±é…ç½®æ–¹æ¡ˆåˆ—è¡¨  
        await loadNormalRewardSchemeOptions();
      } catch (error) {
        console.error('åŠ è½½è€è™æœºé…ç½®å¤±è´¥:', error);
        showMessage('åŠ è½½é…ç½®å¤±è´¥', 'error');
      }
    }
    
    //åŠ è½½åˆçº§åœºæƒé‡é…ç½®æ–¹æ¡ˆé€‰é¡¹
    async function loadNormalWeightConfigOptions() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('normalSlotWeightConfigId');
          
          // å…ˆè·å–å½“å‰é…ç½®
          const configRes = await fetch('/api/admin/slot/config');
          const configData = await configRes.json();
          const currentWeightId = configData.success && configData.data.weight_config_id ? configData.data.weight_config_id : null;
          
          // æ¸²æŸ“é€‰é¡¹ï¼Œç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = data.data.map(w => 
            `<option value="${w.id}">${w.config_name}</option>`
          ).join('');
          
          // è®¾ç½®å½“å‰é€‰ä¸­çš„é…ç½®
          if (currentWeightId) {
            select.value = currentWeightId;
            previewNormalWeightConfig();
          }
        }
      } catch (error) {
        console.error('åŠ è½½æƒé‡é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // åŠ è½½åˆçº§åœºå¥–åŠ±é…ç½®æ–¹æ¡ˆé€‰é¡¹
    async function loadNormalRewardSchemeOptions() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('normalSlotRewardSchemeId');
          
          // å…ˆè·å–å½“å‰é…ç½®
          const configRes = await fetch('/api/admin/slot/config');
          const configData = await configRes.json();
          const currentSchemeId = configData.success && configData.data.reward_scheme_id ? configData.data.reward_scheme_id : null;
          
          // æ¸²æŸ“é€‰é¡¹ï¼Œç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = data.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}</option>`
          ).join('');
          
          // è®¾ç½®å½“å‰é€‰ä¸­çš„é…ç½®
          if (currentSchemeId) {
            select.value = currentSchemeId;
            previewNormalRewardScheme();
          }
        }
      } catch (error) {
        console.error('åŠ è½½å¥–åŠ±é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // é¢„è§ˆåˆçº§åœºæƒé‡é…ç½®
    async function previewNormalWeightConfig() {
      const configId = document.getElementById('normalSlotWeightConfigId').value;
      if (!configId) return;
      
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.find(c => c.id == configId);
          if (config) {
            document.getElementById('preview_weight_m').textContent = config.weight_m;
            document.getElementById('preview_weight_t').textContent = config.weight_t;
            document.getElementById('preview_weight_n').textContent = config.weight_n;
            document.getElementById('preview_weight_j').textContent = config.weight_j;
            document.getElementById('preview_weight_lq').textContent = config.weight_lq;
            document.getElementById('preview_weight_bj').textContent = config.weight_bj;
            document.getElementById('preview_weight_zft').textContent = config.weight_zft;
            document.getElementById('preview_weight_bdk').textContent = config.weight_bdk;
            document.getElementById('preview_weight_lsh').textContent = config.weight_lsh;
            document.getElementById('preview_weight_man').textContent = config.weight_man || 25;
            document.getElementById('normalWeightPreview').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('é¢„è§ˆæƒé‡é…ç½®å¤±è´¥:', error);
      }
    }
    
    // é¢„è§ˆåˆçº§åœºå¥–åŠ±é…ç½®
    async function previewNormalRewardScheme() {
      const schemeId = document.getElementById('normalSlotRewardSchemeId').value;
      if (!schemeId) return;
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (data.success) {
          const rules = data.data.rules || [];
          const punishments = data.data.punishments || [];
          const previewList = document.getElementById('normalRewardPreviewList');
          
          let html = '';
          
          // ğŸ ä¸­å¥–è§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (rules.length > 0) {
            html += `
              <div class="mb-4">
                <h5 class="text-xs font-bold text-green-700 mb-2">ğŸ ä¸­å¥–è§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${rules.map(rule => `
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1 truncate" title="${rule.rule_name}">${rule.rule_name}</div>
                      <div class="text-lg font-bold text-green-600">${rule.win_multiplier}x</div>
                      ${rule.grant_free_spin > 0 ? `<div class="text-xs text-amber-600 mt-1">ğŸ +${rule.grant_free_spin}æ¬¡å…è´¹</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          // âš ï¸ æƒ©ç½šè§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (punishments.length > 0) {
            html += `
              <div>
                <h5 class="text-xs font-bold text-red-700 mb-2">âš ï¸ æƒ©ç½šè§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${punishments.map(p => `
                    <div class="bg-gradient-to-br from-red-50 to-rose-50 p-3 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1">å¾‹å¸ˆå‡½Ã—${p.lsh_count}</div>
                      <div class="text-lg font-bold text-red-600">-${p.deduct_multiplier}x</div>
                      ${p.ban_hours > 0 ? `<div class="text-xs text-red-600 mt-1">ğŸš« ç¦${p.ban_hours}å°æ—¶</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          if (rules.length === 0 && punishments.length === 0) {
            html = '<div class="text-slate-500 text-center py-4">æš‚æ— è§„åˆ™</div>';
          }
          
          previewList.innerHTML = html;
          document.getElementById('normalRewardPreview').classList.remove('hidden');
        }
      } catch (error) {
        console.error('é¢„è§ˆå¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // è®¡ç®—åˆçº§åœºæ¦‚ç‡
    async function calculateNormalProbability() {
      const weightConfigId = document.getElementById('normalSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('normalSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        document.getElementById('normalProbabilityDisplay').classList.add('hidden');
        return;
      }
      
      const method = document.querySelector('input[name="normalCalcMethod"]:checked').value;
      const displayDiv = document.getElementById('normalProbabilityDisplay');
      const cacheKey = getCacheKey(weightConfigId, rewardSchemeId, method);
      
      // ğŸ”¥ å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼ˆç¡®ä¿è·å–æœ€æ–°è®¡ç®—ç»“æœï¼‰
      if (probabilityCache.has(cacheKey)) {
        console.log('[å¼ºåˆ¶åˆ·æ–°] æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ¦‚ç‡');
        probabilityCache.delete(cacheKey);
      }
      
      // ğŸ”„ æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
      let progressPercent = 0;
      const progressInterval = method === 'monte-carlo' ? setInterval(() => {
        if (progressPercent < 95) {
          progressPercent += Math.random() * 10;
          if (progressPercent > 95) progressPercent = 95;
          updateProgressBar(displayDiv, progressPercent, method);
        }
      }, 200) : null;
      
      updateProgressBar(displayDiv, 0, method);
      displayDiv.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/admin/calculate-probability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId),
            method: method,
            simulation_count: method === 'monte-carlo' ? 1000000 : undefined
          })
        });
        
        const data = await res.json();
        
        if (progressInterval) {
          clearInterval(progressInterval);
          updateProgressBar(displayDiv, 100, method);
        }
        
        if (data.success) {
          const result = data.data;
          // ğŸ”¥ ç¼“å­˜ç»“æœ
          probabilityCache.set(cacheKey, result);
          setTimeout(() => {
            renderProbabilityDisplay('normalProbabilityDisplay', result);
          }, 300);
        } else {
          displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥: ${data.message}</div>`;
        }
      } catch (error) {
        if (progressInterval) clearInterval(progressInterval);
        console.error('è®¡ç®—æ¦‚ç‡å¤±è´¥:', error);
        displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
      }
    }
    
    // ä¿å­˜åˆçº§åœºé…ç½®æ–¹æ¡ˆé€‰æ‹©
    async function saveNormalSlotConfigSchemes() {
      const weightConfigId = document.getElementById('normalSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('normalSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        showToast('è¯·é€‰æ‹©æƒé‡é…ç½®æ–¹æ¡ˆå’Œå¥–åŠ±é…ç½®æ–¹æ¡ˆ', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/slot/config/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId)
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('âœ… åˆçº§åœºé…ç½®æ–¹æ¡ˆå·²ä¿å­˜å¹¶ç”Ÿæ•ˆ', 'success');
          // ğŸ”¥ é‡æ–°åŠ è½½é…ç½®ä»¥åˆ·æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤º
          await loadNormalWeightConfigOptions();
          await loadNormalRewardSchemeOptions();
          // ğŸ”¥ é‡æ–°è®¡ç®—æ¦‚ç‡
          await calculateNormalProbability();
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜åˆçº§åœºé…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥', 'error');
      }
    }

    async function updateSlotConfig() {
      try {
        const betAmountUSD = parseFloat(document.getElementById('slotBetAmountUSD').value);
        const maxDailySpins = parseInt(document.getElementById('slotMaxDailySpins').value);
        const minQuotaUSD = parseFloat(document.getElementById('slotMinQuotaUSD').value);
        const enabled = parseInt(document.getElementById('slotEnabled').value);
        const backgroundType = document.getElementById('slotBackgroundType').value;

        // è´­ä¹°æ¬¡æ•°é…ç½®
        const buySpinsEnabled = parseInt(document.getElementById('buySpinsEnabled').value);
        const buySpinsPriceUSD = parseFloat(document.getElementById('buySpinsPriceUSD').value);
        const maxDailyBuySpins = parseInt(document.getElementById('maxDailyBuySpins').value);

        if (isNaN(betAmountUSD) || betAmountUSD < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•æ³¨é‡‘é¢', 'error');
          return;
        }
        if (isNaN(maxDailySpins) || maxDailySpins < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯æ—¥æ¬¡æ•°', 'error');
          return;
        }
        if (isNaN(minQuotaUSD) || minQuotaUSD < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€ä½é¢åº¦', 'error');
          return;
        }
        if (isNaN(buySpinsPriceUSD) || buySpinsPriceUSD < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è´­ä¹°ä»·æ ¼', 'error');
          return;
        }
        if (isNaN(maxDailyBuySpins) || maxDailyBuySpins < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯æ—¥æœ€å¤§è´­ä¹°æ¬¡æ•°', 'error');
          return;
        }

        // å°†ç¾å…ƒè½¬æ¢ä¸ºèª
        const betAmount = Math.floor(betAmountUSD * 500000);
        const minQuota = Math.floor(minQuotaUSD * 500000);
        const buySpinsPrice = Math.floor(buySpinsPriceUSD * 500000);

        const res = await fetch('/api/admin/slot/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bet_amount: betAmount,
            max_daily_spins: maxDailySpins,
            min_quota_required: minQuota,
            enabled: enabled,
            background_type: backgroundType,
            buy_spins_enabled: buySpinsEnabled,
            buy_spins_price: buySpinsPrice,
            max_daily_buy_spins: maxDailyBuySpins
          })
        });

        const data = await res.json();

        if (data.success) {
          showMessage('é…ç½®å·²æ›´æ–°', 'success');
          loadSlotConfig();
        } else {
          showMessage(data.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    // è€è™æœºè®°å½•ç®¡ç†
    let slotCurrentPage = 1;
    let slotPageSize = 50;

    // ğŸš€ ä¼˜åŒ–ï¼šç§»é™¤å‰ç«¯å¤§æ‰¹é‡åŠ è½½ï¼Œä½¿ç”¨æœåŠ¡ç«¯ç­›é€‰
    async function loadSlotRecords(page = 1) {
      if (page < 1) return;

      try {
        // ğŸš€ ä¼˜åŒ–ï¼šä½¿ç”¨æœåŠ¡ç«¯ç­›é€‰ï¼Œå°†æœç´¢å‚æ•°ä¼ ç»™åç«¯
        const searchInput = document.getElementById('adminRecordSearchInput')?.value.trim() || '';

        // æ„å»ºè¯·æ±‚ URL
        let url = `/api/admin/records/slot?page=${page}&pageSize=${slotPageSize}`;
        if (searchInput) {
          url += `&username=${encodeURIComponent(searchInput)}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          slotCurrentPage = data.pagination.page;

          const tbody = document.getElementById('slotTableBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('slotTotal').textContent = data.pagination.total;
          document.getElementById('slotFiltered').textContent = data.pagination.total;
          document.getElementById('slotCurrentPage').textContent = data.pagination.page;
          document.getElementById('slotTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('slotPrevBtn').disabled = data.pagination.page <= 1;
          document.getElementById('slotNextBtn').disabled = data.pagination.page >= data.pagination.totalPages;

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">æš‚æ— è®°å½•</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const symbols = JSON.parse(r.result_symbols);
            const symbolsHTML = symbols.map(s => {
              const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
              return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-8 h-8 inline-block border border-slate-300 rounded mr-1">`;
            }).join('');

            const winClass = r.win_amount > 0 ? 'text-green-600' : 'text-slate-500';
            const typeClass = r.is_free_spin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
            const typeLabel = r.is_free_spin ? 'å…è´¹' : 'æ™®é€š';

            // ä¼˜å…ˆæ˜¾ç¤ºrule_nameï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨winTypeæ˜ å°„
            const displayWinType = r.rule_name || (() => {
              const winTypeLabels = {
                'super_jackpot': 'ğŸ† è¶…çº§å¤§å¥–',
                'special_combo': 'ğŸ’ ç‰¹æ®Šç»„åˆ',
                'quad': 'ğŸ° å››è¿',
                'triple': 'âœ¨ ä¸‰è¿',
                'double': 'ğŸ åŒè¿',
                'man_only': 'ğŸ¯ Manç»„åˆ',
                'man_quad': 'ğŸ° ManÃ—4',
                'symmetric': 'ğŸ”„ å¯¹ç§°ABBA',
                'consecutive': 'â­ è¿ç»­',
                'combination': 'ğŸ ç»„åˆ',
                'any': 'ğŸ² ä»»æ„',
                'double_pair': 'ğŸ­ ä¸¤å¯¹',
                'punishment': 'âš¡ æƒ©ç½š',
                'none': 'âŒ æœªä¸­å¥–'
              };
              return winTypeLabels[r.win_type] || r.win_type;
            })();

            // ä¼˜å…ˆæ˜¾ç¤º LinuxDo ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºå…¬ç›Šç«™ç”¨æˆ·å
            const displayName = r.linux_do_username || r.username;
            const hasLinuxDoUsername = r.linux_do_username && r.linux_do_username !== r.username;

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 text-sm">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3">
                  <div class="font-semibold text-indigo-600">@${displayName}</div>
                  ${hasLinuxDoUsername ? `<div class="text-xs text-slate-500">å…¬ç›Šç«™: ${r.username}</div>` : ''}
                </td>
                <td class="px-4 py-3 font-mono text-xs text-slate-600">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${symbolsHTML}</td>
                <td class="px-4 py-3 text-center text-sm font-semibold">${displayWinType}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">${r.win_multiplier}x</td>
                <td class="px-4 py-3 text-right font-semibold">$${(r.bet_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">$${(r.win_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 ${typeClass} rounded-full text-xs font-semibold">${typeLabel}</span>
                  ${r.free_spin_awarded ? '<span class="ml-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">+1ğŸ</span>' : ''}
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½è€è™æœºè®°å½•å¤±è´¥', e);
      }
    }

    async function refreshSlotRecords() {
      const icon = document.getElementById('slotRefreshIcon');
      icon.classList.add('animate-spin');

      try {
        // ğŸš€ ä¼˜åŒ–ï¼šç›´æ¥é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
        await loadSlotRecords(1);
        showToast('è®°å½•å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('åˆ·æ–°å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥', 'error');
      }

      setTimeout(() => icon.classList.remove('animate-spin'), 500);
    }

    function changeSlotPageSize() {
      slotPageSize = parseInt(document.getElementById('slotPageSize').value);
      loadSlotRecords(1);
    }

    // ğŸš€ ä¼˜åŒ–ï¼šAdminè®°å½•ç­›é€‰åŠŸèƒ½æ”¹ä¸ºè§¦å‘æœåŠ¡ç«¯ç­›é€‰
    function filterAdminSlotRecords() {
      // ç›´æ¥é‡æ–°åŠ è½½ï¼Œæœç´¢å‚æ•°ä¼šåœ¨ loadSlotRecords ä¸­è¢«ä½¿ç”¨
      loadSlotRecords(1);
    }

    // ğŸš€ ä¼˜åŒ–ï¼šåˆ·æ–°è®°å½•ï¼ˆç›´æ¥é‡æ–°åŠ è½½å½“å‰é¡µï¼‰
    async function refreshAdminSlotRecords() {
      try {
        const refreshBtn = event?.target?.closest('button');
        const refreshIcon = refreshBtn?.querySelector('svg');
        if (refreshIcon) {
          refreshIcon.classList.add('animate-spin');
        }

        // é‡æ–°åŠ è½½å½“å‰é¡µï¼ˆä¿ç•™ç­›é€‰æ¡ä»¶ï¼‰
        await loadSlotRecords(slotCurrentPage);

        if (refreshIcon) {
          refreshIcon.classList.remove('animate-spin');
        }

        showToast('è®°å½•å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('åˆ·æ–°è®°å½•å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    // ğŸš€ ä¼˜åŒ–ï¼šæ¸…é™¤ç­›é€‰æ¡ä»¶ï¼ˆé‡æ–°åŠ è½½ç¬¬ä¸€é¡µï¼‰
    function clearAdminRecordFilters() {
      document.getElementById('adminRecordSearchInput').value = '';
      loadSlotRecords(1);
    }

    // ç¬¦å·æƒé‡é…ç½®ç®¡ç†
    async function loadSymbolWeights() {
      try {
        const res = await fetch('/api/admin/slot/weights');
        const data = await res.json();

        if (data.success) {
          const weights = data.data;
          
          // å¡«å……è¡¨å•
          document.getElementById('weight_m').value = weights.weight_m;
          document.getElementById('weight_t').value = weights.weight_t;
          document.getElementById('weight_n').value = weights.weight_n;
          document.getElementById('weight_j').value = weights.weight_j;
          document.getElementById('weight_lq').value = weights.weight_lq;
          document.getElementById('weight_bj').value = weights.weight_bj;
          document.getElementById('weight_zft').value = weights.weight_zft;
          document.getElementById('weight_bdk').value = weights.weight_bdk;
          document.getElementById('weight_lsh').value = weights.weight_lsh;
          
          // è‡ªåŠ¨è®¡ç®—æ¦‚ç‡
          calculateProbabilities();
        }
      } catch (error) {
        console.error('åŠ è½½ç¬¦å·æƒé‡å¤±è´¥:', error);
        showMessage('åŠ è½½ç¬¦å·æƒé‡å¤±è´¥', 'error');
      }
    }

    async function updateSymbolWeights() {
      try {
        const weights = {
          weight_m: parseInt(document.getElementById('weight_m').value),
          weight_t: parseInt(document.getElementById('weight_t').value),
          weight_n: parseInt(document.getElementById('weight_n').value),
          weight_j: parseInt(document.getElementById('weight_j').value),
          weight_lq: parseInt(document.getElementById('weight_lq').value),
          weight_bj: parseInt(document.getElementById('weight_bj').value),
          weight_zft: parseInt(document.getElementById('weight_zft').value),
          weight_bdk: parseInt(document.getElementById('weight_bdk').value),
          weight_lsh: parseInt(document.getElementById('weight_lsh').value)
        };

        // éªŒè¯æ‰€æœ‰æƒé‡
        for (const [key, value] of Object.entries(weights)) {
          if (isNaN(value) || value < 1 || value > 1000) {
            showMessage(`${key} æƒé‡å¿…é¡»æ˜¯1-1000ä¹‹é—´çš„æ•´æ•°`, 'error');
            return;
          }
        }

        const res = await fetch('/api/admin/slot/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weights)
        });

        const data = await res.json();

        if (data.success) {
          showMessage('ç¬¦å·æƒé‡å·²æ›´æ–°ï¼Œå·²ç«‹å³ç”Ÿæ•ˆ', 'success');
          loadSymbolWeights();
        } else {
          showMessage(data.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°ç¬¦å·æƒé‡å¤±è´¥:', error);
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    function calculateProbabilities() {
      const symbols = ['m', 't', 'n', 'j', 'lq', 'bj', 'zft', 'bdk', 'lsh', 'man'];
      const weights = {};
      let totalWeight = 0;

      // è·å–æ‰€æœ‰æƒé‡å€¼
      symbols.forEach(symbol => {
        const value = parseInt(document.getElementById('weight_' + symbol).value) || 0;
        weights[symbol] = value;
        totalWeight += value;
      });

      // æ›´æ–°æ€»æƒé‡æ˜¾ç¤º
      document.getElementById('totalWeight').textContent = totalWeight.toLocaleString();

      // è®¡ç®—å¹¶æ˜¾ç¤ºæ¯ä¸ªç¬¦å·çš„æ¦‚ç‡
      symbols.forEach(symbol => {
        const weight = weights[symbol];
        const probability = totalWeight > 0 ? (weight / totalWeight * 100).toFixed(2) : '0.00';
        const probEl = document.getElementById('prob_' + symbol);
        if (probEl) {
          probEl.textContent = `æ¦‚ç‡: ${probability}%`;
        }
        
        // ä¸ºå¾‹å¸ˆå‡½é¢å¤–è®¡ç®—4ä¸ªä½ç½®è‡³å°‘å‡ºç°1æ¬¡çš„æ¦‚ç‡
        if (symbol === 'lsh') {
          const singleProb = weight / totalWeight;
          const atLeastOnce = (1 - Math.pow(1 - singleProb, 4)) * 100;
          const lshProbEl = document.getElementById('prob_lsh_appear');
          if (lshProbEl) {
            lshProbEl.textContent = `4ä¸ªä½ç½®è‡³å°‘å‡ºç°1æ¬¡: ${atLeastOnce.toFixed(2)}%`;
          }
        }
      });
    }

    function resetToDefault() {
      if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æƒé‡é…ç½®å—ï¼Ÿ\n\né»˜è®¤é…ç½®ï¼š\næ™®é€šç¬¦å·(m,t,n,j,lq,bj,zft,bdk): 100\nå¾‹å¸ˆå‡½(lsh): 25')) {
        return;
      }

      // è®¾ç½®é»˜è®¤å€¼
      document.getElementById('weight_m').value = 100;
      document.getElementById('weight_t').value = 100;
      document.getElementById('weight_n').value = 100;
      document.getElementById('weight_j').value = 100;
      document.getElementById('weight_lq').value = 100;
      document.getElementById('weight_bj').value = 100;
      document.getElementById('weight_zft').value = 100;
      document.getElementById('weight_bdk').value = 100;
      document.getElementById('weight_lsh').value = 25;

      // è®¡ç®—æ¦‚ç‡
      calculateProbabilities();
    }

    // å¥–åŠ±å€æ•°é…ç½®ç®¡ç†
    async function loadMultipliers() {
      try {
        const res = await fetch('/api/admin/slot/multipliers');
        const data = await res.json();

        if (data.success) {
          const multipliers = data.data;

          // å¡«å……è¡¨å•
          document.getElementById('super_jackpot_multiplier').value = multipliers.super_jackpot_multiplier;
          document.getElementById('special_combo_multiplier').value = multipliers.special_combo_multiplier;
          document.getElementById('quad_multiplier').value = multipliers.quad_multiplier;
          document.getElementById('triple_multiplier').value = multipliers.triple_multiplier;
          document.getElementById('double_multiplier').value = multipliers.double_multiplier;
        }
      } catch (error) {
        console.error('åŠ è½½å¥–åŠ±å€æ•°å¤±è´¥:', error);
        showMessage('åŠ è½½å¥–åŠ±å€æ•°å¤±è´¥', 'error');
      }
    }

    async function saveMultipliers() {
      try {
        const multipliers = {
          super_jackpot_multiplier: parseInt(document.getElementById('super_jackpot_multiplier').value),
          special_combo_multiplier: parseInt(document.getElementById('special_combo_multiplier').value),
          quad_multiplier: parseInt(document.getElementById('quad_multiplier').value),
          triple_multiplier: parseInt(document.getElementById('triple_multiplier').value),
          double_multiplier: parseInt(document.getElementById('double_multiplier').value)
        };

        // éªŒè¯æ‰€æœ‰å€æ•°
        for (const [key, value] of Object.entries(multipliers)) {
          if (isNaN(value) || value < 1 || value > 10000) {
            showMessage(`å€æ•°å¿…é¡»æ˜¯1-10000ä¹‹é—´çš„æ•´æ•°`, 'error');
            return;
          }
        }

        const res = await fetch('/api/admin/slot/multipliers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(multipliers)
        });

        const data = await res.json();

        if (data.success) {
          showMessage('å¥–åŠ±å€æ•°å·²æ›´æ–°ï¼Œå·²ç«‹å³ç”Ÿæ•ˆ', 'success');
          loadMultipliers();
        } else {
          showMessage(data.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°å¥–åŠ±å€æ•°å¤±è´¥:', error);
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    // è€è™æœºæŠ½å¥–åˆ†æ
    async function loadSlotAnalytics() {
      try {
        // ğŸ”¥ åˆ·æ–°æŒ‰é’®åŠ¨ç”»
        const refreshIcon = document.getElementById('analyticsRefreshIcon');
        if (refreshIcon) {
          refreshIcon.classList.add('animate-spin');
        }
        
        // ğŸ”¥ è·å–ç­›é€‰å‚æ•°
        const recordCount = document.getElementById('analyticsRecordCount')?.value || '500';
        const slotMode = document.getElementById('analyticsSlotMode')?.value || 'all';
        
        const res = await fetch(`/api/admin/slot/analytics?limit=${recordCount}&mode=${slotMode}`);
        const data = await res.json();
        
        // ğŸ”¥ åœæ­¢åŠ¨ç”»
        if (refreshIcon) {
          refreshIcon.classList.remove('animate-spin');
        }

        if (!data.success) {
          showMessage('åŠ è½½åˆ†ææ•°æ®å¤±è´¥', 'error');
          return;
        }

        const analytics = data.data;
        const summary = analytics.summary;
        const winTypes = analytics.winTypes;
        const dailyStats = analytics.dailyStats;
        const userStats = analytics.userStats;
        const filters = analytics.filters || {};

        // ğŸ”¥ æ˜¾ç¤ºå½“å‰ç­›é€‰æ¡ä»¶
        const modeText = filters.mode === 'normal' ? 'åˆçº§åœº' : 
                        filters.mode === 'advanced' ? 'é«˜çº§åœº' : 'å…¨éƒ¨æ¨¡å¼';
        console.log(`[æŠ½å¥–åˆ†æ] æ­£åœ¨åˆ†æ: ${modeText} - æœ€è¿‘${filters.limit}æ¡è®°å½•`);

        // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
        document.getElementById('analyticsTotal').textContent = summary.totalCount.toLocaleString();
        document.getElementById('analyticsWinRate').textContent = summary.winRate.toFixed(1) + '%';
        document.getElementById('analyticsWinCount').textContent = summary.winCount.toLocaleString();
        document.getElementById('analyticsTotalBet').textContent = '$' + (summary.totalBet / 500000).toFixed(2);
        document.getElementById('analyticsTotalWin').textContent = '$' + (summary.totalWin / 500000).toFixed(2);
        
        const netProfit = summary.netProfit;
        const netProfitElement = document.getElementById('analyticsNetProfit');
        netProfitElement.textContent = (netProfit >= 0 ? '+' : '') + '$' + (netProfit / 500000).toFixed(2);
        netProfitElement.className = netProfit >= 0 
          ? 'text-3xl font-bold text-green-600' 
          : 'text-3xl font-bold text-red-600';

        // ğŸ”¥ è®¡ç®—å¹¶æ˜¾ç¤ºRTPæ•°æ®
        const overallRTP = summary.totalBet > 0 ? ((summary.totalWin / summary.totalBet) * 100).toFixed(2) : '0.00';
        document.getElementById('analyticsRTP').textContent = overallRTP + '%';
        
        // RTPè¯¦ç»†åˆ†æ
        document.getElementById('rtpOverall').textContent = overallRTP + '%';
        document.getElementById('rtpTotalBet').textContent = '$' + (summary.totalBet / 500000).toFixed(2);
        document.getElementById('rtpTotalWin').textContent = '$' + (summary.totalWin / 500000).toFixed(2);
        
        // ğŸ”¥ è®¡ç®—ä¸­å¥–æ¸¸æˆRTPï¼ˆåŠ¨æ€ï¼‰
        const winGameTypes = winTypes.filter(t => t.name !== 'none' && !t.name.includes('å¾‹å¸ˆå‡½') && t.name !== 'punishment');
        const winGames = winGameTypes.reduce((sum, t) => sum + t.count, 0);
        const winGamesBet = winGameTypes.reduce((sum, t) => sum + t.totalBet, 0);
        const winGamesWin = winGameTypes.reduce((sum, t) => sum + t.totalWin, 0);
        
        const winGamesRTP = winGamesBet > 0 ? ((winGamesWin / winGamesBet) * 100).toFixed(2) : '0.00';
        document.getElementById('rtpWinGames').textContent = winGamesRTP + '%';
        document.getElementById('rtpWinCount').textContent = winGames;
        document.getElementById('rtpWinBet').textContent = '$' + (winGamesBet / 500000).toFixed(2);
        
        // ğŸ”¥ è®¡ç®—æœªä¸­å¥–æŸå¤±ï¼ˆåŠ¨æ€ï¼‰
        const lossTypes = winTypes.filter(t => t.name === 'none' || t.name.includes('å¾‹å¸ˆå‡½') || t.name === 'punishment');
        const lossGames = lossTypes.reduce((sum, t) => sum + t.count, 0);
        const lossAmount = Math.abs(lossTypes.reduce((sum, t) => sum + t.totalWin, 0));
        const lossRate = summary.totalBet > 0 ? ((lossAmount / summary.totalBet) * 100).toFixed(2) : '0.00';
        
        document.getElementById('rtpLossRate').textContent = lossRate + '%';
        document.getElementById('rtpLossCount').textContent = lossGames;
        document.getElementById('rtpLossAmount').textContent = '$' + (lossAmount / 500000).toFixed(2);
        
        // ğŸ”¥ æŒ‰ä¸­å¥–ç±»å‹æ˜¾ç¤ºRTPè´¡çŒ®ï¼ˆåŠ¨æ€æ˜¾ç¤ºæ‰€æœ‰è§„åˆ™ï¼‰
        const rtpByWinTypeHtml = winTypes
          .map(type => {
            const contributionPercent = summary.totalBet > 0 ? ((type.totalWin / summary.totalBet) * 100).toFixed(2) : '0.00';
            
            // ğŸ”¥ åŠ¨æ€è·å–è§„åˆ™å›¾æ ‡å’Œåç§°
            let icon = 'ğŸ¯';
            let displayName = type.name;
            
            // æ ¹æ®è§„åˆ™åç§°è‡ªåŠ¨é€‰æ‹©å›¾æ ‡
            if (type.name.includes('å¾‹å¸ˆå‡½')) {
              icon = 'âš¡';
            } else if (type.name === 'none' || type.name === 'æœªä¸­å¥–') {
              icon = 'âŒ';
              displayName = 'æœªä¸­å¥–';
            } else if (type.name.includes('jntm')) {
              icon = type.name.includes('æŒ‰é¡ºåº') ? 'ğŸ†' : 'ğŸ’';
            } else if (type.name.includes('å››è¿')) {
              icon = 'ğŸ°';
            } else if (type.name.includes('ä¸‰è¿') || type.name.includes('3è¿')) {
              icon = 'âœ¨';
            } else if (type.name.includes('åŒè¿') || type.name.includes('2è¿') || type.name.includes('ä¸¤å¯¹')) {
              icon = 'ğŸ';
            }
            
            const rtpColor = type.rtp >= 100 ? 'text-green-600' : 
                           type.rtp >= 50 ? 'text-yellow-600' : 'text-red-600';
            
            return `
              <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                <div class="flex-1">
                  <div class="font-medium text-slate-900">${icon} ${displayName}</div>
                  <div class="text-xs text-slate-600 mt-1">
                    å‡ºç°${type.count}æ¬¡ Â· æ€»èµ¢å¾—$${(type.totalWin / 500000).toFixed(2)}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold ${rtpColor}">${type.rtp.toFixed(2)}%</div>
                  <div class="text-xs text-slate-500">å¯¹æ•´ä½“è´¡çŒ®: ${contributionPercent >= 0 ? '+' : ''}${contributionPercent}%</div>
                </div>
              </div>
            `;
          }).join('');
        
        document.getElementById('rtpByWinType').innerHTML = rtpByWinTypeHtml;

        // ğŸ”¥ æ¸²æŸ“ä¸­å¥–ç±»å‹åˆ†å¸ƒï¼ˆåŠ¨æ€æ˜¾ç¤ºæ‰€æœ‰è§„åˆ™ï¼‰
        const winTypesHtml = winTypes
          .map(type => {
            const percentage = summary.totalCount > 0 ? (type.count / summary.totalCount * 100).toFixed(2) : '0.00';
            const barWidth = summary.totalCount > 0 ? (type.count / summary.totalCount * 100) : 0;
            
            // ğŸ”¥ åŠ¨æ€è·å–è§„åˆ™å›¾æ ‡å’Œåç§°
            let icon = 'ğŸ¯';
            let displayName = type.name;
            
            if (type.name.includes('å¾‹å¸ˆå‡½')) {
              icon = 'âš¡';
            } else if (type.name === 'none' || type.name === 'æœªä¸­å¥–') {
              icon = 'âŒ';
              displayName = 'æœªä¸­å¥–';
            } else if (type.name.includes('jntm')) {
              icon = type.name.includes('æŒ‰é¡ºåº') ? 'ğŸ†' : 'ğŸ’';
            } else if (type.name.includes('å››è¿') || type.name === 'quad') {
              icon = 'ğŸ°';
              if (type.name === 'quad') displayName = 'å››è¿';
            } else if (type.name.includes('ä¸‰è¿') || type.name.includes('3è¿') || type.name === 'triple') {
              icon = 'âœ¨';
              if (type.name === 'triple') displayName = 'ä¸‰è¿';
            } else if (type.name.includes('åŒè¿') || type.name.includes('2è¿') || type.name.includes('ä¸¤å¯¹') || type.name === 'double') {
              icon = 'ğŸ';
              if (type.name === 'double') displayName = 'åŒè¿';
            } else if (type.name === 'super_jackpot') {
              icon = 'ğŸ†';
              displayName = 'è¶…çº§å¤§å¥–';
            } else if (type.name === 'special_combo') {
              icon = 'ğŸ’';
              displayName = 'ç‰¹æ®Šç»„åˆ';
            } else if (type.name === 'punishment') {
              icon = 'âš¡';
              displayName = 'å¾‹å¸ˆå‡½';
            }
            
            return `
              <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-semibold text-slate-900">${icon} ${displayName}</span>
                  <span class="text-sm font-bold text-slate-700">${type.count} æ¬¡ (${percentage}%)</span>
                </div>
                <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all" style="width: ${barWidth}%"></div>
                </div>
                <div class="flex items-center justify-between text-xs text-slate-600">
                  <span>æ€»${type.totalWin >= 0 ? 'èµ¢å¾—' : 'æ‰£é™¤'}: $${(Math.abs(type.totalWin) / 500000).toFixed(2)}</span>
                  <span>å¹³å‡: $${(Math.abs(type.avgWin) / 500000).toFixed(2)}</span>
                  <span class="font-semibold ${type.rtp >= 100 ? 'text-green-600' : 'text-red-600'}">RTP: ${type.rtp.toFixed(1)}%</span>
                </div>
              </div>
            `;
          }).join('');
        document.getElementById('winTypesDistribution').innerHTML = winTypesHtml;

        // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡
        const dailyStatsHtml = Object.entries(dailyStats)
          .sort((a, b) => b[0].localeCompare(a[0])) // æŒ‰æ—¥æœŸå€’åºæ’åº
          .map(([date, stats]) => {
            const profitColor = stats.profit >= 0 ? 'text-green-600' : 'text-red-600';
            // ğŸ”¥ è®¡ç®—æ¯æ—¥RTP
            const dailyRTP = stats.bet > 0 ? ((stats.win / stats.bet) * 100).toFixed(2) : '0.00';
            const rtpColor = parseFloat(dailyRTP) >= 100 ? 'text-green-600' : 
                           parseFloat(dailyRTP) >= 90 ? 'text-yellow-600' : 
                           parseFloat(dailyRTP) >= 80 ? 'text-orange-600' : 'text-red-600';
            
            return `
              <tr>
                <td class="px-4 py-3 text-sm text-slate-900">${date}</td>
                <td class="px-4 py-3 text-sm text-slate-900 text-right">${stats.count}</td>
                <td class="px-4 py-3 text-sm text-red-600 text-right">$${(stats.bet / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-green-600 text-right">$${(stats.win / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${profitColor} text-right font-semibold">${stats.profit >= 0 ? '+' : ''}$${(stats.profit / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${rtpColor} text-right font-bold">${dailyRTP}%</td>
              </tr>
            `;
          }).join('');
        document.getElementById('dailyStatsBody').innerHTML = dailyStatsHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">æš‚æ— æ•°æ®</td></tr>';

        showMessage('åˆ†ææ•°æ®å·²æ›´æ–°', 'success');
      } catch (error) {
        console.error('åŠ è½½æŠ½å¥–åˆ†æå¤±è´¥:', error);
        showMessage('åŠ è½½åˆ†ææ•°æ®å¤±è´¥', 'error');
      }
    }

    // ç›ˆåˆ©æ’è¡Œæ¦œ
    async function loadProfitLeaderboard() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('åŠ è½½ç›ˆåˆ©æ’è¡Œæ¦œå¤±è´¥', 'error');
          return;
        }

        const userStats = data.data.userStats;

        // ä¸­å¥–ç±»å‹æ ‡ç­¾
        const winTypeLabels = {
          'super_jackpot': 'ğŸ† è¶…çº§å¤§å¥–',
          'special_combo': 'ğŸ’ ç‰¹æ®Šç»„åˆ',
          'quad': 'ğŸ° å››è¿',
          'triple': 'âœ¨ ä¸‰è¿',
          'double': 'ğŸ åŒè¿',
          'man_only': 'ğŸ¯ Manç»„åˆ',
          'man_quad': 'ğŸ° ManÃ—4',
          'symmetric': 'ğŸ”„ å¯¹ç§°ABBA',
          'consecutive': 'â­ è¿ç»­',
          'combination': 'ğŸ ç»„åˆ',
          'any': 'ğŸ² ä»»æ„',
          'double_pair': 'ğŸ­ ä¸¤å¯¹',
          'punishment': 'âš¡ å¾‹å¸ˆå‡½',
          'none': 'âŒ æœªä¸­å¥–'
        };

        // ç›ˆåˆ©æ¦œï¼šåªæ˜¾ç¤ºç›ˆåˆ©çš„ç”¨æˆ·ï¼ˆprofit >= 0ï¼‰ï¼ŒæŒ‰ç›ˆäºé™åº
        const profitLeaderboard = [...userStats]
          .filter(user => (user.total_win - user.total_bet) >= 0)
          .sort((a, b) => {
            const profitA = a.total_win - a.total_bet;
            const profitB = b.total_win - b.total_bet;
            return profitB - profitA; // é™åºï¼Œèµšæœ€å¤šåœ¨å‰
          })
          .slice(0, 20); // åªå–å‰20å

        // æ¸²æŸ“ç›ˆåˆ©æ’è¡Œæ¦œ
        const leaderboardHtml = profitLeaderboard.map((user, index) => {
          const rank = index + 1;
          let rankBadge = `<span class="text-slate-600 font-semibold">#${rank}</span>`;
          let rowClass = '';
          
          if (rank === 1) {
            rankBadge = '<span class="text-3xl">ğŸ¥‡</span>';
            rowClass = 'bg-gradient-to-r from-yellow-50 to-amber-50';
          } else if (rank === 2) {
            rankBadge = '<span class="text-3xl">ğŸ¥ˆ</span>';
            rowClass = 'bg-gradient-to-r from-gray-50 to-slate-50';
          } else if (rank === 3) {
            rankBadge = '<span class="text-3xl">ğŸ¥‰</span>';
            rowClass = 'bg-gradient-to-r from-orange-50 to-amber-50';
          }

          const netProfit = user.total_win - user.total_bet;
          const profitColor = netProfit >= 0 ? 'text-green-600' : 'text-red-600';

          return `
            <tr class="${rowClass}">
              <td class="px-4 py-4 text-center">${rankBadge}</td>
              <td class="px-4 py-4">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-slate-900">${user.username || user.linux_do_id}</span>
                  ${user.biggest_win_type ? `<span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full">${winTypeLabels[user.biggest_win_type] || ''}</span>` : ''}
                </div>
              </td>
              <td class="px-4 py-4 text-center text-slate-900">${user.total_spins}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">$${(user.total_bet / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-green-600 font-bold text-lg">$${(user.total_win / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right ${profitColor} font-semibold">${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-orange-600 font-medium">$${(user.biggest_win / 500000).toFixed(2)}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('profitLeaderboardTableBody').innerHTML = leaderboardHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">æš‚æ— ç›ˆåˆ©ç”¨æˆ·</td></tr>';

        showMessage('ç›ˆåˆ©æ’è¡Œæ¦œå·²æ›´æ–°', 'success');
      } catch (error) {
        console.error('åŠ è½½ç›ˆåˆ©æ’è¡Œæ¦œå¤±è´¥:', error);
        showMessage('åŠ è½½ç›ˆåˆ©æ’è¡Œæ¦œå¤±è´¥', 'error');
      }
    }

    // äºæŸæ’è¡Œæ¦œ
    async function loadLossLeaderboard() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('åŠ è½½äºæŸæ’è¡Œæ¦œå¤±è´¥', 'error');
          return;
        }

        // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„äºæŸæ¦œæ•°æ®
        const lossLeaderboard = data.data.lossStats || [];

        // æ¸²æŸ“äºæŸæ’è¡Œæ¦œ
        const lossLeaderboardHtml = lossLeaderboard.slice(0, 20).map((user, index) => {
          const rank = index + 1;
          let rankBadge = `<span class="text-red-600 font-bold">#${rank}</span>`;
          let rowClass = 'bg-red-50';
          
          if (rank === 1) {
            rankBadge = '<span class="text-4xl">ğŸ˜±</span>';
            rowClass = 'bg-gradient-to-r from-red-100 to-rose-100 border-l-4 border-red-500';
          } else if (rank === 2) {
            rankBadge = '<span class="text-4xl">ğŸ˜­</span>';
            rowClass = 'bg-gradient-to-r from-red-50 to-rose-50 border-l-4 border-red-400';
          } else if (rank === 3) {
            rankBadge = '<span class="text-4xl">ğŸ˜¢</span>';
            rowClass = 'bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-red-300';
          }

          const netProfit = user.total_win - user.total_bet;
          const lossRate = user.total_bet > 0 ? ((Math.abs(netProfit) / user.total_bet) * 100).toFixed(1) : '0.0';

          return `
            <tr class="${rowClass}">
              <td class="px-4 py-4 text-center">${rankBadge}</td>
              <td class="px-4 py-4">
                <span class="font-semibold text-slate-900">${user.username || user.linux_do_id}</span>
              </td>
              <td class="px-4 py-4 text-center text-slate-900">${user.total_spins}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">$${(user.total_bet / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-slate-600 font-medium">$${(user.total_win / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-red-700 font-bold text-lg">${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">${lossRate}%</td>
            </tr>
          `;
        }).join('');

        document.getElementById('lossLeaderboardTableBody').innerHTML = lossLeaderboardHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-green-600 font-semibold">ğŸ‰ æš‚æ— äºæŸç”¨æˆ·ï¼Œæ‰€æœ‰ç©å®¶éƒ½åœ¨ç›ˆåˆ©ï¼</td></tr>';

        showMessage('äºæŸæ’è¡Œæ¦œå·²æ›´æ–°', 'success');
      } catch (error) {
        console.error('åŠ è½½äºæŸæ’è¡Œæ¦œå¤±è´¥:', error);
        showMessage('åŠ è½½äºæŸæ’è¡Œæ¦œå¤±è´¥', 'error');
      }
    }

    // ========== å‘æ”¾å…è´¹æ¬¡æ•°åŠŸèƒ½ ==========

    // ç”¨æˆ·æœç´¢ï¼ˆé˜²æŠ–ï¼‰
    let searchTimeout = null;
    function searchUserDebounced() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => searchUser(), 300);
    }

    // æœç´¢ç”¨æˆ·
    async function searchUser() {
      const keyword = document.getElementById('singleUserIdentifier').value.trim();
      const resultsDiv = document.getElementById('singleUserSearchResults');
      
      if (keyword.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
      }

      try {
        const res = await fetch(`/api/admin/search-users?keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          resultsDiv.innerHTML = data.data.map(user => {
            const displayName = user.linux_do_username || user.username;
            const isBanned = user.is_banned === 1;
            return `
              <div onclick="selectUser('${user.linux_do_username || user.username}', '${user.linux_do_id}')" 
                   class="px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 ${isBanned ? 'opacity-50' : ''}">
                <div class="font-semibold text-slate-900">${displayName}</div>
                <div class="text-xs text-slate-500">ID: ${user.linux_do_id} ${isBanned ? '(å·²å°ç¦)' : ''}</div>
              </div>
            `;
          }).join('');
          resultsDiv.classList.remove('hidden');
        } else {
          resultsDiv.classList.add('hidden');
        }
      } catch (error) {
        console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
      }
    }

    // é€‰æ‹©æœç´¢ç»“æœä¸­çš„ç”¨æˆ·
    function selectUser(username, linuxDoId) {
      document.getElementById('singleUserIdentifier').value = username;
      document.getElementById('singleUserSearchResults').classList.add('hidden');
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
    document.addEventListener('click', (e) => {
      const searchInput = document.getElementById('singleUserIdentifier');
      const resultsDiv = document.getElementById('singleUserSearchResults');
      if (searchInput && resultsDiv && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('hidden');
      }
    });

    // æ˜¾ç¤ºå‘æ”¾å…è´¹æ¬¡æ•°çš„æ¨¡æ€æ¡†
    function showGrantFreeSpinsModal(linuxDoId, username) {
      document.getElementById('modalLinuxDoId').value = linuxDoId;
      document.getElementById('modalUsername').value = username;
      document.getElementById('modalSpins').value = 5;
      document.getElementById('modalReason').value = '';
      document.getElementById('grantFreeSpinsModal').classList.remove('hidden');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeGrantFreeSpinsModal() {
      document.getElementById('grantFreeSpinsModal').classList.add('hidden');
    }

    // ä»æ¨¡æ€æ¡†ç¡®è®¤å‘æ”¾
    async function confirmGrantFreeSpin() {
      const linuxDoId = document.getElementById('modalLinuxDoId').value;
      const spins = parseInt(document.getElementById('modalSpins').value);
      const reason = document.getElementById('modalReason').value;

      if (!spins || spins <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…è´¹æ¬¡æ•°', 'error');
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier: linuxDoId, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(data.message || 'å‘æ”¾æˆåŠŸ', 'success');
          closeGrantFreeSpinsModal();
          // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
          if (usersCurrentPage) {
            loadUsersList(usersCurrentPage);
          }
        } else {
          showToast(data.message || 'å‘æ”¾å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('å‘æ”¾å…è´¹æ¬¡æ•°å¤±è´¥:', error);
        showToast('å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // ========== å‘æ”¾å…¥åœºåˆ¸åŠŸèƒ½ ==========
    
    // æ˜¾ç¤ºå‘æ”¾å…¥åœºåˆ¸å¼¹çª—
    function showGrantTicketsModal(linuxDoId, username) {
      document.getElementById('ticketModalLinuxDoId').value = linuxDoId;
      document.getElementById('ticketModalUsername').value = username;
      document.getElementById('ticketModalCount').value = 1;
      document.getElementById('ticketModalReason').value = '';
      document.getElementById('grantTicketsModal').classList.remove('hidden');
    }
    
    // å…³é—­å¼¹çª—
    function closeGrantTicketsModal() {
      document.getElementById('grantTicketsModal').classList.add('hidden');
    }
    
    // ç¡®è®¤å‘æ”¾å…¥åœºåˆ¸
    async function confirmGrantTickets() {
      const linuxDoId = document.getElementById('ticketModalLinuxDoId').value;
      const username = document.getElementById('ticketModalUsername').value;
      const count = parseInt(document.getElementById('ticketModalCount').value);
      const reason = document.getElementById('ticketModalReason').value || 'ç®¡ç†å‘˜æ‰‹åŠ¨å‘æ”¾';
      
      if (!count || count <= 0 || count > 10) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…¥åœºåˆ¸æ•°é‡ï¼ˆ1-10ï¼‰', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/grant-tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            linux_do_id: linuxDoId,
            count: count,
            reason: reason
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… å·²ä¸ºç”¨æˆ· "${username}" å‘æ”¾ ${count} å¼ å…¥åœºåˆ¸`, 'success');
          closeGrantTicketsModal();
          
          // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
          if (usersCurrentPage) {
            loadUsersList(usersCurrentPage);
          }
        } else {
          showToast(data.message || 'å‘æ”¾å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('å‘æ”¾å…¥åœºåˆ¸å¤±è´¥:', error);
        showToast('å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // ========== å‘æ”¾è‡³å°Šä»¤ç‰ŒåŠŸèƒ½ ==========
    
    // æ˜¾ç¤ºå‘æ”¾è‡³å°Šä»¤ç‰Œå¼¹çª—
    function showGrantSupremeTokensModal(linuxDoId, username) {
      document.getElementById('supremeTokenModalLinuxDoId').value = linuxDoId;
      document.getElementById('supremeTokenModalUsername').value = username;
      document.getElementById('supremeTokenModalTokens').value = 0;
      document.getElementById('supremeTokenModalFragments').value = 0;
      document.getElementById('supremeTokenModalReason').value = '';
      document.getElementById('grantSupremeTokensModal').classList.remove('hidden');
    }
    
    // å…³é—­å¼¹çª—
    function closeGrantSupremeTokensModal() {
      document.getElementById('grantSupremeTokensModal').classList.add('hidden');
    }
    
    // ç¡®è®¤å‘æ”¾è‡³å°Šä»¤ç‰Œ
    async function confirmGrantSupremeTokens() {
      const linuxDoId = document.getElementById('supremeTokenModalLinuxDoId').value;
      const username = document.getElementById('supremeTokenModalUsername').value;
      const tokens = parseInt(document.getElementById('supremeTokenModalTokens').value) || 0;
      const fragments = parseInt(document.getElementById('supremeTokenModalFragments').value) || 0;
      const reason = document.getElementById('supremeTokenModalReason').value || 'ç®¡ç†å‘˜æ‰‹åŠ¨å‘æ”¾';
      
      if (tokens === 0 && fragments === 0) {
        showToast('è¯·è‡³å°‘è¾“å…¥ä»¤ç‰Œæˆ–ç¢ç‰‡æ•°é‡', 'error');
        return;
      }
      
      if (tokens > 10) {
        showToast('ä»¤ç‰Œæ•°é‡ä¸èƒ½è¶…è¿‡10', 'error');
        return;
      }
      
      if (fragments > 100) {
        showToast('ç¢ç‰‡æ•°é‡ä¸èƒ½è¶…è¿‡100', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/grant-supreme-tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            linux_do_id: linuxDoId,
            tokens: tokens,
            fragments: fragments,
            reason: reason
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… ${data.message}`, 'success');
          closeGrantSupremeTokensModal();
          
          // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
          if (usersCurrentPage) {
            loadUsersList(usersCurrentPage);
          }
        } else {
          showToast(data.message || 'å‘æ”¾å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('å‘æ”¾è‡³å°Šä»¤ç‰Œå¤±è´¥:', error);
        showToast('å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // å•ä¸ªç”¨æˆ·å‘æ”¾
    async function grantSingleFreeSpin() {
      const identifier = document.getElementById('singleUserIdentifier').value.trim();
      const spins = parseInt(document.getElementById('singleSpins').value);
      const reason = document.getElementById('singleReason').value.trim();

      if (!identifier) {
        showToast('è¯·è¾“å…¥ç”¨æˆ·æ ‡è¯†ï¼ˆç”¨æˆ·åæˆ–IDï¼‰', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…è´¹æ¬¡æ•°', 'error');
        return;
      }

      if (spins > 100) {
        showToast('å•æ¬¡å‘æ”¾æ¬¡æ•°ä¸èƒ½è¶…è¿‡100æ¬¡', 'error');
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… ${data.message}`, 'success');
          clearSingleForm();
        } else {
          showToast(`âŒ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('å‘æ”¾å…è´¹æ¬¡æ•°å¤±è´¥:', error);
        showToast('å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // æ‰¹é‡å‘æ”¾
    async function grantBatchFreeSpin() {
      const idsText = document.getElementById('batchUserIdentifiers').value.trim();
      const spins = parseInt(document.getElementById('batchSpins').value);
      const reason = document.getElementById('batchReason').value.trim();

      if (!idsText) {
        showToast('è¯·è¾“å…¥ç”¨æˆ·åˆ—è¡¨', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…è´¹æ¬¡æ•°', 'error');
        return;
      }

      if (spins > 100) {
        showToast('å•æ¬¡å‘æ”¾æ¬¡æ•°ä¸èƒ½è¶…è¿‡100æ¬¡', 'error');
        return;
      }

      // è§£æç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒç”¨æˆ·åå’ŒIDï¼‰
      const identifiers = idsText.split('\n')
        .map(id => id.trim())
        .filter(id => id.length > 0);

      if (identifiers.length === 0) {
        showToast('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªç”¨æˆ·', 'error');
        return;
      }

      if (identifiers.length > 5000) {
        showToast('å•æ¬¡æ‰¹é‡å‘æ”¾ç”¨æˆ·ä¸èƒ½è¶…è¿‡5000ä¸ª', 'error');
        return;
      }

      if (!confirm(`ç¡®è®¤ä¸º ${identifiers.length} ä¸ªç”¨æˆ·å„å‘æ”¾ ${spins} æ¬¡å…è´¹æŠ½å¥–æœºä¼šå—ï¼Ÿ\n\næ”¯æŒç”¨æˆ·åå’ŒLinux Do IDæ··åˆè¾“å…¥`)) {
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins-batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifiers, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          const results = data.data;
          showToast(`âœ… ${data.message}`, 'success');
          
          // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
          if (results.failed > 0 || results.skipped > 0) {
            console.log(`æ‰¹é‡å‘æ”¾ç»“æœç»Ÿè®¡:\næ€»æ•°: ${results.total}\næˆåŠŸ: ${results.success}\nå¤±è´¥: ${results.failed}\nè·³è¿‡: ${results.skipped}`);
            
            const failedDetails = results.details
              .filter(d => !d.success)
              .slice(0, 20)
              .map(d => `${d.identifier}: ${d.message}`)
              .join('\n');
            
            if (failedDetails) {
              console.log('å¤±è´¥/è·³è¿‡è¯¦æƒ…ï¼ˆå‰20æ¡ï¼‰:\n' + failedDetails);
            }
          }
          
          clearBatchForm();
        } else {
          showToast(`âŒ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('æ‰¹é‡å‘æ”¾å…è´¹æ¬¡æ•°å¤±è´¥:', error);
        showToast('æ‰¹é‡å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // å…¨å‘˜å‘æ”¾
    async function grantAllFreeSpin() {
      const spins = parseInt(document.getElementById('allSpins').value);
      const reason = document.getElementById('allReason').value.trim();

      if (!reason) {
        showToast('å…¨å‘˜å‘æ”¾å¿…é¡»å¡«å†™åŸå› ', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…è´¹æ¬¡æ•°', 'error');
        return;
      }

      if (spins > 100) {
        showToast('å•æ¬¡å‘æ”¾æ¬¡æ•°ä¸èƒ½è¶…è¿‡100æ¬¡', 'error');
        return;
      }

      if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®è®¤ç»™æ‰€æœ‰ç”¨æˆ·ï¼ˆçº¦2000+ï¼‰å„å‘æ”¾ ${spins} æ¬¡å…è´¹æŠ½å¥–æœºä¼šå—ï¼Ÿ\n\nåŸå› ï¼š${reason}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ç¡®è®¤ï¼`)) {
        return;
      }

      // äºŒæ¬¡ç¡®è®¤
      if (!confirm(`æœ€åç¡®è®¤ï¼šçœŸçš„è¦ç»™æ‰€æœ‰ç”¨æˆ·å‘æ”¾ ${spins} æ¬¡å—ï¼Ÿ\n\nè¿™å°†èŠ±è´¹ä¸€äº›æ—¶é—´æ¥å¤„ç†ã€‚`)) {
        return;
      }

      try {
        showToast('â³ æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...', 'success');
        
        const res = await fetch('/api/admin/grant-free-spins-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          const results = data.data;
          showToast(`âœ… ${data.message}\næ€»æ•°: ${results.total}, æˆåŠŸ: ${results.success}, å¤±è´¥: ${results.failed}`, 'success');
          clearAllForm();
        } else {
          showToast(`âŒ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('å…¨å‘˜å‘æ”¾å¤±è´¥:', error);
        showToast('å…¨å‘˜å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // æŸ¥è¯¢ç”¨æˆ·å…è´¹æ¬¡æ•°
    async function queryUserFreeSpins() {
      const identifier = document.getElementById('queryUserIdentifier').value.trim();

      if (!identifier) {
        showToast('è¯·è¾“å…¥ç”¨æˆ·æ ‡è¯†ï¼ˆç”¨æˆ·åæˆ–IDï¼‰', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/admin/users/${encodeURIComponent(identifier)}/free-spins`);
        const data = await res.json();
        
        if (data.success) {
          const info = data.data;
          
          const displayName = info.linux_do_username || info.username;
          document.getElementById('queryUsername').textContent = displayName || '--';
          document.getElementById('queryFreeSpins').textContent = info.free_spins;

          const bannedUntil = info.banned_until;
          if (bannedUntil > 0 && bannedUntil > Date.now()) {
            const bannedDate = new Date(bannedUntil);
            document.getElementById('queryBannedUntil').textContent = bannedDate.toLocaleString('zh-CN', { hour12: false });
            document.getElementById('queryBannedUntil').className = 'text-lg font-bold text-red-600 mt-1';
          } else {
            document.getElementById('queryBannedUntil').textContent = 'æ— é™åˆ¶';
            document.getElementById('queryBannedUntil').className = 'text-lg font-bold text-green-600 mt-1';
          }

          const updatedAt = info.updated_at;
          if (updatedAt > 0) {
            const updatedDate = new Date(updatedAt);
            document.getElementById('queryUpdatedAt').textContent = updatedDate.toLocaleString('zh-CN', { hour12: false });
          } else {
            document.getElementById('queryUpdatedAt').textContent = 'ä»æœªæ›´æ–°';
          }

          document.getElementById('queryResult').classList.remove('hidden');
          showToast('æŸ¥è¯¢æˆåŠŸ', 'success');
        } else {
          showToast(data.message || 'æŸ¥è¯¢å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æŸ¥è¯¢ç”¨æˆ·å…è´¹æ¬¡æ•°å¤±è´¥:', error);
        showToast('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // æ¸…ç©ºå•ä¸ªç”¨æˆ·å‘æ”¾è¡¨å•
    function clearSingleForm() {
      document.getElementById('singleUserIdentifier').value = '';
      document.getElementById('singleSpins').value = 5;
      document.getElementById('singleReason').value = '';
      document.getElementById('singleUserSearchResults').classList.add('hidden');
    }

    // æ¸…ç©ºæ‰¹é‡å‘æ”¾è¡¨å•
    function clearBatchForm() {
      document.getElementById('batchUserIdentifiers').value = '';
      document.getElementById('batchSpins').value = 5;
      document.getElementById('batchReason').value = '';
    }

    // æ¸…ç©ºå…¨å‘˜å‘æ”¾è¡¨å•
    function clearAllForm() {
      document.getElementById('allSpins').value = 5;
      document.getElementById('allReason').value = '';
    }

    // ========== å¾…å‘æ”¾å¥–é‡‘ç®¡ç†åŠŸèƒ½ ==========

    // åŠ è½½å¾…å‘æ”¾å¥–é‡‘åˆ—è¡¨
    async function loadPendingRewards(silent = false) {
      try {
        const res = await fetch('/api/admin/pending-rewards');
        const data = await res.json();

        if (!data.success) {
          if (!silent) showToast('åŠ è½½å¾…å‘æ”¾å¥–é‡‘å¤±è´¥', 'error');
          return;
        }

        const rewards = data.data;
        const stats = data.stats;

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        document.getElementById('pendingTotal').textContent = stats.byStatus.pending + stats.byStatus.processing + stats.byStatus.failed;
        document.getElementById('pendingTotalAmount').textContent = '$' + stats.pendingAmountCny;
        document.getElementById('pendingCount').textContent = stats.byStatus.pending;
        document.getElementById('failedCount').textContent = stats.byStatus.failed;
        
        // æ›´æ–°æˆåŠŸå‘æ”¾ç»Ÿè®¡
        document.getElementById('successCount').textContent = stats.byStatus.success || 0;
        document.getElementById('successAmount').textContent = '$' + (stats.successAmountCny || '0.00');

        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('pendingRewardsTableBody');
        
        if (rewards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-green-600 font-semibold">ğŸ‰ æ²¡æœ‰å¾…å‘æ”¾çš„å¥–é‡‘è®°å½•</td></tr>';
          return;
        }

        tbody.innerHTML = rewards.map(reward => {
          // çŠ¶æ€æ ‡ç­¾
          let statusBadge = '';
          if (reward.status === 'pending') {
            statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">â³ å¾…å¤„ç†</span>';
          } else if (reward.status === 'failed') {
            statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">âŒ å¤±è´¥</span>';
          } else if (reward.status === 'processing') {
            statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">âš™ï¸ å¤„ç†ä¸­</span>';
          } else if (reward.status === 'success') {
            statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… æˆåŠŸ</span>';
          }

          // æ“ä½œæŒ‰é’®
          let actionButtons = '';
          if (reward.status === 'failed') {
            actionButtons = `
              <div class="flex gap-1 justify-center">
                <button onclick="retryPendingReward(${reward.id}, '${reward.username}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold" title="é‡è¯•">ğŸ”„</button>
                <button onclick="deletePendingReward(${reward.id}, '${reward.username}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </div>
            `;
          } else if (reward.status === 'pending' || reward.status === 'processing') {
            actionButtons = `
              <span class="text-slate-400 text-xs">ç­‰å¾…å¤„ç†</span>
            `;
          } else if (reward.status === 'success') {
            actionButtons = `
              <span class="text-green-600 text-xs font-semibold">å·²å®Œæˆ</span>
            `;
          }

          // é”™è¯¯ä¿¡æ¯æç¤º
          const errorInfo = reward.error_message 
            ? `<div class="text-xs text-red-600 mt-1" title="${reward.error_message}">âš ï¸ ${reward.error_message.substring(0, 30)}...</div>`
            : '';

          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 font-mono text-slate-600">#${reward.id}</td>
              <td class="px-4 py-3">
                <div class="font-semibold text-slate-900">${reward.username}</div>
                <div class="text-xs text-slate-500">${reward.linux_do_id}</div>
              </td>
              <td class="px-4 py-3 text-right">
                <div class="font-bold text-green-600">$${reward.reward_amount_cny}</div>
              </td>
              <td class="px-4 py-3">
                <div class="text-slate-700">${reward.reason}</div>
                ${errorInfo}
              </td>
              <td class="px-4 py-3 text-center">${statusBadge}</td>
              <td class="px-4 py-3 text-center">
                <span class="font-semibold ${reward.retry_count >= 5 ? 'text-red-600' : 'text-slate-700'}">${reward.retry_count}/10</span>
              </td>
              <td class="px-4 py-3 text-sm text-slate-600">${reward.created_date}</td>
              <td class="px-4 py-3 text-center">${actionButtons}</td>
            </tr>
          `;
        }).join('');

        if (!silent) showToast('å¾…å‘æ”¾å¥–é‡‘åˆ—è¡¨å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('åŠ è½½å¾…å‘æ”¾å¥–é‡‘å¤±è´¥:', error);
        if (!silent) showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // åˆ·æ–°å¾…å‘æ”¾å¥–é‡‘åˆ—è¡¨
    async function refreshPendingRewards() {
      const icon = document.getElementById('pendingRewardsRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadPendingRewards();
      setTimeout(() => icon.classList.remove('refresh-spin'), 600);
    }

    // ä¸€é”®å‘æ”¾å…¨éƒ¨å¾…å‘æ”¾å¥–é‡‘ï¼ˆä¼˜åŒ–ç‰ˆï¼šå¼‚æ­¥å¤„ç†ï¼‰
    async function processAllPendingRewards() {
      const total = document.getElementById('pendingTotal').textContent;
      const totalAmount = document.getElementById('pendingTotalAmount').textContent;
      
      if (total === '0') {
        showToast('æ²¡æœ‰å¾…å‘æ”¾çš„å¥–é‡‘è®°å½•', 'error');
        return;
      }

      if (!confirm(`ç¡®è®¤ç«‹å³å‘æ”¾å…¨éƒ¨ ${total} æ¡å¾…å‘æ”¾å¥–é‡‘ï¼ˆæ€»é¢ ${totalAmount}ï¼‰å—ï¼Ÿ\n\nç³»ç»Ÿå°†åœ¨åå°å¼‚æ­¥å¤„ç†ï¼Œå¤„ç†å®Œæˆåè‡ªåŠ¨æ›´æ–°åˆ—è¡¨ã€‚`)) {
        return;
      }

      const btn = document.getElementById('processAllBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">âš™ï¸</span> å¯åŠ¨ä¸­...';

      try {
        const res = await fetch('/api/admin/pending-rewards/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(`ğŸš€ ${data.message}`, 'success');

          // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œæ˜¾ç¤º"å¤„ç†ä¸­"çŠ¶æ€ï¼ˆé™é»˜æ¨¡å¼ï¼‰
          await loadPendingRewards(true);

          // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼Œç›‘æ§å¤„ç†è¿›åº¦
          startAutoRefresh();
        } else {
          showToast(`âŒ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('ä¸€é”®å‘æ”¾å¤±è´¥:', error);
        showToast('å‘æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // è‡ªåŠ¨åˆ·æ–°å¾…å‘æ”¾åˆ—è¡¨ï¼ˆç›‘æ§å¤„ç†è¿›åº¦ï¼‰
    let autoRefreshTimer = null;
    let autoRefreshCount = 0;
    const MAX_AUTO_REFRESH = 30; // æœ€å¤šè‡ªåŠ¨åˆ·æ–°30æ¬¡ï¼ˆçº¦1åˆ†é’Ÿï¼‰

    function startAutoRefresh() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
      
      autoRefreshCount = 0;
      
      // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡
      autoRefreshTimer = setInterval(async () => {
        autoRefreshCount++;

        // åˆ·æ–°åˆ—è¡¨ï¼ˆé™é»˜æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºæç¤ºï¼‰
        await loadPendingRewards(true);

        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¾…å¤„ç†çš„è®°å½•
        const pendingCount = parseInt(document.getElementById('pendingCount').textContent) || 0;
        const processingCount = parseInt(document.getElementById('pendingTotal').textContent) || 0;
        
        // å¦‚æœæ²¡æœ‰å¾…å¤„ç†çš„è®°å½•ï¼Œæˆ–è¾¾åˆ°æœ€å¤§åˆ·æ–°æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
        if (processingCount === 0 || autoRefreshCount >= MAX_AUTO_REFRESH) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
          
          if (processingCount === 0) {
            showToast('âœ… æ‰€æœ‰å¾…å‘æ”¾å¥–é‡‘å¤„ç†å®Œæˆ', 'success');
          }
        }
      }, 2000);
    }

    // é‡è¯•å•æ¡å¤±è´¥çš„å¥–é‡‘
    async function retryPendingReward(id, username) {
      if (!confirm(`ç¡®è®¤é‡ç½®å¥–é‡‘å‘æ”¾çŠ¶æ€å—ï¼Ÿ\n\nç”¨æˆ·: ${username}\nè®°å½• ID: #${id}\n\né‡ç½®åï¼Œç³»ç»Ÿå°†åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¤„ç†æ—¶é‡æ–°å°è¯•å‘æ”¾ã€‚`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/pending-rewards/${id}/retry`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast('å·²é‡ç½®ä¸ºå¾…å‘æ”¾çŠ¶æ€', 'success');
          await loadPendingRewards();
        } else {
          showToast(data.message || 'é‡ç½®å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('é‡è¯•å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // åˆ é™¤å¾…å‘æ”¾å¥–é‡‘è®°å½•
    async function deletePendingReward(id, username) {
      if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®è®¤åˆ é™¤æ­¤è®°å½•å—ï¼Ÿ\n\nç”¨æˆ·: ${username}\nè®°å½• ID: #${id}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼åˆ é™¤åè¯¥å¥–é‡‘å°†æ— æ³•å‘æ”¾ã€‚`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/pending-rewards/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast('è®°å½•å·²åˆ é™¤', 'success');
          await loadPendingRewards();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    window.onload = async () => {
      try {
        const res = await fetch('/api/admin/config');
        if (res.ok) {
          // éªŒè¯æˆåŠŸï¼Œæ˜¾ç¤ºç®¡ç†ç•Œé¢
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          await loadAdminData();
        } else {
          // éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
        }
      } catch (e) {
        // è¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
        console.log('éœ€è¦ç™»å½•');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
      }
    };

    // ========== é«˜çº§åœºç®¡ç†åŠŸèƒ½ ==========

    // é¢„è§ˆé«˜çº§åœºæƒé‡é…ç½®
    async function previewAdvancedWeightConfig() {
      const configId = document.getElementById('advancedSlotWeightConfigId').value;
      if (!configId) return;
      
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.find(c => c.id == configId);
          if (config) {
            document.getElementById('adv_preview_weight_m').textContent = config.weight_m;
            document.getElementById('adv_preview_weight_t').textContent = config.weight_t;
            document.getElementById('adv_preview_weight_n').textContent = config.weight_n;
            document.getElementById('adv_preview_weight_j').textContent = config.weight_j;
            document.getElementById('adv_preview_weight_lq').textContent = config.weight_lq;
            document.getElementById('adv_preview_weight_bj').textContent = config.weight_bj;
            document.getElementById('adv_preview_weight_zft').textContent = config.weight_zft;
            document.getElementById('adv_preview_weight_bdk').textContent = config.weight_bdk;
            document.getElementById('adv_preview_weight_lsh').textContent = config.weight_lsh;
            document.getElementById('adv_preview_weight_man').textContent = config.weight_man || 30;
            document.getElementById('advancedWeightPreview').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('é¢„è§ˆé«˜çº§åœºæƒé‡é…ç½®å¤±è´¥:', error);
      }
    }
    
    // ğŸ”¥ æ¦‚ç‡è®¡ç®—ç»“æœç¼“å­˜ï¼ˆå…¨å±€å˜é‡ï¼Œéœ€è¦åœ¨æ‰€æœ‰å‡½æ•°ä¹‹å‰å®šä¹‰ï¼‰
    const probabilityCache = new Map();
    
    // ç”Ÿæˆç¼“å­˜é”®
    function getCacheKey(weightConfigId, rewardSchemeId, method) {
      return `${weightConfigId}-${rewardSchemeId}-${method}`;
    }
    
    // ğŸ”„ æ›´æ–°è¿›åº¦æ¡
    function updateProgressBar(displayDiv, percent, method) {
      displayDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="w-full max-w-md mx-auto mb-4">
            <div class="relative h-6 bg-slate-200 rounded-full overflow-hidden">
              <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-300 ease-out flex items-center justify-center" style="width: ${percent}%">
                <span class="text-xs text-white font-bold">${Math.round(percent)}%</span>
              </div>
            </div>
          </div>
          <div class="animate-spin inline-block w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mb-3"></div>
          <p class="text-sm text-purple-700 font-semibold">ğŸ”„ è®¡ç®—ä¸­...</p>
          <p class="text-xs text-slate-500 mt-1">${method === 'monte-carlo' ? `è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ 1,000,000 æ¬¡ (${Math.round(percent)}%)` : 'å¿«é€Ÿä¼°ç®—'}</p>
          ${percent > 0 ? `<p class="text-xs text-purple-600 mt-2">â±ï¸ é¢„è®¡å‰©ä½™æ—¶é—´: ${Math.max(0, Math.round((100 - percent) / 100 * 3))}ç§’</p>` : ''}
        </div>
      `;
    }
    
    // æ¸²æŸ“æ¦‚ç‡æ˜¾ç¤ºï¼ˆéœ€è¦åœ¨æ‰€æœ‰è°ƒç”¨å®ƒçš„å‡½æ•°ä¹‹å‰å®šä¹‰ï¼‰
    function renderProbabilityDisplay(displayId, result) {
      const displayDiv = document.getElementById(displayId);
      const { rules, punishments, noWin, rtp, houseEdge, totalExpectedValue, method, simulationCount, calculationTime } = result;
      
      let html = `
        <div class="bg-white rounded-lg p-4 border border-purple-200">
          <!-- ä¸­å¥–è§„åˆ™æ¦‚ç‡ -->
          <div class="mb-4">
            <h5 class="text-sm font-bold text-green-700 mb-3">ğŸ é…ç½®è§„åˆ™æ¦‚ç‡ (ä¸å«åŠ¨æ€ç»„åˆ)</h5>
            <div class="grid grid-cols-4 gap-2">
              ${rules.filter(rule => 
                !rule.ruleName.includes('+') && 
                !rule.ruleName.includes('manÃ—') &&
                rule.ruleName !== 'å¯¹ç§°ABBA'
              ).map(rule => `
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                  <div class="text-xs font-semibold text-slate-900 mb-1 truncate" title="${rule.ruleName}">${rule.ruleName}</div>
                  <div class="text-lg font-bold text-green-600">${rule.multiplier}x</div>
                  <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${rule.probability.toFixed(2)}%</div>
                  <div class="text-xs ${rule.expectedValue >= 0 ? 'text-green-600' : 'text-red-600'} mt-0.5">æœŸæœ›: ${rule.expectedValue >= 0 ? '+' : ''}${rule.expectedValue.toFixed(2)}</div>
                </div>
              `).join('')}
              <div class="bg-gradient-to-br from-slate-50 to-gray-50 p-3 rounded-lg border border-slate-300">
                <div class="text-xs font-semibold text-slate-700 mb-1">æœªä¸­å¥–</div>
                <div class="text-lg font-bold text-slate-600">0x</div>
                <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${noWin.probability.toFixed(2)}%</div>
                <div class="text-xs text-slate-500 mt-0.5">æœŸæœ›: 0</div>
              </div>
            </div>
          </div>
          
          <!-- æƒ©ç½šè§„åˆ™æ¦‚ç‡ -->
          ${punishments.length > 0 ? `
            <div class="mb-4">
              <h5 class="text-sm font-bold text-red-700 mb-3">âš ï¸ æƒ©ç½šè§„åˆ™æ¦‚ç‡</h5>
              <div class="grid grid-cols-4 gap-2">
                ${punishments.map(p => `
                  <div class="bg-gradient-to-br from-red-50 to-rose-50 p-3 rounded-lg border border-red-200">
                    <div class="text-xs font-semibold text-slate-900 mb-1">${p.ruleName}</div>
                    <div class="text-lg font-bold text-red-600">${p.multiplier}x</div>
                    <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${p.probability.toFixed(2)}%</div>
                    <div class="text-xs text-red-600 mt-0.5">æœŸæœ›: ${p.expectedValue.toFixed(2)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <!-- RTPåˆ†æ -->
          <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border-2 border-indigo-300">
            <h5 class="text-sm font-bold text-indigo-900 mb-3">ğŸ’ RTP (ç©å®¶å›æŠ¥ç‡) åˆ†æ</h5>
            <div class="grid grid-cols-3 gap-4 mb-3">
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">æ€»æœŸæœ›æ”¶ç›Š</div>
                <div class="text-2xl font-bold ${totalExpectedValue >= 0 ? 'text-green-600' : 'text-red-600'}">${totalExpectedValue >= 0 ? '+' : ''}${totalExpectedValue.toFixed(2)}</div>
                <div class="text-xs text-slate-500">æŠ•æ³¨1å•ä½</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">ç©å®¶RTP</div>
                <div class="text-2xl font-bold ${rtp >= 85 && rtp <= 98 ? 'text-green-600' : 'text-red-600'}">${rtp.toFixed(2)}%</div>
                <div class="text-xs text-slate-500">${rtp >= 85 && rtp <= 98 ? 'âœ… å¥åº·èŒƒå›´' : 'âš ï¸ éœ€è°ƒæ•´'}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">åº„å®¶ä¼˜åŠ¿</div>
                <div class="text-2xl font-bold ${houseEdge > 0 ? 'text-green-600' : 'text-red-600'}">${houseEdge > 0 ? '+' : ''}${houseEdge.toFixed(2)}%</div>
                <div class="text-xs text-slate-500">${houseEdge > 0 ? 'âœ… å¯ç›ˆåˆ©' : 'âš ï¸ ä¼šäºæŸ'}</div>
              </div>
            </div>
            
            <!-- å¥åº·åº¦æŒ‡æ ‡ -->
            <div class="bg-white rounded-lg p-3 border border-indigo-200">
              <div class="text-xs text-slate-600 mb-2">ğŸ’¡ å¥åº·RTPèŒƒå›´: 85% - 98%</div>
              <div class="text-xs text-slate-500 space-y-1">
                <div>â€¢ ä½äº85%: ç©å®¶ä½“éªŒå·®ï¼Œæµå¤±ç‡é«˜</div>
                <div>â€¢ 85%-95%: å¹³è¡¡è‰¯å¥½ï¼Œæ¨èèŒƒå›´</div>
                <div>â€¢ 95%-98%: ç©å®¶å‹å¥½ï¼Œç•¥å¾®è–„åˆ©</div>
                <div>â€¢ é«˜äº98%: åº„å®¶äºæŸï¼Œä¸å¯æŒç»­</div>
              </div>
            </div>
            
            ${rtp < 85 || rtp > 98 ? `
              <div class="mt-3 bg-amber-50 border border-amber-300 rounded-lg p-3">
                <div class="text-xs font-bold text-amber-900 mb-2">ğŸ¯ é…ç½®å»ºè®®:</div>
                <div class="text-xs text-amber-800 space-y-1">
                  ${rtp > 98 ? `
                    <div>âš ï¸ RTPè¿‡é«˜ï¼Œå»ºè®®:</div>
                    <div>â€¢ é™ä½é«˜å€ç‡è§„åˆ™çš„å€æ•°</div>
                    <div>â€¢ æé«˜å¾‹å¸ˆå‡½æƒé‡</div>
                    <div>â€¢ ç§»é™¤éƒ¨åˆ†é«˜å€ç‡è§„åˆ™</div>
                  ` : `
                    <div>âš ï¸ RTPè¿‡ä½ï¼Œå»ºè®®:</div>
                    <div>â€¢ æé«˜å¥–åŠ±è§„åˆ™å€æ•°</div>
                    <div>â€¢ é™ä½å¾‹å¸ˆå‡½æƒé‡</div>
                    <div>â€¢ æ·»åŠ æ›´å¤šä¸­å¥–è§„åˆ™</div>
                  `}
                </div>
              </div>
            ` : ''}
            
            <!-- è®¡ç®—ä¿¡æ¯ -->
            <div class="mt-3 text-xs text-slate-500 text-center">
              ğŸ”„ è®¡ç®—æ–¹å¼: ${method === 'monte-carlo' ? `è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ ${simulationCount?.toLocaleString()} æ¬¡` : 'å¿«é€Ÿä¼°ç®—'} | 
              â±ï¸ è€—æ—¶: ${calculationTime}ms
            </div>
          </div>
        </div>
      `;
      
      displayDiv.innerHTML = html;
      displayDiv.classList.remove('hidden');
    }
    
    // é¢„è§ˆé«˜çº§åœºå¥–åŠ±é…ç½®
    async function previewAdvancedRewardScheme() {
      const schemeId = document.getElementById('advancedSlotRewardSchemeId').value;
      if (!schemeId) return;
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (data.success) {
          const rules = data.data.rules || [];
          const punishments = data.data.punishments || [];
          const previewList = document.getElementById('advancedRewardPreviewList');
          
          let html = '';
          
          // ğŸ ä¸­å¥–è§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (rules.length > 0) {
            html += `
              <div class="mb-4">
                <h5 class="text-xs font-bold text-green-700 mb-2">ğŸ ä¸­å¥–è§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${rules.map(rule => `
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1 truncate" title="${rule.rule_name}">${rule.rule_name}</div>
                      <div class="text-lg font-bold text-green-600">${rule.win_multiplier}x</div>
                      ${rule.grant_free_spin > 0 ? `<div class="text-xs text-amber-600 mt-1">ğŸ +${rule.grant_free_spin}æ¬¡å…è´¹</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          // âš ï¸ æƒ©ç½šè§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (punishments.length > 0) {
            html += `
              <div>
                <h5 class="text-xs font-bold text-red-700 mb-2">âš ï¸ æƒ©ç½šè§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${punishments.map(p => `
                    <div class="bg-gradient-to-br from-red-50 to-rose-50 p-3 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1">å¾‹å¸ˆå‡½Ã—${p.lsh_count}</div>
                      <div class="text-lg font-bold text-red-600">-${p.deduct_multiplier}x</div>
                      ${p.ban_hours > 0 ? `<div class="text-xs text-red-600 mt-1">ğŸš« ç¦${p.ban_hours}å°æ—¶</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          if (rules.length === 0 && punishments.length === 0) {
            html = '<div class="text-slate-500 text-center py-4">æš‚æ— è§„åˆ™</div>';
          }
          
          previewList.innerHTML = html;
          document.getElementById('advancedRewardPreview').classList.remove('hidden');
        }
      } catch (error) {
        console.error('é¢„è§ˆé«˜çº§åœºå¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // è®¡ç®—é«˜çº§åœºæ¦‚ç‡
    async function calculateAdvancedProbability() {
      const weightConfigId = document.getElementById('advancedSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('advancedSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        document.getElementById('advancedProbabilityDisplay').classList.add('hidden');
        return;
      }
      
      const method = document.querySelector('input[name="advancedCalcMethod"]:checked').value;
      const displayDiv = document.getElementById('advancedProbabilityDisplay');
      const cacheKey = getCacheKey(weightConfigId, rewardSchemeId, method);
      
      // ğŸ”¥ å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼ˆç¡®ä¿è·å–æœ€æ–°è®¡ç®—ç»“æœï¼‰
      if (probabilityCache.has(cacheKey)) {
        console.log('[å¼ºåˆ¶åˆ·æ–°] æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ¦‚ç‡');
        probabilityCache.delete(cacheKey);
      }
      
      // ğŸ”„ æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
      let progressPercent = 0;
      const progressInterval = method === 'monte-carlo' ? setInterval(() => {
        if (progressPercent < 95) {
          progressPercent += Math.random() * 10;
          if (progressPercent > 95) progressPercent = 95;
          updateProgressBar(displayDiv, progressPercent, method);
        }
      }, 200) : null;
      
      updateProgressBar(displayDiv, 0, method);
      displayDiv.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/admin/calculate-probability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId),
            method: method,
            simulation_count: method === 'monte-carlo' ? 1000000 : undefined
          })
        });
        
        const data = await res.json();
        
        if (progressInterval) {
          clearInterval(progressInterval);
          updateProgressBar(displayDiv, 100, method);
        }
        
        if (data.success) {
          const result = data.data;
          // ğŸ”¥ ç¼“å­˜ç»“æœ
          probabilityCache.set(cacheKey, result);
          setTimeout(() => {
            renderProbabilityDisplay('advancedProbabilityDisplay', result);
          }, 300);
        } else {
          displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥: ${data.message}</div>`;
        }
      } catch (error) {
        if (progressInterval) clearInterval(progressInterval);
        console.error('è®¡ç®—æ¦‚ç‡å¤±è´¥:', error);
        displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
      }
    }
    
    // ğŸ”„ æ›´æ–°è¿›åº¦æ¡
    function updateProgressBar(displayDiv, percent, method) {
      displayDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="w-full max-w-md mx-auto mb-4">
            <div class="relative h-6 bg-slate-200 rounded-full overflow-hidden">
              <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-300 ease-out flex items-center justify-center" style="width: ${percent}%">
                <span class="text-xs text-white font-bold">${Math.round(percent)}%</span>
              </div>
            </div>
          </div>
          <div class="animate-spin inline-block w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mb-3"></div>
          <p class="text-sm text-purple-700 font-semibold">ğŸ”„ è®¡ç®—ä¸­...</p>
          <p class="text-xs text-slate-500 mt-1">${method === 'monte-carlo' ? `è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ 1,000,000 æ¬¡ (${Math.round(percent)}%)` : 'å¿«é€Ÿä¼°ç®—'}</p>
          ${percent > 0 ? `<p class="text-xs text-purple-600 mt-2">â±ï¸ é¢„è®¡å‰©ä½™æ—¶é—´: ${Math.max(0, Math.round((100 - percent) / 100 * 3))}ç§’</p>` : ''}
        </div>
      `;
    }
    
    // æ¸²æŸ“æ¦‚ç‡æ˜¾ç¤º
    function renderProbabilityDisplay(displayId, result) {
      const displayDiv = document.getElementById(displayId);
      const { rules, punishments, noWin, rtp, houseEdge, totalExpectedValue, method, simulationCount, calculationTime } = result;
      
      let html = `
        <div class="bg-white rounded-lg p-4 border border-purple-200">
          <!-- ä¸­å¥–è§„åˆ™æ¦‚ç‡ -->
          <div class="mb-4">
            <h5 class="text-sm font-bold text-green-700 mb-3">ğŸ é…ç½®è§„åˆ™æ¦‚ç‡ (ä¸å«åŠ¨æ€ç»„åˆ)</h5>
            <div class="grid grid-cols-4 gap-2">
              ${rules.filter(rule => 
                !rule.ruleName.includes('+') && 
                !rule.ruleName.includes('manÃ—') &&
                rule.ruleName !== 'å¯¹ç§°ABBA'
              ).map(rule => `
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                  <div class="text-xs font-semibold text-slate-900 mb-1 truncate" title="${rule.ruleName}">${rule.ruleName}</div>
                  <div class="text-lg font-bold text-green-600">${rule.multiplier}x</div>
                  <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${rule.probability.toFixed(2)}%</div>
                  <div class="text-xs ${rule.expectedValue >= 0 ? 'text-green-600' : 'text-red-600'} mt-0.5">æœŸæœ›: ${rule.expectedValue >= 0 ? '+' : ''}${rule.expectedValue.toFixed(2)}</div>
                </div>
              `).join('')}
              <div class="bg-gradient-to-br from-slate-50 to-gray-50 p-3 rounded-lg border border-slate-300">
                <div class="text-xs font-semibold text-slate-700 mb-1">æœªä¸­å¥–</div>
                <div class="text-lg font-bold text-slate-600">0x</div>
                <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${noWin.probability.toFixed(2)}%</div>
                <div class="text-xs text-slate-500 mt-0.5">æœŸæœ›: 0</div>
              </div>
            </div>
          </div>
          
          <!-- æƒ©ç½šè§„åˆ™æ¦‚ç‡ -->
          ${punishments.length > 0 ? `
            <div class="mb-4">
              <h5 class="text-sm font-bold text-red-700 mb-3">âš ï¸ æƒ©ç½šè§„åˆ™æ¦‚ç‡</h5>
              <div class="grid grid-cols-4 gap-2">
                ${punishments.map(p => `
                  <div class="bg-gradient-to-br from-red-50 to-rose-50 p-3 rounded-lg border border-red-200">
                    <div class="text-xs font-semibold text-slate-900 mb-1">${p.ruleName}</div>
                    <div class="text-lg font-bold text-red-600">${p.multiplier}x</div>
                    <div class="text-xs text-purple-700 font-semibold mt-1">ğŸ“Š ${p.probability.toFixed(2)}%</div>
                    <div class="text-xs text-red-600 mt-0.5">æœŸæœ›: ${p.expectedValue.toFixed(2)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <!-- RTPåˆ†æ -->
          <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border-2 border-indigo-300">
            <h5 class="text-sm font-bold text-indigo-900 mb-3">ğŸ’ RTP (ç©å®¶å›æŠ¥ç‡) åˆ†æ</h5>
            <div class="grid grid-cols-3 gap-4 mb-3">
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">æ€»æœŸæœ›æ”¶ç›Š</div>
                <div class="text-2xl font-bold ${totalExpectedValue >= 0 ? 'text-green-600' : 'text-red-600'}">${totalExpectedValue >= 0 ? '+' : ''}${totalExpectedValue.toFixed(2)}</div>
                <div class="text-xs text-slate-500">æŠ•æ³¨1å•ä½</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">ç©å®¶RTP</div>
                <div class="text-2xl font-bold ${rtp >= 85 && rtp <= 98 ? 'text-green-600' : 'text-red-600'}">${rtp.toFixed(2)}%</div>
                <div class="text-xs text-slate-500">${rtp >= 85 && rtp <= 98 ? 'âœ… å¥åº·èŒƒå›´' : 'âš ï¸ éœ€è°ƒæ•´'}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-600 mb-1">åº„å®¶ä¼˜åŠ¿</div>
                <div class="text-2xl font-bold ${houseEdge > 0 ? 'text-green-600' : 'text-red-600'}">${houseEdge > 0 ? '+' : ''}${houseEdge.toFixed(2)}%</div>
                <div class="text-xs text-slate-500">${houseEdge > 0 ? 'âœ… å¯ç›ˆåˆ©' : 'âš ï¸ ä¼šäºæŸ'}</div>
              </div>
            </div>
            
            <!-- å¥åº·åº¦æŒ‡æ ‡ -->
            <div class="bg-white rounded-lg p-3 border border-indigo-200">
              <div class="text-xs text-slate-600 mb-2">ğŸ’¡ å¥åº·RTPèŒƒå›´: 85% - 98%</div>
              <div class="text-xs text-slate-500 space-y-1">
                <div>â€¢ ä½äº85%: ç©å®¶ä½“éªŒå·®ï¼Œæµå¤±ç‡é«˜</div>
                <div>â€¢ 85%-95%: å¹³è¡¡è‰¯å¥½ï¼Œæ¨èèŒƒå›´</div>
                <div>â€¢ 95%-98%: ç©å®¶å‹å¥½ï¼Œç•¥å¾®è–„åˆ©</div>
                <div>â€¢ é«˜äº98%: åº„å®¶äºæŸï¼Œä¸å¯æŒç»­</div>
              </div>
            </div>
            
            ${rtp < 85 || rtp > 98 ? `
              <div class="mt-3 bg-amber-50 border border-amber-300 rounded-lg p-3">
                <div class="text-xs font-bold text-amber-900 mb-2">ğŸ¯ é…ç½®å»ºè®®:</div>
                <div class="text-xs text-amber-800 space-y-1">
                  ${rtp > 98 ? `
                    <div>âš ï¸ RTPè¿‡é«˜ï¼Œå»ºè®®:</div>
                    <div>â€¢ é™ä½é«˜å€ç‡è§„åˆ™çš„å€æ•°</div>
                    <div>â€¢ æé«˜å¾‹å¸ˆå‡½æƒé‡</div>
                    <div>â€¢ ç§»é™¤éƒ¨åˆ†é«˜å€ç‡è§„åˆ™</div>
                  ` : `
                    <div>âš ï¸ RTPè¿‡ä½ï¼Œå»ºè®®:</div>
                    <div>â€¢ æé«˜å¥–åŠ±è§„åˆ™å€æ•°</div>
                    <div>â€¢ é™ä½å¾‹å¸ˆå‡½æƒé‡</div>
                    <div>â€¢ æ·»åŠ æ›´å¤šä¸­å¥–è§„åˆ™</div>
                  `}
                </div>
              </div>
            ` : ''}
            
            <!-- è®¡ç®—ä¿¡æ¯ -->
            <div class="mt-3 text-xs text-slate-500 text-center">
              ğŸ”„ è®¡ç®—æ–¹å¼: ${method === 'monte-carlo' ? `è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ ${simulationCount?.toLocaleString()} æ¬¡` : 'å¿«é€Ÿä¼°ç®—'} | 
              â±ï¸ è€—æ—¶: ${calculationTime}ms
            </div>
          </div>
        </div>
      `;
      
      displayDiv.innerHTML = html;
      displayDiv.classList.remove('hidden');
    }
    
    // ä¿å­˜é«˜çº§åœºé…ç½®æ–¹æ¡ˆé€‰æ‹©
    async function saveAdvancedSlotConfigSchemes() {
      const weightConfigId = document.getElementById('advancedSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('advancedSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        showToast('è¯·é€‰æ‹©æƒé‡é…ç½®æ–¹æ¡ˆå’Œå¥–åŠ±é…ç½®æ–¹æ¡ˆ', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/slot/advanced/config/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId)
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('âœ… é«˜çº§åœºé…ç½®æ–¹æ¡ˆå·²ä¿å­˜å¹¶ç”Ÿæ•ˆ', 'success');
          // ğŸ”¥ é‡æ–°åŠ è½½é…ç½®ä»¥åˆ·æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤º
          await loadAdvancedWeightConfigOptions();
          await loadAdvancedRewardSchemeOptions();
          // ğŸ”¥ é‡æ–°è®¡ç®—æ¦‚ç‡
          await calculateAdvancedProbability();
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜é«˜çº§åœºé…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥', 'error');
      }
    }

    // é«˜çº§åœºé…ç½®ç®¡ç†
    async function loadAdvancedSlotConfig() {
      try {
        const res = await fetch('/api/admin/slot/advanced/config');
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          
          // åŸºç¡€è®¾ç½®
          document.getElementById('advancedEnabled').checked = config.enabled === 1;
          
          // ğŸ¯ ä½¿ç”¨ç¾å…ƒæ˜¾ç¤ºæŠ•æ³¨èŒƒå›´
          const betMinUsd = (config.bet_min / 500000).toFixed(0);
          const betMaxUsd = (config.bet_max / 500000).toFixed(0);
          const dailyLimitUsd = (config.daily_bet_limit / 500000).toFixed(0);
          
          document.getElementById('advancedBetMinUsd').value = betMinUsd;
          document.getElementById('advancedBetMaxUsd').value = betMaxUsd;
          document.getElementById('advancedDailyBetLimitUsd').value = dailyLimitUsd;
          
          // æ˜¾ç¤ºèªå€¼
          document.getElementById('advancedBetMinQuota').textContent = config.bet_min || 50000000;
          document.getElementById('advancedBetMaxQuota').textContent = config.bet_max || 250000000;
          document.getElementById('advancedDailyBetLimitQuota').textContent = config.daily_bet_limit || 5000000000;
          
          // âŒ å·²ç§»é™¤å€ç‡é…ç½®åŠ è½½
          // document.getElementById('advancedRewardMultiplier').value = config.reward_multiplier || 4.0;
          // document.getElementById('advancedPenaltyFactor').value = config.penalty_weight_factor || 2.0;
          
          // æ—¶æ•ˆè®¾ç½®
          document.getElementById('advancedTicketValidHours').value = config.ticket_valid_hours || 24;
          document.getElementById('advancedSessionValidHours').value = config.session_valid_hours || 24;

          // å…¥åœºåˆ¸è®¾ç½®
          document.getElementById('advancedFragmentsNeeded').value = config.fragments_needed || 5;
          document.getElementById('advancedMaxTicketsHold').value = config.max_tickets_hold || 2;
          document.getElementById('advancedDailyEntryLimit').value = config.daily_entry_limit || 2;
          document.getElementById('advancedDailyTicketGrantLimit').value = config.daily_ticket_grant_limit || 2;
          
          // ğŸ¯ å®æ—¶æ›´æ–°èªå€¼æ˜¾ç¤ºï¼ˆç¾å…ƒâ†’èªï¼‰
          document.getElementById('advancedBetMinUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedBetMinQuota').textContent = value * 500000;
          });
          document.getElementById('advancedBetMaxUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedBetMaxQuota').textContent = value * 500000;
          });
          document.getElementById('advancedDailyBetLimitUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedDailyBetLimitQuota').textContent = value * 500000;
          });
        }
        
        // åŠ è½½é…ç½®æ–¹æ¡ˆåˆ—è¡¨
        await loadAdvancedWeightConfigOptions();
        await loadAdvancedRewardSchemeOptions();
      } catch (error) {
        console.error('åŠ è½½é«˜çº§åœºé…ç½®å¤±è´¥:', error);
        showMessage('åŠ è½½é…ç½®å¤±è´¥', 'error');
      }
    }
    
    // åŠ è½½é«˜çº§åœºæƒé‡é…ç½®æ–¹æ¡ˆé€‰é¡¹
    async function loadAdvancedWeightConfigOptions() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('advancedSlotWeightConfigId');
          
          // å…ˆè·å–å½“å‰é…ç½®
          const configRes = await fetch('/api/admin/slot/advanced/config');
          const configData = await configRes.json();
          const currentWeightId = configData.success && configData.data.weight_config_id ? configData.data.weight_config_id : null;
          
          // æ¸²æŸ“é€‰é¡¹ï¼Œç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = data.data.map(w => 
            `<option value="${w.id}">${w.config_name}</option>`
          ).join('');
          
          // è®¾ç½®å½“å‰é€‰ä¸­çš„é…ç½®
          if (currentWeightId) {
            select.value = currentWeightId;
            previewAdvancedWeightConfig();
          }
        }
      } catch (error) {
        console.error('åŠ è½½é«˜çº§åœºæƒé‡é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // åŠ è½½é«˜çº§åœºå¥–åŠ±é…ç½®æ–¹æ¡ˆé€‰é¡¹
    async function loadAdvancedRewardSchemeOptions() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('advancedSlotRewardSchemeId');
          
          // å…ˆè·å–å½“å‰é…ç½®
          const configRes = await fetch('/api/admin/slot/advanced/config');
          const configData = await configRes.json();
          const currentSchemeId = configData.success && configData.data.reward_scheme_id ? configData.data.reward_scheme_id : null;
          
          // æ¸²æŸ“é€‰é¡¹ï¼Œç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = data.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}</option>`
          ).join('');
          
          // è®¾ç½®å½“å‰é€‰ä¸­çš„é…ç½®
          if (currentSchemeId) {
            select.value = currentSchemeId;
            previewAdvancedRewardScheme();
          }
        }
      } catch (error) {
        console.error('åŠ è½½é«˜çº§åœºå¥–åŠ±é…ç½®æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }

    async function saveAdvancedSlotConfig() {
      try {
        // ğŸ¯ ä»ç¾å…ƒè¾“å…¥æ¡†è·å–å€¼ï¼Œè½¬æ¢ä¸ºèª
        const betMinUsd = parseInt(document.getElementById('advancedBetMinUsd').value) || 100;
        const betMaxUsd = parseInt(document.getElementById('advancedBetMaxUsd').value) || 500;
        const dailyLimitUsd = parseInt(document.getElementById('advancedDailyBetLimitUsd').value) || 10000;
        
        const config = {
          enabled: document.getElementById('advancedEnabled').checked ? 1 : 0,
          bet_min: betMinUsd * 500000,  // ç¾å…ƒè½¬èª
          bet_max: betMaxUsd * 500000,  // ç¾å…ƒè½¬èª
          reward_multiplier: 1.0,  // âŒ å›ºå®šä¸º1.0ï¼Œä¸å†ä½¿ç”¨å€ç‡æ”¾å¤§
          penalty_weight_factor: 1.0,  // âŒ å›ºå®šä¸º1.0ï¼Œä¸å†ä½¿ç”¨å€ç‡æ”¾å¤§
          rtp_target: 0.88,  // ä¿ç•™å­—æ®µä»¥å…¼å®¹æ•°æ®åº“
          ticket_valid_hours: parseInt(document.getElementById('advancedTicketValidHours').value) || 24,
          session_valid_hours: parseInt(document.getElementById('advancedSessionValidHours').value) || 24,
          fragments_needed: parseInt(document.getElementById('advancedFragmentsNeeded').value) || 5,
          max_tickets_hold: parseInt(document.getElementById('advancedMaxTicketsHold').value) || 2,
          daily_bet_limit: dailyLimitUsd * 500000,  // ç¾å…ƒè½¬èª
          daily_entry_limit: parseInt(document.getElementById('advancedDailyEntryLimit').value) || 2,
          daily_ticket_grant_limit: parseInt(document.getElementById('advancedDailyTicketGrantLimit').value) || 2
        };
        
        // éªŒè¯
        if (betMinUsd >= betMaxUsd) {
          showMessage('æœ€å°æŠ•æ³¨å¿…é¡»å°äºæœ€å¤§æŠ•æ³¨', 'error');
          return;
        }
        
        const res = await fetch('/api/admin/slot/advanced/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showMessage('é«˜çº§åœºé…ç½®å·²æ›´æ–°', 'success');
          console.log('[ç®¡ç†å‘˜] é«˜çº§åœºé…ç½®å·²ä¿å­˜:', config);
        } else {
          showMessage(data.message, 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜é«˜çº§åœºé…ç½®å¤±è´¥:', error);
        showMessage('ä¿å­˜é…ç½®å¤±è´¥', 'error');
      }
    }

    // ========== å¤å‘—è´·æ¬¾ç®¡ç†åŠŸèƒ½ ==========
    
    async function loadKunbeiManagement() {
      try {
        // åŠ è½½é…ç½®
        const configRes = await fetch('/api/admin/kunbei/config');
        const configData = await configRes.json();
        
        if (configData.success) {
          const config = configData.data;
          document.getElementById('kunbeiEnabled').value = config.enabled;
          document.getElementById('kunbeiMaxAmount').value = config.max_loan_amount / 500000;
          document.getElementById('kunbeiRepayMultiplier').value = config.repay_multiplier;
          document.getElementById('kunbeiDuration').value = config.loan_duration_hours;
          document.getElementById('kunbeiEarlyDiscount').value = config.early_repay_discount;
          document.getElementById('kunbeiOverduePenalty').value = config.overdue_penalty_hours;
          document.getElementById('kunbeiOverdueDeductMultiplier').value = config.overdue_deduct_multiplier || 2.5;
          document.getElementById('kunbeiMaxDailyBorrows').value = config.max_daily_borrows || 3;
          
          // é€¾æœŸæ‰£é™¤é…ç½®å·²ç§»é™¤ï¼Œä½¿ç”¨å€æ•°ç³»ç»Ÿæ›¿ä»£
        } else {
          console.error('åŠ è½½å¤å‘—é…ç½®å¤±è´¥:', configData.message);
          showToast('åŠ è½½å¤å‘—é…ç½®å¤±è´¥ï¼š' + (configData.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        const loansRes = await fetch('/api/admin/kunbei/loans');
        const loansData = await loansRes.json();
        
        if (loansData.success) {
          updateKunbeiMainStats(loansData.data.stats);
        } else {
          console.error('åŠ è½½å¤å‘—ç»Ÿè®¡å¤±è´¥:', loansData.message);
          showToast('åŠ è½½å¤å‘—ç»Ÿè®¡å¤±è´¥ï¼š' + (loansData.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        
        // åŠ è½½æ¢¯åº¦é…ç½®
        await loadGradientConfigs();
      } catch (error) {
        console.error('åŠ è½½å¤å‘—æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½å¤å‘—æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
      }
    }
    
    function refreshKunbeiData() {
      loadKunbeiManagement();
    }
    
    async function saveKunbeiConfig() {
      try {
        const config = {
          enabled: parseInt(document.getElementById('kunbeiEnabled').value),
          max_loan_amount: parseInt(document.getElementById('kunbeiMaxAmount').value) * 500000,
          min_loan_amount: 5000000,
          repay_multiplier: parseFloat(document.getElementById('kunbeiRepayMultiplier').value),
          loan_duration_hours: parseFloat(document.getElementById('kunbeiDuration').value),
          early_repay_discount: parseFloat(document.getElementById('kunbeiEarlyDiscount').value),
          overdue_penalty_hours: parseInt(document.getElementById('kunbeiOverduePenalty').value),
          overdue_deduct_multiplier: parseFloat(document.getElementById('kunbeiOverdueDeductMultiplier').value) || 2.5,
          max_daily_borrows: parseInt(document.getElementById('kunbeiMaxDailyBorrows').value) || 3,
          overdue_ban_advanced: 1,
          max_active_loans: 1,
          deduct_all_quota_on_overdue: 1  // ä¿ç•™å­—æ®µä»¥å…¼å®¹
        };
        
        const res = await fetch('/api/admin/kunbei/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('é…ç½®å·²ä¿å­˜', 'success');
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜å¤å‘—é…ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥', 'error');
      }
    }
    
    function updateKunbeiMainStats(stats) {
      // æ›´æ–°å¤å‘—ç®¡ç†é¡µé¢çš„ç»Ÿè®¡
      document.getElementById('kunbeiActiveCount').textContent = stats.active_count || 0;
      document.getElementById('kunbeiOverdueCount').textContent = stats.overdue_count || 0;
      document.getElementById('kunbeiTotalLoan').textContent = `$${((stats.total_loan || 0) / 500000).toFixed(2)}`;
      document.getElementById('kunbeiTotalRepaid').textContent = `$${((stats.total_repaid || 0) / 500000).toFixed(2)}`;
    }
    
    // è±å…å€Ÿæ¬¾
    async function forgiveLoan(loanId, username) {
      if (!confirm(`ç¡®è®¤è±å…ç”¨æˆ· "${username}" çš„å€Ÿæ¬¾å—ï¼Ÿ\n\nè±å…åè¯¥å€Ÿæ¬¾å°†æ ‡è®°ä¸ºå·²è¿˜æ¸…ï¼Œç”¨æˆ·æ— éœ€è¿˜æ¬¾ã€‚`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('å€Ÿæ¬¾å·²è±å…', 'success');
          refreshKunbeiData();
        } else {
          showToast(data.message || 'è±å…å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('è±å…å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
      }
    }
    
    // ========== å¤å‘—æ¢¯åº¦é…ç½®ç®¡ç† ==========
    async function loadGradientConfigs() {
      try {
        const res = await fetch('/api/admin/kunbei/gradient-configs');
        const data = await res.json();
        
        if (data.success && data.data) {
          renderGradientConfigsTable(data.data);
        } else {
          console.error('åŠ è½½æ¢¯åº¦é…ç½®å¤±è´¥:', data.message);
          showToast(data.message || 'åŠ è½½æ¢¯åº¦é…ç½®å¤±è´¥', 'error');
          // æ˜¾ç¤ºç©ºçŠ¶æ€
          const tbody = document.getElementById('gradientConfigsTable');
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="4" class="text-center py-8 text-red-500">
                  <div class="text-4xl mb-2">âš ï¸</div>
                  <p>åŠ è½½å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error('åŠ è½½æ¢¯åº¦é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½æ¢¯åº¦é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        const tbody = document.getElementById('gradientConfigsTable');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center py-8 text-red-500">
                <div class="text-4xl mb-2">âš ï¸</div>
                <p>ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</p>
              </td>
            </tr>
          `;
        }
      }
    }
    
    function renderGradientConfigsTable(configs) {
      const tbody = document.getElementById('gradientConfigsTable');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-8 text-slate-500">
              <div class="text-4xl mb-2">ğŸ“‹</div>
              <p>æš‚æ— æ¢¯åº¦é…ç½®</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = configs.map(config => `
        <tr class="border-b border-slate-100 hover:bg-slate-50">
          <td class="px-4 py-3">
            <span class="font-semibold text-slate-900">$${(config.quota_threshold / 500000).toFixed(2)}</span>
            <div class="text-xs text-slate-500">é¢åº¦è¾¾åˆ°æ­¤å€¼</div>
          </td>
          <td class="px-4 py-3">
            <span class="font-semibold text-green-600">$${(config.max_loan_amount / 500000).toFixed(2)}</span>
            <div class="text-xs text-slate-500">æœ€å¤§å¯å€Ÿ</div>
          </td>
          <td class="px-4 py-3">
            ${config.is_active 
              ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… å¯ç”¨</span>'
              : '<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-semibold">âŒ ç¦ç”¨</span>'
            }
          </td>
          <td class="px-4 py-3 text-center">
            <button onclick="editGradientConfig(${JSON.stringify(config).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">ç¼–è¾‘</button>
            <button onclick="deleteGradientConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }
    
    function showGradientConfigModal(config = null) {
      // ğŸ”¥ ä¿®å¤ï¼šå…ˆç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†ï¼Œé¿å…é‡å¤æ·»åŠ 
      const existingModal = document.getElementById('gradientConfigModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const isEdit = !!config;
      const modalHtml = `
        <div id="gradientConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-slate-900 mb-4">${isEdit ? 'ç¼–è¾‘æ¢¯åº¦é…ç½®' : 'æ·»åŠ æ¢¯åº¦é…ç½®'}</h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">é¢åº¦é˜ˆå€¼ï¼ˆç¾å…ƒï¼‰</label>
                <input type="number" id="gradientThreshold" value="${config ? config.quota_threshold / 500000 : ''}" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                  placeholder="ä¾‹å¦‚ï¼š10000">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æœ€å¤§å¯å€Ÿé‡‘é¢ï¼ˆç¾å…ƒï¼‰</label>
                <input type="number" id="gradientMaxLoan" value="${config ? config.max_loan_amount / 500000 : ''}"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="ä¾‹å¦‚ï¼š10000">
              </div>
              
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="gradientActive" ${!config || config.is_active ? 'checked' : ''}
                    class="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                  <span class="text-slate-700 font-medium">å¯ç”¨æ­¤é…ç½®</span>
                </label>
              </div>
            </div>
            
            <div class="flex gap-3 mt-6">
              <button onclick="closeGradientConfigModal()" 
                class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">
                å–æ¶ˆ
              </button>
              <button onclick="saveGradientConfig(${config ? config.id : 'null'})" 
                class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                ${isEdit ? 'æ›´æ–°' : 'æ·»åŠ '}
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function editGradientConfig(config) {
      showGradientConfigModal(config);
    }
    
    function closeGradientConfigModal() {
      const modal = document.getElementById('gradientConfigModal');
      if (modal) modal.remove();
    }
    
    async function saveGradientConfig(configId) {
      try {
        const threshold = parseFloat(document.getElementById('gradientThreshold').value);
        const maxLoan = parseFloat(document.getElementById('gradientMaxLoan').value);
        const isActive = document.getElementById('gradientActive').checked ? 1 : 0;
        
        if (!threshold || !maxLoan) {
          showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
          return;
        }
        
        const data = {
          quota_threshold: threshold * 500000,
          max_loan_amount: maxLoan * 500000,
          priority: 0,  // ä¼˜å…ˆçº§å›ºå®šä¸º0ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰é˜ˆå€¼æ’åº
          is_active: isActive
        };
        
        const url = configId 
          ? `/api/admin/kunbei/gradient-configs/${configId}`
          : '/api/admin/kunbei/gradient-configs';
          
        const method = configId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast(configId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
          closeGradientConfigModal();
          loadGradientConfigs();
        } else {
          showToast(result.message || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜æ¢¯åº¦é…ç½®å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
      }
    }
    
    async function deleteGradientConfig(configId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¢¯åº¦é…ç½®å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/gradient-configs/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('åˆ é™¤æˆåŠŸ', 'success');
          loadGradientConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤æ¢¯åº¦é…ç½®å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    // ä¿å­˜é€¾æœŸæ‰£é™¤é…ç½®å·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨å€æ•°ç³»ç»Ÿï¼Œåœ¨saveKunbeiConfigä¸­ä¸€èµ·ä¿å­˜
    // function saveOverdueConfig() - å·²ç§»é™¤

    // ========== è´·æ¬¾è®°å½•ç®¡ç†åŠŸèƒ½ ==========
    
    let kunbeiRecordsCurrentPage = 1;
    let kunbeiRecordsData = [];
    let kunbeiRecordsFiltered = [];
    let selectedRecords = new Set();
    const recordsPerPage = 20;
    
    async function loadKunbeiRecords() {
      try {
        const res = await fetch('/api/admin/kunbei/all-loans');
        const data = await res.json();
        
        if (data.success) {
          kunbeiRecordsData = data.data.loans || [];
          applyKunbeiFilters();
          updateKunbeiStatistics(data.data.stats);
        }
      } catch (error) {
        console.error('åŠ è½½è´·æ¬¾è®°å½•å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥', 'error');
      }
    }
    
    function refreshKunbeiRecords() {
      selectedRecords.clear();
      updateSelectedCount();
      loadKunbeiRecords();
    }
    
    function searchKunbeiRecords(event) {
      if (event.key === 'Enter' || !event.key) {
        applyKunbeiFilters();
      }
    }

    // ğŸ” æ‰‹åŠ¨è§¦å‘æŸ¥æ‰¾æŒ‰é’®
    function triggerKunbeiSearch() {
      applyKunbeiFilters();
    }

    function filterKunbeiRecords() {
      applyKunbeiFilters();
    }
    
    function applyKunbeiFilters() {
      const searchTerm = document.getElementById('kunbeiRecordSearch').value.toLowerCase();
      const statusFilter = document.getElementById('kunbeiStatusFilter').value;
      const timeFilter = document.getElementById('kunbeiTimeFilter').value;
      
      kunbeiRecordsFiltered = kunbeiRecordsData.filter(record => {
        // æœç´¢è¿‡æ»¤
        if (searchTerm) {
          const matchLinuxDo = record.username.toLowerCase().includes(searchTerm);
          const matchKyx = record.kyx_username && record.kyx_username.toLowerCase().includes(searchTerm);
          if (!matchLinuxDo && !matchKyx) return false;
        }
        
        // çŠ¶æ€è¿‡æ»¤
        if (statusFilter) {
          // åˆ¤æ–­æ˜¯å¦è±å…
          const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
          if (statusFilter === 'forgiven' && !isForgiven) return false;
          if (statusFilter !== 'forgiven' && statusFilter !== record.status) return false;
        }
        
        // æ—¶é—´è¿‡æ»¤
        if (timeFilter && timeFilter !== 'all') {
          const now = Date.now();
          const recordTime = record.borrowed_at;
          const dayMs = 24 * 60 * 60 * 1000;
          
          if (timeFilter === 'today' && recordTime < now - dayMs) return false;
          if (timeFilter === 'week' && recordTime < now - 7 * dayMs) return false;
          if (timeFilter === 'month' && recordTime < now - 30 * dayMs) return false;
        }
        
        return true;
      });
      
      // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      kunbeiRecordsCurrentPage = 1;
      renderKunbeiRecordsTable();
    }
    
    function updateKunbeiStatistics(stats) {
      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      document.getElementById('totalRecordsCount').textContent = stats.total_count || 0;
      document.getElementById('activeLoansCount').textContent = stats.active_count || 0;
      document.getElementById('repaidLoansCount').textContent = stats.repaid_count || 0;
      document.getElementById('overdueLoansCount').textContent = stats.overdue_count || 0;
      document.getElementById('totalLoanedAmount').textContent = `$${((stats.total_loaned || stats.total_amount || 0) / 500000).toFixed(2)}`;
      document.getElementById('totalRepaidAmount').textContent = `$${((stats.total_repaid || 0) / 500000).toFixed(2)}`;
    }
    
    function renderKunbeiRecordsTable() {
      const tbody = document.getElementById('kunbeiRecordsTableBody');
      const totalRecords = kunbeiRecordsFiltered.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const start = (kunbeiRecordsCurrentPage - 1) * recordsPerPage;
      const end = Math.min(start + recordsPerPage, totalRecords);
      const pageRecords = kunbeiRecordsFiltered.slice(start, end);
      
      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      document.getElementById('recordsStart').textContent = totalRecords > 0 ? start + 1 : 0;
      document.getElementById('recordsEnd').textContent = end;
      document.getElementById('recordsTotal').textContent = totalRecords;
      document.getElementById('currentPageNum').textContent = kunbeiRecordsCurrentPage;
      document.getElementById('totalPageNum').textContent = totalPages || 1;
      
      // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
      document.getElementById('prevPageBtn').disabled = kunbeiRecordsCurrentPage <= 1;
      document.getElementById('nextPageBtn').disabled = kunbeiRecordsCurrentPage >= totalPages;
      
      if (pageRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-slate-500">æš‚æ— è®°å½•</td></tr>';
        return;
      }
      
      tbody.innerHTML = pageRecords.map(record => {
        const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
        
        // ğŸ”¥ ä¼˜åŒ–ï¼šåªæœ‰é€¾æœŸä¸”æœ‰æƒ©ç½šæ—¶é—´ä¸”æœªè¿‡æœŸæ—¶æ‰è®¤ä¸ºæœ‰é€¾æœŸæƒ©ç½š
        const now = Date.now();
        const hasOverduePenalty = record.status === 'overdue' && 
                                   record.overdue_penalty_until && 
                                   record.overdue_penalty_until > now;
        
        // ğŸ”¥ çŠ¶æ€æ ‡ç­¾å’Œé¢å¤–ä¿¡æ¯
        let statusBadge = '';
        let extraInfo = '';
        
        if (record.status === 'active') {
          statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">â³ å€Ÿæ¬¾ä¸­</span>';
        } else if (record.status === 'overdue') {
          statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">âš ï¸ å·²é€¾æœŸ</span>';
          // ğŸ”¥ æ˜¾ç¤ºé€¾æœŸè‡ªåŠ¨æ‰£æ¬¾ä¿¡æ¯
          if (record.auto_deducted_amount && record.auto_deducted_amount > 0) {
            extraInfo = `<div class="text-xs text-orange-600 mt-1">ç³»ç»Ÿè‡ªåŠ¨æ‰£æ¬¾ $${(record.auto_deducted_amount / 500000).toFixed(2)}</div>`;
          }
        } else if (isForgiven) {
          statusBadge = '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">ğŸ¤ å·²å…é™¤</span>';
          // ğŸ”¥ æ˜¾ç¤ºè±å…ä¿¡æ¯
          extraInfo = '<div class="text-xs text-purple-600 mt-1">ç®¡ç†å‘˜å·²è±å…æ­¤å€Ÿæ¬¾</div>';
        } else {
          statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… å·²è¿˜æ¬¾</span>';
        }
        
        // ğŸ”¥ æ˜¾ç¤ºè‡ªåŠ¨æ‰£æ¬¾é‡‘é¢å’Œæ‰£æ¬¾åä½™é¢
        const autoDeductDisplay = record.auto_deducted_amount && record.auto_deducted_amount > 0
          ? `<div class="font-semibold text-orange-600">$${(record.auto_deducted_amount / 500000).toFixed(2)}</div>
             <div class="text-xs text-orange-500">ä½™é¢: $${((record.balance_after_deduct || 0) / 500000).toFixed(2)}</div>`
          : (record.status === 'overdue' && record.auto_deducted_amount === 0
              ? `<div class="text-xs text-slate-500">ä½™é¢ä¸è¶³</div><div class="text-xs text-slate-400">æœªæ‰£æ¬¾</div>`
              : '<span class="text-slate-400 text-xs">-</span>');
        
        const isChecked = selectedRecords.has(record.id);
        
        // ğŸ”¥ ä¼˜åŒ–æ“ä½œæŒ‰é’®ï¼šåªåœ¨æœ‰æœ‰æ•ˆçš„é€¾æœŸæƒ©ç½šæ—¶æ˜¾ç¤ºè§£å°æŒ‰é’®
        let actionButtons = '';
        if (record.status === 'active' || record.status === 'overdue') {
          actionButtons = `
            <button onclick="viewLoanDetails(${record.id})" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mb-1">è¯¦æƒ…</button>
          `;
          
          // ğŸ”¥ é€¾æœŸè®°å½•ä¸å…è®¸è±å…
          if (record.status !== 'overdue') {
            actionButtons += `<button onclick="forgiveSingleLoan(${record.id}, '${record.username}')" class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs font-medium mb-1">å…é™¤</button>`;
          }
          
          // ğŸ”¥ åªæœ‰å½“å‰æœ‰æœ‰æ•ˆçš„é€¾æœŸæƒ©ç½šæ—¶æ‰æ˜¾ç¤ºè§£å°æŒ‰é’®
          if (hasOverduePenalty) {
            const remainingHours = Math.ceil((record.overdue_penalty_until - now) / 3600000);
            actionButtons += `
            <button onclick="clearOverduePenaltyBtn(${record.id}, '${record.username}')" 
                    class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium"
                    title="è§£é™¤é«˜çº§åœºç¦å…¥ï¼ˆå‰©ä½™${remainingHours}å°æ—¶ï¼‰">
              ğŸ”“ è§£å°
            </button>
            `;
          }
        } else {
          actionButtons = `<button onclick="viewLoanDetails(${record.id})" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium">è¯¦æƒ…</button>`;
        }
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 text-center">
              <input type="checkbox" ${isChecked ? 'checked' : ''} 
                     onchange="toggleRecordSelection(${record.id})"
                     ${record.status === 'repaid' || isForgiven ? 'disabled' : ''}
                     class="w-4 h-4 text-indigo-600 border-slate-300 rounded ${record.status === 'repaid' || isForgiven ? 'opacity-50' : ''}">
            </td>
            <td class="px-4 py-3 font-mono text-slate-600">#${record.id}</td>
            <td class="px-4 py-3">
              <div class="font-medium text-slate-900">${record.username}</div>
            </td>
            <td class="px-4 py-3">
              <div class="text-sm text-slate-600">${record.kyx_username || '-'}</div>
            </td>
            <td class="px-4 py-3 text-right font-semibold text-blue-600">$${(record.loan_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-semibold text-red-600">$${(record.repay_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-right">${autoDeductDisplay}</td>
            <td class="px-4 py-3 text-xs text-slate-600">${new Date(record.borrowed_at).toLocaleString('zh-CN', { hour12: false })}</td>
            <td class="px-4 py-3 text-xs text-slate-600">${new Date(record.due_at).toLocaleString('zh-CN', { hour12: false })}</td>
            <td class="px-4 py-3 text-center">
              <div>${statusBadge}</div>
              ${extraInfo}
            </td>
            <td class="px-4 py-3 text-center">
              <div class="flex flex-col gap-1 items-center">
                ${actionButtons}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function changeRecordsPage(delta) {
      const totalPages = Math.ceil(kunbeiRecordsFiltered.length / recordsPerPage);
      const newPage = kunbeiRecordsCurrentPage + delta;
      
      if (newPage >= 1 && newPage <= totalPages) {
        kunbeiRecordsCurrentPage = newPage;
        renderKunbeiRecordsTable();
      }
    }
    
    function toggleRecordSelection(recordId) {
      if (selectedRecords.has(recordId)) {
        selectedRecords.delete(recordId);
      } else {
        selectedRecords.add(recordId);
      }
      updateSelectedCount();
    }
    
    function toggleAllRecords() {
      const checkAll = document.getElementById('selectAllRecords').checked;
      const headerCheckAll = document.getElementById('selectAllHeader');
      
      if (headerCheckAll) {
        headerCheckAll.checked = checkAll;
      }
      
      if (checkAll) {
        // åªé€‰æ‹©å½“å‰é¡µé¢ä¸Šå¯é€‰çš„è®°å½•ï¼ˆéå·²è¿˜æ¬¾/å·²å…é™¤ï¼‰
        const start = (kunbeiRecordsCurrentPage - 1) * recordsPerPage;
        const end = Math.min(start + recordsPerPage, kunbeiRecordsFiltered.length);
        const pageRecords = kunbeiRecordsFiltered.slice(start, end);
        
        pageRecords.forEach(record => {
          if (record.status === 'active' || record.status === 'overdue') {
            selectedRecords.add(record.id);
          }
        });
      } else {
        selectedRecords.clear();
      }
      
      updateSelectedCount();
      renderKunbeiRecordsTable();
    }
    
    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedRecords.size;
      const hasSeletion = selectedRecords.size > 0;
      document.getElementById('batchForgiveBtn').disabled = !hasSeletion;
      document.getElementById('batchReminderBtn').disabled = !hasSeletion;
    }
    
    async function batchForgiveLoans() {
      if (selectedRecords.size === 0) return;
      
      if (!confirm(`ç¡®å®šè¦å…é™¤é€‰ä¸­çš„ ${selectedRecords.size} æ¡è´·æ¬¾è®°å½•å—ï¼Ÿ\n\nå…é™¤åè¿™äº›å€Ÿæ¬¾å°†æ ‡è®°ä¸ºå·²è¿˜æ¸…ï¼Œç”¨æˆ·æ— éœ€è¿˜æ¬¾ã€‚`)) {
        return;
      }
      
      let successCount = 0;
      let failCount = 0;
      
      for (const loanId of selectedRecords) {
        try {
          const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
            method: 'POST'
          });
          
          const data = await res.json();
          if (data.success) {
            successCount++;
          } else {
            failCount++;
          }
        } catch (error) {
          failCount++;
        }
      }
      
      showToast(`æ‰¹é‡å…é™¤å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡`, 'success');
      selectedRecords.clear();
      updateSelectedCount();
      refreshKunbeiRecords();
    }
    
    function batchSendReminders() {
      // TODO: å®ç°æ‰¹é‡å‚¬æ”¶åŠŸèƒ½
      showToast('æ‰¹é‡å‚¬æ”¶åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
    
    async function forgiveSingleLoan(loanId, username) {
      if (!confirm(`ç¡®è®¤å…é™¤ç”¨æˆ· "${username}" çš„å€Ÿæ¬¾å—ï¼Ÿ\n\nå…é™¤åè¯¥å€Ÿæ¬¾å°†æ ‡è®°ä¸ºå·²è¿˜æ¸…ï¼Œç”¨æˆ·æ— éœ€è¿˜æ¬¾ã€‚`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('å€Ÿæ¬¾å·²å…é™¤', 'success');
          refreshKunbeiRecords();
        } else {
          showToast(data.message || 'å…é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('å…é™¤å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
      }
    }
    
    // ğŸ”¥ è§£é™¤é€¾æœŸæƒ©ç½šï¼ˆè§£å°é«˜çº§åœºç¦å…¥ï¼‰
    async function clearOverduePenaltyBtn(loanId, username) {
      if (!confirm(`ç¡®è®¤è§£é™¤ç”¨æˆ· "${username}" çš„é€¾æœŸæƒ©ç½šå—ï¼Ÿ\n\nè§£å°åè¯¥ç”¨æˆ·å¯ä»¥æ­£å¸¸è¿›å…¥é«˜çº§åœºã€‚\n\næ³¨æ„ï¼šå€Ÿæ¬¾ä»éœ€è¿˜æ¸…ï¼Œåªæ˜¯è§£é™¤ç¦å…¥æƒ©ç½šã€‚`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/clear-penalty`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('âœ… ' + data.message, 'success');
          refreshKunbeiRecords();
        } else {
          showToast(data.message || 'è§£é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('è§£é™¤æƒ©ç½šå¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
      }
    }
    
    function viewLoanDetails(loanId) {
      // TODO: å®ç°æŸ¥çœ‹å€Ÿæ¬¾è¯¦æƒ…åŠŸèƒ½
      showToast('å€Ÿæ¬¾è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
    
    function exportKunbeiRecords() {
      if (kunbeiRecordsFiltered.length === 0) {
        showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•', 'warning');
        return;
      }
      
      // å‡†å¤‡CSVæ•°æ®
      const headers = ['ID', 'LinuxDoç”¨æˆ·', 'å…¬ç›Šç«™ç”¨æˆ·', 'å€Ÿæ¬¾é‡‘é¢($)', 'åº”è¿˜é‡‘é¢($)', 'å€Ÿæ¬¾æ—¶é—´', 'åˆ°æœŸæ—¶é—´', 'çŠ¶æ€'];
      const rows = kunbeiRecordsFiltered.map(record => {
        const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
        const status = record.status === 'active' ? 'å€Ÿæ¬¾ä¸­' 
          : record.status === 'overdue' ? 'å·²é€¾æœŸ'
          : isForgiven ? 'å·²å…é™¤'
          : 'å·²è¿˜æ¬¾';
          
        return [
          record.id,
          record.username,
          record.kyx_username || '-',
          (record.loan_amount / 500000).toFixed(2),
          (record.repay_amount / 500000).toFixed(2),
          new Date(record.borrowed_at).toLocaleString('zh-CN', { hour12: false }),
          new Date(record.due_at).toLocaleString('zh-CN', { hour12: false }),
          status
        ];
      });
      
      // ç”ŸæˆCSVå†…å®¹
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      // ä¸‹è½½æ–‡ä»¶
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kunbei_records_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // ========== æƒé‡é…ç½®ç®¡ç†åŠŸèƒ½ ==========
    
    async function loadWeightConfigs() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          renderWeightConfigsTable(data.data);
        }
      } catch (error) {
        console.error('åŠ è½½æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥', 'error');
      }
    }
    
    function renderWeightConfigsTable(configs) {
      const tbody = document.getElementById('weightConfigsTableBody');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">æš‚æ— æƒé‡é…ç½®</td></tr>';
        return;
      }
      
      tbody.innerHTML = configs.map(config => {
        const usageText = config.usage_count > 0 ? `${config.usage_count}ä¸ªåœºæ¬¡` : 'æœªä½¿ç”¨';
        const canDelete = config.usage_count === 0;
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${config.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${config.config_name}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${config.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="showEditWeightConfigModal(${config.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mr-1">ç¼–è¾‘</button>
              <button onclick="viewWeightConfigDetails(${config.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium mr-1">è¯¦æƒ…</button>
              ${canDelete ? `<button onclick="deleteWeightConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium">åˆ é™¤</button>` : '<span class="text-xs text-slate-400">ä½¿ç”¨ä¸­</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddWeightConfigModal() {
      const modalHtml = `
        <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-purple-600">
              <h3 class="text-xl font-bold text-white">â• æ·»åŠ æƒé‡é…ç½®</h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®åç§° *</label>
                  <input type="text" id="weightConfigName" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ´»åŠ¨é…ç½®" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®æè¿°</label>
                  <textarea id="weightConfigDesc" placeholder="ç®€è¦æè¿°è¿™ä¸ªé…ç½®çš„ç‰¹ç‚¹" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
              </div>
              
              <h4 class="font-bold text-slate-900 mb-4">ç¬¦å·æƒé‡è®¾ç½®</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                <div><label class="text-sm text-slate-700">ğŸµ ç¾ (m)</label><input type="number" id="newWeight_m" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">âš¡ å¤ª (t)</label><input type="number" id="newWeight_t" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ‘€ ä½  (n)</label><input type="number" id="newWeight_n" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ” é¸¡ (j)</label><input type="number" id="newWeight_j" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ€ ç¯®çƒ (lq)</label><input type="number" id="newWeight_lq" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ¬ èƒŒæ™¯ (bj)</label><input type="number" id="newWeight_bj" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ’‡ ä¸­åˆ†å¤´ (zft)</label><input type="number" id="newWeight_zft" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">ğŸ‘– èƒŒå¸¦è£¤ (bdk)</label><input type="number" id="newWeight_bdk" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">âš–ï¸ å¾‹å¸ˆå‡½ (lsh)</label><input type="number" id="newWeight_lsh" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50"></div>
                <div><label class="text-sm text-slate-700">ğŸ’ª ç”·äºº (man)</label><input type="number" id="newWeight_man" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-green-300 rounded-lg bg-green-50"></div>
              </div>
              
              <div class="flex gap-3">
                <button onclick="saveNewWeightConfig()" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                  âœ… åˆ›å»ºé…ç½®
                </button>
                <button onclick="closeWeightConfigModal()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function showEditWeightConfigModal(configId) {
      // å¾…å®ç°ï¼šç¼–è¾‘é…ç½®çš„æ¨¡æ€æ¡†
      showToast('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
    
    function viewWeightConfigDetails(configId) {
      // å¾…å®ç°ï¼šæŸ¥çœ‹é…ç½®è¯¦æƒ…
      showToast('æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
    
    async function saveNewWeightConfig() {
      const configName = document.getElementById('weightConfigName').value.trim();
      if (!configName) {
        showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
        return;
      }

      const data = {
        config_name: configName,
        description: document.getElementById('weightConfigDesc').value.trim(),
        weight_m: parseInt(document.getElementById('newWeight_m').value),
        weight_t: parseInt(document.getElementById('newWeight_t').value),
        weight_n: parseInt(document.getElementById('newWeight_n').value),
        weight_j: parseInt(document.getElementById('newWeight_j').value),
        weight_lq: parseInt(document.getElementById('newWeight_lq').value),
        weight_bj: parseInt(document.getElementById('newWeight_bj').value),
        weight_zft: parseInt(document.getElementById('newWeight_zft').value),
        weight_bdk: parseInt(document.getElementById('newWeight_bdk').value),
        weight_lsh: parseInt(document.getElementById('newWeight_lsh').value),
        weight_man: parseInt(document.getElementById('newWeight_man').value)
      };
      
      try {
        const res = await fetch('/api/admin/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('æƒé‡é…ç½®å·²æ·»åŠ ', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('æ·»åŠ å¤±è´¥', 'error');
      }
    }
    
    async function deleteWeightConfig(configId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æƒé‡é…ç½®å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('é…ç½®å·²åˆ é™¤', 'success');
          loadWeightConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    function closeWeightConfigModal() {
      const modal = document.getElementById('weightConfigModal');
      if (modal) modal.remove();
    }
    
    // ========== å¥–åŠ±é…ç½®ç®¡ç†åŠŸèƒ½ ==========
    
    // ğŸ”§ æ›´æ–°æ‰€æœ‰æˆå°±çš„å¥–åŠ±é¢åº¦
    async function updateAchievementRewards() {
      if (!confirm('ç¡®å®šè¦æ›´æ–°æ‰€æœ‰æˆå°±çš„å¥–åŠ±é¢åº¦å—ï¼Ÿ\n\nå¥–åŠ±æ¢¯åº¦ï¼š\nCommon(æ™®é€š)=$100\nRare(ç¨€æœ‰)=$200\nEpic(å²è¯—)=$500\nLegendary(ä¼ å¥‡)=$1000\nMythic(ç¥è¯)=$2000')) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/update-achievement-rewards', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… æˆåŠŸæ›´æ–° ${data.updated_count} ä¸ªæˆå°±çš„å¥–åŠ±é¢åº¦`, 'success');
          console.log('å¥–åŠ±æ¢¯åº¦:', data.reward_map);
        } else {
          showToast(data.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°æˆå°±å¥–åŠ±å¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥', 'error');
      }
    }
    
    // ğŸ”§ ä¿®å¤Manè§„åˆ™çš„required_symbolså­—æ®µ
    async function fixManRules() {
      if (!confirm('ç¡®å®šè¦ä¿®å¤æ‰€æœ‰Manè§„åˆ™çš„required_symbolså­—æ®µå—ï¼Ÿ\n\nè¿™å°†è‡ªåŠ¨ä¸ºæ‰€æœ‰åç§°åŒ…å«"man/kun/ç”·äºº"çš„è§„åˆ™è®¾ç½®required_symbolsä¸º["man"]')) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/fix-man-rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… æˆåŠŸä¿®å¤ ${data.fixed_count} æ¡Manè§„åˆ™ï¼Œæ¦‚ç‡ç¼“å­˜å·²æ¸…é™¤`, 'success');
          // é‡æ–°åŠ è½½å¥–åŠ±é…ç½®
          loadRewardConfigs();
        } else {
          showToast(data.message || 'ä¿®å¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿®å¤Manè§„åˆ™å¤±è´¥:', error);
        showToast('ä¿®å¤å¤±è´¥', 'error');
      }
    }
    
    async function loadRewardConfigs() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          renderRewardSchemesTable(data.data);
        }
      } catch (error) {
        console.error('åŠ è½½å¥–åŠ±é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥', 'error');
      }
    }
    
    function renderRewardSchemesTable(schemes) {
      const tbody = document.getElementById('rewardSchemesTableBody');
      
      if (!schemes || schemes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">æš‚æ— å¥–åŠ±æ–¹æ¡ˆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = schemes.map(scheme => {
        const usageText = scheme.usage_count > 0 ? `${scheme.usage_count}ä¸ªåœºæ¬¡` : 'æœªä½¿ç”¨';
        const canDelete = scheme.usage_count === 0;
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${scheme.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${scheme.scheme_name}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">${scheme.rules_count}æ¡è§„åˆ™</span>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${scheme.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="editRewardScheme(${scheme.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mr-1">ç¼–è¾‘</button>
              <button onclick="viewSchemeDetails(${scheme.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium mr-1">è¯¦æƒ…</button>
              ${canDelete ? `<button onclick="deleteRewardScheme(${scheme.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium">åˆ é™¤</button>` : '<span class="text-xs text-slate-400">ä½¿ç”¨ä¸­</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddRewardSchemeModal() {
      const modalHtml = `
        <div id="rewardSchemeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-purple-600">
              <h3 class="text-xl font-bold text-white">â• æ·»åŠ å¥–åŠ±æ–¹æ¡ˆ</h3>
            </div>
            <div class="p-6">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆåç§° *</label>
                  <input type="text" id="rewardSchemeName" placeholder="ä¾‹å¦‚ï¼šé«˜å€ç‡æ¨¡å¼" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆæè¿°</label>
                  <textarea id="rewardSchemeDesc" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ–¹æ¡ˆçš„ç‰¹ç‚¹" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="saveNewRewardScheme()" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                  âœ… åˆ›å»ºæ–¹æ¡ˆ
                </button>
                <button onclick="closeRewardSchemeModal()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewRewardScheme() {
      const schemeName = document.getElementById('rewardSchemeName').value.trim();
      if (!schemeName) {
        showToast('è¯·è¾“å…¥æ–¹æ¡ˆåç§°', 'error');
        return;
      }
      
      const data = {
        scheme_name: schemeName,
        description: document.getElementById('rewardSchemeDesc').value.trim()
      };
      
      try {
        const res = await fetch('/api/admin/rewards/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('å¥–åŠ±æ–¹æ¡ˆå·²æ·»åŠ ï¼Œè¯·ç»§ç»­æ·»åŠ è§„åˆ™', 'success');
          closeRewardSchemeModal();
          loadRewardConfigs();
        } else {
          showToast(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ å¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('æ·»åŠ å¤±è´¥', 'error');
      }
    }
    
    function editRewardScheme(schemeId) {
      // å¾…å®ç°ï¼šç¼–è¾‘æ–¹æ¡ˆï¼ˆå«è§„åˆ™ç®¡ç†ï¼‰
      showToast('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨APIæˆ–æ•°æ®åº“ç›´æ¥æ“ä½œ', 'info');
    }
    
    function viewSchemeDetails(schemeId) {
      // å¾…å®ç°ï¼šæŸ¥çœ‹æ–¹æ¡ˆè¯¦æƒ…
      showToast('æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
    
    async function deleteRewardScheme(schemeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¥–åŠ±æ–¹æ¡ˆå—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('æ–¹æ¡ˆå·²åˆ é™¤', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    function closeRewardSchemeModal() {
      const modal = document.getElementById('rewardSchemeModal');
      if (modal) modal.remove();
    }

    // ========== æƒé‡é…ç½®ç®¡ç†åŠŸèƒ½ ==========
    
    async function loadWeightConfigs() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          renderWeightConfigsTable(data.data);
        }
      } catch (error) {
        console.error('åŠ è½½æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½æƒé‡é…ç½®å¤±è´¥', 'error');
      }
    }
    
    function renderWeightConfigsTable(configs) {
      const tbody = document.getElementById('weightConfigsTableBody');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">æš‚æ— æƒé‡é…ç½®</td></tr>';
        return;
      }
      
      tbody.innerHTML = configs.map(config => {
        const usageText = config.usage_count > 0 ? `è¢« ${config.usage_count} ä¸ªåœºæ¬¡ä½¿ç”¨` : 'æœªä½¿ç”¨';
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${config.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${config.config_name}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${config.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="showEditWeightConfigModal(${config.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">ç¼–è¾‘</button>
              <button onclick="viewWeightConfigDetails(${config.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-semibold mr-1">è¯¦æƒ…</button>
              ${config.usage_count === 0 ? `
                <button onclick="deleteWeightConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">åˆ é™¤</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddWeightConfigModal() {
      const modalHtml = `
        <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <h3 class="text-xl font-bold text-slate-900 mb-4">â• æ·»åŠ æƒé‡é…ç½®</h3>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®åç§° *</label>
                  <input type="text" id="weightConfigName" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ´»åŠ¨é…ç½®">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®æè¿°</label>
                  <textarea id="weightConfigDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªé…ç½®çš„ç‰¹ç‚¹"></textarea>
                </div>
                
                <div class="border-t pt-4">
                  <h4 class="font-semibold text-slate-900 mb-3">ç¬¦å·æƒé‡è®¾ç½®</h4>
                  <div class="grid grid-cols-3 gap-3">
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸµ ç¾(m)</label>
                      <input type="number" id="weight_m_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">âš¡ å¤ª(t)</label>
                      <input type="number" id="weight_t_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ‘€ ä½ (n)</label>
                      <input type="number" id="weight_n_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ” é¸¡(j)</label>
                      <input type="number" id="weight_j_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ€ ç¯®çƒ(lq)</label>
                      <input type="number" id="weight_lq_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ¬ èƒŒæ™¯(bj)</label>
                      <input type="number" id="weight_bj_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ’‡ ä¸­åˆ†å¤´(zft)</label>
                      <input type="number" id="weight_zft_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ‘– èƒŒå¸¦è£¤(bdk)</label>
                      <input type="number" id="weight_bdk_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">âš–ï¸ å¾‹å¸ˆå‡½(lsh)</label>
                      <input type="number" id="weight_lsh_new" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded text-sm bg-red-50">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">ğŸ’ª ç”·äºº(man)</label>
                      <input type="number" id="weight_man_new" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-green-300 rounded text-sm bg-green-50">
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex gap-3 mt-6">
                <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å–æ¶ˆ</button>
                <button onclick="saveNewWeightConfig()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">ä¿å­˜</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewWeightConfig() {
      const name = document.getElementById('weightConfigName').value.trim();
      const desc = document.getElementById('weightConfigDesc').value.trim();
      
      if (!name) {
        showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
        return;
      }
      
      const config = {
        config_name: name,
        weight_m: parseInt(document.getElementById('weight_m_new').value),
        weight_t: parseInt(document.getElementById('weight_t_new').value),
        weight_n: parseInt(document.getElementById('weight_n_new').value),
        weight_j: parseInt(document.getElementById('weight_j_new').value),
        weight_lq: parseInt(document.getElementById('weight_lq_new').value),
        weight_bj: parseInt(document.getElementById('weight_bj_new').value),
        weight_zft: parseInt(document.getElementById('weight_zft_new').value),
        weight_bdk: parseInt(document.getElementById('weight_bdk_new').value),
        weight_lsh: parseInt(document.getElementById('weight_lsh_new').value),
        weight_man: parseInt(document.getElementById('weight_man_new').value),
        description: desc
      };
      
      try {
        const res = await fetch('/api/admin/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('æƒé‡é…ç½®å·²æ·»åŠ ', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(data.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('æ·»åŠ å¤±è´¥', 'error');
      }
    }
    
    function closeWeightConfigModal() {
      const modal = document.getElementById('weightConfigModal');
      if (modal) modal.remove();
    }
    
    async function showEditWeightConfigModal(configId) {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½é…ç½®å¤±è´¥', 'error');
          return;
        }
        
        const config = data.data.find(c => c.id === configId);
        if (!config) {
          showToast('é…ç½®ä¸å­˜åœ¨', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">âœï¸ ç¼–è¾‘æƒé‡é…ç½®</h3>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®åç§° *</label>
                    <input type="text" id="editWeightConfigName" value="${config.config_name}" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ´»åŠ¨é…ç½®">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">é…ç½®æè¿°</label>
                    <textarea id="editWeightConfigDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªé…ç½®çš„ç‰¹ç‚¹">${config.description || ''}</textarea>
                  </div>
                  
                  <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">ç¬¦å·æƒé‡è®¾ç½®</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                      <div>
                        <label class="text-xs text-slate-600">ğŸµ ç¾ (m)</label>
                        <input type="number" id="editWeight_m" value="${config.weight_m}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">âš¡ å¤ª (t)</label>
                        <input type="number" id="editWeight_t" value="${config.weight_t}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ‘€ ä½  (n)</label>
                        <input type="number" id="editWeight_n" value="${config.weight_n}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ” é¸¡ (j)</label>
                        <input type="number" id="editWeight_j" value="${config.weight_j}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ€ ç¯®çƒ (lq)</label>
                        <input type="number" id="editWeight_lq" value="${config.weight_lq}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ¬ èƒŒæ™¯ (bj)</label>
                        <input type="number" id="editWeight_bj" value="${config.weight_bj}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ’‡ ä¸­åˆ†å¤´ (zft)</label>
                        <input type="number" id="editWeight_zft" value="${config.weight_zft}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ‘– èƒŒå¸¦è£¤ (bdk)</label>
                        <input type="number" id="editWeight_bdk" value="${config.weight_bdk}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">âš–ï¸ å¾‹å¸ˆå‡½ (lsh)</label>
                        <input type="number" id="editWeight_lsh" value="${config.weight_lsh}" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50 text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">ğŸ’ª ç”·äºº (man)</label>
                        <input type="number" id="editWeight_man" value="${config.weight_man || 25}" min="1" max="1000" class="w-full px-3 py-2 border border-green-300 rounded-lg bg-green-50 text-sm">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å–æ¶ˆ</button>
                  <button onclick="saveEditWeightConfig(${configId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">ä¿å­˜ä¿®æ”¹</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½é…ç½®å¤±è´¥', 'error');
      }
    }
    
    async function saveEditWeightConfig(configId) {
      const configName = document.getElementById('editWeightConfigName').value.trim();
      if (!configName) {
        showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
        return;
      }
      
      const data = {
        config_name: configName,
        description: document.getElementById('editWeightConfigDesc').value.trim(),
        weight_m: parseInt(document.getElementById('editWeight_m').value),
        weight_t: parseInt(document.getElementById('editWeight_t').value),
        weight_n: parseInt(document.getElementById('editWeight_n').value),
        weight_j: parseInt(document.getElementById('editWeight_j').value),
        weight_lq: parseInt(document.getElementById('editWeight_lq').value),
        weight_bj: parseInt(document.getElementById('editWeight_bj').value),
        weight_zft: parseInt(document.getElementById('editWeight_zft').value),
        weight_bdk: parseInt(document.getElementById('editWeight_bdk').value),
        weight_lsh: parseInt(document.getElementById('editWeight_lsh').value),
        weight_man: parseInt(document.getElementById('editWeight_man').value)
      };
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('é…ç½®å·²æ›´æ–°', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(result.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥', 'error');
      }
    }
    
    async function viewWeightConfigDetails(configId) {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½é…ç½®å¤±è´¥', 'error');
          return;
        }
        
        const config = data.data.find(c => c.id === configId);
        if (!config) {
          showToast('é…ç½®ä¸å­˜åœ¨', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">ğŸ“Š æƒé‡é…ç½®è¯¦æƒ…</h3>
                
                <div class="space-y-4">
                  <div class="bg-slate-50 rounded-lg p-4">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div>
                        <span class="text-slate-600">é…ç½®IDï¼š</span>
                        <span class="font-mono font-semibold text-slate-900">#${config.id}</span>
                      </div>
                      <div>
                        <span class="text-slate-600">é…ç½®åç§°ï¼š</span>
                        <span class="font-semibold text-slate-900">${config.config_name}</span>
                      </div>
                      <div class="col-span-2">
                        <span class="text-slate-600">æè¿°ï¼š</span>
                        <span class="text-slate-900">${config.description || 'æ— '}</span>
                      </div>
                      <div>
                        <span class="text-slate-600">ä½¿ç”¨åœºæ¬¡ï¼š</span>
                        <span class="font-semibold ${config.usage_count > 0 ? 'text-green-600' : 'text-slate-400'}">${config.usage_count > 0 ? config.usage_count + 'ä¸ªåœºæ¬¡' : 'æœªä½¿ç”¨'}</span>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">ç¬¦å·æƒé‡æ˜ç»†</h4>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">ğŸµ ç¾ (m)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_m}</div>
                      </div>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">âš¡ å¤ª (t)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_t}</div>
                      </div>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">ğŸ‘€ ä½  (n)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_n}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">ğŸ” é¸¡ (j)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_j}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">ğŸ€ ç¯®çƒ (lq)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_lq}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">ğŸ¬ èƒŒæ™¯ (bj)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_bj}</div>
                      </div>
                      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div class="text-xs text-amber-600 mb-1">ğŸ’‡ ä¸­åˆ†å¤´ (zft)</div>
                        <div class="text-lg font-bold text-amber-900">${config.weight_zft}</div>
                      </div>
                      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div class="text-xs text-amber-600 mb-1">ğŸ‘– èƒŒå¸¦è£¤ (bdk)</div>
                        <div class="text-lg font-bold text-amber-900">${config.weight_bdk}</div>
                      </div>
                      <div class="bg-red-50 border border-red-300 rounded-lg p-3">
                        <div class="text-xs text-red-600 mb-1">âš–ï¸ å¾‹å¸ˆå‡½ (lsh)</div>
                        <div class="text-lg font-bold text-red-900">${config.weight_lsh}</div>
                      </div>
                      <div class="bg-green-50 border border-green-300 rounded-lg p-3">
                        <div class="text-xs text-green-600 mb-1">ğŸ’ª ç”·äºº (man)</div>
                        <div class="text-lg font-bold text-green-900">${config.weight_man || 25}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å…³é—­</button>
                  <button onclick="closeWeightConfigModal(); showEditWeightConfigModal(${configId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">ç¼–è¾‘é…ç½®</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('åŠ è½½é…ç½®è¯¦æƒ…å¤±è´¥:', error);
        showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
      }
    }
    
    async function deleteWeightConfig(configId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æƒé‡é…ç½®å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('é…ç½®å·²åˆ é™¤', 'success');
          loadWeightConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤æƒé‡é…ç½®å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    // ========== å¥–åŠ±é…ç½®ç®¡ç†åŠŸèƒ½ ==========
    
    async function loadRewardConfigs() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          renderRewardSchemesTable(data.data);
        }
      } catch (error) {
        console.error('åŠ è½½å¥–åŠ±é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½å¥–åŠ±é…ç½®å¤±è´¥', 'error');
      }
    }
    
    function renderRewardSchemesTable(schemes) {
      const tbody = document.getElementById('rewardSchemesTableBody');
      
      if (!schemes || schemes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">æš‚æ— å¥–åŠ±æ–¹æ¡ˆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = schemes.map(scheme => {
        const usageText = scheme.usage_count > 0 ? `è¢« ${scheme.usage_count} ä¸ªåœºæ¬¡ä½¿ç”¨` : 'æœªä½¿ç”¨';
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${scheme.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${scheme.scheme_name}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">${scheme.rules_count}æ¡</span>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${scheme.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="editRewardScheme(${scheme.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">ç¼–è¾‘</button>
              <button onclick="viewRewardSchemeDetails(${scheme.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-semibold mr-1">è¯¦æƒ…</button>
              ${scheme.usage_count === 0 ? `
                <button onclick="deleteRewardScheme(${scheme.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">åˆ é™¤</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddRewardSchemeModal() {
      const modalHtml = `
        <div id="rewardSchemeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
              <h3 class="text-xl font-bold text-slate-900 mb-4">â• æ·»åŠ å¥–åŠ±æ–¹æ¡ˆ</h3>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆåç§° *</label>
                  <input type="text" id="rewardSchemeName" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šåˆçº§åœºæ ‡å‡†">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆæè¿°</label>
                  <textarea id="rewardSchemeDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ–¹æ¡ˆçš„ç‰¹ç‚¹"></textarea>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeRewardSchemeModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å–æ¶ˆ</button>
                <button onclick="saveNewRewardScheme()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">åˆ›å»º</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewRewardScheme() {
      const name = document.getElementById('rewardSchemeName').value.trim();
      const desc = document.getElementById('rewardSchemeDesc').value.trim();
      
      if (!name) {
        showToast('è¯·è¾“å…¥æ–¹æ¡ˆåç§°', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scheme_name: name, description: desc })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('å¥–åŠ±æ–¹æ¡ˆå·²åˆ›å»ºï¼Œç°åœ¨å¯ä»¥æ·»åŠ è§„åˆ™', 'success');
          closeRewardSchemeModal();
          loadRewardConfigs();
        } else {
          showToast(data.message || 'åˆ›å»ºå¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ›å»ºå¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('åˆ›å»ºå¤±è´¥', 'error');
      }
    }
    
    function closeRewardSchemeModal() {
      const modal = document.getElementById('rewardSchemeModal');
      if (modal) modal.remove();
    }
    
    async function editRewardScheme(schemeId) {
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½æ–¹æ¡ˆå¤±è´¥', 'error');
          return;
        }
        
        const { scheme, rules, punishments } = data.data;
        const safePunishments = punishments || [];
        
        const modalHtml = `
          <div id="rewardSchemeEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 border-b border-slate-200 z-10">
                <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">âœï¸ ç¼–è¾‘å¥–åŠ±æ–¹æ¡ˆï¼š${scheme.scheme_name}</h3>
                  <button onclick="closeRewardSchemeEditModal()" class="text-white hover:text-slate-200 text-2xl font-bold">&times;</button>
                </div>
              </div>
              
              <div class="p-6">
                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-5">
                  <h4 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“</span>
                    åŸºç¡€ä¿¡æ¯
                  </h4>
                  <div class="grid grid-cols-1 gap-4 bg-white p-4 rounded-lg border border-slate-200">
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆåç§° *</label>
                      <input type="text" id="editSchemeName" value="${scheme.scheme_name}" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-2">æ–¹æ¡ˆæè¿°</label>
                      <textarea id="editSchemeDesc" rows="2" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">${scheme.description || ''}</textarea>
                    </div>
                  </div>
                  <button onclick="updateSchemeBasicInfo(${schemeId})" class="mt-3 px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all">
                    ğŸ’¾ ä¿å­˜åŸºç¡€ä¿¡æ¯
                  </button>
                </div>
                
                <!-- è§„åˆ™åˆ—è¡¨ -->
                <div class="mb-6">
                  <div class="flex justify-between items-center mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border-2 border-indigo-200">
                    <h4 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                      <span class="text-2xl">ğŸ¯</span>
                      ä¸­å¥–è§„åˆ™ 
                      <span class="px-3 py-1 bg-indigo-500 text-white rounded-full text-sm">${rules.length}æ¡</span>
                    </h4>
                    <button onclick="showAddRuleModal(${schemeId})" class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all hover:scale-105 flex items-center gap-2">
                      <span class="text-lg">â•</span> ä»æ¨¡æ¿æ·»åŠ 
                    </button>
                  </div>
                  
                  <div class="space-y-3" id="rulesList">
                    ${rules.length === 0 ? '<div class="text-center py-8 text-slate-500 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»ä¸Šæ–¹"â• ä»æ¨¡æ¿æ·»åŠ "é€‰æ‹©é¢„è®¾è§„åˆ™</div>' : rules.map(rule => `
                      <div class="bg-gradient-to-r from-slate-50 to-indigo-50 border-2 border-indigo-200 rounded-lg p-4 hover:shadow-lg transition-all hover:border-indigo-400">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-3">
                              <span class="text-lg font-bold text-slate-900">${rule.rule_name}</span>
                              <span class="px-2 py-1 text-xs rounded font-semibold ${rule.is_active ? 'bg-green-500 text-white' : 'bg-slate-400 text-white'}">${rule.is_active ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨'}</span>
                              ${rule.rule_category === 'jackpot' ? '<span class="px-2 py-1 text-xs rounded bg-yellow-500 text-white font-semibold">ğŸ† å¤§å¥–</span>' : ''}
                              ${rule.rule_category === 'high' ? '<span class="px-2 py-1 text-xs rounded bg-purple-500 text-white font-semibold">ğŸ’ é«˜çº§</span>' : ''}
                              ${rule.rule_category === 'medium' ? '<span class="px-2 py-1 text-xs rounded bg-blue-500 text-white font-semibold">ğŸ¯ ä¸­ç­‰</span>' : ''}
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                              <div class="flex items-center gap-2">
                                <span class="text-slate-500">æ¨¡å¼ï¼š</span>
                                <span class="font-mono text-slate-900 bg-white px-2 py-0.5 rounded border">${rule.match_pattern}</span>
                              </div>
                              ${rule.match_count ? `<div class="flex items-center gap-2"><span class="text-slate-500">åŒ¹é…æ•°ï¼š</span><span class="font-semibold text-slate-900">${rule.match_count}</span></div>` : ''}
                              ${rule.required_symbols ? `<div class="flex items-center gap-2"><span class="text-slate-500">ç¬¦å·ï¼š</span><span class="font-mono text-indigo-700 bg-white px-2 py-0.5 rounded border">${rule.required_symbols}</span></div>` : ''}
                              <div class="flex items-center gap-2">
                                <span class="text-slate-500">å€ç‡ï¼š</span>
                                <span class="font-bold text-green-600 text-lg bg-green-50 px-2 py-0.5 rounded">${rule.win_multiplier}x</span>
                              </div>
                              ${rule.grant_free_spin > 0 ? `<div class="flex items-center gap-2"><span class="text-slate-500">å…è´¹è½¬ï¼š</span><span class="font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded">+${rule.grant_free_spin}æ¬¡</span></div>` : ''}
                              ${rule.priority ? `<div class="flex items-center gap-2"><span class="text-slate-500">ä¼˜å…ˆçº§ï¼š</span><span class="font-semibold text-purple-700">${rule.priority}</span></div>` : ''}
                            </div>
                            ${rule.description ? `<div class="text-xs text-slate-600 italic mt-2 bg-white px-3 py-1 rounded border border-slate-200">${rule.description}</div>` : ''}
                          </div>
                          <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editRule(${rule.id}, ${schemeId})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-semibold transition-colors whitespace-nowrap">âœï¸ ç¼–è¾‘</button>
                            <button onclick="deleteRule(${rule.id}, ${schemeId})" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-semibold transition-colors whitespace-nowrap">ğŸ—‘ï¸ åˆ é™¤</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- å¾‹å¸ˆå‡½æƒ©ç½šé…ç½® -->
                <div class="mb-6">
                  <div class="flex justify-between items-center mb-4 bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border-2 border-red-200">
                    <h4 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                      <span class="text-2xl">âš–ï¸</span>
                      å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®
                      <span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm">${safePunishments.length}é¡¹</span>
                    </h4>
                    <button onclick="applyDefaultPunishment(${schemeId})" class="px-5 py-2 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all hover:scale-105">
                      âš¡ åº”ç”¨é»˜è®¤æƒ©ç½š
                    </button>
                  </div>
                  
                  <div id="punishmentConfigList" class="space-y-2">
                    ${safePunishments.length === 0 ? '<div class="text-center py-8 text-slate-500 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">æš‚æ— å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®ï¼Œç‚¹å‡»"âš¡ åº”ç”¨é»˜è®¤æƒ©ç½š"å¿«é€Ÿæ·»åŠ </div>' : safePunishments.map(p => `
                      <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-md transition-all">
                        <div class="flex justify-between items-center">
                          <div class="flex-1 flex items-center gap-3">
                            <span class="text-2xl">âš–ï¸</span>
                            <div>
                              <div class="font-bold text-red-900 text-lg">${p.lsh_count}ä¸ªå¾‹å¸ˆå‡½</div>
                              <div class="text-sm text-slate-600 mt-1">
                                æ‰£é™¤ <span class="font-bold text-red-700">${p.deduct_multiplier}å€</span> æŠ•æ³¨é¢
                                ${p.ban_hours > 0 ? `<span class="ml-2 px-2 py-0.5 bg-orange-500 text-white rounded text-xs">ğŸ”’ å°ç¦${p.ban_hours}å°æ—¶</span>` : '<span class="ml-2 px-2 py-0.5 bg-green-500 text-white rounded text-xs">âœ“ ä¸å°ç¦</span>'}
                              </div>
                            </div>
                          </div>
                          <div class="flex gap-2">
                            <button onclick="editPunishment(${p.lsh_count}, ${p.deduct_multiplier}, ${p.ban_hours}, ${schemeId})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">âœï¸ ç¼–è¾‘</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6 sticky bottom-0 bg-gradient-to-r from-slate-50 to-slate-100 pt-4 pb-2 border-t-2 border-slate-300 rounded-b-xl">
                  <button onclick="closeRewardSchemeEditModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                    âœ• å…³é—­
                  </button>
                  <button onclick="closeRewardSchemeEditModal(); viewRewardSchemeDetails(${schemeId})" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                    ğŸ‘ï¸ æŸ¥çœ‹å®Œæ•´è¯¦æƒ…
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('åŠ è½½æ–¹æ¡ˆå¤±è´¥', 'error');
      }
    }
    
    async function updateSchemeBasicInfo(schemeId) {
      const name = document.getElementById('editSchemeName').value.trim();
      if (!name) {
        showToast('è¯·è¾“å…¥æ–¹æ¡ˆåç§°', 'error');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_name: name,
            description: document.getElementById('editSchemeDesc').value.trim()
          })
        });
        
        const data = await res.json();
        if (data.success) {
          showToast('åŸºç¡€ä¿¡æ¯å·²æ›´æ–°', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥', 'error');
      }
    }
    
    function closeRewardSchemeEditModal() {
      const modal = document.getElementById('rewardSchemeEditModal');
      if (modal) modal.remove();
    }
    
    // é»˜è®¤å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®
    const DEFAULT_PUNISHMENT_CONFIG = [
      { lsh_count: 1, deduct_multiplier: 1, ban_hours: 0 },
      { lsh_count: 2, deduct_multiplier: 2, ban_hours: 0 },
      { lsh_count: 3, deduct_multiplier: 3, ban_hours: 60 },
      { lsh_count: 4, deduct_multiplier: 4, ban_hours: 60 }
    ];
    
    async function applyDefaultPunishment(schemeId) {
      if (!confirm('ç¡®å®šè¦åº”ç”¨é»˜è®¤å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®å—ï¼Ÿ\n\né»˜è®¤é…ç½®ï¼š\nâ€¢ 1ä¸ªå¾‹å¸ˆå‡½ï¼šæ‰£1å€ï¼Œä¸å°ç¦\nâ€¢ 2ä¸ªå¾‹å¸ˆå‡½ï¼šæ‰£2å€ï¼Œä¸å°ç¦\nâ€¢ 3ä¸ªå¾‹å¸ˆå‡½ï¼šæ‰£3å€ï¼Œå°ç¦60å°æ—¶\nâ€¢ 4ä¸ªå¾‹å¸ˆå‡½ï¼šæ‰£4å€ï¼Œå°ç¦60å°æ—¶')) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/punishments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_id: schemeId,
            punishments: DEFAULT_PUNISHMENT_CONFIG
          })
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('é»˜è®¤æƒ©ç½šé…ç½®å·²åº”ç”¨', 'success');
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || 'åº”ç”¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åº”ç”¨é»˜è®¤æƒ©ç½šé…ç½®å¤±è´¥:', error);
        showToast('åº”ç”¨å¤±è´¥', 'error');
      }
    }
    
    async function editPunishment(lshCount, deductMultiplier, banHours, schemeId) {
      const modalHtml = `
        <div id="editPunishmentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4 backdrop-blur-sm">
          <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-fadeIn">
            <div class="bg-gradient-to-r from-red-600 via-orange-600 to-red-600 p-6 border-b border-slate-200">
              <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                  âš–ï¸ ç¼–è¾‘å¾‹å¸ˆå‡½æƒ©ç½š
                </h3>
                <button onclick="closeEditPunishmentModal()" class="text-white hover:text-slate-200 text-3xl font-bold transition-colors">&times;</button>
            </div>
              </div>
            <div class="p-6 space-y-5">
              <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">âš ï¸</span>
                <div>
                    <p class="text-sm font-semibold text-amber-900">é…ç½®æƒ©ç½šå‚æ•°</p>
                    <p class="text-xs text-amber-800 mt-1">å½“ç©å®¶æŠ½åˆ° <strong class="text-red-700">${lshCount}ä¸ªå¾‹å¸ˆå‡½</strong> æ—¶è§¦å‘ä»¥ä¸‹æƒ©ç½š</p>
                </div>
                </div>
              </div>
              
              <div class="bg-slate-50 p-4 rounded-xl border-2 border-slate-200">
                <label class="block text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                  <span class="text-xl">ğŸ’¸</span>
                  æ‰£é™¤å€ç‡ *
                </label>
                <div class="flex items-center gap-3">
                  <input type="number" id="editPunishmentMultiplier" value="${deductMultiplier}" min="0" step="0.1" class="flex-1 px-4 py-3 border-2 border-slate-300 rounded-lg text-lg font-bold focus:border-red-500 focus:ring-2 focus:ring-red-200 transition-all">
                  <span class="text-lg font-semibold text-slate-600">å€</span>
                </div>
                <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                  <span>ğŸ’¡</span>
                  ä¾‹å¦‚ï¼šè®¾ç½®ä¸º <strong>1</strong> è¡¨ç¤ºæ‰£é™¤ <strong>1å€</strong> æŠ•æ³¨é¢
                </p>
              </div>
              
              <div class="bg-slate-50 p-4 rounded-xl border-2 border-slate-200">
                <label class="block text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                  <span class="text-xl">ğŸ”’</span>
                  å°ç¦æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
                </label>
                <div class="flex items-center gap-3">
                  <input type="number" id="editPunishmentBanHours" value="${banHours}" min="0" step="1" class="flex-1 px-4 py-3 border-2 border-slate-300 rounded-lg text-lg font-bold focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                  <span class="text-lg font-semibold text-slate-600">å°æ—¶</span>
                </div>
                <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                  <span>ğŸ’¡</span>
                  <strong>0</strong> è¡¨ç¤ºä¸å°ç¦ï¼Œå»ºè®® <strong>3-4ä¸ªå¾‹å¸ˆå‡½</strong> è®¾ç½® <strong class="text-orange-600">60å°æ—¶</strong>
                </p>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeEditPunishmentModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  âœ• å–æ¶ˆ
                </button>
                <button onclick="savePunishmentEdit(${lshCount}, ${schemeId})" class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  ğŸ’¾ ä¿å­˜
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function savePunishmentEdit(lshCount, schemeId) {
      const deductMultiplier = parseFloat(document.getElementById('editPunishmentMultiplier').value);
      const banHours = parseInt(document.getElementById('editPunishmentBanHours').value) || 0;
      
      if (isNaN(deductMultiplier) || deductMultiplier < 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰£é™¤å€ç‡', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/punishments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_id: schemeId,
            punishments: [{ lsh_count: lshCount, deduct_multiplier: deductMultiplier, ban_hours: banHours, is_active: 1 }]
          })
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('æƒ©ç½šé…ç½®å·²æ›´æ–°', 'success');
          closeEditPunishmentModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°æƒ©ç½šé…ç½®å¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥', 'error');
      }
    }
    
    function closeEditPunishmentModal() {
      const modal = document.getElementById('editPunishmentModal');
      if (modal) modal.remove();
    }
    
    // é¢„è®¾è§„åˆ™æ¨¡æ¿
    const RULE_TEMPLATES = [
      {
        id: 'jntm_sequence',
        name: 'ğŸ¯ æŒ‰é¡ºåºJNTM',
        description: 'å¿…é¡»æŒ‰ç…§ jâ†’nâ†’tâ†’m é¡ºåºå‡ºç°',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'sequence',
        required_symbols: '["j","n","t","m"]',
        match_count: 4,
        win_multiplier: 256,
        grant_free_spin: 0,
        priority: 100,
        emoji: 'ğŸ¯'
      },
      {
        id: 'jntm_any',
        name: 'â­ ä¸æŒ‰é¡ºåºJNTM',
        description: 'åŒ…å« jã€nã€tã€m å››ä¸ªç¬¦å·å³å¯ï¼Œé¡ºåºä¸é™',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'combination',
        required_symbols: '["j","n","t","m"]',
        match_count: 4,
        win_multiplier: 16,
        grant_free_spin: 0,
        priority: 90,
        emoji: 'â­'
      },
      {
        id: 'bzlq_sequence',
        name: 'ğŸ”¥ æŒ‰é¡ºåºBJâ†’ZFTâ†’BDKâ†’LQ',
        description: 'å¿…é¡»æŒ‰ç…§ bjâ†’zftâ†’bdkâ†’lq é¡ºåºå‡ºç°',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'sequence',
        required_symbols: '["bj","zft","bdk","lq"]',
        match_count: 4,
        win_multiplier: 256,
        grant_free_spin: 0,
        priority: 100,
        emoji: 'ğŸ”¥'
      },
      {
        id: 'bzlq_any',
        name: 'ğŸ’« ä¸æŒ‰é¡ºåºBJâ†’ZFTâ†’BDKâ†’LQ',
        description: 'åŒ…å« bjã€zftã€bdkã€lq å››ä¸ªç¬¦å·å³å¯',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'combination',
        required_symbols: '["bj","zft","bdk","lq"]',
        match_count: 4,
        win_multiplier: 16,
        grant_free_spin: 0,
        priority: 90,
        emoji: 'ğŸ’«'
      },
      {
        id: '4_consecutive',
        name: 'ğŸ æ™®é€š4è¿',
        description: 'ä»»æ„4ä¸ªç›¸åŒç¬¦å·è¿ç»­å‡ºç°',
        category: 'high',
        rule_type: 'match',
        match_pattern: '4-consecutive',
        required_symbols: null,
        match_count: 4,
        win_multiplier: 32,
        grant_free_spin: 1,
        priority: 80,
        emoji: 'ğŸ'
      },
      {
        id: 'man_quad',
        name: 'ğŸ’ª Manå››è¿',
        description: '4ä¸ªmanç¬¦å·è¿ç»­å‡ºç°ï¼Œ25å€ç‹¬ç«‹å¥–åŠ±ï¼ˆä¸å¯ä¸å…¶ä»–è§„åˆ™ç»„åˆï¼‰',
        category: 'special',
        rule_type: 'match',
        match_pattern: '4-consecutive',
        required_symbols: '["man"]',
        match_count: 4,
        win_multiplier: 25,
        grant_free_spin: 0,
        priority: 85,
        emoji: 'ğŸ’ª'
      },
      {
        id: 'man_triple',
        name: 'ğŸ¦¸ Manä¸‰è¿',
        description: '3ä¸ªmanç¬¦å·è¿ç»­å‡ºç°ï¼Œ10å€ï¼ˆç”±äºåªå‰©1ä¸ªä½ç½®ï¼Œå®é™…æ— æ³•ä¸å…¶ä»–è§„åˆ™ç»„åˆï¼‰',
        category: 'special',
        rule_type: 'match',
        match_pattern: '3-consecutive',
        required_symbols: '["man"]',
        match_count: 3,
        win_multiplier: 10,
        grant_free_spin: 0,
        priority: 75,
        emoji: 'ğŸ¦¸'
      },
      {
        id: 'man_double_strict',
        name: 'ğŸ‹ï¸ Manä¸¥æ ¼äºŒè¿',
        description: '2ä¸ªmanç¬¦å·è¿ç»­å‡ºç°ï¼Œ5å€ï¼ˆå¯ä¸å…¶ä»–è§„åˆ™ç»„åˆåŠ æˆï¼‰',
        category: 'special',
        rule_type: 'match',
        match_pattern: '2-consecutive',
        required_symbols: '["man"]',
        match_count: 2,
        win_multiplier: 5,
        grant_free_spin: 0,
        priority: 45,
        emoji: 'ğŸ‹ï¸'
      },
      {
        id: '3_consecutive_strict',
        name: 'ğŸ’ ä¸¥æ ¼3è¿',
        description: 'ä»»æ„3ä¸ªç›¸åŒç¬¦å·è¿ç»­å‡ºç°ï¼ˆä¸¥æ ¼ç›¸é‚»ï¼‰',
        category: 'medium',
        rule_type: 'match',
        match_pattern: '3-consecutive',
        required_symbols: null,
        match_count: 3,
        win_multiplier: 12,
        grant_free_spin: 0,
        priority: 70,
        emoji: 'ğŸ’'
      },
      {
        id: '3_any',
        name: 'ğŸ² æ™®é€š3è¿',
        description: 'ä»»æ„3ä¸ªç›¸åŒç¬¦å·ï¼ˆä½ç½®ä¸é™ï¼‰',
        category: 'medium',
        rule_type: 'match',
        match_pattern: '3-any',
        required_symbols: null,
        match_count: 3,
        win_multiplier: 8,
        grant_free_spin: 0,
        priority: 60,
        emoji: 'ğŸ²'
      },
      {
        id: 'symmetric',
        name: 'ğŸ”„ å¯¹ç§°å¥–åŠ±ï¼ˆABBAï¼‰',
        description: 'å‰åå¯¹ç§°æ ¼å¼ï¼ˆABBAï¼šé¦–å°¾ç›¸åŒï¼Œä¸­é—´ç›¸åŒï¼Œå¦‚JTTJï¼‰',
        category: 'normal',
        rule_type: 'match',
        match_pattern: 'symmetric',
        required_symbols: null,
        match_count: 4,
        win_multiplier: 10,
        grant_free_spin: 0,
        priority: 56,
        emoji: 'ğŸ”„'
      },
      {
        id: 'double_pair',
        name: 'ğŸ° ä¸¤å¯¹ä¸¥æ ¼2è¿',
        description: 'ä¸¤å¯¹ä¸åŒç¬¦å·å„è‡ªè¿ç»­ï¼ˆMMNNæˆ–NNMMæ ¼å¼ï¼Œæ’é™¤4è¿å’Œäº¤é”™æ ¼å¼MNMNï¼‰',
        category: 'normal',
        rule_type: 'match',
        match_pattern: 'double_pair',
        required_symbols: null,
        match_count: 4,
        win_multiplier: 5,
        grant_free_spin: 0,
        priority: 50,
        emoji: 'ğŸ°'
      },
      {
        id: '2_consecutive',
        name: 'ğŸŒŸ ä¸¥æ ¼2è¿',
        description: 'ä»»æ„2ä¸ªç›¸åŒç¬¦å·è¿ç»­å‡ºç°',
        category: 'normal',
        rule_type: 'match',
        match_pattern: '2-consecutive',
        required_symbols: null,
        match_count: 2,
        win_multiplier: 3,
        grant_free_spin: 0,
        priority: 40,
        emoji: 'ğŸŒŸ'
      },
      {
        id: '2_any',
        name: 'âœ¨ æ™®é€š2è¿',
        description: 'ä»»æ„2ä¸ªç›¸åŒç¬¦å·ï¼ˆä½ç½®ä¸é™ï¼‰',
        category: 'normal',
        rule_type: 'match',
        match_pattern: '2-any',
        required_symbols: null,
        match_count: 2,
        win_multiplier: 2,
        grant_free_spin: 0,
        priority: 30,
        emoji: 'âœ¨'
      }
    ];

    async function showAddRuleModal(schemeId) {
      // ğŸ” å…ˆè·å–å½“å‰æ–¹æ¡ˆçš„è§„åˆ™åˆ—è¡¨ï¼Œæ£€æŸ¥å“ªäº›å·²æ·»åŠ 
      let existingRules = [];
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        if (data.success && data.data.rules) {
          existingRules = data.data.rules;
        }
      } catch (error) {
        console.error('è·å–è§„åˆ™åˆ—è¡¨å¤±è´¥:', error);
      }
      
      // åˆ›å»ºå·²æ·»åŠ è§„åˆ™åç§°çš„Setï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
      const existingRuleNames = new Set(existingRules.map(r => r.rule_name));
      
      const modalHtml = `
        <div id="addRuleModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4 overflow-y-auto backdrop-blur-sm">
          <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto my-8 animate-fadeIn">
            <div class="sticky top-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6 border-b border-slate-200 z-10">
              <div class="flex justify-between items-center">
              <div>
                  <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                    âœ¨ é€‰æ‹©é¢„è®¾è§„åˆ™æ¨¡æ¿
                  </h3>
                  <p class="text-indigo-100 text-sm mt-1">ä¸€é”®æ·»åŠ ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å¤æ‚å‚æ•°</p>
                </div>
                <button onclick="closeAddRuleModal()" class="text-white hover:text-slate-200 text-3xl font-bold transition-colors">&times;</button>
              </div>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                ${RULE_TEMPLATES.map(template => {
                  const isAdded = existingRuleNames.has(template.name);
                  return `
                  <div class="relative bg-gradient-to-br from-white to-slate-50 border-2 ${isAdded ? 'border-green-300 bg-green-50' : 'border-slate-200'} rounded-xl p-5 ${isAdded ? 'opacity-75' : 'hover:border-indigo-500 hover:shadow-2xl cursor-pointer transform hover:-translate-y-1'} transition-all group" onclick="selectRuleTemplate('${template.id}', ${schemeId}, ${isAdded})">
                    ${isAdded ? '<div class="absolute top-2 left-2 z-10"><span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-bold shadow-lg">âœ“ å·²æ·»åŠ </span></div>' : ''}
                    <div class="absolute top-3 right-3 text-4xl opacity-20 group-hover:opacity-40 transition-opacity">${template.emoji}</div>
                    <div class="flex items-start gap-4 ${isAdded ? 'mt-6' : ''}">
                      <div class="text-4xl ${isAdded ? '' : 'group-hover:scale-110'} transition-transform">${template.emoji}</div>
                      <div class="flex-1">
                        <h4 class="font-bold text-lg ${isAdded ? 'text-slate-600' : 'text-slate-900 group-hover:text-indigo-600'} mb-2 transition-colors">${template.name}</h4>
                        <p class="text-sm text-slate-600 mb-3 leading-relaxed">${template.description}</p>
                        <div class="flex flex-wrap gap-2">
                          <span class="px-3 py-1 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 rounded-full text-xs font-semibold shadow-sm">
                            ğŸ¯ ä¼˜å…ˆçº§ ${template.priority}
                          </span>
                          <span class="px-3 py-1 bg-gradient-to-r from-green-100 to-green-200 text-green-800 rounded-full text-xs font-bold shadow-sm">
                            ğŸ’° å€ç‡ ${template.win_multiplier}x
                          </span>
                          ${template.grant_free_spin > 0 ? `<span class="px-3 py-1 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 rounded-full text-xs font-semibold shadow-sm">ğŸ +${template.grant_free_spin}æ¬¡å…è´¹</span>` : ''}
                        </div>
                      </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-200 text-center">
                      <span class="text-xs ${isAdded ? 'text-green-600 font-bold' : 'text-slate-500 group-hover:text-indigo-600 font-medium'} transition-colors">${isAdded ? 'âœ“ æ­¤è§„åˆ™å·²åœ¨æ–¹æ¡ˆä¸­' : 'ç‚¹å‡»æ·»åŠ  â†’'}</span>
                    </div>
                  </div>
                  `;
                }).join('')}
              </div>
              
              <div class="mt-6 p-5 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ’¡</span>
              <div>
                    <p class="text-sm text-amber-900 font-semibold mb-1">ä½¿ç”¨æç¤º</p>
                    <ul class="text-sm text-amber-800 space-y-1">
                      <li>â€¢ ç‚¹å‡»æœªæ·»åŠ çš„æ¨¡æ¿å¡ç‰‡å³å¯å¿«é€Ÿæ·»åŠ åˆ°æ–¹æ¡ˆä¸­</li>
                      <li>â€¢ å·²æ·»åŠ çš„è§„åˆ™ä¼šæ˜¾ç¤º"âœ“ å·²æ·»åŠ "æ ‡è®°</li>
                      <li>â€¢ æ¯ä¸ªè§„åˆ™åªèƒ½æ·»åŠ ä¸€æ¬¡ï¼Œé¿å…é‡å¤é…ç½®</li>
                      <li>â€¢ æ·»åŠ åå¯åœ¨è§„åˆ™åˆ—è¡¨ä¸­ç¼–è¾‘å€ç‡ç­‰å‚æ•°</li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeAddRuleModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  âœ• å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function selectRuleTemplate(templateId, schemeId, isAdded) {
      // ğŸš« å¦‚æœè§„åˆ™å·²æ·»åŠ ï¼Œæç¤ºç”¨æˆ·
      if (isAdded) {
        showToast('âš ï¸ è¯¥è§„åˆ™å·²æ·»åŠ åˆ°æ–¹æ¡ˆä¸­ï¼Œä¸èƒ½é‡å¤æ·»åŠ ', 'warning');
        return;
      }
      
      const template = RULE_TEMPLATES.find(t => t.id === templateId);
      if (!template) {
        showToast('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
        return;
      }
      
      const data = {
        scheme_id: schemeId,
        rule_name: template.name,
        rule_type: template.rule_type,
        rule_category: template.category,
        match_pattern: template.match_pattern,
        match_count: template.match_count,
        required_symbols: template.required_symbols,
        win_multiplier: template.win_multiplier,
        grant_free_spin: template.grant_free_spin,
        priority: template.priority,
        description: template.description
      };
      
      try {
        const res = await fetch('/api/admin/rewards/rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('è§„åˆ™å·²æ·»åŠ ', 'success');
          closeAddRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ è§„åˆ™å¤±è´¥:', error);
        showToast('æ·»åŠ å¤±è´¥', 'error');
      }
    }
    
    async function saveNewRule(schemeId) {
      const ruleName = document.getElementById('newRuleName').value.trim();
      const matchPattern = document.getElementById('newMatchPattern').value.trim();
      const winMultiplier = parseFloat(document.getElementById('newWinMultiplier').value);
      
      if (!ruleName || !matchPattern || isNaN(winMultiplier)) {
        showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'error');
        return;
      }
      
      // ğŸ”¥ å¤„ç† required_symbolsï¼šç»Ÿä¸€è½¬æ¢ä¸º JSON æ•°ç»„æ ¼å¼
      let requiredSymbols = document.getElementById('newRequiredSymbols').value.trim() || null;
      if (requiredSymbols) {
        // å¦‚æœæ˜¯é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸º JSON æ•°ç»„
        if (!requiredSymbols.startsWith('[')) {
          const symbolsArray = requiredSymbols.split(',').map(s => s.trim()).filter(s => s);
          requiredSymbols = JSON.stringify(symbolsArray);
        }
      }
      
      const data = {
        scheme_id: schemeId,
        rule_name: ruleName,
        rule_type: document.getElementById('newRuleType').value,
        rule_category: document.getElementById('newRuleCategory').value || null,
        match_pattern: matchPattern,
        match_count: parseInt(document.getElementById('newMatchCount').value) || null,
        required_symbols: requiredSymbols,
        win_multiplier: winMultiplier,
        grant_free_spin: parseInt(document.getElementById('newGrantFreeSpin').value) || 0,
        description: document.getElementById('newRuleDescription').value.trim() || null
      };
      
      try {
        const res = await fetch('/api/admin/rewards/rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('è§„åˆ™å·²æ·»åŠ ', 'success');
          closeAddRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ è§„åˆ™å¤±è´¥:', error);
        showToast('æ·»åŠ å¤±è´¥', 'error');
      }
    }
    
    function closeAddRuleModal() {
      const modal = document.getElementById('addRuleModal');
      if (modal) modal.remove();
    }
    
    async function editRule(ruleId, schemeId) {
      // è·å–è§„åˆ™è¯¦æƒ…å¹¶æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        if (!data.success) {
          showToast('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
          return;
        }
        
        const rule = data.data.rules.find(r => r.id === ruleId);
        if (!rule) {
          showToast('è§„åˆ™ä¸å­˜åœ¨', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="editRuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="p-6 border-b border-slate-200 bg-blue-600">
                <h3 class="text-xl font-bold text-white">âœï¸ ç¼–è¾‘è§„åˆ™</h3>
              </div>
              <div class="p-6 space-y-5">
                <!-- æç¤ºä¿¡æ¯ -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                  <p class="text-sm text-blue-800">
                    <span class="font-semibold">ğŸ’¡ æç¤ºï¼š</span> åªèƒ½ä¿®æ”¹åŸºæœ¬å‚æ•°ï¼Œè§„åˆ™æ ¸å¿ƒé…ç½®å·²é”å®š
                  </p>
                </div>
                
                <!-- éšè—å­—æ®µï¼Œä¿å­˜æ—¶éœ€è¦ï¼ˆä½¿ç”¨ JS å®‰å…¨è®¾ç½®å€¼ï¼‰ -->
                <input type="hidden" id="editRuleType">
                <input type="hidden" id="editRuleCategory">
                <input type="hidden" id="editMatchPattern">
                <input type="hidden" id="editMatchCount">
                <input type="hidden" id="editRequiredSymbols">
                
                <!-- è§„åˆ™åç§° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">è§„åˆ™åç§° *</label>
                  <input type="text" id="editRuleName" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                
                <!-- ä¸­å¥–å€ç‡ã€å…è´¹è½¬å’Œä¼˜å…ˆçº§ -->
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä¸­å¥–å€ç‡ *</label>
                    <input type="number" id="editWinMultiplier" step="0.1" min="0" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">èµ é€å…è´¹è½¬</label>
                    <input type="number" id="editGrantFreeSpin" min="0" max="10" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä¼˜å…ˆçº§</label>
                    <input type="number" id="editRulePriority" min="0" max="100" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" title="æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜">
                  </div>
                </div>
                
                <!-- å¯ç”¨çŠ¶æ€ -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">å¯ç”¨çŠ¶æ€</label>
                  <select id="editRuleActive" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    <option value="1" ${rule.is_active ? 'selected' : ''}>âœ… å¯ç”¨</option>
                    <option value="0" ${!rule.is_active ? 'selected' : ''}>âŒ ç¦ç”¨</option>
                  </select>
                </div>
                
                <!-- è§„åˆ™æè¿° -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">è§„åˆ™æè¿°</label>
                  <textarea id="editRuleDescription" rows="3" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="å¯é€‰ï¼šæ·»åŠ è§„åˆ™è¯´æ˜..."></textarea>
                </div>
                
                <!-- åªè¯»ä¿¡æ¯å±•ç¤º -->
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-2">
                  <h5 class="text-sm font-semibold text-slate-700 mb-2">ğŸ”’ è§„åˆ™æ ¸å¿ƒé…ç½®ï¼ˆåªè¯»ï¼‰</h5>
                  <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="bg-white p-2 rounded border border-slate-200">
                      <span class="text-slate-500">è§„åˆ™ç±»å‹ï¼š</span>
                      <span class="font-semibold text-slate-700">${rule.rule_type}</span>
                    </div>
                    <div class="bg-white p-2 rounded border border-slate-200">
                      <span class="text-slate-500">è§„åˆ™åˆ†ç±»ï¼š</span>
                      <span class="font-semibold text-slate-700">${rule.rule_category || 'æ— '}</span>
                    </div>
                    <div class="bg-white p-2 rounded border border-slate-200">
                      <span class="text-slate-500">åŒ¹é…æ¨¡å¼ï¼š</span>
                      <span class="font-semibold text-slate-700">${rule.match_pattern}</span>
                    </div>
                    <div class="bg-white p-2 rounded border border-slate-200">
                      <span class="text-slate-500">åŒ¹é…æ•°é‡ï¼š</span>
                      <span class="font-semibold text-slate-700">${rule.match_count || 'ä¸é™'}</span>
                    </div>
                    ${rule.required_symbols ? `
                    <div class="bg-white p-2 rounded border border-slate-200 col-span-2">
                      <span class="text-slate-500">å¿…éœ€ç¬¦å·ï¼š</span>
                      <span class="font-semibold text-indigo-700">${typeof rule.required_symbols === 'string' ? rule.required_symbols : JSON.stringify(rule.required_symbols)}</span>
                    </div>
                    ` : ''}
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeEditRuleModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å–æ¶ˆ</button>
                  <button onclick="saveEditRule(${ruleId}, ${schemeId})" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">ä¿å­˜ä¿®æ”¹</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ğŸ”¥ å®‰å…¨è®¾ç½®å­—æ®µçš„å€¼ï¼ˆé¿å… HTML æ³¨å…¥å’Œå¼•å·é—®é¢˜ï¼‰
        // å¯ç¼–è¾‘å­—æ®µ - æ–‡æœ¬ç±»å‹
        document.getElementById('editRuleName').value = rule.rule_name || '';
        document.getElementById('editRuleDescription').value = rule.description || '';
        
        // å¯ç¼–è¾‘å­—æ®µ - æ•°å€¼ç±»å‹
        document.getElementById('editWinMultiplier').value = rule.win_multiplier || 0;
        document.getElementById('editGrantFreeSpin').value = rule.grant_free_spin || 0;
        document.getElementById('editRulePriority').value = rule.priority || 0;
        
        // éšè—å­—æ®µï¼ˆæ ¸å¿ƒé…ç½®ï¼Œåªè¯»ï¼‰
        document.getElementById('editRuleType').value = rule.rule_type || '';
        document.getElementById('editRuleCategory').value = rule.rule_category || '';
        document.getElementById('editMatchPattern').value = rule.match_pattern || '';
        document.getElementById('editMatchCount').value = rule.match_count || '';
        // ğŸ”’ ä¿æŒ required_symbols çš„åŸå§‹æ ¼å¼ï¼ˆå¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰
        const requiredSymbolsValue = typeof rule.required_symbols === 'string' 
          ? rule.required_symbols 
          : (rule.required_symbols ? JSON.stringify(rule.required_symbols) : '');
        document.getElementById('editRequiredSymbols').value = requiredSymbolsValue;
        
      } catch (error) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', error);
        showToast('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
      }
    }
    
    async function saveEditRule(ruleId, schemeId) {
      const ruleName = document.getElementById('editRuleName').value.trim();
      const winMultiplier = parseFloat(document.getElementById('editWinMultiplier').value);
      
      if (!ruleName || isNaN(winMultiplier)) {
        showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'error');
        return;
      }
      
      // ğŸ”’ ä»éšè—å­—æ®µè¯»å–æ ¸å¿ƒé…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
      const ruleType = document.getElementById('editRuleType').value;
      const ruleCategory = document.getElementById('editRuleCategory').value || null;
      const matchPattern = document.getElementById('editMatchPattern').value;
      const matchCount = document.getElementById('editMatchCount').value;
      // ğŸ”¥ ç¡®ä¿ required_symbols ä¿æŒåŸå§‹ JSON æ ¼å¼
      const requiredSymbolsValue = document.getElementById('editRequiredSymbols').value;
      const requiredSymbols = requiredSymbolsValue.trim() ? requiredSymbolsValue : null;
      
      const data = {
        rule_name: ruleName,
        rule_type: ruleType,
        rule_category: ruleCategory,
        match_pattern: matchPattern,
        match_count: matchCount ? parseInt(matchCount) : null,
        required_symbols: requiredSymbols,
        win_multiplier: winMultiplier,
        grant_free_spin: parseInt(document.getElementById('editGrantFreeSpin').value) || 0,
        priority: parseInt(document.getElementById('editRulePriority').value) || 0,
        is_active: parseInt(document.getElementById('editRuleActive').value),
        description: document.getElementById('editRuleDescription').value.trim() || null
      };
      
      try {
        const res = await fetch(`/api/admin/rewards/rules/${ruleId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('è§„åˆ™å·²æ›´æ–°', 'success');
          closeEditRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°è§„åˆ™å¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥', 'error');
      }
    }
    
    function closeEditRuleModal() {
      const modal = document.getElementById('editRuleModal');
      if (modal) modal.remove();
    }
    
    async function deleteRule(ruleId, schemeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/rules/${ruleId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        if (data.success) {
          showToast('è§„åˆ™å·²åˆ é™¤', 'success');
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤è§„åˆ™å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    async function viewRewardSchemeDetails(schemeId) {
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½æ–¹æ¡ˆè¯¦æƒ…å¤±è´¥', 'error');
          return;
        }
        
        const { scheme, rules, punishments } = data.data;
        
        const modalHtml = `
          <div id="rewardSchemeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 p-6 border-b border-slate-200 z-10">
                <h3 class="text-xl font-bold text-white">ğŸ“Š å¥–åŠ±æ–¹æ¡ˆè¯¦æƒ…</h3>
              </div>
              
              <div class="p-6">
                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div class="bg-slate-50 rounded-lg p-4 mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">åŸºç¡€ä¿¡æ¯</h4>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="text-slate-600">æ–¹æ¡ˆIDï¼š</span><span class="font-mono font-semibold">#${scheme.id}</span></div>
                    <div><span class="text-slate-600">æ–¹æ¡ˆåç§°ï¼š</span><span class="font-semibold">${scheme.scheme_name}</span></div>
                    <div class="col-span-2"><span class="text-slate-600">æè¿°ï¼š</span><span>${scheme.description || 'æ— '}</span></div>
                  </div>
                </div>
                
                <!-- è§„åˆ™ç»Ÿè®¡ -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                  <h4 class="font-bold text-blue-900 mb-3">ğŸ“‹ è§„åˆ™ç»Ÿè®¡</h4>
                  <div class="grid grid-cols-3 gap-3 text-sm">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-blue-600">${rules.length}</div>
                      <div class="text-blue-700">æ€»è§„åˆ™æ•°</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-green-600">${rules.filter(r => r.is_active).length}</div>
                      <div class="text-green-700">å¯ç”¨è§„åˆ™</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-slate-400">${rules.filter(r => !r.is_active).length}</div>
                      <div class="text-slate-600">ç¦ç”¨è§„åˆ™</div>
                    </div>
                  </div>
                </div>
                
                <!-- è¯¦ç»†è§„åˆ™åˆ—è¡¨ -->
                <div class="mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">ğŸ¯ è¯¦ç»†è§„åˆ™åˆ—è¡¨</h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${rules.length === 0 ? '<div class="text-center py-6 text-slate-500 bg-slate-50 rounded-lg">æš‚æ— è§„åˆ™</div>' : rules.map(rule => `
                      <div class="bg-white border border-slate-200 rounded-lg p-3 text-sm">
                        <div class="flex justify-between items-start mb-2">
                          <span class="font-semibold text-slate-900">${rule.rule_name}</span>
                          <div class="flex gap-1">
                            <span class="px-2 py-0.5 text-xs rounded ${rule.is_active ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}">${rule.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                            <span class="px-2 py-0.5 text-xs rounded bg-blue-100 text-blue-700">${rule.rule_type}</span>
                          </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-600">
                          <div>æ¨¡å¼ï¼š<span class="font-mono">${rule.match_pattern}</span></div>
                          <div>å€ç‡ï¼š<span class="font-bold text-green-600">${rule.win_multiplier}x</span></div>
                          ${rule.match_count ? `<div>æ•°é‡ï¼š${rule.match_count}</div>` : ''}
                          ${rule.grant_free_spin > 0 ? `<div>å…è´¹è½¬ï¼š${rule.grant_free_spin}æ¬¡</div>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- å¾‹å¸ˆå‡½æƒ©ç½šé…ç½® -->
                ${punishments && punishments.length > 0 ? `
                <div class="mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">âš–ï¸ å¾‹å¸ˆå‡½æƒ©ç½šé…ç½®</h4>
                  <div class="space-y-2">
                    ${punishments.map(p => `
                      <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm">
                        <div class="flex justify-between items-center">
                          <div>
                            <span class="font-semibold text-red-900">${p.lsh_count}æ¬¡å¾‹å¸ˆå‡½</span>
                            <span class="mx-2 text-slate-400">â†’</span>
                            <span class="text-red-700">å€ç‡Ã—${p.deduct_multiplier}</span>
                            ${p.ban_hours > 0 ? `<span class="ml-2 text-red-600">å°ç¦${p.ban_hours}å°æ—¶</span>` : ''}
                          </div>
                          <span class="px-2 py-0.5 text-xs rounded ${p.is_active ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}">${p.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                ` : ''}
                
                <div class="flex gap-3 mt-6 sticky bottom-0 bg-white pt-4 border-t border-slate-200">
                  <button onclick="closeRewardSchemeDetailModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å…³é—­</button>
                  <button onclick="closeRewardSchemeDetailModal(); editRewardScheme(${schemeId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">ç¼–è¾‘æ–¹æ¡ˆ</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('åŠ è½½æ–¹æ¡ˆè¯¦æƒ…å¤±è´¥:', error);
        showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
      }
    }
    
    function closeRewardSchemeDetailModal() {
      const modal = document.getElementById('rewardSchemeDetailModal');
      if (modal) modal.remove();
    }
    
    async function deleteRewardScheme(schemeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¥–åŠ±æ–¹æ¡ˆå—ï¼Ÿ')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('æ–¹æ¡ˆå·²åˆ é™¤', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // ========== è‡³å°Šåœºé…ç½®ç®¡ç† ==========
    
    async function loadSupremeConfig() {
      try {
        // åŠ è½½æƒé‡æ–¹æ¡ˆåˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼‰
        const weightRes = await fetch('/api/admin/weights');
        const weightData = await weightRes.json();
        
        if (weightData.success) {
          const select = document.getElementById('supremeWeightConfigId');
          // ç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = weightData.data.map(w => 
            `<option value="${w.id}">${w.config_name}</option>`
          ).join('');
        }
        
        // åŠ è½½å¥–åŠ±æ–¹æ¡ˆåˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼‰
        const rewardRes = await fetch('/api/admin/rewards/schemes');
        const rewardData = await rewardRes.json();
        
        if (rewardData.success) {
          const select = document.getElementById('supremeRewardSchemeId');
          // ç§»é™¤"ä½¿ç”¨ä¸­"æ ‡ç­¾
          select.innerHTML = rewardData.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}</option>`
          ).join('');
        }
        
        // åŠ è½½è‡³å°Šåœºé…ç½®
        const configRes = await fetch('/api/admin/supreme/config');
        const configData = await configRes.json();
        
        if (configData.success && configData.data) {
          const config = configData.data;
          document.getElementById('supremeEnabled').value = config.enabled ? '1' : '0';
          document.getElementById('supremeFragmentsToToken').value = config.fragments_to_token;
          document.getElementById('supremeMaxTokens').value = config.max_tokens_hold;
          document.getElementById('supremeTokenValidHours').value = config.token_valid_hours || 168;
          document.getElementById('supremeSessionValidHours').value = config.session_valid_hours || 2;
          // å¤å¸å€¼è½¬æ¢å›æ˜¾ç¤ºå€¼ï¼ˆé™¤ä»¥500000ï¼‰
          document.getElementById('supremeMinBet').value = config.min_bet_amount / 500000;
          document.getElementById('supremeMaxBet').value = config.max_bet_amount / 500000;
          document.getElementById('supremeDailyEntry').value = config.daily_entry_limit;
          document.getElementById('supremeDailyTokenGrant').value = config.daily_token_grant_limit || 1;
          document.getElementById('supremeDailyBetLimit').value = config.daily_bet_limit / 500000;
          // è®¾ç½®é€‰ä¸­çš„é…ç½®
          if (config.weight_config_id) {
            document.getElementById('supremeWeightConfigId').value = config.weight_config_id;
            // ğŸ”¥ ç«‹å³é¢„è§ˆæƒé‡é…ç½®
            await previewSupremeWeightConfig();
          }
          if (config.reward_scheme_id) {
            document.getElementById('supremeRewardSchemeId').value = config.reward_scheme_id;
            // ğŸ”¥ ç«‹å³é¢„è§ˆå¥–åŠ±æ–¹æ¡ˆ
            await previewSupremeRewardScheme();
          }
          
          // ğŸ”¥ ç§»é™¤è‡ªåŠ¨è®¡ç®—ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»è®¡ç®—æŒ‰é’®
          // await calculateSupremeProbability();
        } else {
          // ä½¿ç”¨é»˜è®¤å€¼
          document.getElementById('supremeEnabled').value = '1';
          document.getElementById('supremeFragmentsToToken').value = '10';
          document.getElementById('supremeMaxTokens').value = '3';
          document.getElementById('supremeTokenValidHours').value = '168';
          document.getElementById('supremeSessionValidHours').value = '2';
          document.getElementById('supremeMinBet').value = '1000';
          document.getElementById('supremeMaxBet').value = '10000';
          document.getElementById('supremeDailyEntry').value = '3';
          document.getElementById('supremeDailyTokenGrant').value = '1';
          document.getElementById('supremeDailyBetLimit').value = '100000';
        }

      } catch (error) {
        console.error('åŠ è½½è‡³å°Šåœºé…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½é…ç½®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼', 'warning');
        // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼
        document.getElementById('supremeEnabled').value = '1';
        document.getElementById('supremeFragmentsToToken').value = '10';
        document.getElementById('supremeMaxTokens').value = '3';
        document.getElementById('supremeTokenValidHours').value = '168';
        document.getElementById('supremeSessionValidHours').value = '2';
        document.getElementById('supremeMinBet').value = '1000';
        document.getElementById('supremeMaxBet').value = '10000';
        document.getElementById('supremeDailyEntry').value = '3';
        document.getElementById('supremeDailyTokenGrant').value = '1';
        document.getElementById('supremeDailyBetLimit').value = '100000';
      }
    }
    
    // é¢„è§ˆè‡³å°Šåœºæƒé‡é…ç½®
    async function previewSupremeWeightConfig() {
      const configId = document.getElementById('supremeWeightConfigId').value;
      if (!configId) return;
      
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.find(c => c.id == configId);
          if (config) {
            document.getElementById('sup_preview_weight_m').textContent = config.weight_m;
            document.getElementById('sup_preview_weight_t').textContent = config.weight_t;
            document.getElementById('sup_preview_weight_n').textContent = config.weight_n;
            document.getElementById('sup_preview_weight_j').textContent = config.weight_j;
            document.getElementById('sup_preview_weight_lq').textContent = config.weight_lq;
            document.getElementById('sup_preview_weight_bj').textContent = config.weight_bj;
            document.getElementById('sup_preview_weight_zft').textContent = config.weight_zft;
            document.getElementById('sup_preview_weight_bdk').textContent = config.weight_bdk;
            document.getElementById('sup_preview_weight_lsh').textContent = config.weight_lsh;
            document.getElementById('sup_preview_weight_man').textContent = config.weight_man || 25;
            document.getElementById('supremeWeightPreview').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('é¢„è§ˆè‡³å°Šåœºæƒé‡é…ç½®å¤±è´¥:', error);
      }
    }
    
    // é¢„è§ˆè‡³å°Šåœºå¥–åŠ±æ–¹æ¡ˆ
    async function previewSupremeRewardScheme() {
      const schemeId = document.getElementById('supremeRewardSchemeId').value;
      if (!schemeId) return;
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (data.success) {
          const rules = data.data.rules || [];
          const punishments = data.data.punishments || [];
          const previewList = document.getElementById('supremeRewardPreviewList');
          
          let html = '';
          
          // ğŸ ä¸­å¥–è§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (rules.length > 0) {
            html += `
              <div>
                <h5 class="text-xs font-bold text-green-700 mb-2">ğŸ ä¸­å¥–è§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${rules.map(rule => `
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1">${rule.rule_name}</div>
                      <div class="text-lg font-bold text-green-600">${rule.win_multiplier}x</div>
                      ${rule.grant_free_spin ? '<div class="text-xs text-purple-600 mt-1">ğŸ é€å…è´¹æ¬¡æ•°</div>' : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          // âš ï¸ æƒ©ç½šè§„åˆ™ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
          if (punishments.length > 0) {
            html += `
              <div>
                <h5 class="text-xs font-bold text-red-700 mb-2">âš ï¸ æƒ©ç½šè§„åˆ™</h5>
                <div class="grid grid-cols-4 gap-2">
                  ${punishments.map(p => `
                    <div class="bg-gradient-to-br from-red-50 to-rose-50 p-3 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                      <div class="text-xs font-semibold text-slate-900 mb-1">å¾‹å¸ˆå‡½Ã—${p.lsh_count}</div>
                      <div class="text-lg font-bold text-red-600">-${p.deduct_multiplier}x</div>
                      ${p.ban_hours > 0 ? `<div class="text-xs text-red-600 mt-1">ğŸš« ç¦${p.ban_hours}å°æ—¶</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          if (rules.length === 0 && punishments.length === 0) {
            html = '<div class="text-slate-500 text-center py-4">æš‚æ— è§„åˆ™</div>';
          }
          
          previewList.innerHTML = html;
          document.getElementById('supremeRewardPreview').classList.remove('hidden');
        }
      } catch (error) {
        console.error('é¢„è§ˆè‡³å°Šåœºå¥–åŠ±æ–¹æ¡ˆå¤±è´¥:', error);
      }
    }
    
    // è®¡ç®—è‡³å°Šåœºæ¦‚ç‡
    async function calculateSupremeProbability() {
      const weightConfigId = document.getElementById('supremeWeightConfigId').value;
      const rewardSchemeId = document.getElementById('supremeRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        document.getElementById('supremeProbabilityDisplay').classList.add('hidden');
        return;
      }
      
      const method = document.querySelector('input[name="supremeCalcMethod"]:checked').value;
      const displayDiv = document.getElementById('supremeProbabilityDisplay');
      const cacheKey = getCacheKey(weightConfigId, rewardSchemeId, method);
      
      // ğŸ”¥ å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼ˆç¡®ä¿è·å–æœ€æ–°è®¡ç®—ç»“æœï¼‰
      if (probabilityCache.has(cacheKey)) {
        console.log('[å¼ºåˆ¶åˆ·æ–°] æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ¦‚ç‡');
        probabilityCache.delete(cacheKey);
      }
      
      // ğŸ”„ æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
      let progressPercent = 0;
      const progressInterval = method === 'monte-carlo' ? setInterval(() => {
        if (progressPercent < 95) {
          progressPercent += Math.random() * 10;
          if (progressPercent > 95) progressPercent = 95;
          updateProgressBar(displayDiv, progressPercent, method);
        }
      }, 200) : null;
      
      updateProgressBar(displayDiv, 0, method);
      displayDiv.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/admin/calculate-probability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId),
            method: method,
            simulation_count: method === 'monte-carlo' ? 1000000 : undefined
          })
        });
        
        const data = await res.json();
        
        if (progressInterval) {
          clearInterval(progressInterval);
          updateProgressBar(displayDiv, 100, method);
        }
        
        if (data.success) {
          const result = data.data;
          // ğŸ”¥ ç¼“å­˜ç»“æœ
          probabilityCache.set(cacheKey, result);
          setTimeout(() => {
            renderProbabilityDisplay('supremeProbabilityDisplay', result);
          }, 300);
        } else {
          displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥: ${data.message}</div>`;
        }
      } catch (error) {
        if (progressInterval) clearInterval(progressInterval);
        console.error('è®¡ç®—æ¦‚ç‡å¤±è´¥:', error);
        displayDiv.innerHTML = `<div class="text-center py-4 text-red-600">è®¡ç®—å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
      }
    }
    
    // ========== æ‰è½é…ç½®ç®¡ç† ==========
    
    async function loadDropConfigs() {
      try {
        const res = await fetch('/api/admin/drop-configs');
        const data = await res.json();
        
        if (!data.success) {
          document.getElementById('dropConfigsList').innerHTML = '<div class="text-center py-4 text-red-600">åŠ è½½å¤±è´¥</div>';
          return;
        }
        
        const configs = data.data || [];
        const container = document.getElementById('dropConfigsList');
        
        if (configs.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12">
              <p class="text-slate-500 text-lg mb-3">æš‚æ— æ‰è½é…ç½®</p>
              <p class="text-slate-400 text-sm">ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ æ‰è½è§„åˆ™"å¼€å§‹é…ç½®</p>
            </div>
          `;
          return;
        }
        
        // æŒ‰ç‰©å“ç±»å‹åˆ†ç»„
        const grouped = configs.reduce((acc, config) => {
          if (!acc[config.drop_item_type]) acc[config.drop_item_type] = [];
          acc[config.drop_item_type].push(config);
          return acc;
        }, {});
        
        const typeNames = {
          'ticket': 'ğŸŸï¸ å…¥åœºåˆ¸',
          'fragment': 'ğŸ€ ç¢ç‰‡',
          'supreme_token': 'ğŸ’ è‡³å°Šä»¤ç‰Œ',
          'supreme_fragment': 'ğŸ’  è‡³å°Šç¢ç‰‡'
        };
        
        const modeNames = {
          'normal': 'ğŸ° åˆçº§åœº',
          'advanced': 'ğŸ”¥ é«˜çº§åœº',
          'supreme': 'ğŸ’ è‡³å°Šåœº'
        };
        
        let html = '';
        for (const [type, typeConfigs] of Object.entries(grouped)) {
          html += `
            <div class="border-2 border-slate-200 rounded-xl p-5">
              <h4 class="font-bold text-lg text-slate-900 mb-4">${typeNames[type]} æ‰è½é…ç½® (${typeConfigs.length}æ¡)</h4>
              <div class="space-y-3">
                ${typeConfigs.map(config => `
                  <div class="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-gray-50 rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="font-semibold text-slate-900">${modeNames[config.slot_mode]} â†’ ${config.trigger_rule_name}</span>
                        <span class="px-2 py-0.5 bg-${config.is_active ? 'green' : 'red'}-100 text-${config.is_active ? 'green' : 'red'}-700 rounded-full text-xs font-bold">
                          ${config.is_active ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}
                        </span>
                      </div>
                      <div class="flex items-center gap-4 text-sm text-slate-600">
                        <span>ğŸ“Š æ¦‚ç‡: <strong class="text-purple-600">${(config.drop_probability * 100).toFixed(1)}%</strong></span>
                        <span>ğŸ“¦ æ•°é‡: <strong>${config.drop_count}</strong></span>
                        <span class="text-xs text-slate-500">${config.description || ''}</span>
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="editDropConfig(${config.id})" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors">
                        âœï¸ ç¼–è¾‘
                      </button>
                      <button onclick="deleteDropConfig(${config.id})" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors">
                        ğŸ—‘ï¸ åˆ é™¤
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        container.innerHTML = html;
      } catch (error) {
        console.error('åŠ è½½æ‰è½é…ç½®å¤±è´¥:', error);
        document.getElementById('dropConfigsList').innerHTML = '<div class="text-center py-4 text-red-600">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
      }
    }
    
    function openAddDropConfigModal() {
      // é‡ç½®ä¸ºæ–°å¢æ¨¡å¼
      document.getElementById('dropConfigEditId').value = '';
      document.getElementById('dropConfigModalTitle').textContent = 'ğŸ² æ·»åŠ æ‰è½è§„åˆ™';

      // é‡ç½®è¡¨å•
      resetDropConfigForm();

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('dropConfigModal').classList.remove('hidden');
      updateDropRulesList();
    }

    function resetDropConfigForm() {
      // é‡ç½®æ‰€æœ‰è¾“å…¥
      document.querySelector('input[name="dropSlotMode"][value="normal"]').checked = true;
      document.querySelector('input[name="dropItemType"][value="ticket"]').checked = true;
      document.getElementById('dropProbability').value = 50;
      document.getElementById('dropProbabilitySlider').value = 50;
      document.getElementById('dropCount').value = 1;
      document.getElementById('dropDescription').value = '';
      updateDropProbabilityDisplay(50);
    }

    function closeDropConfigModal() {
      document.getElementById('dropConfigModal').classList.add('hidden');
      resetDropConfigForm();
    }
    
    async function updateDropRulesList() {
      const mode = document.querySelector('input[name="dropSlotMode"]:checked').value;
      const select = document.getElementById('dropTriggerRule');
      
      try {
        // è·å–è¯¥åœºæ¬¡çš„é…ç½®
        let configRes;
        if (mode === 'normal') {
          configRes = await fetch('/api/admin/slot/config');
        } else if (mode === 'advanced') {
          configRes = await fetch('/api/admin/slot/advanced/config');
        } else if (mode === 'supreme') {
          configRes = await fetch('/api/admin/supreme/config');
        }
        
        const configData = await configRes.json();
        const schemeId = configData.data?.reward_scheme_id || 1;
        
        // è·å–å¥–åŠ±æ–¹æ¡ˆçš„è§„åˆ™åˆ—è¡¨
        const schemeRes = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const schemeData = await schemeRes.json();
        
        if (schemeData.success) {
          const rules = schemeData.data.rules || [];
          select.innerHTML = rules.map(r => 
            `<option value="${r.rule_name}">${r.rule_name}</option>`
          ).join('');
        }
      } catch (error) {
        console.error('åŠ è½½è§„åˆ™åˆ—è¡¨å¤±è´¥:', error);
        select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }
    
    function updateDropProbabilityDisplay(value) {
      document.getElementById('dropProbability').value = value;
      document.getElementById('dropProbabilitySlider').value = value;
      document.getElementById('dropProbBar').style.width = value + '%';
      document.getElementById('dropProbPercent').textContent = value;
    }
    
    async function saveDropConfig() {
      const editId = document.getElementById('dropConfigEditId').value;
      const mode = document.querySelector('input[name="dropSlotMode"]:checked').value;
      const ruleName = document.getElementById('dropTriggerRule').value;
      const itemType = document.querySelector('input[name="dropItemType"]:checked').value;
      const probability = parseFloat(document.getElementById('dropProbability').value) / 100;
      const count = parseInt(document.getElementById('dropCount').value);
      const description = document.getElementById('dropDescription').value;

      if (!ruleName) {
        showToast('è¯·é€‰æ‹©ä¸­å¥–è§„åˆ™', 'error');
        return;
      }

      const requestData = {
        slot_mode: mode,
        trigger_rule_name: ruleName,
        drop_item_type: itemType,
        drop_probability: probability,
        drop_count: count,
        description: description
      };

      try {
        let res;
        if (editId) {
          // æ›´æ–°æ¨¡å¼
          res = await fetch(`/api/admin/drop-configs/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
          });
        } else {
          // æ–°å¢æ¨¡å¼
          res = await fetch('/api/admin/drop-configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
          });
        }

        const data = await res.json();

        if (data.success) {
          showToast(editId ? 'âœ… æ‰è½é…ç½®å·²æ›´æ–°' : 'âœ… æ‰è½é…ç½®å·²æ·»åŠ ', 'success');
          closeDropConfigModal();
          loadDropConfigs();
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥', 'error');
      }
    }
    
    async function editDropConfig(id) {
      try {
        // è·å–æ‰€æœ‰é…ç½®
        const res = await fetch('/api/admin/drop-configs');
        const data = await res.json();

        if (!data.success) {
          showToast('åŠ è½½é…ç½®å¤±è´¥', 'error');
          return;
        }

        // æŸ¥æ‰¾å¯¹åº”çš„é…ç½®
        const config = data.data.find(c => c.id === id);
        if (!config) {
          showToast('é…ç½®ä¸å­˜åœ¨', 'error');
          return;
        }

        // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
        document.getElementById('dropConfigEditId').value = id;
        document.getElementById('dropConfigModalTitle').textContent = 'âœï¸ ç¼–è¾‘æ‰è½è§„åˆ™';

        // å¡«å……æ•°æ®åˆ°è¡¨å•
        document.querySelector(`input[name="dropSlotMode"][value="${config.slot_mode}"]`).checked = true;
        document.querySelector(`input[name="dropItemType"][value="${config.drop_item_type}"]`).checked = true;

        const probability = (config.drop_probability * 100).toFixed(0);
        document.getElementById('dropProbability').value = probability;
        document.getElementById('dropProbabilitySlider').value = probability;
        updateDropProbabilityDisplay(probability);

        document.getElementById('dropCount').value = config.drop_count;
        document.getElementById('dropDescription').value = config.description || '';

        // å…ˆåŠ è½½è§„åˆ™åˆ—è¡¨ï¼Œç„¶åé€‰ä¸­å¯¹åº”çš„è§„åˆ™
        await updateDropRulesList();
        document.getElementById('dropTriggerRule').value = config.trigger_rule_name;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('dropConfigModal').classList.remove('hidden');
      } catch (error) {
        console.error('åŠ è½½ç¼–è¾‘æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥', 'error');
      }
    }
    
    async function deleteDropConfig(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ‰è½é…ç½®å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`/api/admin/drop-configs/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          showToast('åˆ é™¤æˆåŠŸ', 'success');
          loadDropConfigs();
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥', 'error');
      }
    }
    
    async function saveSupremeConfig() {
      try {
        const minBetUsd = parseInt(document.getElementById('supremeMinBet').value);
        const maxBetUsd = parseInt(document.getElementById('supremeMaxBet').value);

        // ğŸ”¥ æ ¹æ®æŠ•æ³¨èŒƒå›´åŠ¨æ€è®¡ç®—æ­¥é•¿
        const betRange = maxBetUsd - minBetUsd;
        let betStep = 1000; // é»˜è®¤æ­¥é•¿

        if (betRange <= 1000) {
          betStep = 100;
        } else if (betRange <= 10000) {
          betStep = 500;
        } else if (betRange <= 50000) {
          betStep = 1000;
        } else {
          betStep = 5000;
        }

        const config = {
          enabled: parseInt(document.getElementById('supremeEnabled').value),
          fragments_to_token: parseInt(document.getElementById('supremeFragmentsToToken').value),
          max_tokens_hold: parseInt(document.getElementById('supremeMaxTokens').value),
          token_valid_hours: parseInt(document.getElementById('supremeTokenValidHours').value),
          session_valid_hours: parseInt(document.getElementById('supremeSessionValidHours').value),
          min_bet_amount: minBetUsd * 500000,
          max_bet_amount: maxBetUsd * 500000,
          bet_step: betStep * 500000,  // ğŸ”¥ ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„æ­¥é•¿
          daily_entry_limit: parseInt(document.getElementById('supremeDailyEntry').value),
          daily_token_grant_limit: parseInt(document.getElementById('supremeDailyTokenGrant').value),
          daily_bet_limit: parseInt(document.getElementById('supremeDailyBetLimit').value) * 500000,
          weight_config_id: parseInt(document.getElementById('supremeWeightConfigId').value),
          reward_scheme_id: parseInt(document.getElementById('supremeRewardSchemeId').value)
        };
        
        // éªŒè¯é…ç½®
        if (config.min_bet_amount > config.max_bet_amount) {
          showToast('æœ€å°ä¸‹æ³¨ä¸èƒ½å¤§äºæœ€å¤§ä¸‹æ³¨', 'error');
          return;
        }
        
        if (config.fragments_to_token < 1 || config.max_tokens_hold < 1) {
          showToast('ç¢ç‰‡å’Œä»¤ç‰Œæ•°é‡å¿…é¡»å¤§äº0', 'error');
          return;
        }
        
        const res = await fetch('/api/admin/supreme/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('è‡³å°Šåœºé…ç½®å·²ä¿å­˜', 'success');
          await loadSupremeConfig(); // é‡æ–°åŠ è½½é…ç½®
          await calculateSupremeProbability(); // ğŸ”¥ é‡æ–°è®¡ç®—æ¦‚ç‡
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜è‡³å°Šåœºé…ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ========== è‡³å°Šåœºè®°å½•ç®¡ç† ==========
    
    // ğŸ’ è‡³å°Šåœºè®°å½•ç­›é€‰å˜é‡
    let supremeSlotAllRecords = [];
    let supremeSlotFilters = {
      username: '',
      winType: 'all'
    };
    
    // ğŸš€ ä¼˜åŒ–ï¼šè‡³å°Šåœºè®°å½•åŠ è½½ï¼ˆä½¿ç”¨æœåŠ¡ç«¯åˆ†é¡µå’Œç­›é€‰ï¼‰
    let supremeCurrentPage = 1;
    let supremePageSize = 50;

    async function loadSupremeRecords(page = 1) {
      if (page < 1) return;

      try {
        // ğŸš€ ä¼˜åŒ–ï¼šä½¿ç”¨æœåŠ¡ç«¯ç­›é€‰å’Œåˆ†é¡µ
        const username = supremeSlotFilters.username || '';
        let url = `/api/admin/supreme/records?page=${page}&pageSize=${supremePageSize}`;
        if (username) {
          url += `&username=${encodeURIComponent(username)}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (!data.success) {
          showToast('åŠ è½½è®°å½•å¤±è´¥', 'error');
          return;
        }

        supremeCurrentPage = data.pagination?.page || 1;
        const records = data.data || [];

        // ğŸ’ è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆåŸºäºå½“å‰ç­›é€‰ç»“æœï¼‰
        const stats = {
          count: data.pagination?.total || records.length,
          total_bet: records.reduce((sum, r) => sum + (r.bet_amount || 0), 0),
          total_win: records.reduce((sum, r) => sum + (r.win_amount || 0), 0)
        };

        // ğŸ’ æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        document.getElementById('supremeSlotTotal').textContent = stats.count;
        document.getElementById('supremeSlotTotalBet').textContent = `$${(stats.total_bet / 500000).toFixed(2)}`;
        document.getElementById('supremeSlotTotalWin').textContent = `$${(stats.total_win / 500000).toFixed(2)}`;
        const rtp = stats.total_bet > 0 ? ((stats.total_win / stats.total_bet) * 100).toFixed(2) : '0.00';
        document.getElementById('supremeSlotRTP').textContent = `${rtp}%`;

        // ğŸ’ æ›´æ–°åˆ†é¡µä¿¡æ¯
        if (data.pagination) {
          document.getElementById('supremeCurrentPage').textContent = data.pagination.page;
          document.getElementById('supremeTotalPages').textContent = data.pagination.totalPages;
          document.getElementById('supremePrevBtn').disabled = data.pagination.page <= 1;
          document.getElementById('supremeNextBtn').disabled = !data.pagination.hasMore;
        }

        // ğŸ’ æ˜¾ç¤ºç­›é€‰æç¤º
        const hintEl = document.getElementById('supremeFilterResultHint');
        if (hintEl) {
          if (username) {
            hintEl.textContent = `ğŸ“Š ç­›é€‰ç»“æœ: ${stats.count} æ¡è®°å½•`;
            hintEl.classList.remove('hidden');
          } else {
            hintEl.classList.add('hidden');
          }
        }

        const tbody = document.getElementById('supremeRecordsTableBody');

        if (records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-slate-500">æš‚æ— æ¸¸æˆè®°å½•</td></tr>';
          return;
        }

        // ğŸ’ ä¸­å¥–ç±»å‹åç§°æ˜ å°„ï¼ˆfallbackä½¿ç”¨ï¼‰
        const winTypeNames = {
          'super_jackpot': 'ğŸ† è¶…çº§å¤§å¥–',
          'special_combo': 'ğŸ’ ç‰¹æ®Šç»„åˆ',
          'quad': 'ğŸ° å››è¿',
          'triple': 'âœ¨ ä¸‰è¿',
          'double': 'ğŸ åŒè¿',
          'man_only': 'ğŸ¯ Manç»„åˆ',
          'man_quad': 'ğŸ° ManÃ—4',
          'symmetric': 'ğŸ”„ å¯¹ç§°ABBA',
          'consecutive': 'â­ è¿ç»­',
          'combination': 'ğŸ ç»„åˆ',
          'any': 'ğŸ² ä»»æ„',
          'double_pair': 'ğŸ­ ä¸¤å¯¹',
          'punishment': 'âš¡ å¾‹å¸ˆå‡½',
          'none': 'âŒ æœªä¸­å¥–'
        };

        tbody.innerHTML = records.map(record => {
          const gameTime = new Date(record.timestamp).toLocaleString('zh-CN');
          const betAmount = (record.bet_amount / 500000).toFixed(2);
          const winAmount = (record.win_amount / 500000).toFixed(2);
          const multiplier = record.win_multiplier;
          const isWin = multiplier > 0;
          const isLoss = multiplier < 0;

          // ğŸ’ è§£æç»“æœç¬¦å·
          let symbols = [];
          try {
            symbols = JSON.parse(record.result_symbols || '[]');
          } catch (e) {
            symbols = [];
          }

          // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ rule_nameï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ° win_type æ˜ å°„
          const displayWinType = record.rule_name || (() => {
            // ğŸ”¥ ä» RULE_TEMPLATES ä¸­æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™
            const matchedRule = RULE_TEMPLATES.find(r => r.id === record.win_type);
            if (matchedRule) {
              return matchedRule.name;
            }
            // ğŸ”¥ æœ€åæ‰ä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„
            return winTypeNames[record.win_type] || record.win_type || 'æœªä¸­å¥–';
          })();

          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 text-xs text-slate-500 font-mono">${gameTime}</td>
              <td class="px-4 py-3 text-sm">
                <div class="font-semibold text-slate-900">${record.linux_do_username || record.username || 'æœªçŸ¥ç”¨æˆ·'}</div>
                <div class="text-xs text-slate-500">${record.username || '-'}</div>
              </td>
              <td class="px-4 py-3 text-center text-sm text-slate-600">${record.linux_do_id || '-'}</td>
              <td class="px-4 py-3">
                <div class="flex gap-1 justify-center">
                  ${symbols.map(s => {
                    const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
                    return `<img src="/slot-symbols/${s}.${ext}" class="w-8 h-8 object-contain" title="${s}">`;
                  }).join('')}
                </div>
              </td>
              <td class="px-4 py-3 text-center text-sm">
                <span class="px-2 py-1 rounded ${isWin ? 'bg-purple-100 text-purple-700' : isLoss ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'} text-xs font-semibold">
                  ${displayWinType}
                </span>
              </td>
              <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs font-bold ${isWin ? 'bg-green-100 text-green-700' : isLoss ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'}">
                  ${multiplier}x
                </span>
              </td>
              <td class="px-4 py-3 text-right font-mono text-sm text-blue-600 font-semibold">$${betAmount}</td>
              <td class="px-4 py-3 text-right font-mono text-sm ${isWin ? 'text-green-600 font-bold' : isLoss ? 'text-red-600 font-bold' : 'text-slate-500'}">
                ${isWin ? '+' : ''}$${winAmount}
              </td>
              <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs font-semibold ${isWin ? 'bg-green-100 text-green-700' : isLoss ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'}">
                  ${isWin ? 'ğŸ‰ å¥–åŠ±' : isLoss ? 'âš¡ æƒ©ç½š' : '-'}
                </span>
              </td>
              <td class="px-4 py-3 text-center text-xs text-slate-500">${record.game_mode || 'è‡³å°Šåœº'}</td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('åŠ è½½è‡³å°Šåœºè®°å½•å¤±è´¥:', error);
        const tbody = document.getElementById('supremeRecordsTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>';
      }
    }
    
    // ğŸ’ è‡³å°Šåœºè®°å½•ç­›é€‰å‡½æ•°ï¼ˆğŸš€ ä¼˜åŒ–ï¼šå›åˆ°ç¬¬ä¸€é¡µï¼‰
    function filterSupremeSlotRecords() {
      supremeSlotFilters.username = document.getElementById('supremeRecordSearchInput').value.trim();
      supremeSlotFilters.winType = document.getElementById('supremeWinTypeFilter').value;

      loadSupremeRecords(1);  // ğŸš€ å›åˆ°ç¬¬ä¸€é¡µ
    }

    // ğŸ’ åˆ·æ–°å¹¶ä¿ç•™ç­›é€‰æ¡ä»¶ï¼ˆğŸš€ ä¼˜åŒ–ï¼šåˆ·æ–°å½“å‰é¡µï¼‰
    async function refreshSupremeRecordsKeepFilter() {
      const refreshBtn = event?.target?.closest('button');
      const refreshIcon = refreshBtn?.querySelector('svg');
      if (refreshIcon) {
        refreshIcon.classList.add('animate-spin');
      }

      await loadSupremeRecords(supremeCurrentPage);  // ğŸš€ ä¿æŒå½“å‰é¡µ

      if (refreshIcon) {
        refreshIcon.classList.remove('animate-spin');
      }
    }

    // ğŸ’ æ¸…é™¤è‡³å°Šåœºç­›é€‰æ¡ä»¶ï¼ˆğŸš€ ä¼˜åŒ–ï¼šå›åˆ°ç¬¬ä¸€é¡µï¼‰
    function clearSupremeRecordFilters() {
      document.getElementById('supremeRecordSearchInput').value = '';
      document.getElementById('supremeWinTypeFilter').value = 'all';

      supremeSlotFilters.username = '';
      supremeSlotFilters.winType = 'all';

      loadSupremeRecords(1);  // ğŸš€ å›åˆ°ç¬¬ä¸€é¡µ

      showToast('å·²é‡ç½®ç­›é€‰æ¡ä»¶', 'success');
    }

    // ğŸ’ åˆ·æ–°è‡³å°Šåœºè®°å½•ï¼ˆæ¸…é™¤ç­›é€‰ï¼‰
    function refreshSupremeRecords() {
      clearSupremeRecordFilters();
    }
    
    async function viewSupremeDropDetail(recordId) {
      try {
        const res = await fetch('/api/admin/supreme/drops');
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
          return;
        }
        
        const record = data.data.find(r => r.id === recordId);
        if (!record) {
          showToast('è®°å½•ä¸å­˜åœ¨', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="supremeDropDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-purple-600 to-pink-600">
                <h3 class="text-xl font-bold text-white">ğŸ’ è‡³å°Šåœºæ‰è½è¯¦æƒ…</h3>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  <div class="bg-slate-50 rounded-lg p-4">
                    <h4 class="font-bold text-slate-900 mb-3">åŸºç¡€ä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-slate-600">è®°å½•IDï¼š</span><span class="font-mono font-semibold">#${record.id}</span></div>
                      <div><span class="text-slate-600">ç”¨æˆ·åï¼š</span><span class="font-semibold">${record.username || 'æœªçŸ¥'}</span></div>
                      <div class="col-span-2"><span class="text-slate-600">ç”¨æˆ·IDï¼š</span><span class="font-mono text-xs">${record.user_id}</span></div>
                    </div>
                  </div>
                  
                  <div class="bg-amber-50 rounded-lg p-4">
                    <h4 class="font-bold text-amber-900 mb-3">æ‰è½ä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-amber-700">ç‰©å“ç±»å‹ï¼š</span><span class="font-semibold">${record.item_type === 'fragment' ? 'è‡³å°Šç¢ç‰‡' : 'è‡³å°Šä»¤ç‰Œ'}</span></div>
                      <div><span class="text-amber-700">æ•°é‡ï¼š</span><span class="font-bold text-amber-900">${record.item_count}</span></div>
                      <div><span class="text-amber-700">æ‰è½æ—¶é—´ï¼š</span><span class="font-mono text-xs">${new Date(record.drop_timestamp).toLocaleString('zh-CN')}</span></div>
                    </div>
                  </div>
                  
                  <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-bold text-green-900 mb-3">æ¸¸æˆä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-green-700">ä¸‹æ³¨é‡‘é¢ï¼š</span><span class="font-bold text-green-900">${(record.bet_amount / 500000).toLocaleString()} å¤å¸</span></div>
                      <div><span class="text-green-700">ä¸­å¥–é‡‘é¢ï¼š</span><span class="font-bold text-green-900">${(record.win_amount / 500000).toLocaleString()} å¤å¸</span></div>
                      <div class="col-span-2"><span class="text-green-700">æ¸¸æˆåœºæ¬¡ï¼š</span><span class="font-semibold">è‡³å°Šåœº (Supreme Slot)</span></div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeSupremeDropDetailModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">å…³é—­</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
        showToast('åŠ è½½è¯¦æƒ…å¤±è´¥', 'error');
      }
    }
    
    function closeSupremeDropDetailModal() {
      const modal = document.getElementById('supremeDropDetailModal');
      if (modal) modal.remove();
    }

    // ========== å°ç¦è®°å½•ç®¡ç†åŠŸèƒ½ ==========
    
    // åŠ è½½å°ç¦ç”¨æˆ·åˆ—è¡¨
    async function loadBannedUsers() {
      try {
        const res = await fetch('/api/admin/users/banned');
        const data = await res.json();
        
        if (!data.success) {
          showToast('åŠ è½½å°ç¦è®°å½•å¤±è´¥', 'error');
          return;
        }
        
        const bannedUsers = data.data.users;
        const freeSpinsBans = data.data.freeSpinsBans || [];
        
        // åˆå¹¶ä¸¤ç§å°ç¦è®°å½•
        const allBans = [];
        
        // ç”¨æˆ·è¡¨çš„å°ç¦ï¼ˆæ°¸ä¹…å°ç¦ï¼‰
        bannedUsers.forEach(user => {
          allBans.push({
            linux_do_id: user.linux_do_id,
            username: user.username,
            linux_do_username: user.linux_do_username,
            banned_at: user.banned_at,
            banned_until: null,  // æ°¸ä¹…å°ç¦
            banned_reason: user.banned_reason || 'ç®¡ç†å‘˜æ‰‹åŠ¨å°ç¦',
            type: 'permanent',
            is_active: true
          });
        });
        
        // è€è™æœºå…è´¹æ¬¡æ•°è¡¨çš„å°ç¦ï¼ˆä¸´æ—¶å°ç¦ - å¾‹å¸ˆå‡½è§¦å‘ï¼‰
        freeSpinsBans.forEach(ban => {
          const banHours = ban.ban_hours || 60;  // é»˜è®¤60å°æ—¶ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
          
          // ğŸ”¥ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“ä¸­å­˜å‚¨çš„å°ç¦å¼€å§‹æ—¶é—´ï¼Œè€Œä¸æ˜¯åæ¨
          let bannedAt = ban.banned_at;
          
          // ğŸ”¥ å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰ banned_atï¼Œåˆ™åæ¨ï¼ˆä½†ä¼šä¸å‡†ç¡®ï¼‰
          if (!bannedAt || bannedAt === 0) {
            bannedAt = ban.banned_until - (banHours * 3600 * 1000);
          }
          
          allBans.push({
            linux_do_id: ban.linux_do_id,
            username: ban.username || ban.linux_do_id,
            linux_do_username: ban.linux_do_username || null,  // ğŸ”¥ ä½¿ç”¨åç«¯è¿”å›çš„ linux_do_username
            banned_at: bannedAt,  // ğŸ”¥ ä½¿ç”¨å®é™…çš„å°ç¦å¼€å§‹æ—¶é—´
            banned_until: ban.banned_until,
            banned_reason: `è§¦å‘3ä¸ªåŠä»¥ä¸Šå¾‹å¸ˆå‡½ï¼ˆå°ç¦${banHours}å°æ—¶ï¼‰`,
            type: 'temporary',
            is_active: ban.banned_until > Date.now(),
            ban_slot_mode: ban.ban_slot_mode || 'normal',
            ban_hours: banHours
          });
        });
        
        // ç»Ÿè®¡
        const totalBanned = allBans.length;
        const tempBanned = allBans.filter(b => b.type === 'temporary' && b.is_active).length;
        const permBanned = allBans.filter(b => b.type === 'permanent').length;
        
        document.getElementById('bannedUsersCount').textContent = totalBanned;
        document.getElementById('tempBannedCount').textContent = tempBanned;
        document.getElementById('permBannedCount').textContent = permBanned;
        
        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('bannedUsersTableBody');
        
        if (allBans.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-green-600 font-semibold">ğŸ‰ å½“å‰æ²¡æœ‰è¢«å°ç¦çš„ç”¨æˆ·</td></tr>';
          return;
        }
        
        // æŒ‰å°ç¦æ—¶é—´å€’åºæ’åº
        allBans.sort((a, b) => (b.banned_at || 0) - (a.banned_at || 0));
        
        tbody.innerHTML = allBans.map(ban => {
          // ğŸ”¥ ä¿®å¤ï¼šæ›´ä¸¥æ ¼çš„æ—¶é—´éªŒè¯ï¼Œé¿å… Invalid Date
          const bannedTime = (ban.banned_at && typeof ban.banned_at === 'number' && !isNaN(ban.banned_at))
            ? new Date(ban.banned_at).toLocaleString('zh-CN', { hour12: false })
            : '--';
          const unbanTime = ban.banned_until
            ? ((typeof ban.banned_until === 'number' && !isNaN(ban.banned_until))
                ? new Date(ban.banned_until).toLocaleString('zh-CN', { hour12: false })
                : '--')
            : 'æ°¸ä¹…';
          const isExpired = ban.banned_until && typeof ban.banned_until === 'number' && ban.banned_until < Date.now();
          
          // åœºæ¬¡ç±»å‹æ ‡ç­¾
          let slotModeBadge = '<span class="text-slate-400 text-xs">--</span>';
          if (ban.type === 'temporary' && ban.ban_slot_mode) {
            const modeConfig = {
              'normal': { text: 'åˆçº§åœº', color: 'bg-blue-100 text-blue-800', icon: 'ğŸ°' },
              'advanced': { text: 'é«˜çº§åœº', color: 'bg-purple-100 text-purple-800', icon: 'ğŸ’' },
              'supreme': { text: 'è‡³å°Šåœº', color: 'bg-amber-100 text-amber-800', icon: 'ğŸ‘‘' }
            };
            const config = modeConfig[ban.ban_slot_mode] || modeConfig['normal'];
            slotModeBadge = `<span class="px-2 py-1 ${config.color} rounded-full text-xs font-semibold">${config.icon} ${config.text}</span>`;
          }
          
          // å°ç¦ç±»å‹
          const typeBadge = ban.type === 'permanent' 
            ? '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">ğŸ”’ æ°¸ä¹…</span>'
            : '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">â±ï¸ ä¸´æ—¶</span>';
          
          // çŠ¶æ€
          const statusBadge = ban.is_active
            ? '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">ğŸš« å°ç¦ä¸­</span>'
            : '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… å·²è¿‡æœŸ</span>';
          
          // æ“ä½œæŒ‰é’®
          const actionButtons = ban.is_active
            ? `<button onclick="unbanUser('${ban.linux_do_id}', '${ban.username}')" class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg text-xs font-semibold shadow-sm transition-all">ğŸ”“ è§£å°</button>`
            : '<span class="text-slate-400 text-xs">å·²è¿‡æœŸ</span>';
          
          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 font-mono text-slate-600 text-xs">${ban.linux_do_id.substring(0, 8)}...</td>
              <td class="px-4 py-3">
                <div class="font-semibold text-slate-900">${ban.username}</div>
              </td>
              <td class="px-4 py-3">
                <div class="text-sm text-slate-700">${ban.linux_do_username || '--'}</div>
              </td>
              <td class="px-4 py-3 text-sm text-slate-600">${bannedTime}</td>
              <td class="px-4 py-3 text-sm ${isExpired ? 'text-green-600' : 'text-red-600'} font-semibold">${unbanTime}</td>
              <td class="px-4 py-3">
                <div class="text-sm text-slate-700">${ban.banned_reason}</div>
              </td>
              <td class="px-4 py-3 text-center">${slotModeBadge}</td>
              <td class="px-4 py-3 text-center">${typeBadge}</td>
              <td class="px-4 py-3 text-center">${statusBadge}</td>
              <td class="px-4 py-3 text-center">${actionButtons}</td>
            </tr>
          `;
        }).join('');
        
        showToast('å°ç¦è®°å½•å·²åŠ è½½', 'success');
      } catch (error) {
        console.error('åŠ è½½å°ç¦è®°å½•å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åˆ·æ–°å°ç¦è®°å½•
    function refreshBannedUsers() {
      loadBannedUsers();
    }
    
    // è§£å°ç”¨æˆ·
    async function unbanUser(linuxDoId, username) {
      if (!confirm(`ç¡®è®¤è§£å°ç”¨æˆ· "${username}" å—ï¼Ÿ\n\nè§£å°åè¯¥ç”¨æˆ·å¯ä»¥ç»§ç»­è¿›è¡ŒæŠ½å¥–ã€‚`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unban`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`âœ… ç”¨æˆ· "${username}" å·²è§£å°`, 'success');
          // åˆ·æ–°åˆ—è¡¨
          setTimeout(() => loadBannedUsers(), 500);
        } else {
          showToast(data.message || 'è§£å°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('è§£å°ç”¨æˆ·å¤±è´¥:', error);
        showToast('è§£å°æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // æ‰¹é‡è§£å°æ‰€æœ‰ç”¨æˆ·
    async function batchUnbanAllUsers() {
      try {
        // å…ˆè·å–å½“å‰æ‰€æœ‰å°ç¦ç”¨æˆ·
        const res = await fetch('/api/admin/users/banned');
        const data = await res.json();
        
        if (!data.success) {
          showToast('è·å–å°ç¦åˆ—è¡¨å¤±è´¥', 'error');
          return;
        }
        
        // åˆå¹¶ä¸¤ç§å°ç¦è®°å½•
        const bannedUsers = data.data.users || [];
        const freeSpinsBans = data.data.freeSpinsBans || [];
        
        // ç»Ÿè®¡éœ€è¦è§£å°çš„ç”¨æˆ·æ•°é‡
        const activeBannedCount = bannedUsers.length + freeSpinsBans.filter(b => b.banned_until > Date.now()).length;
        
        if (activeBannedCount === 0) {
          showToast('å½“å‰æ²¡æœ‰è¢«å°ç¦çš„ç”¨æˆ·', 'info');
          return;
        }
        
        if (!confirm(`ç¡®è®¤è¦æ‰¹é‡è§£å°æ‰€æœ‰ ${activeBannedCount} ä¸ªè¢«å°ç¦çš„ç”¨æˆ·å—ï¼Ÿ\n\næ­¤æ“ä½œå°†è§£é™¤ï¼š\nâ€¢ ${bannedUsers.length} ä¸ªæ°¸ä¹…å°ç¦ç”¨æˆ·\nâ€¢ ${freeSpinsBans.filter(b => b.banned_until > Date.now()).length} ä¸ªä¸´æ—¶å°ç¦ç”¨æˆ·\n\nè§£å°åæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ç»§ç»­è¿›è¡ŒæŠ½å¥–ã€‚`)) {
          return;
        }
        
        // æ”¶é›†æ‰€æœ‰éœ€è¦è§£å°çš„ç”¨æˆ·IDï¼ˆå»é‡ï¼‰
        const userIds = new Set();
        bannedUsers.forEach(u => userIds.add(u.linux_do_id));
        freeSpinsBans.forEach(b => userIds.add(b.linux_do_id));
        
        // æ‰¹é‡è§£å°
        let successCount = 0;
        let failCount = 0;
        
        showToast(`å¼€å§‹æ‰¹é‡è§£å° ${userIds.size} ä¸ªç”¨æˆ·...`, 'info');
        
        for (const userId of userIds) {
          try {
            const unbanRes = await fetch(`/api/admin/users/${userId}/unban`, {
              method: 'POST'
            });
            const unbanData = await unbanRes.json();
            
            if (unbanData.success) {
              successCount++;
            } else {
              failCount++;
            }
          } catch (err) {
            failCount++;
            console.error(`è§£å°ç”¨æˆ· ${userId} å¤±è´¥:`, err);
          }
        }
        
        // æ˜¾ç¤ºç»“æœ
        if (failCount === 0) {
          showToast(`ğŸ‰ æ‰¹é‡è§£å°å®Œæˆï¼æˆåŠŸè§£å° ${successCount} ä¸ªç”¨æˆ·`, 'success');
        } else {
          showToast(`æ‰¹é‡è§£å°å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, failCount > successCount ? 'error' : 'warning');
        }
        
        // åˆ·æ–°åˆ—è¡¨
        setTimeout(() => loadBannedUsers(), 500);
      } catch (error) {
        console.error('æ‰¹é‡è§£å°å¤±è´¥:', error);
        showToast('æ‰¹é‡è§£å°æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // é«˜çº§åœºæ¸¸æˆè®°å½•
    let advancedSlotCurrentPage = 1;
    let advancedSlotPageSize = 50;
    let advancedSlotAllRecords = [];  // å­˜å‚¨æ‰€æœ‰è®°å½•ç”¨äºç­›é€‰
    let advancedSlotFilters = {
      username: '',
      winType: 'all'
    };

    // ğŸš€ ä¼˜åŒ–ï¼šé«˜çº§åœºè®°å½•åŠ è½½ï¼ˆä½¿ç”¨æœåŠ¡ç«¯ç­›é€‰ï¼‰
    async function loadAdvancedSlotRecords(page = 1) {
      try {
        advancedSlotCurrentPage = page;

        // ğŸš€ ä¼˜åŒ–ï¼šä½¿ç”¨æœåŠ¡ç«¯ç­›é€‰
        const username = advancedSlotFilters.username || '';
        let url = `/api/admin/slot/advanced/records?page=${page}&pageSize=${advancedSlotPageSize}`;
        if (username) {
          url += `&username=${encodeURIComponent(username)}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          const { records, total, stats } = data.data;

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('advancedSlotTotal').textContent = stats.count;
          document.getElementById('advancedSlotTotalBet').textContent = `$${(stats.total_bet / 500000).toFixed(2)}`;
          document.getElementById('advancedSlotTotalWin').textContent = `$${(stats.total_win / 500000).toFixed(2)}`;
          const rtp = stats.total_bet > 0 ? ((stats.total_win / stats.total_win) * 100).toFixed(2) : '0.00';
          document.getElementById('advancedSlotRTP').textContent = `${rtp}%`;

          // æ¸²æŸ“è¡¨æ ¼
          const tbody = document.getElementById('advancedSlotRecordsBody');
          if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-400">æš‚æ— é«˜çº§åœºæ¸¸æˆè®°å½•</td></tr>';
          } else {
            tbody.innerHTML = records.map(r => {
              const symbols = JSON.parse(r.result_symbols);

              // ä¼˜å…ˆæ˜¾ç¤ºrule_nameï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨winTypeæ˜ å°„
              const displayWinType = r.rule_name || (() => {
                const winTypeNames = {
                  'super_jackpot': 'ğŸ† è¶…çº§å¤§å¥–',
                  'special_combo': 'ğŸ’ ç‰¹æ®Šç»„åˆ',
                  'quad': 'ğŸ° å››è¿',
                  'triple': 'âœ¨ ä¸‰è¿',
                  'double': 'ğŸ åŒè¿',
                  'man_only': 'ğŸ¯ Manç»„åˆ',
                  'man_quad': 'ğŸ° ManÃ—4',
                  'symmetric': 'ğŸ”„ å¯¹ç§°ABBA',
                  'consecutive': 'â­ è¿ç»­',
                  'combination': 'ğŸ ç»„åˆ',
                  'any': 'ğŸ² ä»»æ„',
                  'double_pair': 'ğŸ­ ä¸¤å¯¹',
                  'punishment': 'âš¡ å¾‹å¸ˆå‡½',
                  'none': 'âŒ æœªä¸­å¥–'
                };
                return winTypeNames[r.win_type] || r.win_type;
              })();

              const winAmount = r.win_amount;
              const amountClass = winAmount > 0 ? 'text-green-600 font-semibold' : (winAmount < 0 ? 'text-red-600 font-semibold' : 'text-slate-600');

              return `
                <tr class="border-t border-slate-200 hover:bg-slate-50">
                  <td class="px-4 py-3 text-sm text-slate-600">${r.id}</td>
                  <td class="px-4 py-3 text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                  <td class="px-4 py-3 text-sm">
                    <div class="font-medium text-slate-900">${r.linux_do_username || r.username}</div>
                    <div class="text-xs text-slate-500">${r.username}</div>
                  </td>
                  <td class="px-4 py-3 text-sm font-semibold text-blue-600">$${(r.bet_amount / 500000).toFixed(2)}</td>
                  <td class="px-4 py-3 text-sm">
                    <div class="flex gap-1">
                      ${symbols.map(s => {
                        const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
                        return `<img src="/slot-symbols/${s}.${ext}" class="w-8 h-8 object-contain" title="${s}">`;
                      }).join('')}
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm">${displayWinType}</td>
                  <td class="px-4 py-3 text-sm font-semibold">${r.win_multiplier}x</td>
                  <td class="px-4 py-3 text-sm ${amountClass}">${winAmount >= 0 ? '+' : ''}$${(winAmount / 500000).toFixed(2)}</td>
                </tr>
              `;
            }).join('');
          }

          // æ›´æ–°åˆ†é¡µ
          document.getElementById('advancedSlotRecordsTotal').textContent = total;
          document.getElementById('advancedSlotCurrentPage').textContent = page;
          document.getElementById('advancedSlotPrevBtn').disabled = page <= 1;
          document.getElementById('advancedSlotNextBtn').disabled = records.length < advancedSlotPageSize;

          if (total > 0) {
            document.getElementById('advancedSlotRecordsPagination').classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('åŠ è½½é«˜çº§åœºè®°å½•å¤±è´¥', e);
        showMessage('åŠ è½½è®°å½•å¤±è´¥', 'error');
      }
    }

    function refreshAdvancedSlotRecords() {
      loadAdvancedSlotRecords(advancedSlotCurrentPage);
    }

    function advancedSlotPrevPage() {
      if (advancedSlotCurrentPage > 1) {
        loadAdvancedSlotRecords(advancedSlotCurrentPage - 1);
      }
    }

    function advancedSlotNextPage() {
      loadAdvancedSlotRecords(advancedSlotCurrentPage + 1);
    }
    
    // ğŸ”¥ é«˜çº§åœºè®°å½•ç­›é€‰å‡½æ•°
    function filterAdvancedSlotRecords() {
      advancedSlotFilters.username = document.getElementById('advancedRecordSearchInput').value.trim();
      advancedSlotFilters.winType = document.getElementById('advancedWinTypeFilter').value;
      
      advancedSlotCurrentPage = 1;
      loadAdvancedSlotRecords(1);
    }
    
    // ğŸ”¥ åˆ·æ–°å¹¶ä¿ç•™ç­›é€‰æ¡ä»¶
    async function refreshAdvancedSlotRecordsKeepFilter() {
      // ğŸ”¥ æ‰¾åˆ°åˆ·æ–°æŒ‰é’®å¹¶æ·»åŠ æ—‹è½¬åŠ¨ç”»
      const refreshBtn = event?.target?.closest('button');
      const refreshIcon = refreshBtn?.querySelector('svg');
      if (refreshIcon) {
        refreshIcon.classList.add('animate-spin');
      }
      
      await loadAdvancedSlotRecords(advancedSlotCurrentPage);
      
      // ğŸ”¥ åœæ­¢åŠ¨ç”»
      if (refreshIcon) {
        refreshIcon.classList.remove('animate-spin');
      }
    }
    
    // ğŸ”¥ æ¸…é™¤é«˜çº§åœºç­›é€‰æ¡ä»¶
    function clearAdvancedRecordFilters() {
      document.getElementById('advancedRecordSearchInput').value = '';
      document.getElementById('advancedWinTypeFilter').value = 'all';
      
      advancedSlotFilters.username = '';
      advancedSlotFilters.winType = 'all';
      
      advancedSlotCurrentPage = 1;
      loadAdvancedSlotRecords(1);
      
      showToast('å·²é‡ç½®ç­›é€‰æ¡ä»¶', 'success');
    }

    // å…¥åœºåˆ¸æ‰è½è®°å½•
    let ticketDropCurrentPage = 1;
    let ticketDropPageSize = 50;

    async function loadTicketDropRecords(page = 1) {
      try {
        ticketDropCurrentPage = page;
        const res = await fetch(`/api/admin/slot/tickets/drop-records?page=${page}&pageSize=${ticketDropPageSize}`);
        const data = await res.json();

        if (data.success) {
          const { records, total, stats } = data.data;
          
          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('ticketDropTotal').textContent = stats.total;
          document.getElementById('ticketDropCount').textContent = stats.ticket_drops;
          document.getElementById('fragmentDropCount').textContent = stats.fragment_drops;
          document.getElementById('todayDropCount').textContent = stats.today_drops;
          
          // æ¸²æŸ“è¡¨æ ¼
          const tbody = document.getElementById('ticketDropRecordsBody');
          if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">æš‚æ— æ‰è½è®°å½•</td></tr>';
          } else {
            tbody.innerHTML = records.map(r => {
              const dropIcon = r.drop_type === 'ticket' ? 'ğŸŸï¸' : 'ğŸ§©';
              const dropName = r.drop_type === 'ticket' ? 'å…¥åœºåˆ¸' : 'ç¢ç‰‡';
              const winTypeNames = {
                'quad': 'ğŸ° å››è¿',
                'triple': 'âœ¨ ä¸‰è¿',
                'double': 'ğŸ åŒè¿'
              };
              
              return `
                <tr class="border-t border-slate-200 hover:bg-slate-50">
                  <td class="px-4 py-3 text-sm text-slate-600">${r.id}</td>
                  <td class="px-4 py-3 text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                  <td class="px-4 py-3 text-sm font-medium text-slate-900">${r.username}</td>
                  <td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                      ${dropIcon} ${dropName}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm font-semibold text-indigo-600">${r.drop_count}</td>
                  <td class="px-4 py-3 text-sm">${winTypeNames[r.trigger_win_type] || r.trigger_win_type}</td>
                </tr>
              `;
            }).join('');
          }
          
          // æ›´æ–°åˆ†é¡µ
          document.getElementById('ticketDropRecordsTotal').textContent = total;
          document.getElementById('ticketDropCurrentPage').textContent = page;
          document.getElementById('ticketDropPrevBtn').disabled = page <= 1;
          document.getElementById('ticketDropNextBtn').disabled = records.length < ticketDropPageSize;
          
          if (total > 0) {
            document.getElementById('ticketDropPagination').classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('åŠ è½½æ‰è½è®°å½•å¤±è´¥', e);
        showMessage('åŠ è½½è®°å½•å¤±è´¥', 'error');
      }
    }

    function ticketDropPrevPage() {
      if (ticketDropCurrentPage > 1) {
        loadTicketDropRecords(ticketDropCurrentPage - 1);
      }
    }

    function ticketDropNextPage() {
      loadTicketDropRecords(ticketDropCurrentPage + 1);
    }

    // é«˜çº§åœºç¬¦å·æƒé‡ç®¡ç†
    async function loadAdvancedSymbolWeights() {
      try {
        const res = await fetch('/api/admin/slot/advanced/weights');
        const data = await res.json();

        if (data.success) {
          const weights = data.data;
          
          // å¡«å……è¡¨å•
          document.getElementById('advWeight_m').value = weights.weight_m;
          document.getElementById('advWeight_t').value = weights.weight_t;
          document.getElementById('advWeight_n').value = weights.weight_n;
          document.getElementById('advWeight_j').value = weights.weight_j;
          document.getElementById('advWeight_lq').value = weights.weight_lq;
          document.getElementById('advWeight_bj').value = weights.weight_bj;
          document.getElementById('advWeight_zft').value = weights.weight_zft;
          document.getElementById('advWeight_bdk').value = weights.weight_bdk;
          document.getElementById('advWeight_lsh').value = weights.weight_lsh;
          
          // è®¡ç®—å¹¶æ˜¾ç¤ºæ¦‚ç‡
          calculateAdvancedProbabilities();
        }
      } catch (error) {
        console.error('åŠ è½½é«˜çº§åœºç¬¦å·æƒé‡å¤±è´¥:', error);
        showMessage('åŠ è½½æƒé‡å¤±è´¥', 'error');
      }
    }

    async function saveAdvancedSymbolWeights() {
      try {
        const weights = {
          weight_m: parseInt(document.getElementById('advWeight_m').value),
          weight_t: parseInt(document.getElementById('advWeight_t').value),
          weight_n: parseInt(document.getElementById('advWeight_n').value),
          weight_j: parseInt(document.getElementById('advWeight_j').value),
          weight_lq: parseInt(document.getElementById('advWeight_lq').value),
          weight_bj: parseInt(document.getElementById('advWeight_bj').value),
          weight_zft: parseInt(document.getElementById('advWeight_zft').value),
          weight_bdk: parseInt(document.getElementById('advWeight_bdk').value),
          weight_lsh: parseInt(document.getElementById('advWeight_lsh').value)
        };
        
        // éªŒè¯
        for (const [key, value] of Object.entries(weights)) {
          if (isNaN(value) || value < 1 || value > 1000) {
            showMessage(`${key} æƒé‡å¿…é¡»åœ¨1-1000ä¹‹é—´`, 'error');
            return;
          }
        }
        
        const res = await fetch('/api/admin/slot/advanced/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weights)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showMessage('é«˜çº§åœºæƒé‡é…ç½®å·²æ›´æ–°', 'success');
          calculateAdvancedProbabilities();
        } else {
          showMessage(data.message, 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜é«˜çº§åœºæƒé‡å¤±è´¥:', error);
        showMessage('ä¿å­˜æƒé‡å¤±è´¥', 'error');
      }
    }

    // ğŸ”¥ æ˜¾ç¤ºRTPå¸®åŠ©è¯´æ˜
    function showRTPHelp() {
      alert(`ğŸ§  å€ç‡ä¸RTPè¯´æ˜

RTP (Return to Player)ï¼š
â€¢ è¿”è¿˜ç©å®¶ç‡ï¼Œè¡¨ç¤ºç©å®¶é•¿æœŸæ¸¸æˆèƒ½æ‹¿å›çš„æŠ•æ³¨æ¯”ä¾‹
â€¢ ä¾‹å¦‚ï¼šRTP 0.88 = 88%ï¼Œç©å®¶é•¿æœŸå¹³å‡èƒ½æ‹¿å›88%çš„æŠ•æ³¨

å¥–åŠ±å€æ•°ï¼š
â€¢ é«˜çº§åœºçš„å¥–åŠ±å€æ•°æ”¾å¤§ç³»æ•°
â€¢ ä¾‹å¦‚ï¼šåŸºç¡€å€ç‡8xï¼Œå¥–åŠ±å€æ•°4.0ï¼Œå®é™…å¥–åŠ± = 8 Ã— 4 = 32x

æƒ©ç½šå€æ•°ï¼š
â€¢ å¾‹å¸ˆå‡½çš„æƒ©ç½šé‡‘é¢æ”¾å¤§ç³»æ•°
â€¢ ä¾‹å¦‚ï¼š1ä¸ªå¾‹å¸ˆå‡½æ‰£1å€æŠ•æ³¨ï¼Œæƒ©ç½šå€æ•°2.0ï¼Œå®é™…æ‰£é™¤ = 1 Ã— 2 = 2å€æŠ•æ³¨
â€¢ å¾‹å¸ˆå‡½å‡ºç°æ¦‚ç‡ç”±æƒé‡é…ç½®å•ç‹¬æ§åˆ¶

æ¨èé…ç½®ï¼š
â€¢ å¥–åŠ±å€æ•°ï¼š4.0ï¼ˆä¸­å¥–é‡‘é¢æ”¾å¤§ï¼‰
â€¢ æƒ©ç½šå€æ•°ï¼š2.0ï¼ˆå¾‹å¸ˆå‡½æƒ©ç½šæ”¾å¤§ï¼‰`);
    }
    
    function calculateAdvancedProbabilities() {
      const weights = {
        m: parseInt(document.getElementById('advWeight_m').value) || 100,
        t: parseInt(document.getElementById('advWeight_t').value) || 100,
        n: parseInt(document.getElementById('advWeight_n').value) || 100,
        j: parseInt(document.getElementById('advWeight_j').value) || 100,
        lq: parseInt(document.getElementById('advWeight_lq').value) || 100,
        bj: parseInt(document.getElementById('advWeight_bj').value) || 100,
        zft: parseInt(document.getElementById('advWeight_zft').value) || 100,
        bdk: parseInt(document.getElementById('advWeight_bdk').value) || 100,
        lsh: parseInt(document.getElementById('advWeight_lsh').value) || 50,
        man: parseInt(document.getElementById('advWeight_man').value) || 30
      };
      
      const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
      document.getElementById('advTotalWeight').textContent = totalWeight;
      
      // è®¡ç®—æ¯ä¸ªç¬¦å·çš„æ¦‚ç‡
      for (const [symbol, weight] of Object.entries(weights)) {
        const prob = ((weight / totalWeight) * 100).toFixed(2);
        const probEl = document.getElementById(`advProb_${symbol}`);
        
        if (symbol === 'lsh') {
          // å¾‹å¸ˆå‡½ç‰¹æ®Šè®¡ç®—ï¼šè‡³å°‘å‡ºç°1æ¬¡çš„æ¦‚ç‡
          const singleProb = weight / totalWeight;
          const atLeastOne = (1 - Math.pow(1 - singleProb, 4)) * 100;
          probEl.textContent = `æ¦‚ç‡: ${prob}% | 4ä¸ªä½ç½®è‡³å°‘å‡ºç°1æ¬¡: ${atLeastOne.toFixed(2)}%`;
        } else {
          probEl.textContent = `æ¦‚ç‡: ${prob}%`;
        }
      }
    }

    function resetAdvancedWeightsToDefault() {
      if (!confirm('ç¡®å®šè¦æ¢å¤é«˜çº§åœºç¬¦å·æƒé‡ä¸ºé»˜è®¤å€¼å—ï¼Ÿ\né»˜è®¤ï¼šæ™®é€šç¬¦å·100ï¼Œå¾‹å¸ˆå‡½50')) {
        return;
      }
      
      document.getElementById('advWeight_m').value = 100;
      document.getElementById('advWeight_t').value = 100;
      document.getElementById('advWeight_n').value = 100;
      document.getElementById('advWeight_j').value = 100;
      document.getElementById('advWeight_lq').value = 100;
      document.getElementById('advWeight_bj').value = 100;
      document.getElementById('advWeight_zft').value = 100;
      document.getElementById('advWeight_bdk').value = 100;
      document.getElementById('advWeight_lsh').value = 50;
      
      calculateAdvancedProbabilities();
    }

    // ================== Achievement Management Functions ==================

    // Global variables for achievement management
    let allAchievements = [];
    let filteredAchievements = [];

    /**
     * Load and display achievements
     */
    async function refreshAchievements() {
      const icon = document.getElementById('achievementRefreshIcon');
      icon.classList.add('refresh-spin');

      try {
        const response = await fetch('/api/achievement/all');
        const data = await response.json();

        if (data.success) {
          allAchievements = data.data;
          filteredAchievements = [...allAchievements];
          updateAchievementStats();
          displayAchievements();
          showToast('âœ… æˆå°±æ•°æ®åŠ è½½æˆåŠŸ', 'success');
        } else {
          showToast('âŒ åŠ è½½å¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Load achievements error:', error);
        showToast('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error');
      } finally {
        setTimeout(() => icon.classList.remove('refresh-spin'), 600);
      }
    }

    /**
     * Update achievement statistics
     */
    function updateAchievementStats() {
      const totalAchievements = allAchievements.length;
      const totalUsers = allAchievements[0]?.total_users || 0;
      const totalRewardsPool = allAchievements.reduce((sum, a) => sum + (a.reward_quota || 0), 0);
      const totalDistributed = allAchievements.reduce((sum, a) => sum + (a.unlock_count || 0) * (a.reward_quota || 0), 0);

      document.getElementById('totalAchievements').textContent = totalAchievements;
      document.getElementById('totalAchievementUsers').textContent = totalUsers;
      document.getElementById('totalRewardsPool').textContent = '$' + (totalRewardsPool / 500000).toFixed(2);
      document.getElementById('totalRewardsDistributed').textContent = '$' + (totalDistributed / 500000).toFixed(2);
    }

    /**
     * Display achievements in table
     */
    function displayAchievements() {
      const tbody = document.getElementById('achievementTableBody');

      if (filteredAchievements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æˆå°±</td></tr>';
        return;
      }

      const rarityColors = {
        common: 'bg-slate-100 text-slate-700',
        rare: 'bg-blue-100 text-blue-700',
        epic: 'bg-purple-100 text-purple-700',
        legendary: 'bg-yellow-100 text-yellow-700'
      };

      const rarityNames = {
        common: 'æ™®é€š',
        rare: 'ç¨€æœ‰',
        epic: 'å²è¯—',
        legendary: 'ä¼ è¯´'
      };

      tbody.innerHTML = filteredAchievements.map(achievement => `
        <tr class="border-b border-slate-100 hover:bg-slate-50">
          <td class="px-4 py-3 text-center text-2xl">${achievement.icon || 'ğŸ†'}</td>
          <td class="px-4 py-3">
            <div class="font-semibold text-slate-900">${achievement.achievement_name}</div>
            <div class="text-xs text-slate-500 mt-1">${achievement.achievement_desc || ''}</div>
            <div class="text-xs text-slate-400 mt-1">Key: ${achievement.achievement_key}</div>
          </td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs font-medium">${achievement.category}</span>
          </td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 ${rarityColors[achievement.rarity]} rounded text-xs font-medium">${rarityNames[achievement.rarity]}</span>
          </td>
          <td class="px-4 py-3 text-right">
            <div class="font-semibold text-slate-900">$${(achievement.reward_quota / 500000).toFixed(2)}</div>
            <div class="text-xs text-slate-400">${achievement.reward_quota} quota</div>
          </td>
          <td class="px-4 py-3 text-center font-semibold">${achievement.unlock_count || 0}</td>
          <td class="px-4 py-3 text-center">
            <div class="font-semibold">${achievement.unlock_rate || 0}%</div>
            <div class="text-xs text-slate-400">${achievement.unlock_count || 0}/${achievement.total_users || 0}</div>
          </td>
          <td class="px-4 py-3 text-center">
            <button onclick="editAchievementReward('${achievement.achievement_key}', ${achievement.reward_quota})"
                    class="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-xs font-medium transition-colors">
              ç¼–è¾‘å¥–åŠ±
            </button>
          </td>
        </tr>
      `).join('');
    }

    /**
     * Filter achievements by category, rarity, and search term
     */
    function filterAchievements() {
      const category = document.getElementById('achievementCategoryFilter').value;
      const rarity = document.getElementById('achievementRarityFilter').value;
      const searchTerm = document.getElementById('achievementSearchInput').value.toLowerCase();

      filteredAchievements = allAchievements.filter(achievement => {
        const matchesCategory = !category || achievement.category === category;
        const matchesRarity = !rarity || achievement.rarity === rarity;
        const matchesSearch = !searchTerm ||
                              achievement.achievement_name.toLowerCase().includes(searchTerm) ||
                              (achievement.achievement_desc && achievement.achievement_desc.toLowerCase().includes(searchTerm)) ||
                              achievement.achievement_key.toLowerCase().includes(searchTerm);

        return matchesCategory && matchesRarity && matchesSearch;
      });

      displayAchievements();
    }

    /**
     * Edit achievement reward amount
     */
    async function editAchievementReward(achievementKey, currentReward) {
      const currentUSD = (currentReward / 500000).toFixed(2);
      const newUSD = prompt(`ç¼–è¾‘æˆå°±å¥–åŠ±é‡‘é¢\næˆå°±: ${achievementKey}\nå½“å‰å¥–åŠ±: $${currentUSD}\n\nè¯·è¾“å…¥æ–°çš„å¥–åŠ±é‡‘é¢ï¼ˆç¾å…ƒï¼‰:`, currentUSD);

      if (newUSD === null) return; // User cancelled

      const newUSDValue = parseFloat(newUSD);
      if (isNaN(newUSDValue) || newUSDValue < 0) {
        showToast('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'error');
        return;
      }

      const newQuota = Math.floor(newUSDValue * 500000);

      if (!confirm(`ç¡®è®¤ä¿®æ”¹å¥–åŠ±é‡‘é¢ï¼Ÿ\næˆå°±: ${achievementKey}\næ–°é‡‘é¢: $${newUSDValue.toFixed(2)} (${newQuota} quota)`)) {
        return;
      }

      try {
        const password = localStorage.getItem('admin_password');
        const response = await fetch('/api/achievement/admin/update-reward', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Password': password
          },
          body: JSON.stringify({
            achievement_key: achievementKey,
            reward_quota: newQuota
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast(`âœ… å¥–åŠ±é‡‘é¢å·²æ›´æ–°ä¸º $${newUSDValue.toFixed(2)}`, 'success');
          await refreshAchievements();
        } else {
          showToast('âŒ æ›´æ–°å¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Update reward error:', error);
        showToast('âŒ æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    /**
     * Load and display achievement leaderboard
     */
    async function refreshAchievementLeaderboard() {
      const icon = document.getElementById('leaderboardRefreshIcon');
      icon.classList.add('refresh-spin');

      try {
        const response = await fetch('/api/achievement/leaderboard?limit=100');
        const data = await response.json();

        if (data.success) {
          displayLeaderboard(data.data);
          showToast('âœ… æ’è¡Œæ¦œæ•°æ®åŠ è½½æˆåŠŸ', 'success');
        } else {
          showToast('âŒ åŠ è½½å¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Load leaderboard error:', error);
        showToast('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error');
      } finally {
        setTimeout(() => icon.classList.remove('refresh-spin'), 600);
      }
    }

    /**
     * Display leaderboard in table
     */
    function displayLeaderboard(leaderboard) {
      const tbody = document.getElementById('leaderboardTableBody');

      if (!leaderboard || leaderboard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">æš‚æ— æ’è¡Œæ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = leaderboard.map((user, index) => {
        const rank = index + 1;
        const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
        const completionRate = user.completion_rate ? user.completion_rate.toFixed(1) : '0.0';
        const totalRewards = (user.total_rewards || 0) / 500000;
        const claimedRewards = (user.claimed_rewards || 0) / 500000;

        // Display badges
        const badges = [user.badge_slot_1, user.badge_slot_2, user.badge_slot_3]
          .filter(b => b)
          .map(b => `<span class="inline-block px-1 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs">${b}</span>`)
          .join(' ');

        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 text-center font-bold text-lg">${rankEmoji}</td>
            <td class="px-4 py-3">
              <div class="font-semibold text-slate-900">${user.username || user.linux_do_username || 'Unknown'}</div>
              <div class="text-xs text-slate-400">${user.linux_do_id}</div>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="font-semibold">${user.unlocked_achievements}/${user.total_achievements}</span>
            </td>
            <td class="px-4 py-3 text-center">
              <div class="flex items-center justify-center gap-2">
                <div class="w-16 bg-slate-200 rounded-full h-2">
                  <div class="bg-indigo-600 h-2 rounded-full" style="width: ${completionRate}%"></div>
                </div>
                <span class="text-sm font-medium">${completionRate}%</span>
              </div>
            </td>
            <td class="px-4 py-3 text-right font-semibold">$${totalRewards.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-semibold text-green-600">$${claimedRewards.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">${badges || '-'}</td>
          </tr>
        `;
      }).join('');
    }

  </script>
</body>
</html>