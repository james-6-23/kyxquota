<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理后台 - KYX API Refueling Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚙️</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .refresh-spin {
      animation: spin 0.6s ease-in-out;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  <!-- Loading Section -->
  <div id="loadingSection" class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-white text-lg">验证登录中...</p>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
      <div class="flex justify-center mb-6">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full blur-xl opacity-50 animate-pulse"></div>
          <div class="relative bg-gradient-to-br from-indigo-500 to-purple-600 p-4 rounded-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
        </div>
      </div>
      <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">管理员后台</h1>
      <p class="text-center text-slate-600 mb-8 text-sm">⚙️ 系统管理控制台</p>
      <input type="password" id="password" placeholder="请输入管理员密码" class="w-full px-4 py-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
      <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
        登录
      </button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminSection" class="hidden min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <h1 class="text-xl font-bold text-slate-900">KYX API 管理后台</h1>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">管理员</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="flex">
      <aside class="w-64 bg-white min-h-screen border-r border-slate-200">
        <nav class="p-4">
          <button onclick="showSection('dashboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 bg-indigo-100 text-indigo-700 font-semibold flex items-center gap-2">
            <span>📊</span> 仪表板
          </button>
          <button onclick="showSection('config')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>⚙️</span> 系统配置
          </button>
          <button onclick="showSection('keys')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🔑</span> Keys 管理
          </button>
          <button onclick="showSection('claims')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📥</span> 领取记录
          </button>
          <button onclick="showSection('donates')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎁</span> 投喂记录
          </button>
          <button onclick="showSection('slotRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎰</span> 老虎机记录
          </button>
          <button onclick="showSection('slotConfig')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>⚙️</span> 老虎机配置
          </button>
          <button onclick="showSection('slotAnalytics')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📈</span> 抽奖分析
          </button>
          <button onclick="showSection('slotLeaderboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🏆</span> 用户获奖排行
          </button>
          <button onclick="showSection('users')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>👥</span> 用户列表
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6">
        <!-- Dashboard -->
        <div id="dashboardSection">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">仪表板</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">📥</div>
                <div>
                  <p class="text-sm text-slate-600">领取记录总数</p>
                  <p id="claimCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">🎁</div>
                <div>
                  <p class="text-sm text-slate-600">投喂记录总数</p>
                  <p id="donateCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-2xl">👥</div>
                <div>
                  <p class="text-sm text-slate-600">注册用户总数</p>
                  <p id="userCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">💰</div>
                <div>
                  <p class="text-sm text-slate-600">当前领取额度</p>
                  <p id="currentQuota" class="text-2xl font-bold text-slate-900">--</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 当前配置卡片 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-900">当前系统配置</h3>
              </div>
              <button onclick="showSection('config')" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                <span>编辑配置</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- 每日领取额度 -->
              <div class="p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">💰</span>
                  <span class="text-sm font-semibold text-slate-700">每日领取额度</span>
                </div>
                <p id="dashboardQuota" class="text-2xl font-bold text-purple-700">--</p>
                <p class="text-xs text-slate-600 mt-1">≈ <span id="dashboardQuotaUSD">--</span> quota</p>
              </div>

              <!-- 每日最大领取次数 -->
              <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border border-green-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔢</span>
                  <span class="text-sm font-semibold text-slate-700">每日最大领取次数</span>
                </div>
                <p id="dashboardMaxClaims" class="text-2xl font-bold text-green-700">--</p>
                <p class="text-xs text-slate-600 mt-1">次/天</p>
              </div>

              <!-- API Session 状态 -->
              <div class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg border border-orange-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔑</span>
                  <span class="text-sm font-semibold text-slate-700">API Session</span>
                </div>
                <p id="dashboardSessionStatus" class="text-lg font-bold text-orange-700">--</p>
                <p class="text-xs text-slate-600 mt-1">KYX API 认证</p>
              </div>

              <!-- New-API-User -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🆔</span>
                  <span class="text-sm font-semibold text-slate-700">New-API-User</span>
                </div>
                <p id="dashboardNewApiUser" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">请求头参数</p>
              </div>

              <!-- Keys API URL -->
              <div class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg border border-blue-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔗</span>
                  <span class="text-sm font-semibold text-slate-700">Keys API URL</span>
                </div>
                <p id="dashboardKeysApi" class="text-sm font-mono text-blue-700 truncate" title="">--</p>
                <p class="text-xs text-slate-600 mt-1">验证服务地址</p>
              </div>

              <!-- ModelScope Group ID -->
              <div class="p-4 bg-gradient-to-br from-pink-50 to-rose-50 rounded-lg border border-pink-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">👥</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope Group ID</span>
                </div>
                <p id="dashboardGroupId" class="text-2xl font-bold text-pink-700">--</p>
                <p class="text-xs text-slate-600 mt-1">ModelScope 分组</p>
              </div>

              <!-- iFlow Group ID -->
              <div class="p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg border border-emerald-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">✨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow Group ID</span>
                </div>
                <p id="dashboardIflowGroupId" class="text-2xl font-bold text-emerald-700">--</p>
                <p class="text-xs text-slate-600 mt-1">iFlow 分组</p>
              </div>

              <!-- Keys Authorization -->
              <div class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔐</span>
                  <span class="text-sm font-semibold text-slate-700">Keys Authorization</span>
                </div>
                <p id="dashboardKeysAuth" class="text-sm font-mono text-indigo-700 truncate" title="">--</p>
                <p id="dashboardKeysAuthStatus" class="text-xs text-slate-600 mt-1">--</p>
              </div>

              <!-- ModelScope 投喂限制 -->
              <div class="p-4 bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg border border-amber-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🎁</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope 投喂限制</span>
                </div>
                <p id="dashboardMaxDonateModelscope" class="text-2xl font-bold text-amber-700">--</p>
                <p class="text-xs text-slate-600 mt-1">个/天</p>
              </div>

              <!-- iFlow 投喂限制 -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-green-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">✨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow 投喂限制</span>
                </div>
                <p id="dashboardMaxDonateIflow" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">个/天</p>
              </div>
            </div>

            <!-- 更新时间 -->
            <div class="mt-4 pt-4 border-t border-slate-200">
              <p class="text-xs text-slate-500 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>最后更新：<span id="dashboardUpdatedAt">--</span></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Config Section -->
        <div id="configSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">系统配置</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <!-- 额度说明 -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm text-blue-900">
                  <p class="font-semibold mb-1">💰 额度单位换算</p>
                  <p class="text-blue-800">500,000 quota = <strong>$1 美元</strong></p>
                  <p class="text-blue-700 text-xs mt-1">示例：20,000,000 quota = $40</p>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">每日领取额度</label>
              <div class="flex gap-2 items-center">
                <div class="flex-1 relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">$</span>
                  <input type="number" id="claimQuotaUSD" placeholder="40" step="0.01" min="0" class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <span class="text-sm text-slate-600 whitespace-nowrap">≈ <span id="quotaValue">20,000,000</span> quota</span>
                <button onclick="updateQuota()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">输入美元金额，自动转换为 quota（$1 = 500,000 quota）</p>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">每日最大领取次数</label>
              <div class="flex gap-2 items-center">
                <input type="number" id="maxDailyClaims" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                <span class="text-sm text-slate-600">次/天</span>
                <button onclick="updateMaxDailyClaims()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">API Session</label>
              <div class="mb-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                <div class="text-xs text-slate-500 mb-1">当前 Session:</div>
                <div id="currentSession" class="text-sm font-mono text-slate-700 break-all">未配置</div>
              </div>
              <div class="flex gap-2">
                <input type="text" id="sessionValue" placeholder="输入新的 Session" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg font-mono">
                <button onclick="updateSession()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">New-API-User</label>
              <div class="mb-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="text-xs text-blue-800">
                    <p>KYX API 请求头参数，用于用户搜索和额度更新</p>
                    <p class="mt-1">默认值：<code class="px-1 bg-blue-100 rounded">1</code>（通常无需修改）</p>
                  </div>
                </div>
              </div>
              <div class="flex gap-2 items-center">
                <input type="text" id="newApiUserValue" placeholder="1" class="w-32 px-4 py-2 border border-slate-300 rounded-lg text-center font-mono">
                <span class="text-sm text-slate-600">当前值: <code id="currentNewApiUser" class="px-2 py-1 bg-slate-100 rounded font-mono">1</code></span>
                <button onclick="updateNewApiUser()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys API URL</label>
              <div class="flex gap-2">
                <input type="text" id="keysApiUrl" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysApiUrl()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys Authorization</label>
              <div class="flex gap-2">
                <input type="text" id="keysAuthorization" placeholder="输入 Authorization Token" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysAuthorization()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="modelscopeGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateModelscopeGroupId()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="iflowGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateIflowGroupId()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">更新</button>
              </div>
            </div>
            
            <!-- 投喂限制配置 -->
            <div class="mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
              <h4 class="text-lg font-bold text-amber-900 mb-4 flex items-center gap-2">
                <span>🎁</span>
                <span>每日投喂限制配置</span>
              </h4>
              <p class="text-sm text-amber-800 mb-4">控制用户每天可以投喂的 Key 数量，不同渠道单独配置</p>
              
              <!-- ModelScope 投喂限制 -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope 每日投喂限制</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateModelscope" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">个/天</span>
                  <button onclick="updateMaxDailyDonateModelscope()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
              </div>
              
              <!-- iFlow 投喂限制 -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow 每日投喂限制</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateIflow" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">个/天</span>
                  <button onclick="updateMaxDailyDonateIflow()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 whitespace-nowrap">更新</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Keys Section -->
        <div id="keysSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">Keys 管理</h2>
            <button onclick="refreshKeys()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="keysRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex gap-2">
                <button onclick="exportKeys()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">📥 导出所有</button>
                <button onclick="copyAllKeys()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">📋 复制所有</button>
                <button onclick="testAllKeys()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">🧪 一键测试</button>
              </div>
              <button onclick="toggleKeysBatchMode()" id="keysBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">批量操作</button>
            </div>
            <div id="keysBatchActions" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllKeys" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">全选 (<span id="selectedKeysCount">0</span> 个已选)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="deleteSelectedKeys()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">🗑️ 删除选中</button>
                  <button onclick="testSelectedKeys()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">🧪 测试选中</button>
                </div>
              </div>
            </div>
            <p class="text-sm text-slate-600">总计: <span id="totalKeysCount">0</span> 个 Key</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="keysCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllKeysHeader" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Key</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">渠道</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">投喂用户</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">投喂时间</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">测试状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="keysListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Claims Section -->
        <div id="claimsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">领取记录</h2>
            <button onclick="refreshClaims()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="claimsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="claimsTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="claimsPageSize" onchange="changeClaimsPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">类型</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">领取额度</th>
                  </tr>
                </thead>
                <tbody id="claimTableBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="claimPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="claimCurrentPage">1</span> / <span id="claimTotalPages">1</span> 页（共 <span id="claimTotal">0</span> 条）
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadClaimRecords(claimCurrentPage - 1)" id="claimPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="claimPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadClaimRecords(claimCurrentPage + 1)" id="claimNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Donates Section -->
        <div id="donatesSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">投喂记录</h2>
            <button onclick="refreshDonates()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="donatesRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="donatesTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="donatesPageSize" onchange="changeDonatesPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">渠道</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">Key 数量</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">增加额度</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">推送状态</th>
                  </tr>
                </thead>
                <tbody id="donateTableBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="donatePagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="donateCurrentPage">1</span> / <span id="donateTotalPages">1</span> 页（共 <span id="donateTotal">0</span> 条）
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadDonateRecords(donateCurrentPage - 1)" id="donatePrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="donatePageNumbers" class="flex gap-1"></div>
                  <button onclick="loadDonateRecords(donateCurrentPage + 1)" id="donateNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slot Machine Config Section -->
        <div id="slotConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">老虎机配置</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">基本配置</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  投注金额 (单位: $, 500000 = $1)
                </label>
                <input type="number" step="0.01" id="slotBetAmountUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">当前：$<span id="slotBetAmountDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  每日游玩次数
                </label>
                <input type="number" id="slotMaxDailySpins" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="5">
                <p class="text-xs text-slate-500 mt-1">每个用户每天最多可玩的次数</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  最低额度要求 (单位: $)
                </label>
                <input type="number" step="0.01" id="slotMinQuotaUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">当前：$<span id="slotMinQuotaDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  启用状态
                </label>
                <select id="slotEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="1">启用</option>
                  <option value="0">禁用</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">禁用后用户无法访问老虎机</p>
              </div>
            </div>
            
            <div class="mt-6 flex gap-3">
              <button onclick="updateSlotConfig()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                保存配置
              </button>
              <button onclick="loadSlotConfig()" class="px-6 py-2 bg-slate-100 text-slate-700 rounded-lg font-semibold hover:bg-slate-200 transition-colors">
                重置
              </button>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900">🎲 符号出现概率配置</h3>
              <button onclick="calculateProbabilities()" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                📊 计算概率
              </button>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-blue-800 mb-2">
                <strong>💡 权重说明：</strong>权重决定符号出现的概率。权重越高，出现概率越大。
              </p>
              <p class="text-xs text-blue-700">
                • 单个位置概率 = 符号权重 / 总权重<br>
                • 建议范围：1-1000（普通符号推荐50-150，律师函推荐10-50）<br>
                • 修改后立即生效，无需重启服务器
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- 美 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🎵 美 (m) 权重
                </label>
                <input type="number" id="weight_m" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_m" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 太 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  ⚡ 太 (t) 权重
                </label>
                <input type="number" id="weight_t" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_t" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 你 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  👀 你 (n) 权重
                </label>
                <input type="number" id="weight_n" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_n" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 鸡 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🐔 鸡 (j) 权重
                </label>
                <input type="number" id="weight_j" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_j" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 篮球 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🏀 篮球 (lq) 权重
                </label>
                <input type="number" id="weight_lq" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_lq" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 背景 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🎬 背景 (bj) 权重
                </label>
                <input type="number" id="weight_bj" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_bj" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 中分头 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  💇 中分头 (zft) 权重
                </label>
                <input type="number" id="weight_zft" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_zft" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 背带裤 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  👖 背带裤 (bdk) 权重
                </label>
                <input type="number" id="weight_bdk" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_bdk" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 律师函 -->
              <div class="md:col-span-3">
                <label class="block text-sm font-medium text-red-700 mb-1">
                  ⚖️ 律师函 (lsh) 权重 <span class="text-xs text-red-600">(惩罚符号)</span>
                </label>
                <div class="flex gap-4 items-center">
                  <input type="number" id="weight_lsh" min="1" max="1000" class="flex-1 px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-red-50" placeholder="25">
                  <div class="flex-1">
                    <p id="prob_lsh" class="text-sm font-medium text-red-700">概率: --</p>
                    <p id="prob_lsh_appear" class="text-xs text-red-600">4个位置至少出现1次: --</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 rounded-lg p-4 mb-4">
              <p class="text-sm font-semibold text-slate-700 mb-2">📊 当前总权重: <span id="totalWeight" class="text-indigo-600">--</span></p>
              <p class="text-xs text-slate-600">总权重 = 所有符号权重之和</p>
            </div>

            <div class="flex gap-3">
              <button onclick="updateSymbolWeights()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                保存权重配置
              </button>
              <button onclick="loadSymbolWeights()" class="px-6 py-2 bg-slate-100 text-slate-700 rounded-lg font-semibold hover:bg-slate-200 transition-colors">
                重置
              </button>
              <button onclick="resetToDefault()" class="px-6 py-2 bg-orange-100 text-orange-700 rounded-lg font-semibold hover:bg-orange-200 transition-colors">
                恢复默认值
              </button>
            </div>
          </div>

          <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <div>
                <p class="font-semibold text-yellow-800 mb-1">⚠️ 重要提示</p>
                <ul class="text-sm text-yellow-700 space-y-1">
                  <li>• 修改配置会立即生效，影响所有用户</li>
                  <li>• 投注金额建议不要设置过高，避免用户损失过大</li>
                  <li>• 符号权重调整会改变中奖概率，请谨慎操作</li>
                  <li>• 律师函权重建议保持在10-50之间，过高会影响游戏体验</li>
                  <li>• 500000 聪 = $1 USD</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Slot Analytics Section -->
        <div id="slotAnalyticsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🎰 抽奖数据分析</h2>
            <button onclick="loadSlotAnalytics()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="analyticsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新数据
            </button>
          </div>

          <!-- 概览统计 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">总游戏次数</h3>
                <span class="text-2xl">🎰</span>
              </div>
              <p id="analyticsTotal" class="text-3xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">中奖率</h3>
                <span class="text-2xl">🎯</span>
              </div>
              <p id="analyticsWinRate" class="text-3xl font-bold text-green-600">0%</p>
              <p class="text-xs text-slate-500 mt-1">中奖 <span id="analyticsWinCount">0</span> 次</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">总投注</h3>
                <span class="text-2xl">💰</span>
              </div>
              <p id="analyticsTotalBet" class="text-3xl font-bold text-red-600">$0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">净盈亏</h3>
                <span class="text-2xl">📊</span>
              </div>
              <p id="analyticsNetProfit" class="text-3xl font-bold">$0</p>
              <p class="text-xs text-slate-500 mt-1">总赢得 <span id="analyticsTotalWin">$0</span></p>
            </div>
          </div>

          <!-- 中奖类型分布 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">🎁 中奖类型分布</h3>
            <div class="space-y-3" id="winTypesDistribution">
              <!-- 将通过JS填充 -->
            </div>
          </div>

          <!-- 每日统计 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">📅 最近7天统计</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">日期</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">游戏次数</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">总投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">总赢得</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">净盈亏</th>
                  </tr>
                </thead>
                <tbody id="dailyStatsBody" class="divide-y divide-slate-100">
                  <!-- 将通过JS填充 -->
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Slot Leaderboard Section -->
        <div id="slotLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🏆 用户获奖排行</h2>
            <button onclick="loadSlotLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="leaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新排行
            </button>
          </div>

          <!-- 排行榜说明 -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-blue-800 mb-2">
              <strong>📊 排行依据：</strong>按用户历史总获奖金额排序
            </p>
            <p class="text-xs text-blue-700">
              • 统计所有游戏的累计获奖金额（不扣除投注）<br>
              • 实时更新，每次游戏后自动刷新<br>
              • 只显示玩过老虎机的用户
            </p>
          </div>

          <!-- 排行榜表格 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">排名</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase">LinuxDo 用户名</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">游戏次数</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">总投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">总获奖</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">净盈亏</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">最大单次奖金</th>
                  </tr>
                </thead>
                <tbody id="leaderboardTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Slot Machine Records Section -->
        <div id="slotRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">老虎机记录</h2>
            <button onclick="refreshSlotRecords()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="slotRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="slotTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="slotPageSize" onchange="changeSlotPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">时间</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">用户名</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Linux Do ID</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">结果符号</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">中奖类型</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">倍率</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">赢得</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">类型</th>
                  </tr>
                </thead>
                <tbody id="slotTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="9" class="px-4 py-8 text-center text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
              <div class="flex items-center justify-between">
                <button onclick="loadSlotRecords(slotCurrentPage - 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotPrevBtn">
                  上一页
                </button>
                <span class="text-sm text-slate-600">
                  第 <span id="slotCurrentPage" class="font-semibold">1</span> 页 / 共 <span id="slotTotalPages" class="font-semibold">1</span> 页
                </span>
                <button onclick="loadSlotRecords(slotCurrentPage + 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotNextBtn">
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">用户列表</h2>
            <button onclick="refreshUsers()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="usersRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center gap-4">
                <div class="text-sm text-slate-600">
                  总用户数: <span id="usersTotal" class="font-bold text-slate-900">0</span>
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-600">每页显示:</label>
                  <select id="usersPageSize" onchange="changeUsersPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                    <option value="10">10条</option>
                    <option value="20" selected>20条</option>
                    <option value="50">50条</option>
                    <option value="100">100条</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="exportUsersData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">📥 导出</button>
                <button onclick="toggleUsersBatchMode()" id="usersBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">批量操作</button>
              </div>
            </div>
            <div id="usersBatchActions" class="hidden mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">全选 (<span id="selectedUsersCount">0</span> 个已选)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="batchBanUsers()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">🚫 批量封禁</button>
                  <button onclick="batchUnbindUsers()" class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold">🔓 批量解绑</button>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="usersCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllUsersHeader" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">#</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">投喂次数</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">领取次数</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">总获得额度</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">管理</th>
                  </tr>
                </thead>
                <tbody id="usersListBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="usersPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="usersCurrentPage">1</span> / <span id="usersTotalPages">1</span> 页
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadUsersList(usersCurrentPage - 1)" id="usersPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="usersPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadUsersList(usersCurrentPage + 1)" id="usersNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600';
      toast.className = `toast px-6 py-4 rounded-xl ${bgColor} text-white min-w-[300px]`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-6 h-6 rounded-full ${type === 'success' ? 'bg-white/20' : 'bg-white/20'} flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
            </svg>
          </div>
          <span class="font-medium">${message}</span>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // 保留旧的 showMessage 函数用于兼容
    function showMessage(text, type) {
      showToast(text, type);
    }

    async function adminLogin() {
      const password = document.getElementById('password').value;
      if (!password) {
        showToast('请输入管理员密码', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          showToast('登录成功', 'success');
          await loadAdminData();
        } else {
          showToast(data.message || '密码错误', 'error');
        }
      } catch (e) {
        showToast('登录失败，请重试', 'error');
      }
    }

    async function loadAdminData() {
      await loadConfig();
      await loadClaimRecords();
      await loadDonateRecords();
      await loadKeysList();
      await loadUsersCount();
    }

    async function loadUsersCount() {
      try {
        const res = await fetch('/api/admin/users?page=1&pageSize=1');
        const data = await res.json();
        if (data.success) {
          document.getElementById('userCount').textContent = data.pagination.total;
        }
      } catch (e) {
        console.error('加载用户数失败', e);
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/admin/config');
        const data = await res.json();

        if (data.success) {
          const claimQuota = data.data.claim_quota;
          const usdValue = (claimQuota / 500000).toFixed(2);
          const maxDailyClaims = data.data.max_daily_claims || 1;
          const session = data.data.session || '';
          const newApiUser = data.data.new_api_user || '1';
          const keysApiUrl = data.data.keys_api_url || '';
          const keysAuthorization = data.data.keys_authorization || '';
          const modelscopeGroupId = data.data.modelscope_group_id || 26;
          const iflowGroupId = data.data.iflow_group_id || 26;
          const keysAuthConfigured = data.data.keys_authorization_configured;
          const updatedAt = data.data.updated_at;
          const maxDailyDonateModelscope = data.data.max_daily_donate_modelscope || 1;
          const maxDailyDonateIflow = data.data.max_daily_donate_iflow || 1;
          
          // 更新配置页面
          document.getElementById('claimQuotaUSD').value = usdValue;
          document.getElementById('currentQuota').textContent = '$' + usdValue;
          document.getElementById('quotaValue').textContent = claimQuota.toLocaleString();
          document.getElementById('maxDailyClaims').value = maxDailyClaims;
          
          // 显示当前 session
          document.getElementById('currentSession').textContent = session || '未配置';
          document.getElementById('currentSession').className = session 
            ? 'text-sm font-mono text-slate-700 break-all' 
            : 'text-sm font-mono text-slate-400 break-all';
          
          // 显示当前 new_api_user
          document.getElementById('currentNewApiUser').textContent = newApiUser;
          
          document.getElementById('keysApiUrl').value = keysApiUrl;
          document.getElementById('modelscopeGroupId').value = modelscopeGroupId;
          document.getElementById('iflowGroupId').value = iflowGroupId;
          document.getElementById('maxDailyDonateModelscope').value = maxDailyDonateModelscope;
          document.getElementById('maxDailyDonateIflow').value = maxDailyDonateIflow;
          
          // 更新仪表板配置卡片
          document.getElementById('dashboardQuota').textContent = '$' + usdValue;
          document.getElementById('dashboardQuotaUSD').textContent = claimQuota.toLocaleString();
          document.getElementById('dashboardMaxClaims').textContent = maxDailyClaims;
          document.getElementById('dashboardSessionStatus').textContent = session ? '已配置 ✓' : '未配置';
          document.getElementById('dashboardSessionStatus').className = session 
            ? 'text-lg font-bold text-green-600' 
            : 'text-lg font-bold text-orange-600';
          
          document.getElementById('dashboardNewApiUser').textContent = newApiUser;
          document.getElementById('dashboardKeysApi').textContent = keysApiUrl || '未配置';
          document.getElementById('dashboardKeysApi').title = keysApiUrl || '未配置';
          document.getElementById('dashboardGroupId').textContent = modelscopeGroupId;
          document.getElementById('dashboardIflowGroupId').textContent = iflowGroupId;
          document.getElementById('dashboardMaxDonateModelscope').textContent = maxDailyDonateModelscope;
          document.getElementById('dashboardMaxDonateIflow').textContent = maxDailyDonateIflow;
          
          // 显示 Keys Authorization（前20个字符）
          if (keysAuthorization) {
            const displayAuth = keysAuthorization.length > 20 
              ? keysAuthorization.substring(0, 20) + '...' 
              : keysAuthorization;
            document.getElementById('dashboardKeysAuth').textContent = displayAuth;
            document.getElementById('dashboardKeysAuth').title = keysAuthorization;
            document.getElementById('dashboardKeysAuthStatus').textContent = '已配置 ✓';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-green-600 mt-1 font-semibold';
          } else {
            document.getElementById('dashboardKeysAuth').textContent = '未配置';
            document.getElementById('dashboardKeysAuth').title = '';
            document.getElementById('dashboardKeysAuthStatus').textContent = '未配置';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-orange-600 mt-1 font-semibold';
          }
          
          // 格式化更新时间
          if (updatedAt) {
            const date = new Date(updatedAt);
            document.getElementById('dashboardUpdatedAt').textContent = date.toLocaleString('zh-CN');
          }
        }
      } catch (e) {
        console.error('加载配置失败', e);
      }
    }

    // 实时计算 quota 显示
    document.addEventListener('DOMContentLoaded', () => {
      const claimQuotaUSDInput = document.getElementById('claimQuotaUSD');
      if (claimQuotaUSDInput) {
        claimQuotaUSDInput.addEventListener('input', (e) => {
          const usd = parseFloat(e.target.value) || 0;
          const quota = Math.round(usd * 500000);
          const quotaEl = document.getElementById('quotaValue');
          if (quotaEl) {
            quotaEl.textContent = quota.toLocaleString();
          }
        });
      }
    });

    async function updateQuota() {
      const usd = parseFloat(document.getElementById('claimQuotaUSD').value);
      if (!usd || usd <= 0) {
        showMessage('请输入有效的美元金额', 'error');
        return;
      }
      const quota = Math.round(usd * 500000);
      try {
        const res = await fetch('/api/admin/config/quota', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ claim_quota: quota }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyClaims() {
      const maxClaims = parseInt(document.getElementById('maxDailyClaims').value);
      if (!maxClaims || maxClaims <= 0) {
        showMessage('请输入有效的领取次数', 'error');
        return;
      }
      if (maxClaims > 10) {
        showMessage('每日领取次数不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-claims', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_claims: maxClaims }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateSession() {
      const session = document.getElementById('sessionValue').value.trim();
      try {
        const res = await fetch('/api/admin/config/session', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('sessionValue').value = '';
          await loadConfig();  // 重新加载配置以刷新显示
        }
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateNewApiUser() {
      const new_api_user = document.getElementById('newApiUserValue').value.trim();
      if (!new_api_user) {
        showMessage('请输入 New-API-User 值', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/new-api-user', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_api_user }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('newApiUserValue').value = '';
          await loadConfig();  // 重新加载配置以刷新显示
        }
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateKeysApiUrl() {
      const keys_api_url = document.getElementById('keysApiUrl').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-api-url', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_api_url }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateKeysAuthorization() {
      const keys_authorization = document.getElementById('keysAuthorization').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-authorization', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_authorization }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) document.getElementById('keysAuthorization').value = '';
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateModelscopeGroupId() {
      const modelscope_group_id = parseInt(document.getElementById('modelscopeGroupId').value);
      try {
        const res = await fetch('/api/admin/config/modelscope-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelscope_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateIflowGroupId() {
      const iflow_group_id = parseInt(document.getElementById('iflowGroupId').value);
      try {
        const res = await fetch('/api/admin/config/iflow-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ iflow_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyDonateModelscope() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateModelscope').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('请输入有效的投喂限制次数', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('ModelScope 每日投喂限制不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-modelscope', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_modelscope: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyDonateIflow() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateIflow').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('请输入有效的投喂限制次数', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('iFlow 每日投喂限制不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-iflow', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_iflow: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    // 刷新按钮包装函数
    async function refreshKeys() {
      const icon = document.getElementById('keysRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadKeysList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('Keys 列表已刷新', 'success');
      }, 600);
    }

    async function refreshClaims() {
      const icon = document.getElementById('claimsRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadClaimRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('领取记录已刷新', 'success');
      }, 600);
    }

    async function refreshDonates() {
      const icon = document.getElementById('donatesRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadDonateRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('投喂记录已刷新', 'success');
      }, 600);
    }

    async function refreshUsers() {
      const icon = document.getElementById('usersRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadUsersList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('用户列表已刷新', 'success');
      }, 600);
    }

    async function loadKeysList() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          document.getElementById('totalKeysCount').textContent = data.data.length;
          const tbody = document.getElementById('keysListBody');

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">暂无Keys</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((item, index) => {
            const keyType = item.key_type || 'modelscope';
            const keyTypeTag = keyType === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>✨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>🎁</span><span>ModelScope</span></span>';
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50" data-key="${item.key}" data-key-type="${keyType}">
                <td class="keysCheckboxCell hidden px-4 py-3 text-center align-middle">
                  <input type="checkbox" class="key-checkbox w-4 h-4 rounded border-slate-300" value="${item.key}" data-key-type="${keyType}" onchange="updateSelectedCount()">
                </td>
                <td class="px-4 py-3 font-mono text-xs align-middle break-all">${item.key}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 align-middle">${item.username || '-'}</td>
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(item.timestamp).toLocaleString('zh-CN')}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="key-status-${index}">-</span>
                </td>
                <td class="px-4 py-3 text-center align-middle">
                  <button onclick="copyKey('${item.key}')" class="p-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors" title="复制 Key">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载Keys失败', e);
      }
    }

    // 复制单个 Key
    function copyKey(key) {
      navigator.clipboard.writeText(key).then(() => {
        showToast('Key 已复制', 'success');
      }).catch(() => {
        showToast('复制失败', 'error');
      });
    }

    // Keys 批量操作功能
    let keysBatchMode = false;

    function toggleKeysBatchMode() {
      keysBatchMode = !keysBatchMode;
      const btn = document.getElementById('keysBatchBtn');
      const batchActions = document.getElementById('keysBatchActions');
      const checkboxCells = document.querySelectorAll('.keysCheckboxCell');
      const checkboxHeader = document.getElementById('keysCheckboxHeader');
      
      if (keysBatchMode) {
        btn.textContent = '✓ 退出批量';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = '批量操作';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        // 清除所有选中
        document.querySelectorAll('.key-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
      }
    }

    function toggleSelectAllKeys() {
      const selectAll = document.getElementById('selectAllKeys');
      const selectAllHeader = document.getElementById('selectAllKeysHeader');
      const checkboxes = document.querySelectorAll('.key-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const selected = document.querySelectorAll('.key-checkbox:checked');
      document.getElementById('selectedKeysCount').textContent = selected.length;
    }

    function getSelectedKeys() {
      return Array.from(document.querySelectorAll('.key-checkbox:checked')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
    }

    async function deleteSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('请先选择要删除的 Keys', 'error');
        return;
      }
      
      if (!confirm(`确定要删除 ${selectedKeys.length} 个 Keys 吗？此操作不可恢复！`)) return;
      
      try {
        const res = await fetch('/api/admin/keys/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys: selectedKeys }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(data.message, 'success');
          await loadKeysList();
        } else {
          showMessage(data.message || '删除失败', 'error');
        }
      } catch (e) {
        showMessage('删除失败', 'error');
      }
    }

    async function testSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('请先选择要测试的 Keys', 'error');
        return;
      }
      
      showMessage(`正在测试 ${selectedKeys.length} 个 Keys...`, 'success');
      await testKeys(selectedKeys);
    }

    async function testAllKeys() {
      const allKeys = Array.from(document.querySelectorAll('.key-checkbox')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
      if (allKeys.length === 0) {
        showMessage('暂无 Keys 可测试', 'error');
        return;
      }
      
      if (!confirm(`确定要测试全部 ${allKeys.length} 个 Keys 吗？`)) return;
      
      showMessage(`正在测试全部 ${allKeys.length} 个 Keys...`, 'success');
      await testKeys(allKeys);
    }

    async function testKeys(keys) {
      let validCount = 0;
      let invalidCount = 0;
      
      // 一个接一个测试
      for (let index = 0; index < keys.length; index++) {
        const keyItem = keys[index];
        const statusSpan = document.querySelector(`.key-status-${index}`);
        
        if (statusSpan) {
          // 显示测试中状态
          statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span>测试中</span></span>';
        }
        
        try {
          // 单个测试
          const res = await fetch('/api/admin/keys/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keys: [keyItem] }),
          });
          const data = await res.json();
          
          if (statusSpan && data.success && data.data.length > 0) {
            const result = data.data[0];
            if (result.valid) {
              validCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg><span>成功</span></span>';
            } else {
              invalidCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>失败</span></span>';
            }
          }
        } catch (e) {
          if (statusSpan) {
            invalidCount++;
            statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>失败</span></span>';
          }
        }
        
        // 添加小延迟，让动画更明显
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      showMessage(`测试完成：有效 ${validCount} 个，失效 ${invalidCount} 个`, 'success');
    }

    async function exportKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // 按渠道分类
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let exportContent = '';
          
          if (modelscopeKeys.length > 0) {
            exportContent += `=== ModelScope Keys (${modelscopeKeys.length}个) ===\n`;
            exportContent += modelscopeKeys.map(item => item.key).join('\n');
            exportContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            exportContent += `=== iFlow Keys (${iflowKeys.length}个) ===\n`;
            exportContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          const blob = new Blob([exportContent], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `donated-keys-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          showMessage(`成功导出 ${data.data.length} 个 Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('导出失败', 'error');
      }
    }

    async function copyAllKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // 按渠道分类
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let copyContent = '';
          
          if (modelscopeKeys.length > 0) {
            copyContent += `=== ModelScope Keys (${modelscopeKeys.length}个) ===\n`;
            copyContent += modelscopeKeys.map(item => item.key).join('\n');
            copyContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            copyContent += `=== iFlow Keys (${iflowKeys.length}个) ===\n`;
            copyContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          await navigator.clipboard.writeText(copyContent);
          showMessage(`成功复制 ${data.data.length} 个 Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('复制失败', 'error');
      }
    }

    let claimCurrentPage = 1;
    let claimPageSize = 50;

    async function loadClaimRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/claim?page=${page}&pageSize=${claimPageSize}`);
        const data = await res.json();

        if (data.success) {
          claimCurrentPage = data.pagination.page;
          const tbody = document.getElementById('claimTableBody');

          // 更新统计信息
          document.getElementById('claimCount').textContent = data.pagination.total;
          document.getElementById('claimsTotal').textContent = data.pagination.total;
          document.getElementById('claimTotal').textContent = data.pagination.total;
          document.getElementById('claimCurrentPage').textContent = data.pagination.page;
          document.getElementById('claimTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('claimPrevBtn').disabled = page === 1;
          document.getElementById('claimNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderClaimPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const quotaUSD = (r.quota_added / 500000).toFixed(2);
            const isBindingBonus = r.quota_added === 50000000; // 绑定奖励是 $100
            
            const typeLabel = isBindingBonus 
              ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-semibold">🎁 绑定奖励</span>'
              : '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">📅 每日领取</span>';
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                <td class="px-4 py-3 font-semibold">${r.username}</td>
                <td class="px-4 py-3 font-mono text-xs">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${typeLabel}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">$${quotaUSD}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载领取记录失败', e);
      }
    }

    let donateCurrentPage = 1;
    let donatePageSize = 50;

    async function loadDonateRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/donate?page=${page}&pageSize=${donatePageSize}`);
        const data = await res.json();

        if (data.success) {
          donateCurrentPage = data.pagination.page;
          const tbody = document.getElementById('donateTableBody');

          // 更新统计信息
          document.getElementById('donateCount').textContent = data.pagination.total;
          document.getElementById('donatesTotal').textContent = data.pagination.total;
          document.getElementById('donateTotal').textContent = data.pagination.total;
          document.getElementById('donateCurrentPage').textContent = data.pagination.page;
          document.getElementById('donateTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('donatePrevBtn').disabled = page === 1;
          document.getElementById('donateNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderDonatePageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const keyTypeTag = r.key_type === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>✨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>🎁</span><span>ModelScope</span></span>';
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                <td class="px-4 py-3 align-middle">${r.username}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 text-center align-middle">${r.keys_count}</td>
                <td class="px-4 py-3 text-right font-semibold align-middle">$${(r.total_quota_added / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="inline-block px-2 py-1 rounded text-xs ${r.push_status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${r.push_status === 'success' ? '✓ 成功' : '✕ 失败'}
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载投喂记录失败', e);
      }
    }

    let usersCurrentPage = 1;
    let usersPageSize = 20;

    async function loadUsersList(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/users?page=${page}&pageSize=${usersPageSize}`);
        const data = await res.json();

        if (data.success) {
          usersCurrentPage = data.pagination.page;
          const tbody = document.getElementById('usersListBody');

          // 更新统计信息
          document.getElementById('userCount').textContent = data.pagination.total;
          document.getElementById('usersTotal').textContent = data.pagination.total;
          document.getElementById('usersCurrentPage').textContent = data.pagination.page;
          document.getElementById('usersTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('usersPrevBtn').disabled = page === 1;
          document.getElementById('usersNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderUsersPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">暂无用户</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((user, index) => {
            const globalIndex = (page - 1) * usersPageSize + index + 1;
            const isBanned = user.is_banned === 1;
            const statusHtml = isBanned 
              ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">🚫 已封禁</span>` 
              : `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✓ 正常</span>`;
            
            const actionButtons = isBanned
              ? `<button onclick="unbanUser('${user.linux_do_id}', '${user.username}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold transition-colors">解封</button>`
              : `
                <div class="flex gap-2 justify-center">
                  <button onclick="banUser('${user.linux_do_id}', '${user.username}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold transition-colors">封禁</button>
                  <button onclick="unbindUser('${user.linux_do_id}', '${user.username}')" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-semibold transition-colors">解绑</button>
                </div>
              `;
            
            return `
              <tr class="border-b border-slate-100 ${isBanned ? 'bg-red-50' : 'hover:bg-slate-50'}">
                <td class="usersCheckboxCell hidden px-4 py-3 text-center">
                  <input type="checkbox" class="user-checkbox w-4 h-4 rounded border-slate-300" value="${user.linux_do_id}" data-username="${user.username}" onchange="updateSelectedUsersCount()">
                </td>
                <td class="px-4 py-3">${globalIndex}</td>
                <td class="px-4 py-3 font-semibold">${user.username}</td>
                <td class="px-4 py-3 font-mono text-xs">${user.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${user.donate_count}</td>
                <td class="px-4 py-3 text-center">${user.claim_count}</td>
                <td class="px-4 py-3 text-right font-semibold">$${(user.total_quota / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">${statusHtml}</td>
                <td class="px-4 py-3 text-center">${actionButtons}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载用户列表失败', e);
      }
    }

    function renderUsersPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('usersPageNumbers');
      const maxVisible = 5; // 最多显示5个页码
      let pages = [];

      if (totalPages <= maxVisible) {
        // 总页数少，显示全部
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        // 总页数多，智能显示
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadUsersList(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function renderClaimPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('claimPageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadClaimRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeClaimsPageSize() {
      claimPageSize = parseInt(document.getElementById('claimsPageSize').value);
      loadClaimRecords(1);
    }

    function renderDonatePageNumbers(currentPage, totalPages) {
      const container = document.getElementById('donatePageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadDonateRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeDonatesPageSize() {
      donatePageSize = parseInt(document.getElementById('donatesPageSize').value);
      loadDonateRecords(1);
    }

    function changeUsersPageSize() {
      usersPageSize = parseInt(document.getElementById('usersPageSize').value);
      loadUsersList(1); // 重置到第一页
    }

    async function exportUsersData() {
      try {
        const link = document.createElement('a');
        link.href = '/api/admin/export/users';
        link.download = `users_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => showMessage('用户数据导出成功', 'success'), 500);
      } catch (e) {
        showMessage('导出失败', 'error');
      }
    }

    async function banUser(linuxDoId, username) {
      const reason = prompt(`确定要封禁用户 "${username}" 吗？\n\n请输入封禁原因（可选）：`, '违规行为');
      if (reason === null) return; // 用户取消
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/ban`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || '违规行为' }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 已被封禁`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '封禁失败', 'error');
        }
      } catch (e) {
        showMessage('封禁失败', 'error');
      }
    }

    async function unbanUser(linuxDoId, username) {
      if (!confirm(`确定要解封用户 "${username}" 吗？`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unban`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 已解封`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '解封失败', 'error');
        }
      } catch (e) {
        showMessage('解封失败', 'error');
      }
    }

    async function unbindUser(linuxDoId, username) {
      if (!confirm(`⚠️ 确定要解除用户 "${username}" 的绑定吗？\n\n此操作将：\n• 删除该用户的绑定信息\n• 清除所有相关记录\n• 用户需要重新绑定才能使用\n\n此操作不可恢复！`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unbind`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 的绑定已解除`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '解绑失败', 'error');
        }
      } catch (e) {
        showMessage('解绑失败', 'error');
      }
    }

    // 用户列表批量操作功能
    let usersBatchMode = false;

    function toggleUsersBatchMode() {
      usersBatchMode = !usersBatchMode;
      const btn = document.getElementById('usersBatchBtn');
      const batchActions = document.getElementById('usersBatchActions');
      const checkboxCells = document.querySelectorAll('.usersCheckboxCell');
      const checkboxHeader = document.getElementById('usersCheckboxHeader');
      
      if (usersBatchMode) {
        btn.textContent = '✓ 退出批量';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = '批量操作';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
        updateSelectedUsersCount();
      }
    }

    function toggleSelectAllUsers() {
      const selectAll = document.getElementById('selectAllUsers');
      const selectAllHeader = document.getElementById('selectAllUsersHeader');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedUsersCount();
    }

    function updateSelectedUsersCount() {
      const selected = document.querySelectorAll('.user-checkbox:checked');
      document.getElementById('selectedUsersCount').textContent = selected.length;
    }

    function getSelectedUsers() {
      return Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => ({
        linuxDoId: cb.value,
        username: cb.dataset.username
      }));
    }

    async function batchBanUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('请先选择要封禁的用户', 'error');
        return;
      }
      
      const reason = prompt(`确定要批量封禁 ${selectedUsers.length} 个用户吗？\n\n请输入封禁原因：`, '违规行为');
      if (reason === null) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason }),
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`批量封禁完成：成功 ${successCount} 个，失败 ${failCount} 个`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    async function batchUnbindUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('请先选择要解绑的用户', 'error');
        return;
      }
      
      if (!confirm(`⚠️ 确定要批量解绑 ${selectedUsers.length} 个用户吗？\n\n此操作不可恢复！`)) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/unbind`, {
            method: 'POST',
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`批量解绑完成：成功 ${successCount} 个，失败 ${failCount} 个`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    function showSection(section) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        link.classList.add('text-slate-700');
      });
      event.target.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
      event.target.classList.remove('text-slate-700');

      ['dashboard', 'config', 'keys', 'claims', 'donates', 'slotRecords', 'slotConfig', 'slotAnalytics', 'slotLeaderboard', 'users'].forEach(s => {
        document.getElementById(s + 'Section').classList.add('hidden');
      });
      document.getElementById(section + 'Section').classList.remove('hidden');

      if (section === 'users') loadUsersList(1);
      if (section === 'slotRecords') loadSlotRecords(1);
      if (section === 'slotConfig') {
        loadSlotConfig();
        loadSymbolWeights();
      }
      if (section === 'slotAnalytics') loadSlotAnalytics();
      if (section === 'slotLeaderboard') loadSlotLeaderboard();
    }

    // 老虎机配置管理
    async function loadSlotConfig() {
      try {
        const res = await fetch('/api/admin/slot/config');
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          // 将聪转换为美元显示
          const betAmountUSD = (config.bet_amount / 500000).toFixed(2);
          const minQuotaUSD = (config.min_quota_required / 500000).toFixed(2);
          
          document.getElementById('slotBetAmountUSD').value = betAmountUSD;
          document.getElementById('slotMaxDailySpins').value = config.max_daily_spins;
          document.getElementById('slotMinQuotaUSD').value = minQuotaUSD;
          document.getElementById('slotEnabled').value = config.enabled;

          // 更新显示
          document.getElementById('slotBetAmountDisplay').textContent = betAmountUSD;
          document.getElementById('slotMinQuotaDisplay').textContent = minQuotaUSD;
        }
      } catch (error) {
        console.error('加载老虎机配置失败:', error);
        showMessage('加载配置失败', 'error');
      }
    }

    async function updateSlotConfig() {
      try {
        const betAmountUSD = parseFloat(document.getElementById('slotBetAmountUSD').value);
        const maxDailySpins = parseInt(document.getElementById('slotMaxDailySpins').value);
        const minQuotaUSD = parseFloat(document.getElementById('slotMinQuotaUSD').value);
        const enabled = parseInt(document.getElementById('slotEnabled').value);

        if (isNaN(betAmountUSD) || betAmountUSD < 0) {
          showMessage('请输入有效的投注金额', 'error');
          return;
        }
        if (isNaN(maxDailySpins) || maxDailySpins < 0) {
          showMessage('请输入有效的每日次数', 'error');
          return;
        }
        if (isNaN(minQuotaUSD) || minQuotaUSD < 0) {
          showMessage('请输入有效的最低额度', 'error');
          return;
        }

        // 将美元转换为聪
        const betAmount = Math.floor(betAmountUSD * 500000);
        const minQuota = Math.floor(minQuotaUSD * 500000);

        const res = await fetch('/api/admin/slot/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bet_amount: betAmount,
            max_daily_spins: maxDailySpins,
            min_quota_required: minQuota,
            enabled: enabled
          })
        });

        const data = await res.json();

        if (data.success) {
          showMessage('配置已更新', 'success');
          loadSlotConfig();
        } else {
          showMessage(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新配置失败:', error);
        showMessage('更新失败', 'error');
      }
    }

    // 老虎机记录管理
    let slotCurrentPage = 1;
    let slotPageSize = 50;

    async function loadSlotRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/slot?page=${page}&pageSize=${slotPageSize}`);
        const data = await res.json();

        if (data.success) {
          slotCurrentPage = data.pagination.page;
          const tbody = document.getElementById('slotTableBody');

          // 更新统计信息
          document.getElementById('slotTotal').textContent = data.pagination.total;
          document.getElementById('slotCurrentPage').textContent = data.pagination.page;
          document.getElementById('slotTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('slotPrevBtn').disabled = data.pagination.page <= 1;
          document.getElementById('slotNextBtn').disabled = data.pagination.page >= data.pagination.totalPages;

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">暂无记录</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const symbols = JSON.parse(r.result_symbols);
            const symbolsHTML = symbols.map(s => {
              const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
              return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-8 h-8 inline-block border border-slate-300 rounded mr-1">`;
            }).join('');
            
            const winClass = r.win_amount > 0 ? 'text-green-600' : 'text-slate-500';
            const typeClass = r.is_free_spin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
            const typeLabel = r.is_free_spin ? '免费' : '普通';

            const winTypeLabels = {
              'super_jackpot': '🏆 超级大奖',
              'special_combo': '💎 特殊组合',
              'quad': '🎰 四连',
              'triple': '✨ 三连',
              'double': '🎁 双连',
              'punishment': '⚡ 惩罚',
              'none': '❌ 未中奖'
            };
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 text-sm">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                <td class="px-4 py-3 font-semibold">${r.username}</td>
                <td class="px-4 py-3 font-mono text-xs text-slate-600">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${symbolsHTML}</td>
                <td class="px-4 py-3 text-center text-sm font-semibold">${winTypeLabels[r.win_type] || r.win_type}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">${r.win_multiplier}x</td>
                <td class="px-4 py-3 text-right font-semibold">$${(r.bet_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">$${(r.win_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 ${typeClass} rounded-full text-xs font-semibold">${typeLabel}</span>
                  ${r.free_spin_awarded ? '<span class="ml-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">+1🎁</span>' : ''}
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载老虎机记录失败', e);
      }
    }

    async function refreshSlotRecords() {
      const icon = document.getElementById('slotRefreshIcon');
      icon.classList.add('animate-spin');
      await loadSlotRecords(slotCurrentPage);
      setTimeout(() => icon.classList.remove('animate-spin'), 500);
    }

    function changeSlotPageSize() {
      slotPageSize = parseInt(document.getElementById('slotPageSize').value);
      loadSlotRecords(1);
    }

    // 符号权重配置管理
    async function loadSymbolWeights() {
      try {
        const res = await fetch('/api/admin/slot/weights');
        const data = await res.json();

        if (data.success) {
          const weights = data.data;
          
          // 填充表单
          document.getElementById('weight_m').value = weights.weight_m;
          document.getElementById('weight_t').value = weights.weight_t;
          document.getElementById('weight_n').value = weights.weight_n;
          document.getElementById('weight_j').value = weights.weight_j;
          document.getElementById('weight_lq').value = weights.weight_lq;
          document.getElementById('weight_bj').value = weights.weight_bj;
          document.getElementById('weight_zft').value = weights.weight_zft;
          document.getElementById('weight_bdk').value = weights.weight_bdk;
          document.getElementById('weight_lsh').value = weights.weight_lsh;
          
          // 自动计算概率
          calculateProbabilities();
        }
      } catch (error) {
        console.error('加载符号权重失败:', error);
        showMessage('加载符号权重失败', 'error');
      }
    }

    async function updateSymbolWeights() {
      try {
        const weights = {
          weight_m: parseInt(document.getElementById('weight_m').value),
          weight_t: parseInt(document.getElementById('weight_t').value),
          weight_n: parseInt(document.getElementById('weight_n').value),
          weight_j: parseInt(document.getElementById('weight_j').value),
          weight_lq: parseInt(document.getElementById('weight_lq').value),
          weight_bj: parseInt(document.getElementById('weight_bj').value),
          weight_zft: parseInt(document.getElementById('weight_zft').value),
          weight_bdk: parseInt(document.getElementById('weight_bdk').value),
          weight_lsh: parseInt(document.getElementById('weight_lsh').value)
        };

        // 验证所有权重
        for (const [key, value] of Object.entries(weights)) {
          if (isNaN(value) || value < 1 || value > 1000) {
            showMessage(`${key} 权重必须是1-1000之间的整数`, 'error');
            return;
          }
        }

        const res = await fetch('/api/admin/slot/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weights)
        });

        const data = await res.json();

        if (data.success) {
          showMessage('符号权重已更新，已立即生效', 'success');
          loadSymbolWeights();
        } else {
          showMessage(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新符号权重失败:', error);
        showMessage('更新失败', 'error');
      }
    }

    function calculateProbabilities() {
      const symbols = ['m', 't', 'n', 'j', 'lq', 'bj', 'zft', 'bdk', 'lsh'];
      const weights = {};
      let totalWeight = 0;

      // 获取所有权重值
      symbols.forEach(symbol => {
        const value = parseInt(document.getElementById('weight_' + symbol).value) || 0;
        weights[symbol] = value;
        totalWeight += value;
      });

      // 更新总权重显示
      document.getElementById('totalWeight').textContent = totalWeight.toLocaleString();

      // 计算并显示每个符号的概率
      symbols.forEach(symbol => {
        const weight = weights[symbol];
        const probability = totalWeight > 0 ? (weight / totalWeight * 100).toFixed(2) : '0.00';
        document.getElementById('prob_' + symbol).textContent = `概率: ${probability}%`;
        
        // 为律师函额外计算4个位置至少出现1次的概率
        if (symbol === 'lsh') {
          const singleProb = weight / totalWeight;
          const atLeastOnce = (1 - Math.pow(1 - singleProb, 4)) * 100;
          document.getElementById('prob_lsh_appear').textContent = `4个位置至少出现1次: ${atLeastOnce.toFixed(2)}%`;
        }
      });
    }

    function resetToDefault() {
      if (!confirm('确定要恢复默认权重配置吗？\n\n默认配置：\n普通符号(m,t,n,j,lq,bj,zft,bdk): 100\n律师函(lsh): 25')) {
        return;
      }

      // 设置默认值
      document.getElementById('weight_m').value = 100;
      document.getElementById('weight_t').value = 100;
      document.getElementById('weight_n').value = 100;
      document.getElementById('weight_j').value = 100;
      document.getElementById('weight_lq').value = 100;
      document.getElementById('weight_bj').value = 100;
      document.getElementById('weight_zft').value = 100;
      document.getElementById('weight_bdk').value = 100;
      document.getElementById('weight_lsh').value = 25;

      // 计算概率
      calculateProbabilities();
    }

    // 老虎机抽奖分析
    async function loadSlotAnalytics() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('加载分析数据失败', 'error');
          return;
        }

        const analytics = data.data;
        const summary = analytics.summary;
        const winTypes = analytics.winTypes;
        const dailyStats = analytics.dailyStats;
        const userStats = analytics.userStats;

        // 更新概览统计
        document.getElementById('analyticsTotal').textContent = summary.totalCount.toLocaleString();
        document.getElementById('analyticsWinRate').textContent = summary.winRate.toFixed(1) + '%';
        document.getElementById('analyticsWinCount').textContent = summary.winCount.toLocaleString();
        document.getElementById('analyticsTotalBet').textContent = '$' + (summary.totalBet / 500000).toFixed(2);
        document.getElementById('analyticsTotalWin').textContent = '$' + (summary.totalWin / 500000).toFixed(2);
        
        const netProfit = summary.netProfit;
        const netProfitElement = document.getElementById('analyticsNetProfit');
        netProfitElement.textContent = (netProfit >= 0 ? '+' : '') + '$' + (netProfit / 500000).toFixed(2);
        netProfitElement.className = netProfit >= 0 
          ? 'text-3xl font-bold text-green-600' 
          : 'text-3xl font-bold text-red-600';

        // 渲染中奖类型分布
        const winTypeNames = {
          'super_jackpot': '🏆 超级大奖 (256x)',
          'special_combo': '💎 特殊组合 (32x)',
          'quad': '🎰 四连 (16x)',
          'triple': '✨ 三连 (8x)',
          'double': '🎁 双连 (4x)',
          'punishment': '⚡ 律师函',
          'none': '❌ 未中奖'
        };

        const winTypesHtml = Object.entries(winTypes)
          .sort((a, b) => b[1].count - a[1].count)
          .map(([key, data]) => {
            const percentage = summary.totalCount > 0 ? (data.count / summary.totalCount * 100).toFixed(2) : '0.00';
            const barWidth = summary.totalCount > 0 ? (data.count / summary.totalCount * 100) : 0;
            
            return `
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-semibold text-slate-900">${winTypeNames[key]}</span>
                  <span class="text-sm font-bold text-slate-700">${data.count} 次 (${percentage}%)</span>
                </div>
                <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full" style="width: ${barWidth}%"></div>
                </div>
                <div class="flex items-center justify-between text-xs text-slate-600">
                  <span>总${data.totalWin >= 0 ? '赢得' : '扣除'}: $${(Math.abs(data.totalWin) / 500000).toFixed(2)}</span>
                  <span>平均: $${(Math.abs(data.avgWin) / 500000).toFixed(2)}</span>
                </div>
              </div>
            `;
          }).join('');
        document.getElementById('winTypesDistribution').innerHTML = winTypesHtml;

        // 渲染每日统计
        const dailyStatsHtml = Object.entries(dailyStats)
          .sort((a, b) => b[0].localeCompare(a[0])) // 按日期倒序排序
          .map(([date, stats]) => {
            const profitColor = stats.profit >= 0 ? 'text-green-600' : 'text-red-600';
            return `
              <tr>
                <td class="px-4 py-3 text-sm text-slate-900">${date}</td>
                <td class="px-4 py-3 text-sm text-slate-900 text-right">${stats.count}</td>
                <td class="px-4 py-3 text-sm text-red-600 text-right">$${(stats.bet / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-green-600 text-right">$${(stats.win / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${profitColor} text-right font-semibold">${stats.profit >= 0 ? '+' : ''}$${(stats.profit / 500000).toFixed(2)}</td>
              </tr>
            `;
          }).join('');
        document.getElementById('dailyStatsBody').innerHTML = dailyStatsHtml || '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">暂无数据</td></tr>';

        showMessage('分析数据已更新', 'success');
      } catch (error) {
        console.error('加载抽奖分析失败:', error);
        showMessage('加载分析数据失败', 'error');
      }
    }

    // 用户获奖排行榜
    async function loadSlotLeaderboard() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('加载排行榜失败', 'error');
          return;
        }

        const userStats = data.data.userStats;

        // 中奖类型标签
        const winTypeLabels = {
          'super_jackpot': '🏆 超级大奖',
          'special_combo': '💎 特殊组合',
          'quad': '🎰 四连',
          'triple': '✨ 三连',
          'double': '🎁 双连',
          'punishment': '⚡ 律师函',
          'none': '❌ 未中奖'
        };

        // 渲染排行榜
        const leaderboardHtml = userStats.map((user, index) => {
          const rank = index + 1;
          let rankBadge = `<span class="text-slate-600 font-semibold">#${rank}</span>`;
          let rowClass = '';
          
          if (rank === 1) {
            rankBadge = '<span class="text-3xl">🥇</span>';
            rowClass = 'bg-gradient-to-r from-yellow-50 to-amber-50';
          } else if (rank === 2) {
            rankBadge = '<span class="text-3xl">🥈</span>';
            rowClass = 'bg-gradient-to-r from-gray-50 to-slate-50';
          } else if (rank === 3) {
            rankBadge = '<span class="text-3xl">🥉</span>';
            rowClass = 'bg-gradient-to-r from-orange-50 to-amber-50';
          }

          const netProfit = user.total_win - user.total_bet;
          const profitColor = netProfit >= 0 ? 'text-green-600' : 'text-red-600';

          return `
            <tr class="${rowClass}">
              <td class="px-4 py-4 text-center">${rankBadge}</td>
              <td class="px-4 py-4">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-slate-900">${user.username || user.linux_do_id}</span>
                  ${user.biggest_win_type ? `<span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full">${winTypeLabels[user.biggest_win_type] || ''}</span>` : ''}
                </div>
              </td>
              <td class="px-4 py-4 text-center text-slate-900">${user.total_spins}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">$${(user.total_bet / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-green-600 font-bold text-lg">$${(user.total_win / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right ${profitColor} font-semibold">${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-orange-600 font-medium">$${(user.biggest_win / 500000).toFixed(2)}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('leaderboardTableBody').innerHTML = leaderboardHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">暂无数据</td></tr>';

        showMessage('排行榜已更新', 'success');
      } catch (error) {
        console.error('加载排行榜失败:', error);
        showMessage('加载排行榜失败', 'error');
      }
    }

    window.onload = async () => {
      try {
        const res = await fetch('/api/admin/config');
        if (res.ok) {
          // 验证成功，显示管理界面
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          await loadAdminData();
        } else {
          // 验证失败，显示登录界面
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
        }
      } catch (e) {
        // 请求失败，显示登录界面
        console.log('需要登录');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
      }
    };
  </script>
</body>
</html>

