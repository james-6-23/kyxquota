<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理后台 - KYX API Refueling Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚙️</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .refresh-spin {
      animation: spin 0.6s ease-in-out;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  <!-- Loading Section -->
  <div id="loadingSection" class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-white text-lg">验证登录中...</p>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
      <div class="flex justify-center mb-6">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full blur-xl opacity-50 animate-pulse"></div>
          <div class="relative bg-gradient-to-br from-indigo-500 to-purple-600 p-4 rounded-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
        </div>
      </div>
      <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">管理员后台</h1>
      <p class="text-center text-slate-600 mb-8 text-sm">⚙️ 系统管理控制台</p>
      <input type="password" id="password" placeholder="请输入管理员密码" class="w-full px-4 py-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
      <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
        登录
      </button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminSection" class="hidden min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <h1 class="text-xl font-bold text-slate-900">KYX API 管理后台</h1>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">管理员</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="flex">
      <aside class="w-64 bg-white min-h-screen border-r border-slate-200">
        <nav class="p-4">
          <button onclick="showSection('dashboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 bg-indigo-100 text-indigo-700 font-semibold flex items-center gap-2">
            <span>📊</span> 仪表板
          </button>
          <button onclick="showSection('config')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>⚙️</span> 系统配置
          </button>
          <button onclick="showSection('keys')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🔑</span> Keys 管理
          </button>
          <button onclick="showSection('claims')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📥</span> 领取记录
          </button>
          <button onclick="showSection('donates')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎁</span> 投喂记录
          </button>
          <button onclick="showSection('slotRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎰</span> 初级场记录
          </button>
          <button onclick="showSection('advancedSlotRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🔥</span> 高级场记录
          </button>
          <button onclick="showSection('slotConfig')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>⚙️</span> 老虎机配置
          </button>
          <button onclick="showSection('advancedSlotConfig')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🔥</span> 高级场配置
          </button>
          <button onclick="showSection('ticketDropRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎟️</span> 入场券掉落
          </button>
          <button onclick="showSection('slotAnalytics')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📈</span> 抽奖分析
          </button>
          <button onclick="showSection('profitLeaderboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🏆</span> 盈利排行榜
          </button>
          <button onclick="showSection('lossLeaderboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📉</span> 亏损排行榜
          </button>
          <button onclick="showSection('users')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>👥</span> 用户列表
          </button>
          <button onclick="showSection('grantFreeSpins')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎁</span> 发放免费次数
          </button>
          <button onclick="showSection('pendingRewards')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>💰</span> 待发放奖金
          </button>
          <button onclick="showSection('bannedUsers')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🚫</span> 封禁记录
          </button>
          <button onclick="showSection('kunbeiManagement')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🐔</span> 坤呗贷款管理
          </button>
          <button onclick="showSection('kunbeiRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>📋</span> 贷款记录
          </button>
          <button onclick="showSection('weightConfigs')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>⚖️</span> 权重配置管理
          </button>
          <button onclick="showSection('rewardConfigs')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🎁</span> 奖励配置管理
          </button>
          <button onclick="showSection('supremeConfig')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>💎</span> 至尊场配置
          </button>
          <button onclick="showSection('supremeRecords')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>🏆</span> 至尊场记录
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6">
        <!-- Dashboard -->
        <div id="dashboardSection">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">仪表板</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">📥</div>
                <div>
                  <p class="text-sm text-slate-600">领取记录总数</p>
                  <p id="claimCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">🎁</div>
                <div>
                  <p class="text-sm text-slate-600">投喂记录总数</p>
                  <p id="donateCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-2xl">👥</div>
                <div>
                  <p class="text-sm text-slate-600">注册用户总数</p>
                  <p id="userCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">💰</div>
                <div>
                  <p class="text-sm text-slate-600">当前领取额度</p>
                  <p id="currentQuota" class="text-2xl font-bold text-slate-900">--</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 当前配置卡片 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-900">当前系统配置</h3>
              </div>
              <button onclick="showSection('config')" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                <span>编辑配置</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- 每日领取额度 -->
              <div class="p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">💰</span>
                  <span class="text-sm font-semibold text-slate-700">每日领取额度</span>
                </div>
                <p id="dashboardQuota" class="text-2xl font-bold text-purple-700">--</p>
                <p class="text-xs text-slate-600 mt-1">≈ <span id="dashboardQuotaUSD">--</span> quota</p>
              </div>

              <!-- 每日最大领取次数 -->
              <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border border-green-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔢</span>
                  <span class="text-sm font-semibold text-slate-700">每日最大领取次数</span>
                </div>
                <p id="dashboardMaxClaims" class="text-2xl font-bold text-green-700">--</p>
                <p class="text-xs text-slate-600 mt-1">次/天</p>
              </div>

              <!-- API Session 状态 -->
              <div class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg border border-orange-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔑</span>
                  <span class="text-sm font-semibold text-slate-700">API Session</span>
                </div>
                <p id="dashboardSessionStatus" class="text-lg font-bold text-orange-700">--</p>
                <p class="text-xs text-slate-600 mt-1">KYX API 认证</p>
              </div>

              <!-- New-API-User -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🆔</span>
                  <span class="text-sm font-semibold text-slate-700">New-API-User</span>
                </div>
                <p id="dashboardNewApiUser" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">请求头参数</p>
              </div>

              <!-- Keys API URL -->
              <div class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg border border-blue-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔗</span>
                  <span class="text-sm font-semibold text-slate-700">Keys API URL</span>
                </div>
                <p id="dashboardKeysApi" class="text-sm font-mono text-blue-700 truncate" title="">--</p>
                <p class="text-xs text-slate-600 mt-1">验证服务地址</p>
              </div>

              <!-- ModelScope Group ID -->
              <div class="p-4 bg-gradient-to-br from-pink-50 to-rose-50 rounded-lg border border-pink-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">👥</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope Group ID</span>
                </div>
                <p id="dashboardGroupId" class="text-2xl font-bold text-pink-700">--</p>
                <p class="text-xs text-slate-600 mt-1">ModelScope 分组</p>
              </div>

              <!-- iFlow Group ID -->
              <div class="p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg border border-emerald-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">✨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow Group ID</span>
                </div>
                <p id="dashboardIflowGroupId" class="text-2xl font-bold text-emerald-700">--</p>
                <p class="text-xs text-slate-600 mt-1">iFlow 分组</p>
              </div>

              <!-- Keys Authorization -->
              <div class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🔐</span>
                  <span class="text-sm font-semibold text-slate-700">Keys Authorization</span>
                </div>
                <p id="dashboardKeysAuth" class="text-sm font-mono text-indigo-700 truncate" title="">--</p>
                <p id="dashboardKeysAuthStatus" class="text-xs text-slate-600 mt-1">--</p>
              </div>

              <!-- ModelScope 投喂限制 -->
              <div class="p-4 bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg border border-amber-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">🎁</span>
                  <span class="text-sm font-semibold text-slate-700">ModelScope 投喂限制</span>
                </div>
                <p id="dashboardMaxDonateModelscope" class="text-2xl font-bold text-amber-700">--</p>
                <p class="text-xs text-slate-600 mt-1">个/天</p>
              </div>

              <!-- iFlow 投喂限制 -->
              <div class="p-4 bg-gradient-to-br from-teal-50 to-green-50 rounded-lg border border-teal-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">✨</span>
                  <span class="text-sm font-semibold text-slate-700">iFlow 投喂限制</span>
                </div>
                <p id="dashboardMaxDonateIflow" class="text-2xl font-bold text-teal-700">--</p>
                <p class="text-xs text-slate-600 mt-1">个/天</p>
              </div>
            </div>

            <!-- 更新时间 -->
            <div class="mt-4 pt-4 border-t border-slate-200">
              <p class="text-xs text-slate-500 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>最后更新：<span id="dashboardUpdatedAt">--</span></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Config Section -->
        <div id="configSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">系统配置</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <!-- 额度说明 -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm text-blue-900">
                  <p class="font-semibold mb-1">💰 额度单位换算</p>
                  <p class="text-blue-800">500,000 quota = <strong>$1 美元</strong></p>
                  <p class="text-blue-700 text-xs mt-1">示例：20,000,000 quota = $40</p>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">每日领取额度</label>
              <div class="flex gap-2 items-center">
                <div class="flex-1 relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-600 font-semibold">$</span>
                  <input type="number" id="claimQuotaUSD" placeholder="40" step="0.01" min="0" class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <span class="text-sm text-slate-600 whitespace-nowrap">≈ <span id="quotaValue">20,000,000</span> quota</span>
                <button onclick="updateQuota()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">输入美元金额，自动转换为 quota（$1 = 500,000 quota）</p>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">每日最大领取次数</label>
              <div class="flex gap-2 items-center">
                <input type="number" id="maxDailyClaims" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                <span class="text-sm text-slate-600">次/天</span>
                <button onclick="updateMaxDailyClaims()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">API Session</label>
              <div class="mb-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                <div class="text-xs text-slate-500 mb-1">当前 Session:</div>
                <div id="currentSession" class="text-sm font-mono text-slate-700 break-all">未配置</div>
              </div>
              <div class="flex gap-2">
                <input type="text" id="sessionValue" placeholder="输入新的 Session" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg font-mono">
                <button onclick="updateSession()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">New-API-User</label>
              <div class="mb-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="text-xs text-blue-800">
                    <p>KYX API 请求头参数，用于用户搜索和额度更新</p>
                    <p class="mt-1">默认值：<code class="px-1 bg-blue-100 rounded">1</code>（通常无需修改）</p>
                  </div>
                </div>
              </div>
              <div class="flex gap-2 items-center">
                <input type="text" id="newApiUserValue" placeholder="1" class="w-32 px-4 py-2 border border-slate-300 rounded-lg text-center font-mono">
                <span class="text-sm text-slate-600">当前值: <code id="currentNewApiUser" class="px-2 py-1 bg-slate-100 rounded font-mono">1</code></span>
                <button onclick="updateNewApiUser()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys API URL</label>
              <div class="flex gap-2">
                <input type="text" id="keysApiUrl" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysApiUrl()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys Authorization</label>
              <div class="flex gap-2">
                <input type="text" id="keysAuthorization" placeholder="输入 Authorization Token" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysAuthorization()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="modelscopeGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateModelscopeGroupId()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">更新</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="iflowGroupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateIflowGroupId()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">更新</button>
              </div>
            </div>
            
            <!-- 投喂限制配置 -->
            <div class="mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
              <h4 class="text-lg font-bold text-amber-900 mb-4 flex items-center gap-2">
                <span>🎁</span>
                <span>每日投喂限制配置</span>
              </h4>
              <p class="text-sm text-amber-800 mb-4">控制用户每天可以投喂的 Key 数量，不同渠道单独配置</p>
              
              <!-- ModelScope 投喂限制 -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-2">ModelScope 每日投喂限制</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateModelscope" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">个/天</span>
                  <button onclick="updateMaxDailyDonateModelscope()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">更新</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
              </div>
              
              <!-- iFlow 投喂限制 -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">iFlow 每日投喂限制</label>
                <div class="flex gap-2 items-center">
                  <input type="number" id="maxDailyDonateIflow" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                  <span class="text-sm text-slate-600">个/天</span>
                  <button onclick="updateMaxDailyDonateIflow()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 whitespace-nowrap">更新</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">建议设置：1-3次（设置过高可能导致额度滥用）</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Keys Section -->
        <div id="keysSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">Keys 管理</h2>
            <button onclick="refreshKeys()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="keysRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex gap-2">
                <button onclick="exportKeys()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">📥 导出所有</button>
                <button onclick="copyAllKeys()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">📋 复制所有</button>
                <button onclick="testAllKeys()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">🧪 一键测试</button>
              </div>
              <button onclick="toggleKeysBatchMode()" id="keysBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">批量操作</button>
            </div>
            <div id="keysBatchActions" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllKeys" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">全选 (<span id="selectedKeysCount">0</span> 个已选)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="deleteSelectedKeys()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">🗑️ 删除选中</button>
                  <button onclick="testSelectedKeys()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">🧪 测试选中</button>
                </div>
              </div>
            </div>
            <p class="text-sm text-slate-600">总计: <span id="totalKeysCount">0</span> 个 Key</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="keysCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllKeysHeader" onchange="toggleSelectAllKeys()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Key</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">渠道</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">投喂用户</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">投喂时间</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">测试状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="keysListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Claims Section -->
        <div id="claimsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">领取记录</h2>
            <button onclick="refreshClaims()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="claimsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="claimsTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="claimsPageSize" onchange="changeClaimsPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">类型</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">领取额度</th>
                  </tr>
                </thead>
                <tbody id="claimTableBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="claimPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="claimCurrentPage">1</span> / <span id="claimTotalPages">1</span> 页（共 <span id="claimTotal">0</span> 条）
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadClaimRecords(claimCurrentPage - 1)" id="claimPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="claimPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadClaimRecords(claimCurrentPage + 1)" id="claimNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Donates Section -->
        <div id="donatesSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">投喂记录</h2>
            <button onclick="refreshDonates()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="donatesRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="donatesTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="donatesPageSize" onchange="changeDonatesPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">渠道</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">Key 数量</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">增加额度</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">推送状态</th>
                  </tr>
                </thead>
                <tbody id="donateTableBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="donatePagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="donateCurrentPage">1</span> / <span id="donateTotalPages">1</span> 页（共 <span id="donateTotal">0</span> 条）
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadDonateRecords(donateCurrentPage - 1)" id="donatePrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="donatePageNumbers" class="flex gap-1"></div>
                  <button onclick="loadDonateRecords(donateCurrentPage + 1)" id="donateNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 🔥 Advanced Slot Records Section -->
        <div id="advancedSlotRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🔥 高级场游戏记录</h2>
            <button onclick="refreshAdvancedSlotRecords()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          
          <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-red-800">
              💡 <strong>高级场特色：</strong>投注金额$100-$1500可选，奖励倍率×4，惩罚金额×2，严格连续判定
            </p>
          </div>
          
          <!-- 搜索和筛选栏 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- 搜索用户名 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">搜索用户名</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="advancedRecordSearchInput" 
                    placeholder="输入LinuxDo用户名或公益站用户名..." 
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                  >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- 中奖类型筛选 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">中奖类型</label>
                <select 
                  id="advancedWinTypeFilter" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                >
                  <option value="all">全部类型</option>
                  <option value="super_jackpot">🏆 超级大奖</option>
                  <option value="special_combo">💎 特殊组合</option>
                  <option value="quad">🎰 四连</option>
                  <option value="triple">✨ 三连</option>
                  <option value="double">🎁 双连</option>
                  <option value="punishment">⚡ 律师函</option>
                  <option value="none">❌ 未中奖</option>
                </select>
              </div>
              
              <!-- 操作按钮 -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterAdvancedSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  🔍 查询
                </button>
                <button 
                  onclick="refreshAdvancedSlotRecordsKeepFilter()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-1"
                  title="刷新数据（保留筛选条件）"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  刷新
                </button>
              </div>
            </div>
          </div>

          <!-- 统计信息 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-slate-600">总记录数</p>
                <p id="advancedSlotTotal" class="text-2xl font-bold text-slate-900">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">总投注</p>
                <p id="advancedSlotTotalBet" class="text-2xl font-bold text-blue-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">总获奖</p>
                <p id="advancedSlotTotalWin" class="text-2xl font-bold text-green-600">$0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">实际RTP</p>
                <p id="advancedSlotRTP" class="text-2xl font-bold text-purple-600">0%</p>
                <p class="text-xs text-slate-500 mt-1">返还玩家率 (总赢 ÷ 总投)</p>
              </div>
            </div>
            
            <!-- RTP计算公式说明 -->
            <div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
              <div class="flex items-start gap-2">
                <span class="text-purple-600">📊</span>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-purple-900 mb-1">RTP计算公式</p>
                  <p class="text-xs text-slate-700">
                    RTP (Return To Player) = (总获奖 ÷ 总投注) × 100%
                  </p>
                  <p class="text-xs text-slate-600 mt-1">
                    示例：总投注$1000，总获奖$950 → RTP = (950 ÷ 1000) × 100% = 95%
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gradient-to-r from-red-50 to-orange-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">用户</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">投注金额</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">符号</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">中奖类型</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">倍率</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">奖金</th>
                  </tr>
                </thead>
                <tbody id="advancedSlotRecordsBody">
                  <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-slate-400">暂无高级场游戏记录</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div id="advancedSlotRecordsPagination" class="hidden px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                共 <span id="advancedSlotRecordsTotal">0</span> 条记录，当前第 <span id="advancedSlotCurrentPage">1</span> 页
              </div>
              <div class="flex gap-2">
                <button onclick="advancedSlotPrevPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="advancedSlotPrevBtn">
                  上一页
                </button>
                <button onclick="advancedSlotNextPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="advancedSlotNextBtn">
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 🔥 Advanced Slot Config Section -->
        <div id="advancedSlotConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">🔥 高级场配置</h2>
          
          <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-red-800">
              ⚠️ <strong>注意：</strong>配置修改后立即生效，影响所有用户的高级场体验
            </p>
          </div>

          <!-- 🧱 顶部固定区（基础设置）-->
          <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl shadow-md border-2 border-slate-300 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                <span>基础设置</span>
                <button onclick="showRTPHelp()" class="text-blue-600 hover:text-blue-700 transition-colors" title="倍率与RTP说明">
                  🧠
                </button>
              </h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- 启用开关 -->
              <div class="md:col-span-2 lg:col-span-3">
                <label class="flex items-center gap-3 cursor-pointer group">
                  <div class="relative">
                    <input type="checkbox" id="advancedEnabled" class="sr-only peer">
                    <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-red-600 peer-checked:to-orange-600"></div>
                  </div>
                  <span class="text-base font-semibold text-slate-900">启用高级场功能</span>
                </label>
              </div>
              
              <!-- 投注范围 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  投注范围 <span class="text-red-600">*</span>
                </label>
                <div class="flex items-center gap-2">
                  <input type="number" id="advancedBetMinUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold" placeholder="200">
                  <span class="text-slate-500 font-medium">至</span>
                  <input type="number" id="advancedBetMaxUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold" placeholder="1500">
                </div>
                <p class="text-xs text-slate-500 mt-1">美元 (当前: <span id="advancedBetMinQuota">50000000</span> 聪 至 <span id="advancedBetMaxQuota">250000000</span> 聪)</p>
              </div>
              
              <!-- 奖励倍数 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  奖励倍数 <span class="text-blue-500" title="奖励倍数说明">🛈</span>
                </label>
                <input type="number" step="0.1" id="advancedRewardMultiplier" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold text-green-600" placeholder="4.0">
                <p class="text-xs text-slate-500 mt-1">奖励放大系数</p>
              </div>
              
              <!-- 惩罚倍数 -->
              <div>
                <label class="block text-sm font-medium text-red-700 mb-2">
                  惩罚倍数 <span class="text-red-500" title="律师函惩罚金额倍数">🛈</span>
                </label>
                <input type="number" step="0.1" id="advancedPenaltyFactor" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50 font-bold text-red-600" placeholder="2.0">
                <p class="text-xs text-red-600 mt-1">律师函扣除金额倍数</p>
              </div>
              
              <!-- 每日投注上限 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  每日投注上限 <span class="text-blue-500" title="单个用户每天最多投注金额">🛈</span>
                </label>
                <input type="number" id="advancedDailyBetLimitUsd" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold text-orange-600" placeholder="10000">
                <p class="text-xs text-slate-500 mt-1">美元 (当前: <span id="advancedDailyBetLimitQuota">5000000000</span> 聪)</p>
              </div>
            </div>
          </div>

          <!-- ⏰ 时效设置（可折叠）-->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 group">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-900 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">▶</span>
                <span>⏰ 时效设置</span>
              </span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <!-- 入场券有效期 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">入场券有效期（小时）</label>
                  <input type="number" id="advancedTicketValidHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="24">
                  <p class="text-xs text-slate-500 mt-1">入场券过期时间</p>
                </div>
                
                <!-- 高级场停留时长 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">高级场停留时长（小时）</label>
                  <input type="number" id="advancedSessionValidHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="24">
                  <p class="text-xs text-slate-500 mt-1">进入高级场后的有效时间</p>
                </div>
                
                <!-- 提示 -->
                <div class="md:col-span-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p class="text-xs text-blue-800">
                    💡 <strong>提示：</strong>剩余有效时间 = min(入场券有效期, 停留时长)
                  </p>
                </div>
              </div>
            </div>
          </details>

          <!-- 🎲 掉落设置（可折叠）-->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 group">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-900 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">▶</span>
                <span>🎲 掉落与资格机制</span>
              </span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <!-- 合成所需碎片数 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">合成所需碎片数量</label>
                  <input type="number" id="advancedFragmentsNeeded" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="5">
                  <p class="text-xs text-slate-500 mt-1">合成1张入场券需要的碎片</p>
                </div>
                
                <!-- 最多持有券数 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">最多持有入场券数</label>
                  <input type="number" id="advancedMaxTicketsHold" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">防止囤券</p>
                </div>
                
                <!-- 每日进入次数限制 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">每日进入高级场次数限制</label>
                  <input type="number" id="advancedDailyEntryLimit" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">每个用户每天最多进入次数</p>
                </div>
                
                <!-- 每日入场券获得限制 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">每日获得入场券数量限制</label>
                  <input type="number" id="advancedDailyTicketGrantLimit" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-bold" placeholder="2">
                  <p class="text-xs text-slate-500 mt-1">每个用户每天最多获得入场券数</p>
                </div>
                
                <!-- 二连掉落碎片概率 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">二连中奖后掉落碎片概率</label>
                  <input type="range" id="advancedDropRateDoubleSlider" min="0" max="1" step="0.01" value="0.5" 
                         class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                         oninput="updateDropRateDoubleDisplay(this.value)">
                  <div class="flex items-center justify-between mt-2">
                    <input type="number" step="0.01" min="0" max="1" id="advancedDropRateDouble" class="w-20 px-2 py-1 border border-slate-300 rounded text-center text-sm font-bold"
                           oninput="document.getElementById('advancedDropRateDoubleSlider').value = this.value; updateDropRateDoubleDisplay(this.value)">
                    <div class="flex-1 ml-3">
                      <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div id="dropDoubleBar" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-300" style="width: 50%"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">
                    中二连时有 <span id="dropDoublePercent" class="font-bold text-purple-600">50</span>% 概率掉落
                    <span class="mx-1">•</span>
                    期望: 每10局掉落 <span id="dropDoubleExpected" class="font-bold text-purple-600">1.0</span> 个碎片
                  </p>
                </div>
                
                <!-- 三连/四连掉落入场券概率 -->
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">三连/四连中奖后掉落入场券概率</label>
                  <input type="range" id="advancedDropRateTripleSlider" min="0" max="1" step="0.01" value="0.1" 
                         class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                         oninput="updateDropRateTripleDisplay(this.value)">
                  <div class="flex items-center justify-between mt-2">
                    <input type="number" step="0.01" min="0" max="1" id="advancedDropRateTriple" class="w-20 px-2 py-1 border border-slate-300 rounded text-center text-sm font-bold"
                           oninput="document.getElementById('advancedDropRateTripleSlider').value = this.value; updateDropRateTripleDisplay(this.value)">
                    <div class="flex-1 ml-3">
                      <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div id="dropTripleBar" class="h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-300" style="width: 10%"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-xs text-slate-500 mt-1">
                    中三连/四连时有 <span id="dropTriplePercent" class="font-bold text-orange-600">10</span>% 概率掉落
                    <span class="mx-1">•</span>
                    期望: 每10局掉落 <span id="dropTripleExpected" class="font-bold text-orange-600">0.1</span> 张券
                  </p>
                </div>
                
                <!-- 掉落强度评估 -->
                <div class="md:col-span-2 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-700">掉落强度：</span>
                    <div id="dropIntensity" class="flex items-center gap-1">
                      <span class="text-2xl">★★☆☆☆</span>
                      <span class="text-sm font-bold text-purple-600 ml-2">(平衡)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <!-- 🎲 符号权重配置方案 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">⚖️ 符号权重配置方案（高级场）</h3>
            </div>
            
            <div class="mb-4 p-4 bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg">
              <p class="text-sm text-red-800 mb-2">
                <strong>✨ 新配置方式：</strong>从配置方案中选择，无需手动填写！
              </p>
              <p class="text-xs text-red-700">
                • 在"权重配置管理"中创建高级场专用权重方案<br>
                • 修改方案后立即生效<br>
                • 可与初级场使用不同的配置方案
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择权重配置方案 *</label>
              <select id="advancedSlotWeightConfigId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" onchange="previewAdvancedWeightConfig()">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 可与初级场使用相同或不同的权重方案</p>
            </div>
            
            <!-- 预览权重 -->
            <div id="advancedWeightPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">📊 当前配置预览</h4>
              <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">美(m)</div>
                  <div id="adv_preview_weight_m" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">坤(t)</div>
                  <div id="adv_preview_weight_t" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">你(n)</div>
                  <div id="adv_preview_weight_n" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">太(j)</div>
                  <div id="adv_preview_weight_j" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">鲤鱼(lq)</div>
                  <div id="adv_preview_weight_lq" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">背景(bj)</div>
                  <div id="adv_preview_weight_bj" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">真粉头(zft)</div>
                  <div id="adv_preview_weight_zft" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">不打工(bdk)</div>
                  <div id="adv_preview_weight_bdk" class="font-bold text-red-600">--</div>
                </div>
                <div class="text-center p-2 bg-red-100 rounded border border-red-300">
                  <div class="text-red-700">律师函(lsh)</div>
                  <div id="adv_preview_weight_lsh" class="font-bold text-red-700">--</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">🎁 中奖规则配置方案（高级场）</h3>
            </div>
            
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-purple-800 mb-2">
                <strong>✨ 新配置方式：</strong>使用预设规则模板，无需手动配置！
              </p>
              <p class="text-xs text-purple-700">
                • 在"奖励配置管理"中创建方案并添加预设规则<br>
                • 可与初级场使用相同或不同的奖励方案<br>
                • 支持一键应用律师函惩罚
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择奖励配置方案 *</label>
              <select id="advancedSlotRewardSchemeId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" onchange="previewAdvancedRewardScheme()">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 在"奖励配置管理"中可以创建新方案或编辑规则</p>
            </div>
            
            <!-- 预览规则 -->
            <div id="advancedRewardPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">🎯 包含规则</h4>
              <div id="advancedRewardPreviewList" class="space-y-2 text-xs">
                <!-- 动态填充 -->
              </div>
            </div>
          </div>
          
          <!-- 旧版手动权重配置（折叠） -->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-700 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">▶</span>
                <span>🔧 旧版手动权重配置（不推荐）</span>
              </span>
              <span class="text-xs text-red-600">已弃用</span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 mt-4">
                <p class="text-sm text-red-800">
                  ⚠️ <strong>警告：</strong>建议使用上方的配置方案系统。手动修改可能与配置方案冲突。
              </p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <!-- 普通符号 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">🎵 美 (m)</label>
                <input type="number" id="advWeight_m" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_m" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">⚡ 太 (t)</label>
                <input type="number" id="advWeight_t" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_t" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">👀 你 (n)</label>
                <input type="number" id="advWeight_n" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_n" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">🐔 鸡 (j)</label>
                <input type="number" id="advWeight_j" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_j" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">🏀 篮球 (lq)</label>
                <input type="number" id="advWeight_lq" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_lq" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">🎬 背景 (bj)</label>
                <input type="number" id="advWeight_bj" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_bj" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">💇 中分头 (zft)</label>
                <input type="number" id="advWeight_zft" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_zft" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">👖 背带裤 (bdk)</label>
                <input type="number" id="advWeight_bdk" class="w-full px-3 py-2 border border-slate-300 rounded-lg" min="1" max="1000">
                <p id="advProb_bdk" class="text-xs text-slate-500 mt-1">概率: 0%</p>
              </div>
              <div class="md:col-span-3">
                <label class="block text-sm font-medium text-red-700 mb-2">⚖️ 律师函 (lsh) - 惩罚符号</label>
                <input type="number" id="advWeight_lsh" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50" min="1" max="1000">
                <p id="advProb_lsh" class="text-xs text-red-600 mt-1">概率: 0% | 4个位置至少出现1次: 0%</p>
              </div>
            </div>
            
            <!-- 总权重显示 -->
            <div class="mt-4 p-3 bg-slate-50 rounded-lg border border-slate-300">
              <p class="text-sm text-slate-700">
                📊 当前总权重: <span id="advTotalWeight" class="font-bold text-indigo-600">825</span>
              </p>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex gap-2 mt-4">
              <button onclick="saveAdvancedSymbolWeights()" class="flex-1 px-4 py-2 bg-slate-400 hover:bg-slate-500 text-white rounded-lg font-semibold transition-all">
                保存权重配置（旧版）
              </button>
              <button onclick="loadAdvancedSymbolWeights()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium transition-colors">
                重置
              </button>
            </div>
            </div>
          </details>

          <!-- 保存配置方案按钮 -->
          <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-300 rounded-xl p-5 mb-6">
            <h4 class="text-md font-bold text-red-900 mb-3 flex items-center gap-2">
              <span class="text-xl">💾</span>
              保存配置方案（推荐）
            </h4>
            <p class="text-sm text-red-700 mb-4">应用权重和奖励配置方案到高级场</p>
            <div class="flex gap-3">
              <button onclick="saveAdvancedSlotConfigSchemes()" class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold shadow-lg transition-all">
                💾 保存高级场配置方案
              </button>
              <button onclick="loadAdvancedSlotConfig()" class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium transition-colors">
                🔄 重新加载
              </button>
            </div>
          </div>
          
          <!-- 保存基础配置按钮 -->
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-5 mb-6">
            <h4 class="text-md font-bold text-blue-900 mb-3 flex items-center gap-2">
              <span class="text-xl">⚙️</span>
              保存基础配置
            </h4>
            <p class="text-sm text-blue-700 mb-4">保存投注范围、奖励倍数、掉落率等基础参数</p>
            <button onclick="saveAdvancedSlotConfig()" class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-semibold shadow-lg transition-all">
              💾 保存基础配置
            </button>
          </div>
        </div>

        <!-- 🎟️ Ticket Drop Records Section -->
        <div id="ticketDropRecordsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">🎟️ 入场券掉落记录</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-slate-600">总掉落次数</p>
                <p id="ticketDropTotal" class="text-2xl font-bold text-slate-900">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">入场券掉落</p>
                <p id="ticketDropCount" class="text-2xl font-bold text-purple-600">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">碎片掉落</p>
                <p id="fragmentDropCount" class="text-2xl font-bold text-blue-600">0</p>
              </div>
              <div>
                <p class="text-sm text-slate-600">今日掉落</p>
                <p id="todayDropCount" class="text-2xl font-bold text-green-600">0</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">用户</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">掉落类型</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">数量</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">触发条件</th>
                  </tr>
                </thead>
                <tbody id="ticketDropRecordsBody">
                  <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-slate-400">暂无掉落记录</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div id="ticketDropPagination" class="hidden px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                共 <span id="ticketDropRecordsTotal">0</span> 条记录，当前第 <span id="ticketDropCurrentPage">1</span> 页
              </div>
              <div class="flex gap-2">
                <button onclick="ticketDropPrevPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="ticketDropPrevBtn">
                  上一页
                </button>
                <button onclick="ticketDropNextPage()" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="ticketDropNextBtn">
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Slot Machine Config Section -->
        <div id="slotConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">⚙️ 老虎机配置（初级场）</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">基本配置</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  投注金额 (单位: $, 500000 = $1)
                </label>
                <input type="number" step="0.01" id="slotBetAmountUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">当前：$<span id="slotBetAmountDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  每日游玩次数
                </label>
                <input type="number" id="slotMaxDailySpins" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="5">
                <p class="text-xs text-slate-500 mt-1">每个用户每天最多可玩的次数</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  最低额度要求 (单位: $)
                </label>
                <input type="number" step="0.01" id="slotMinQuotaUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="20">
                <p class="text-xs text-slate-500 mt-1">当前：$<span id="slotMinQuotaDisplay">20.00</span></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  启用状态
                </label>
                <select id="slotEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="1">启用</option>
                  <option value="0">禁用</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">禁用后用户无法访问老虎机</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  背景类型
                </label>
                <select id="slotBackgroundType" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="default">默认渐变</option>
                  <option value="gif">动态GIF</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">选择老虎机界面的背景样式</p>
              </div>
            </div>

            <!-- 购买次数配置 -->
            <div class="mt-6 p-4 bg-orange-50 border-2 border-orange-200 rounded-lg">
              <h4 class="text-md font-semibold text-orange-800 mb-3 flex items-center gap-2">
                <span>💰</span>
                <span>购买抽奖次数功能</span>
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    功能开关
                  </label>
                  <select id="buySpinsEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <option value="0">关闭</option>
                    <option value="1">开启</option>
                  </select>
                  <p class="text-xs text-slate-500 mt-1">开启后用户可以购买抽奖次数</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    购买价格 (单位: $)
                  </label>
                  <input type="number" step="0.01" id="buySpinsPriceUSD" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="40">
                  <p class="text-xs text-slate-500 mt-1">当前：$<span id="buySpinsPriceDisplay">40.00</span></p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    每日最大购买次数
                  </label>
                  <input type="number" id="maxDailyBuySpins" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="5">
                  <p class="text-xs text-slate-500 mt-1">用户每天最多可购买的次数</p>
                </div>

                <div class="flex items-end">
                  <div class="w-full p-3 bg-white rounded-lg border border-orange-200">
                    <p class="text-xs text-orange-700 font-medium mb-1">说明</p>
                    <p class="text-xs text-slate-600">购买的次数会增加到免费次数中，购买后仍需投注才能抽奖</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
              <h4 class="text-sm font-bold text-blue-900 mb-3">💾 保存基本配置</h4>
              <p class="text-xs text-blue-700 mb-3">保存投注金额、每日次数、购买功能等基础参数</p>
              <div class="flex gap-3">
                <button onclick="updateSlotConfig()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                  💾 保存基本配置
                </button>
                <button onclick="loadSlotConfig()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                  🔄 重新加载
                </button>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900">⚖️ 符号权重配置方案</h3>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-blue-800 mb-2">
                <strong>✨ 新配置方式：</strong>从配置方案中选择，无需手动填写权重值！
              </p>
              <p class="text-xs text-blue-700">
                • 在"权重配置管理"中创建和管理配置方案<br>
                • 修改方案后，所有使用该方案的场次立即生效<br>
                • 支持多场次共用同一配置方案
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择权重配置方案 *</label>
              <select id="normalSlotWeightConfigId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="previewNormalWeightConfig()">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 在"权重配置管理"中可以创建新方案或编辑现有方案</p>
            </div>
            
            <!-- 预览权重 -->
            <div id="normalWeightPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">📊 当前配置预览</h4>
              <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs">
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">美(m)</div>
                  <div id="preview_weight_m" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">坤(t)</div>
                  <div id="preview_weight_t" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">你(n)</div>
                  <div id="preview_weight_n" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">太(j)</div>
                  <div id="preview_weight_j" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">鲤鱼(lq)</div>
                  <div id="preview_weight_lq" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">背景(bj)</div>
                  <div id="preview_weight_bj" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">真粉头(zft)</div>
                  <div id="preview_weight_zft" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                  <div class="text-slate-600">不打工(bdk)</div>
                  <div id="preview_weight_bdk" class="font-bold text-blue-600">--</div>
                </div>
                <div class="text-center p-2 bg-red-50 rounded border border-red-200">
                  <div class="text-red-600">律师函(lsh)</div>
                  <div id="preview_weight_lsh" class="font-bold text-red-600">--</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900">🎁 中奖规则配置方案</h3>
            </div>
            
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-purple-800 mb-2">
                <strong>✨ 新配置方式：</strong>使用预设规则模板，无需手动配置复杂参数！
              </p>
              <p class="text-xs text-purple-700">
                • 在"奖励配置管理"中创建方案并添加预设规则<br>
                • 支持一键应用律师函惩罚配置<br>
                • 同一方案可被多个场次复用
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择奖励配置方案 *</label>
              <select id="normalSlotRewardSchemeId" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="previewNormalRewardScheme()">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 在"奖励配置管理"中可以创建新方案或编辑规则</p>
            </div>
            
            <!-- 预览规则 -->
            <div id="normalRewardPreview" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
              <h4 class="text-sm font-bold text-slate-900 mb-3">🎯 包含规则</h4>
              <div id="normalRewardPreviewList" class="space-y-2 text-xs">
                <!-- 动态填充 -->
              </div>
            </div>
          </div>
          
          <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <span class="text-2xl">💡</span>
              <div>
                <p class="text-sm font-semibold text-amber-900 mb-1">快速配置指南</p>
                <ol class="text-sm text-amber-800 space-y-1">
                  <li>1. 在"权重配置管理"中创建权重方案（如：标准初级场配置）</li>
                  <li>2. 在"奖励配置管理"中创建奖励方案并添加预设规则模板</li>
                  <li>3. 在此处选择刚创建的方案</li>
                  <li>4. 点击保存配置，立即生效！</li>
                </ol>
              </div>
            </div>
          </div>
          
          <!-- 旧版手动配置（折叠，兼容性保留） -->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-700 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">▶</span>
                <span>🔧 旧版手动配置（不推荐）</span>
              </span>
              <span class="text-xs text-red-600">已弃用</span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 mt-4">
                <p class="text-sm text-red-800">
                  ⚠️ <strong>警告：</strong>旧版手动配置已弃用，建议使用上方的配置方案系统。手动修改权重可能与配置方案冲突。
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- 美 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🎵 美 (m) 权重
                </label>
                <input type="number" id="weight_m" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_m" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 太 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  ⚡ 太 (t) 权重
                </label>
                <input type="number" id="weight_t" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_t" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 你 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  👀 你 (n) 权重
                </label>
                <input type="number" id="weight_n" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_n" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 鸡 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🐔 鸡 (j) 权重
                </label>
                <input type="number" id="weight_j" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_j" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 篮球 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🏀 篮球 (lq) 权重
                </label>
                <input type="number" id="weight_lq" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_lq" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 背景 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🎬 背景 (bj) 权重
                </label>
                <input type="number" id="weight_bj" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_bj" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 中分头 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  💇 中分头 (zft) 权重
                </label>
                <input type="number" id="weight_zft" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_zft" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 背带裤 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  👖 背带裤 (bdk) 权重
                </label>
                <input type="number" id="weight_bdk" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="100">
                <p id="prob_bdk" class="text-xs text-slate-500 mt-1">概率: --</p>
              </div>

              <!-- 律师函 -->
              <div class="md:col-span-3">
                <label class="block text-sm font-medium text-red-700 mb-1">
                  ⚖️ 律师函 (lsh) 权重 <span class="text-xs text-red-600">(惩罚符号)</span>
                </label>
                <div class="flex gap-4 items-center">
                  <input type="number" id="weight_lsh" min="1" max="1000" class="flex-1 px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-red-50" placeholder="25">
                  <div class="flex-1">
                    <p id="prob_lsh" class="text-sm font-medium text-red-700">概率: --</p>
                    <p id="prob_lsh_appear" class="text-xs text-red-600">4个位置至少出现1次: --</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 rounded-lg p-4 mb-4">
              <p class="text-sm font-semibold text-slate-700 mb-2">📊 当前总权重: <span id="totalWeight" class="text-indigo-600">--</span></p>
              <p class="text-xs text-slate-600">总权重 = 所有符号权重之和</p>
            </div>

            <div class="flex gap-3">
              <button onclick="updateSymbolWeights()" class="px-6 py-2 bg-slate-400 text-white rounded-lg font-semibold hover:bg-slate-500 transition-colors">
                保存权重配置（旧版）
              </button>
              <button onclick="loadSymbolWeights()" class="px-6 py-2 bg-slate-100 text-slate-700 rounded-lg font-semibold hover:bg-slate-200 transition-colors">
                重置
              </button>
            </div>
            </div>
          </details>

          <!-- 保存配置方案按钮 -->
          <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-xl p-5 mb-6">
            <h4 class="text-md font-bold text-indigo-900 mb-3 flex items-center gap-2">
              <span class="text-xl">💾</span>
              保存配置方案（推荐）
            </h4>
            <p class="text-sm text-indigo-700 mb-4">应用权重和奖励配置方案到初级场</p>
            <div class="flex gap-3">
              <button onclick="saveNormalSlotConfigSchemes()" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-semibold shadow-lg transition-all">
                💾 保存初级场配置方案
              </button>
              <button onclick="loadSlotConfig()" class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium transition-colors">
                🔄 重新加载
              </button>
            </div>
          </div>

          <!-- 奖励倍数配置（旧版，已由奖励配置方案替代） -->
          <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
            <summary class="cursor-pointer px-6 py-4 font-bold text-slate-700 hover:bg-slate-50 transition-colors flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-lg transform transition-transform group-open:rotate-90">▶</span>
                <span>🎁 旧版奖励倍数配置（不推荐）</span>
              </span>
              <span class="text-xs text-red-600">已弃用</span>
            </summary>
            <div class="px-6 pb-6 border-t border-slate-200">
              <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 mt-4">
                <p class="text-sm text-red-800 mb-2">
                  ⚠️ <strong>警告：</strong>建议使用"奖励配置方案"系统管理中奖规则和倍率。
                </p>
                <p class="text-xs text-red-700">
                  • 新系统支持预设规则模板，配置更简单<br>
                  • 支持多场次共用同一配置方案<br>
                  • 手动修改可能与配置方案冲突
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
              <!-- 超级大奖 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  💎 超级大奖（顺序四连）
                </label>
                <input type="number" id="super_jackpot_multiplier" min="1" max="10000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="256">
                <p class="text-xs text-slate-500 mt-1">j→n→t→m 或 bj→zft→bdk→lq</p>
              </div>

              <!-- 特殊四异符 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  ✨ 特殊四异符（乱序）
                </label>
                <input type="number" id="special_combo_multiplier" min="1" max="10000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="16">
                <p class="text-xs text-slate-500 mt-1">包含所有4个特殊符号但不按顺序</p>
              </div>

              <!-- 四连 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🎯 四连（相同符号×4）
                </label>
                <input type="number" id="quad_multiplier" min="1" max="10000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="32">
                <p class="text-xs text-slate-500 mt-1">任意相同符号出现4次，赠送1次免费</p>
              </div>

              <!-- 三连 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  🔥 三连（相同符号×3）
                </label>
                <input type="number" id="triple_multiplier" min="1" max="10000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="8">
                <p class="text-xs text-slate-500 mt-1">任意相同符号出现3次</p>
              </div>

              <!-- 双连 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                  ⭐ 双连（相同符号×2）
                </label>
                <input type="number" id="double_multiplier" min="1" max="10000" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="4">
                <p class="text-xs text-slate-500 mt-1">任意相同符号出现2次</p>
              </div>
            </div>

            <div class="flex justify-end">
              <button onclick="saveMultipliers()" class="px-6 py-2.5 bg-slate-400 hover:bg-slate-500 text-white rounded-lg transition-all font-medium">
                💾 保存倍数配置（旧版）
              </button>
            </div>
            </div>
          </details>
        </div>

        <!-- Slot Analytics Section -->
        <div id="slotAnalyticsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🎰 抽奖数据分析</h2>
            <button onclick="loadSlotAnalytics()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="analyticsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新数据
            </button>
          </div>
          
          <!-- 🔥 分析筛选栏 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 分析范围选择 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">📊 分析范围</label>
                <select 
                  id="analyticsRecordCount" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  onchange="loadSlotAnalytics()"
                >
                  <option value="100">最近100次游戏</option>
                  <option value="500" selected>最近500次游戏</option>
                  <option value="1000">最近1000次游戏</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">修改权重后选择100次可快速观察效果</p>
              </div>
              
              <!-- 游戏模式筛选 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">🎮 游戏模式</label>
                <select 
                  id="analyticsSlotMode" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  onchange="loadSlotAnalytics()"
                >
                  <option value="all" selected>全部模式</option>
                  <option value="normal">初级场（任意位置）</option>
                  <option value="advanced">高级场（严格连续）</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">初级场和高级场使用不同权重配置</p>
              </div>
              
              <!-- 说明信息 -->
              <div class="flex items-center">
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                  <p class="text-xs text-blue-800">
                    <strong>提示：</strong> 
                    <br>• 初级场：任意位置相同即可
                    <br>• 高级场：必须相邻连续
                    <br>• 建议分别查看两种模式数据
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- 概览统计 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">总游戏次数</h3>
                <span class="text-2xl">🎰</span>
              </div>
              <p id="analyticsTotal" class="text-3xl font-bold text-slate-900">0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">中奖率</h3>
                <span class="text-2xl">🎯</span>
              </div>
              <p id="analyticsWinRate" class="text-3xl font-bold text-green-600">0%</p>
              <p class="text-xs text-slate-500 mt-1">中奖 <span id="analyticsWinCount">0</span> 次</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">总投注</h3>
                <span class="text-2xl">💰</span>
              </div>
              <p id="analyticsTotalBet" class="text-3xl font-bold text-red-600">$0</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">净盈亏</h3>
                <span class="text-2xl">📊</span>
              </div>
              <p id="analyticsNetProfit" class="text-3xl font-bold">$0</p>
              <p class="text-xs text-slate-500 mt-1">总赢得 <span id="analyticsTotalWin">$0</span></p>
            </div>
            
            <!-- 🔥 新增：RTP统计 -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-600">实际RTP</h3>
                <span class="text-2xl">📈</span>
              </div>
              <p id="analyticsRTP" class="text-3xl font-bold text-purple-600">0%</p>
              <p class="text-xs text-slate-500 mt-1">返还玩家率</p>
            </div>
          </div>
          
          <!-- 🔥 RTP详细分析 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">📈 RTP详细分析</h3>
            
            <!-- RTP说明 -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
              <div class="flex items-start gap-3">
                <div class="text-2xl">💡</div>
                <div class="flex-1">
                  <h4 class="font-semibold text-purple-900 mb-2">什么是RTP？</h4>
                  <p class="text-sm text-purple-800 mb-2">
                    RTP (Return to Player) = 返还玩家率，表示玩家长期游戏能拿回的投注比例
                  </p>
                  <p class="text-sm text-purple-700">
                    <strong>计算公式：</strong> RTP = (总赢得 ÷ 总投注) × 100%
                  </p>
                  <p class="text-xs text-purple-600 mt-2">
                    例如：总投注$1000，总赢得$880 → RTP = 88%（玩家拿回88%，系统收益12%）
                  </p>
                </div>
              </div>
            </div>
            
            <!-- RTP统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 整体RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">整体RTP</span>
                  <span id="rtpOverall" class="text-2xl font-bold text-purple-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>总投注:</span>
                    <span id="rtpTotalBet" class="font-semibold">$0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>总赢得:</span>
                    <span id="rtpTotalWin" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
              
              <!-- 中奖RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">中奖游戏RTP</span>
                  <span id="rtpWinGames" class="text-2xl font-bold text-green-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>中奖次数:</span>
                    <span id="rtpWinCount" class="font-semibold">0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>中奖投注:</span>
                    <span id="rtpWinBet" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
              
              <!-- 未中奖RTP -->
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-slate-700">未中奖损失率</span>
                  <span id="rtpLossRate" class="text-2xl font-bold text-red-600">--</span>
                </div>
                <div class="text-xs text-slate-600">
                  <div class="flex justify-between">
                    <span>未中奖次数:</span>
                    <span id="rtpLossCount" class="font-semibold">0</span>
                  </div>
                  <div class="flex justify-between mt-1">
                    <span>损失金额:</span>
                    <span id="rtpLossAmount" class="font-semibold">$0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- RTP趋势（按中奖类型） -->
            <div class="mt-6">
              <h4 class="font-semibold text-slate-900 mb-3">各中奖类型RTP贡献</h4>
              <div class="space-y-2" id="rtpByWinType">
                <!-- 将通过JS填充 -->
              </div>
            </div>
          </div>

          <!-- 中奖类型分布 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">🎁 中奖类型分布</h3>
            <div class="space-y-3" id="winTypesDistribution">
              <!-- 将通过JS填充 -->
            </div>
          </div>

          <!-- 每日统计 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">📅 最近7天统计</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700">日期</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">游戏次数</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">总投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">总赢得</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">净盈亏</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700">RTP</th>
                  </tr>
                </thead>
                <tbody id="dailyStatsBody" class="divide-y divide-slate-100">
                  <!-- 将通过JS填充 -->
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Profit Leaderboard Section -->
        <div id="profitLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🏆 盈利排行榜</h2>
            <button onclick="loadProfitLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
              <svg id="profitLeaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新排行
            </button>
          </div>

          <!-- 排行榜说明 -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-green-800 mb-2">
              <strong>📊 排行依据：</strong>按用户总盈亏排序（总赢得 - 总投注）
            </p>
            <p class="text-xs text-green-700">
              • 显示赚钱最多的用户 TOP 20<br>
              • 实时更新，每次游戏后自动刷新
            </p>
          </div>

          <!-- 盈利排行榜表格 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-500 to-orange-500 px-4 py-3">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span>🏆</span>
                <span>盈利排行榜 TOP 20</span>
                <span class="text-sm font-normal text-white/80">（赚最多）</span>
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">排名</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase">LinuxDo 用户名</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase">游戏次数</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">总投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">总获奖</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">净盈亏</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase">最大单次奖金</th>
                  </tr>
                </thead>
                <tbody id="profitLeaderboardTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Loss Leaderboard Section -->
        <div id="lossLeaderboardSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">📉 亏损排行榜</h2>
            <button onclick="loadLossLeaderboard()" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
              <svg id="lossLeaderboardRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新排行
            </button>
          </div>

          <!-- 排行榜说明 -->
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-red-800 mb-2">
              <strong>📊 排行依据：</strong>按用户总盈亏排序（总赢得 - 总投注）
            </p>
            <p class="text-xs text-red-700">
              • 显示亏损最多的用户 TOP 20（警示作用）<br>
              • 实时更新，每次游戏后自动刷新
            </p>
          </div>
          
          <!-- 亏损排行榜表格 -->
          <div class="bg-white rounded-xl shadow-sm border-2 border-red-200 overflow-hidden">
            <div class="bg-gradient-to-r from-red-500 to-rose-500 px-4 py-3">
              <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span>📉</span>
                <span>亏损排行榜 TOP 20</span>
                <span class="text-sm font-normal text-white/80">（亏最多）</span>
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-red-50 border-b border-red-200">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-red-700 uppercase">排名</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-red-700 uppercase">LinuxDo 用户名</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-red-700 uppercase">游戏次数</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">总投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">总获奖</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">净盈亏</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-red-700 uppercase">亏损率</th>
                  </tr>
                </thead>
                <tbody id="lossLeaderboardTableBody" class="divide-y divide-red-100">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Slot Machine Records Section -->
        <div id="slotRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🎰 初级场游戏记录</h2>
            <button onclick="refreshSlotRecords()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="slotRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          
          <!-- 搜索和筛选栏 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <!-- 搜索用户名 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">搜索用户名</label>
                <div class="relative">
                <input 
                  type="text" 
                  id="adminRecordSearchInput" 
                  placeholder="输入LinuxDo用户名或公益站用户名..." 
                  class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- 中奖类型筛选 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">中奖类型</label>
                <select 
                  id="adminWinTypeFilter" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="all">全部类型</option>
                  <option value="super_jackpot">🏆 超级大奖</option>
                  <option value="special_combo">💎 特殊组合</option>
                  <option value="quad">🎰 四连</option>
                  <option value="triple">✨ 三连</option>
                  <option value="double">🎁 双连</option>
                  <option value="punishment">⚡ 律师函</option>
                  <option value="none">❌ 未中奖</option>
                </select>
              </div>
              
              <!-- 操作按钮 -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterAdminSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  🔍 查询
                </button>
                <button 
                  onclick="refreshAdminSlotRecords()" 
                  class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-1"
                  title="刷新数据（保留筛选条件）"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  刷新
                </button>
                <button 
                  onclick="clearAdminRecordFilters()" 
                  class="flex-1 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors font-medium"
                >
                  🔄 重置
                </button>
              </div>
            </div>
            
            <!-- 筛选结果提示 -->
            <div id="adminFilterResultHint" class="text-sm text-slate-600 hidden"></div>
          </div>
          
          <!-- 统计信息 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex items-center gap-4">
              <div class="text-sm text-slate-600">
                总记录数: <span id="slotTotal" class="font-bold text-slate-900">0</span>
              </div>
              <div class="text-sm text-slate-600">
                筛选结果: <span id="slotFiltered" class="font-bold text-indigo-600">0</span>
              </div>
              <div class="flex items-center gap-2 ml-auto">
                <label class="text-sm text-slate-600">每页显示:</label>
                <select id="slotPageSize" onchange="changeSlotPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                  <option value="20">20条</option>
                  <option value="50" selected>50条</option>
                  <option value="100">100条</option>
                </select>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">时间</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">用户名</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Linux Do ID</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">结果符号</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">中奖类型</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">倍率</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">投注</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">赢得</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">类型</th>
                  </tr>
                </thead>
                <tbody id="slotTableBody" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="9" class="px-4 py-8 text-center text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
              <div class="flex items-center justify-between">
                <button onclick="loadSlotRecords(slotCurrentPage - 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotPrevBtn">
                  上一页
                </button>
                <span class="text-sm text-slate-600">
                  第 <span id="slotCurrentPage" class="font-semibold">1</span> 页 / 共 <span id="slotTotalPages" class="font-semibold">1</span> 页
                </span>
                <button onclick="loadSlotRecords(slotCurrentPage + 1)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" id="slotNextBtn">
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">用户列表</h2>
            <button onclick="refreshUsers()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg id="usersRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          
          <!-- 🔍 搜索栏 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- 用户名搜索 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">搜索用户</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="usersSearchInput" 
                    placeholder="输入LinuxDo用户名或公益站用户名（linuxdo_xxx）..." 
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  >
                  <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <!-- 操作按钮 -->
              <div class="flex items-end gap-2">
                <button 
                  onclick="filterUsers()" 
                  class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all font-semibold shadow-md"
                >
                  🔍 搜索
                </button>
                <button 
                  onclick="clearUsersFilter()" 
                  class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors font-medium"
                >
                  🔄 重置
                </button>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center gap-4">
                <div class="text-sm text-slate-600">
                  总用户数: <span id="usersTotal" class="font-bold text-slate-900">0</span>
                  <span id="usersFilteredInfo" class="hidden text-indigo-600 ml-2">（筛选后: <span id="usersFilteredCount">0</span>）</span>
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-600">每页显示:</label>
                  <select id="usersPageSize" onchange="changeUsersPageSize()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                    <option value="10">10条</option>
                    <option value="20" selected>20条</option>
                    <option value="50">50条</option>
                    <option value="100">100条</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="exportUsersData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">📥 导出</button>
                <button onclick="toggleUsersBatchMode()" id="usersBatchBtn" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">批量操作</button>
              </div>
            </div>
            <div id="usersBatchActions" class="hidden mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                  <label class="text-sm font-semibold text-slate-700">全选 (<span id="selectedUsersCount">0</span> 个已选)</label>
                </div>
                <div class="flex gap-2">
                  <button onclick="batchBanUsers()" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">🚫 批量封禁</button>
                  <button onclick="batchUnbindUsers()" class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm font-semibold">🔓 批量解绑</button>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th id="usersCheckboxHeader" class="hidden px-4 py-3 text-center font-semibold text-slate-700 w-12">
                      <input type="checkbox" id="selectAllUsersHeader" onchange="toggleSelectAllUsers()" class="w-4 h-4 rounded border-slate-300">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">#</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">投喂次数</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">领取次数</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">总获得额度</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">管理</th>
                  </tr>
                </thead>
                <tbody id="usersListBody"></tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="usersPagination" class="border-t border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600">
                  第 <span id="usersCurrentPage">1</span> / <span id="usersTotalPages">1</span> 页
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="loadUsersList(usersCurrentPage - 1)" id="usersPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>上一页</button>
                  <div id="usersPageNumbers" class="flex gap-1"></div>
                  <button onclick="loadUsersList(usersCurrentPage + 1)" id="usersNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">下一页</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Grant Free Spins Section -->
        <div id="grantFreeSpinsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">🎁 发放免费次数</h2>
          
          <!-- 单个用户发放 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">单个用户发放</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">用户标识 *</label>
                <div class="relative">
                  <input type="text" id="singleUserIdentifier" placeholder="输入用户名或ID，如: linuxdo_123 或 123456" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onkeyup="searchUserDebounced()">
                  <div id="singleUserSearchResults" class="hidden absolute z-10 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <p class="text-xs text-slate-500 mt-1">支持用户名（linuxdo_123）或 Linux Do ID（123456）</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">免费次数 *</label>
                <input type="number" id="singleSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">最多100次</p>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">发放原因</label>
                <input type="text" id="singleReason" placeholder="例如: bug补偿、活动奖励等" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">选填，记录发放原因便于追溯</p>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantSingleFreeSpin()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                发放
              </button>
              <button onclick="clearSingleForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                清空
              </button>
            </div>
          </div>

          <!-- 批量发放 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">批量发放</h3>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">用户列表 *</label>
                <textarea id="batchUserIdentifiers" rows="6" placeholder="输入用户名或ID，每行一个，例如：&#10;linuxdo_123&#10;linuxdo_456&#10;123456&#10;789012" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"></textarea>
                <p class="text-xs text-slate-500 mt-1">支持用户名（linuxdo_xxx）或Linux Do ID，每行一个，最多5000个用户</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">免费次数 *</label>
                  <input type="number" id="batchSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <p class="text-xs text-slate-500 mt-1">每个用户获得的次数</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">发放原因</label>
                  <input type="text" id="batchReason" placeholder="例如: bug补偿、活动奖励等" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantBatchFreeSpin()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                批量发放
              </button>
              <button onclick="clearBatchForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                清空
              </button>
            </div>
          </div>

          <!-- 全员发放 -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl shadow-sm border-2 border-orange-300 p-6 mb-6">
            <h3 class="text-lg font-semibold text-orange-900 mb-2 flex items-center gap-2">
              <span>⚠️</span> 
              <span>全员发放（慎用）</span>
            </h3>
            <p class="text-sm text-orange-800 mb-4">此功能将为所有未封禁用户（约2000+）发放免费次数，请谨慎使用！</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">免费次数 *</label>
                <input type="number" id="allSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">每个用户获得的次数</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">发放原因 *</label>
                <input type="text" id="allReason" placeholder="例如: 系统维护补偿" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-1">必填，记录全员发放原因</p>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button onclick="grantAllFreeSpin()" class="px-8 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                ⚠️ 给所有用户发放
              </button>
              <button onclick="clearAllForm()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                清空
              </button>
            </div>
          </div>

          <!-- 查询用户免费次数 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">查询用户免费次数</h3>
            <div class="flex gap-3">
              <div class="flex-1">
                <input type="text" id="queryUserIdentifier" placeholder="输入用户名（linuxdo_123）或Linux Do ID" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
              <button onclick="queryUserFreeSpins()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                查询
              </button>
            </div>
            <div id="queryResult" class="mt-4 hidden">
              <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                  <div>
                    <p class="text-sm text-slate-600">用户名</p>
                    <p id="queryUsername" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">免费次数</p>
                    <p id="queryFreeSpins" class="text-lg font-bold text-purple-600 mt-1">0</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">禁止抽奖至</p>
                    <p id="queryBannedUntil" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                  <div>
                    <p class="text-sm text-slate-600">更新时间</p>
                    <p id="queryUpdatedAt" class="text-lg font-bold text-slate-900 mt-1">--</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Rewards Section -->
        <div id="pendingRewardsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">💰 待发放奖金管理</h2>
            <div class="flex gap-2">
              <button onclick="refreshPendingRewards()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg id="pendingRewardsRefreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                刷新
              </button>
              <button onclick="processAllPendingRewards()" id="processAllBtn" class="flex items-center gap-2 px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all font-semibold shadow-lg">
                <span>🚀</span> 一键发放全部
              </button>
            </div>
          </div>

          <!-- 统计卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">📋</div>
                <div>
                  <p class="text-sm text-slate-600">待发放总数</p>
                  <p id="pendingTotal" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">💵</div>
                <div>
                  <p class="text-sm text-slate-600">待发放总额</p>
                  <p id="pendingTotalAmount" class="text-2xl font-bold text-green-600">$0.00</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">⏳</div>
                <div>
                  <p class="text-sm text-slate-600">待处理</p>
                  <p id="pendingCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">❌</div>
                <div>
                  <p class="text-sm text-slate-600">失败</p>
                  <p id="failedCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 已发放统计 -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-200 rounded-lg flex items-center justify-center text-2xl">✅</div>
                <div>
                  <p class="text-sm text-green-700 font-medium">已成功发放（最近200条）</p>
                </div>
              </div>
              <div class="flex gap-6">
                <div class="text-right">
                  <p class="text-xs text-green-600">发放次数</p>
                  <p id="successCount" class="text-2xl font-bold text-green-700">0</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-green-600">发放金额</p>
                  <p id="successAmount" class="text-2xl font-bold text-green-700">$0.00</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 说明提示 -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <div class="text-2xl">ℹ️</div>
              <div class="flex-1">
                <h3 class="font-semibold text-blue-900 mb-2">关于待发放奖金</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                  <li>• <strong>自动发放</strong>：系统每 60 秒自动尝试发放一次待处理的奖金</li>
                  <li>• <strong>一键发放</strong>：管理员可以手动触发立即发放，作为自动发放失败时的补充</li>
                  <li>• <strong>重试机制</strong>：失败的记录可以重置状态，让系统重新尝试</li>
                  <li>• <strong>最大重试</strong>：每条记录最多重试 10 次，超过后标记为失败</li>
                  <li>• <strong>记录保留</strong>：所有记录包括成功的都保存在数据库中，显示最近200条</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- 奖金列表 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">奖金金额</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">原因</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">重试次数</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">创建时间</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="pendingRewardsTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 🚫 Banned Users Section -->
        <div id="bannedUsersSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🚫 封禁记录管理</h2>
            <button onclick="refreshBannedUsers()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>

          <!-- 统计卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">🚫</div>
                <div>
                  <p class="text-sm text-slate-600">当前封禁用户</p>
                  <p id="bannedUsersCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">⏱️</div>
                <div>
                  <p class="text-sm text-slate-600">临时封禁</p>
                  <p id="tempBannedCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl">🔒</div>
                <div>
                  <p class="text-sm text-slate-600">永久封禁</p>
                  <p id="permBannedCount" class="text-2xl font-bold text-gray-700">0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 说明提示 -->
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <div class="text-2xl">⚠️</div>
              <div class="flex-1">
                <h3 class="font-semibold text-amber-900 mb-2">关于封禁系统</h3>
                <ul class="text-sm text-amber-800 space-y-1">
                  <li>• <strong>临时封禁</strong>：触发3个及以上律师函自动封禁60小时（从最后一次触发算起）</li>
                  <li>• <strong>永久封禁</strong>：由管理员手动设置的永久封禁状态</li>
                  <li>• <strong>自动解封</strong>：临时封禁到期后系统会自动解封</li>
                  <li>• <strong>手动解封</strong>：管理员可以提前解除任何封禁</li>
                  <li>• <strong>封禁影响</strong>：被封禁用户无法进行任何抽奖操作</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- 封禁记录列表 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-red-50 to-orange-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户名</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">LinuxDo</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">封禁时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">解封时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">封禁原因</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">封禁类型</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="bannedUsersTableBody">
                  <tr>
                    <td colspan="9" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 🐔 Kunbei Management Section -->
        <div id="kunbeiManagementSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🐔 坤呗贷款管理</h2>
            <button onclick="refreshKunbeiData()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          
          <!-- 配置卡片 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">⚙️ 坤呗配置</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 启用状态 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">启用状态</label>
                <select id="kunbeiEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="1">✅ 启用</option>
                  <option value="0">❌ 禁用</option>
                </select>
              </div>
              
              <!-- 最大借款额度 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">最大借款额度</label>
                <input type="number" id="kunbeiMaxAmount" min="10" max="1000" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">单位：美元</p>
              </div>
              
              <!-- 还款倍数 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">还款倍数</label>
                <input type="number" id="kunbeiRepayMultiplier" min="1" max="10" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">例如：2.5表示还2.5倍</p>
              </div>
              
              <!-- 借款期限 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">借款期限</label>
                <input type="number" id="kunbeiDuration" min="0.5" max="720" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">单位：小时，支持小数（如2.5小时）</p>
              </div>
              
              <!-- 提前还款优惠 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">提前还款优惠</label>
                <input type="number" id="kunbeiEarlyDiscount" min="0" max="0.5" step="0.001" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">例如：0.025表示免除2.5%</p>
              </div>
              
              <!-- 逾期惩罚时长 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">逾期惩罚时长</label>
                <input type="number" id="kunbeiOverduePenalty" min="1" max="720" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">禁止高级场的小时数</p>
              </div>
              
              <!-- 逾期扣款倍数 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">逾期扣款倍数</label>
                <input type="number" id="kunbeiOverdueDeductMultiplier" min="1" max="10" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <p class="text-xs text-slate-500 mt-1">逾期时扣除欠款的倍数（如2.5倍）</p>
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button onclick="saveKunbeiConfig()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                💾 保存配置
              </button>
            </div>
          </div>
          
          <!-- 梯度配置卡片 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-900">📊 梯度额度配置</h3>
              <button onclick="showGradientConfigModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                ➕ 添加梯度
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-slate-200">
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">额度阈值</th>
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">最大可借金额</th>
                    <th class="text-left py-3 px-4 font-semibold text-slate-700">状态</th>
                    <th class="text-center py-3 px-4 font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="gradientConfigsTable">
                  <tr>
                    <td colspan="4" class="text-center py-8 text-slate-500">
                      <div class="text-4xl mb-2">📋</div>
                      <p>暂无梯度配置</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <p class="text-sm text-amber-800">
                <strong>💡 说明：</strong>系统自动根据用户额度匹配借款额度。用户额度低于所有阈值时，使用最小阈值的借款额度。
              </p>
              <p class="text-sm text-amber-800 mt-2">
                <strong>配置示例：</strong><br>
                • 阈值 $5000，可借 $10 - 额度 < $5000 的用户可借 $10<br>
                • 阈值 $100000，可借 $200 - 额度 ≥ $100000 的用户可借 $200<br>
                • 阈值 $1000000，可借 $400 - 额度 ≥ $1000000 的用户可借 $400
              </p>
              <p class="text-sm text-amber-700 mt-2">
                <strong>⚠️ 重要：</strong>系统会自动按阈值排序处理，无需设置优先级。
              </p>
            </div>
          </div>
          
          <!-- 逾期扣除配置说明 -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-bold text-orange-900 mb-4 flex items-center gap-2">
              <span class="text-2xl">⚡</span>
              逾期扣款规则说明
            </h3>
            
            <div class="space-y-3 text-sm">
              <div class="bg-white rounded-lg p-4 border border-orange-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">💡</span>
                  <div class="flex-1">
                    <p class="font-semibold text-orange-900 mb-2">扣款计算公式</p>
                    <p class="text-orange-800">
                      自动扣款金额 = 应还金额 × 逾期扣款倍数（默认2.5倍）
                    </p>
                    <p class="text-orange-700 mt-2">
                      <strong>示例：</strong>用户欠款 $400，逾期扣款倍数为 2.5<br>
                      → 自动扣款 = $400 × 2.5 = $1000
                    </p>
                  </div>
                </div>
              </div>
              
              <div class="bg-white rounded-lg p-4 border border-orange-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">🛡️</span>
                  <div class="flex-1">
                    <p class="font-semibold text-orange-900 mb-2">保护机制</p>
                    <ul class="text-orange-800 space-y-1">
                      <li>• 如果用户余额不足，只扣到 $0，不会扣为负数</li>
                      <li>• 如果用户余额为 $0，则不扣款</li>
                      <li>• 扣款记录会保存在借款记录的"自动扣款"列中</li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="bg-white rounded-lg p-4 border border-red-200">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">🔒</span>
                  <div class="flex-1">
                    <p class="font-semibold text-red-900 mb-2">逾期惩罚</p>
                    <ul class="text-red-800 space-y-1">
                      <li>• 逾期后禁止进入高级场（可在贷款记录中解封）</li>
                      <li>• 禁入时长由"逾期惩罚时长"配置决定</li>
                      <li>• 管理员可手动解封（点击"🔓 解封"按钮）</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 统计卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">⏳</div>
                <div>
                  <p class="text-sm text-slate-600">活跃借款</p>
                  <p id="kunbeiActiveCount" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">⚠️</div>
                <div>
                  <p class="text-sm text-slate-600">逾期借款</p>
                  <p id="kunbeiOverdueCount" class="text-2xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">💰</div>
                <div>
                  <p class="text-sm text-slate-600">总借出</p>
                  <p id="kunbeiTotalLoan" class="text-2xl font-bold text-blue-600">$0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">✅</div>
                <div>
                  <p class="text-sm text-slate-600">总回收</p>
                  <p id="kunbeiTotalRepaid" class="text-2xl font-bold text-green-600">$0</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 📋 Kunbei Records Section (独立的贷款记录管理) -->
        <div id="kunbeiRecordsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">📋 贷款记录管理</h2>
            <div class="flex gap-2">
              <button onclick="exportKunbeiRecords()" class="flex items-center gap-2 px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                导出记录
              </button>
              <button onclick="refreshKunbeiRecords()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                刷新
              </button>
            </div>
          </div>

          <!-- 搜索和筛选区域 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <!-- 搜索框 -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">搜索用户</label>
                <div class="relative">
                  <input type="text" id="kunbeiRecordSearch" 
                         placeholder="输入LinuxDo用户名或公益站用户名..." 
                         class="w-full px-4 py-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                         onkeyup="searchKunbeiRecords(event)">
                  <svg class="absolute left-3 top-2.5 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>

              <!-- 状态筛选 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">状态筛选</label>
                <select id="kunbeiStatusFilter" onchange="filterKunbeiRecords()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="">全部状态</option>
                  <option value="active">⏳ 借款中</option>
                  <option value="repaid">✅ 已还款</option>
                  <option value="overdue">⚠️ 已逾期</option>
                  <option value="forgiven">🤝 已免除</option>
                </select>
              </div>

              <!-- 时间范围 -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">时间范围</label>
                <select id="kunbeiTimeFilter" onchange="filterKunbeiRecords()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="">全部时间</option>
                  <option value="today">今天</option>
                  <option value="week">最近7天</option>
                  <option value="month">最近30天</option>
                  <option value="all">所有记录</option>
                </select>
              </div>
            </div>

            <!-- 批量操作 -->
            <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-200">
              <label class="flex items-center gap-2">
                <input type="checkbox" id="selectAllRecords" onchange="toggleAllRecords()" class="w-4 h-4 text-indigo-600 border-slate-300 rounded">
                <span class="text-sm text-slate-700">全选</span>
              </label>
              <span class="text-sm text-slate-500">已选择 <span id="selectedCount">0</span> 条记录</span>
              
              <div class="ml-auto flex gap-2">
                <button onclick="batchForgiveLoans()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors text-sm font-medium disabled:opacity-50" disabled id="batchForgiveBtn">
                  🤝 批量免除
                </button>
                <button onclick="batchSendReminders()" class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-lg transition-colors text-sm font-medium disabled:opacity-50" disabled id="batchReminderBtn">
                  📧 批量催收
                </button>
              </div>
            </div>
          </div>

          <!-- 统计概览 -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-xl">📊</div>
                <div>
                  <p class="text-xs text-slate-600">总记录数</p>
                  <p id="totalRecordsCount" class="text-xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center text-xl">⏳</div>
                <div>
                  <p class="text-xs text-slate-600">借款中</p>
                  <p id="activeLoansCount" class="text-xl font-bold text-yellow-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-xl">✅</div>
                <div>
                  <p class="text-xs text-slate-600">已还款</p>
                  <p id="repaidLoansCount" class="text-xl font-bold text-green-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-xl">⚠️</div>
                <div>
                  <p class="text-xs text-slate-600">已逾期</p>
                  <p id="overdueLoansCount" class="text-xl font-bold text-red-600">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-xl">💸</div>
                <div>
                  <p class="text-xs text-slate-600">总借出</p>
                  <p id="totalLoanedAmount" class="text-xl font-bold text-indigo-600">$0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-xl">💰</div>
                <div>
                  <p class="text-xs text-slate-600">总回收</p>
                  <p id="totalRepaidAmount" class="text-xl font-bold text-emerald-600">$0</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 记录列表 -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-center">
                      <input type="checkbox" id="selectAllHeader" onchange="toggleAllRecords()" class="w-4 h-4 text-indigo-600 border-slate-300 rounded">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">LinuxDo用户</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">公益站用户</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">借款金额</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">应还金额</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">自动扣款</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">借款时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">到期时间</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">状态</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="kunbeiRecordsTableBody">
                  <tr>
                    <td colspan="11" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- 分页 -->
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                显示第 <span id="recordsStart">0</span> - <span id="recordsEnd">0</span> 条，共 <span id="recordsTotal">0</span> 条记录
              </div>
              <div class="flex gap-2">
                <button onclick="changeRecordsPage(-1)" id="prevPageBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50" disabled>
                  上一页
                </button>
                <span class="px-4 py-2 text-sm">
                  第 <span id="currentPageNum">1</span> / <span id="totalPageNum">1</span> 页
                </span>
                <button onclick="changeRecordsPage(1)" id="nextPageBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50" disabled>
                  下一页
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ⚖️ Weight Configs Section -->
        <div id="weightConfigsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">⚖️ 符号权重配置管理</h2>
            <button onclick="showAddWeightConfigModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
              ➕ 添加新配置
            </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">配置名称</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">使用场次</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">描述</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="weightConfigsTableBody">
                  <tr>
                    <td colspan="5" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <p class="text-sm text-amber-800">
              <strong>💡 说明：</strong>权重配置方案可被初级场、高级场、至尊场引用。修改配置后，使用该配置的所有场次将立即生效。
            </p>
          </div>
        </div>

        <!-- 🎁 Reward Configs Section -->
        <div id="rewardConfigsSection" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-900">🎁 奖励配置管理</h2>
            <button onclick="showAddRewardSchemeModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
              ➕ 添加新方案
            </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ID</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">方案名称</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">规则数量</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">使用场次</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">描述</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">操作</th>
                  </tr>
                </thead>
                <tbody id="rewardSchemesTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <p class="text-sm text-amber-800">
              <strong>💡 说明：</strong>奖励配置方案包含多条中奖规则和律师函惩罚配置。修改方案后，使用该方案的所有场次将立即生效。
            </p>
          </div>
        </div>

        <!-- 💎 Supreme Slot Config Section -->
        <div id="supremeConfigSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">💎 至尊场配置</h2>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">⚙️ 基础配置</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">启用状态</label>
                <select id="supremeEnabled" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  <option value="1">✅ 启用</option>
                  <option value="0">❌ 禁用</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">合成所需碎片</label>
                <input type="number" id="supremeFragmentsToToken" min="1" max="100" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">令牌持有上限</label>
                <input type="number" id="supremeMaxTokens" min="1" max="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">投注范围（美元）</label>
                <div class="flex gap-2">
                  <input type="number" id="supremeMinBet" placeholder="最小" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                  <input type="number" id="supremeMaxBet" placeholder="最大" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">每日进入限制</label>
                <input type="number" id="supremeDailyEntry" min="1" max="10" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">每日投注限额（美元）</label>
                <input type="number" id="supremeDailyBetLimit" min="1000" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
              </div>
            </div>
            
            <div class="flex justify-end mt-4">
              <button onclick="saveSupremeConfig()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                💾 保存配置
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">⚖️ 符号权重方案</h3>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择权重方案</label>
              <select id="supremeWeightConfigId" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 可在"权重配置管理"中创建和编辑方案</p>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">🎁 奖励规则方案</h3>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">选择奖励方案</label>
              <select id="supremeRewardSchemeId" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                <option value="">加载中...</option>
              </select>
              <p class="text-xs text-slate-500 mt-2">💡 可在"奖励配置管理"中创建和编辑方案</p>
            </div>
          </div>
        </div>

        <!-- 💎 Supreme Slot Records Section -->
        <div id="supremeRecordsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">💎 至尊场记录</h2>
          
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-purple-50 to-gold-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">时间</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">用户</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">投注</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">赢得</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">倍率</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">中奖类型</th>
                  </tr>
                </thead>
                <tbody id="supremeRecordsTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-8 text-slate-500">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Grant Free Spins Modal -->
  <div id="grantFreeSpinsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">🎁 发放免费次数</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">用户</label>
          <input type="text" id="modalUsername" readonly class="w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700">
          <input type="hidden" id="modalLinuxDoId">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">免费次数 *</label>
          <input type="number" id="modalSpins" min="1" max="100" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">发放原因</label>
          <input type="text" id="modalReason" placeholder="例如: bug补偿" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmGrantFreeSpin()" class="flex-1 px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
          确认发放
        </button>
        <button onclick="closeGrantFreeSpinsModal()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
          取消
        </button>
      </div>
    </div>
  </div>

  <!-- 🎟️ Grant Tickets Modal -->
  <div id="grantTicketsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">🎟️ 发放入场券</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">用户</label>
          <input type="text" id="ticketModalUsername" readonly class="w-full px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700">
          <input type="hidden" id="ticketModalLinuxDoId">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">入场券数量 *</label>
          <input type="number" id="ticketModalCount" min="1" max="10" value="1" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <p class="text-xs text-slate-500 mt-1">每次最多发放10张</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">发放原因</label>
          <input type="text" id="ticketModalReason" placeholder="例如: 活动奖励" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-xs text-blue-800">
            💡 <strong>提示：</strong>入场券有效期24小时，用户最多持有2张（可在高级场配置中调整）
          </p>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmGrantTickets()" class="flex-1 px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
          确认发放
        </button>
        <button onclick="closeGrantTicketsModal()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
          取消
        </button>
      </div>
    </div>
  </div>

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600';
      toast.className = `toast px-6 py-4 rounded-xl ${bgColor} text-white min-w-[300px]`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-6 h-6 rounded-full ${type === 'success' ? 'bg-white/20' : 'bg-white/20'} flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
            </svg>
          </div>
          <span class="font-medium">${message}</span>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // 保留旧的 showMessage 函数用于兼容
    function showMessage(text, type) {
      showToast(text, type);
    }

    async function adminLogin() {
      const password = document.getElementById('password').value;
      if (!password) {
        showToast('请输入管理员密码', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          showToast('登录成功', 'success');
          await loadAdminData();
        } else {
          showToast(data.message || '密码错误', 'error');
        }
      } catch (e) {
        showToast('登录失败，请重试', 'error');
      }
    }

    async function loadAdminData() {
      await loadConfig();
      await loadClaimRecords();
      await loadDonateRecords();
      await loadKeysList();
      await loadUsersCount();
    }

    async function loadUsersCount() {
      try {
        const res = await fetch('/api/admin/users?page=1&pageSize=1');
        const data = await res.json();
        if (data.success) {
          document.getElementById('userCount').textContent = data.pagination.total;
        }
      } catch (e) {
        console.error('加载用户数失败', e);
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/admin/config');
        const data = await res.json();

        if (data.success) {
          const claimQuota = data.data.claim_quota;
          const usdValue = (claimQuota / 500000).toFixed(2);
          const maxDailyClaims = data.data.max_daily_claims || 1;
          const session = data.data.session || '';
          const newApiUser = data.data.new_api_user || '1';
          const keysApiUrl = data.data.keys_api_url || '';
          const keysAuthorization = data.data.keys_authorization || '';
          const modelscopeGroupId = data.data.modelscope_group_id || 26;
          const iflowGroupId = data.data.iflow_group_id || 26;
          const keysAuthConfigured = data.data.keys_authorization_configured;
          const updatedAt = data.data.updated_at;
          const maxDailyDonateModelscope = data.data.max_daily_donate_modelscope || 1;
          const maxDailyDonateIflow = data.data.max_daily_donate_iflow || 1;
          
          // 更新配置页面
          document.getElementById('claimQuotaUSD').value = usdValue;
          document.getElementById('currentQuota').textContent = '$' + usdValue;
          document.getElementById('quotaValue').textContent = claimQuota.toLocaleString();
          document.getElementById('maxDailyClaims').value = maxDailyClaims;
          
          // 显示当前 session
          document.getElementById('currentSession').textContent = session || '未配置';
          document.getElementById('currentSession').className = session 
            ? 'text-sm font-mono text-slate-700 break-all' 
            : 'text-sm font-mono text-slate-400 break-all';
          
          // 显示当前 new_api_user
          document.getElementById('currentNewApiUser').textContent = newApiUser;
          
          document.getElementById('keysApiUrl').value = keysApiUrl;
          document.getElementById('modelscopeGroupId').value = modelscopeGroupId;
          document.getElementById('iflowGroupId').value = iflowGroupId;
          document.getElementById('maxDailyDonateModelscope').value = maxDailyDonateModelscope;
          document.getElementById('maxDailyDonateIflow').value = maxDailyDonateIflow;
          
          // 更新仪表板配置卡片
          document.getElementById('dashboardQuota').textContent = '$' + usdValue;
          document.getElementById('dashboardQuotaUSD').textContent = claimQuota.toLocaleString();
          document.getElementById('dashboardMaxClaims').textContent = maxDailyClaims;
          document.getElementById('dashboardSessionStatus').textContent = session ? '已配置 ✓' : '未配置';
          document.getElementById('dashboardSessionStatus').className = session 
            ? 'text-lg font-bold text-green-600' 
            : 'text-lg font-bold text-orange-600';
          
          document.getElementById('dashboardNewApiUser').textContent = newApiUser;
          document.getElementById('dashboardKeysApi').textContent = keysApiUrl || '未配置';
          document.getElementById('dashboardKeysApi').title = keysApiUrl || '未配置';
          document.getElementById('dashboardGroupId').textContent = modelscopeGroupId;
          document.getElementById('dashboardIflowGroupId').textContent = iflowGroupId;
          document.getElementById('dashboardMaxDonateModelscope').textContent = maxDailyDonateModelscope;
          document.getElementById('dashboardMaxDonateIflow').textContent = maxDailyDonateIflow;
          
          // 显示 Keys Authorization（前20个字符）
          if (keysAuthorization) {
            const displayAuth = keysAuthorization.length > 20 
              ? keysAuthorization.substring(0, 20) + '...' 
              : keysAuthorization;
            document.getElementById('dashboardKeysAuth').textContent = displayAuth;
            document.getElementById('dashboardKeysAuth').title = keysAuthorization;
            document.getElementById('dashboardKeysAuthStatus').textContent = '已配置 ✓';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-green-600 mt-1 font-semibold';
          } else {
            document.getElementById('dashboardKeysAuth').textContent = '未配置';
            document.getElementById('dashboardKeysAuth').title = '';
            document.getElementById('dashboardKeysAuthStatus').textContent = '未配置';
            document.getElementById('dashboardKeysAuthStatus').className = 'text-xs text-orange-600 mt-1 font-semibold';
          }

          // 格式化更新时间
          if (updatedAt) {
            const date = new Date(updatedAt);
            document.getElementById('dashboardUpdatedAt').textContent = date.toLocaleString('zh-CN', { hour12: false });
          }
        }
      } catch (e) {
        console.error('加载配置失败', e);
      }
    }

    // 实时计算 quota 显示
    document.addEventListener('DOMContentLoaded', () => {
      const claimQuotaUSDInput = document.getElementById('claimQuotaUSD');
      if (claimQuotaUSDInput) {
        claimQuotaUSDInput.addEventListener('input', (e) => {
          const usd = parseFloat(e.target.value) || 0;
          const quota = Math.round(usd * 500000);
          const quotaEl = document.getElementById('quotaValue');
          if (quotaEl) {
            quotaEl.textContent = quota.toLocaleString();
          }
        });
      }
    });

    async function updateQuota() {
      const usd = parseFloat(document.getElementById('claimQuotaUSD').value);
      if (!usd || usd <= 0) {
        showMessage('请输入有效的美元金额', 'error');
        return;
      }
      const quota = Math.round(usd * 500000);
      try {
        const res = await fetch('/api/admin/config/quota', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ claim_quota: quota }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyClaims() {
      const maxClaims = parseInt(document.getElementById('maxDailyClaims').value);
      if (!maxClaims || maxClaims <= 0) {
        showMessage('请输入有效的领取次数', 'error');
        return;
      }
      if (maxClaims > 10) {
        showMessage('每日领取次数不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-claims', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_claims: maxClaims }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateSession() {
      const session = document.getElementById('sessionValue').value.trim();
      try {
        const res = await fetch('/api/admin/config/session', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('sessionValue').value = '';
          await loadConfig();  // 重新加载配置以刷新显示
        }
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateNewApiUser() {
      const new_api_user = document.getElementById('newApiUserValue').value.trim();
      if (!new_api_user) {
        showMessage('请输入 New-API-User 值', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/new-api-user', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_api_user }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          document.getElementById('newApiUserValue').value = '';
          await loadConfig();  // 重新加载配置以刷新显示
        }
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateKeysApiUrl() {
      const keys_api_url = document.getElementById('keysApiUrl').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-api-url', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_api_url }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateKeysAuthorization() {
      const keys_authorization = document.getElementById('keysAuthorization').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-authorization', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_authorization }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) document.getElementById('keysAuthorization').value = '';
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateModelscopeGroupId() {
      const modelscope_group_id = parseInt(document.getElementById('modelscopeGroupId').value);
      try {
        const res = await fetch('/api/admin/config/modelscope-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelscope_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateIflowGroupId() {
      const iflow_group_id = parseInt(document.getElementById('iflowGroupId').value);
      try {
        const res = await fetch('/api/admin/config/iflow-group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ iflow_group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyDonateModelscope() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateModelscope').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('请输入有效的投喂限制次数', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('ModelScope 每日投喂限制不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-modelscope', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_modelscope: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    async function updateMaxDailyDonateIflow() {
      const maxDonate = parseInt(document.getElementById('maxDailyDonateIflow').value);
      if (!maxDonate || maxDonate <= 0) {
        showMessage('请输入有效的投喂限制次数', 'error');
        return;
      }
      if (maxDonate > 10) {
        showMessage('iFlow 每日投喂限制不能超过10次', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-donate-iflow', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_donate_iflow: maxDonate }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('更新失败', 'error');
      }
    }

    // 刷新按钮包装函数
    async function refreshKeys() {
      const icon = document.getElementById('keysRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadKeysList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('Keys 列表已刷新', 'success');
      }, 600);
    }

    async function refreshClaims() {
      const icon = document.getElementById('claimsRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadClaimRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('领取记录已刷新', 'success');
      }, 600);
    }

    async function refreshDonates() {
      const icon = document.getElementById('donatesRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadDonateRecords(1);
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('投喂记录已刷新', 'success');
      }, 600);
    }

    async function refreshUsers() {
      const icon = document.getElementById('usersRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadUsersList();
      setTimeout(() => {
        icon.classList.remove('refresh-spin');
        showMessage('用户列表已刷新', 'success');
      }, 600);
    }

    async function loadKeysList() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          document.getElementById('totalKeysCount').textContent = data.data.length;
          const tbody = document.getElementById('keysListBody');

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">暂无Keys</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((item, index) => {
            const keyType = item.key_type || 'modelscope';
            const keyTypeTag = keyType === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>✨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>🎁</span><span>ModelScope</span></span>';
            
            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50" data-key="${item.key}" data-key-type="${keyType}">
                <td class="keysCheckboxCell hidden px-4 py-3 text-center align-middle">
                  <input type="checkbox" class="key-checkbox w-4 h-4 rounded border-slate-300" value="${item.key}" data-key-type="${keyType}" onchange="updateSelectedCount()">
                </td>
                <td class="px-4 py-3 font-mono text-xs align-middle break-all">${item.key}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 align-middle">${item.username || '-'}</td>
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(item.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="key-status-${index}">-</span>
                </td>
                <td class="px-4 py-3 text-center align-middle">
                  <button onclick="copyKey('${item.key}')" class="p-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors" title="复制 Key">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载Keys失败', e);
      }
    }

    // 复制单个 Key
    function copyKey(key) {
      navigator.clipboard.writeText(key).then(() => {
        showToast('Key 已复制', 'success');
      }).catch(() => {
        showToast('复制失败', 'error');
      });
    }

    // Keys 批量操作功能
    let keysBatchMode = false;

    function toggleKeysBatchMode() {
      keysBatchMode = !keysBatchMode;
      const btn = document.getElementById('keysBatchBtn');
      const batchActions = document.getElementById('keysBatchActions');
      const checkboxCells = document.querySelectorAll('.keysCheckboxCell');
      const checkboxHeader = document.getElementById('keysCheckboxHeader');
      
      if (keysBatchMode) {
        btn.textContent = '✓ 退出批量';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = '批量操作';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        // 清除所有选中
        document.querySelectorAll('.key-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
      }
    }

    function toggleSelectAllKeys() {
      const selectAll = document.getElementById('selectAllKeys');
      const selectAllHeader = document.getElementById('selectAllKeysHeader');
      const checkboxes = document.querySelectorAll('.key-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const selected = document.querySelectorAll('.key-checkbox:checked');
      document.getElementById('selectedKeysCount').textContent = selected.length;
    }

    function getSelectedKeys() {
      return Array.from(document.querySelectorAll('.key-checkbox:checked')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
    }

    async function deleteSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('请先选择要删除的 Keys', 'error');
        return;
      }
      
      if (!confirm(`确定要删除 ${selectedKeys.length} 个 Keys 吗？此操作不可恢复！`)) return;
      
      try {
        const res = await fetch('/api/admin/keys/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys: selectedKeys }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(data.message, 'success');
          await loadKeysList();
        } else {
          showMessage(data.message || '删除失败', 'error');
        }
      } catch (e) {
        showMessage('删除失败', 'error');
      }
    }

    async function testSelectedKeys() {
      const selectedKeys = getSelectedKeys();
      if (selectedKeys.length === 0) {
        showMessage('请先选择要测试的 Keys', 'error');
        return;
      }
      
      showMessage(`正在测试 ${selectedKeys.length} 个 Keys...`, 'success');
      await testKeys(selectedKeys);
    }

    async function testAllKeys() {
      const allKeys = Array.from(document.querySelectorAll('.key-checkbox')).map(cb => ({
        key: cb.value,
        key_type: cb.getAttribute('data-key-type') || 'modelscope'
      }));
      if (allKeys.length === 0) {
        showMessage('暂无 Keys 可测试', 'error');
        return;
      }
      
      if (!confirm(`确定要测试全部 ${allKeys.length} 个 Keys 吗？`)) return;
      
      showMessage(`正在测试全部 ${allKeys.length} 个 Keys...`, 'success');
      await testKeys(allKeys);
    }

    async function testKeys(keys) {
      let validCount = 0;
      let invalidCount = 0;
      
      // 一个接一个测试
      for (let index = 0; index < keys.length; index++) {
        const keyItem = keys[index];
        const statusSpan = document.querySelector(`.key-status-${index}`);
        
        if (statusSpan) {
          // 显示测试中状态
          statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span>测试中</span></span>';
        }
        
        try {
          // 单个测试
          const res = await fetch('/api/admin/keys/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keys: [keyItem] }),
          });
          const data = await res.json();
          
          if (statusSpan && data.success && data.data.length > 0) {
            const result = data.data[0];
            if (result.valid) {
              validCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg><span>成功</span></span>';
            } else {
              invalidCount++;
              statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>失败</span></span>';
            }
          }
        } catch (e) {
          if (statusSpan) {
            invalidCount++;
            statusSpan.innerHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg><span>失败</span></span>';
          }
        }
        
        // 添加小延迟，让动画更明显
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      showMessage(`测试完成：有效 ${validCount} 个，失效 ${invalidCount} 个`, 'success');
    }

    async function exportKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // 按渠道分类
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let exportContent = '';
          
          if (modelscopeKeys.length > 0) {
            exportContent += `=== ModelScope Keys (${modelscopeKeys.length}个) ===\n`;
            exportContent += modelscopeKeys.map(item => item.key).join('\n');
            exportContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            exportContent += `=== iFlow Keys (${iflowKeys.length}个) ===\n`;
            exportContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          const blob = new Blob([exportContent], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `donated-keys-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          showMessage(`成功导出 ${data.data.length} 个 Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('导出失败', 'error');
      }
    }

    async function copyAllKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          // 按渠道分类
          const modelscopeKeys = data.data.filter(item => !item.key_type || item.key_type === 'modelscope');
          const iflowKeys = data.data.filter(item => item.key_type === 'iflow');
          
          let copyContent = '';
          
          if (modelscopeKeys.length > 0) {
            copyContent += `=== ModelScope Keys (${modelscopeKeys.length}个) ===\n`;
            copyContent += modelscopeKeys.map(item => item.key).join('\n');
            copyContent += '\n\n';
          }
          
          if (iflowKeys.length > 0) {
            copyContent += `=== iFlow Keys (${iflowKeys.length}个) ===\n`;
            copyContent += iflowKeys.map(item => item.key).join('\n');
          }
          
          await navigator.clipboard.writeText(copyContent);
          showMessage(`成功复制 ${data.data.length} 个 Key (ModelScope: ${modelscopeKeys.length}, iFlow: ${iflowKeys.length})`, 'success');
        }
      } catch (e) {
        showMessage('复制失败', 'error');
      }
    }

    let claimCurrentPage = 1;
    let claimPageSize = 50;

    async function loadClaimRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/claim?page=${page}&pageSize=${claimPageSize}`);
        const data = await res.json();

        if (data.success) {
          claimCurrentPage = data.pagination.page;
          const tbody = document.getElementById('claimTableBody');

          // 更新统计信息
          document.getElementById('claimCount').textContent = data.pagination.total;
          document.getElementById('claimsTotal').textContent = data.pagination.total;
          document.getElementById('claimTotal').textContent = data.pagination.total;
          document.getElementById('claimCurrentPage').textContent = data.pagination.page;
          document.getElementById('claimTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('claimPrevBtn').disabled = page === 1;
          document.getElementById('claimNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderClaimPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const quotaUSD = (r.quota_added / 500000).toFixed(2);
            const isBindingBonus = r.quota_added === 50000000; // 绑定奖励是 $100
            
            const typeLabel = isBindingBonus 
              ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-semibold">🎁 绑定奖励</span>'
              : '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">📅 每日领取</span>';

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 font-semibold">${r.username}</td>
                <td class="px-4 py-3 font-mono text-xs">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${typeLabel}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">$${quotaUSD}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载领取记录失败', e);
      }
    }

    let donateCurrentPage = 1;
    let donatePageSize = 50;

    async function loadDonateRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/donate?page=${page}&pageSize=${donatePageSize}`);
        const data = await res.json();

        if (data.success) {
          donateCurrentPage = data.pagination.page;
          const tbody = document.getElementById('donateTableBody');

          // 更新统计信息
          document.getElementById('donateCount').textContent = data.pagination.total;
          document.getElementById('donatesTotal').textContent = data.pagination.total;
          document.getElementById('donateTotal').textContent = data.pagination.total;
          document.getElementById('donateCurrentPage').textContent = data.pagination.page;
          document.getElementById('donateTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('donatePrevBtn').disabled = page === 1;
          document.getElementById('donateNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderDonatePageNumbers(data.pagination.page, data.pagination.totalPages);

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">暂无数据</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const keyTypeTag = r.key_type === 'iflow'
              ? '<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>✨</span><span>iFlow</span></span>'
              : '<span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold whitespace-nowrap"><span>🎁</span><span>ModelScope</span></span>';

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 align-middle whitespace-nowrap">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3 align-middle">${r.username}</td>
                <td class="px-4 py-3 text-center align-middle">${keyTypeTag}</td>
                <td class="px-4 py-3 text-center align-middle">${r.keys_count}</td>
                <td class="px-4 py-3 text-right font-semibold align-middle">$${(r.total_quota_added / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center align-middle">
                  <span class="inline-block px-2 py-1 rounded text-xs ${r.push_status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${r.push_status === 'success' ? '✓ 成功' : '✕ 失败'}
                  </span>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载投喂记录失败', e);
      }
    }

    let usersCurrentPage = 1;
    let usersPageSize = 20;
    let usersAllData = [];  // 存储所有用户数据
    let usersSearchFilter = '';  // 搜索过滤条件

    async function loadUsersList(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/users?page=${page}&pageSize=${usersPageSize}`);
        const data = await res.json();

        if (data.success) {
          usersCurrentPage = data.pagination.page;
          const tbody = document.getElementById('usersListBody');
          
          // 🔥 存储所有用户数据
          usersAllData = data.data;
          
          // 🔥 应用搜索过滤
          let filteredUsers = usersAllData;
          if (usersSearchFilter) {
            filteredUsers = usersAllData.filter(user => 
              (user.linux_do_username && user.linux_do_username.toLowerCase().includes(usersSearchFilter.toLowerCase())) ||
              (user.username && user.username.toLowerCase().includes(usersSearchFilter.toLowerCase()))
            );
          }

          // 更新统计信息
          document.getElementById('userCount').textContent = data.pagination.total;
          document.getElementById('usersTotal').textContent = data.pagination.total;
          
          // 🔥 显示筛选信息
          if (usersSearchFilter && filteredUsers.length < usersAllData.length) {
            document.getElementById('usersFilteredInfo').classList.remove('hidden');
            document.getElementById('usersFilteredCount').textContent = filteredUsers.length;
          } else {
            document.getElementById('usersFilteredInfo').classList.add('hidden');
          }
          document.getElementById('usersCurrentPage').textContent = data.pagination.page;
          document.getElementById('usersTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('usersPrevBtn').disabled = page === 1;
          document.getElementById('usersNextBtn').disabled = !data.pagination.hasMore;

          // 生成页码
          renderUsersPageNumbers(data.pagination.page, data.pagination.totalPages);

          if (filteredUsers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-500">暂无用户</td></tr>';
            return;
          }

          tbody.innerHTML = filteredUsers.map((user, index) => {
            const globalIndex = (page - 1) * usersPageSize + index + 1;
            const isBanned = user.is_banned === 1;
            const statusHtml = isBanned 
              ? `<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">🚫 已封禁</span>` 
              : `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✓ 正常</span>`;
            
            const actionButtons = isBanned
              ? `<button onclick="unbanUser('${user.linux_do_id}', '${user.username}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold transition-colors">解封</button>`
              : `
                <div class="flex gap-1 justify-center flex-wrap">
                  <button onclick="showGrantFreeSpinsModal('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs font-semibold transition-colors" title="发放免费次数">🎁</button>
                  <button onclick="showGrantTicketsModal('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition-colors" title="发放入场券">🎟️</button>
                  <button onclick="banUser('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold transition-colors" title="封禁用户">🚫</button>
                  <button onclick="unbindUser('${user.linux_do_id}', '${user.username}')" class="px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-semibold transition-colors" title="解绑用户">🔓</button>
                </div>
              `;
            
            return `
              <tr class="border-b border-slate-100 ${isBanned ? 'bg-red-50' : 'hover:bg-slate-50'}">
                <td class="usersCheckboxCell hidden px-4 py-3 text-center">
                  <input type="checkbox" class="user-checkbox w-4 h-4 rounded border-slate-300" value="${user.linux_do_id}" data-username="${user.username}" onchange="updateSelectedUsersCount()">
                </td>
                <td class="px-4 py-3">${globalIndex}</td>
                <td class="px-4 py-3 font-semibold">${user.username}</td>
                <td class="px-4 py-3 font-mono text-xs">${user.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${user.donate_count}</td>
                <td class="px-4 py-3 text-center">${user.claim_count}</td>
                <td class="px-4 py-3 text-right font-semibold">$${(user.total_quota / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">${statusHtml}</td>
                <td class="px-4 py-3 text-center">${actionButtons}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载用户列表失败', e);
      }
    }

    function renderUsersPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('usersPageNumbers');
      const maxVisible = 5; // 最多显示5个页码
      let pages = [];

      if (totalPages <= maxVisible) {
        // 总页数少，显示全部
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        // 总页数多，智能显示
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadUsersList(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function renderClaimPageNumbers(currentPage, totalPages) {
      const container = document.getElementById('claimPageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadClaimRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeClaimsPageSize() {
      claimPageSize = parseInt(document.getElementById('claimsPageSize').value);
      loadClaimRecords(1);
    }

    function renderDonatePageNumbers(currentPage, totalPages) {
      const container = document.getElementById('donatePageNumbers');
      const maxVisible = 5;
      let pages = [];

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 3) {
          pages = [1, 2, 3, 4, 5];
        } else if (currentPage >= totalPages - 2) {
          pages = [totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pages = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        }
      }

      container.innerHTML = pages.map(p => `
        <button 
          onclick="loadDonateRecords(${p})" 
          class="px-3 py-1 rounded text-sm ${p === currentPage ? 'bg-indigo-600 text-white font-semibold' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}"
        >${p}</button>
      `).join('');
    }

    function changeDonatesPageSize() {
      donatePageSize = parseInt(document.getElementById('donatesPageSize').value);
      loadDonateRecords(1);
    }

    function changeUsersPageSize() {
      usersPageSize = parseInt(document.getElementById('usersPageSize').value);
      loadUsersList(1); // 重置到第一页
    }
    
    // 🔥 搜索用户
    function filterUsers() {
      usersSearchFilter = document.getElementById('usersSearchInput').value.trim();
      usersCurrentPage = 1;
      loadUsersList(1);
    }
    
    // 🔥 清除筛选
    function clearUsersFilter() {
      document.getElementById('usersSearchInput').value = '';
      usersSearchFilter = '';
      usersCurrentPage = 1;
      loadUsersList(1);
    }

    async function exportUsersData() {
      try {
        const link = document.createElement('a');
        link.href = '/api/admin/export/users';
        link.download = `users_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => showMessage('用户数据导出成功', 'success'), 500);
      } catch (e) {
        showMessage('导出失败', 'error');
      }
    }

    async function banUser(linuxDoId, username) {
      const reason = prompt(`确定要封禁用户 "${username}" 吗？\n\n请输入封禁原因（可选）：`, '违规行为');
      if (reason === null) return; // 用户取消
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/ban`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || '违规行为' }),
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 已被封禁`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '封禁失败', 'error');
        }
      } catch (e) {
        showMessage('封禁失败', 'error');
      }
    }

    async function unbanUser(linuxDoId, username) {
      if (!confirm(`确定要解封用户 "${username}" 吗？`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unban`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 已解封`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '解封失败', 'error');
        }
      } catch (e) {
        showMessage('解封失败', 'error');
      }
    }

    async function unbindUser(linuxDoId, username) {
      if (!confirm(`⚠️ 确定要解除用户 "${username}" 的绑定吗？\n\n此操作将：\n• 删除该用户的绑定信息\n• 清除所有相关记录\n• 用户需要重新绑定才能使用\n\n此操作不可恢复！`)) return;
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unbind`, {
          method: 'POST',
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage(`用户 "${username}" 的绑定已解除`, 'success');
          await loadUsersList(usersCurrentPage);
        } else {
          showMessage(data.message || '解绑失败', 'error');
        }
      } catch (e) {
        showMessage('解绑失败', 'error');
      }
    }

    // 用户列表批量操作功能
    let usersBatchMode = false;

    function toggleUsersBatchMode() {
      usersBatchMode = !usersBatchMode;
      const btn = document.getElementById('usersBatchBtn');
      const batchActions = document.getElementById('usersBatchActions');
      const checkboxCells = document.querySelectorAll('.usersCheckboxCell');
      const checkboxHeader = document.getElementById('usersCheckboxHeader');
      
      if (usersBatchMode) {
        btn.textContent = '✓ 退出批量';
        btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
        batchActions.classList.remove('hidden');
        checkboxHeader.classList.remove('hidden');
        checkboxCells.forEach(cell => cell.classList.remove('hidden'));
      } else {
        btn.textContent = '批量操作';
        btn.className = 'px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700';
        batchActions.classList.add('hidden');
        checkboxHeader.classList.add('hidden');
        checkboxCells.forEach(cell => cell.classList.add('hidden'));
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
        updateSelectedUsersCount();
      }
    }

    function toggleSelectAllUsers() {
      const selectAll = document.getElementById('selectAllUsers');
      const selectAllHeader = document.getElementById('selectAllUsersHeader');
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked || selectAllHeader.checked);
      if (selectAllHeader.checked) selectAll.checked = true;
      if (selectAll.checked) selectAllHeader.checked = true;
      updateSelectedUsersCount();
    }

    function updateSelectedUsersCount() {
      const selected = document.querySelectorAll('.user-checkbox:checked');
      document.getElementById('selectedUsersCount').textContent = selected.length;
    }

    function getSelectedUsers() {
      return Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => ({
        linuxDoId: cb.value,
        username: cb.dataset.username
      }));
    }

    async function batchBanUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('请先选择要封禁的用户', 'error');
        return;
      }
      
      const reason = prompt(`确定要批量封禁 ${selectedUsers.length} 个用户吗？\n\n请输入封禁原因：`, '违规行为');
      if (reason === null) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason }),
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`批量封禁完成：成功 ${successCount} 个，失败 ${failCount} 个`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    async function batchUnbindUsers() {
      const selectedUsers = getSelectedUsers();
      if (selectedUsers.length === 0) {
        showMessage('请先选择要解绑的用户', 'error');
        return;
      }
      
      if (!confirm(`⚠️ 确定要批量解绑 ${selectedUsers.length} 个用户吗？\n\n此操作不可恢复！`)) return;
      
      let successCount = 0;
      let failCount = 0;
      
      for (const user of selectedUsers) {
        try {
          const res = await fetch(`/api/admin/users/${user.linuxDoId}/unbind`, {
            method: 'POST',
          });
          const data = await res.json();
          if (data.success) successCount++;
          else failCount++;
        } catch (e) {
          failCount++;
        }
      }
      
      showMessage(`批量解绑完成：成功 ${successCount} 个，失败 ${failCount} 个`, 'success');
      await loadUsersList(usersCurrentPage);
    }

    function showSection(section) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        link.classList.add('text-slate-700');
      });
      event.target.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
      event.target.classList.remove('text-slate-700');

      ['dashboard', 'config', 'keys', 'claims', 'donates', 'slotRecords', 'advancedSlotRecords', 'slotConfig', 'advancedSlotConfig', 'ticketDropRecords', 'slotAnalytics', 'profitLeaderboard', 'lossLeaderboard', 'users', 'grantFreeSpins', 'pendingRewards', 'bannedUsers', 'kunbeiManagement', 'kunbeiRecords', 'weightConfigs', 'rewardConfigs', 'supremeConfig', 'supremeRecords'].forEach(s => {
        document.getElementById(s + 'Section').classList.add('hidden');
      });
      document.getElementById(section + 'Section').classList.remove('hidden');

      if (section === 'users') loadUsersList(1);
      if (section === 'slotRecords') loadSlotRecords(1);
      if (section === 'advancedSlotRecords') loadAdvancedSlotRecords(1);
      if (section === 'ticketDropRecords') loadTicketDropRecords(1);
      if (section === 'slotConfig') {
        loadSlotConfig();
        loadSymbolWeights();
        loadMultipliers();
      }
      if (section === 'advancedSlotConfig') {
        loadAdvancedSlotConfig();
        loadAdvancedSymbolWeights();  // 🔥 加载高级场权重
      }
      if (section === 'slotAnalytics') loadSlotAnalytics();
      if (section === 'profitLeaderboard') loadProfitLeaderboard();
      if (section === 'lossLeaderboard') loadLossLeaderboard();
      if (section === 'pendingRewards') loadPendingRewards();
      if (section === 'bannedUsers') loadBannedUsers();
      if (section === 'kunbeiManagement') loadKunbeiManagement();
      if (section === 'kunbeiRecords') loadKunbeiRecords();
      if (section === 'weightConfigs') loadWeightConfigs();
      if (section === 'rewardConfigs') loadRewardConfigs();
      if (section === 'supremeConfig') loadSupremeConfig();
      if (section === 'supremeRecords') loadSupremeRecords();
    }

    // 老虎机配置管理
    async function loadSlotConfig() {
      try {
        const res = await fetch('/api/admin/slot/config');
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          // 将聪转换为美元显示
          const betAmountUSD = (config.bet_amount / 500000).toFixed(2);
          const minQuotaUSD = (config.min_quota_required / 500000).toFixed(2);
          const buySpinsPriceUSD = ((config.buy_spins_price || 20000000) / 500000).toFixed(2);

          document.getElementById('slotBetAmountUSD').value = betAmountUSD;
          document.getElementById('slotMaxDailySpins').value = config.max_daily_spins;
          document.getElementById('slotMinQuotaUSD').value = minQuotaUSD;
          document.getElementById('slotEnabled').value = config.enabled;
          document.getElementById('slotBackgroundType').value = config.background_type || 'default';

          // 购买次数配置
          document.getElementById('buySpinsEnabled').value = config.buy_spins_enabled || 0;
          document.getElementById('buySpinsPriceUSD').value = buySpinsPriceUSD;
          document.getElementById('maxDailyBuySpins').value = config.max_daily_buy_spins || 5;

          // 更新显示
          document.getElementById('slotBetAmountDisplay').textContent = betAmountUSD;
          document.getElementById('slotMinQuotaDisplay').textContent = minQuotaUSD;
          document.getElementById('buySpinsPriceDisplay').textContent = buySpinsPriceUSD;
        }
        
        // 加载权重配置方案列表
        await loadNormalWeightConfigOptions();
        // 加载奖励配置方案列表  
        await loadNormalRewardSchemeOptions();
      } catch (error) {
        console.error('加载老虎机配置失败:', error);
        showMessage('加载配置失败', 'error');
      }
    }
    
    //加载初级场权重配置方案选项
    async function loadNormalWeightConfigOptions() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('normalSlotWeightConfigId');
          select.innerHTML = data.data.map(w => 
            `<option value="${w.id}">${w.config_name}${w.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
          
          // 获取当前配置
          const configRes = await fetch('/api/admin/slot/config');
          const configData = await configRes.json();
          if (configData.success && configData.data.weight_config_id) {
            select.value = configData.data.weight_config_id;
            previewNormalWeightConfig();
          }
        }
      } catch (error) {
        console.error('加载权重配置方案失败:', error);
      }
    }
    
    // 加载初级场奖励配置方案选项
    async function loadNormalRewardSchemeOptions() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('normalSlotRewardSchemeId');
          select.innerHTML = data.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}${s.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
          
          // 获取当前配置
          const configRes = await fetch('/api/admin/slot/config');
          const configData = await configRes.json();
          if (configData.success && configData.data.reward_scheme_id) {
            select.value = configData.data.reward_scheme_id;
            previewNormalRewardScheme();
          }
        }
      } catch (error) {
        console.error('加载奖励配置方案失败:', error);
      }
    }
    
    // 预览初级场权重配置
    async function previewNormalWeightConfig() {
      const configId = document.getElementById('normalSlotWeightConfigId').value;
      if (!configId) return;
      
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.find(c => c.id == configId);
          if (config) {
            document.getElementById('preview_weight_m').textContent = config.weight_m;
            document.getElementById('preview_weight_t').textContent = config.weight_t;
            document.getElementById('preview_weight_n').textContent = config.weight_n;
            document.getElementById('preview_weight_j').textContent = config.weight_j;
            document.getElementById('preview_weight_lq').textContent = config.weight_lq;
            document.getElementById('preview_weight_bj').textContent = config.weight_bj;
            document.getElementById('preview_weight_zft').textContent = config.weight_zft;
            document.getElementById('preview_weight_bdk').textContent = config.weight_bdk;
            document.getElementById('preview_weight_lsh').textContent = config.weight_lsh;
            document.getElementById('normalWeightPreview').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('预览权重配置失败:', error);
      }
    }
    
    // 预览初级场奖励配置
    async function previewNormalRewardScheme() {
      const schemeId = document.getElementById('normalSlotRewardSchemeId').value;
      if (!schemeId) return;
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (data.success) {
          const rules = data.data.rules || [];
          const previewList = document.getElementById('normalRewardPreviewList');
          
          if (rules.length === 0) {
            previewList.innerHTML = '<div class="text-slate-500 text-center py-2">暂无规则</div>';
          } else {
            previewList.innerHTML = rules.map(rule => `
              <div class="flex justify-between items-center bg-white p-2 rounded border">
                <span class="font-semibold text-slate-900">${rule.rule_name}</span>
                <span class="text-green-600 font-bold">${rule.win_multiplier}x</span>
              </div>
            `).join('');
          }
          document.getElementById('normalRewardPreview').classList.remove('hidden');
        }
      } catch (error) {
        console.error('预览奖励方案失败:', error);
      }
    }
    
    // 保存初级场配置方案选择
    async function saveNormalSlotConfigSchemes() {
      const weightConfigId = document.getElementById('normalSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('normalSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        showToast('请选择权重配置方案和奖励配置方案', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/slot/config/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId)
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('✅ 初级场配置方案已保存并生效', 'success');
          // 🔥 重新加载配置以刷新下拉框显示
          await loadNormalWeightConfigOptions();
          await loadNormalRewardSchemeOptions();
        } else {
          showToast(data.message || '保存失败', 'error');
        }
      } catch (error) {
        console.error('保存初级场配置方案失败:', error);
        showToast('保存失败', 'error');
      }
    }

    async function updateSlotConfig() {
      try {
        const betAmountUSD = parseFloat(document.getElementById('slotBetAmountUSD').value);
        const maxDailySpins = parseInt(document.getElementById('slotMaxDailySpins').value);
        const minQuotaUSD = parseFloat(document.getElementById('slotMinQuotaUSD').value);
        const enabled = parseInt(document.getElementById('slotEnabled').value);
        const backgroundType = document.getElementById('slotBackgroundType').value;

        // 购买次数配置
        const buySpinsEnabled = parseInt(document.getElementById('buySpinsEnabled').value);
        const buySpinsPriceUSD = parseFloat(document.getElementById('buySpinsPriceUSD').value);
        const maxDailyBuySpins = parseInt(document.getElementById('maxDailyBuySpins').value);

        if (isNaN(betAmountUSD) || betAmountUSD < 0) {
          showMessage('请输入有效的投注金额', 'error');
          return;
        }
        if (isNaN(maxDailySpins) || maxDailySpins < 0) {
          showMessage('请输入有效的每日次数', 'error');
          return;
        }
        if (isNaN(minQuotaUSD) || minQuotaUSD < 0) {
          showMessage('请输入有效的最低额度', 'error');
          return;
        }
        if (isNaN(buySpinsPriceUSD) || buySpinsPriceUSD < 0) {
          showMessage('请输入有效的购买价格', 'error');
          return;
        }
        if (isNaN(maxDailyBuySpins) || maxDailyBuySpins < 0) {
          showMessage('请输入有效的每日最大购买次数', 'error');
          return;
        }

        // 将美元转换为聪
        const betAmount = Math.floor(betAmountUSD * 500000);
        const minQuota = Math.floor(minQuotaUSD * 500000);
        const buySpinsPrice = Math.floor(buySpinsPriceUSD * 500000);

        const res = await fetch('/api/admin/slot/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bet_amount: betAmount,
            max_daily_spins: maxDailySpins,
            min_quota_required: minQuota,
            enabled: enabled,
            background_type: backgroundType,
            buy_spins_enabled: buySpinsEnabled,
            buy_spins_price: buySpinsPrice,
            max_daily_buy_spins: maxDailyBuySpins
          })
        });

        const data = await res.json();

        if (data.success) {
          showMessage('配置已更新', 'success');
          loadSlotConfig();
        } else {
          showMessage(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新配置失败:', error);
        showMessage('更新失败', 'error');
      }
    }

    // 老虎机记录管理
    let slotCurrentPage = 1;
    let slotPageSize = 50;

    // 全局变量：存储所有记录用于筛选
    let allAdminSlotRecords = [];
    let filteredAdminSlotRecords = [];
    let allRecordsLoaded = false;
    
    async function loadSlotRecords(page = 1) {
      if (page < 1) return;
      
      // 第一次加载时，获取所有记录（用于筛选）
      if (!allRecordsLoaded) {
        try {
          // 🔥 修复：使用正确的API路径加载所有记录
          const recordsRes = await fetch('/api/admin/records/slot?page=1&pageSize=1000');
          const recordsData = await recordsRes.json();
          if (recordsData.success && recordsData.data) {
            allAdminSlotRecords = recordsData.data;
            filteredAdminSlotRecords = allAdminSlotRecords;
            allRecordsLoaded = true;
          }
        } catch (e) {
          console.error('获取所有记录失败，将使用分页模式:', e);
        }
      }
      
      try {
        const res = await fetch(`/api/admin/records/slot?page=${page}&pageSize=${slotPageSize}`);
        const data = await res.json();

        if (data.success) {
          slotCurrentPage = data.pagination.page;
          
          const tbody = document.getElementById('slotTableBody');

          // 更新统计信息
          document.getElementById('slotTotal').textContent = data.pagination.total;
          document.getElementById('slotFiltered').textContent = filteredAdminSlotRecords.length;
          document.getElementById('slotCurrentPage').textContent = data.pagination.page;
          document.getElementById('slotTotalPages').textContent = data.pagination.totalPages;

          // 更新按钮状态
          document.getElementById('slotPrevBtn').disabled = data.pagination.page <= 1;
          document.getElementById('slotNextBtn').disabled = data.pagination.page >= data.pagination.totalPages;

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">暂无记录</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => {
            const symbols = JSON.parse(r.result_symbols);
            const symbolsHTML = symbols.map(s => {
              const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
              return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-8 h-8 inline-block border border-slate-300 rounded mr-1">`;
            }).join('');
            
            const winClass = r.win_amount > 0 ? 'text-green-600' : 'text-slate-500';
            const typeClass = r.is_free_spin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
            const typeLabel = r.is_free_spin ? '免费' : '普通';

            const winTypeLabels = {
              'super_jackpot': '🏆 超级大奖',
              'special_combo': '💎 特殊组合',
              'quad': '🎰 四连',
              'triple': '✨ 三连',
              'double': '🎁 双连',
              'punishment': '⚡ 惩罚',
              'none': '❌ 未中奖'
            };
            
            // 优先显示 LinuxDo 用户名，如果没有则显示公益站用户名
            const displayName = r.linux_do_username || r.username;
            const hasLinuxDoUsername = r.linux_do_username && r.linux_do_username !== r.username;

            return `
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="px-4 py-3 text-sm">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
                <td class="px-4 py-3">
                  <div class="font-semibold text-indigo-600">@${displayName}</div>
                  ${hasLinuxDoUsername ? `<div class="text-xs text-slate-500">公益站: ${r.username}</div>` : ''}
                </td>
                <td class="px-4 py-3 font-mono text-xs text-slate-600">${r.linux_do_id}</td>
                <td class="px-4 py-3 text-center">${symbolsHTML}</td>
                <td class="px-4 py-3 text-center text-sm font-semibold">${winTypeLabels[r.win_type] || r.win_type}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">${r.win_multiplier}x</td>
                <td class="px-4 py-3 text-right font-semibold">$${(r.bet_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-bold ${winClass}">$${(r.win_amount / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 ${typeClass} rounded-full text-xs font-semibold">${typeLabel}</span>
                  ${r.free_spin_awarded ? '<span class="ml-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">+1🎁</span>' : ''}
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('加载老虎机记录失败', e);
      }
    }

    async function refreshSlotRecords() {
      const icon = document.getElementById('slotRefreshIcon');
      icon.classList.add('animate-spin');
      
      try {
        // 🔥 修复：重新加载所有数据
        allRecordsLoaded = false;  // 强制重新加载
        await loadSlotRecords(1);  // 从第一页开始
        showToast('记录已刷新', 'success');
      } catch (error) {
        console.error('刷新失败:', error);
        showToast('刷新失败', 'error');
      }
      
      setTimeout(() => icon.classList.remove('animate-spin'), 500);
    }

    function changeSlotPageSize() {
      slotPageSize = parseInt(document.getElementById('slotPageSize').value);
      loadSlotRecords(1);
    }

    // Admin记录筛选功能
    function filterAdminSlotRecords() {
      const searchInput = document.getElementById('adminRecordSearchInput').value.trim().toLowerCase();
      const winTypeFilter = document.getElementById('adminWinTypeFilter').value;
      
      let filtered = allAdminSlotRecords;
      
      // 🔥 按用户名筛选（留空则显示所有）
      if (searchInput) {
        filtered = filtered.filter(r => {
          const linuxDoUsername = (r.linux_do_username || '').toLowerCase();
          const kyxUsername = (r.username || '').toLowerCase();
          return linuxDoUsername.includes(searchInput) || kyxUsername.includes(searchInput);
        });
      }
      // 如果searchInput为空，不过滤，显示所有记录
      
      // 按中奖类型筛选（修复：空字符串也要过滤）
      if (winTypeFilter && winTypeFilter !== 'all') {
        filtered = filtered.filter(r => {
          const recordWinType = r.win_type || '';
          return recordWinType === winTypeFilter;
        });
      }
      
      filteredAdminSlotRecords = filtered;
      
      // 调试：输出win_type分布
      if (winTypeFilter && winTypeFilter !== 'all') {
        console.log('[筛选调试] 筛选类型:', winTypeFilter);
        console.log('[筛选调试] 符合条件的记录数:', filtered.length);
        console.log('[筛选调试] 前5条记录:', filtered.slice(0, 5).map(r => ({
          win_type: r.win_type,
          username: r.linux_do_username || r.username
        })));
      }
      
      // 🔥 显示筛选结果提示（优化）
      const hintEl = document.getElementById('adminFilterResultHint');
      if (hintEl) {
        let hintText = '';
        if (searchInput || winTypeFilter !== 'all') {
          hintText = `🔍 筛选到 ${filtered.length} 条记录（共 ${allAdminSlotRecords.length} 条）`;
          if (searchInput) hintText += ` - 用户: "${document.getElementById('adminRecordSearchInput').value}"`;
          if (winTypeFilter !== 'all') hintText += ` - 类型: ${winTypeFilter}`;
        } else {
          hintText = `📊 显示全部 ${allAdminSlotRecords.length} 条记录`;
        }
        hintEl.textContent = hintText;
        hintEl.classList.remove('hidden');
      }
      
      // 更新筛选结果数量显示
      document.getElementById('slotFiltered').textContent = filtered.length;
      
      // 重新渲染当前页的数据
      renderFilteredSlotRecords(1);
    }

    // 刷新记录（保留筛选条件）
    async function refreshAdminSlotRecords() {
      try {
        // 🔥 重新加载所有初级场记录（修复：正确的API路径）
        const recordsRes = await fetch('/api/admin/records/slot?page=1&pageSize=1000');
        const recordsData = await recordsRes.json();
        
        if (recordsData.success) {
          allAdminSlotRecords = recordsData.data;
          allRecordsLoaded = true;
          
          // 应用筛选条件
          filterAdminSlotRecords();
          
          showToast('记录已刷新', 'success');
        } else {
          showToast('加载失败：' + (recordsData.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('刷新记录失败:', error);
        showToast('刷新失败：' + error.message, 'error');
      }
    }

    // 渲染筛选后的记录
    function renderFilteredSlotRecords(page = 1) {
      const tbody = document.getElementById('slotTableBody');
      const pageSize = slotPageSize;
      const startIdx = (page - 1) * pageSize;
      const endIdx = startIdx + pageSize;
      const pageData = filteredAdminSlotRecords.slice(startIdx, endIdx);
      
      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">无符合条件的记录</td></tr>';
        return;
      }
      
      const winTypeLabels = {
        'super_jackpot': '🏆 超级大奖',
        'special_combo': '💎 特殊组合',
        'quad': '🎰 四连',
        'triple': '✨ 三连',
        'double': '🎁 双连',
        'punishment': '⚡ 惩罚',
        'none': '❌ 未中奖'
      };
      
      tbody.innerHTML = pageData.map(r => {
        const symbols = JSON.parse(r.result_symbols);
        const symbolsHTML = symbols.map(s => {
          const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
          return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-8 h-8 inline-block border border-slate-300 rounded mr-1">`;
        }).join('');
        
        const winClass = r.win_amount > 0 ? 'text-green-600' : 'text-slate-500';
        const typeClass = r.is_free_spin ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
        const typeLabel = r.is_free_spin ? '免费' : '普通';
        
        const displayName = r.linux_do_username || r.username;
        const hasLinuxDoUsername = r.linux_do_username && r.linux_do_username !== r.username;

        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 text-sm">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</td>
            <td class="px-4 py-3">
              <div class="font-semibold text-indigo-600">@${displayName}</div>
              ${hasLinuxDoUsername ? `<div class="text-xs text-slate-500">公益站: ${r.username}</div>` : ''}
            </td>
            <td class="px-4 py-3 font-mono text-xs text-slate-600">${r.linux_do_id}</td>
            <td class="px-4 py-3 text-center">${symbolsHTML}</td>
            <td class="px-4 py-3 text-center text-sm font-semibold">${winTypeLabels[r.win_type] || r.win_type}</td>
            <td class="px-4 py-3 text-right font-bold ${winClass}">${r.win_multiplier}x</td>
            <td class="px-4 py-3 text-right font-semibold">$${(r.bet_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-bold ${winClass}">$${(r.win_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 ${typeClass} rounded-full text-xs font-semibold">${typeLabel}</span>
              ${r.free_spin_awarded ? '<span class="ml-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">+1🎁</span>' : ''}
            </td>
          </tr>
        `;
      }).join('');
      
      // 更新分页信息
      const totalPages = Math.ceil(filteredAdminSlotRecords.length / pageSize);
      document.getElementById('slotCurrentPage').textContent = page;
      document.getElementById('slotTotalPages').textContent = totalPages;
      slotCurrentPage = page;
      
      // 更新按钮状态
      document.getElementById('slotPrevBtn').disabled = page <= 1;
      document.getElementById('slotNextBtn').disabled = page >= totalPages;
    }

    // 清除admin记录筛选
    function clearAdminRecordFilters() {
      document.getElementById('adminRecordSearchInput').value = '';
      document.getElementById('adminWinTypeFilter').value = 'all';
      
      // 🔥 重新加载所有记录并显示
      filteredAdminSlotRecords = allAdminSlotRecords;
      document.getElementById('slotFiltered').textContent = filteredAdminSlotRecords.length;
      
      // 显示总记录数
      const hintEl = document.getElementById('adminFilterResultHint');
      if (hintEl) {
        hintEl.textContent = `📊 已显示全部 ${allAdminSlotRecords.length} 条记录`;
        hintEl.classList.remove('hidden');
      }
      
      renderFilteredSlotRecords(1);
    }

    // 符号权重配置管理
    async function loadSymbolWeights() {
      try {
        const res = await fetch('/api/admin/slot/weights');
        const data = await res.json();

        if (data.success) {
          const weights = data.data;
          
          // 填充表单
          document.getElementById('weight_m').value = weights.weight_m;
          document.getElementById('weight_t').value = weights.weight_t;
          document.getElementById('weight_n').value = weights.weight_n;
          document.getElementById('weight_j').value = weights.weight_j;
          document.getElementById('weight_lq').value = weights.weight_lq;
          document.getElementById('weight_bj').value = weights.weight_bj;
          document.getElementById('weight_zft').value = weights.weight_zft;
          document.getElementById('weight_bdk').value = weights.weight_bdk;
          document.getElementById('weight_lsh').value = weights.weight_lsh;
          
          // 自动计算概率
          calculateProbabilities();
        }
      } catch (error) {
        console.error('加载符号权重失败:', error);
        showMessage('加载符号权重失败', 'error');
      }
    }

    async function updateSymbolWeights() {
      try {
        const weights = {
          weight_m: parseInt(document.getElementById('weight_m').value),
          weight_t: parseInt(document.getElementById('weight_t').value),
          weight_n: parseInt(document.getElementById('weight_n').value),
          weight_j: parseInt(document.getElementById('weight_j').value),
          weight_lq: parseInt(document.getElementById('weight_lq').value),
          weight_bj: parseInt(document.getElementById('weight_bj').value),
          weight_zft: parseInt(document.getElementById('weight_zft').value),
          weight_bdk: parseInt(document.getElementById('weight_bdk').value),
          weight_lsh: parseInt(document.getElementById('weight_lsh').value)
        };

        // 验证所有权重
        for (const [key, value] of Object.entries(weights)) {
          if (isNaN(value) || value < 1 || value > 1000) {
            showMessage(`${key} 权重必须是1-1000之间的整数`, 'error');
            return;
          }
        }

        const res = await fetch('/api/admin/slot/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weights)
        });

        const data = await res.json();

        if (data.success) {
          showMessage('符号权重已更新，已立即生效', 'success');
          loadSymbolWeights();
        } else {
          showMessage(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新符号权重失败:', error);
        showMessage('更新失败', 'error');
      }
    }

    function calculateProbabilities() {
      const symbols = ['m', 't', 'n', 'j', 'lq', 'bj', 'zft', 'bdk', 'lsh'];
      const weights = {};
      let totalWeight = 0;

      // 获取所有权重值
      symbols.forEach(symbol => {
        const value = parseInt(document.getElementById('weight_' + symbol).value) || 0;
        weights[symbol] = value;
        totalWeight += value;
      });

      // 更新总权重显示
      document.getElementById('totalWeight').textContent = totalWeight.toLocaleString();

      // 计算并显示每个符号的概率
      symbols.forEach(symbol => {
        const weight = weights[symbol];
        const probability = totalWeight > 0 ? (weight / totalWeight * 100).toFixed(2) : '0.00';
        document.getElementById('prob_' + symbol).textContent = `概率: ${probability}%`;
        
        // 为律师函额外计算4个位置至少出现1次的概率
        if (symbol === 'lsh') {
          const singleProb = weight / totalWeight;
          const atLeastOnce = (1 - Math.pow(1 - singleProb, 4)) * 100;
          document.getElementById('prob_lsh_appear').textContent = `4个位置至少出现1次: ${atLeastOnce.toFixed(2)}%`;
        }
      });
    }

    function resetToDefault() {
      if (!confirm('确定要恢复默认权重配置吗？\n\n默认配置：\n普通符号(m,t,n,j,lq,bj,zft,bdk): 100\n律师函(lsh): 25')) {
        return;
      }

      // 设置默认值
      document.getElementById('weight_m').value = 100;
      document.getElementById('weight_t').value = 100;
      document.getElementById('weight_n').value = 100;
      document.getElementById('weight_j').value = 100;
      document.getElementById('weight_lq').value = 100;
      document.getElementById('weight_bj').value = 100;
      document.getElementById('weight_zft').value = 100;
      document.getElementById('weight_bdk').value = 100;
      document.getElementById('weight_lsh').value = 25;

      // 计算概率
      calculateProbabilities();
    }

    // 奖励倍数配置管理
    async function loadMultipliers() {
      try {
        const res = await fetch('/api/admin/slot/multipliers');
        const data = await res.json();

        if (data.success) {
          const multipliers = data.data;

          // 填充表单
          document.getElementById('super_jackpot_multiplier').value = multipliers.super_jackpot_multiplier;
          document.getElementById('special_combo_multiplier').value = multipliers.special_combo_multiplier;
          document.getElementById('quad_multiplier').value = multipliers.quad_multiplier;
          document.getElementById('triple_multiplier').value = multipliers.triple_multiplier;
          document.getElementById('double_multiplier').value = multipliers.double_multiplier;
        }
      } catch (error) {
        console.error('加载奖励倍数失败:', error);
        showMessage('加载奖励倍数失败', 'error');
      }
    }

    async function saveMultipliers() {
      try {
        const multipliers = {
          super_jackpot_multiplier: parseInt(document.getElementById('super_jackpot_multiplier').value),
          special_combo_multiplier: parseInt(document.getElementById('special_combo_multiplier').value),
          quad_multiplier: parseInt(document.getElementById('quad_multiplier').value),
          triple_multiplier: parseInt(document.getElementById('triple_multiplier').value),
          double_multiplier: parseInt(document.getElementById('double_multiplier').value)
        };

        // 验证所有倍数
        for (const [key, value] of Object.entries(multipliers)) {
          if (isNaN(value) || value < 1 || value > 10000) {
            showMessage(`倍数必须是1-10000之间的整数`, 'error');
            return;
          }
        }

        const res = await fetch('/api/admin/slot/multipliers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(multipliers)
        });

        const data = await res.json();

        if (data.success) {
          showMessage('奖励倍数已更新，已立即生效', 'success');
          loadMultipliers();
        } else {
          showMessage(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新奖励倍数失败:', error);
        showMessage('更新失败', 'error');
      }
    }

    // 老虎机抽奖分析
    async function loadSlotAnalytics() {
      try {
        // 🔥 获取筛选参数
        const recordCount = document.getElementById('analyticsRecordCount')?.value || '500';
        const slotMode = document.getElementById('analyticsSlotMode')?.value || 'all';
        
        const res = await fetch(`/api/admin/slot/analytics?limit=${recordCount}&mode=${slotMode}`);
        const data = await res.json();

        if (!data.success) {
          showMessage('加载分析数据失败', 'error');
          return;
        }

        const analytics = data.data;
        const summary = analytics.summary;
        const winTypes = analytics.winTypes;
        const dailyStats = analytics.dailyStats;
        const userStats = analytics.userStats;
        const filters = analytics.filters || {};

        // 🔥 显示当前筛选条件
        const modeText = filters.mode === 'normal' ? '初级场' : 
                        filters.mode === 'advanced' ? '高级场' : '全部模式';
        console.log(`[抽奖分析] 正在分析: ${modeText} - 最近${filters.limit}条记录`);

        // 更新概览统计
        document.getElementById('analyticsTotal').textContent = summary.totalCount.toLocaleString();
        document.getElementById('analyticsWinRate').textContent = summary.winRate.toFixed(1) + '%';
        document.getElementById('analyticsWinCount').textContent = summary.winCount.toLocaleString();
        document.getElementById('analyticsTotalBet').textContent = '$' + (summary.totalBet / 500000).toFixed(2);
        document.getElementById('analyticsTotalWin').textContent = '$' + (summary.totalWin / 500000).toFixed(2);
        
        const netProfit = summary.netProfit;
        const netProfitElement = document.getElementById('analyticsNetProfit');
        netProfitElement.textContent = (netProfit >= 0 ? '+' : '') + '$' + (netProfit / 500000).toFixed(2);
        netProfitElement.className = netProfit >= 0 
          ? 'text-3xl font-bold text-green-600' 
          : 'text-3xl font-bold text-red-600';

        // 🔥 计算并显示RTP数据
        const overallRTP = summary.totalBet > 0 ? ((summary.totalWin / summary.totalBet) * 100).toFixed(2) : '0.00';
        document.getElementById('analyticsRTP').textContent = overallRTP + '%';
        
        // RTP详细分析
        document.getElementById('rtpOverall').textContent = overallRTP + '%';
        document.getElementById('rtpTotalBet').textContent = '$' + (summary.totalBet / 500000).toFixed(2);
        document.getElementById('rtpTotalWin').textContent = '$' + (summary.totalWin / 500000).toFixed(2);
        
        // 🔥 计算中奖游戏RTP
        const winGames = Object.entries(winTypes)
          .filter(([key]) => key !== 'none' && key !== 'punishment')
          .reduce((sum, [key, data]) => sum + data.count, 0);
        
        const winGamesBet = Object.entries(winTypes)
          .filter(([key]) => key !== 'none' && key !== 'punishment')
          .reduce((sum, [key, data]) => {
            // 假设平均投注为总投注/总次数
            const avgBet = summary.totalBet / summary.totalCount;
            return sum + (data.count * avgBet);
          }, 0);
        
        const winGamesWin = Object.entries(winTypes)
          .filter(([key]) => key !== 'none' && key !== 'punishment')
          .reduce((sum, [key, data]) => sum + data.totalWin, 0);
        
        const winGamesRTP = winGamesBet > 0 ? ((winGamesWin / winGamesBet) * 100).toFixed(2) : '0.00';
        document.getElementById('rtpWinGames').textContent = winGamesRTP + '%';
        document.getElementById('rtpWinCount').textContent = winGames;
        document.getElementById('rtpWinBet').textContent = '$' + (winGamesBet / 500000).toFixed(2);
        
        // 🔥 计算未中奖损失
        const lossGames = (winTypes['none']?.count || 0) + (winTypes['punishment']?.count || 0);
        const lossAmount = Math.abs((winTypes['none']?.totalWin || 0) + (winTypes['punishment']?.totalWin || 0));
        const lossRate = summary.totalBet > 0 ? ((lossAmount / summary.totalBet) * 100).toFixed(2) : '0.00';
        
        document.getElementById('rtpLossRate').textContent = lossRate + '%';
        document.getElementById('rtpLossCount').textContent = lossGames;
        document.getElementById('rtpLossAmount').textContent = '$' + (lossAmount / 500000).toFixed(2);
        
        // 🔥 按中奖类型显示RTP贡献
        const rtpByWinTypeHtml = Object.entries(winTypes)
          .sort((a, b) => Math.abs(b[1].totalWin) - Math.abs(a[1].totalWin))
          .map(([key, data]) => {
            const avgBet = summary.totalBet / summary.totalCount;
            const typeBet = data.count * avgBet;
            const typeRTP = typeBet > 0 ? ((data.totalWin / typeBet) * 100).toFixed(2) : '0.00';
            const contributionPercent = summary.totalBet > 0 ? ((data.totalWin / summary.totalBet) * 100).toFixed(2) : '0.00';
            
            const winTypeNames = {
              'super_jackpot': '🏆 超级大奖',
              'special_combo': '💎 特殊组合',
              'quad': '🎰 四连',
              'triple': '✨ 三连',
              'double': '🎁 双连',
              'punishment': '⚡ 律师函',
              'none': '❌ 未中奖'
            };
            
            const rtpColor = parseFloat(typeRTP) >= 100 ? 'text-green-600' : 
                           parseFloat(typeRTP) >= 50 ? 'text-yellow-600' : 'text-red-600';
            
            return `
              <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                <div class="flex-1">
                  <div class="font-medium text-slate-900">${winTypeNames[key]}</div>
                  <div class="text-xs text-slate-600 mt-1">
                    出现${data.count}次 · 总赢得$${(data.totalWin / 500000).toFixed(2)}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold ${rtpColor}">${typeRTP}%</div>
                  <div class="text-xs text-slate-500">对整体贡献: ${contributionPercent >= 0 ? '+' : ''}${contributionPercent}%</div>
                </div>
              </div>
            `;
          }).join('');
        
        document.getElementById('rtpByWinType').innerHTML = rtpByWinTypeHtml;

        // 渲染中奖类型分布
        const winTypeNames = {
          'super_jackpot': '🏆 超级大奖 (256x)',
          'special_combo': '💎 特殊组合 (32x)',
          'quad': '🎰 四连 (16x)',
          'triple': '✨ 三连 (8x)',
          'double': '🎁 双连 (4x)',
          'punishment': '⚡ 律师函',
          'none': '❌ 未中奖'
        };

        const winTypesHtml = Object.entries(winTypes)
          .sort((a, b) => b[1].count - a[1].count)
          .map(([key, data]) => {
            const percentage = summary.totalCount > 0 ? (data.count / summary.totalCount * 100).toFixed(2) : '0.00';
            const barWidth = summary.totalCount > 0 ? (data.count / summary.totalCount * 100) : 0;
            
            return `
              <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-semibold text-slate-900">${winTypeNames[key]}</span>
                  <span class="text-sm font-bold text-slate-700">${data.count} 次 (${percentage}%)</span>
                </div>
                <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full" style="width: ${barWidth}%"></div>
                </div>
                <div class="flex items-center justify-between text-xs text-slate-600">
                  <span>总${data.totalWin >= 0 ? '赢得' : '扣除'}: $${(Math.abs(data.totalWin) / 500000).toFixed(2)}</span>
                  <span>平均: $${(Math.abs(data.avgWin) / 500000).toFixed(2)}</span>
                </div>
              </div>
            `;
          }).join('');
        document.getElementById('winTypesDistribution').innerHTML = winTypesHtml;

        // 渲染每日统计
        const dailyStatsHtml = Object.entries(dailyStats)
          .sort((a, b) => b[0].localeCompare(a[0])) // 按日期倒序排序
          .map(([date, stats]) => {
            const profitColor = stats.profit >= 0 ? 'text-green-600' : 'text-red-600';
            // 🔥 计算每日RTP
            const dailyRTP = stats.bet > 0 ? ((stats.win / stats.bet) * 100).toFixed(2) : '0.00';
            const rtpColor = parseFloat(dailyRTP) >= 100 ? 'text-green-600' : 
                           parseFloat(dailyRTP) >= 90 ? 'text-yellow-600' : 
                           parseFloat(dailyRTP) >= 80 ? 'text-orange-600' : 'text-red-600';
            
            return `
              <tr>
                <td class="px-4 py-3 text-sm text-slate-900">${date}</td>
                <td class="px-4 py-3 text-sm text-slate-900 text-right">${stats.count}</td>
                <td class="px-4 py-3 text-sm text-red-600 text-right">$${(stats.bet / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-green-600 text-right">$${(stats.win / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${profitColor} text-right font-semibold">${stats.profit >= 0 ? '+' : ''}$${(stats.profit / 500000).toFixed(2)}</td>
                <td class="px-4 py-3 text-sm ${rtpColor} text-right font-bold">${dailyRTP}%</td>
              </tr>
            `;
          }).join('');
        document.getElementById('dailyStatsBody').innerHTML = dailyStatsHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">暂无数据</td></tr>';

        showMessage('分析数据已更新', 'success');
      } catch (error) {
        console.error('加载抽奖分析失败:', error);
        showMessage('加载分析数据失败', 'error');
      }
    }

    // 盈利排行榜
    async function loadProfitLeaderboard() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('加载盈利排行榜失败', 'error');
          return;
        }

        const userStats = data.data.userStats;

        // 中奖类型标签
        const winTypeLabels = {
          'super_jackpot': '🏆 超级大奖',
          'special_combo': '💎 特殊组合',
          'quad': '🎰 四连',
          'triple': '✨ 三连',
          'double': '🎁 双连',
          'punishment': '⚡ 律师函',
          'none': '❌ 未中奖'
        };

        // 盈利榜：只显示盈利的用户（profit >= 0），按盈亏降序
        const profitLeaderboard = [...userStats]
          .filter(user => (user.total_win - user.total_bet) >= 0)
          .sort((a, b) => {
            const profitA = a.total_win - a.total_bet;
            const profitB = b.total_win - b.total_bet;
            return profitB - profitA; // 降序，赚最多在前
          })
          .slice(0, 20); // 只取前20名

        // 渲染盈利排行榜
        const leaderboardHtml = profitLeaderboard.map((user, index) => {
          const rank = index + 1;
          let rankBadge = `<span class="text-slate-600 font-semibold">#${rank}</span>`;
          let rowClass = '';
          
          if (rank === 1) {
            rankBadge = '<span class="text-3xl">🥇</span>';
            rowClass = 'bg-gradient-to-r from-yellow-50 to-amber-50';
          } else if (rank === 2) {
            rankBadge = '<span class="text-3xl">🥈</span>';
            rowClass = 'bg-gradient-to-r from-gray-50 to-slate-50';
          } else if (rank === 3) {
            rankBadge = '<span class="text-3xl">🥉</span>';
            rowClass = 'bg-gradient-to-r from-orange-50 to-amber-50';
          }

          const netProfit = user.total_win - user.total_bet;
          const profitColor = netProfit >= 0 ? 'text-green-600' : 'text-red-600';

          return `
            <tr class="${rowClass}">
              <td class="px-4 py-4 text-center">${rankBadge}</td>
              <td class="px-4 py-4">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-slate-900">${user.username || user.linux_do_id}</span>
                  ${user.biggest_win_type ? `<span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full">${winTypeLabels[user.biggest_win_type] || ''}</span>` : ''}
                </div>
              </td>
              <td class="px-4 py-4 text-center text-slate-900">${user.total_spins}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">$${(user.total_bet / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-green-600 font-bold text-lg">$${(user.total_win / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right ${profitColor} font-semibold">${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-orange-600 font-medium">$${(user.biggest_win / 500000).toFixed(2)}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('profitLeaderboardTableBody').innerHTML = leaderboardHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">暂无盈利用户</td></tr>';

        showMessage('盈利排行榜已更新', 'success');
      } catch (error) {
        console.error('加载盈利排行榜失败:', error);
        showMessage('加载盈利排行榜失败', 'error');
      }
    }

    // 亏损排行榜
    async function loadLossLeaderboard() {
      try {
        const res = await fetch('/api/admin/slot/analytics');
        const data = await res.json();

        if (!data.success) {
          showMessage('加载亏损排行榜失败', 'error');
          return;
        }

        // 直接使用后端返回的亏损榜数据
        const lossLeaderboard = data.data.lossStats || [];

        // 渲染亏损排行榜
        const lossLeaderboardHtml = lossLeaderboard.slice(0, 20).map((user, index) => {
          const rank = index + 1;
          let rankBadge = `<span class="text-red-600 font-bold">#${rank}</span>`;
          let rowClass = 'bg-red-50';
          
          if (rank === 1) {
            rankBadge = '<span class="text-4xl">😱</span>';
            rowClass = 'bg-gradient-to-r from-red-100 to-rose-100 border-l-4 border-red-500';
          } else if (rank === 2) {
            rankBadge = '<span class="text-4xl">😭</span>';
            rowClass = 'bg-gradient-to-r from-red-50 to-rose-50 border-l-4 border-red-400';
          } else if (rank === 3) {
            rankBadge = '<span class="text-4xl">😢</span>';
            rowClass = 'bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-red-300';
          }

          const netProfit = user.total_win - user.total_bet;
          const lossRate = user.total_bet > 0 ? ((Math.abs(netProfit) / user.total_bet) * 100).toFixed(1) : '0.0';

          return `
            <tr class="${rowClass}">
              <td class="px-4 py-4 text-center">${rankBadge}</td>
              <td class="px-4 py-4">
                <span class="font-semibold text-slate-900">${user.username || user.linux_do_id}</span>
              </td>
              <td class="px-4 py-4 text-center text-slate-900">${user.total_spins}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">$${(user.total_bet / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-slate-600 font-medium">$${(user.total_win / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-red-700 font-bold text-lg">${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</td>
              <td class="px-4 py-4 text-right text-red-600 font-medium">${lossRate}%</td>
            </tr>
          `;
        }).join('');

        document.getElementById('lossLeaderboardTableBody').innerHTML = lossLeaderboardHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-green-600 font-semibold">🎉 暂无亏损用户，所有玩家都在盈利！</td></tr>';

        showMessage('亏损排行榜已更新', 'success');
      } catch (error) {
        console.error('加载亏损排行榜失败:', error);
        showMessage('加载亏损排行榜失败', 'error');
      }
    }

    // ========== 发放免费次数功能 ==========

    // 用户搜索（防抖）
    let searchTimeout = null;
    function searchUserDebounced() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => searchUser(), 300);
    }

    // 搜索用户
    async function searchUser() {
      const keyword = document.getElementById('singleUserIdentifier').value.trim();
      const resultsDiv = document.getElementById('singleUserSearchResults');
      
      if (keyword.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
      }

      try {
        const res = await fetch(`/api/admin/search-users?keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          resultsDiv.innerHTML = data.data.map(user => {
            const displayName = user.linux_do_username || user.username;
            const isBanned = user.is_banned === 1;
            return `
              <div onclick="selectUser('${user.linux_do_username || user.username}', '${user.linux_do_id}')" 
                   class="px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 ${isBanned ? 'opacity-50' : ''}">
                <div class="font-semibold text-slate-900">${displayName}</div>
                <div class="text-xs text-slate-500">ID: ${user.linux_do_id} ${isBanned ? '(已封禁)' : ''}</div>
              </div>
            `;
          }).join('');
          resultsDiv.classList.remove('hidden');
        } else {
          resultsDiv.classList.add('hidden');
        }
      } catch (error) {
        console.error('搜索用户失败:', error);
      }
    }

    // 选择搜索结果中的用户
    function selectUser(username, linuxDoId) {
      document.getElementById('singleUserIdentifier').value = username;
      document.getElementById('singleUserSearchResults').classList.add('hidden');
    }

    // 点击页面其他地方关闭搜索结果
    document.addEventListener('click', (e) => {
      const searchInput = document.getElementById('singleUserIdentifier');
      const resultsDiv = document.getElementById('singleUserSearchResults');
      if (searchInput && resultsDiv && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('hidden');
      }
    });

    // 显示发放免费次数的模态框
    function showGrantFreeSpinsModal(linuxDoId, username) {
      document.getElementById('modalLinuxDoId').value = linuxDoId;
      document.getElementById('modalUsername').value = username;
      document.getElementById('modalSpins').value = 5;
      document.getElementById('modalReason').value = '';
      document.getElementById('grantFreeSpinsModal').classList.remove('hidden');
    }

    // 关闭模态框
    function closeGrantFreeSpinsModal() {
      document.getElementById('grantFreeSpinsModal').classList.add('hidden');
    }

    // 从模态框确认发放
    async function confirmGrantFreeSpin() {
      const linuxDoId = document.getElementById('modalLinuxDoId').value;
      const spins = parseInt(document.getElementById('modalSpins').value);
      const reason = document.getElementById('modalReason').value;

      if (!spins || spins <= 0) {
        showToast('请输入有效的免费次数', 'error');
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier: linuxDoId, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(data.message || '发放成功', 'success');
          closeGrantFreeSpinsModal();
          // 刷新用户列表
          if (usersCurrentPage) {
            loadUsersList(usersCurrentPage);
          }
        } else {
          showToast(data.message || '发放失败', 'error');
        }
      } catch (error) {
        console.error('发放免费次数失败:', error);
        showToast('发放失败，请重试', 'error');
      }
    }

    // ========== 发放入场券功能 ==========
    
    // 显示发放入场券弹窗
    function showGrantTicketsModal(linuxDoId, username) {
      document.getElementById('ticketModalLinuxDoId').value = linuxDoId;
      document.getElementById('ticketModalUsername').value = username;
      document.getElementById('ticketModalCount').value = 1;
      document.getElementById('ticketModalReason').value = '';
      document.getElementById('grantTicketsModal').classList.remove('hidden');
    }
    
    // 关闭弹窗
    function closeGrantTicketsModal() {
      document.getElementById('grantTicketsModal').classList.add('hidden');
    }
    
    // 确认发放入场券
    async function confirmGrantTickets() {
      const linuxDoId = document.getElementById('ticketModalLinuxDoId').value;
      const username = document.getElementById('ticketModalUsername').value;
      const count = parseInt(document.getElementById('ticketModalCount').value);
      const reason = document.getElementById('ticketModalReason').value || '管理员手动发放';
      
      if (!count || count <= 0 || count > 10) {
        showToast('请输入有效的入场券数量（1-10）', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/grant-tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            linux_do_id: linuxDoId,
            count: count,
            reason: reason
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`✅ 已为用户 "${username}" 发放 ${count} 张入场券`, 'success');
          closeGrantTicketsModal();
          
          // 刷新用户列表
          if (usersCurrentPage) {
            loadUsersList(usersCurrentPage);
          }
        } else {
          showToast(data.message || '发放失败', 'error');
        }
      } catch (error) {
        console.error('发放入场券失败:', error);
        showToast('发放失败，请重试', 'error');
      }
    }

    // 单个用户发放
    async function grantSingleFreeSpin() {
      const identifier = document.getElementById('singleUserIdentifier').value.trim();
      const spins = parseInt(document.getElementById('singleSpins').value);
      const reason = document.getElementById('singleReason').value.trim();

      if (!identifier) {
        showToast('请输入用户标识（用户名或ID）', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('请输入有效的免费次数', 'error');
        return;
      }

      if (spins > 100) {
        showToast('单次发放次数不能超过100次', 'error');
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(`✅ ${data.message}`, 'success');
          clearSingleForm();
        } else {
          showToast(`❌ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('发放免费次数失败:', error);
        showToast('发放失败，请重试', 'error');
      }
    }

    // 批量发放
    async function grantBatchFreeSpin() {
      const idsText = document.getElementById('batchUserIdentifiers').value.trim();
      const spins = parseInt(document.getElementById('batchSpins').value);
      const reason = document.getElementById('batchReason').value.trim();

      if (!idsText) {
        showToast('请输入用户列表', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('请输入有效的免费次数', 'error');
        return;
      }

      if (spins > 100) {
        showToast('单次发放次数不能超过100次', 'error');
        return;
      }

      // 解析用户列表（支持用户名和ID）
      const identifiers = idsText.split('\n')
        .map(id => id.trim())
        .filter(id => id.length > 0);

      if (identifiers.length === 0) {
        showToast('请输入至少一个用户', 'error');
        return;
      }

      if (identifiers.length > 5000) {
        showToast('单次批量发放用户不能超过5000个', 'error');
        return;
      }

      if (!confirm(`确认为 ${identifiers.length} 个用户各发放 ${spins} 次免费抽奖机会吗？\n\n支持用户名和Linux Do ID混合输入`)) {
        return;
      }

      try {
        const res = await fetch('/api/admin/grant-free-spins-batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifiers, spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          const results = data.data;
          showToast(`✅ ${data.message}`, 'success');
          
          // 显示详细结果
          if (results.failed > 0 || results.skipped > 0) {
            console.log(`批量发放结果统计:\n总数: ${results.total}\n成功: ${results.success}\n失败: ${results.failed}\n跳过: ${results.skipped}`);
            
            const failedDetails = results.details
              .filter(d => !d.success)
              .slice(0, 20)
              .map(d => `${d.identifier}: ${d.message}`)
              .join('\n');
            
            if (failedDetails) {
              console.log('失败/跳过详情（前20条）:\n' + failedDetails);
            }
          }
          
          clearBatchForm();
        } else {
          showToast(`❌ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('批量发放免费次数失败:', error);
        showToast('批量发放失败，请重试', 'error');
      }
    }

    // 全员发放
    async function grantAllFreeSpin() {
      const spins = parseInt(document.getElementById('allSpins').value);
      const reason = document.getElementById('allReason').value.trim();

      if (!reason) {
        showToast('全员发放必须填写原因', 'error');
        return;
      }

      if (!spins || spins <= 0) {
        showToast('请输入有效的免费次数', 'error');
        return;
      }

      if (spins > 100) {
        showToast('单次发放次数不能超过100次', 'error');
        return;
      }

      if (!confirm(`⚠️ 警告：确认给所有用户（约2000+）各发放 ${spins} 次免费抽奖机会吗？\n\n原因：${reason}\n\n此操作不可撤销，请谨慎确认！`)) {
        return;
      }

      // 二次确认
      if (!confirm(`最后确认：真的要给所有用户发放 ${spins} 次吗？\n\n这将花费一些时间来处理。`)) {
        return;
      }

      try {
        showToast('⏳ 正在处理，请稍候...', 'success');
        
        const res = await fetch('/api/admin/grant-free-spins-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spins, reason })
        });

        const data = await res.json();
        
        if (data.success) {
          const results = data.data;
          showToast(`✅ ${data.message}\n总数: ${results.total}, 成功: ${results.success}, 失败: ${results.failed}`, 'success');
          clearAllForm();
        } else {
          showToast(`❌ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('全员发放失败:', error);
        showToast('全员发放失败，请重试', 'error');
      }
    }

    // 查询用户免费次数
    async function queryUserFreeSpins() {
      const identifier = document.getElementById('queryUserIdentifier').value.trim();

      if (!identifier) {
        showToast('请输入用户标识（用户名或ID）', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/admin/users/${encodeURIComponent(identifier)}/free-spins`);
        const data = await res.json();
        
        if (data.success) {
          const info = data.data;
          
          const displayName = info.linux_do_username || info.username;
          document.getElementById('queryUsername').textContent = displayName || '--';
          document.getElementById('queryFreeSpins').textContent = info.free_spins;

          const bannedUntil = info.banned_until;
          if (bannedUntil > 0 && bannedUntil > Date.now()) {
            const bannedDate = new Date(bannedUntil);
            document.getElementById('queryBannedUntil').textContent = bannedDate.toLocaleString('zh-CN', { hour12: false });
            document.getElementById('queryBannedUntil').className = 'text-lg font-bold text-red-600 mt-1';
          } else {
            document.getElementById('queryBannedUntil').textContent = '无限制';
            document.getElementById('queryBannedUntil').className = 'text-lg font-bold text-green-600 mt-1';
          }

          const updatedAt = info.updated_at;
          if (updatedAt > 0) {
            const updatedDate = new Date(updatedAt);
            document.getElementById('queryUpdatedAt').textContent = updatedDate.toLocaleString('zh-CN', { hour12: false });
          } else {
            document.getElementById('queryUpdatedAt').textContent = '从未更新';
          }

          document.getElementById('queryResult').classList.remove('hidden');
          showToast('查询成功', 'success');
        } else {
          showToast(data.message || '查询失败', 'error');
        }
      } catch (error) {
        console.error('查询用户免费次数失败:', error);
        showToast('查询失败，请重试', 'error');
      }
    }

    // 清空单个用户发放表单
    function clearSingleForm() {
      document.getElementById('singleUserIdentifier').value = '';
      document.getElementById('singleSpins').value = 5;
      document.getElementById('singleReason').value = '';
      document.getElementById('singleUserSearchResults').classList.add('hidden');
    }

    // 清空批量发放表单
    function clearBatchForm() {
      document.getElementById('batchUserIdentifiers').value = '';
      document.getElementById('batchSpins').value = 5;
      document.getElementById('batchReason').value = '';
    }

    // 清空全员发放表单
    function clearAllForm() {
      document.getElementById('allSpins').value = 5;
      document.getElementById('allReason').value = '';
    }

    // ========== 待发放奖金管理功能 ==========

    // 加载待发放奖金列表
    async function loadPendingRewards(silent = false) {
      try {
        const res = await fetch('/api/admin/pending-rewards');
        const data = await res.json();

        if (!data.success) {
          if (!silent) showToast('加载待发放奖金失败', 'error');
          return;
        }

        const rewards = data.data;
        const stats = data.stats;

        // 更新统计卡片
        document.getElementById('pendingTotal').textContent = stats.byStatus.pending + stats.byStatus.processing + stats.byStatus.failed;
        document.getElementById('pendingTotalAmount').textContent = '$' + stats.pendingAmountCny;
        document.getElementById('pendingCount').textContent = stats.byStatus.pending;
        document.getElementById('failedCount').textContent = stats.byStatus.failed;
        
        // 更新成功发放统计
        document.getElementById('successCount').textContent = stats.byStatus.success || 0;
        document.getElementById('successAmount').textContent = '$' + (stats.successAmountCny || '0.00');

        // 渲染表格
        const tbody = document.getElementById('pendingRewardsTableBody');
        
        if (rewards.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-green-600 font-semibold">🎉 没有待发放的奖金记录</td></tr>';
          return;
        }

        tbody.innerHTML = rewards.map(reward => {
          // 状态标签
          let statusBadge = '';
          if (reward.status === 'pending') {
            statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⏳ 待处理</span>';
          } else if (reward.status === 'failed') {
            statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">❌ 失败</span>';
          } else if (reward.status === 'processing') {
            statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">⚙️ 处理中</span>';
          } else if (reward.status === 'success') {
            statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ 成功</span>';
          }

          // 操作按钮
          let actionButtons = '';
          if (reward.status === 'failed') {
            actionButtons = `
              <div class="flex gap-1 justify-center">
                <button onclick="retryPendingReward(${reward.id}, '${reward.username}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold" title="重试">🔄</button>
                <button onclick="deletePendingReward(${reward.id}, '${reward.username}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold" title="删除">🗑️</button>
              </div>
            `;
          } else if (reward.status === 'pending' || reward.status === 'processing') {
            actionButtons = `
              <span class="text-slate-400 text-xs">等待处理</span>
            `;
          } else if (reward.status === 'success') {
            actionButtons = `
              <span class="text-green-600 text-xs font-semibold">已完成</span>
            `;
          }

          // 错误信息提示
          const errorInfo = reward.error_message 
            ? `<div class="text-xs text-red-600 mt-1" title="${reward.error_message}">⚠️ ${reward.error_message.substring(0, 30)}...</div>`
            : '';

          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 font-mono text-slate-600">#${reward.id}</td>
              <td class="px-4 py-3">
                <div class="font-semibold text-slate-900">${reward.username}</div>
                <div class="text-xs text-slate-500">${reward.linux_do_id}</div>
              </td>
              <td class="px-4 py-3 text-right">
                <div class="font-bold text-green-600">$${reward.reward_amount_cny}</div>
              </td>
              <td class="px-4 py-3">
                <div class="text-slate-700">${reward.reason}</div>
                ${errorInfo}
              </td>
              <td class="px-4 py-3 text-center">${statusBadge}</td>
              <td class="px-4 py-3 text-center">
                <span class="font-semibold ${reward.retry_count >= 5 ? 'text-red-600' : 'text-slate-700'}">${reward.retry_count}/10</span>
              </td>
              <td class="px-4 py-3 text-sm text-slate-600">${reward.created_date}</td>
              <td class="px-4 py-3 text-center">${actionButtons}</td>
            </tr>
          `;
        }).join('');

        if (!silent) showToast('待发放奖金列表已刷新', 'success');
      } catch (error) {
        console.error('加载待发放奖金失败:', error);
        if (!silent) showToast('加载失败，请重试', 'error');
      }
    }

    // 刷新待发放奖金列表
    async function refreshPendingRewards() {
      const icon = document.getElementById('pendingRewardsRefreshIcon');
      icon.classList.add('refresh-spin');
      await loadPendingRewards();
      setTimeout(() => icon.classList.remove('refresh-spin'), 600);
    }

    // 一键发放全部待发放奖金（优化版：异步处理）
    async function processAllPendingRewards() {
      const total = document.getElementById('pendingTotal').textContent;
      const totalAmount = document.getElementById('pendingTotalAmount').textContent;
      
      if (total === '0') {
        showToast('没有待发放的奖金记录', 'error');
        return;
      }

      if (!confirm(`确认立即发放全部 ${total} 条待发放奖金（总额 ${totalAmount}）吗？\n\n系统将在后台异步处理，处理完成后自动更新列表。`)) {
        return;
      }

      const btn = document.getElementById('processAllBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">⚙️</span> 启动中...';

      try {
        const res = await fetch('/api/admin/pending-rewards/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast(`🚀 ${data.message}`, 'success');

          // 立即刷新一次，显示"处理中"状态（静默模式）
          await loadPendingRewards(true);

          // 启动自动刷新，监控处理进度
          startAutoRefresh();
        } else {
          showToast(`❌ ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('一键发放失败:', error);
        showToast('发放失败，请重试', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // 自动刷新待发放列表（监控处理进度）
    let autoRefreshTimer = null;
    let autoRefreshCount = 0;
    const MAX_AUTO_REFRESH = 30; // 最多自动刷新30次（约1分钟）

    function startAutoRefresh() {
      // 清除之前的定时器
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
      
      autoRefreshCount = 0;
      
      // 每2秒刷新一次
      autoRefreshTimer = setInterval(async () => {
        autoRefreshCount++;

        // 刷新列表（静默模式，不显示提示）
        await loadPendingRewards(true);

        // 检查是否还有待处理的记录
        const pendingCount = parseInt(document.getElementById('pendingCount').textContent) || 0;
        const processingCount = parseInt(document.getElementById('pendingTotal').textContent) || 0;
        
        // 如果没有待处理的记录，或达到最大刷新次数，停止自动刷新
        if (processingCount === 0 || autoRefreshCount >= MAX_AUTO_REFRESH) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
          
          if (processingCount === 0) {
            showToast('✅ 所有待发放奖金处理完成', 'success');
          }
        }
      }, 2000);
    }

    // 重试单条失败的奖金
    async function retryPendingReward(id, username) {
      if (!confirm(`确认重置奖金发放状态吗？\n\n用户: ${username}\n记录 ID: #${id}\n\n重置后，系统将在下次自动处理时重新尝试发放。`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/pending-rewards/${id}/retry`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast('已重置为待发放状态', 'success');
          await loadPendingRewards();
        } else {
          showToast(data.message || '重置失败', 'error');
        }
      } catch (error) {
        console.error('重试失败:', error);
        showToast('操作失败，请重试', 'error');
      }
    }

    // 删除待发放奖金记录
    async function deletePendingReward(id, username) {
      if (!confirm(`⚠️ 警告：确认删除此记录吗？\n\n用户: ${username}\n记录 ID: #${id}\n\n此操作不可撤销！删除后该奖金将无法发放。`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/pending-rewards/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          showToast('记录已删除', 'success');
          await loadPendingRewards();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除失败:', error);
        showToast('操作失败，请重试', 'error');
      }
    }

    window.onload = async () => {
      try {
        const res = await fetch('/api/admin/config');
        if (res.ok) {
          // 验证成功，显示管理界面
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          await loadAdminData();
        } else {
          // 验证失败，显示登录界面
          document.getElementById('loadingSection').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
        }
      } catch (e) {
        // 请求失败，显示登录界面
        console.log('需要登录');
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
      }
    };

    // ========== 高级场管理功能 ==========

    // 预览高级场权重配置
    async function previewAdvancedWeightConfig() {
      const configId = document.getElementById('advancedSlotWeightConfigId').value;
      if (!configId) return;
      
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const config = data.data.find(c => c.id == configId);
          if (config) {
            document.getElementById('adv_preview_weight_m').textContent = config.weight_m;
            document.getElementById('adv_preview_weight_t').textContent = config.weight_t;
            document.getElementById('adv_preview_weight_n').textContent = config.weight_n;
            document.getElementById('adv_preview_weight_j').textContent = config.weight_j;
            document.getElementById('adv_preview_weight_lq').textContent = config.weight_lq;
            document.getElementById('adv_preview_weight_bj').textContent = config.weight_bj;
            document.getElementById('adv_preview_weight_zft').textContent = config.weight_zft;
            document.getElementById('adv_preview_weight_bdk').textContent = config.weight_bdk;
            document.getElementById('adv_preview_weight_lsh').textContent = config.weight_lsh;
            document.getElementById('advancedWeightPreview').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('预览高级场权重配置失败:', error);
      }
    }
    
    // 预览高级场奖励配置
    async function previewAdvancedRewardScheme() {
      const schemeId = document.getElementById('advancedSlotRewardSchemeId').value;
      if (!schemeId) return;
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (data.success) {
          const rules = data.data.rules || [];
          const previewList = document.getElementById('advancedRewardPreviewList');
          
          if (rules.length === 0) {
            previewList.innerHTML = '<div class="text-slate-500 text-center py-2">暂无规则</div>';
          } else {
            previewList.innerHTML = rules.map(rule => `
              <div class="flex justify-between items-center bg-white p-2 rounded border">
                <span class="font-semibold text-slate-900">${rule.rule_name}</span>
                <span class="text-green-600 font-bold">${rule.win_multiplier}x</span>
              </div>
            `).join('');
          }
          document.getElementById('advancedRewardPreview').classList.remove('hidden');
        }
      } catch (error) {
        console.error('预览高级场奖励方案失败:', error);
      }
    }
    
    // 保存高级场配置方案选择
    async function saveAdvancedSlotConfigSchemes() {
      const weightConfigId = document.getElementById('advancedSlotWeightConfigId').value;
      const rewardSchemeId = document.getElementById('advancedSlotRewardSchemeId').value;
      
      if (!weightConfigId || !rewardSchemeId) {
        showToast('请选择权重配置方案和奖励配置方案', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/slot/advanced/config/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            weight_config_id: parseInt(weightConfigId),
            reward_scheme_id: parseInt(rewardSchemeId)
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('✅ 高级场配置方案已保存并生效', 'success');
          // 🔥 重新加载配置以刷新下拉框显示
          await loadAdvancedWeightConfigOptions();
          await loadAdvancedRewardSchemeOptions();
        } else {
          showToast(data.message || '保存失败', 'error');
        }
      } catch (error) {
        console.error('保存高级场配置方案失败:', error);
        showToast('保存失败', 'error');
      }
    }

    // 高级场配置管理
    async function loadAdvancedSlotConfig() {
      try {
        const res = await fetch('/api/admin/slot/advanced/config');
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          
          // 基础设置
          document.getElementById('advancedEnabled').checked = config.enabled === 1;
          
          // 🎯 使用美元显示投注范围
          const betMinUsd = (config.bet_min / 500000).toFixed(0);
          const betMaxUsd = (config.bet_max / 500000).toFixed(0);
          const dailyLimitUsd = (config.daily_bet_limit / 500000).toFixed(0);
          
          document.getElementById('advancedBetMinUsd').value = betMinUsd;
          document.getElementById('advancedBetMaxUsd').value = betMaxUsd;
          document.getElementById('advancedDailyBetLimitUsd').value = dailyLimitUsd;
          
          // 显示聪值
          document.getElementById('advancedBetMinQuota').textContent = config.bet_min || 50000000;
          document.getElementById('advancedBetMaxQuota').textContent = config.bet_max || 250000000;
          document.getElementById('advancedDailyBetLimitQuota').textContent = config.daily_bet_limit || 5000000000;
          
          document.getElementById('advancedRewardMultiplier').value = config.reward_multiplier || 4.0;
          document.getElementById('advancedPenaltyFactor').value = config.penalty_weight_factor || 2.0;
          
          // 时效设置
          document.getElementById('advancedTicketValidHours').value = config.ticket_valid_hours || 24;
          document.getElementById('advancedSessionValidHours').value = config.session_valid_hours || 24;
          
          // 掉落设置
          document.getElementById('advancedFragmentsNeeded').value = config.fragments_needed || 5;
          document.getElementById('advancedDropRateTriple').value = config.drop_rate_triple || 1.0;
          document.getElementById('advancedDropRateDouble').value = config.drop_rate_double || 1.0;
          document.getElementById('advancedMaxTicketsHold').value = config.max_tickets_hold || 2;
          document.getElementById('advancedDailyEntryLimit').value = config.daily_entry_limit || 2;
          document.getElementById('advancedDailyTicketGrantLimit').value = config.daily_ticket_grant_limit || 2;
          
          // 🔥 初始化掉落率滑杆和可视条
          const doubleSlider = document.getElementById('advancedDropRateDoubleSlider');
          const tripleSlider = document.getElementById('advancedDropRateTripleSlider');
          if (doubleSlider) {
            doubleSlider.value = config.drop_rate_double;
            updateDropRateDoubleDisplay(config.drop_rate_double);
          }
          if (tripleSlider) {
            tripleSlider.value = config.drop_rate_triple;
            updateDropRateTripleDisplay(config.drop_rate_triple);
          }
          
          // 🎯 实时更新聪值显示（美元→聪）
          document.getElementById('advancedBetMinUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedBetMinQuota').textContent = value * 500000;
          });
          document.getElementById('advancedBetMaxUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedBetMaxQuota').textContent = value * 500000;
          });
          document.getElementById('advancedDailyBetLimitUsd').addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            document.getElementById('advancedDailyBetLimitQuota').textContent = value * 500000;
          });
        }
        
        // 加载配置方案列表
        await loadAdvancedWeightConfigOptions();
        await loadAdvancedRewardSchemeOptions();
      } catch (error) {
        console.error('加载高级场配置失败:', error);
        showMessage('加载配置失败', 'error');
      }
    }
    
    // 加载高级场权重配置方案选项
    async function loadAdvancedWeightConfigOptions() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('advancedSlotWeightConfigId');
          select.innerHTML = data.data.map(w => 
            `<option value="${w.id}">${w.config_name}${w.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
          
          // 获取当前配置
          const configRes = await fetch('/api/admin/slot/advanced/config');
          const configData = await configRes.json();
          if (configData.success && configData.data.weight_config_id) {
            select.value = configData.data.weight_config_id;
            previewAdvancedWeightConfig();
          }
        }
      } catch (error) {
        console.error('加载高级场权重配置方案失败:', error);
      }
    }
    
    // 加载高级场奖励配置方案选项
    async function loadAdvancedRewardSchemeOptions() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          const select = document.getElementById('advancedSlotRewardSchemeId');
          select.innerHTML = data.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}${s.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
          
          // 获取当前配置
          const configRes = await fetch('/api/admin/slot/advanced/config');
          const configData = await configRes.json();
          if (configData.success && configData.data.reward_scheme_id) {
            select.value = configData.data.reward_scheme_id;
            previewAdvancedRewardScheme();
          }
        }
      } catch (error) {
        console.error('加载高级场奖励配置方案失败:', error);
      }
    }

    async function saveAdvancedSlotConfig() {
      try {
        // 🎯 从美元输入框获取值，转换为聪
        const betMinUsd = parseInt(document.getElementById('advancedBetMinUsd').value) || 100;
        const betMaxUsd = parseInt(document.getElementById('advancedBetMaxUsd').value) || 500;
        const dailyLimitUsd = parseInt(document.getElementById('advancedDailyBetLimitUsd').value) || 10000;
        
        const config = {
          enabled: document.getElementById('advancedEnabled').checked ? 1 : 0,
          bet_min: betMinUsd * 500000,  // 美元转聪
          bet_max: betMaxUsd * 500000,  // 美元转聪
          reward_multiplier: parseFloat(document.getElementById('advancedRewardMultiplier').value) || 4.0,
          penalty_weight_factor: parseFloat(document.getElementById('advancedPenaltyFactor').value) || 2.0,
          rtp_target: 0.88,  // 保留字段以兼容数据库
          ticket_valid_hours: parseInt(document.getElementById('advancedTicketValidHours').value) || 24,
          session_valid_hours: parseInt(document.getElementById('advancedSessionValidHours').value) || 24,
          fragments_needed: parseInt(document.getElementById('advancedFragmentsNeeded').value) || 5,
          drop_rate_triple: parseFloat(document.getElementById('advancedDropRateTriple').value) || 1.0,
          drop_rate_double: parseFloat(document.getElementById('advancedDropRateDouble').value) || 1.0,
          max_tickets_hold: parseInt(document.getElementById('advancedMaxTicketsHold').value) || 2,
          daily_bet_limit: dailyLimitUsd * 500000,  // 美元转聪
          daily_entry_limit: parseInt(document.getElementById('advancedDailyEntryLimit').value) || 2,
          daily_ticket_grant_limit: parseInt(document.getElementById('advancedDailyTicketGrantLimit').value) || 2
        };
        
        // 验证
        if (betMinUsd >= betMaxUsd) {
          showMessage('最小投注必须小于最大投注', 'error');
          return;
        }
        
        const res = await fetch('/api/admin/slot/advanced/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showMessage('高级场配置已更新', 'success');
          console.log('[管理员] 高级场配置已保存:', config);
        } else {
          showMessage(data.message, 'error');
        }
      } catch (error) {
        console.error('保存高级场配置失败:', error);
        showMessage('保存配置失败', 'error');
      }
    }

    // ========== 坤呗贷款管理功能 ==========
    
    async function loadKunbeiManagement() {
      try {
        // 加载配置
        const configRes = await fetch('/api/admin/kunbei/config');
        const configData = await configRes.json();
        
        if (configData.success) {
          const config = configData.data;
          document.getElementById('kunbeiEnabled').value = config.enabled;
          document.getElementById('kunbeiMaxAmount').value = config.max_loan_amount / 500000;
          document.getElementById('kunbeiRepayMultiplier').value = config.repay_multiplier;
          document.getElementById('kunbeiDuration').value = config.loan_duration_hours;
          document.getElementById('kunbeiEarlyDiscount').value = config.early_repay_discount;
          document.getElementById('kunbeiOverduePenalty').value = config.overdue_penalty_hours;
          document.getElementById('kunbeiOverdueDeductMultiplier').value = config.overdue_deduct_multiplier || 2.5;
          
          // 设置逾期扣除配置（保留用于显示）
          if (config.deduct_all_quota_on_overdue !== undefined) {
            document.getElementById('deductAllQuotaOnOverdue').checked = !!config.deduct_all_quota_on_overdue;
          }
        }
        
        // 加载统计数据
        const loansRes = await fetch('/api/admin/kunbei/loans');
        const loansData = await loansRes.json();
        
        if (loansData.success) {
          updateKunbeiMainStats(loansData.data.stats);
        }
        
        // 加载梯度配置
        loadGradientConfigs();
      } catch (error) {
        console.error('加载坤呗数据失败:', error);
        showToast('加载失败', 'error');
      }
    }
    
    function refreshKunbeiData() {
      loadKunbeiManagement();
    }
    
    async function saveKunbeiConfig() {
      try {
        const config = {
          enabled: parseInt(document.getElementById('kunbeiEnabled').value),
          max_loan_amount: parseInt(document.getElementById('kunbeiMaxAmount').value) * 500000,
          min_loan_amount: 5000000,
          repay_multiplier: parseFloat(document.getElementById('kunbeiRepayMultiplier').value),
          loan_duration_hours: parseFloat(document.getElementById('kunbeiDuration').value),
          early_repay_discount: parseFloat(document.getElementById('kunbeiEarlyDiscount').value),
          overdue_penalty_hours: parseInt(document.getElementById('kunbeiOverduePenalty').value),
          overdue_deduct_multiplier: parseFloat(document.getElementById('kunbeiOverdueDeductMultiplier').value) || 2.5,
          overdue_ban_advanced: 1,
          max_active_loans: 1,
          deduct_all_quota_on_overdue: 1  // 保留字段以兼容
        };
        
        const res = await fetch('/api/admin/kunbei/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('配置已保存', 'success');
        } else {
          showToast(data.message || '保存失败', 'error');
        }
      } catch (error) {
        console.error('保存坤呗配置失败:', error);
        showToast('保存失败', 'error');
      }
    }
    
    function updateKunbeiMainStats(stats) {
      // 更新坤呗管理页面的统计
      document.getElementById('kunbeiActiveCount').textContent = stats.active_count || 0;
      document.getElementById('kunbeiOverdueCount').textContent = stats.overdue_count || 0;
      document.getElementById('kunbeiTotalLoan').textContent = `$${((stats.total_loan || 0) / 500000).toFixed(2)}`;
      document.getElementById('kunbeiTotalRepaid').textContent = `$${((stats.total_repaid || 0) / 500000).toFixed(2)}`;
    }
    
    // 豁免借款
    async function forgiveLoan(loanId, username) {
      if (!confirm(`确认豁免用户 "${username}" 的借款吗？\n\n豁免后该借款将标记为已还清，用户无需还款。`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('借款已豁免', 'success');
          refreshKunbeiData();
        } else {
          showToast(data.message || '豁免失败', 'error');
        }
      } catch (error) {
        console.error('豁免失败:', error);
        showToast('操作失败', 'error');
      }
    }
    
    // ========== 坤呗梯度配置管理 ==========
    async function loadGradientConfigs() {
      try {
        const res = await fetch('/api/admin/kunbei/gradient-configs');
        const data = await res.json();
        
        if (data.success && data.data) {
          renderGradientConfigsTable(data.data);
        }
      } catch (error) {
        console.error('加载梯度配置失败:', error);
      }
    }
    
    function renderGradientConfigsTable(configs) {
      const tbody = document.getElementById('gradientConfigsTable');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-8 text-slate-500">
              <div class="text-4xl mb-2">📋</div>
              <p>暂无梯度配置</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = configs.map(config => `
        <tr class="border-b border-slate-100 hover:bg-slate-50">
          <td class="px-4 py-3">
            <span class="font-semibold text-slate-900">$${(config.quota_threshold / 500000).toFixed(2)}</span>
            <div class="text-xs text-slate-500">额度达到此值</div>
          </td>
          <td class="px-4 py-3">
            <span class="font-semibold text-green-600">$${(config.max_loan_amount / 500000).toFixed(2)}</span>
            <div class="text-xs text-slate-500">最大可借</div>
          </td>
          <td class="px-4 py-3">
            ${config.is_active 
              ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ 启用</span>'
              : '<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-semibold">❌ 禁用</span>'
            }
          </td>
          <td class="px-4 py-3 text-center">
            <button onclick="editGradientConfig(${JSON.stringify(config).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">编辑</button>
            <button onclick="deleteGradientConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">删除</button>
          </td>
        </tr>
      `).join('');
    }
    
    function showGradientConfigModal(config = null) {
      const isEdit = !!config;
      const modalHtml = `
        <div id="gradientConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-slate-900 mb-4">${isEdit ? '编辑梯度配置' : '添加梯度配置'}</h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">额度阈值（美元）</label>
                <input type="number" id="gradientThreshold" value="${config ? config.quota_threshold / 500000 : ''}" 
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                  placeholder="例如：10000">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">最大可借金额（美元）</label>
                <input type="number" id="gradientMaxLoan" value="${config ? config.max_loan_amount / 500000 : ''}"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="例如：10000">
              </div>
              
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="gradientActive" ${!config || config.is_active ? 'checked' : ''}
                    class="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                  <span class="text-slate-700 font-medium">启用此配置</span>
                </label>
              </div>
            </div>
            
            <div class="flex gap-3 mt-6">
              <button onclick="closeGradientConfigModal()" 
                class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">
                取消
              </button>
              <button onclick="saveGradientConfig(${config ? config.id : 'null'})" 
                class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                ${isEdit ? '更新' : '添加'}
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function editGradientConfig(config) {
      showGradientConfigModal(config);
    }
    
    function closeGradientConfigModal() {
      const modal = document.getElementById('gradientConfigModal');
      if (modal) modal.remove();
    }
    
    async function saveGradientConfig(configId) {
      try {
        const threshold = parseFloat(document.getElementById('gradientThreshold').value);
        const maxLoan = parseFloat(document.getElementById('gradientMaxLoan').value);
        const isActive = document.getElementById('gradientActive').checked ? 1 : 0;
        
        if (!threshold || !maxLoan) {
          showToast('请填写完整信息', 'error');
          return;
        }
        
        const data = {
          quota_threshold: threshold * 500000,
          max_loan_amount: maxLoan * 500000,
          priority: 0,  // 优先级固定为0，系统会自动按阈值排序
          is_active: isActive
        };
        
        const url = configId 
          ? `/api/admin/kunbei/gradient-configs/${configId}`
          : '/api/admin/kunbei/gradient-configs';
          
        const method = configId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast(configId ? '更新成功' : '添加成功', 'success');
          closeGradientConfigModal();
          loadGradientConfigs();
        } else {
          showToast(result.message || '操作失败', 'error');
        }
      } catch (error) {
        console.error('保存梯度配置失败:', error);
        showToast('操作失败', 'error');
      }
    }
    
    async function deleteGradientConfig(configId) {
      if (!confirm('确定要删除此梯度配置吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/gradient-configs/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('删除成功', 'success');
          loadGradientConfigs();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除梯度配置失败:', error);
        showToast('删除失败', 'error');
      }
    }
    
    // 保存逾期扣除配置
    async function saveOverdueConfig() {
      try {
        const deductAll = document.getElementById('deductAllQuotaOnOverdue').checked;
        
        // 获取当前配置
        const configRes = await fetch('/api/admin/kunbei/config');
        const configData = await configRes.json();
        
        if (!configData.success) {
          showToast('获取配置失败', 'error');
          return;
        }
        
        // 更新配置
        const config = configData.data;
        config.deduct_all_quota_on_overdue = deductAll ? 1 : 0;
        
        const res = await fetch('/api/admin/kunbei/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('逾期惩罚配置已保存', 'success');
        } else {
          showToast(data.message || '保存失败', 'error');
        }
      } catch (error) {
        console.error('保存逾期配置失败:', error);
        showToast('保存失败', 'error');
      }
    }

    // ========== 贷款记录管理功能 ==========
    
    let kunbeiRecordsCurrentPage = 1;
    let kunbeiRecordsData = [];
    let kunbeiRecordsFiltered = [];
    let selectedRecords = new Set();
    const recordsPerPage = 20;
    
    async function loadKunbeiRecords() {
      try {
        const res = await fetch('/api/admin/kunbei/all-loans');
        const data = await res.json();
        
        if (data.success) {
          kunbeiRecordsData = data.data.loans || [];
          applyKunbeiFilters();
          updateKunbeiStatistics(data.data.stats);
        }
      } catch (error) {
        console.error('加载贷款记录失败:', error);
        showToast('加载失败', 'error');
      }
    }
    
    function refreshKunbeiRecords() {
      selectedRecords.clear();
      updateSelectedCount();
      loadKunbeiRecords();
    }
    
    function searchKunbeiRecords(event) {
      if (event.key === 'Enter' || !event.key) {
        applyKunbeiFilters();
      }
    }
    
    function filterKunbeiRecords() {
      applyKunbeiFilters();
    }
    
    function applyKunbeiFilters() {
      const searchTerm = document.getElementById('kunbeiRecordSearch').value.toLowerCase();
      const statusFilter = document.getElementById('kunbeiStatusFilter').value;
      const timeFilter = document.getElementById('kunbeiTimeFilter').value;
      
      kunbeiRecordsFiltered = kunbeiRecordsData.filter(record => {
        // 搜索过滤
        if (searchTerm) {
          const matchLinuxDo = record.username.toLowerCase().includes(searchTerm);
          const matchKyx = record.kyx_username && record.kyx_username.toLowerCase().includes(searchTerm);
          if (!matchLinuxDo && !matchKyx) return false;
        }
        
        // 状态过滤
        if (statusFilter) {
          // 判断是否豁免
          const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
          if (statusFilter === 'forgiven' && !isForgiven) return false;
          if (statusFilter !== 'forgiven' && statusFilter !== record.status) return false;
        }
        
        // 时间过滤
        if (timeFilter && timeFilter !== 'all') {
          const now = Date.now();
          const recordTime = record.borrowed_at;
          const dayMs = 24 * 60 * 60 * 1000;
          
          if (timeFilter === 'today' && recordTime < now - dayMs) return false;
          if (timeFilter === 'week' && recordTime < now - 7 * dayMs) return false;
          if (timeFilter === 'month' && recordTime < now - 30 * dayMs) return false;
        }
        
        return true;
      });
      
      // 重置到第一页
      kunbeiRecordsCurrentPage = 1;
      renderKunbeiRecordsTable();
    }
    
    function updateKunbeiStatistics(stats) {
      // 更新统计数据
      document.getElementById('totalRecordsCount').textContent = stats.total_count || 0;
      document.getElementById('activeLoansCount').textContent = stats.active_count || 0;
      document.getElementById('repaidLoansCount').textContent = stats.repaid_count || 0;
      document.getElementById('overdueLoansCount').textContent = stats.overdue_count || 0;
      document.getElementById('totalLoanedAmount').textContent = `$${((stats.total_loaned || stats.total_amount || 0) / 500000).toFixed(2)}`;
      document.getElementById('totalRepaidAmount').textContent = `$${((stats.total_repaid || 0) / 500000).toFixed(2)}`;
    }
    
    function renderKunbeiRecordsTable() {
      const tbody = document.getElementById('kunbeiRecordsTableBody');
      const totalRecords = kunbeiRecordsFiltered.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const start = (kunbeiRecordsCurrentPage - 1) * recordsPerPage;
      const end = Math.min(start + recordsPerPage, totalRecords);
      const pageRecords = kunbeiRecordsFiltered.slice(start, end);
      
      // 更新分页信息
      document.getElementById('recordsStart').textContent = totalRecords > 0 ? start + 1 : 0;
      document.getElementById('recordsEnd').textContent = end;
      document.getElementById('recordsTotal').textContent = totalRecords;
      document.getElementById('currentPageNum').textContent = kunbeiRecordsCurrentPage;
      document.getElementById('totalPageNum').textContent = totalPages || 1;
      
      // 更新分页按钮状态
      document.getElementById('prevPageBtn').disabled = kunbeiRecordsCurrentPage <= 1;
      document.getElementById('nextPageBtn').disabled = kunbeiRecordsCurrentPage >= totalPages;
      
      if (pageRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-slate-500">暂无记录</td></tr>';
        return;
      }
      
      tbody.innerHTML = pageRecords.map(record => {
        const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
        
        // 🔥 优化：只有逾期且有惩罚时间且未过期时才认为有逾期惩罚
        const now = Date.now();
        const hasOverduePenalty = record.status === 'overdue' && 
                                   record.overdue_penalty_until && 
                                   record.overdue_penalty_until > now;
        
        const statusBadge = record.status === 'active' 
          ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⏳ 借款中</span>'
          : record.status === 'overdue'
            ? '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">⚠️ 已逾期</span>'
            : isForgiven
              ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">🤝 已免除</span>'
              : '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ 已还款</span>';
        
        // 🔥 显示自动扣款金额
        const autoDeductDisplay = record.auto_deducted_amount && record.auto_deducted_amount > 0
          ? `<div class="font-semibold text-orange-600">$${(record.auto_deducted_amount / 500000).toFixed(2)}</div>
             <div class="text-xs text-orange-500">已自动扣除</div>`
          : '<span class="text-slate-400 text-xs">-</span>';
        
        const isChecked = selectedRecords.has(record.id);
        
        // 🔥 优化操作按钮：只在有有效的逾期惩罚时显示解封按钮
        let actionButtons = '';
        if (record.status === 'active' || record.status === 'overdue') {
          actionButtons = `
            <button onclick="viewLoanDetails(${record.id})" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mb-1">详情</button>
            <button onclick="forgiveSingleLoan(${record.id}, '${record.username}')" class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs font-medium mb-1">免除</button>
          `;
          
          // 🔥 只有当前有有效的逾期惩罚时才显示解封按钮
          if (hasOverduePenalty) {
            const remainingHours = Math.ceil((record.overdue_penalty_until - now) / 3600000);
            actionButtons += `
            <button onclick="clearOverduePenaltyBtn(${record.id}, '${record.username}')" 
                    class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium"
                    title="解除高级场禁入（剩余${remainingHours}小时）">
              🔓 解封
            </button>
            `;
          }
        } else {
          actionButtons = `<button onclick="viewLoanDetails(${record.id})" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium">详情</button>`;
        }
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 text-center">
              <input type="checkbox" ${isChecked ? 'checked' : ''} 
                     onchange="toggleRecordSelection(${record.id})"
                     ${record.status === 'repaid' || isForgiven ? 'disabled' : ''}
                     class="w-4 h-4 text-indigo-600 border-slate-300 rounded ${record.status === 'repaid' || isForgiven ? 'opacity-50' : ''}">
            </td>
            <td class="px-4 py-3 font-mono text-slate-600">#${record.id}</td>
            <td class="px-4 py-3">
              <div class="font-medium text-slate-900">${record.username}</div>
            </td>
            <td class="px-4 py-3">
              <div class="text-sm text-slate-600">${record.kyx_username || '-'}</div>
            </td>
            <td class="px-4 py-3 text-right font-semibold text-blue-600">$${(record.loan_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-semibold text-red-600">$${(record.repay_amount / 500000).toFixed(2)}</td>
            <td class="px-4 py-3 text-right">${autoDeductDisplay}</td>
            <td class="px-4 py-3 text-xs text-slate-600">${new Date(record.borrowed_at).toLocaleString('zh-CN', { hour12: false })}</td>
            <td class="px-4 py-3 text-xs text-slate-600">${new Date(record.due_at).toLocaleString('zh-CN', { hour12: false })}</td>
            <td class="px-4 py-3 text-center">${statusBadge}</td>
            <td class="px-4 py-3 text-center">
              <div class="flex flex-col gap-1 items-center">
                ${actionButtons}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function changeRecordsPage(delta) {
      const totalPages = Math.ceil(kunbeiRecordsFiltered.length / recordsPerPage);
      const newPage = kunbeiRecordsCurrentPage + delta;
      
      if (newPage >= 1 && newPage <= totalPages) {
        kunbeiRecordsCurrentPage = newPage;
        renderKunbeiRecordsTable();
      }
    }
    
    function toggleRecordSelection(recordId) {
      if (selectedRecords.has(recordId)) {
        selectedRecords.delete(recordId);
      } else {
        selectedRecords.add(recordId);
      }
      updateSelectedCount();
    }
    
    function toggleAllRecords() {
      const checkAll = document.getElementById('selectAllRecords').checked;
      const headerCheckAll = document.getElementById('selectAllHeader');
      
      if (headerCheckAll) {
        headerCheckAll.checked = checkAll;
      }
      
      if (checkAll) {
        // 只选择当前页面上可选的记录（非已还款/已免除）
        const start = (kunbeiRecordsCurrentPage - 1) * recordsPerPage;
        const end = Math.min(start + recordsPerPage, kunbeiRecordsFiltered.length);
        const pageRecords = kunbeiRecordsFiltered.slice(start, end);
        
        pageRecords.forEach(record => {
          if (record.status === 'active' || record.status === 'overdue') {
            selectedRecords.add(record.id);
          }
        });
      } else {
        selectedRecords.clear();
      }
      
      updateSelectedCount();
      renderKunbeiRecordsTable();
    }
    
    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedRecords.size;
      const hasSeletion = selectedRecords.size > 0;
      document.getElementById('batchForgiveBtn').disabled = !hasSeletion;
      document.getElementById('batchReminderBtn').disabled = !hasSeletion;
    }
    
    async function batchForgiveLoans() {
      if (selectedRecords.size === 0) return;
      
      if (!confirm(`确定要免除选中的 ${selectedRecords.size} 条贷款记录吗？\n\n免除后这些借款将标记为已还清，用户无需还款。`)) {
        return;
      }
      
      let successCount = 0;
      let failCount = 0;
      
      for (const loanId of selectedRecords) {
        try {
          const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
            method: 'POST'
          });
          
          const data = await res.json();
          if (data.success) {
            successCount++;
          } else {
            failCount++;
          }
        } catch (error) {
          failCount++;
        }
      }
      
      showToast(`批量免除完成：成功 ${successCount} 条，失败 ${failCount} 条`, 'success');
      selectedRecords.clear();
      updateSelectedCount();
      refreshKunbeiRecords();
    }
    
    function batchSendReminders() {
      // TODO: 实现批量催收功能
      showToast('批量催收功能开发中...', 'info');
    }
    
    async function forgiveSingleLoan(loanId, username) {
      if (!confirm(`确认免除用户 "${username}" 的借款吗？\n\n免除后该借款将标记为已还清，用户无需还款。`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/forgive`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('借款已免除', 'success');
          refreshKunbeiRecords();
        } else {
          showToast(data.message || '免除失败', 'error');
        }
      } catch (error) {
        console.error('免除失败:', error);
        showToast('操作失败', 'error');
      }
    }
    
    // 🔥 解除逾期惩罚（解封高级场禁入）
    async function clearOverduePenaltyBtn(loanId, username) {
      if (!confirm(`确认解除用户 "${username}" 的逾期惩罚吗？\n\n解封后该用户可以正常进入高级场。\n\n注意：借款仍需还清，只是解除禁入惩罚。`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/kunbei/loans/${loanId}/clear-penalty`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('✅ ' + data.message, 'success');
          refreshKunbeiRecords();
        } else {
          showToast(data.message || '解除失败', 'error');
        }
      } catch (error) {
        console.error('解除惩罚失败:', error);
        showToast('操作失败', 'error');
      }
    }
    
    function viewLoanDetails(loanId) {
      // TODO: 实现查看借款详情功能
      showToast('借款详情功能开发中...', 'info');
    }
    
    function exportKunbeiRecords() {
      if (kunbeiRecordsFiltered.length === 0) {
        showToast('没有可导出的记录', 'warning');
        return;
      }
      
      // 准备CSV数据
      const headers = ['ID', 'LinuxDo用户', '公益站用户', '借款金额($)', '应还金额($)', '借款时间', '到期时间', '状态'];
      const rows = kunbeiRecordsFiltered.map(record => {
        const isForgiven = record.status === 'repaid' && record.actual_repay_amount === 0;
        const status = record.status === 'active' ? '借款中' 
          : record.status === 'overdue' ? '已逾期'
          : isForgiven ? '已免除'
          : '已还款';
          
        return [
          record.id,
          record.username,
          record.kyx_username || '-',
          (record.loan_amount / 500000).toFixed(2),
          (record.repay_amount / 500000).toFixed(2),
          new Date(record.borrowed_at).toLocaleString('zh-CN', { hour12: false }),
          new Date(record.due_at).toLocaleString('zh-CN', { hour12: false }),
          status
        ];
      });
      
      // 生成CSV内容
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      // 下载文件
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kunbei_records_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('导出成功', 'success');
    }

    // ========== 权重配置管理功能 ==========
    
    async function loadWeightConfigs() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          renderWeightConfigsTable(data.data);
        }
      } catch (error) {
        console.error('加载权重配置失败:', error);
        showToast('加载失败', 'error');
      }
    }
    
    function renderWeightConfigsTable(configs) {
      const tbody = document.getElementById('weightConfigsTableBody');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">暂无权重配置</td></tr>';
        return;
      }
      
      tbody.innerHTML = configs.map(config => {
        const usageText = config.usage_count > 0 ? `${config.usage_count}个场次` : '未使用';
        const canDelete = config.usage_count === 0;
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${config.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${config.config_name}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${config.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="showEditWeightConfigModal(${config.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mr-1">编辑</button>
              <button onclick="viewWeightConfigDetails(${config.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium mr-1">详情</button>
              ${canDelete ? `<button onclick="deleteWeightConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium">删除</button>` : '<span class="text-xs text-slate-400">使用中</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddWeightConfigModal() {
      const modalHtml = `
        <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-purple-600">
              <h3 class="text-xl font-bold text-white">➕ 添加权重配置</h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">配置名称 *</label>
                  <input type="text" id="weightConfigName" placeholder="例如：周末活动配置" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">配置描述</label>
                  <textarea id="weightConfigDesc" placeholder="简要描述这个配置的特点" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
              </div>
              
              <h4 class="font-bold text-slate-900 mb-4">符号权重设置</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                <div><label class="text-sm text-slate-700">🎵 美 (m)</label><input type="number" id="newWeight_m" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">⚡ 太 (t)</label><input type="number" id="newWeight_t" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">👀 你 (n)</label><input type="number" id="newWeight_n" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">🐔 鸡 (j)</label><input type="number" id="newWeight_j" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">🏀 篮球 (lq)</label><input type="number" id="newWeight_lq" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">🎬 背景 (bj)</label><input type="number" id="newWeight_bj" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">💇 中分头 (zft)</label><input type="number" id="newWeight_zft" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">👖 背带裤 (bdk)</label><input type="number" id="newWeight_bdk" value="100" min="1" max="1000" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="text-sm text-slate-700">⚖️ 律师函 (lsh)</label><input type="number" id="newWeight_lsh" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50"></div>
              </div>
              
              <div class="flex gap-3">
                <button onclick="saveNewWeightConfig()" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                  ✅ 创建配置
                </button>
                <button onclick="closeWeightConfigModal()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">
                  取消
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function showEditWeightConfigModal(configId) {
      // 待实现：编辑配置的模态框
      showToast('编辑功能开发中...', 'info');
    }
    
    function viewWeightConfigDetails(configId) {
      // 待实现：查看配置详情
      showToast('查看详情功能开发中...', 'info');
    }
    
    async function saveNewWeightConfig() {
      const configName = document.getElementById('weightConfigName').value.trim();
      if (!configName) {
        showToast('请输入配置名称', 'error');
        return;
      }
      
      const data = {
        config_name: configName,
        description: document.getElementById('weightConfigDesc').value.trim(),
        weight_m: parseInt(document.getElementById('newWeight_m').value),
        weight_t: parseInt(document.getElementById('newWeight_t').value),
        weight_n: parseInt(document.getElementById('newWeight_n').value),
        weight_j: parseInt(document.getElementById('newWeight_j').value),
        weight_lq: parseInt(document.getElementById('newWeight_lq').value),
        weight_bj: parseInt(document.getElementById('newWeight_bj').value),
        weight_zft: parseInt(document.getElementById('newWeight_zft').value),
        weight_bdk: parseInt(document.getElementById('newWeight_bdk').value),
        weight_lsh: parseInt(document.getElementById('newWeight_lsh').value)
      };
      
      try {
        const res = await fetch('/api/admin/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('权重配置已添加', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(result.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加权重配置失败:', error);
        showToast('添加失败', 'error');
      }
    }
    
    async function deleteWeightConfig(configId) {
      if (!confirm('确定要删除此权重配置吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('配置已删除', 'success');
          loadWeightConfigs();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除权重配置失败:', error);
        showToast('删除失败', 'error');
      }
    }
    
    function closeWeightConfigModal() {
      const modal = document.getElementById('weightConfigModal');
      if (modal) modal.remove();
    }
    
    // ========== 奖励配置管理功能 ==========
    
    async function loadRewardConfigs() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          renderRewardSchemesTable(data.data);
        }
      } catch (error) {
        console.error('加载奖励配置失败:', error);
        showToast('加载失败', 'error');
      }
    }
    
    function renderRewardSchemesTable(schemes) {
      const tbody = document.getElementById('rewardSchemesTableBody');
      
      if (!schemes || schemes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">暂无奖励方案</td></tr>';
        return;
      }
      
      tbody.innerHTML = schemes.map(scheme => {
        const usageText = scheme.usage_count > 0 ? `${scheme.usage_count}个场次` : '未使用';
        const canDelete = scheme.usage_count === 0;
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${scheme.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${scheme.scheme_name}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">${scheme.rules_count}条规则</span>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${scheme.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="editRewardScheme(${scheme.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium mr-1">编辑</button>
              <button onclick="viewSchemeDetails(${scheme.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium mr-1">详情</button>
              ${canDelete ? `<button onclick="deleteRewardScheme(${scheme.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium">删除</button>` : '<span class="text-xs text-slate-400">使用中</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddRewardSchemeModal() {
      const modalHtml = `
        <div id="rewardSchemeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-purple-600">
              <h3 class="text-xl font-bold text-white">➕ 添加奖励方案</h3>
            </div>
            <div class="p-6">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">方案名称 *</label>
                  <input type="text" id="rewardSchemeName" placeholder="例如：高倍率模式" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">方案描述</label>
                  <textarea id="rewardSchemeDesc" placeholder="简要描述这个方案的特点" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="saveNewRewardScheme()" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">
                  ✅ 创建方案
                </button>
                <button onclick="closeRewardSchemeModal()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">
                  取消
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewRewardScheme() {
      const schemeName = document.getElementById('rewardSchemeName').value.trim();
      if (!schemeName) {
        showToast('请输入方案名称', 'error');
        return;
      }
      
      const data = {
        scheme_name: schemeName,
        description: document.getElementById('rewardSchemeDesc').value.trim()
      };
      
      try {
        const res = await fetch('/api/admin/rewards/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('奖励方案已添加，请继续添加规则', 'success');
          closeRewardSchemeModal();
          loadRewardConfigs();
        } else {
          showToast(result.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加奖励方案失败:', error);
        showToast('添加失败', 'error');
      }
    }
    
    function editRewardScheme(schemeId) {
      // 待实现：编辑方案（含规则管理）
      showToast('编辑功能开发中，请使用API或数据库直接操作', 'info');
    }
    
    function viewSchemeDetails(schemeId) {
      // 待实现：查看方案详情
      showToast('查看详情功能开发中...', 'info');
    }
    
    async function deleteRewardScheme(schemeId) {
      if (!confirm('确定要删除此奖励方案吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('方案已删除', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除奖励方案失败:', error);
        showToast('删除失败', 'error');
      }
    }
    
    function closeRewardSchemeModal() {
      const modal = document.getElementById('rewardSchemeModal');
      if (modal) modal.remove();
    }

    // ========== 权重配置管理功能 ==========
    
    async function loadWeightConfigs() {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (data.success) {
          renderWeightConfigsTable(data.data);
        }
      } catch (error) {
        console.error('加载权重配置失败:', error);
        showToast('加载权重配置失败', 'error');
      }
    }
    
    function renderWeightConfigsTable(configs) {
      const tbody = document.getElementById('weightConfigsTableBody');
      
      if (!configs || configs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">暂无权重配置</td></tr>';
        return;
      }
      
      tbody.innerHTML = configs.map(config => {
        const usageText = config.usage_count > 0 ? `被 ${config.usage_count} 个场次使用` : '未使用';
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${config.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${config.config_name}</td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${config.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="showEditWeightConfigModal(${config.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">编辑</button>
              <button onclick="viewWeightConfigDetails(${config.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-semibold mr-1">详情</button>
              ${config.usage_count === 0 ? `
                <button onclick="deleteWeightConfig(${config.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">删除</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddWeightConfigModal() {
      const modalHtml = `
        <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <h3 class="text-xl font-bold text-slate-900 mb-4">➕ 添加权重配置</h3>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">配置名称 *</label>
                  <input type="text" id="weightConfigName" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：周末活动配置">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">配置描述</label>
                  <textarea id="weightConfigDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="简要描述这个配置的特点"></textarea>
                </div>
                
                <div class="border-t pt-4">
                  <h4 class="font-semibold text-slate-900 mb-3">符号权重设置</h4>
                  <div class="grid grid-cols-3 gap-3">
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">🎵 美(m)</label>
                      <input type="number" id="weight_m_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">⚡ 太(t)</label>
                      <input type="number" id="weight_t_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">👀 你(n)</label>
                      <input type="number" id="weight_n_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">🐔 鸡(j)</label>
                      <input type="number" id="weight_j_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">🏀 篮球(lq)</label>
                      <input type="number" id="weight_lq_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">🎬 背景(bj)</label>
                      <input type="number" id="weight_bj_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">💇 中分头(zft)</label>
                      <input type="number" id="weight_zft_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">👖 背带裤(bdk)</label>
                      <input type="number" id="weight_bdk_new" value="100" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded text-sm">
                    </div>
                    <div>
                      <label class="block text-xs text-slate-600 mb-1">⚖️ 律师函(lsh)</label>
                      <input type="number" id="weight_lsh_new" value="25" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded text-sm bg-red-50">
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">取消</button>
                <button onclick="saveNewWeightConfig()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">保存</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewWeightConfig() {
      const name = document.getElementById('weightConfigName').value.trim();
      const desc = document.getElementById('weightConfigDesc').value.trim();
      
      if (!name) {
        showToast('请输入配置名称', 'error');
        return;
      }
      
      const config = {
        config_name: name,
        weight_m: parseInt(document.getElementById('weight_m_new').value),
        weight_t: parseInt(document.getElementById('weight_t_new').value),
        weight_n: parseInt(document.getElementById('weight_n_new').value),
        weight_j: parseInt(document.getElementById('weight_j_new').value),
        weight_lq: parseInt(document.getElementById('weight_lq_new').value),
        weight_bj: parseInt(document.getElementById('weight_bj_new').value),
        weight_zft: parseInt(document.getElementById('weight_zft_new').value),
        weight_bdk: parseInt(document.getElementById('weight_bdk_new').value),
        weight_lsh: parseInt(document.getElementById('weight_lsh_new').value),
        description: desc
      };
      
      try {
        const res = await fetch('/api/admin/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('权重配置已添加', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(data.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加权重配置失败:', error);
        showToast('添加失败', 'error');
      }
    }
    
    function closeWeightConfigModal() {
      const modal = document.getElementById('weightConfigModal');
      if (modal) modal.remove();
    }
    
    async function showEditWeightConfigModal(configId) {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载配置失败', 'error');
          return;
        }
        
        const config = data.data.find(c => c.id === configId);
        if (!config) {
          showToast('配置不存在', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">✏️ 编辑权重配置</h3>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">配置名称 *</label>
                    <input type="text" id="editWeightConfigName" value="${config.config_name}" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：周末活动配置">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">配置描述</label>
                    <textarea id="editWeightConfigDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="简要描述这个配置的特点">${config.description || ''}</textarea>
                  </div>
                  
                  <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">符号权重设置</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                      <div>
                        <label class="text-xs text-slate-600">🎵 美 (m)</label>
                        <input type="number" id="editWeight_m" value="${config.weight_m}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">⚡ 太 (t)</label>
                        <input type="number" id="editWeight_t" value="${config.weight_t}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">👀 你 (n)</label>
                        <input type="number" id="editWeight_n" value="${config.weight_n}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">🐔 鸡 (j)</label>
                        <input type="number" id="editWeight_j" value="${config.weight_j}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">🏀 篮球 (lq)</label>
                        <input type="number" id="editWeight_lq" value="${config.weight_lq}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">🎬 背景 (bj)</label>
                        <input type="number" id="editWeight_bj" value="${config.weight_bj}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">💇 中分头 (zft)</label>
                        <input type="number" id="editWeight_zft" value="${config.weight_zft}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">👖 背带裤 (bdk)</label>
                        <input type="number" id="editWeight_bdk" value="${config.weight_bdk}" min="1" max="1000" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                      </div>
                      <div>
                        <label class="text-xs text-slate-600">⚖️ 律师函 (lsh)</label>
                        <input type="number" id="editWeight_lsh" value="${config.weight_lsh}" min="1" max="1000" class="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50 text-sm">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">取消</button>
                  <button onclick="saveEditWeightConfig(${configId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">保存修改</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载配置失败:', error);
        showToast('加载配置失败', 'error');
      }
    }
    
    async function saveEditWeightConfig(configId) {
      const configName = document.getElementById('editWeightConfigName').value.trim();
      if (!configName) {
        showToast('请输入配置名称', 'error');
        return;
      }
      
      const data = {
        config_name: configName,
        description: document.getElementById('editWeightConfigDesc').value.trim(),
        weight_m: parseInt(document.getElementById('editWeight_m').value),
        weight_t: parseInt(document.getElementById('editWeight_t').value),
        weight_n: parseInt(document.getElementById('editWeight_n').value),
        weight_j: parseInt(document.getElementById('editWeight_j').value),
        weight_lq: parseInt(document.getElementById('editWeight_lq').value),
        weight_bj: parseInt(document.getElementById('editWeight_bj').value),
        weight_zft: parseInt(document.getElementById('editWeight_zft').value),
        weight_bdk: parseInt(document.getElementById('editWeight_bdk').value),
        weight_lsh: parseInt(document.getElementById('editWeight_lsh').value)
      };
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
          showToast('配置已更新', 'success');
          closeWeightConfigModal();
          loadWeightConfigs();
        } else {
          showToast(result.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新权重配置失败:', error);
        showToast('更新失败', 'error');
      }
    }
    
    async function viewWeightConfigDetails(configId) {
      try {
        const res = await fetch('/api/admin/weights');
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载配置失败', 'error');
          return;
        }
        
        const config = data.data.find(c => c.id === configId);
        if (!config) {
          showToast('配置不存在', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="weightConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">📊 权重配置详情</h3>
                
                <div class="space-y-4">
                  <div class="bg-slate-50 rounded-lg p-4">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div>
                        <span class="text-slate-600">配置ID：</span>
                        <span class="font-mono font-semibold text-slate-900">#${config.id}</span>
                      </div>
                      <div>
                        <span class="text-slate-600">配置名称：</span>
                        <span class="font-semibold text-slate-900">${config.config_name}</span>
                      </div>
                      <div class="col-span-2">
                        <span class="text-slate-600">描述：</span>
                        <span class="text-slate-900">${config.description || '无'}</span>
                      </div>
                      <div>
                        <span class="text-slate-600">使用场次：</span>
                        <span class="font-semibold ${config.usage_count > 0 ? 'text-green-600' : 'text-slate-400'}">${config.usage_count > 0 ? config.usage_count + '个场次' : '未使用'}</span>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-sm font-bold text-slate-900 mb-3">符号权重明细</h4>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">🎵 美 (m)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_m}</div>
                      </div>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">⚡ 太 (t)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_t}</div>
                      </div>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="text-xs text-blue-600 mb-1">👀 你 (n)</div>
                        <div class="text-lg font-bold text-blue-900">${config.weight_n}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">🐔 鸡 (j)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_j}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">🏀 篮球 (lq)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_lq}</div>
                      </div>
                      <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="text-xs text-purple-600 mb-1">🎬 背景 (bj)</div>
                        <div class="text-lg font-bold text-purple-900">${config.weight_bj}</div>
                      </div>
                      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div class="text-xs text-amber-600 mb-1">💇 中分头 (zft)</div>
                        <div class="text-lg font-bold text-amber-900">${config.weight_zft}</div>
                      </div>
                      <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div class="text-xs text-amber-600 mb-1">👖 背带裤 (bdk)</div>
                        <div class="text-lg font-bold text-amber-900">${config.weight_bdk}</div>
                      </div>
                      <div class="bg-red-50 border border-red-300 rounded-lg p-3">
                        <div class="text-xs text-red-600 mb-1">⚖️ 律师函 (lsh)</div>
                        <div class="text-lg font-bold text-red-900">${config.weight_lsh}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeWeightConfigModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">关闭</button>
                  <button onclick="closeWeightConfigModal(); showEditWeightConfigModal(${configId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">编辑配置</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载配置详情失败:', error);
        showToast('加载详情失败', 'error');
      }
    }
    
    async function deleteWeightConfig(configId) {
      if (!confirm('确定要删除此权重配置吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/weights/${configId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('配置已删除', 'success');
          loadWeightConfigs();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除权重配置失败:', error);
        showToast('删除失败', 'error');
      }
    }
    
    // ========== 奖励配置管理功能 ==========
    
    async function loadRewardConfigs() {
      try {
        const res = await fetch('/api/admin/rewards/schemes');
        const data = await res.json();
        
        if (data.success) {
          renderRewardSchemesTable(data.data);
        }
      } catch (error) {
        console.error('加载奖励配置失败:', error);
        showToast('加载奖励配置失败', 'error');
      }
    }
    
    function renderRewardSchemesTable(schemes) {
      const tbody = document.getElementById('rewardSchemesTableBody');
      
      if (!schemes || schemes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">暂无奖励方案</td></tr>';
        return;
      }
      
      tbody.innerHTML = schemes.map(scheme => {
        const usageText = scheme.usage_count > 0 ? `被 ${scheme.usage_count} 个场次使用` : '未使用';
        
        return `
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="px-4 py-3 font-mono text-slate-600">#${scheme.id}</td>
            <td class="px-4 py-3 font-semibold text-slate-900">${scheme.scheme_name}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">${scheme.rules_count}条</span>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">${usageText}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${scheme.description || '-'}</td>
            <td class="px-4 py-3 text-center">
              <button onclick="editRewardScheme(${scheme.id})" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-semibold mr-1">编辑</button>
              <button onclick="viewRewardSchemeDetails(${scheme.id})" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-semibold mr-1">详情</button>
              ${scheme.usage_count === 0 ? `
                <button onclick="deleteRewardScheme(${scheme.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-semibold">删除</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function showAddRewardSchemeModal() {
      const modalHtml = `
        <div id="rewardSchemeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
              <h3 class="text-xl font-bold text-slate-900 mb-4">➕ 添加奖励方案</h3>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">方案名称 *</label>
                  <input type="text" id="rewardSchemeName" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：初级场标准">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">方案描述</label>
                  <textarea id="rewardSchemeDesc" class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="2" placeholder="简要描述这个方案的特点"></textarea>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeRewardSchemeModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">取消</button>
                <button onclick="saveNewRewardScheme()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">创建</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function saveNewRewardScheme() {
      const name = document.getElementById('rewardSchemeName').value.trim();
      const desc = document.getElementById('rewardSchemeDesc').value.trim();
      
      if (!name) {
        showToast('请输入方案名称', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/schemes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scheme_name: name, description: desc })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('奖励方案已创建，现在可以添加规则', 'success');
          closeRewardSchemeModal();
          loadRewardConfigs();
        } else {
          showToast(data.message || '创建失败', 'error');
        }
      } catch (error) {
        console.error('创建奖励方案失败:', error);
        showToast('创建失败', 'error');
      }
    }
    
    function closeRewardSchemeModal() {
      const modal = document.getElementById('rewardSchemeModal');
      if (modal) modal.remove();
    }
    
    async function editRewardScheme(schemeId) {
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载方案失败', 'error');
          return;
        }
        
        const { scheme, rules, punishments } = data.data;
        const safePunishments = punishments || [];
        
        const modalHtml = `
          <div id="rewardSchemeEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 border-b border-slate-200 z-10">
                <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">✏️ 编辑奖励方案：${scheme.scheme_name}</h3>
                  <button onclick="closeRewardSchemeEditModal()" class="text-white hover:text-slate-200 text-2xl font-bold">&times;</button>
                </div>
              </div>
              
              <div class="p-6">
                <!-- 基础信息 -->
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-5">
                  <h4 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="text-2xl">📝</span>
                    基础信息
                  </h4>
                  <div class="grid grid-cols-1 gap-4 bg-white p-4 rounded-lg border border-slate-200">
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-2">方案名称 *</label>
                      <input type="text" id="editSchemeName" value="${scheme.scheme_name}" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-700 mb-2">方案描述</label>
                      <textarea id="editSchemeDesc" rows="2" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">${scheme.description || ''}</textarea>
                    </div>
                  </div>
                  <button onclick="updateSchemeBasicInfo(${schemeId})" class="mt-3 px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all">
                    💾 保存基础信息
                  </button>
                </div>
                
                <!-- 规则列表 -->
                <div class="mb-6">
                  <div class="flex justify-between items-center mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border-2 border-indigo-200">
                    <h4 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                      <span class="text-2xl">🎯</span>
                      中奖规则 
                      <span class="px-3 py-1 bg-indigo-500 text-white rounded-full text-sm">${rules.length}条</span>
                    </h4>
                    <button onclick="showAddRuleModal(${schemeId})" class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all hover:scale-105">
                      ➕ 添加规则
                    </button>
                  </div>
                  
                  <div class="space-y-3" id="rulesList">
                    ${rules.length === 0 ? '<div class="text-center py-8 text-slate-500 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">暂无规则，点击"➕ 添加规则"从预设模板中选择</div>' : rules.map(rule => `
                      <div class="bg-gradient-to-r from-slate-50 to-indigo-50 border-2 border-indigo-200 rounded-lg p-4 hover:shadow-lg transition-all hover:border-indigo-400">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-3">
                              <span class="text-lg font-bold text-slate-900">${rule.rule_name}</span>
                              <span class="px-2 py-1 text-xs rounded font-semibold ${rule.is_active ? 'bg-green-500 text-white' : 'bg-slate-400 text-white'}">${rule.is_active ? '✓ 启用' : '✗ 禁用'}</span>
                              ${rule.rule_category === 'jackpot' ? '<span class="px-2 py-1 text-xs rounded bg-yellow-500 text-white font-semibold">🏆 大奖</span>' : ''}
                              ${rule.rule_category === 'high' ? '<span class="px-2 py-1 text-xs rounded bg-purple-500 text-white font-semibold">💎 高级</span>' : ''}
                              ${rule.rule_category === 'medium' ? '<span class="px-2 py-1 text-xs rounded bg-blue-500 text-white font-semibold">🎯 中等</span>' : ''}
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                              <div class="flex items-center gap-2">
                                <span class="text-slate-500">模式：</span>
                                <span class="font-mono text-slate-900 bg-white px-2 py-0.5 rounded border">${rule.match_pattern}</span>
                              </div>
                              ${rule.match_count ? `<div class="flex items-center gap-2"><span class="text-slate-500">匹配数：</span><span class="font-semibold text-slate-900">${rule.match_count}</span></div>` : ''}
                              ${rule.required_symbols ? `<div class="flex items-center gap-2"><span class="text-slate-500">符号：</span><span class="font-mono text-indigo-700 bg-white px-2 py-0.5 rounded border">${rule.required_symbols}</span></div>` : ''}
                              <div class="flex items-center gap-2">
                                <span class="text-slate-500">倍率：</span>
                                <span class="font-bold text-green-600 text-lg bg-green-50 px-2 py-0.5 rounded">${rule.win_multiplier}x</span>
                              </div>
                              ${rule.grant_free_spin > 0 ? `<div class="flex items-center gap-2"><span class="text-slate-500">免费转：</span><span class="font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded">+${rule.grant_free_spin}次</span></div>` : ''}
                              ${rule.priority ? `<div class="flex items-center gap-2"><span class="text-slate-500">优先级：</span><span class="font-semibold text-purple-700">${rule.priority}</span></div>` : ''}
                            </div>
                            ${rule.description ? `<div class="text-xs text-slate-600 italic mt-2 bg-white px-3 py-1 rounded border border-slate-200">${rule.description}</div>` : ''}
                          </div>
                          <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editRule(${rule.id}, ${schemeId})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-semibold transition-colors whitespace-nowrap">✏️ 编辑</button>
                            <button onclick="deleteRule(${rule.id}, ${schemeId})" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-semibold transition-colors whitespace-nowrap">🗑️ 删除</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- 律师函惩罚配置 -->
                <div class="mb-6">
                  <div class="flex justify-between items-center mb-4 bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border-2 border-red-200">
                    <h4 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                      <span class="text-2xl">⚖️</span>
                      律师函惩罚配置
                      <span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm">${safePunishments.length}项</span>
                    </h4>
                    <button onclick="applyDefaultPunishment(${schemeId})" class="px-5 py-2 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg hover:shadow-lg text-sm font-semibold transition-all hover:scale-105">
                      ⚡ 应用默认惩罚
                    </button>
                  </div>
                  
                  <div id="punishmentConfigList" class="space-y-2">
                    ${safePunishments.length === 0 ? '<div class="text-center py-8 text-slate-500 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">暂无律师函惩罚配置，点击"⚡ 应用默认惩罚"快速添加</div>' : safePunishments.map(p => `
                      <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-md transition-all">
                        <div class="flex justify-between items-center">
                          <div class="flex-1 flex items-center gap-3">
                            <span class="text-2xl">⚖️</span>
                            <div>
                              <div class="font-bold text-red-900 text-lg">${p.lsh_count}个律师函</div>
                              <div class="text-sm text-slate-600 mt-1">
                                扣除 <span class="font-bold text-red-700">${p.deduct_multiplier}倍</span> 投注额
                                ${p.ban_hours > 0 ? `<span class="ml-2 px-2 py-0.5 bg-orange-500 text-white rounded text-xs">🔒 封禁${p.ban_hours}小时</span>` : '<span class="ml-2 px-2 py-0.5 bg-green-500 text-white rounded text-xs">✓ 不封禁</span>'}
                              </div>
                            </div>
                          </div>
                          <div class="flex gap-2">
                            <button onclick="editPunishment(${p.lsh_count}, ${p.deduct_multiplier}, ${p.ban_hours}, ${schemeId})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-colors">✏️ 编辑</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6 sticky bottom-0 bg-gradient-to-r from-slate-50 to-slate-100 pt-4 pb-2 border-t-2 border-slate-300 rounded-b-xl">
                  <button onclick="closeRewardSchemeEditModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                    ✕ 关闭
                  </button>
                  <button onclick="closeRewardSchemeEditModal(); viewRewardSchemeDetails(${schemeId})" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                    👁️ 查看完整详情
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载方案失败:', error);
        showToast('加载方案失败', 'error');
      }
    }
    
    async function updateSchemeBasicInfo(schemeId) {
      const name = document.getElementById('editSchemeName').value.trim();
      if (!name) {
        showToast('请输入方案名称', 'error');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_name: name,
            description: document.getElementById('editSchemeDesc').value.trim()
          })
        });
        
        const data = await res.json();
        if (data.success) {
          showToast('基础信息已更新', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新方案失败:', error);
        showToast('更新失败', 'error');
      }
    }
    
    function closeRewardSchemeEditModal() {
      const modal = document.getElementById('rewardSchemeEditModal');
      if (modal) modal.remove();
    }
    
    // 默认律师函惩罚配置
    const DEFAULT_PUNISHMENT_CONFIG = [
      { lsh_count: 1, deduct_multiplier: 1, ban_hours: 0 },
      { lsh_count: 2, deduct_multiplier: 2, ban_hours: 0 },
      { lsh_count: 3, deduct_multiplier: 3, ban_hours: 60 },
      { lsh_count: 4, deduct_multiplier: 4, ban_hours: 60 }
    ];
    
    async function applyDefaultPunishment(schemeId) {
      if (!confirm('确定要应用默认律师函惩罚配置吗？\n\n默认配置：\n• 1个律师函：扣1倍，不封禁\n• 2个律师函：扣2倍，不封禁\n• 3个律师函：扣3倍，封禁60小时\n• 4个律师函：扣4倍，封禁60小时')) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/punishments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_id: schemeId,
            punishments: DEFAULT_PUNISHMENT_CONFIG
          })
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('默认惩罚配置已应用', 'success');
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || '应用失败', 'error');
        }
      } catch (error) {
        console.error('应用默认惩罚配置失败:', error);
        showToast('应用失败', 'error');
      }
    }
    
    async function editPunishment(lshCount, deductMultiplier, banHours, schemeId) {
      const modalHtml = `
        <div id="editPunishmentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4 backdrop-blur-sm">
          <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-fadeIn">
            <div class="bg-gradient-to-r from-red-600 via-orange-600 to-red-600 p-6 border-b border-slate-200">
              <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                  ⚖️ 编辑律师函惩罚
                </h3>
                <button onclick="closeEditPunishmentModal()" class="text-white hover:text-slate-200 text-3xl font-bold transition-colors">&times;</button>
            </div>
              </div>
            <div class="p-6 space-y-5">
              <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">⚠️</span>
                <div>
                    <p class="text-sm font-semibold text-amber-900">配置惩罚参数</p>
                    <p class="text-xs text-amber-800 mt-1">当玩家抽到 <strong class="text-red-700">${lshCount}个律师函</strong> 时触发以下惩罚</p>
                </div>
                </div>
              </div>
              
              <div class="bg-slate-50 p-4 rounded-xl border-2 border-slate-200">
                <label class="block text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                  <span class="text-xl">💸</span>
                  扣除倍率 *
                </label>
                <div class="flex items-center gap-3">
                  <input type="number" id="editPunishmentMultiplier" value="${deductMultiplier}" min="0" step="0.1" class="flex-1 px-4 py-3 border-2 border-slate-300 rounded-lg text-lg font-bold focus:border-red-500 focus:ring-2 focus:ring-red-200 transition-all">
                  <span class="text-lg font-semibold text-slate-600">倍</span>
                </div>
                <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                  <span>💡</span>
                  例如：设置为 <strong>1</strong> 表示扣除 <strong>1倍</strong> 投注额
                </p>
              </div>
              
              <div class="bg-slate-50 p-4 rounded-xl border-2 border-slate-200">
                <label class="block text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                  <span class="text-xl">🔒</span>
                  封禁时长（小时）
                </label>
                <div class="flex items-center gap-3">
                  <input type="number" id="editPunishmentBanHours" value="${banHours}" min="0" step="1" class="flex-1 px-4 py-3 border-2 border-slate-300 rounded-lg text-lg font-bold focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all">
                  <span class="text-lg font-semibold text-slate-600">小时</span>
                </div>
                <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                  <span>💡</span>
                  <strong>0</strong> 表示不封禁，建议 <strong>3-4个律师函</strong> 设置 <strong class="text-orange-600">60小时</strong>
                </p>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeEditPunishmentModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  ✕ 取消
                </button>
                <button onclick="savePunishmentEdit(${lshCount}, ${schemeId})" class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  💾 保存
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function savePunishmentEdit(lshCount, schemeId) {
      const deductMultiplier = parseFloat(document.getElementById('editPunishmentMultiplier').value);
      const banHours = parseInt(document.getElementById('editPunishmentBanHours').value) || 0;
      
      if (isNaN(deductMultiplier) || deductMultiplier < 0) {
        showToast('请输入有效的扣除倍率', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/rewards/punishments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scheme_id: schemeId,
            punishments: [{ lsh_count: lshCount, deduct_multiplier: deductMultiplier, ban_hours: banHours, is_active: 1 }]
          })
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('惩罚配置已更新', 'success');
          closeEditPunishmentModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新惩罚配置失败:', error);
        showToast('更新失败', 'error');
      }
    }
    
    function closeEditPunishmentModal() {
      const modal = document.getElementById('editPunishmentModal');
      if (modal) modal.remove();
    }
    
    // 预设规则模板
    const RULE_TEMPLATES = [
      {
        id: 'jntm_sequence',
        name: '🎯 按顺序JNTM',
        description: '必须按照 j→n→t→m 顺序出现',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'sequence',
        required_symbols: 'j,n,t,m',
        match_count: 4,
        win_multiplier: 256,
        grant_free_spin: 0,
        priority: 100,
        emoji: '🎯'
      },
      {
        id: 'jntm_any',
        name: '⭐ 不按顺序JNTM',
        description: '包含 j、n、t、m 四个符号即可，顺序不限',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'combination',
        required_symbols: 'j,n,t,m',
        match_count: 4,
        win_multiplier: 16,
        grant_free_spin: 0,
        priority: 90,
        emoji: '⭐'
      },
      {
        id: 'bzlq_sequence',
        name: '🔥 按顺序BJ→ZFT→BDK→LQ',
        description: '必须按照 bj→zft→bdk→lq 顺序出现',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'sequence',
        required_symbols: 'bj,zft,bdk,lq',
        match_count: 4,
        win_multiplier: 256,
        grant_free_spin: 0,
        priority: 100,
        emoji: '🔥'
      },
      {
        id: 'bzlq_any',
        name: '💫 不按顺序BJ→ZFT→BDK→LQ',
        description: '包含 bj、zft、bdk、lq 四个符号即可',
        category: 'jackpot',
        rule_type: 'match',
        match_pattern: 'combination',
        required_symbols: 'bj,zft,bdk,lq',
        match_count: 4,
        win_multiplier: 16,
        grant_free_spin: 0,
        priority: 90,
        emoji: '💫'
      },
      {
        id: '4_consecutive',
        name: '🎁 普通4连',
        description: '任意4个相同符号连续出现',
        category: 'high',
        rule_type: 'match',
        match_pattern: '4-consecutive',
        required_symbols: null,
        match_count: 4,
        win_multiplier: 32,
        grant_free_spin: 1,
        priority: 80,
        emoji: '🎁'
      },
      {
        id: '3_consecutive_strict',
        name: '💎 严格3连',
        description: '任意3个相同符号连续出现（严格相邻）',
        category: 'medium',
        rule_type: 'match',
        match_pattern: '3-consecutive',
        required_symbols: null,
        match_count: 3,
        win_multiplier: 12,
        grant_free_spin: 0,
        priority: 70,
        emoji: '💎'
      },
      {
        id: '3_any',
        name: '🎲 普通3连',
        description: '任意3个相同符号（位置不限）',
        category: 'medium',
        rule_type: 'match',
        match_pattern: '3-any',
        required_symbols: null,
        match_count: 3,
        win_multiplier: 8,
        grant_free_spin: 0,
        priority: 60,
        emoji: '🎲'
      },
      {
        id: 'double_pair',
        name: '🎰 两对2连',
        description: '两对不同的相同符号',
        category: 'normal',
        rule_type: 'match',
        match_pattern: 'double_pair',
        required_symbols: null,
        match_count: 4,
        win_multiplier: 5,
        grant_free_spin: 0,
        priority: 50,
        emoji: '🎰'
      },
      {
        id: '2_consecutive',
        name: '🌟 严格2连',
        description: '任意2个相同符号连续出现',
        category: 'normal',
        rule_type: 'match',
        match_pattern: '2-consecutive',
        required_symbols: null,
        match_count: 2,
        win_multiplier: 3,
        grant_free_spin: 0,
        priority: 40,
        emoji: '🌟'
      },
      {
        id: '2_any',
        name: '✨ 普通2连',
        description: '任意2个相同符号（位置不限）',
        category: 'normal',
        rule_type: 'match',
        match_pattern: '2-any',
        required_symbols: null,
        match_count: 2,
        win_multiplier: 2,
        grant_free_spin: 0,
        priority: 30,
        emoji: '✨'
      }
    ];

    async function showAddRuleModal(schemeId) {
      const modalHtml = `
        <div id="addRuleModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4 overflow-y-auto backdrop-blur-sm">
          <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto my-8 animate-fadeIn">
            <div class="sticky top-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6 border-b border-slate-200 z-10">
              <div class="flex justify-between items-center">
              <div>
                  <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                    ✨ 选择预设规则模板
                  </h3>
                  <p class="text-indigo-100 text-sm mt-1">一键添加，无需手动配置复杂参数</p>
                </div>
                <button onclick="closeAddRuleModal()" class="text-white hover:text-slate-200 text-3xl font-bold transition-colors">&times;</button>
              </div>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                ${RULE_TEMPLATES.map(template => `
                  <div class="relative bg-gradient-to-br from-white to-slate-50 border-2 border-slate-200 rounded-xl p-5 hover:border-indigo-500 hover:shadow-2xl transition-all cursor-pointer group transform hover:-translate-y-1" onclick="selectRuleTemplate('${template.id}', ${schemeId})">
                    <div class="absolute top-3 right-3 text-4xl opacity-20 group-hover:opacity-40 transition-opacity">${template.emoji}</div>
                    <div class="flex items-start gap-4">
                      <div class="text-4xl group-hover:scale-110 transition-transform">${template.emoji}</div>
                      <div class="flex-1">
                        <h4 class="font-bold text-lg text-slate-900 group-hover:text-indigo-600 mb-2 transition-colors">${template.name}</h4>
                        <p class="text-sm text-slate-600 mb-3 leading-relaxed">${template.description}</p>
                        <div class="flex flex-wrap gap-2">
                          <span class="px-3 py-1 bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 rounded-full text-xs font-semibold shadow-sm">
                            🎯 优先级 ${template.priority}
                          </span>
                          <span class="px-3 py-1 bg-gradient-to-r from-green-100 to-green-200 text-green-800 rounded-full text-xs font-bold shadow-sm">
                            💰 倍率 ${template.win_multiplier}x
                          </span>
                          ${template.grant_free_spin > 0 ? `<span class="px-3 py-1 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 rounded-full text-xs font-semibold shadow-sm">🎁 +${template.grant_free_spin}次免费</span>` : ''}
                        </div>
                      </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-200 text-center">
                      <span class="text-xs text-slate-500 group-hover:text-indigo-600 font-medium transition-colors">点击添加 →</span>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div class="mt-6 p-5 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl">
                <div class="flex items-start gap-3">
                  <span class="text-2xl">💡</span>
              <div>
                    <p class="text-sm text-amber-900 font-semibold mb-1">使用提示</p>
                    <ul class="text-sm text-amber-800 space-y-1">
                      <li>• 点击任意模板卡片即可快速添加到方案中</li>
                      <li>• 添加后可在规则列表中编辑倍率、优先级等参数</li>
                      <li>• 同一模板可以添加多次并设置不同参数</li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button onclick="closeAddRuleModal()" class="flex-1 px-6 py-3 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all hover:shadow-lg">
                  ✕ 取消
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    async function selectRuleTemplate(templateId, schemeId) {
      const template = RULE_TEMPLATES.find(t => t.id === templateId);
      if (!template) {
        showToast('模板不存在', 'error');
        return;
      }
      
      const data = {
        scheme_id: schemeId,
        rule_name: template.name,
        rule_type: template.rule_type,
        rule_category: template.category,
        match_pattern: template.match_pattern,
        match_count: template.match_count,
        required_symbols: template.required_symbols,
        win_multiplier: template.win_multiplier,
        grant_free_spin: template.grant_free_spin,
        priority: template.priority,
        description: template.description
      };
      
      try {
        const res = await fetch('/api/admin/rewards/rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('规则已添加', 'success');
          closeAddRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加规则失败:', error);
        showToast('添加失败', 'error');
      }
    }
    
    async function saveNewRule(schemeId) {
      const ruleName = document.getElementById('newRuleName').value.trim();
      const matchPattern = document.getElementById('newMatchPattern').value.trim();
      const winMultiplier = parseFloat(document.getElementById('newWinMultiplier').value);
      
      if (!ruleName || !matchPattern || isNaN(winMultiplier)) {
        showToast('请填写必填字段', 'error');
        return;
      }
      
      const data = {
        scheme_id: schemeId,
        rule_name: ruleName,
        rule_type: document.getElementById('newRuleType').value,
        rule_category: document.getElementById('newRuleCategory').value || null,
        match_pattern: matchPattern,
        match_count: parseInt(document.getElementById('newMatchCount').value) || null,
        required_symbols: document.getElementById('newRequiredSymbols').value.trim() || null,
        win_multiplier: winMultiplier,
        grant_free_spin: parseInt(document.getElementById('newGrantFreeSpin').value) || 0,
        description: document.getElementById('newRuleDescription').value.trim() || null
      };
      
      try {
        const res = await fetch('/api/admin/rewards/rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('规则已添加', 'success');
          closeAddRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加规则失败:', error);
        showToast('添加失败', 'error');
      }
    }
    
    function closeAddRuleModal() {
      const modal = document.getElementById('addRuleModal');
      if (modal) modal.remove();
    }
    
    async function editRule(ruleId, schemeId) {
      // 获取规则详情并打开编辑对话框
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        if (!data.success) {
          showToast('加载规则失败', 'error');
          return;
        }
        
        const rule = data.data.rules.find(r => r.id === ruleId);
        if (!rule) {
          showToast('规则不存在', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="editRuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="p-6 border-b border-slate-200 bg-blue-600">
                <h3 class="text-xl font-bold text-white">✏️ 编辑规则</h3>
              </div>
              <div class="p-6 space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">规则名称 *</label>
                  <input type="text" id="editRuleName" value="${rule.rule_name}" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">规则类型 *</label>
                    <select id="editRuleType" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      <option value="match" ${rule.rule_type === 'match' ? 'selected' : ''}>匹配规则</option>
                      <option value="scatter" ${rule.rule_type === 'scatter' ? 'selected' : ''}>分散规则</option>
                      <option value="bonus" ${rule.rule_type === 'bonus' ? 'selected' : ''}>奖励规则</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">规则分类</label>
                    <select id="editRuleCategory" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      <option value="">无</option>
                      <option value="normal" ${rule.rule_category === 'normal' ? 'selected' : ''}>普通奖励</option>
                      <option value="medium" ${rule.rule_category === 'medium' ? 'selected' : ''}>中等奖励</option>
                      <option value="high" ${rule.rule_category === 'high' ? 'selected' : ''}>高级奖励</option>
                      <option value="jackpot" ${rule.rule_category === 'jackpot' ? 'selected' : ''}>大奖</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">匹配模式 *</label>
                  <input type="text" id="editMatchPattern" value="${rule.match_pattern}" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">匹配数量</label>
                    <input type="number" id="editMatchCount" value="${rule.match_count || ''}" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">中奖倍率 *</label>
                    <input type="number" id="editWinMultiplier" value="${rule.win_multiplier}" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">必需符号</label>
                  <input type="text" id="editRequiredSymbols" value="${rule.required_symbols || ''}" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">赠送免费转</label>
                    <input type="number" id="editGrantFreeSpin" value="${rule.grant_free_spin}" min="0" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">启用状态</label>
                    <select id="editRuleActive" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      <option value="1" ${rule.is_active ? 'selected' : ''}>启用</option>
                      <option value="0" ${!rule.is_active ? 'selected' : ''}>禁用</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">规则描述</label>
                  <textarea id="editRuleDescription" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg">${rule.description || ''}</textarea>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeEditRuleModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">取消</button>
                  <button onclick="saveEditRule(${ruleId}, ${schemeId})" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">保存修改</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载规则失败:', error);
        showToast('加载规则失败', 'error');
      }
    }
    
    async function saveEditRule(ruleId, schemeId) {
      const ruleName = document.getElementById('editRuleName').value.trim();
      const matchPattern = document.getElementById('editMatchPattern').value.trim();
      const winMultiplier = parseFloat(document.getElementById('editWinMultiplier').value);
      
      if (!ruleName || !matchPattern || isNaN(winMultiplier)) {
        showToast('请填写必填字段', 'error');
        return;
      }
      
      const data = {
        rule_name: ruleName,
        rule_type: document.getElementById('editRuleType').value,
        rule_category: document.getElementById('editRuleCategory').value || null,
        match_pattern: matchPattern,
        match_count: parseInt(document.getElementById('editMatchCount').value) || null,
        required_symbols: document.getElementById('editRequiredSymbols').value.trim() || null,
        win_multiplier: winMultiplier,
        grant_free_spin: parseInt(document.getElementById('editGrantFreeSpin').value) || 0,
        is_active: parseInt(document.getElementById('editRuleActive').value),
        description: document.getElementById('editRuleDescription').value.trim() || null
      };
      
      try {
        const res = await fetch(`/api/admin/rewards/rules/${ruleId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
          showToast('规则已更新', 'success');
          closeEditRuleModal();
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(result.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新规则失败:', error);
        showToast('更新失败', 'error');
      }
    }
    
    function closeEditRuleModal() {
      const modal = document.getElementById('editRuleModal');
      if (modal) modal.remove();
    }
    
    async function deleteRule(ruleId, schemeId) {
      if (!confirm('确定要删除此规则吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/rules/${ruleId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        if (data.success) {
          showToast('规则已删除', 'success');
          closeRewardSchemeEditModal();
          editRewardScheme(schemeId);
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除规则失败:', error);
        showToast('删除失败', 'error');
      }
    }
    
    async function viewRewardSchemeDetails(schemeId) {
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`);
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载方案详情失败', 'error');
          return;
        }
        
        const { scheme, rules, punishments } = data.data;
        
        const modalHtml = `
          <div id="rewardSchemeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto my-8">
              <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 p-6 border-b border-slate-200 z-10">
                <h3 class="text-xl font-bold text-white">📊 奖励方案详情</h3>
              </div>
              
              <div class="p-6">
                <!-- 基础信息 -->
                <div class="bg-slate-50 rounded-lg p-4 mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">基础信息</h4>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><span class="text-slate-600">方案ID：</span><span class="font-mono font-semibold">#${scheme.id}</span></div>
                    <div><span class="text-slate-600">方案名称：</span><span class="font-semibold">${scheme.scheme_name}</span></div>
                    <div class="col-span-2"><span class="text-slate-600">描述：</span><span>${scheme.description || '无'}</span></div>
                  </div>
                </div>
                
                <!-- 规则统计 -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                  <h4 class="font-bold text-blue-900 mb-3">📋 规则统计</h4>
                  <div class="grid grid-cols-3 gap-3 text-sm">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-blue-600">${rules.length}</div>
                      <div class="text-blue-700">总规则数</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-green-600">${rules.filter(r => r.is_active).length}</div>
                      <div class="text-green-700">启用规则</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-slate-400">${rules.filter(r => !r.is_active).length}</div>
                      <div class="text-slate-600">禁用规则</div>
                    </div>
                  </div>
                </div>
                
                <!-- 详细规则列表 -->
                <div class="mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">🎯 详细规则列表</h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${rules.length === 0 ? '<div class="text-center py-6 text-slate-500 bg-slate-50 rounded-lg">暂无规则</div>' : rules.map(rule => `
                      <div class="bg-white border border-slate-200 rounded-lg p-3 text-sm">
                        <div class="flex justify-between items-start mb-2">
                          <span class="font-semibold text-slate-900">${rule.rule_name}</span>
                          <div class="flex gap-1">
                            <span class="px-2 py-0.5 text-xs rounded ${rule.is_active ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}">${rule.is_active ? '启用' : '禁用'}</span>
                            <span class="px-2 py-0.5 text-xs rounded bg-blue-100 text-blue-700">${rule.rule_type}</span>
                          </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-600">
                          <div>模式：<span class="font-mono">${rule.match_pattern}</span></div>
                          <div>倍率：<span class="font-bold text-green-600">${rule.win_multiplier}x</span></div>
                          ${rule.match_count ? `<div>数量：${rule.match_count}</div>` : ''}
                          ${rule.grant_free_spin > 0 ? `<div>免费转：${rule.grant_free_spin}次</div>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- 律师函惩罚配置 -->
                ${punishments && punishments.length > 0 ? `
                <div class="mb-6">
                  <h4 class="font-bold text-slate-900 mb-3">⚖️ 律师函惩罚配置</h4>
                  <div class="space-y-2">
                    ${punishments.map(p => `
                      <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm">
                        <div class="flex justify-between items-center">
                          <div>
                            <span class="font-semibold text-red-900">${p.lsh_count}次律师函</span>
                            <span class="mx-2 text-slate-400">→</span>
                            <span class="text-red-700">倍率×${p.deduct_multiplier}</span>
                            ${p.ban_hours > 0 ? `<span class="ml-2 text-red-600">封禁${p.ban_hours}小时</span>` : ''}
                          </div>
                          <span class="px-2 py-0.5 text-xs rounded ${p.is_active ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}">${p.is_active ? '启用' : '禁用'}</span>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                ` : ''}
                
                <div class="flex gap-3 mt-6 sticky bottom-0 bg-white pt-4 border-t border-slate-200">
                  <button onclick="closeRewardSchemeDetailModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">关闭</button>
                  <button onclick="closeRewardSchemeDetailModal(); editRewardScheme(${schemeId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg font-semibold">编辑方案</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载方案详情失败:', error);
        showToast('加载详情失败', 'error');
      }
    }
    
    function closeRewardSchemeDetailModal() {
      const modal = document.getElementById('rewardSchemeDetailModal');
      if (modal) modal.remove();
    }
    
    async function deleteRewardScheme(schemeId) {
      if (!confirm('确定要删除此奖励方案吗？')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/rewards/schemes/${schemeId}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('方案已删除', 'success');
          loadRewardConfigs();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除奖励方案失败:', error);
        showToast('删除失败', 'error');
      }
    }

    // ========== 至尊场配置管理 ==========
    
    async function loadSupremeConfig() {
      try {
        // 加载权重方案列表（用于下拉选择）
        const weightRes = await fetch('/api/admin/weights');
        const weightData = await weightRes.json();
        
        if (weightData.success) {
          const select = document.getElementById('supremeWeightConfigId');
          select.innerHTML = weightData.data.map(w => 
            `<option value="${w.id}">${w.config_name}${w.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
        }
        
        // 加载奖励方案列表（用于下拉选择）
        const rewardRes = await fetch('/api/admin/rewards/schemes');
        const rewardData = await rewardRes.json();
        
        if (rewardData.success) {
          const select = document.getElementById('supremeRewardSchemeId');
          select.innerHTML = rewardData.data.map(s =>
            `<option value="${s.id}">${s.scheme_name}${s.usage_count > 0 ? ' (使用中)' : ''}</option>`
          ).join('');
        }
        
        // 加载至尊场配置
        const configRes = await fetch('/api/admin/supreme/config');
        const configData = await configRes.json();
        
        if (configData.success && configData.data) {
          const config = configData.data;
          document.getElementById('supremeEnabled').value = config.enabled ? '1' : '0';
          document.getElementById('supremeFragmentsToToken').value = config.fragments_to_token;
          document.getElementById('supremeMaxTokens').value = config.max_tokens_hold;
          // 坤币值转换回显示值（除以500000）
          document.getElementById('supremeMinBet').value = config.min_bet_amount / 500000;
          document.getElementById('supremeMaxBet').value = config.max_bet_amount / 500000;
          document.getElementById('supremeDailyEntry').value = config.daily_entry_limit;
          document.getElementById('supremeDailyBetLimit').value = config.daily_bet_limit / 500000;
          // 设置选中的配置
          if (config.weight_config_id) {
            document.getElementById('supremeWeightConfigId').value = config.weight_config_id;
          }
          if (config.reward_scheme_id) {
            document.getElementById('supremeRewardSchemeId').value = config.reward_scheme_id;
          }
        } else {
          // 使用默认值
          document.getElementById('supremeEnabled').value = '1';
          document.getElementById('supremeFragmentsToToken').value = '10';
          document.getElementById('supremeMaxTokens').value = '3';
          document.getElementById('supremeMinBet').value = '1000';
          document.getElementById('supremeMaxBet').value = '10000';
          document.getElementById('supremeDailyEntry').value = '3';
          document.getElementById('supremeDailyBetLimit').value = '100000';
        }
        
      } catch (error) {
        console.error('加载至尊场配置失败:', error);
        showToast('加载配置失败，将使用默认值', 'warning');
        // 发生错误时使用默认值
        document.getElementById('supremeEnabled').value = '1';
        document.getElementById('supremeFragmentsToToken').value = '10';
        document.getElementById('supremeMaxTokens').value = '3';
        document.getElementById('supremeMinBet').value = '1000';
        document.getElementById('supremeMaxBet').value = '10000';
        document.getElementById('supremeDailyEntry').value = '3';
        document.getElementById('supremeDailyBetLimit').value = '100000';
      }
    }
    
    async function saveSupremeConfig() {
      try {
        const config = {
          enabled: parseInt(document.getElementById('supremeEnabled').value),
          fragments_to_token: parseInt(document.getElementById('supremeFragmentsToToken').value),
          max_tokens_hold: parseInt(document.getElementById('supremeMaxTokens').value),
          min_bet_amount: parseInt(document.getElementById('supremeMinBet').value) * 500000,
          max_bet_amount: parseInt(document.getElementById('supremeMaxBet').value) * 500000,
          daily_entry_limit: parseInt(document.getElementById('supremeDailyEntry').value),
          daily_bet_limit: parseInt(document.getElementById('supremeDailyBetLimit').value) * 500000,
          weight_config_id: parseInt(document.getElementById('supremeWeightConfigId').value),
          reward_scheme_id: parseInt(document.getElementById('supremeRewardSchemeId').value)
        };
        
        // 验证配置
        if (config.min_bet_amount > config.max_bet_amount) {
          showToast('最小下注不能大于最大下注', 'error');
          return;
        }
        
        if (config.fragments_to_token < 1 || config.max_tokens_hold < 1) {
          showToast('碎片和令牌数量必须大于0', 'error');
          return;
        }
        
        const res = await fetch('/api/admin/supreme/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('至尊场配置已保存', 'success');
          loadSupremeConfig(); // 重新加载配置
        } else {
          showToast(data.message || '保存失败', 'error');
        }
      } catch (error) {
        console.error('保存至尊场配置失败:', error);
        showToast('保存失败: ' + error.message, 'error');
      }
    }
    
    // ========== 至尊场记录管理 ==========
    
    async function loadSupremeRecords() {
      try {
        const res = await fetch('/api/admin/supreme/records');
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载记录失败', 'error');
          return;
        }
        
        const tbody = document.getElementById('supremeRecordsTableBody');
        const records = data.data || [];
        
        if (records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">暂无游戏记录</td></tr>';
          return;
        }
        
        tbody.innerHTML = records.map(record => {
          const gameTime = new Date(record.timestamp).toLocaleString('zh-CN');
          const betAmount = (record.bet_amount / 500000).toFixed(2);
          const winAmount = (record.win_amount / 500000).toFixed(2);
          const multiplier = record.win_multiplier;
          const isWin = multiplier > 0;
          const isLoss = multiplier < 0;
          
          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 text-xs text-slate-500 font-mono">${gameTime}</td>
              <td class="px-4 py-3 text-sm">
                <div class="font-semibold text-slate-900">${record.username || '未知用户'}</div>
                ${record.linux_do_username ? `<div class="text-xs text-slate-500">@${record.linux_do_username}</div>` : ''}
              </td>
              <td class="px-4 py-3 text-right font-mono text-sm text-slate-900">$${betAmount}</td>
              <td class="px-4 py-3 text-right font-mono text-sm ${isWin ? 'text-green-600 font-bold' : isLoss ? 'text-red-600 font-bold' : 'text-slate-500'}">
                ${isWin ? '+' : ''}$${winAmount}
              </td>
              <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs font-bold ${isWin ? 'bg-green-100 text-green-700' : isLoss ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'}">
                  ${multiplier}x
                </span>
              </td>
              <td class="px-4 py-3 text-center text-sm">
                <span class="px-2 py-1 rounded bg-purple-100 text-purple-700 text-xs font-semibold">
                  ${record.win_type || '未中奖'}
                </span>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('加载至尊场记录失败:', error);
        const tbody = document.getElementById('supremeRecordsTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">加载失败，请刷新重试</td></tr>';
      }
    }
    
    async function viewSupremeDropDetail(recordId) {
      try {
        const res = await fetch('/api/admin/supreme/drops');
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载详情失败', 'error');
          return;
        }
        
        const record = data.data.find(r => r.id === recordId);
        if (!record) {
          showToast('记录不存在', 'error');
          return;
        }
        
        const modalHtml = `
          <div id="supremeDropDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-purple-600 to-pink-600">
                <h3 class="text-xl font-bold text-white">💎 至尊场掉落详情</h3>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  <div class="bg-slate-50 rounded-lg p-4">
                    <h4 class="font-bold text-slate-900 mb-3">基础信息</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-slate-600">记录ID：</span><span class="font-mono font-semibold">#${record.id}</span></div>
                      <div><span class="text-slate-600">用户名：</span><span class="font-semibold">${record.username || '未知'}</span></div>
                      <div class="col-span-2"><span class="text-slate-600">用户ID：</span><span class="font-mono text-xs">${record.user_id}</span></div>
                    </div>
                  </div>
                  
                  <div class="bg-amber-50 rounded-lg p-4">
                    <h4 class="font-bold text-amber-900 mb-3">掉落信息</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-amber-700">物品类型：</span><span class="font-semibold">${record.item_type === 'fragment' ? '至尊碎片' : '至尊令牌'}</span></div>
                      <div><span class="text-amber-700">数量：</span><span class="font-bold text-amber-900">${record.item_count}</span></div>
                      <div><span class="text-amber-700">掉落时间：</span><span class="font-mono text-xs">${new Date(record.drop_timestamp).toLocaleString('zh-CN')}</span></div>
                    </div>
                  </div>
                  
                  <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-bold text-green-900 mb-3">游戏信息</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                      <div><span class="text-green-700">下注金额：</span><span class="font-bold text-green-900">${(record.bet_amount / 500000).toLocaleString()} 坤币</span></div>
                      <div><span class="text-green-700">中奖金额：</span><span class="font-bold text-green-900">${(record.win_amount / 500000).toLocaleString()} 坤币</span></div>
                      <div class="col-span-2"><span class="text-green-700">游戏场次：</span><span class="font-semibold">至尊场 (Supreme Slot)</span></div>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                  <button onclick="closeSupremeDropDetailModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-semibold">关闭</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        console.error('加载详情失败:', error);
        showToast('加载详情失败', 'error');
      }
    }
    
    function closeSupremeDropDetailModal() {
      const modal = document.getElementById('supremeDropDetailModal');
      if (modal) modal.remove();
    }

    // ========== 封禁记录管理功能 ==========
    
    // 加载封禁用户列表
    async function loadBannedUsers() {
      try {
        const res = await fetch('/api/admin/users/banned');
        const data = await res.json();
        
        if (!data.success) {
          showToast('加载封禁记录失败', 'error');
          return;
        }
        
        const bannedUsers = data.data.users;
        const freeSpinsBans = data.data.freeSpinsBans || [];
        
        // 合并两种封禁记录
        const allBans = [];
        
        // 用户表的封禁（永久封禁）
        bannedUsers.forEach(user => {
          allBans.push({
            linux_do_id: user.linux_do_id,
            username: user.username,
            linux_do_username: user.linux_do_username,
            banned_at: user.banned_at,
            banned_until: null,  // 永久封禁
            banned_reason: user.banned_reason || '管理员手动封禁',
            type: 'permanent',
            is_active: true
          });
        });
        
        // 老虎机免费次数表的封禁（临时封禁 - 律师函触发）
        freeSpinsBans.forEach(ban => {
          allBans.push({
            linux_do_id: ban.linux_do_id,
            username: ban.username || ban.linux_do_id,
            linux_do_username: null,
            banned_at: ban.banned_until - (60 * 60 * 1000),  // 推算封禁时间（60小时前）
            banned_until: ban.banned_until,
            banned_reason: '触发3个及以上律师函',
            type: 'temporary',
            is_active: ban.banned_until > Date.now()
          });
        });
        
        // 统计
        const totalBanned = allBans.length;
        const tempBanned = allBans.filter(b => b.type === 'temporary' && b.is_active).length;
        const permBanned = allBans.filter(b => b.type === 'permanent').length;
        
        document.getElementById('bannedUsersCount').textContent = totalBanned;
        document.getElementById('tempBannedCount').textContent = tempBanned;
        document.getElementById('permBannedCount').textContent = permBanned;
        
        // 渲染表格
        const tbody = document.getElementById('bannedUsersTableBody');
        
        if (allBans.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-green-600 font-semibold">🎉 当前没有被封禁的用户</td></tr>';
          return;
        }
        
        // 按封禁时间倒序排序
        allBans.sort((a, b) => (b.banned_at || 0) - (a.banned_at || 0));
        
        tbody.innerHTML = allBans.map(ban => {
          const bannedTime = ban.banned_at ? new Date(ban.banned_at).toLocaleString('zh-CN') : '--';
          const unbanTime = ban.banned_until ? new Date(ban.banned_until).toLocaleString('zh-CN') : '永久';
          const isExpired = ban.banned_until && ban.banned_until < Date.now();
          
          // 封禁类型
          const typeBadge = ban.type === 'permanent' 
            ? '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">🔒 永久</span>'
            : '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⏱️ 临时</span>';
          
          // 状态
          const statusBadge = ban.is_active
            ? '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">🚫 封禁中</span>'
            : '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ 已过期</span>';
          
          // 操作按钮
          const actionButtons = ban.is_active
            ? `<button onclick="unbanUser('${ban.linux_do_id}', '${ban.username}')" class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg text-xs font-semibold shadow-sm transition-all">🔓 解封</button>`
            : '<span class="text-slate-400 text-xs">已过期</span>';
          
          return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3 font-mono text-slate-600 text-xs">${ban.linux_do_id.substring(0, 8)}...</td>
              <td class="px-4 py-3">
                <div class="font-semibold text-slate-900">${ban.username}</div>
              </td>
              <td class="px-4 py-3">
                <div class="text-sm text-slate-700">${ban.linux_do_username || '--'}</div>
              </td>
              <td class="px-4 py-3 text-sm text-slate-600">${bannedTime}</td>
              <td class="px-4 py-3 text-sm ${isExpired ? 'text-green-600' : 'text-red-600'} font-semibold">${unbanTime}</td>
              <td class="px-4 py-3">
                <div class="text-sm text-slate-700">${ban.banned_reason}</div>
              </td>
              <td class="px-4 py-3 text-center">${typeBadge}</td>
              <td class="px-4 py-3 text-center">${statusBadge}</td>
              <td class="px-4 py-3 text-center">${actionButtons}</td>
            </tr>
          `;
        }).join('');
        
        showToast('封禁记录已加载', 'success');
      } catch (error) {
        console.error('加载封禁记录失败:', error);
        showToast('加载失败，请重试', 'error');
      }
    }
    
    // 刷新封禁记录
    function refreshBannedUsers() {
      loadBannedUsers();
    }
    
    // 解封用户
    async function unbanUser(linuxDoId, username) {
      if (!confirm(`确认解封用户 "${username}" 吗？\n\n解封后该用户可以继续进行抽奖。`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/${linuxDoId}/unban`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`✅ 用户 "${username}" 已解封`, 'success');
          // 刷新列表
          setTimeout(() => loadBannedUsers(), 500);
        } else {
          showToast(data.message || '解封失败', 'error');
        }
      } catch (error) {
        console.error('解封用户失败:', error);
        showToast('解封操作失败，请重试', 'error');
      }
    }

    // 高级场游戏记录
    let advancedSlotCurrentPage = 1;
    let advancedSlotPageSize = 50;
    let advancedSlotAllRecords = [];  // 存储所有记录用于筛选
    let advancedSlotFilters = {
      username: '',
      winType: 'all'
    };

    async function loadAdvancedSlotRecords(page = 1) {
      try {
        advancedSlotCurrentPage = page;
        const res = await fetch(`/api/admin/slot/advanced/records?page=${page}&pageSize=${advancedSlotPageSize}`);
        const data = await res.json();

        if (data.success) {
          let { records, total, stats } = data.data;
          
          // 🔥 存储所有记录
          advancedSlotAllRecords = records;
          
          // 🔥 应用筛选
          if (advancedSlotFilters.username) {
            records = records.filter(r => 
              (r.linux_do_username && r.linux_do_username.toLowerCase().includes(advancedSlotFilters.username.toLowerCase())) ||
              (r.username && r.username.toLowerCase().includes(advancedSlotFilters.username.toLowerCase()))
            );
          }
          
          if (advancedSlotFilters.winType !== 'all') {
            records = records.filter(r => r.win_type === advancedSlotFilters.winType);
          }
          
          // 更新总数（筛选后）
          total = records.length;
          
          // 更新统计信息
          document.getElementById('advancedSlotTotal').textContent = stats.count;
          document.getElementById('advancedSlotTotalBet').textContent = `$${(stats.total_bet / 500000).toFixed(2)}`;
          document.getElementById('advancedSlotTotalWin').textContent = `$${(stats.total_win / 500000).toFixed(2)}`;
          const rtp = stats.total_bet > 0 ? ((stats.total_win / stats.total_bet) * 100).toFixed(2) : '0.00';
          document.getElementById('advancedSlotRTP').textContent = `${rtp}%`;
          
          
          // 渲染表格
          const tbody = document.getElementById('advancedSlotRecordsBody');
          if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-400">暂无高级场游戏记录</td></tr>';
          } else {
            tbody.innerHTML = records.map(r => {
              const symbols = JSON.parse(r.result_symbols);
              const winTypeNames = {
                'super_jackpot': '🏆 超级大奖',
                'special_combo': '💎 特殊组合',
                'quad': '🎰 四连',
                'triple': '✨ 三连',
                'double': '🎁 双连',
                'punishment': '⚡ 律师函',
                'none': '❌ 未中奖'
              };
              const winAmount = r.win_amount;
              const amountClass = winAmount > 0 ? 'text-green-600 font-semibold' : (winAmount < 0 ? 'text-red-600 font-semibold' : 'text-slate-600');
              
              return `
                <tr class="border-t border-slate-200 hover:bg-slate-50">
                  <td class="px-4 py-3 text-sm text-slate-600">${r.id}</td>
                  <td class="px-4 py-3 text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                  <td class="px-4 py-3 text-sm">
                    <div class="font-medium text-slate-900">${r.linux_do_username || r.username}</div>
                    <div class="text-xs text-slate-500">${r.username}</div>
                  </td>
                  <td class="px-4 py-3 text-sm font-semibold text-blue-600">$${(r.bet_amount / 500000).toFixed(2)}</td>
                  <td class="px-4 py-3 text-sm">
                    <div class="flex gap-1">
                      ${symbols.map(s => {
                        // 🔥 修复：lq, bj, bdk 使用 jpg，其他符号使用 png
                        const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
                        return `<img src="/slot-symbols/${s}.${ext}" class="w-8 h-8 object-contain" title="${s}">`;
                      }).join('')}
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm">${winTypeNames[r.win_type] || r.win_type}</td>
                  <td class="px-4 py-3 text-sm font-semibold">${r.win_multiplier}x</td>
                  <td class="px-4 py-3 text-sm ${amountClass}">${winAmount >= 0 ? '+' : ''}$${(winAmount / 500000).toFixed(2)}</td>
                </tr>
              `;
            }).join('');
          }
          
          // 更新分页
          document.getElementById('advancedSlotRecordsTotal').textContent = total;
          document.getElementById('advancedSlotCurrentPage').textContent = page;
          document.getElementById('advancedSlotPrevBtn').disabled = page <= 1;
          document.getElementById('advancedSlotNextBtn').disabled = records.length < advancedSlotPageSize;
          
          if (total > 0) {
            document.getElementById('advancedSlotRecordsPagination').classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('加载高级场记录失败', e);
        showMessage('加载记录失败', 'error');
      }
    }

    function refreshAdvancedSlotRecords() {
      loadAdvancedSlotRecords(advancedSlotCurrentPage);
    }

    function advancedSlotPrevPage() {
      if (advancedSlotCurrentPage > 1) {
        loadAdvancedSlotRecords(advancedSlotCurrentPage - 1);
      }
    }

    function advancedSlotNextPage() {
      loadAdvancedSlotRecords(advancedSlotCurrentPage + 1);
    }
    
    // 🔥 高级场记录筛选函数
    function filterAdvancedSlotRecords() {
      advancedSlotFilters.username = document.getElementById('advancedRecordSearchInput').value.trim();
      advancedSlotFilters.winType = document.getElementById('advancedWinTypeFilter').value;
      
      advancedSlotCurrentPage = 1;
      loadAdvancedSlotRecords(1);
    }
    
    // 🔥 刷新并保留筛选条件
    function refreshAdvancedSlotRecordsKeepFilter() {
      loadAdvancedSlotRecords(advancedSlotCurrentPage);
    }

    // 入场券掉落记录
    let ticketDropCurrentPage = 1;
    let ticketDropPageSize = 50;

    async function loadTicketDropRecords(page = 1) {
      try {
        ticketDropCurrentPage = page;
        const res = await fetch(`/api/admin/slot/tickets/drop-records?page=${page}&pageSize=${ticketDropPageSize}`);
        const data = await res.json();

        if (data.success) {
          const { records, total, stats } = data.data;
          
          // 更新统计信息
          document.getElementById('ticketDropTotal').textContent = stats.total;
          document.getElementById('ticketDropCount').textContent = stats.ticket_drops;
          document.getElementById('fragmentDropCount').textContent = stats.fragment_drops;
          document.getElementById('todayDropCount').textContent = stats.today_drops;
          
          // 渲染表格
          const tbody = document.getElementById('ticketDropRecordsBody');
          if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">暂无掉落记录</td></tr>';
          } else {
            tbody.innerHTML = records.map(r => {
              const dropIcon = r.drop_type === 'ticket' ? '🎟️' : '🧩';
              const dropName = r.drop_type === 'ticket' ? '入场券' : '碎片';
              const winTypeNames = {
                'quad': '🎰 四连',
                'triple': '✨ 三连',
                'double': '🎁 双连'
              };
              
              return `
                <tr class="border-t border-slate-200 hover:bg-slate-50">
                  <td class="px-4 py-3 text-sm text-slate-600">${r.id}</td>
                  <td class="px-4 py-3 text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
                  <td class="px-4 py-3 text-sm font-medium text-slate-900">${r.username}</td>
                  <td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                      ${dropIcon} ${dropName}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm font-semibold text-indigo-600">${r.drop_count}</td>
                  <td class="px-4 py-3 text-sm">${winTypeNames[r.trigger_win_type] || r.trigger_win_type}</td>
                </tr>
              `;
            }).join('');
          }
          
          // 更新分页
          document.getElementById('ticketDropRecordsTotal').textContent = total;
          document.getElementById('ticketDropCurrentPage').textContent = page;
          document.getElementById('ticketDropPrevBtn').disabled = page <= 1;
          document.getElementById('ticketDropNextBtn').disabled = records.length < ticketDropPageSize;
          
          if (total > 0) {
            document.getElementById('ticketDropPagination').classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('加载掉落记录失败', e);
        showMessage('加载记录失败', 'error');
      }
    }

    function ticketDropPrevPage() {
      if (ticketDropCurrentPage > 1) {
        loadTicketDropRecords(ticketDropCurrentPage - 1);
      }
    }

    function ticketDropNextPage() {
      loadTicketDropRecords(ticketDropCurrentPage + 1);
    }

    // 高级场符号权重管理
    async function loadAdvancedSymbolWeights() {
      try {
        const res = await fetch('/api/admin/slot/advanced/weights');
        const data = await res.json();

        if (data.success) {
          const weights = data.data;
          
          // 填充表单
          document.getElementById('advWeight_m').value = weights.weight_m;
          document.getElementById('advWeight_t').value = weights.weight_t;
          document.getElementById('advWeight_n').value = weights.weight_n;
          document.getElementById('advWeight_j').value = weights.weight_j;
          document.getElementById('advWeight_lq').value = weights.weight_lq;
          document.getElementById('advWeight_bj').value = weights.weight_bj;
          document.getElementById('advWeight_zft').value = weights.weight_zft;
          document.getElementById('advWeight_bdk').value = weights.weight_bdk;
          document.getElementById('advWeight_lsh').value = weights.weight_lsh;
          
          // 计算并显示概率
          calculateAdvancedProbabilities();
        }
      } catch (error) {
        console.error('加载高级场符号权重失败:', error);
        showMessage('加载权重失败', 'error');
      }
    }

    async function saveAdvancedSymbolWeights() {
      try {
        const weights = {
          weight_m: parseInt(document.getElementById('advWeight_m').value),
          weight_t: parseInt(document.getElementById('advWeight_t').value),
          weight_n: parseInt(document.getElementById('advWeight_n').value),
          weight_j: parseInt(document.getElementById('advWeight_j').value),
          weight_lq: parseInt(document.getElementById('advWeight_lq').value),
          weight_bj: parseInt(document.getElementById('advWeight_bj').value),
          weight_zft: parseInt(document.getElementById('advWeight_zft').value),
          weight_bdk: parseInt(document.getElementById('advWeight_bdk').value),
          weight_lsh: parseInt(document.getElementById('advWeight_lsh').value)
        };
        
        // 验证
        for (const [key, value] of Object.entries(weights)) {
          if (isNaN(value) || value < 1 || value > 1000) {
            showMessage(`${key} 权重必须在1-1000之间`, 'error');
            return;
          }
        }
        
        const res = await fetch('/api/admin/slot/advanced/weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weights)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showMessage('高级场权重配置已更新', 'success');
          calculateAdvancedProbabilities();
        } else {
          showMessage(data.message, 'error');
        }
      } catch (error) {
        console.error('保存高级场权重失败:', error);
        showMessage('保存权重失败', 'error');
      }
    }

    // 🔥 更新二连掉落率显示
    function updateDropRateDoubleDisplay(value) {
      const rate = parseFloat(value);
      document.getElementById('advancedDropRateDouble').value = rate.toFixed(2);
      document.getElementById('dropDoubleBar').style.width = (rate * 100) + '%';
      
      // 更新百分比显示
      document.getElementById('dropDoublePercent').textContent = Math.round(rate * 100);
      
      // 计算期望值（假设二连出现率约20%，每10局中有2次二连）
      const expected = Math.round(rate * 2 * 10) / 10; // 保留一位小数
      document.getElementById('dropDoubleExpected').textContent = expected.toFixed(1);
      
      // 更新掉落强度
      updateDropIntensity();
    }
    
    // 🔥 更新三连掉落率显示
    function updateDropRateTripleDisplay(value) {
      const rate = parseFloat(value);
      document.getElementById('advancedDropRateTriple').value = rate.toFixed(2);
      document.getElementById('dropTripleBar').style.width = (rate * 100) + '%';
      
      // 更新百分比显示
      document.getElementById('dropTriplePercent').textContent = Math.round(rate * 100);
      
      // 计算期望值（假设三连/四连出现率约10%，每10局中有1次）
      const expected = Math.round(rate * 1 * 10) / 10; // 保留一位小数
      document.getElementById('dropTripleExpected').textContent = expected.toFixed(1);
      
      // 更新掉落强度
      updateDropIntensity();
    }
    
    // 🔥 更新掉落强度评估
    function updateDropIntensity() {
      const doubleRate = parseFloat(document.getElementById('advancedDropRateDouble').value) || 0;
      const tripleRate = parseFloat(document.getElementById('advancedDropRateTriple').value) || 0;
      
      // 综合评分 (0-1)
      const intensityScore = (doubleRate * 0.3 + tripleRate * 0.7);
      
      let stars, label, color;
      if (intensityScore >= 0.8) {
        stars = '★★★★★';
        label = '(极高)';
        color = 'text-red-600';
      } else if (intensityScore >= 0.6) {
        stars = '★★★★☆';
        label = '(高)';
        color = 'text-orange-600';
      } else if (intensityScore >= 0.4) {
        stars = '★★★☆☆';
        label = '(中等)';
        color = 'text-yellow-600';
      } else if (intensityScore >= 0.2) {
        stars = '★★☆☆☆';
        label = '(平衡)';
        color = 'text-purple-600';
      } else {
        stars = '★☆☆☆☆';
        label = '(低)';
        color = 'text-blue-600';
      }
      
      document.getElementById('dropIntensity').innerHTML = `
        <span class="text-2xl">${stars}</span>
        <span class="text-sm font-bold ${color} ml-2">${label}</span>
      `;
    }
    
    // 🔥 显示RTP帮助说明
    function showRTPHelp() {
      alert(`🧠 倍率与RTP说明

RTP (Return to Player)：
• 返还玩家率，表示玩家长期游戏能拿回的投注比例
• 例如：RTP 0.88 = 88%，玩家长期平均能拿回88%的投注

奖励倍数：
• 高级场的奖励倍数放大系数
• 例如：基础倍率8x，奖励倍数4.0，实际奖励 = 8 × 4 = 32x

惩罚倍数：
• 律师函的惩罚金额放大系数
• 例如：1个律师函扣1倍投注，惩罚倍数2.0，实际扣除 = 1 × 2 = 2倍投注
• 律师函出现概率由权重配置单独控制

推荐配置：
• 奖励倍数：4.0（中奖金额放大）
• 惩罚倍数：2.0（律师函惩罚放大）`);
    }
    
    function calculateAdvancedProbabilities() {
      const weights = {
        m: parseInt(document.getElementById('advWeight_m').value) || 100,
        t: parseInt(document.getElementById('advWeight_t').value) || 100,
        n: parseInt(document.getElementById('advWeight_n').value) || 100,
        j: parseInt(document.getElementById('advWeight_j').value) || 100,
        lq: parseInt(document.getElementById('advWeight_lq').value) || 100,
        bj: parseInt(document.getElementById('advWeight_bj').value) || 100,
        zft: parseInt(document.getElementById('advWeight_zft').value) || 100,
        bdk: parseInt(document.getElementById('advWeight_bdk').value) || 100,
        lsh: parseInt(document.getElementById('advWeight_lsh').value) || 50
      };
      
      const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
      document.getElementById('advTotalWeight').textContent = totalWeight;
      
      // 计算每个符号的概率
      for (const [symbol, weight] of Object.entries(weights)) {
        const prob = ((weight / totalWeight) * 100).toFixed(2);
        const probEl = document.getElementById(`advProb_${symbol}`);
        
        if (symbol === 'lsh') {
          // 律师函特殊计算：至少出现1次的概率
          const singleProb = weight / totalWeight;
          const atLeastOne = (1 - Math.pow(1 - singleProb, 4)) * 100;
          probEl.textContent = `概率: ${prob}% | 4个位置至少出现1次: ${atLeastOne.toFixed(2)}%`;
        } else {
          probEl.textContent = `概率: ${prob}%`;
        }
      }
    }

    function resetAdvancedWeightsToDefault() {
      if (!confirm('确定要恢复高级场符号权重为默认值吗？\n默认：普通符号100，律师函50')) {
        return;
      }
      
      document.getElementById('advWeight_m').value = 100;
      document.getElementById('advWeight_t').value = 100;
      document.getElementById('advWeight_n').value = 100;
      document.getElementById('advWeight_j').value = 100;
      document.getElementById('advWeight_lq').value = 100;
      document.getElementById('advWeight_bj').value = 100;
      document.getElementById('advWeight_zft').value = 100;
      document.getElementById('advWeight_bdk').value = 100;
      document.getElementById('advWeight_lsh').value = 50;
      
      calculateAdvancedProbabilities();
    }

  </script>
</body>
</html>