<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="KYX API 公益加油站">
  <title>KYX API Refueling Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #0F9D58 0%, #0b7a42 100%);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 25%, #8b5cf6 75%, #ec4899 100%);
      position: relative;
      overflow: hidden;
    }

    .gradient-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(10%, 10%) rotate(90deg); }
      50% { transform: translate(0, 20%) rotate(180deg); }
      75% { transform: translate(-10%, 10%) rotate(270deg); }
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .animate-in {
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }

    /* 老虎机样式 */
    .slot-reel-container {
      width: 180px;
      height: 180px;
      border: 5px solid #fbbf24;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .slot-reel {
      position: relative;
      height: 100%;
      width: 100%;
      overflow: hidden;
      /* 🎯 优化：启用硬件加速 */
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }

    .slot-symbols {
      position: relative;
      width: 100%;
      display: flex;
      flex-direction: column;
      /* 🎯 优化：启用硬件加速和性能优化 */
      will-change: transform, filter;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .slot-symbol {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      flex-shrink: 0;
      /* 🎯 优化：减少重排和重绘 */
      contain: layout style paint;
    }

    .slot-symbol img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
      /* 🎯 优化：图片渲染优化 */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      transform: translateZ(0);
    }

    /* 老虎机动画优化 */
    @media (prefers-reduced-motion: reduce) {
      .slot-symbols {
        animation: none !important;
      }
    }

    /* 响应式调整 - 移动端优化 */
    @media only screen and (max-width: 768px) {
      /* 老虎机滚轮 */
      .slot-reel-container {
        width: 70px;
        height: 70px;
      }
      
      .slot-symbol {
        height: 70px;
        padding: 5px;
      }
      
      .slot-symbol img {
        max-width: 100%;
        max-height: 100%;
        /* 🎯 移动端：降低模糊强度，提升性能 */
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));
      }
      
      /* 隐藏侧边栏排行榜和盈亏榜 */
      #slotSidebarLeaderboard,
      #slotSidebarProfitBoard {
        display: none !important;
      }
      
      /* Toast消息位置调整 */
      .toast {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: calc(100vw - 20px);
      }
      
      /* 模态框内边距调整 */
      .modal-content {
        padding: 1rem;
      }
    }
    
    /* 平板端适配 */
    @media only screen and (min-width: 769px) and (max-width: 1024px) {
      .slot-reel-container {
        width: 100px;
        height: 100px;
      }
      
      .slot-symbol {
        height: 100px;
        padding: 8px;
      }
      
      /* 排行榜窄一些 */
      #slotSidebarLeaderboard {
        width: 280px !important;
      }
    }

    /* 界面切换过渡动画 */
    .fade-enter {
      opacity: 0;
      transform: scale(0.95);
    }
    
    .fade-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    
    .fade-exit {
      opacity: 1;
      transform: scale(1);
    }
    
    .fade-exit-active {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 0.2s ease-in, transform 0.2s ease-in;
    }
    
    /* Loading遮罩 */
    .slot-loading-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #8b5cf6 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.3s ease-out;
    }
    
    /* 老虎机背景 - 默认渐变（可通过配置切换为GIF） */
    .slot-machine-bg {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 50%, rgba(139, 92, 246, 0.9) 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    /* 确保背景在所有子元素后面 */
    .slot-machine-bg > * {
      position: relative;
      z-index: 1;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* 🎯 优化：滚轮停止时的脉冲动画 */
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 50px rgba(251, 191, 36, 0.9), inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 80px rgba(251, 191, 36, 0.4);
      }
    }

    /* 自定义滚动条 */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Loading Page -->
  <div id="loadingPage" class="fixed inset-0 gradient-bg flex flex-col items-center justify-center z-50">
    <div class="relative">
      <div class="absolute inset-0 bg-white/20 rounded-full blur-2xl"></div>
      <div class="relative">
        <div class="spinner"></div>
      </div>
    </div>
    <p class="text-white text-xl font-semibold mt-6 tracking-wide">正在加载...</p>
    <div class="flex gap-2 mt-3">
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen gradient-bg flex items-center justify-center p-6">
    <div class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl p-12 max-w-md w-full animate-in border border-white/20">
      <div class="flex justify-center mb-8">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur-2xl opacity-60 animate-pulse"></div>
          <div class="relative bg-white p-3 rounded-full shadow-2xl ring-4 ring-white/50">
            <img src="https://lh3.googleusercontent.com/a/ACg8ocJmyq3J-RuNfGv7J430fFiZ6EYQ0AB_phVlIPwm265e9HC1vJc=s288-c-no" alt="Logo" class="w-20 h-20 rounded-full object-cover">
          </div>
        </div>
      </div>
      <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3 whitespace-nowrap">KYX API Refueling Station</h1>
      <p class="text-center text-slate-600 mb-8 text-sm">⚡ 公益站额度加油站</p>
      
      <button onclick="login()" class="group relative w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white py-4 px-6 rounded-xl font-semibold overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl active:scale-[0.98]">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-700 via-purple-700 to-pink-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        <div class="relative flex items-center justify-center gap-3">
          <img src="https://linux.do/uploads/default/original/4X/c/c/d/ccd8c210609d498cbeb3d5201d4c259348447562.png" alt="Linux Do" class="w-6 h-6">
          <span class="text-lg">使用 Linux Do 账户登录</span>
          <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </div>
      </button>
      
      <div class="mt-8 flex items-center justify-center gap-2 text-xs text-slate-500">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        <span>安全登录，保护您的隐私</span>
      </div>
      
      <p class="text-xs text-slate-400 text-center mt-4">登录即表示您同意我们的服务条款和隐私政策</p>
    </div>
  </div>

  <!-- Bind Section -->
  <div id="bindSection" class="hidden min-h-screen gradient-bg flex items-center justify-center p-6">
    <div class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl p-12 max-w-md w-full animate-in border border-white/20">
      <div class="flex justify-center mb-6">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-green-600 to-blue-600 rounded-full blur-xl opacity-50 animate-pulse"></div>
          <div class="relative bg-gradient-to-br from-green-500 to-blue-600 p-4 rounded-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      <h2 class="text-2xl font-bold text-center bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-2">绑定公益站账号</h2>
      <p class="text-sm text-slate-600 text-center mb-8">🔗 请输入您在公益站的用户名</p>
      <div id="bindMessage" class="hidden mb-4 p-3 rounded-lg"></div>
      <input type="text" id="username" placeholder="输入您的公益站用户名" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-6 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 outline-none text-lg">
      <button onclick="bindAccount()" class="group relative w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl font-semibold overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl active:scale-[0.98]">
        <div class="absolute inset-0 bg-gradient-to-r from-green-700 to-blue-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        <div class="relative flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          <span class="text-lg">确认绑定</span>
        </div>
      </button>
    </div>
  </div>

  <!-- Main Section -->
  <div id="mainSection" class="hidden">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center h-16">
          <!-- Logo -->
          <div class="flex items-center gap-8">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">KYX API</h1>
            
            <!-- 导航选项卡 -->
            <div class="flex items-center gap-1" data-switch-container>
              <!-- 加油站 -->
              <button data-btn="refuel" onclick="switchToRefuel()" 
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md">
                <span>⛽</span>
                <span>加油站</span>
              </button>
              
              <!-- 娱乐站 -->
              <button data-btn="entertain" onclick="switchToEntertain()" 
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>🎰</span>
                <span>娱乐站</span>
              </button>
            </div>
          </div>
          
          <!-- 右侧：用户菜单 -->
          <div class="flex items-center gap-3 ml-auto">
            <div class="relative">
              <button onclick="toggleDropdown()" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center text-white font-semibold">
                  <span id="userInitial">U</span>
                </div>
                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
              <div class="px-4 py-3 border-b border-slate-200">
                <p id="linuxDoUsername" class="font-semibold text-slate-900 text-sm">@用户名</p>
                <p id="userName" class="text-sm text-slate-600">公益站: 用户名</p>
                <p id="userId" class="text-xs text-slate-500">ID: xxx</p>
              </div>
              <button onclick="showSlotRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                <span>🎰</span> 抽奖记录
              </button>
              <button onclick="showMyRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                <span>📊</span> 我的记录
              </button>
              <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2">
                <span>🚪</span> 退出登录
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <div class="max-w-4xl mx-auto p-6">
      <div id="message" class="hidden mb-4 p-4 rounded-lg animate-in"></div>

      <!-- Quota Display -->
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white mb-6 shadow-xl animate-in">
        <p class="text-sm opacity-90 mb-2">当前剩余额度</p>
        <h2 id="quotaValue" class="text-5xl font-bold mb-4">--</h2>
        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/20">
          <div>
            <p class="text-xs opacity-75">已使用</p>
            <p id="quotaUsage" class="text-lg font-semibold">--</p>
          </div>
          <div>
            <p class="text-xs opacity-75">状态</p>
            <p id="quotaStatus" class="text-lg font-semibold">正常</p>
          </div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-in card-hover">
        <h3 class="text-xl font-bold text-slate-900 mb-4">💰 每日额度领取</h3>
        <p class="text-sm text-slate-600 mb-2">当您的剩余额度低于 $20 时，可以每天领取额度补充</p>
        
        <!-- 领取次数显示 -->
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-xs text-blue-800">
              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
              </svg>
              <span>今日领取情况</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-blue-700">
                已领取 <span id="todayClaimCount" class="text-lg">0</span>/<span id="maxDailyClaims">1</span> 次
              </span>
              <span id="remainingClaims" class="px-2 py-1 bg-blue-600 text-white rounded-full text-xs font-semibold">剩余 1 次</span>
            </div>
          </div>
        </div>
        
        <button id="claimBtn" onclick="claimQuota()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
          领取今日额度
        </button>
      </div>

      <!-- Donate Cards Container -->
      <div class="bg-white rounded-2xl shadow-lg p-6 animate-in card-hover">
        <h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">💝 投喂 API Keys</h3>
        <p id="donateDescription" class="text-sm text-slate-600 mb-6 text-center">每个有效的 API Key 可为您增加 $50 额度并且获得一次免费抽奖机会 · 每种类型每天可投喂 1 个</p>
        
        <!-- 两列布局 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <!-- ModelScope Card -->
          <div class="border-2 border-indigo-200 rounded-xl p-5 hover:border-indigo-400 transition-colors">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">🎁</span>
              <h4 class="text-lg font-bold text-slate-900">ModelScope Key</h4>
            </div>
            
            <!-- 投喂限制说明 -->
            <div id="donateWarning" class="mb-3 p-2 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-red-800">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span><strong>每天只能提交 1 个</strong></span>
              </div>
            </div>

            <!-- 今日已投喂提示 -->
            <div id="donatedToday" class="hidden mb-3 p-2 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-green-800">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>✓ <strong>今日已投喂</strong></span>
              </div>
            </div>
            
            <textarea id="keysInput" placeholder="ms-xxxxx-xxxx-xxxx-xxxx" class="w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm resize-none"></textarea>
            <button id="donateBtn" onclick="donateKeys()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3">
              🚀 提交 ModelScope Key
            </button>
            <a href="https://www.modelscope.cn/my/myaccesstoken" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 text-xs text-indigo-600 hover:text-indigo-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              <span class="font-medium">获取 ModelScope API Key</span>
            </a>
          </div>

          <!-- iFlow Card -->
          <div class="border-2 border-emerald-200 rounded-xl p-5 hover:border-emerald-400 transition-colors">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">✨</span>
              <h4 class="text-lg font-bold text-slate-900">iFlow API Key</h4>
            </div>
            
            <!-- 投喂限制说明 -->
            <div id="donateIflowWarning" class="mb-3 p-2 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-red-800">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span><strong>每天只能提交 1 个</strong></span>
              </div>
            </div>

            <!-- 今日已投喂提示 -->
            <div id="donatedIflowToday" class="hidden mb-3 p-2 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-green-800">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>✓ <strong>今日已投喂</strong></span>
              </div>
            </div>
            
            <textarea id="iflowKeysInput" placeholder="sk-xxxxx-xxxx-xxxx-xxxx" class="w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-emerald-500 focus:border-transparent font-mono text-sm resize-none"></textarea>
            <button id="donateIflowBtn" onclick="donateIflowKeys()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3">
              🚀 提交 iFlow Key
            </button>
            <a href="https://platform.iflow.cn/profile?tab=apiKey" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 text-xs text-emerald-600 hover:text-emerald-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              <span class="font-medium">获取 iFlow API Key</span>
            </a>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Records Modal -->
  <div id="recordsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl animate-in">
      <div class="flex justify-between items-center p-6 border-b border-slate-200">
        <h2 class="text-2xl font-bold text-slate-900">我的记录</h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-6">
        <div class="flex gap-2 mb-6 border-b border-slate-200">
          <button onclick="showTab('claim')" class="tab-btn px-4 py-2 font-semibold border-b-2 border-indigo-600 text-indigo-600">领取记录</button>
          <button onclick="showTab('donate')" class="tab-btn px-4 py-2 font-semibold border-b-2 border-transparent text-slate-500 hover:text-slate-900">投喂记录</button>
        </div>
        <div id="claimRecords" class="tab-content overflow-y-auto max-h-96"></div>
        <div id="donateRecords" class="tab-content hidden overflow-y-auto max-h-96"></div>
      </div>
    </div>
  </div>

  <!-- 老虎机全屏界面 -->
  <div id="slotMachineModal" class="hidden fixed inset-0 z-50 slot-machine-bg">
    
    <!-- Loading遮罩 -->
    <div id="slotLoadingOverlay" class="slot-loading-overlay hidden">
      <div class="relative">
        <div class="spinner"></div>
      </div>
      <p class="text-white text-xl font-semibold mt-6 tracking-wide">加载娱乐站...</p>
      <div class="flex gap-2 mt-3">
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
      </div>
    </div>
    
    <!-- 顶部导航栏（与主界面一致）-->
    <nav class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
        <div class="flex items-center h-16">
          <!-- Logo和导航 - 响应式 -->
          <div class="flex items-center gap-2 sm:gap-4 md:gap-8">
            <h1 class="text-base sm:text-lg md:text-xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">KYX API</h1>
            
            <!-- 导航选项卡 - 响应式 -->
            <div class="flex items-center gap-1" data-switch-container>
              <!-- 加油站 -->
              <button data-btn="refuel" onclick="switchToRefuel()" 
                      class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 text-white/70 hover:bg-white/10">
                <span class="text-base sm:text-lg">⛽</span>
                <span class="hidden sm:inline">加油站</span>
              </button>
              
              <!-- 娱乐站 -->
              <button data-btn="entertain" onclick="switchToEntertain()" 
                      class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-lg">
                <span class="text-base sm:text-lg">🎰</span>
                <span class="hidden sm:inline">娱乐站</span>
              </button>
            </div>
          </div>
          
          <!-- 🔥 高级场标题（居中显示）-->
          <div id="advancedModeTitle" class="hidden absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
            <span class="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent animate-pulse whitespace-nowrap">
              <span class="hidden sm:inline">🔥 </span>高级场模式
            </span>
          </div>
          
          <!-- 🎰 初级场标题（居中显示）-->
          <div id="normalModeTitle" class="hidden absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
            <span class="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent whitespace-nowrap">
              <span class="hidden sm:inline">🎰 </span>初级场
            </span>
          </div>
          
          <!-- 右侧：用户菜单和高级场信息 -->
          <div class="flex items-center gap-2 sm:gap-3 ml-auto">
            <!-- 音效控制按钮 -->
            <button id="soundToggleBtn" onclick="toggleSound()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="音效开关">
              <span id="soundIcon" class="text-xl">🔊</span>
            </button>
            
            <!-- 移动端排行榜按钮 -->
            <button onclick="showLeaderboard()" class="md:hidden p-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 transition-colors" title="查看排行榜">
              <span class="text-xl">🏆</span>
            </button>
            
            <div class="text-white text-right hidden sm:block">
              <p class="text-xs opacity-75">剩余额度</p>
              <p id="slotQuota" class="text-lg font-bold text-yellow-400">$0.00</p>
            </div>
            <!-- 移动端简化显示 -->
            <div class="text-white text-right sm:hidden">
              <p id="slotQuotaMobile" class="text-sm font-bold text-yellow-400">$0.00</p>
            </div>
            
            <div class="relative">
              <button onclick="toggleSlotDropdown()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors">
                <div id="slotUserAvatar" class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center text-white font-semibold border-2 border-white/30">
                  <span id="slotUserInitial">U</span>
                </div>
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div id="slotDropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
              <div class="px-4 py-3 border-b border-slate-200">
                <p id="slotLinuxDoUsername" class="font-semibold text-slate-900 text-sm">@用户名</p>
                <p id="slotUserName" class="text-sm text-slate-600">公益站: 用户名</p>
                <p id="slotUserId" class="text-xs text-slate-500">ID: xxx</p>
              </div>
                <button onclick="showSlotRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>🎰</span> 抽奖记录
                </button>
                <button onclick="showMyRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>📊</span> 我的记录
                </button>
                <button onclick="showPendingRewardsModal()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>💰</span> 待发放记录
                </button>
                <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2">
                  <span>🚪</span> 退出登录
                </button>
              </div>
            </div>
            
            <!-- 🔥 高级场倒计时和返回按钮 -->
            <div id="advancedModeIndicator" class="hidden flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg shadow-lg ml-2">
              <div class="text-white">
                <p class="text-xs opacity-75 leading-tight">剩余时间</p>
                <p id="advancedTimeRemaining" class="text-sm font-mono font-bold text-yellow-300 leading-tight">23:59:59</p>
              </div>
              <button onclick="exitAdvancedMode()" class="px-2.5 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-bold rounded transition-all whitespace-nowrap">
                返回初级场
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- 🔥 入场券信息栏（独立，在导航栏下方）-->
    <div id="advancedTicketBar" class="hidden bg-gradient-to-r from-purple-600/90 to-blue-600/90 backdrop-blur-md border-b border-white/20">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex items-center justify-center py-1.5">
          <!-- 紧凑且清晰的布局 -->
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- 入场券 -->
            <div class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded">
              <span class="text-sm">🎟️</span>
              <span class="text-white font-medium text-sm">
                <span id="ticketCount">0</span>/<span id="ticketMax" class="text-white/70">2</span>
              </span>
              <span id="dailyTicketGrantInfo" class="text-xs text-white/60 ml-1 hidden"></span>
            </div>
            
            <!-- 碎片 -->
            <div class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded">
              <span class="text-sm">🍀</span>
              <span class="text-white font-medium text-sm">
                <span id="fragmentCount">0</span>/<span id="fragmentsNeeded" class="text-white/70">5</span>
              </span>
            </div>
            
            <!-- 每日进入次数 -->
            <div id="dailyEntryInfo" class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded hidden">
              <span class="text-sm">📅</span>
              <span class="text-white font-medium text-sm">
                今日进入: <span id="todayEntryCount">0</span>/<span id="dailyEntryLimit" class="text-white/70">2</span>
              </span>
            </div>
            
            <!-- 操作按钮 -->
            <button id="synthesizeButton" onclick="synthesizeTicket()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              🔨 合成
            </button>
            
            <button id="enterAdvancedButton" onclick="enterAdvancedMode()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              🔥 进入
            </button>
            
            <!-- 过期时间 -->
            <span id="ticketExpiry" class="text-white/60 text-xs hidden sm:inline"></span>
            
            <!-- 提示（移动端隐藏）-->
            <div class="hidden sm:block text-white/50 text-xs">
              二连→碎片 三/四连→券
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 老虎机主体 -->
    <div class="relative flex flex-col" style="min-height: calc(100vh - 64px);">
      
      <!-- 主游戏区 -->
      <div class="flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto pb-[100px]">
        
        <!-- 标题 - 响应式字体 -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-yellow-400 mb-3 sm:mb-4 drop-shadow-lg animate-pulse">
          🎰 KYX-Slot-Machine
        </h1>
        
        <!-- 次数显示 - 响应式（仅初级场显示）-->
        <div id="normalModeSpinsDisplay" class="bg-white/10 backdrop-blur-md rounded-lg px-4 sm:px-8 py-2 sm:py-3 mb-4 sm:mb-6">
          <p class="text-white text-center text-sm sm:text-base md:text-lg">
            今日剩余：<span id="spinsRemaining" class="text-yellow-400 font-bold text-lg sm:text-xl md:text-2xl">5</span> 次
            <span class="mx-2 sm:mx-3">|</span>
            免费次数：<span id="freeSpinsCount" class="text-green-400 font-bold text-lg sm:text-xl md:text-2xl">0</span> 次
          </p>

          <!-- 购买次数功能区 -->
          <div id="buySpinsSection" class="hidden mt-3 p-3 bg-gradient-to-r from-orange-500/20 to-yellow-500/20 rounded-lg border border-orange-400/30">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
              <div class="text-white text-sm text-center sm:text-left">
                <span>💰 购买抽奖次数：<span id="buySpinsPrice" class="text-orange-300 font-bold">$40</span>/次</span>
                <span class="ml-2 text-white/70">今日已购：<span id="buySpinsToday" class="text-orange-300">0</span>/<span id="buySpinsMax" class="text-orange-300">5</span></span>
              </div>
              <button id="buySpinsButton" onclick="buySpins()"
                      class="px-4 py-2 bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600
                             text-white font-bold rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200
                             disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 text-sm">
                🛒 购买1次 (+$<span id="buySpinsBtnPrice">40</span>)
              </button>
            </div>
          </div>

          <!-- 禁止状态提示 -->
          <div id="bannedNotice" class="hidden mt-3 p-3 bg-red-500/90 rounded-lg border border-red-300">
            <p class="text-white text-sm text-center font-semibold">
              🚫 您已被禁止抽奖
              <br>
              <span id="bannedUntilText" class="text-xs">解禁时间：--</span>
            </p>
          </div>
        </div>

        <!-- 老虎机滚轮容器 (1行4列) - 响应式 -->
        <div id="slotReelsContainer" class="bg-black/50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 lg:p-10 shadow-2xl mb-4 sm:mb-6 md:mb-8">
          <div id="slotReels" class="flex gap-2 sm:gap-3 md:gap-4 lg:gap-6 justify-center">
            <!-- 滚轮将通过 JavaScript 动态生成 -->
          </div>
        </div>

        <!-- 结果显示 - 响应式 -->
        <div id="slotResult" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 
                                         rounded-lg sm:rounded-xl px-4 sm:px-6 md:px-10 py-3 sm:py-4 md:py-5 mb-4 sm:mb-6 shadow-xl">
          <p id="slotResultText" class="text-white text-base sm:text-xl md:text-2xl lg:text-3xl font-bold text-center drop-shadow-lg"></p>
        </div>

        <!-- 🔥 高级场投注选择器和按钮（紧凑版，在滚轮下方）-->
        <div id="advancedBetSelector" class="hidden mb-6">
          <div class="max-w-xl mx-auto">
            <!-- 快捷金额按钮（动态生成）-->
            <div id="advancedBetOptions" class="flex items-center justify-center gap-2 mb-3">
              <!-- 按钮将通过 JavaScript 动态生成 -->
            </div>
            
            <!-- 滑块（紧凑版）-->
            <div class="px-4 mb-3">
              <input type="range" id="advancedBetSlider" min="100" max="500" step="10" value="100" 
                     class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
                     oninput="updateAdvancedBetDisplay(this.value)">
            </div>
            
            <!-- 🔥 高级场封禁状态提示 -->
            <div id="advancedBannedNotice" class="hidden mb-3 p-3 bg-red-500/90 rounded-lg border border-red-300">
              <p class="text-white text-sm text-center font-semibold">
                🚫 您已被禁止抽奖
                <br>
                <span id="advancedBannedUntilText" class="text-xs">解禁时间：--</span>
              </p>
            </div>
            
            <!-- 投注按钮 -->
            <button id="advancedSpinButton" onclick="spinSlot(false)" 
                    class="w-full px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700
                           text-white text-xl font-bold rounded-lg shadow-lg 
                           transform hover:scale-105 transition-all duration-200
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              <span class="flex items-center justify-center gap-2">
                <span>🎰</span>
                <span>投注</span>
                <span id="advancedBetDisplay" class="text-yellow-300">$100</span>
              </span>
            </button>
          </div>
        </div>

        <!-- 初级场控制按钮 - 响应式 -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 md:gap-6 w-full sm:w-auto px-4 sm:px-0">
          <button id="spinButton" onclick="spinSlot(false)" 
                  class="px-8 sm:px-12 md:px-16 py-3 sm:py-4 md:py-5 bg-gradient-to-r from-green-500 to-emerald-600 
                         text-white text-xl sm:text-2xl md:text-3xl font-bold rounded-lg sm:rounded-xl shadow-lg 
                         hover:scale-105 transform transition-all duration-200
                         disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            <span>🎰 spin</span> <span id="spinButtonPrice">($20)</span>
          </button>
          
          <button id="freeSpinButton" onclick="spinSlot(true)" 
                  class="hidden px-8 sm:px-12 md:px-16 py-3 sm:py-4 md:py-5 bg-gradient-to-r from-purple-500 to-pink-600 
                         text-white text-xl sm:text-2xl md:text-3xl font-bold rounded-lg sm:rounded-xl shadow-lg 
                         hover:scale-105 transform transition-all duration-200
                         disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            ✨ free spin
          </button>
        </div>

        <!-- 规则说明按钮 - 响应式 -->
        <button onclick="showSlotRules()" class="mt-4 sm:mt-6 text-white/70 hover:text-white text-sm sm:text-base transition-colors">
          📖 查看游戏规则
        </button>
        
        <!-- 🔥 投注限额进度条（仅高级场显示，在规则按钮下方）-->
        <div id="dailyBetLimitBar" class="hidden mt-6 max-w-xl mx-auto">
          <div class="bg-white/10 backdrop-blur-md rounded-lg px-6 py-3">
            <div class="flex items-center justify-between mb-2 text-xs sm:text-sm">
              <span id="dailyBetLimitTitle" class="text-white/80 font-medium">今日投注额度限额</span>
              <span id="dailyBetProgress" class="text-white font-bold">$0 / $5,000</span>
            </div>
            <div class="w-full h-2.5 bg-white/10 rounded-full overflow-hidden">
              <div id="dailyBetProgressBar" class="h-full bg-gradient-to-r from-green-500 to-yellow-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="dailyBetWarning" class="hidden text-xs sm:text-sm text-orange-400 mt-2 text-center font-medium">⚠️ 接近投注限额</p>
          </div>
        </div>
      </div>

      <!-- 左侧：亏损榜（悬浮显示）- 移动端隐藏 -->
      <div id="slotSidebarProfitBoard" class="absolute top-4 left-4 w-[360px] max-h-[calc(100vh-200px)] bg-gradient-to-b from-red-950/90 to-rose-950/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-red-500/30 overflow-hidden flex flex-col">
        <div class="p-4 bg-gradient-to-r from-red-600/30 to-rose-600/30 border-b border-red-500/30">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-red-400 flex items-center gap-2">
              <span>📉</span>
              <span>亏损榜 TOP 20</span>
            </h2>
            <div class="flex gap-1">
              <button onclick="loadSidebarLeaderboard(true)" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="刷新">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
              <button onclick="toggleLossBoard()" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="收起/展开">
                <svg id="lossBoardToggleIcon" class="w-4 h-4 text-white transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
          </div>
          <p class="text-xs text-white/70 text-center">最亏损用户top20</p>
          <p id="profitBoardLastUpdate" class="text-xs text-white/50 text-center mt-1">--</p>
        </div>
        
        <!-- 用户自己的盈亏（固定在上方）-->
        <div id="lossBoardContent" class="transition-all duration-300">
          <div class="px-4 py-3 bg-gradient-to-r from-red-600/20 to-rose-600/20 border-b border-red-500/20">
            <div class="text-white text-sm space-y-1">
              <div class="flex justify-between items-center">
                <span class="opacity-90">我的亏损排名：</span>
                <span id="profitBoardMyRank" class="font-bold text-yellow-300">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="opacity-90">我的盈亏：</span>
                <span id="profitBoardMyProfit" class="font-bold">$0</span>
              </div>
            </div>
          </div>

          <!-- 盈亏榜列表（可滚动）-->
          <div id="profitBoardList" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent" style="max-height: calc(100vh - 380px);">
            <div class="text-center text-white/50 py-8">加载中...</div>
          </div>
        </div>
      </div>

      <!-- 右侧：盈利榜（悬浮显示）- 移动端隐藏 -->
      <div id="slotSidebarLeaderboard" class="absolute top-4 right-4 w-[360px] max-h-[calc(100vh-200px)] bg-gradient-to-b from-emerald-900/90 to-green-900/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-green-500/30 overflow-hidden flex flex-col transition-all duration-300">
        <div class="p-4 bg-gradient-to-r from-green-600/30 to-emerald-600/30 border-b border-green-500/30">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-green-400 flex items-center gap-2">
              <span>🏆</span>
              <span>盈利榜 TOP 20</span>
            </h2>
            <div class="flex gap-1">
              <button onclick="loadSidebarLeaderboard(true)" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="刷新排行榜">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
              <button onclick="toggleProfitBoard()" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="收起/展开">
                <svg id="profitBoardToggleIcon" class="w-4 h-4 text-white transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
          </div>
          <p class="text-xs text-white/70 text-center">按总盈亏排名（总赢得 - 总投注）</p>
          <p id="leaderboardLastUpdate" class="text-xs text-white/50 text-center mt-1">--</p>
        </div>
        
        <!-- 用户自己的统计（固定在上方）-->
        <div id="profitBoardContent" class="transition-all duration-300">
          <div id="myLeaderboardStats" class="px-4 py-3 bg-gradient-to-r from-green-600/20 to-emerald-600/20 border-b border-green-500/20">
            <div class="text-white text-sm space-y-1">
              <div class="flex justify-between items-center">
                <span class="opacity-90">我的盈利排名：</span>
                <span id="sidebarMyRank" class="font-bold text-yellow-300">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="opacity-90">我的盈亏：</span>
                <span id="sidebarMyProfit" class="font-bold">$0</span>
              </div>
            </div>
          </div>

          <!-- 排行榜列表（可滚动）-->
          <div id="sidebarLeaderboard" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent" style="max-height: calc(100vh - 380px);">
            <div class="text-center text-white/50 py-8">加载中...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- 底部统计（固定底部）- 响应式 -->
    <div class="bg-black/30 backdrop-blur-md p-2 sm:p-3 md:p-4 text-center text-white border-t border-white/10">
      <!-- 今日统计 -->
      <div class="mb-1 sm:mb-2">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">📅 今日数据</p>
        <p class="text-xs sm:text-sm md:text-base">
          已玩 <span id="todayPlayed" class="font-bold text-yellow-400">0</span> 次 
          <span class="mx-1 sm:mx-2 text-white/40">|</span> 
          投注 <span id="todayBet" class="font-bold text-red-400">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          赢得 <span id="todayWon" class="font-bold text-green-400">$0</span>
        </p>
      </div>
      <!-- 历史总计 -->
      <div class="pt-1 sm:pt-2 border-t border-white/20">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">📊 历史总计</p>
        <p class="text-xs sm:text-sm md:text-base">
          总次数 <span id="totalPlayed" class="font-bold text-yellow-300">0</span> 次
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          总投注 <span id="totalBet" class="font-bold text-red-300">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          总获得 <span id="totalWon" class="font-bold text-green-300">$0</span>
        </p>
      </div>
      <!-- 当前余额和待发放 -->
      <div class="pt-1 sm:pt-2 border-t border-white/20">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">💰 账户信息</p>
        <p class="text-xs sm:text-sm md:text-base">
          当前余额 <span id="currentBalance" class="font-bold text-blue-300">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          待发放 <span id="pendingRewardsCount" class="font-bold text-orange-300">0</span> 条 (<span id="pendingRewardsAmount" class="font-bold text-orange-300">$0</span>)
          <button onclick="showPendingRewardsModal()" class="ml-2 px-2 py-0.5 bg-orange-500/30 hover:bg-orange-500/50 rounded text-xs transition-colors">
            查看详情
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- 待发放奖金弹窗 -->
  <div id="pendingRewardsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
      <!-- 标题栏 -->
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-orange-600 to-amber-600">
        <div>
          <h2 class="text-2xl font-bold text-white">💰 待发放奖金记录</h2>
          <p class="text-sm text-white/90 mt-1">查看您的奖金发放状态</p>
        </div>
        <button onclick="closePendingRewards()" class="text-white hover:text-yellow-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- 统计卡片 -->
      <div class="p-6 bg-gradient-to-r from-orange-50 to-amber-50 border-b border-slate-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">当前余额</p>
            <p id="modalCurrentBalance" class="text-2xl font-bold text-blue-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">待发放总数</p>
            <p id="modalPendingCount" class="text-2xl font-bold text-orange-600">0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">待发放金额</p>
            <p id="modalPendingAmount" class="text-2xl font-bold text-green-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">已发放金额</p>
            <p id="modalSuccessAmount" class="text-2xl font-bold text-purple-600">$0</p>
          </div>
        </div>
      </div>

      <!-- 说明 -->
      <div class="px-6 py-3 bg-blue-50 border-b border-blue-200">
        <div class="flex items-start gap-2 text-sm text-blue-800">
          <span>ℹ️</span>
          <div>
            <p><strong>说明：</strong>奖金发放失败时会记录到待发放列表，系统每60秒自动重试一次。</p>
            <p class="mt-1">• <strong>待处理</strong>：系统正在自动处理中</p>
            <p>• <strong>处理中</strong>：当前正在发放</p>
            <p>• <strong>成功</strong>：已成功发放到您的账户</p>
            <p>• <strong>失败</strong>：多次重试失败，请联系管理员</p>
          </div>
        </div>
      </div>

      <!-- 记录列表 -->
      <div class="p-6 overflow-y-auto flex-1">
        <div id="pendingRewardsList">
          <div class="text-center text-slate-500 py-8">加载中...</div>
        </div>
      </div>

      <!-- 底部按钮 -->
      <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
        <button onclick="refreshPendingRewards()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          刷新
        </button>
        <button onclick="closePendingRewards()" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors">
          关闭
        </button>
      </div>
    </div>
  </div>

  <!-- 老虎机记录弹窗 -->
  <div id="slotRecordsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
      <!-- 标题栏 -->
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-purple-600 to-indigo-600">
        <h2 id="slotRecordsTitle" class="text-2xl font-bold text-white">🎰 我的抽奖记录</h2>
        <button onclick="closeSlotRecords()" class="text-white hover:text-yellow-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- 搜索和筛选栏 -->
      <div class="p-4 border-b border-slate-200 bg-slate-50">
        <div class="flex flex-col sm:flex-row gap-3">
          <!-- 搜索框 -->
          <div class="flex-1">
            <div class="relative">
              <input 
                type="text" 
                id="recordSearchInput" 
                placeholder="搜索用户名..." 
                class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              >
              <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
          
          <!-- 中奖类型筛选 -->
          <div class="sm:w-64">
            <select 
              id="winTypeFilter" 
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            >
              <option value="all">全部类型</option>
              <option value="super_jackpot">🏆 超级大奖</option>
              <option value="special_combo">💎 特殊组合</option>
              <option value="quad">🎰 四连</option>
              <option value="triple">✨ 三连</option>
              <option value="double">🎁 双连</option>
              <option value="punishment">⚡ 律师函</option>
              <option value="none">❌ 未中奖</option>
            </select>
          </div>
          
          <!-- 操作按钮组 -->
          <div class="flex gap-2">
            <button 
              onclick="filterSlotRecords()" 
              class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all whitespace-nowrap font-semibold shadow-md"
            >
              🔍 查询
            </button>
            <button 
              onclick="refreshSlotRecordsKeepFilter()" 
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors whitespace-nowrap flex items-center gap-1"
              title="刷新数据（保留筛选条件）"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
            <button 
              onclick="clearRecordFilters()" 
              class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors whitespace-nowrap"
            >
              🔄 重置
            </button>
          </div>
        </div>
        
        <!-- 筛选结果提示 -->
        <div id="filterResultHint" class="mt-2 text-sm text-slate-600 hidden"></div>
      </div>
      
      <!-- 记录内容 -->
      <div class="overflow-y-auto flex-1">
        <!-- 待发放记录区域 -->
        <div id="pendingRewardsSection" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 border-b-2 border-orange-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-orange-700 flex items-center gap-2">
              <span>⏳</span>
              <span>待发放奖金</span>
            </h3>
            <button onclick="refreshPendingRewards()" class="text-sm text-orange-600 hover:text-orange-700 font-medium flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              刷新
            </button>
          </div>
          <div id="pendingRewardsContent">
            <!-- 待发放记录将通过 JavaScript 加载 -->
          </div>
        </div>
        
        <!-- 抽奖记录 -->
        <div id="slotRecordsContent" class="p-6">
          <!-- 记录将通过 JavaScript 加载 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 排行榜弹窗 -->
  <div id="leaderboardModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-emerald-500 to-green-600">
        <div>
          <h2 class="text-2xl font-bold text-white">🏆 排行榜</h2>
          <p class="text-sm text-white/90 mt-1">查看盈利榜和亏损榜（总赢得 - 总投注）</p>
        </div>
        <button onclick="closeLeaderboard()" class="text-white hover:text-gray-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- 标签页切换 -->
      <div class="flex border-b border-slate-200 bg-slate-50">
        <button id="profitTabBtn" onclick="switchLeaderboardTab('profit')" class="flex-1 px-6 py-4 text-center font-semibold transition-all border-b-2 border-green-500 bg-white text-green-600">
          🏆 盈利排行榜
        </button>
        <button id="lossTabBtn" onclick="switchLeaderboardTab('loss')" class="flex-1 px-6 py-4 text-center font-semibold transition-all border-b-2 border-transparent text-slate-600 hover:text-slate-900">
          📉 亏损排行榜
        </button>
      </div>

      <!-- 用户统计卡片 -->
      <div class="p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-slate-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">我的排名</p>
            <p id="myRank" class="text-2xl font-bold text-indigo-600">-</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">总游玩次数</p>
            <p id="myTotalSpins" class="text-2xl font-bold text-purple-600">0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">总投注</p>
            <p id="myTotalBet" class="text-2xl font-bold text-red-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">总盈亏</p>
            <p id="myTotalProfit" class="text-2xl font-bold">$0</p>
          </div>
        </div>
        <div class="mt-4 text-center">
          <p class="text-sm text-slate-600">最大单次奖金：<span id="myBiggestWin" class="text-lg font-bold text-orange-600">$0</span> <span id="myBiggestWinType" class="text-sm text-slate-500"></span></p>
        </div>
      </div>

      <!-- 排行榜内容区 -->
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-350px)]">
        <!-- 盈利排行榜 -->
        <div id="leaderboardContent">
          <!-- 排行榜内容 -->
        </div>
        
        <!-- 亏损排行榜 -->
        <div id="lossLeaderboardContent" class="hidden">
          <!-- 亏损榜内容 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 购买确认弹窗 -->
  <div id="buySpinsConfirmModal" onclick="if(event.target === this) cancelBuySpins()" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl animate-in">
      <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-orange-500 to-yellow-600">
        <h3 class="text-xl font-bold text-white flex items-center gap-2">
          <span>💰</span>
          <span>确认购买</span>
        </h3>
      </div>
      <div class="p-6">
        <div class="mb-6 text-center">
          <p class="text-lg text-slate-900 mb-3">确认购买1次抽奖机会吗？</p>
          <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-200">
            <p class="text-sm text-slate-700 mb-2">
              <span class="font-semibold">价格：</span>
              <span id="confirmBuyPrice" class="text-2xl font-bold text-orange-600">$40.00</span>
            </p>
            <p class="text-xs text-slate-600 mt-2">
              ⚠️ 购买后今日剩余次数+1（仍需投注 $20）
            </p>
          </div>
        </div>
        <div class="flex gap-3">
          <button onclick="cancelBuySpins()" class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-semibold transition-colors">
            取消
          </button>
          <button onclick="confirmBuySpins()" class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-yellow-600 hover:from-orange-600 hover:to-yellow-700 text-white rounded-lg font-semibold transition-all shadow-lg">
            确认购买
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 老虎机规则弹窗 -->
  <div id="slotRulesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-yellow-500 to-orange-600">
        <h2 class="text-2xl font-bold text-white">📖 游戏规则</h2>
        <button onclick="closeSlotRules()" class="text-white hover:text-gray-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-8 overflow-y-auto max-h-[calc(90vh-100px)]">
        <div class="space-y-6">
          <div>
            <h3 class="text-xl font-bold text-slate-900 mb-3">🎯 基本规则</h3>
            <ul class="list-disc list-inside space-y-2 text-slate-700" id="basicRules">
              <li>假如每次旋转投注 <strong id="basicRulesBetAmount">$20</strong></li>
              <li>每天有 <strong id="basicRulesMaxSpins">5次</strong> 游玩机会</li>
              <li>最低额度要求：<strong id="basicRulesMinQuota">$20</strong></li>
              <li>1行4列布局，共9种符号</li>
            </ul>
          </div>

          <div>
            <h3 class="text-xl font-bold text-slate-900 mb-3">💰 中奖规则</h3>
            <div class="space-y-3" id="slotRulesContent">
              <div class="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-2 border-yellow-300">
                <p class="font-bold text-lg text-orange-700">🏆 超级大奖（<span id="rulesSuperJackpot">256x$20</span>）</p>
                <p class="text-sm text-slate-600 mt-1">鸡→你→太→美 按顺序排列 或 偶像练习生背景→中分头→背带裤→篮球 按顺序排列</p>
              </div>
              
              <div class="p-3 bg-purple-50 rounded-lg border border-purple-300">
                <p class="font-bold text-purple-700">💎 特殊组合（<span id="rulesSpecialCombo">16x$20</span>）</p>
                <p class="text-sm text-slate-600 mt-1">包含 鸡你太美 全部（不按顺序）或 偶像练习生背景、中分头、背带裤、篮球 全部（不按顺序）</p>
              </div>
              
              <div class="p-3 bg-blue-50 rounded-lg border border-blue-300">
                <p class="font-bold text-blue-700">🎰 四连🐔（<span id="rulesQuad">32x$20</span>）+ 🎁 免费1次</p>
                <p class="text-sm text-slate-600 mt-1">4个相同符号</p>
              </div>
              
              <div class="p-3 bg-green-50 rounded-lg border border-green-300">
                <p class="font-bold text-green-700">✨ 三连🐔（<span id="rulesTriple">8x$20</span>）+ 🎁 免费1次</p>
                <p class="text-sm text-slate-600 mt-1">3个相同符号</p>
              </div>
              
              <div class="p-3 bg-teal-50 rounded-lg border border-teal-300">
                <p class="font-bold text-teal-700">🎁 双🐔（<span id="rulesDouble">4x$20</span>）</p>
                <p class="text-sm text-slate-600 mt-1">2个相同符号</p>
              </div>
              
                <div class="p-4 bg-red-50 rounded-lg border-2 border-red-400">
                  <p class="font-bold text-lg text-red-700">⚡ 律师函警告（梯度惩罚）</p>
                  <div class="text-sm text-slate-600 mt-2 space-y-1">
                    <p>• 出现 <strong>1个</strong> 律师函：扣除 <strong class="text-red-600">1倍</strong> 投注（如$20）</p>
                    <p>• 出现 <strong>2个</strong> 律师函：扣除 <strong class="text-red-600">2倍</strong> 投注（如$40）</p>
                    <p>• 出现 <strong>3个</strong> 律师函：扣除 <strong class="text-red-600">3倍</strong> 投注（如$60）+ <strong class="text-orange-600">禁止抽奖1坤天60小时</strong></p>
                    <p>• 出现 <strong>4个</strong> 律师函：扣除 <strong class="text-red-600">4倍</strong> 投注（如$80）+ <strong class="text-orange-600">禁止抽奖1坤天60小时</strong></p>
                    <p class="text-xs text-red-500 mt-2">⚠️ 额度不会扣为负数（最多扣到$0）</p>
                  </div>
                </div>
              
              <div class="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-300">
                <p class="text-sm text-slate-700">💰 投注金额：<span id="rulesBetAmount" class="font-bold text-blue-700">$20</span></p>
                <p class="text-xs text-slate-500 mt-1">以上金额基于当前投注金额计算</p>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-xl font-bold text-slate-900 mb-3">🎁 免费次数</h3>
            <ul class="list-disc list-inside space-y-2 text-slate-700">
              <li>抽中3个或4个相同符号，奖励1次免费机会</li>
              <li>免费次数可累积，没有上限</li>
              <li>使用免费次数不消耗额度，但仍可获得奖励</li>
            </ul>
          </div>

          <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
            <p class="font-bold text-yellow-800">⚠️ 温馨提示</p>
            <p class="text-sm text-yellow-700 mt-1">娱乐功能，请理性游玩，适度娱乐！</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== 音效系统 ==========
    
    // 🎵 音效管理器（升级版 - 使用真实音频文件）
    class SoundManager {
      constructor() {
        this.sounds = {};
        this.muted = localStorage.getItem('slotSoundMuted') === 'true';
        this.volume = parseFloat(localStorage.getItem('slotSoundVolume') || '0.5');
        this.initialized = false;
      }
      
      // 初始化音效
      init() {
        if (this.initialized) return;
        
        try {
          // 🎵 加载真实音频文件
          this.sounds.spin = new Audio('/sounds/mixkit-slot-machine-win-1928.wav');
          this.sounds.win = new Audio('/sounds/mixkit-coin-win-notification-1992.wav');
          this.sounds.lose = new Audio('/sounds/ngmhhy.mp3');
          
          // 设置音量
          Object.values(this.sounds).forEach(audio => {
            audio.volume = this.volume;
            audio.load(); // 预加载
          });
          
          this.initialized = true;
          // console.log('🔊 音效系统已初始化（使用真实音频文件）');
        } catch (error) {
          console.error('❌ 音效初始化失败:', error);
        }
      }
      
      // 播放指定音效
      playAudio(soundName, volumeMultiplier = 1.0) {
        if (this.muted || !this.initialized) return;
        
        try {
          const audio = this.sounds[soundName];
          if (!audio) {
            // console.warn(`音效 ${soundName} 不存在`);
            return;
          }
          
          // 重置播放位置
          audio.pause();
          audio.currentTime = 0;
          
          // 设置音量
          audio.volume = Math.max(0, Math.min(1, this.volume * volumeMultiplier));
          
          // 播放音效
          audio.play().catch(err => {
            // console.warn('音效播放失败:', err.message);
          });
        } catch (error) {
          console.error('播放音效出错:', error);
        }
      }
      
      // 停止指定音效
      stopAudio(soundName) {
        try {
          const audio = this.sounds[soundName];
          if (audio) {
            audio.pause();
            audio.currentTime = 0;
          }
        } catch (error) {
          console.error('停止音效出错:', error);
        }
      }
      
      // 旋转音效（5.5-6秒）
      playSpin() {
        this.init();
        this.playAudio('spin', 0.6); // 音量稍大，营造氛围
      }
      
      // 中奖音效
      playWin(multiplier) {
        this.init();
        
        // 🎯 根据倍率调整音量，超级大奖满音量
        if (multiplier >= 256) {
          this.playJackpot(); // 超级大奖特殊处理
        } else if (multiplier >= 32) {
          this.playAudio('win', 0.9); // 大奖
        } else {
          this.playAudio('win', 0.8); // 普通中奖
        }
      }
      
      // 超级大奖音效（满音量！）
      playJackpot() {
        this.init();
        this.playAudio('win', 1.0); // 🔥 满音量，最震撼！
      }
      
      // 未中奖/惩罚音效
      playLose() {
        this.init();
        this.playAudio('lose', 1.0);
      }
      
      // 惩罚音效（与未中奖使用相同音效）
      playPunishment() {
        this.init();
        this.playAudio('lose', 1.0);
      }
      
      // 按钮点击音效（保留简单音调）
      playClick() {
        this.init();
        // 使用Web Audio API生成简短的点击音
        if (!this.muted && this.audioContext) {
          try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.frequency.value = 600;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(this.volume * 0.3, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + 0.05);
          } catch (e) {
            console.error('播放点击音失败:', e);
          }
        }
      }
      
      // 切换静音
      toggleMute() {
        this.muted = !this.muted;
        localStorage.setItem('slotSoundMuted', this.muted);
        
        // 如果静音，停止所有音效
        if (this.muted) {
          Object.values(this.sounds).forEach(audio => {
            if (audio && audio.pause) {
              audio.pause();
            }
          });
        }
        
        return this.muted;
      }
      
      // 设置音量
      setVolume(vol) {
        this.volume = Math.max(0, Math.min(1, vol));
        localStorage.setItem('slotSoundVolume', this.volume);
        
        // 更新所有音频的音量
        Object.values(this.sounds).forEach(audio => {
          if (audio) {
            audio.volume = this.volume;
          }
        });
      }
    }
    
    // 创建全局音效管理器
    const soundManager = new SoundManager();
    
    // 音效控制函数
    function toggleSound() {
      const muted = soundManager.toggleMute();
      const icon = document.getElementById('soundIcon');
      icon.textContent = muted ? '🔇' : '🔊';
      showToast(muted ? '音效已关闭' : '音效已开启', 'success');
    }
    
    // ========== 配置 ==========
    
    const CONFIG = {
      LINUX_DO_AUTH_URL: 'https://connect.linux.do/oauth2/authorize',
      LINUX_DO_CLIENT_ID: '',
      LINUX_DO_REDIRECT_URI: window.location.origin + '/oauth/callback',
    };

    let currentUser = null;
    let currentMode = 'refuel'; // 'refuel' or 'entertain'

    // 保存当前模式到 URL hash
    function saveCurrentMode(mode) {
      currentMode = mode;
      // 使用 history.replaceState 避免增加历史记录
      if (mode === 'entertain') {
        window.location.hash = 'slot';
      } else {
        window.location.hash = '';
      }
    }

    // 从 URL hash 恢复模式
    function restoreMode() {
      const hash = window.location.hash.slice(1); // 移除 #
      if (hash === 'slot') {
        return 'entertain';
      }
      return 'refuel';
    }

    // 切换到加油站模式
    async function switchToRefuel() {
      if (currentMode === 'refuel') return;
      
      saveCurrentMode('refuel');
      
      // 更新主界面的切换按钮
      updateSwitchButtons('refuel');
      
      const mainSection = document.getElementById('mainSection');
      const slotModal = document.getElementById('slotMachineModal');
      
      // 添加退出动画
      slotModal.classList.add('fade-exit');
      
      // 等待动画完成
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // 切换显示
      slotModal.classList.add('hidden');
      slotModal.classList.remove('fade-exit');
      
      mainSection.classList.remove('hidden');
      mainSection.classList.add('fade-enter');
      
      // 触发进入动画
      requestAnimationFrame(() => {
        mainSection.classList.add('fade-enter-active');
      });
      
      // 完成动画后清理
      setTimeout(() => {
        mainSection.classList.remove('fade-enter', 'fade-enter-active');
      }, 300);
      
      // 刷新额度
      loadQuota();
    }

    // 切换到娱乐站模式
    function switchToEntertain() {
      if (currentMode === 'entertain') return;
      
      saveCurrentMode('entertain');
      
      // 更新主界面的切换按钮
      updateSwitchButtons('entertain');
      
      // 打开老虎机
      showSlotMachine();
    }

    // 更新所有切换按钮的样式（主界面和老虎机界面同步）
    function updateSwitchButtons(mode) {
      // 获取所有切换按钮容器
      const containers = document.querySelectorAll('[data-switch-container]');
      
      containers.forEach((container) => {
        const refuelBtn = container.querySelector('[data-btn="refuel"]');
        const entertainBtn = container.querySelector('[data-btn="entertain"]');
        
        // 检查是否在老虎机界面（暗色主题）
        const isDarkTheme = container.closest('#slotMachineModal') !== null;
        
        if (mode === 'refuel') {
          // 加油站模式激活
          if (isDarkTheme) {
            // 老虎机界面 - 暗色主题
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
          } else {
            // 主界面 - 亮色主题
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
          }
        } else {
          // 娱乐站模式激活
          if (isDarkTheme) {
            // 老虎机界面 - 暗色主题
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-lg';
          } else {
            // 主界面 - 亮色主题
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-md';
          }
        }
      });
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600';
      toast.className = `toast px-6 py-4 rounded-xl ${bgColor} text-white min-w-[300px]`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-6 h-6 rounded-full ${type === 'success' ? 'bg-white/20' : 'bg-white/20'} flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
            </svg>
          </div>
          <span class="font-medium">${message}</span>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showThankYouToast() {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 z-[10000] px-12 py-10 rounded-3xl bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white shadow-2xl';
      toast.style.animation = 'fadeInScale 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      toast.innerHTML = `
        <div class="relative">
          <!-- 粒子容器（在最底层） -->
          <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none" style="z-index: 0;">
            ${Array.from({length: 25}, (_, i) => `
              <div class="particle absolute w-1.5 h-1.5 bg-white rounded-full" style="
                left: ${Math.random() * 100}%;
                top: ${Math.random() * 100}%;
                opacity: ${0.15 + Math.random() * 0.2};
                animation: float ${2 + Math.random() * 3}s ease-in-out infinite;
                animation-delay: ${Math.random() * 2}s;
              "></div>
            `).join('')}
          </div>
          
          <!-- 内容（在最上层） -->
          <div class="relative text-center" style="z-index: 10;">
            <div class="text-6xl mb-4 animate-bounce">🎉</div>
            <div class="text-3xl font-bold mb-3 drop-shadow-lg">感谢您的支持！</div>
            <div class="text-lg opacity-95 mb-2 drop-shadow-md">您的投喂让公益站更好运行</div>
            <div class="flex items-center justify-center gap-2 text-sm opacity-90 drop-shadow-md">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
              </svg>
              <span>公益有你，未来可期</span>
            </div>
          </div>
        </div>
      `;
      
      // 添加动画样式
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeInScale {
          from {
            opacity: 0;
            transform: translate(-50%, -30px) scale(0.8);
          }
          to {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
          }
        }
        @keyframes fadeOutScale {
          from {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
          }
          to {
            opacity: 0;
            transform: translate(-50%, -30px) scale(0.8);
          }
        }
        @keyframes float {
          0%, 100% {
            transform: translateY(0) translateX(0);
          }
          25% {
            transform: translateY(-10px) translateX(5px);
          }
          50% {
            transform: translateY(-20px) translateX(-5px);
          }
          75% {
            transform: translateY(-10px) translateX(5px);
          }
        }
        .particle {
          pointer-events: none;
        }
      `;
      if (!document.querySelector('#thankYouToastStyle')) {
        style.id = 'thankYouToastStyle';
        document.head.appendChild(style);
      }
      
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOutScale 0.5s ease-in forwards';
        setTimeout(() => toast.remove(), 500);
      }, 4000);
    }

    function toggleDropdown() {
      document.getElementById('dropdownMenu').classList.toggle('hidden');
    }

    function toggleSlotDropdown() {
      document.getElementById('slotDropdownMenu').classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('dropdownMenu');
      const slotDropdown = document.getElementById('slotDropdownMenu');
      
      if (dropdown && !e.target.closest('button[onclick="toggleDropdown()"]') && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
      
      if (slotDropdown && !e.target.closest('button[onclick="toggleSlotDropdown()"]') && !slotDropdown.contains(e.target)) {
        slotDropdown.classList.add('hidden');
      }
    });

    function login() {
      sessionStorage.setItem('oauth_loading', 'true');
      const authUrl = `${CONFIG.LINUX_DO_AUTH_URL}?client_id=${CONFIG.LINUX_DO_CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.LINUX_DO_REDIRECT_URI)}&response_type=code&scope=user`;
      window.location.href = authUrl;
    }

    async function bindAccount() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        showMessage('请输入用户名', 'error', 'bind');
        return;
      }

      try {
        const res = await fetch('/api/auth/bind', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('bindSection').classList.add('hidden');
          document.getElementById('mainSection').classList.remove('hidden');
          await loadQuota();
          showToast(data.message, 'success');
        } else {
          showMessage(data.message, 'error', 'bind');
        }
      } catch (e) {
        showMessage('绑定失败', 'error', 'bind');
      }
    }

    async function loadQuota() {
      try {
        const res = await fetch('/api/user/quota');
        const data = await res.json();

        // 检查是否被封禁
        if (res.status === 403 && data.banned) {
          document.getElementById('mainSection').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
          alert('⚠️ ' + data.message);
          await logout();
          return;
        }

        if (data.success) {
          const { quota, used_quota, total, username, linux_do_id, linux_do_username, avatar_url } = data.data;

          // 显示LinuxDo用户名和公益站用户名
          // 优先显示 LinuxDo 用户名，如果为空则显示公益站用户名
          const displayName = linux_do_username && linux_do_username.trim() ? linux_do_username : username;
          document.getElementById('linuxDoUsername').textContent = `@${displayName}`;
          document.getElementById('userName').textContent = `公益站: ${username}`;
          document.getElementById('userId').textContent = 'ID: ' + linux_do_id;
          document.getElementById('userInitial').textContent = displayName[0].toUpperCase();

          // 设置用户头像
          if (avatar_url && avatar_url.trim()) {
            const userAvatar = document.getElementById('userAvatar');
            
            // 使用Image对象预加载，确保图片能正常加载
            const img = new Image();
            img.onload = function() {
              userAvatar.style.backgroundImage = `url(${avatar_url})`;
              userAvatar.style.backgroundSize = 'cover';
              userAvatar.style.backgroundPosition = 'center';
              document.getElementById('userInitial').textContent = '';
            };
            img.onerror = function() {
              // 如果加载失败，使用LinuxDo的letter_avatar（字母头像）
              const firstLetter = (linux_do_username || username).charAt(0).toLowerCase();
              const colorCode = firstLetter.charCodeAt(0) % 10;
              const fallbackUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/120.png`;
              const fallbackImg = new Image();
              fallbackImg.onload = function() {
                userAvatar.style.backgroundImage = `url(${fallbackUrl})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
                document.getElementById('userInitial').textContent = '';
              };
              fallbackImg.onerror = function() {
                console.error('[头像加载失败]', avatar_url);
              };
              fallbackImg.src = fallbackUrl;
            };
            img.src = avatar_url;
          } else {
            // 如果没有avatar_url，直接使用letter_avatar
            const firstLetter = (linux_do_username || username).charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            const letterAvatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/120.png`;
            const img = new Image();
            img.onload = function() {
              // console.log('[头像加载] Letter avatar加载成功');
              const userAvatar = document.getElementById('userAvatar');
              userAvatar.style.backgroundImage = `url(${letterAvatarUrl})`;
              userAvatar.style.backgroundSize = 'cover';
              userAvatar.style.backgroundPosition = 'center';
              document.getElementById('userInitial').textContent = '';
            };
            img.onerror = function() {
              console.error('[头像加载] Letter avatar失败，使用首字母');
            };
            img.src = letterAvatarUrl;
          }

          const quotaUSD = (quota / 500000).toFixed(2);
          document.getElementById('quotaValue').textContent = '$' + quotaUSD;
          document.getElementById('quotaUsage').textContent = ((used_quota / total * 100).toFixed(2)) + '%';
          document.getElementById('quotaStatus').textContent = quota < 10000000 ? '额度不足' : '充足';
          
          // 更新投喂说明（在获取配置后）
          const maxModelscope = data.data.max_daily_donate_modelscope || 1;
          const maxIflow = data.data.max_daily_donate_iflow || 1;
          if (maxModelscope === maxIflow) {
            document.getElementById('donateDescription').textContent = `每个有效的 API Key 可为您增加 $50 额度并获得1次免费抽奖 · 每种类型每天可投喂 ${maxModelscope} 个`;
          } else {
            document.getElementById('donateDescription').textContent = `每个有效的 API Key 可为您增加 $50 额度并获得1次免费抽奖 · ModelScope 每天可投喂 ${maxModelscope} 个，iFlow 每天可投喂 ${maxIflow} 个`;
          }

          // 更新领取次数信息
          const todayClaimCount = data.data.today_claim_count || 0;
          const maxDailyClaims = data.data.max_daily_claims || 1;
          const remainingClaims = data.data.remaining_claims || 0;
          
          document.getElementById('todayClaimCount').textContent = todayClaimCount;
          document.getElementById('maxDailyClaims').textContent = maxDailyClaims;
          document.getElementById('remainingClaims').textContent = remainingClaims > 0 ? `剩余 ${remainingClaims} 次` : '已用完';
          document.getElementById('remainingClaims').className = remainingClaims > 0 
            ? 'px-2 py-1 bg-blue-600 text-white rounded-full text-xs font-semibold'
            : 'px-2 py-1 bg-slate-400 text-white rounded-full text-xs font-semibold';

          const claimBtn = document.getElementById('claimBtn');
          if (remainingClaims === 0) {
            claimBtn.disabled = true;
            claimBtn.textContent = '✓ 今日已达上限';
            claimBtn.className = 'w-full bg-slate-400 text-white py-3 rounded-lg font-semibold cursor-not-allowed';
          } else if (!data.data.can_claim) {
            claimBtn.disabled = true;
            claimBtn.textContent = '❌ 额度充足';
            claimBtn.className = 'w-full bg-slate-400 text-white py-3 rounded-lg font-semibold cursor-not-allowed';
          } else {
            claimBtn.disabled = false;
            claimBtn.textContent = '领取今日额度';
            claimBtn.className = 'w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all';
          }

          // 处理 ModelScope 投喂状态
          const donateBtn = document.getElementById('donateBtn');
          const donateWarning = document.getElementById('donateWarning');
          const donatedToday = document.getElementById('donatedToday');
          const keysInput = document.getElementById('keysInput');
          
          const todayDonateModelscope = data.data.today_donate_modelscope_count || 0;
          const maxDonateModelscope = data.data.max_daily_donate_modelscope || 1;
          const remainingDonateModelscope = data.data.remaining_donate_modelscope || 0;
          
          // 更新投喂限制说明
          donateWarning.querySelector('span').innerHTML = `<strong>每天可以投喂 ${maxDonateModelscope} 个</strong>`;
          
          if (remainingDonateModelscope <= 0) {
            // 今日已达上限
            donateWarning.classList.add('hidden');
            donatedToday.classList.remove('hidden');
            donatedToday.querySelector('span').innerHTML = `✓ <strong>今日已投喂 ${todayDonateModelscope}/${maxDonateModelscope} 个</strong>`;
            donateBtn.disabled = true;
            donateBtn.textContent = '✓ 今日已投喂';
            donateBtn.className = 'w-full bg-slate-400 text-white py-2.5 rounded-lg font-semibold cursor-not-allowed text-sm mb-3';
            keysInput.disabled = true;
            keysInput.className = 'w-full h-24 px-3 py-2 border border-slate-200 rounded-lg mb-3 font-mono text-sm bg-slate-50 cursor-not-allowed resize-none';
          } else {
            // 可以继续投喂
            donateWarning.classList.remove('hidden');
            donatedToday.classList.add('hidden');
            donateBtn.disabled = false;
            donateBtn.textContent = `🚀 提交 ModelScope Key（还可投喂 ${remainingDonateModelscope} 个）`;
            donateBtn.className = 'w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3';
            keysInput.disabled = false;
            keysInput.className = 'w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm resize-none';
          }

          // 处理 iFlow 投喂状态
          const donateIflowBtn = document.getElementById('donateIflowBtn');
          const donateIflowWarning = document.getElementById('donateIflowWarning');
          const donatedIflowToday = document.getElementById('donatedIflowToday');
          const iflowKeysInput = document.getElementById('iflowKeysInput');
          
          const todayDonateIflow = data.data.today_donate_iflow_count || 0;
          const maxDonateIflow = data.data.max_daily_donate_iflow || 1;
          const remainingDonateIflow = data.data.remaining_donate_iflow || 0;
          
          // 更新投喂限制说明
          donateIflowWarning.querySelector('span').innerHTML = `<strong>每天可以投喂 ${maxDonateIflow} 个</strong>`;
          
          if (remainingDonateIflow <= 0) {
            // 今日已达上限
            donateIflowWarning.classList.add('hidden');
            donatedIflowToday.classList.remove('hidden');
            donatedIflowToday.querySelector('span').innerHTML = `✓ <strong>今日已投喂 ${todayDonateIflow}/${maxDonateIflow} 个</strong>`;
            donateIflowBtn.disabled = true;
            donateIflowBtn.textContent = '✓ 今日已投喂';
            donateIflowBtn.className = 'w-full bg-slate-400 text-white py-2.5 rounded-lg font-semibold cursor-not-allowed text-sm mb-3';
            iflowKeysInput.disabled = true;
            iflowKeysInput.className = 'w-full h-24 px-3 py-2 border border-slate-200 rounded-lg mb-3 font-mono text-sm bg-slate-50 cursor-not-allowed resize-none';
          } else {
            // 可以继续投喂
            donateIflowWarning.classList.remove('hidden');
            donatedIflowToday.classList.add('hidden');
            donateIflowBtn.disabled = false;
            donateIflowBtn.textContent = `🚀 提交 iFlow Key（还可投喂 ${remainingDonateIflow} 个）`;
            donateIflowBtn.className = 'w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3';
            iflowKeysInput.disabled = false;
            iflowKeysInput.className = 'w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-emerald-500 focus:border-transparent font-mono text-sm resize-none';
          }
        } else if (res.status === 400) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('bindSection').classList.remove('hidden');
        }
      } catch (e) {
        console.error('加载额度失败', e);
      }
    }

    async function claimQuota() {
      const btn = document.getElementById('claimBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> 领取中...';

      try {
        const res = await fetch('/api/claim/daily', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          await loadQuota();
        } else {
          showToast(data.message, 'error');
          btn.disabled = false;
          btn.textContent = originalText;
        }
      } catch (e) {
        showToast('领取失败', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function donateKeys() {
      const keysText = document.getElementById('keysInput').value.trim();
      if (!keysText) {
        showToast('请输入 Keys', 'error');
        return;
      }

      const keys = keysText.split('\n').map(k => k.trim()).filter(k => k);
      if (keys.length === 0) {
        showToast('没有有效的 Key', 'error');
        return;
      }

      // 提示：每天只能提交1个Key
      if (keys.length > 1) {
        showToast('每天只能提交 1 个 Key，已自动提取第一个', 'error');
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> 验证中...';

      try {
        const res = await fetch('/api/donate/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys }),
        });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          if (data.show_thanks) {
            setTimeout(() => showThankYouToast(), 500);
          }
          document.getElementById('keysInput').value = '';
          await loadQuota();
          
          // ✅ 如果投喂成功并返回了免费次数，显示提示
          if (data.free_spins !== undefined) {
            setTimeout(() => {
              showToast(`🎁 投喂成功！获得1次免费抽奖机会（当前共${data.free_spins}次）`, 'success');
            }, 1500);
            
            // 如果老虎机界面已打开，刷新配置
            const slotModal = document.getElementById('slotModal');
            if (slotModal && !slotModal.classList.contains('hidden')) {
              try {
                const configRes = await fetch('/api/slot/config');
                const configData = await configRes.json();
                if (configData.success) {
                  slotUserData = configData.data.user;
                  updateSlotUI();
                }
              } catch (error) {
                console.error('[免费次数同步失败]', error);
              }
            }
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (e) {
        showToast('提交失败', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function donateIflowKeys() {
      const keysText = document.getElementById('iflowKeysInput').value.trim();
      if (!keysText) {
        showToast('请输入 iFlow Keys', 'error');
        return;
      }

      const keys = keysText.split('\n').map(k => k.trim()).filter(k => k);
      if (keys.length === 0) {
        showToast('没有有效的 iFlow Key', 'error');
        return;
      }

      // 提示：每天只能提交1个Key
      if (keys.length > 1) {
        showToast('每天只能提交 1 个 iFlow Key，已自动提取第一个', 'error');
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> 验证中...';

      try {
        const res = await fetch('/api/donate/iflow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys }),
        });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          if (data.show_thanks) {
            setTimeout(() => showThankYouToast(), 500);
          }
          document.getElementById('iflowKeysInput').value = '';
          await loadQuota();
          
          // ✅ 如果投喂成功并返回了免费次数，显示提示
          if (data.free_spins !== undefined) {
            setTimeout(() => {
              showToast(`🎁 iFlow投喂成功！获得1次免费抽奖机会（当前共${data.free_spins}次）`, 'success');
            }, 1500);
            
            // 如果老虎机界面已打开，刷新配置
            const slotModal = document.getElementById('slotModal');
            if (slotModal && !slotModal.classList.contains('hidden')) {
              try {
                const configRes = await fetch('/api/slot/config');
                const configData = await configRes.json();
                if (configData.success) {
                  slotUserData = configData.data.user;
                  updateSlotUI();
                }
              } catch (error) {
                console.error('[免费次数同步失败]', error);
              }
            }
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (e) {
        showToast('提交失败', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function showMessage(text, type, section = 'main') {
      const msgId = section === 'bind' ? 'bindMessage' : 'message';
      const msg = document.getElementById(msgId);
      msg.textContent = text;
      msg.className = `p-4 rounded-lg mb-4 ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    async function showMyRecords() {
      // 关闭所有下拉菜单
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');
      
      document.getElementById('recordsModal').classList.remove('hidden');
      await loadMyRecords();
    }

    async function loadMyRecords() {
      try {
        const [claimRes, donateRes] = await Promise.all([
          fetch('/api/user/records/claim'),
          fetch('/api/user/records/donate')
        ]);
        const claimData = await claimRes.json();
        const donateData = await donateRes.json();

        const claimContainer = document.getElementById('claimRecords');
        const donateContainer = document.getElementById('donateRecords');

        // 渲染领取记录
        if (claimData.success && claimData.data.length > 0) {
          claimContainer.innerHTML = claimData.data.map(r => {
            const quotaUSD = (r.quota_added / 500000).toFixed(2);
            const isBindingBonus = r.quota_added === 50000000; // 绑定奖励是 $100

            const typeLabel = isBindingBonus
              ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-semibold">🎁 绑定奖励</span>'
              : '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">📅 每日领取</span>';

            return `
              <div class="border-b border-slate-200 py-3">
                <div class="flex items-center justify-between mb-1">
                  <p class="text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</p>
                  ${typeLabel}
                </div>
                <p class="font-semibold text-slate-900">领取额度: <span class="text-lg text-green-600">$${quotaUSD}</span></p>
              </div>
            `;
          }).join('');
        } else {
          claimContainer.innerHTML = '<p class="text-center text-slate-500 py-8">暂无领取记录</p>';
        }

        // 渲染投喂记录
        if (donateData.success && donateData.data.length > 0) {
          donateContainer.innerHTML = donateData.data.map(r => {
            const keyTypeLabel = r.key_type === 'iflow'
              ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold">✨ iFlow</span>'
              : '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">🎁 ModelScope</span>';

            return `
              <div class="border-b border-slate-200 py-3">
                <div class="flex items-center justify-between mb-1">
                  <p class="text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</p>
                  ${keyTypeLabel}
                </div>
                <p class="font-semibold text-slate-900">投喂 ${r.keys_count} 个 Key，增加额度: <span class="text-lg text-green-600">$${(r.total_quota_added / 500000).toFixed(2)}</span></p>
              </div>
            `;
          }).join('');
        } else {
          donateContainer.innerHTML = '<p class="text-center text-slate-500 py-8">暂无投喂记录</p>';
        }
      } catch (e) {
        console.error('加载记录失败', e);
      }
    }

    function closeModal() {
      document.getElementById('recordsModal').classList.add('hidden');
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-600', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-slate-500');
      });
      event.target.classList.add('border-indigo-600', 'text-indigo-600');
      event.target.classList.remove('border-transparent', 'text-slate-500');

      if (tab === 'claim') {
        document.getElementById('claimRecords').classList.remove('hidden');
        document.getElementById('donateRecords').classList.add('hidden');
      } else {
        document.getElementById('claimRecords').classList.add('hidden');
        document.getElementById('donateRecords').classList.remove('hidden');
      }
    }

    async function logout() {
      if (!confirm('确定要退出登录吗？')) return;
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.reload();
      } catch (e) {
        showToast('登出失败', 'error');
      }
    }

    // ========== 老虎机相关功能 ==========
    
    const SLOT_SYMBOLS = ['m', 't', 'n', 'j', 'lq', 'bj', 'zft', 'bdk', 'lsh'];
    let slotConfig = null;
    let slotUserData = null;
    let isSpinning = false;
    
    // 🔥 高级场相关变量
    let advancedTicketsData = null;  // 入场券和碎片数据
    let advancedModeTimer = null;    // 高级场倒计时定时器
    let isInAdvancedMode = false;    // 是否在高级场
    let advancedBetAmount = 100;     // 高级场投注金额（美元，默认$100）
    let advancedBetMin = 100;        // 高级场最小投注
    let advancedBetMax = 500;        // 高级场最大投注

    // 🔥 动态生成投注选项按钮
    function generateAdvancedBetOptions(minBet, maxBet) {
      const container = document.getElementById('advancedBetOptions');
      if (!container) return;
      
      // 清空现有按钮
      container.innerHTML = '';
      
      // 计算合适的选项（均匀分布4个选项）
      const range = maxBet - minBet;
      const options = [];
      
      if (range <= 100) {
        // 范围很小，直接使用最小和最大值
        options.push(minBet, maxBet);
      } else if (range <= 400) {
        // 中等范围，生成3-4个选项
        options.push(minBet);
        const step = Math.floor(range / 3);
        options.push(minBet + step);
        options.push(minBet + step * 2);
        options.push(maxBet);
      } else {
        // 大范围，生成4个均匀分布的选项
        const step = Math.floor(range / 3);
        options.push(minBet);
        options.push(minBet + step);
        options.push(minBet + step * 2);
        options.push(maxBet);
      }
      
      // 去重并排序
      const uniqueOptions = [...new Set(options)].sort((a, b) => a - b);
      
      // 生成按钮
      uniqueOptions.forEach(amount => {
        const button = document.createElement('button');
        button.onclick = () => setAdvancedBet(amount);
        button.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        button.setAttribute('data-amount', amount);
        button.textContent = `$${amount}`;
        container.appendChild(button);
      });
      
      // console.log('[高级场] 动态生成投注选项:', uniqueOptions);
    }
    
    // 🔥 设置高级场投注金额
    function setAdvancedBet(amount) {
      advancedBetAmount = amount;
      document.getElementById('advancedBetSlider').value = amount;
      document.getElementById('advancedBetDisplay').textContent = `$${amount}`;
      
      // 高亮选中的按钮
      document.querySelectorAll('.advanced-bet-option').forEach(btn => {
        if (parseInt(btn.dataset.amount) === amount) {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-lg font-bold transition-all shadow-lg text-sm';
        } else {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        }
      });
      
      // 🔥 更新投注按钮状态
      updateAdvancedSpinButtonState();
      
      // console.log('[高级场] 投注金额设置为:', amount);
    }

    // 🔥 更新投注金额显示（滑块）
    function updateAdvancedBetDisplay(value) {
      advancedBetAmount = parseInt(value);
      document.getElementById('advancedBetDisplay').textContent = `$${value}`;
      
      // 更新按钮高亮（只有精确匹配的才高亮）
      const presets = [100, 200, 300, 500];
      
      document.querySelectorAll('.advanced-bet-option').forEach(btn => {
        const amount = parseInt(btn.dataset.amount);
        if (amount === advancedBetAmount) {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-lg font-bold transition-all shadow-lg text-sm';
        } else {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        }
      });
      
      // 🔥 更新投注按钮状态
      updateAdvancedSpinButtonState();
    }

    // 🔥 更新高级场投注按钮状态（独立函数）
    function updateAdvancedSpinButtonState() {
      if (!isInAdvancedMode || !slotUserData) return;
      
      const advSpinBtn = document.getElementById('advancedSpinButton');
      if (!advSpinBtn) return;
      
      // 检查用户是否被禁止
      if (slotUserData.is_banned) {
        advSpinBtn.disabled = true;
        // console.log('[高级场] 投注按钮禁用：用户被禁止');
        return;
      }
      
      // 检查余额是否足够投注
      const requiredQuota = advancedBetAmount * 500000;
      if (slotUserData.quota >= requiredQuota) {
        advSpinBtn.disabled = false;
        // console.log('[高级场] 投注按钮已启用');
      } else {
        advSpinBtn.disabled = true;
        // console.log('[高级场] 投注按钮禁用：余额不足，需要', requiredQuota, '当前', slotUserData.quota);
      }
    }

    // 🔥 更新投注限额进度条（独立函数）
    function updateBetLimitProgressBar() {
      // console.log('[进度条] ========== updateBetLimitProgressBar 被调用 ==========');
      // console.log('[进度条] isInAdvancedMode:', isInAdvancedMode);
      // console.log('[进度条] slotUserData:', slotUserData);
      // console.log('[进度条] advancedTicketsData:', advancedTicketsData);
      
      if (!slotUserData) {
        // console.warn('[进度条] slotUserData 不存在，跳过更新');
        return;
      }
      
      const dailyBetLimitBar = document.getElementById('dailyBetLimitBar');
      // console.log('[进度条] 找到元素 dailyBetLimitBar:', dailyBetLimitBar);
      // console.log('[进度条] 元素当前 classList:', dailyBetLimitBar?.classList);
      
      if (!dailyBetLimitBar) {
        // console.error('[进度条] ❌ 找不到 dailyBetLimitBar 元素！');
        return;
      }
      
      if (isInAdvancedMode) {
        // 🔥 高级场：显示投注额度限额进度条
        // console.log('[进度条] ✅ 高级场模式 - 准备显示进度条');
        dailyBetLimitBar.classList.remove('hidden');
        // console.log('[进度条] ✅ 已移除 hidden 类，当前 class:', dailyBetLimitBar.className);
        // console.log('[进度条] ✅ computed style display:', window.getComputedStyle(dailyBetLimitBar).display);
        
        const titleEl = document.getElementById('dailyBetLimitTitle');
        const progressText = document.getElementById('dailyBetProgress');
        const progressBar = document.getElementById('dailyBetProgressBar');
        const warningText = document.getElementById('dailyBetWarning');
        
        // 从配置获取高级场每日投注限额（管理员可配置）
        const betLimit = advancedTicketsData?.config?.daily_bet_limit 
          ? advancedTicketsData.config.daily_bet_limit / 500000 
          : 5000; // 默认$5000
        const todayBetAmount = (slotUserData.today_bet || 0) / 500000;
        const betPercentage = Math.min((todayBetAmount / betLimit) * 100, 100);
        
        // console.log('[进度条] 限额:', betLimit, '已投注:', todayBetAmount, '进度:', betPercentage + '%');
        
        if (titleEl) titleEl.textContent = '今日投注额度限额';
        if (progressText) {
          progressText.textContent = `$${todayBetAmount.toFixed(2)} / $${betLimit.toLocaleString()}`;
        }
        
        if (progressBar) {
          progressBar.style.width = `${betPercentage}%`;
          // 根据进度改变颜色
          if (betPercentage >= 100) {
            progressBar.className = 'h-full bg-gradient-to-r from-red-600 to-red-800 transition-all duration-300';
          } else if (betPercentage >= 80) {
            progressBar.className = 'h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-300';
          } else if (betPercentage >= 60) {
            progressBar.className = 'h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-300';
          } else {
            progressBar.className = 'h-full bg-gradient-to-r from-green-500 to-yellow-500 transition-all duration-300';
          }
        }
        
        // 显示警告
        if (warningText) {
          if (betPercentage >= 80) {
            warningText.classList.remove('hidden');
            if (betPercentage >= 100) {
              warningText.textContent = '⛔ 已达到投注限额';
              warningText.className = 'text-xs text-red-400 mt-1';
            } else {
              warningText.textContent = '⚠️ 接近投注限额';
              warningText.className = 'text-xs text-orange-400 mt-1';
            }
          } else {
            warningText.classList.add('hidden');
          }
        }
      } else {
        // 🔥 初级场：隐藏投注限额进度条（初级场使用次数限制）
        // console.log('[进度条] 初级场模式 - 隐藏进度条');
        dailyBetLimitBar.classList.add('hidden');
      }
    }
    
    // 🔥 加载入场券信息
    async function loadAdvancedTickets() {
      try {
        const res = await fetch('/api/slot/tickets');
        const data = await res.json();
        
        if (data.success) {
          advancedTicketsData = data.data;
          updateAdvancedTicketsUI();
          // console.log('[高级场] 入场券信息:', advancedTicketsData);
        }
      } catch (error) {
        console.error('[高级场] 加载入场券信息失败:', error);
      }
    }

    // 🔥 更新入场券UI
    function updateAdvancedTicketsUI() {
      if (!advancedTicketsData) return;
      
      const { tickets, fragments, can_synthesize, in_advanced_mode, fragments_needed, max_tickets_hold, config } = advancedTicketsData;
      
      // 更新数据显示
      document.getElementById('ticketCount').textContent = tickets;
      document.getElementById('ticketMax').textContent = max_tickets_hold;
      document.getElementById('fragmentCount').textContent = fragments;
      document.getElementById('fragmentsNeeded').textContent = fragments_needed;
      
      // 🔥 更新每日限制信息（如果配置存在）
      if (config) {
        // 显示每日进入限制信息
        const dailyEntryInfo = document.getElementById('dailyEntryInfo');
        const dailyEntryLimit = document.getElementById('dailyEntryLimit');
        const todayEntryCount = document.getElementById('todayEntryCount');
        if (dailyEntryInfo && dailyEntryLimit && config.daily_entry_limit) {
          dailyEntryLimit.textContent = config.daily_entry_limit;
          // 更新今日已进入次数
          if (todayEntryCount && advancedTicketsData.today_entry_count !== undefined) {
            todayEntryCount.textContent = advancedTicketsData.today_entry_count;
          }
          // 只在未进入高级场时显示每日进入次数信息
          if (!in_advanced_mode) {
            dailyEntryInfo.classList.remove('hidden');
          } else {
            dailyEntryInfo.classList.add('hidden');
          }
        }
        
        // 显示每日入场券获得限制（作为工具提示）
        const dailyTicketGrantInfo = document.getElementById('dailyTicketGrantInfo');
        if (dailyTicketGrantInfo && config.daily_ticket_grant_limit) {
          const grantedText = advancedTicketsData.today_ticket_granted !== undefined 
            ? `(今日已获${advancedTicketsData.today_ticket_granted}/${config.daily_ticket_grant_limit}张)`
            : `(每日限${config.daily_ticket_grant_limit}张)`;
          dailyTicketGrantInfo.textContent = grantedText;
          dailyTicketGrantInfo.classList.remove('hidden');
        }
      }
      
      // 更新过期时间
      const expiryEl = document.getElementById('ticketExpiry');
      if (advancedTicketsData.tickets_expires_at && tickets > 0) {
        const expiryDate = new Date(advancedTicketsData.tickets_expires_at);
        expiryEl.textContent = `过期: ${expiryDate.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
      } else {
        expiryEl.textContent = '';
      }
      
      // 更新合成按钮状态
      const synthesizeBtn = document.getElementById('synthesizeButton');
      if (can_synthesize && tickets < max_tickets_hold) {
        synthesizeBtn.disabled = false;
      } else {
        synthesizeBtn.disabled = true;
      }
      
      // 更新进入高级场按钮状态
      const enterBtn = document.getElementById('enterAdvancedButton');
      enterBtn.disabled = tickets < 1;
      
      // 🎯 改进：显示/隐藏入场券栏和高级场指示器
      const ticketBar = document.getElementById('advancedTicketBar');
      const modeIndicator = document.getElementById('advancedModeIndicator');  // 🔥 导航栏右上角的指示器
      const betSelector = document.getElementById('advancedBetSelector');
      const freeSpinButton = document.getElementById('freeSpinButton');
      const normalSpinButton = document.getElementById('spinButton');
      
      if (in_advanced_mode) {
        // console.log('[高级场] 更新UI为高级场模式');
        // 在高级场：隐藏入场券栏，显示高级场指示器和投注选择器
        ticketBar.classList.add('hidden');
        modeIndicator.classList.remove('hidden');  // 🔥 显示右上角指示器
        betSelector.classList.remove('hidden');     // 🔥 显示投注选择器
        freeSpinButton.classList.add('hidden');     // 🔥 隐藏免费抽奖
        normalSpinButton.classList.add('hidden');   // 🔥 隐藏初级场spin按钮
        
        // 🔥 隐藏初级场次数显示
        const normalSpinsDisplay = document.getElementById('normalModeSpinsDisplay');
        if (normalSpinsDisplay) normalSpinsDisplay.classList.add('hidden');
        
        // 🔥 显示高级场标题，隐藏初级场标题
        const advancedTitle = document.getElementById('advancedModeTitle');
        const normalTitle = document.getElementById('normalModeTitle');
        if (advancedTitle) advancedTitle.classList.remove('hidden');
        if (normalTitle) normalTitle.classList.add('hidden');
        
        isInAdvancedMode = true;
        startAdvancedModeTimer();
        
        // 🔥 从高级场状态中获取投注范围并动态生成选项
        if (advancedTicketsData.config) {
          advancedBetMin = advancedTicketsData.config.bet_min / 500000;
          advancedBetMax = advancedTicketsData.config.bet_max / 500000;
          
          // 🔥 动态生成投注选项按钮
          generateAdvancedBetOptions(advancedBetMin, advancedBetMax);
          
          // 更新滑块范围和步长
          const slider = document.getElementById('advancedBetSlider');
          slider.min = advancedBetMin;
          slider.max = advancedBetMax;
          // 动态计算合适的步长
          const range = advancedBetMax - advancedBetMin;
          slider.step = range <= 100 ? 5 : (range <= 500 ? 10 : 50);
          
          // 如果当前投注超出范围，重置为最小值
          if (advancedBetAmount < advancedBetMin || advancedBetAmount > advancedBetMax) {
            setAdvancedBet(advancedBetMin);
          }
          
          // console.log(`[高级场] 投注范围: $${advancedBetMin} ~ $${advancedBetMax}, 步长: ${slider.step}`);
        }
        
        // 🔥 立即更新进度条显示（确保高级场进度条显示）
        updateBetLimitProgressBar();
        
        // 🔥 更新投注按钮状态（确保按钮在进入高级场后正确启用）
        updateAdvancedSpinButtonState();
      } else {
        // 不在高级场：常驻显示入场券栏，隐藏高级场指示器和投注选择器
        ticketBar.classList.remove('hidden');
        modeIndicator.classList.add('hidden');    // 🔥 隐藏右上角指示器
        betSelector.classList.add('hidden');      // 🔥 隐藏投注选择器
        if (freeSpinButton) freeSpinButton.classList.remove('hidden'); // 🔥 显示免费抽奖
        normalSpinButton.classList.remove('hidden'); // 🔥 显示初级场spin按钮
        
        // 🔥 显示初级场次数显示
        const normalSpinsDisplay = document.getElementById('normalModeSpinsDisplay');
        if (normalSpinsDisplay) normalSpinsDisplay.classList.remove('hidden');
        
        // 🔥 隐藏高级场标题，显示初级场标题
        const advancedTitle = document.getElementById('advancedModeTitle');
        const normalTitle = document.getElementById('normalModeTitle');
        if (advancedTitle) advancedTitle.classList.add('hidden');
        if (normalTitle) normalTitle.classList.remove('hidden');
        
        isInAdvancedMode = false;
        stopAdvancedModeTimer();
        
        // 🔥 更新进度条显示（确保初级场进度条隐藏）
        updateBetLimitProgressBar();
      }
    }

    // 🔥 合成入场券
    async function synthesizeTicket() {
      if (!advancedTicketsData || !advancedTicketsData.can_synthesize) {
        showToast('碎片不足，无法合成', 'error');
        return;
      }
      
      const btn = document.getElementById('synthesizeButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '⏳ 合成中...';
      
      try {
        const res = await fetch('/api/slot/tickets/synthesize', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          // 刷新入场券信息
          await loadAdvancedTickets();
          
          // 🎉 合成成功特效
          playTicketSynthesizeAnimation();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[高级场] 合成失败:', error);
        showToast('合成失败，请重试', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // 🔥 进入高级场
    async function enterAdvancedMode() {
      // console.log('[高级场] 尝试进入高级场...');
      if (!advancedTicketsData || advancedTicketsData.tickets < 1) {
        showToast('入场券不足', 'error');
        return;
      }
      
      const btn = document.getElementById('enterAdvancedButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '⏳ 进入中...';
      
      try {
        const res = await fetch('/api/slot/advanced/enter', {
          method: 'POST'
        });
        const data = await res.json();
        // console.log('[高级场] 进入高级场响应:', data);
        
        if (data.success) {
          showToast('🔥 ' + data.message, 'success');
          
          // 🔥 立即设置高级场状态
          isInAdvancedMode = true;
          
          // 🔥 并行加载配置和入场券信息
          const [configRes] = await Promise.all([
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // 这会调用 updateAdvancedTicketsUI
          ]);
          
          if (configRes && configRes.success) {
            slotConfig = configRes.data.config;
            slotUserData = configRes.data.user;
          }
          
          // 🔥 再次更新UI确保所有状态正确
          updateSlotUI();
          
          // 🔥 强制更新高级场UI（确保显示正确）
          if (advancedTicketsData) {
            updateAdvancedTicketsUI();
          }
          
          // 🎉 进入高级场特效
          playEnterAdvancedAnimation();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[高级场] 进入失败:', error);
        showToast('进入失败，请重试', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // 🔥 退出高级场
    async function exitAdvancedMode() {
      if (!confirm('确定要退出高级场吗？\n退出后需要重新使用入场券才能进入。')) {
        return;
      }
      
      try {
        const res = await fetch('/api/slot/advanced/exit', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          
          // 🔥 立即设置为初级场状态
          isInAdvancedMode = false;
          
          // 🔥 并行加载配置和入场券信息
          const [configRes] = await Promise.all([
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // 这会调用 updateAdvancedTicketsUI
          ]);
          
          if (configRes && configRes.success) {
            slotConfig = configRes.data.config;
            slotUserData = configRes.data.user;
          }
          
          // 🔥 更新UI确保显示正确的投注金额
          updateSlotUI();
          
          // 🔥 强制更新UI（确保退出高级场后UI正确）
          if (advancedTicketsData) {
            updateAdvancedTicketsUI();
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[高级场] 退出失败:', error);
        showToast('退出失败，请重试', 'error');
      }
    }

    // 🔥 启动高级场倒计时
    function startAdvancedModeTimer() {
      stopAdvancedModeTimer(); // 先停止旧的定时器
      
      if (!advancedTicketsData || !advancedTicketsData.advanced_mode_until) return;
      
      const updateTimer = () => {
        const now = Date.now();
        const remaining = advancedTicketsData.advanced_mode_until - now;
        
        if (remaining <= 0) {
          // 时间到，自动退出高级场
          const timeEl = document.getElementById('advancedTimeRemaining');
          if (timeEl) timeEl.textContent = '00:00:00';
          stopAdvancedModeTimer();
          showToast('高级场时间已到，已自动退出', 'error');
          
          // 🔥 立即设置为初级场状态
          isInAdvancedMode = false;
          
          // 🔥 并行刷新状态和重新加载配置
          Promise.all([
            loadAdvancedTickets(),  // 这会调用 updateAdvancedTicketsUI
            fetch('/api/slot/config').then(res => res.json())
          ]).then(([_, configData]) => {
            if (configData && configData.success) {
              slotConfig = configData.data.config;
              slotUserData = configData.data.user;
              updateSlotUI(); // 🔥 更新UI，确保显示正确的投注金额
            }
            
            // 🔥 强制更新UI（确保退出高级场后UI正确）
            if (advancedTicketsData) {
              updateAdvancedTicketsUI();
            }
          }).catch(error => {
            console.error('[高级场] 自动退出时重新加载配置失败:', error);
          });
          
          return;
        }
        
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // 🔥 更新导航栏中的倒计时
        const timeEl = document.getElementById('advancedTimeRemaining');
        if (timeEl) timeEl.textContent = timeStr;
      };
      
      updateTimer(); // 立即更新一次
      advancedModeTimer = setInterval(updateTimer, 1000);
    }

    // 🔥 停止高级场倒计时
    function stopAdvancedModeTimer() {
      if (advancedModeTimer) {
        clearInterval(advancedModeTimer);
        advancedModeTimer = null;
      }
    }

    // 🎉 合成成功动画
    function playTicketSynthesizeAnimation() {
      // TODO: 添加炫酷的合成动画特效
      // console.log('[动画] 播放合成成功动画');
    }

    // 🎉 进入高级场动画
    function playEnterAdvancedAnimation() {
      // TODO: 添加进入高级场的特效
      // console.log('[动画] 播放进入高级场动画');
    }

    // 🎉 掉落动画
    function playTicketDropAnimation(dropType, dropCount) {
      const icon = dropType === 'ticket' ? '🎟️' : '🧩';
      const name = dropType === 'ticket' ? '入场券' : '碎片';
      
      // 创建掉落特效元素
      const dropEffect = document.createElement('div');
      dropEffect.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[10000]';
      dropEffect.style.animation = 'fadeInScale 0.5s ease-out, fadeOutScale 0.5s ease-in 1.5s';
      dropEffect.innerHTML = `
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl px-12 py-8 shadow-2xl border-4 border-yellow-400">
          <div class="text-center">
            <div class="text-8xl mb-4 animate-bounce">${icon}</div>
            <div class="text-3xl font-bold text-white mb-2">恭喜获得！</div>
            <div class="text-2xl text-yellow-300">${name} × ${dropCount}</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(dropEffect);
      
      setTimeout(() => {
        dropEffect.remove();
      }, 2000);
      
      // console.log('[动画] 播放掉落动画:', dropType, dropCount);
    }

    // 初始化老虎机滚轮
    function initSlotReels() {
      const reelsContainer = document.getElementById('slotReels');
      reelsContainer.innerHTML = '';

      for (let i = 0; i < 4; i++) {
        const reelContainer = document.createElement('div');
        reelContainer.className = 'slot-reel-container';
        reelContainer.innerHTML = `
          <div class="slot-reel" data-reel="${i}">
            <div class="slot-symbols"></div>
          </div>
        `;
        reelsContainer.appendChild(reelContainer);
      }

      // 为每个滚轮填充初始符号（显示一个随机符号）
      document.querySelectorAll('.slot-reel').forEach((reel, idx) => {
        const symbolsContainer = reel.querySelector('.slot-symbols');
        // 初始显示一个随机符号
        const initialSymbol = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
        symbolsContainer.appendChild(createSymbolElement(initialSymbol));
        
        // 确保容器样式正确
        symbolsContainer.style.transform = 'translateY(0)';
        symbolsContainer.style.filter = 'none';
      });
    }

    // 创建符号元素
    function createSymbolElement(symbolName) {
      const div = document.createElement('div');
      div.className = 'slot-symbol';
      div.setAttribute('data-symbol', symbolName);
      
      const img = document.createElement('img');
      const ext = ['lq', 'bj', 'bdk'].includes(symbolName) ? 'jpg' : 'png';
      img.src = `/slot-symbols/${symbolName}.${ext}`;
      img.alt = symbolName;
      img.loading = 'eager'; // 立即加载
      
      img.onerror = () => {
        console.error('图片加载失败:', symbolName, `扩展名: ${ext}`);
        // 创建一个带文字的占位符
        img.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="150" height="150" fill="%23667eea"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="24" fill="white">${symbolName}</text></svg>`;
      };
      
      img.onload = () => {
        // console.log('✅ 图片加载成功:', symbolName);
      };
      
      div.appendChild(img);
      return div;
    }

    // 打开老虎机
    async function showSlotMachine() {
      try {
        const mainSection = document.getElementById('mainSection');
        const slotModal = document.getElementById('slotMachineModal');
        const loadingOverlay = document.getElementById('slotLoadingOverlay');

        // 1. 立即显示老虎机界面（带loading遮罩）- 提供即时反馈
        mainSection.classList.add('fade-exit');
        
        // 等待退出动画完成
        await new Promise(resolve => setTimeout(resolve, 200));
        
        mainSection.classList.add('hidden');
        mainSection.classList.remove('fade-exit');
        
        // 显示老虎机界面和loading
        slotModal.classList.remove('hidden');
        loadingOverlay.classList.remove('hidden');
        slotModal.classList.add('fade-enter');
        
        // 触发进入动画
        requestAnimationFrame(() => {
          slotModal.classList.add('fade-enter-active');
        });

        // 2. 异步加载配置数据（不阻塞界面显示）
        const [configData] = await Promise.all([
          fetch('/api/slot/config').then(res => res.json()),
          // 添加一个最小延迟，确保动画流畅
          new Promise(resolve => setTimeout(resolve, 300))
        ]);

        if (!configData.success) {
          loadingOverlay.classList.add('hidden');
          showToast(configData.message, 'error');
          // 如果未登录或其他错误，切换回加油站模式
          if (currentMode === 'entertain') {
            switchToRefuel();
          }
          return;
        }

        slotConfig = configData.data.config;
        slotUserData = configData.data.user;

        // 应用背景配置
        const slotBg = document.querySelector('.slot-machine-bg');
        if (slotBg && slotConfig.background_type) {
          if (slotConfig.background_type === 'gif') {
            const backgroundAssetUrl = slotConfig.background_asset_url || '/ctrl.gif';
            slotBg.style.background = `linear-gradient(135deg, rgba(30, 58, 138, 0.7) 0%, rgba(59, 130, 246, 0.7) 50%, rgba(139, 92, 246, 0.7) 100%), url('${backgroundAssetUrl}')`;
            slotBg.style.backgroundSize = 'cover, cover';
            slotBg.style.backgroundPosition = 'center, center';
            slotBg.style.backgroundRepeat = 'no-repeat, no-repeat';
          } else {
            slotBg.style.background = 'linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 50%, rgba(139, 92, 246, 0.9) 100%)';
            slotBg.style.backgroundSize = 'cover';
            slotBg.style.backgroundPosition = 'center';
            slotBg.style.backgroundRepeat = 'no-repeat';
          }
        }

        // 3. 初始化UI（快速操作）
        initSlotReels();
        updateSlotUI();
        syncUserInfoToSlot();
        
        // 🎵 预初始化音效系统（首次播放时自动初始化）
        soundManager.init();

        // 4. 隐藏loading遮罩
        loadingOverlay.style.animation = 'fadeOut 0.3s ease-in forwards';
        await new Promise(resolve => setTimeout(resolve, 300));
        loadingOverlay.classList.add('hidden');
        loadingOverlay.style.animation = '';

        // 5. 异步加载排行榜和入场券信息（不阻塞主界面，延迟加载）
        setTimeout(async () => {
          loadSidebarLeaderboard();
          await loadAdvancedTickets();  // 🔥 加载入场券信息
          // console.log('[初始化] 入场券加载完成，isInAdvancedMode:', isInAdvancedMode);
          
          // 🔥 如果用户在高级场，确保UI正确显示
          if (isInAdvancedMode && advancedTicketsData) {
            // console.log('[初始化] 用户在高级场，强制更新UI');
            updateAdvancedTicketsUI();  // 确保高级场UI显示正确
          }
          
          // 🔥 加载完入场券后再次更新UI，确保进度条正确显示
          updateSlotUI();
          
          // 🔥 再次强制更新进度条（确保显示）
          setTimeout(() => {
            // console.log('[初始化] 延迟更新进度条');
            updateBetLimitProgressBar();
          }, 50);
        }, 100);

        // 完成动画
        slotModal.classList.remove('fade-enter', 'fade-enter-active');
      } catch (error) {
        console.error('打开老虎机失败:', error);
        document.getElementById('slotLoadingOverlay').classList.add('hidden');
        showToast('打开老虎机失败', 'error');
        // 出错时切换回加油站模式
        if (currentMode === 'entertain') {
          switchToRefuel();
        }
      }
    }

    // 同步用户信息到老虎机界面
    function syncUserInfoToSlot() {
      // 从主界面复制用户信息到老虎机界面
      const linuxDoUsername = document.getElementById('linuxDoUsername')?.textContent;
      const userName = document.getElementById('userName')?.textContent;
      const userId = document.getElementById('userId')?.textContent;
      const userAvatar = document.getElementById('userAvatar');
      const userInitial = document.getElementById('userInitial')?.textContent;
      
      // console.log('[同步用户信息] LinuxDo用户名:', linuxDoUsername, '公益站用户名:', userName, 'ID:', userId, '头像元素:', userAvatar);
      
      // 确保显示正确的用户名
      if (linuxDoUsername) {
        document.getElementById('slotLinuxDoUsername').textContent = linuxDoUsername;
        // console.log('[同步] 设置老虎机LinuxDo用户名为:', linuxDoUsername);
      }
      if (userName) document.getElementById('slotUserName').textContent = userName;
      if (userId) document.getElementById('slotUserId').textContent = userId;
      if (userInitial && !userAvatar?.style.backgroundImage) {
        document.getElementById('slotUserInitial').textContent = userInitial;
      }
      
      // 复制头像样式
      if (userAvatar) {
        const slotAvatar = document.getElementById('slotUserAvatar');
        if (slotAvatar) {
          const bgImage = userAvatar.style.backgroundImage;
          // console.log('[同步头像] 背景图片:', bgImage);
          
          if (bgImage) {
            slotAvatar.style.backgroundImage = bgImage;
            slotAvatar.style.backgroundSize = 'cover';
            slotAvatar.style.backgroundPosition = 'center';
            document.getElementById('slotUserInitial').textContent = '';
          } else if (userInitial) {
            // 如果没有头像，显示首字母
            document.getElementById('slotUserInitial').textContent = userInitial;
          }
        }
      }
    }

    // 全局存储用户信息（用于获取头像）
    let userDataCache = {};

    // 加载侧边栏排行榜
    async function loadSidebarLeaderboard(forceRefresh = false) {
      try {
        const res = await fetch('/api/slot/leaderboard?limit=10');
        const data = await res.json();

        if (!data.success) {
          document.getElementById('sidebarLeaderboard').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">加载失败</div>';
          document.getElementById('profitBoardList').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">加载失败</div>';
          return;
        }

        const { leaderboard, lossLeaderboard, userStats, userRank, userLossRank } = data.data;

        // 计算用户盈亏
        const userProfit = (userStats.total_win || 0) - (userStats.total_bet || 0);
        const userProfitText = `${userProfit >= 0 ? '+' : ''}$${(userProfit / 500000).toFixed(2)}`;
        const userProfitColor = userProfit >= 0 ? 'text-green-300' : 'text-red-300';

        // 更新右侧排行榜的用户统计
        document.getElementById('sidebarMyRank').textContent = userRank > 0 ? `#${userRank}` : '未上榜';
        const sidebarMyProfit = document.getElementById('sidebarMyProfit');
        sidebarMyProfit.textContent = userProfitText;
        sidebarMyProfit.className = `font-bold ${userProfitColor}`;

        // 更新左侧亏损榜的用户统计
        document.getElementById('profitBoardMyRank').textContent = userLossRank > 0 ? `#${userLossRank}` : '未上榜';
        const profitBoardMyProfit = document.getElementById('profitBoardMyProfit');
        profitBoardMyProfit.textContent = userProfitText;
        profitBoardMyProfit.className = `font-bold ${userProfitColor}`;

        // 更新刷新时间
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('leaderboardLastUpdate').textContent = `最后更新：${timeStr}`;
        document.getElementById('profitBoardLastUpdate').textContent = `最后更新：${timeStr}`;
        
        // 如果是手动刷新，显示提示
        if (forceRefresh) {
          showToast('排行榜已刷新', 'success');
        }

        // 调试：输出完整的排行榜数据
        // console.log('[盈亏排行榜数据]', leaderboard);

        // 渲染盈利榜的函数（绿色主题，奖牌图标）
        const renderProfitLeaderboardItem = (user, index) => {
          const rank = index + 1;
          let rankDisplay = '';
          let bgClass = 'bg-white/5 hover:bg-white/10';
          
          if (rank === 1) {
            rankDisplay = '<span class="text-xl">🥇</span>';
            bgClass = 'bg-gradient-to-r from-green-500/30 to-emerald-500/30 border border-green-400/50 shadow-lg';
          } else if (rank === 2) {
            rankDisplay = '<span class="text-xl">🥈</span>';
            bgClass = 'bg-gradient-to-r from-green-400/30 to-emerald-400/30 border border-green-300/50 shadow-lg';
          } else if (rank === 3) {
            rankDisplay = '<span class="text-xl">🥉</span>';
            bgClass = 'bg-gradient-to-r from-green-500/30 to-teal-500/30 border border-green-400/50 shadow-lg';
          } else {
            rankDisplay = `<span class="text-xs font-bold text-white/50">#${rank}</span>`;
          }

          // 构建头像HTML
          const username = user.username || user.linux_do_id;
          
          let avatarUrl = '';
          if (user.avatar_url && user.avatar_url.trim()) {
            avatarUrl = user.avatar_url;
          } else {
            const firstLetter = username.charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            avatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/48.png`;
          }
          
          // 计算盈亏
          const profit = (user.total_win || 0) - (user.total_bet || 0);
          const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
          const profitColor = profit >= 0 ? 'text-green-300' : 'text-red-300';
          
          return `
            <div class="p-2 rounded-lg ${bgClass} transition-all">
              <div class="flex items-center gap-2">
                <div class="w-8 text-center flex-shrink-0">${rankDisplay}</div>
                <img src="${avatarUrl}" 
                     alt="${username}" 
                     class="w-7 h-7 rounded-full flex-shrink-0 border border-white/30 object-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-7 h-7 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold border border-white/30 flex-shrink-0" style="display:none;">
                  ${username.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-xs text-white truncate">${username}</p>
                  <p class="text-xs text-white/50">${user.total_spins} 次</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs font-bold ${profitColor}">${profitText}</p>
                </div>
              </div>
            </div>
          `;
        };

        // 渲染亏损榜的函数（红色主题，表情图标）
        const renderLossLeaderboardItem = (user, index) => {
          const rank = index + 1;
          let rankDisplay = '';
          let bgClass = 'bg-white/5 hover:bg-white/10';
          
          if (rank === 1) {
            rankDisplay = '<span class="text-xl">😱</span>';
            bgClass = 'bg-gradient-to-r from-red-500/30 to-rose-500/30 border border-red-400/50 shadow-lg';
          } else if (rank === 2) {
            rankDisplay = '<span class="text-xl">😭</span>';
            bgClass = 'bg-gradient-to-r from-red-400/30 to-rose-400/30 border border-red-300/50 shadow-lg';
          } else if (rank === 3) {
            rankDisplay = '<span class="text-xl">😢</span>';
            bgClass = 'bg-gradient-to-r from-orange-500/30 to-red-500/30 border border-red-400/50 shadow-lg';
          } else {
            rankDisplay = `<span class="text-xs font-bold text-white/50">#${rank}</span>`;
          }

          // 构建头像HTML
          const username = user.username || user.linux_do_id;
          
          let avatarUrl = '';
          if (user.avatar_url && user.avatar_url.trim()) {
            avatarUrl = user.avatar_url;
          } else {
            const firstLetter = username.charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            avatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/48.png`;
          }
          
          // 计算盈亏
          const profit = (user.total_win || 0) - (user.total_bet || 0);
          const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
          const profitColor = profit >= 0 ? 'text-green-300' : 'text-red-300';
          
          return `
            <div class="p-2 rounded-lg ${bgClass} transition-all">
              <div class="flex items-center gap-2">
                <div class="w-8 text-center flex-shrink-0">${rankDisplay}</div>
                <img src="${avatarUrl}" 
                     alt="${username}" 
                     class="w-7 h-7 rounded-full flex-shrink-0 border border-white/30 object-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-7 h-7 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold border border-white/30 flex-shrink-0" style="display:none;">
                  ${username.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-xs text-white truncate">${username}</p>
                  <p class="text-xs text-white/50">${user.total_spins} 次</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs font-bold ${profitColor}">${profitText}</p>
                </div>
              </div>
            </div>
          `;
        };

        // 渲染右侧盈利榜（绿色主题，奖牌图标）
        const rightContainer = document.getElementById('sidebarLeaderboard');
        if (leaderboard.length === 0) {
          rightContainer.innerHTML = '<div class="text-center text-white/50 py-4 text-sm">暂无排行数据</div>';
        } else {
          rightContainer.innerHTML = leaderboard.map(renderProfitLeaderboardItem).join('');
        }

        // 渲染左侧亏损榜（红色主题，表情图标）
        const leftContainer = document.getElementById('profitBoardList');
        if (!lossLeaderboard || lossLeaderboard.length === 0) {
          leftContainer.innerHTML = '<div class="text-center text-white/50 py-8 text-sm">🎉 暂无亏损用户<br><span class="text-xs opacity-75 mt-1">所有玩家都在盈利！</span></div>';
        } else {
          leftContainer.innerHTML = lossLeaderboard.map(renderLossLeaderboardItem).join('');
        }

      } catch (error) {
        console.error('加载排行榜失败:', error);
        document.getElementById('sidebarLeaderboard').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">加载失败</div>';
        document.getElementById('profitBoardList').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">加载失败</div>';
      }
    }

    // 收起/展开亏损榜
    function toggleLossBoard() {
      const content = document.getElementById('lossBoardContent');
      const icon = document.getElementById('lossBoardToggleIcon');
      const isCollapsed = content.style.display === 'none';
      
      if (isCollapsed) {
        // 展开
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        // 收起
        content.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
      }
    }

    // 收起/展开盈利榜
    function toggleProfitBoard() {
      const content = document.getElementById('profitBoardContent');
      const icon = document.getElementById('profitBoardToggleIcon');
      const isCollapsed = content.style.display === 'none';
      
      if (isCollapsed) {
        // 展开
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        // 收起
        content.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
      }
    }

    // 关闭老虎机
    async function closeSlotMachine() {
      // 切换回加油站模式
      await switchToRefuel();
    }

    // 更新老虎机界面数据
    function updateSlotUI() {
      if (!slotUserData || !slotConfig) {
        // console.warn('[updateSlotUI] 缺少必要数据:', { slotUserData, slotConfig });
        return;
      }

      // console.log('[updateSlotUI] 更新UI，当前数据:', {
      //   remaining_spins: slotUserData.remaining_spins,
      //   free_spins: slotUserData.free_spins,
      //   quota: slotUserData.quota,
      //   bought_today: slotUserData.bought_today
      // });

      const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
      document.getElementById('slotQuota').textContent = quotaText;
      // 同步更新移动端额度显示
      const slotQuotaMobile = document.getElementById('slotQuotaMobile');
      if (slotQuotaMobile) {
        slotQuotaMobile.textContent = quotaText;
      }

      const spinsRemainingEl = document.getElementById('spinsRemaining');
      const freeSpinsCountEl = document.getElementById('freeSpinsCount');

      // 🎯 增强：确保元素存在且正确更新
      if (spinsRemainingEl) {
        const newValue = slotUserData.remaining_spins || 0;
        const oldValue = parseInt(spinsRemainingEl.textContent) || 0;
        spinsRemainingEl.textContent = newValue;
        
        // 如果值发生变化，添加日志
        if (oldValue !== newValue) {
          // console.log(`[updateSlotUI] 🔄 剩余次数更新: ${oldValue} → ${newValue}`);
        }
      } else {
        // console.error('[updateSlotUI] ❌ 找不到 spinsRemaining 元素！');
      }
      
      if (freeSpinsCountEl) {
        freeSpinsCountEl.textContent = slotUserData.free_spins || 0;
      } else {
        // console.error('[updateSlotUI] ❌ 找不到 freeSpinsCount 元素！');
      }

      // console.log('[updateSlotUI] DOM更新完成:', {
      //   spinsRemainingEl_text: spinsRemainingEl?.textContent || 'N/A',
      //   freeSpinsCountEl_text: freeSpinsCountEl?.textContent || 'N/A',
      //   remaining_spins_value: slotUserData.remaining_spins,
      //   free_spins_value: slotUserData.free_spins
      // });
      
      // 今日统计
      document.getElementById('todayPlayed').textContent = slotUserData.today_count || 0;
      document.getElementById('todayBet').textContent = `$${((slotUserData.today_bet || 0) / 500000).toFixed(2)}`;
      document.getElementById('todayWon').textContent = `$${((slotUserData.today_win || 0) / 500000).toFixed(2)}`;
      
      // 历史总计
      document.getElementById('totalPlayed').textContent = slotUserData.total_spins || 0;
      document.getElementById('totalBet').textContent = `$${((slotUserData.total_bet || 0) / 500000).toFixed(2)}`;
      document.getElementById('totalWon').textContent = `$${((slotUserData.total_win || 0) / 500000).toFixed(2)}`;
      
      // 🔥 更新投注限额进度条（在 updateSlotUI 中直接调用）
      // console.log('[updateSlotUI] 准备更新进度条，isInAdvancedMode:', isInAdvancedMode);
      updateBetLimitProgressBar();

      // 显示禁止状态（初级场和高级场都显示）
      const bannedNotice = document.getElementById('bannedNotice');
      const bannedUntilText = document.getElementById('bannedUntilText');
      const advancedBannedNotice = document.getElementById('advancedBannedNotice');
      const advancedBannedUntilText = document.getElementById('advancedBannedUntilText');
      
      if (slotUserData.is_banned && slotUserData.banned_until > Date.now()) {
        const bannedDate = new Date(slotUserData.banned_until);
        const remainingHours = Math.ceil((slotUserData.banned_until - Date.now()) / 3600000);
        const banText = `解禁时间：${bannedDate.toLocaleString('zh-CN', { hour12: false })} (剩余约${remainingHours}小时)`;
        
        // 🔥 初级场封禁提示
        if (bannedNotice && bannedUntilText) {
          bannedNotice.classList.remove('hidden');
          bannedUntilText.textContent = banText;
        }
        
        // 🔥 高级场封禁提示
        if (advancedBannedNotice && advancedBannedUntilText) {
          advancedBannedNotice.classList.remove('hidden');
          advancedBannedUntilText.textContent = banText;
        }
      } else {
        // 隐藏所有封禁提示
        if (bannedNotice) bannedNotice.classList.add('hidden');
        if (advancedBannedNotice) advancedBannedNotice.classList.add('hidden');
      }

      // 更新投注金额显示（根据管理员配置或高级场选择）
      const spinButtonPrice = document.getElementById('spinButtonPrice');
      if (spinButtonPrice) {
        if (isInAdvancedMode) {
          // 🔥 高级场显示选择的投注金额
          spinButtonPrice.textContent = `($${advancedBetAmount})`;
        } else {
          // 初级场显示配置的投注金额
          const betAmountUSD = (slotConfig.bet_amount / 500000).toFixed(2);
          spinButtonPrice.textContent = `($${betAmountUSD})`;
        }
      }

      // 更新按钮状态
      const spinButton = document.getElementById('spinButton');
      const freeSpinButton = document.getElementById('freeSpinButton');

      // 普通旋转按钮
      const hasSpins = slotUserData.remaining_spins > 0;
      const hasQuota = slotUserData.quota >= slotConfig.min_quota_required;

      // console.log('[updateSlotUI] Spin按钮状态检查:', {
      //   remaining_spins: slotUserData.remaining_spins,
      //   hasSpins: hasSpins,
      //   quota: slotUserData.quota,
      //   min_quota_required: slotConfig.min_quota_required,
      //   hasQuota: hasQuota,
      //   quotaUSD: `$${(slotUserData.quota / 500000).toFixed(2)}`,
      //   minQuotaUSD: `$${(slotConfig.min_quota_required / 500000).toFixed(2)}`,
      //   shouldEnable: hasSpins && hasQuota
      // });

      if (hasSpins && hasQuota) {
        spinButton.disabled = false;
        // console.log('[updateSlotUI] ✅ Spin按钮已启用');
      } else {
        spinButton.disabled = true;
        if (!hasSpins) {
          // console.log('[updateSlotUI] ❌ Spin按钮禁用：没有剩余次数');
        }
        if (!hasQuota) {
          // console.log('[updateSlotUI] ❌ Spin按钮禁用：额度不足（需要至少 $' + (slotConfig.min_quota_required / 500000).toFixed(2) + '）');
        }
      }

      // 免费旋转按钮（🔥 高级场不显示免费抽奖）
      if (!isInAdvancedMode && slotUserData.free_spins > 0 && !slotUserData.is_banned) {
        freeSpinButton.classList.remove('hidden');
        freeSpinButton.disabled = false;
      } else {
        freeSpinButton.classList.add('hidden');
        freeSpinButton.disabled = true;
      }

      // 🔥 高级场投注按钮状态更新
      updateAdvancedSpinButtonState();

      // 购买次数功能区
      const buySpinsSection = document.getElementById('buySpinsSection');
      const buySpinsButton = document.getElementById('buySpinsButton');

      if (buySpinsSection && slotConfig.buy_spins_enabled && !slotUserData.is_banned && !isInAdvancedMode) {
        // 显示购买区域（高级场不显示）
        buySpinsSection.classList.remove('hidden');

        // 更新价格显示
        const buyPriceUSD = (slotConfig.buy_spins_price / 500000).toFixed(2);
        const buySpinsPriceEl = document.getElementById('buySpinsPrice');
        const buySpinsBtnPriceEl = document.getElementById('buySpinsBtnPrice');
        if (buySpinsPriceEl) buySpinsPriceEl.textContent = `$${buyPriceUSD}`;
        if (buySpinsBtnPriceEl) buySpinsBtnPriceEl.textContent = buyPriceUSD;

        // 更新已购次数
        const buySpinsTodayEl = document.getElementById('buySpinsToday');
        const buySpinsMaxEl = document.getElementById('buySpinsMax');
        if (buySpinsTodayEl) buySpinsTodayEl.textContent = slotUserData.bought_today || 0;
        if (buySpinsMaxEl) buySpinsMaxEl.textContent = slotConfig.max_daily_buy_spins;

        // 更新按钮状态
        const boughtToday = slotUserData.bought_today || 0;
        if (buySpinsButton) {
          if (boughtToday >= slotConfig.max_daily_buy_spins) {
            buySpinsButton.disabled = true;
          } else if (slotUserData.quota < slotConfig.buy_spins_price) {
            buySpinsButton.disabled = true;
          } else {
            buySpinsButton.disabled = false;
          }
        }
      } else if (buySpinsSection) {
        // 隐藏购买区域（高级场或其他原因）
        buySpinsSection.classList.add('hidden');
      }
    }

    // 购买抽奖次数 - 显示确认弹窗
    function buySpins() {
      const button = document.getElementById('buySpinsButton');
      if (!button) {
        showToast('按钮加载失败', 'error');
        return;
      }
      if (button.disabled) return;

      if (!slotConfig || !slotUserData) {
        showToast('配置加载失败', 'error');
        return;
      }

      // 更新弹窗中的价格显示
      const buyPriceUSD = (slotConfig.buy_spins_price / 500000).toFixed(2);
      const confirmPriceEl = document.getElementById('confirmBuyPrice');
      if (confirmPriceEl) {
        confirmPriceEl.textContent = `$${buyPriceUSD}`;
      }

      // 显示确认弹窗
      document.getElementById('buySpinsConfirmModal').classList.remove('hidden');
    }

    // 取消购买
    function cancelBuySpins() {
      document.getElementById('buySpinsConfirmModal').classList.add('hidden');
    }

    // 确认购买 - 执行购买逻辑
    async function confirmBuySpins() {
      // 隐藏确认弹窗
      document.getElementById('buySpinsConfirmModal').classList.add('hidden');

      const button = document.getElementById('buySpinsButton');
      if (!button) return;

      // 禁用按钮
      button.disabled = true;
      const originalText = button.innerHTML;
      button.innerHTML = '⏳ 购买中...';

      try {
        const res = await fetch('/api/slot/buy-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (data.success) {
          // 🎯 保存购买前的剩余次数，用于视觉对比
          const oldRemainingSpins = slotUserData.remaining_spins || 0;
          
          // 更新用户数据
          slotUserData.quota = data.data.quota_after;
          slotUserData.remaining_spins = data.data.remaining_spins;
          slotUserData.bought_today = data.data.bought_today;

          // console.log('[购买成功] API返回数据:', data.data);
          // console.log('[购买成功] 更新前剩余次数:', oldRemainingSpins);
          // console.log('[购买成功] 更新后剩余次数:', slotUserData.remaining_spins);
          // console.log('[购买成功] 更新后的 slotUserData:', {
          //   quota: slotUserData.quota,
          //   remaining_spins: slotUserData.remaining_spins,
          //   bought_today: slotUserData.bought_today,
          //   free_spins: slotUserData.free_spins
          // });

          // 立即更新UI
          updateSlotUI();
          
          // 🎯 添加视觉反馈：高亮显示剩余次数
          const spinsRemainingEl = document.getElementById('spinsRemaining');
          if (spinsRemainingEl) {
            // 添加闪烁动画
            spinsRemainingEl.style.animation = 'pulse 0.5s ease-in-out 3';
            setTimeout(() => {
              spinsRemainingEl.style.animation = '';
            }, 1500);
          }
          
          // 🎯 显示详细的成功消息
          const increase = slotUserData.remaining_spins - oldRemainingSpins;
          setTimeout(() => {
            showToast(`✅ 购买成功！剩余次数：${oldRemainingSpins} → ${slotUserData.remaining_spins} (+${increase})`, 'success');
          }, 500);
          
        } else {
          showToast(data.message, 'error');
          // 失败时也要恢复按钮状态
          button.disabled = false;
        }
      } catch (error) {
        console.error('购买失败:', error);
        showToast('购买失败，请重试', 'error');
        // 失败时恢复按钮状态
        button.disabled = false;
      } finally {
        // 🎯 修复：恢复按钮文本，但不在这里设置 disabled 状态
        // 让 updateSlotUI() 来决定最终的按钮状态
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 100);
      }
    }

    // 旋转老虎机（带丝滑动画）
    async function spinSlot(useFreeSpinn = false) {
      if (isSpinning) return;

      const spinButton = document.getElementById('spinButton');
      const freeSpinButton = document.getElementById('freeSpinButton');
      const resultDiv = document.getElementById('slotResult');

      // ✅ 新增：使用免费次数时先检查
      if (useFreeSpinn) {
        if (!slotUserData || slotUserData.free_spins <= 0) {
          showToast('没有免费次数', 'error');
          
          // 重新同步数据
          try {
            const configRes = await fetch('/api/slot/config');
            const configData = await configRes.json();
            if (configData.success) {
              slotUserData = configData.data.user;
              updateSlotUI();
            }
          } catch (error) {
            console.error('[前端] 同步数据失败:', error);
          }
          return;
        }
      }

      // 隐藏上次结果
      resultDiv.classList.add('hidden');

      // 禁用所有按钮
      spinButton.disabled = true;
      freeSpinButton.disabled = true;
      const advSpinBtn = document.getElementById('advancedSpinButton');
      if (advSpinBtn) advSpinBtn.disabled = true;  // 🔥 同时禁用高级场按钮
      isSpinning = true;

      try {
        // 🎯 优化：先调用 API，扣款成功后再播放音效和动画
        // 🔥 高级场传递自定义投注金额
        const requestBody = { useFreeSpinn };
        if (isInAdvancedMode) {
          requestBody.advancedBetAmount = advancedBetAmount * 500000;  // 美元转聪
          // console.log(`[高级场] 投注金额: $${advancedBetAmount} (${requestBody.advancedBetAmount}聪)`);
        }
        
        const res = await fetch('/api/slot/spin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          isSpinning = false;

          // 任何错误都重新加载配置以同步最新数据
          try {
            const configRes = await fetch('/api/slot/config');
            const configData = await configRes.json();
            if (configData.success) {
              slotUserData = configData.data.user;
              updateSlotUI();
            }
          } catch (error) {
            console.error('[配置同步失败]', error);
          }

          // 根据最新数据更新按钮状态（已经调用了 updateSlotUI）
          // updateSlotUI 会自动处理按钮的显示/隐藏和启用/禁用
          return;
        }

        const result = data.data;

        // 🎯 优化：API成功后再播放音效
        soundManager.playSpin();

        // 开始动画（音效和动画同步）
        await playSpinAnimation(result.symbols);

        // 更新用户数据
        slotUserData.quota = result.quota_after;
        slotUserData.remaining_spins = result.spins_remaining;
        slotUserData.free_spins = result.free_spins_remaining;
        if (!useFreeSpinn) {
          slotUserData.today_count++;
          slotUserData.today_bet += result.bet_amount;
        }
        slotUserData.today_win += result.win_amount;

        updateSlotUI();

        // 🔥 处理入场券/碎片掉落
        if (result.ticket_dropped && result.drop_type) {
          // console.log('[掉落] 检测到掉落:', result.drop_type, result.drop_count);
          // 延迟显示掉落动画（在旋转动画之后）
          setTimeout(() => {
            playTicketDropAnimation(result.drop_type, result.drop_count);
          }, 500);
          
          // 刷新入场券信息
          setTimeout(() => {
            loadAdvancedTickets();
          }, 1000);
        }

        // 刷新排行榜（如果中奖）
        if (result.win_amount > 0) {
          setTimeout(() => loadSidebarLeaderboard(), 1000);
        }

        // 更新待发放记录和余额
        setTimeout(() => loadPendingRewardsSummary(), 500);

        // 播放结果音效
        if (result.multiplier < 0) {
          // 惩罚音效
          soundManager.playPunishment();
        } else if (result.multiplier > 0) {
          // 中奖音效
          soundManager.playWin(result.multiplier);
        } else {
          // 未中奖音效
          soundManager.playLose();
        }
        
        // 显示结果
        document.getElementById('slotResultText').textContent = data.message;
        resultDiv.classList.remove('hidden');

        // 🔥 根据中奖类型动态设置提示停留时间
        let displayDuration = 3000; // 默认3秒
        
        if (result.win_type === 'super_jackpot') {
          // 超级大奖：5秒
          displayDuration = 5000;
        } else if (result.win_type === 'special_combo' || result.win_type === 'quad') {
          // 特殊组合、四连：4秒
          displayDuration = 4000;
        } else if (result.win_type === 'triple') {
          // 三连：3秒
          displayDuration = 3000;
        } else if (result.win_type === 'double'|| result.win_type === 'punishment') {
          // 双连：2.5秒
          displayDuration = 2500;
        } else if (result.win_type === 'none' ) {
          // 未中奖、惩罚：3秒（让玩家看清楚结果）
          displayDuration = 1000;
        }
        
        setTimeout(() => {
          resultDiv.classList.add('hidden');
        }, displayDuration);

        // 如果中奖，显示Toast
        if (result.win_amount > 0) {
          setTimeout(() => {
            showToast(data.message, 'success');
          }, 500);
        }

      } catch (error) {
        console.error('旋转失败:', error);
        showToast('旋转失败，请重试', 'error');
      } finally {
        isSpinning = false;
        
        // 🔥 恢复按钮状态（区分高级场和初级场）
        if (isInAdvancedMode) {
          // 高级场：控制投注选择器内的按钮
          const advSpinBtn = document.getElementById('advancedSpinButton');
          if (advSpinBtn && slotUserData.quota >= (advancedBetAmount * 500000)) {
            advSpinBtn.disabled = false;
          }
        } else {
          // 初级场：控制普通spin按钮
          if (slotUserData.remaining_spins > 0 && slotUserData.quota >= slotConfig.min_quota_required) {
            spinButton.disabled = false;
          }
          if (slotUserData.free_spins > 0) {
            freeSpinButton.disabled = false;
          }
        }
      }
    }

    // 播放旋转动画（优化版：同时开始，依次停止）
    async function playSpinAnimation(finalSymbols) {
      const reels = document.querySelectorAll('.slot-reel');
      
      // 🎯 优化：所有滚轮同时启动，制造同步感
      const startTime = Date.now();
      const animationPromises = [];
      
      reels.forEach((reel, idx) => {
        animationPromises.push(animateReel(reel, finalSymbols[idx], idx, startTime));
      });

      // 等待所有滚轮动画完成
      await Promise.all(animationPromises);
    }

    // 单个滚轮动画（优化版）
    function animateReel(reel, finalSymbol, reelIndex, startTime) {
      return new Promise((resolve) => {
        const symbolsContainer = reel.querySelector('.slot-symbols');
        
        // 🎯 优化：响应式符号高度（根据屏幕大小自适应）
        const isMobile = window.innerWidth <= 768;
        const symbolHeight = isMobile ? 70 : (window.innerWidth <= 1024 ? 100 : 180);
        
        // 清空现有符号
        symbolsContainer.innerHTML = '';
        symbolsContainer.style.transform = '';
        symbolsContainer.style.filter = '';

        // 🎯 新优化：所有滚轮同时开始，但持续时间递增（依次停止）
        // 第1个滚轮最快停止，第4个最慢，制造悬念
        const baseDuration = 2000; // 基础时长2秒
        const durationIncrement = 600; // 每个滚轮增加600ms
        const duration = baseDuration + (reelIndex * durationIncrement); // 2s, 2.6s, 3.2s, 3.8s
        
        // 🎯 优化：最后一个滚轮旋转更多符号，增加悬念感
        const baseSymbolCount = 25;
        const symbolCount = Math.floor(baseSymbolCount + (reelIndex * 8)); // 递增符号数量
        
        // 生成符号序列（随机符号 + 最终符号）
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < symbolCount; i++) {
          const symbol = i === symbolCount - 1 
            ? finalSymbol 
            : SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
          fragment.appendChild(createSymbolElement(symbol));
        }
        symbolsContainer.appendChild(fragment); // 一次性添加，性能更好

        // 🎯 优化：不同缓动函数，最后一个滚轮更平滑减速
        const easingFunctions = [
          'cubic-bezier(0.25, 0.46, 0.45, 0.94)',  // reel 0: ease-out-quad
          'cubic-bezier(0.42, 0, 0.58, 1)',        // reel 1: ease-in-out
          'cubic-bezier(0.65, 0, 0.35, 1)',        // reel 2: ease-in-out-cubic
          'cubic-bezier(0.22, 0.61, 0.36, 1)'      // reel 3: ease-out-expo (最平滑)
        ];
        const easing = easingFunctions[reelIndex] || easingFunctions[3];

        // 🎯 优化：更丝滑的模糊效果和关键帧
        const blurIntensity = reelIndex === 3 ? 6 : 5; // 最后一个滚轮模糊更强
        const animation = symbolsContainer.animate([
          { 
            transform: 'translateY(0px)',
            filter: 'blur(0px)',
            offset: 0
          },
          { 
            transform: 'translateY(-80px)',
            filter: `blur(${blurIntensity}px)`,
            offset: 0.1  // 快速加速
          },
          { 
            transform: `translateY(-${(symbolCount - 10) * symbolHeight}px)`,
            filter: `blur(${blurIntensity}px)`,
            offset: 0.7  // 保持高速
          },
          { 
            transform: `translateY(-${(symbolCount - 3) * symbolHeight}px)`,
            filter: 'blur(2px)',
            offset: 0.92  // 开始减速并减少模糊
          },
          { 
            transform: `translateY(-${(symbolCount - 1) * symbolHeight}px)`,
            filter: 'blur(0px)',
            offset: 1  // 完全停止，清晰显示
          }
        ], {
          duration: duration,
          easing: easing,
          fill: 'forwards'
        });

        // 🎯 优化：添加超时保护，防止动画卡死
        const timeoutId = setTimeout(() => {
          if (animation.playState !== 'finished') {
            animation.finish();
          }
        }, duration + 500);

        // 动画结束后
        animation.onfinish = () => {
          clearTimeout(timeoutId);
          
          // 停止动画
          animation.cancel();
          
          // 只保留最终符号，清空其他，节省内存
          symbolsContainer.innerHTML = '';
          const finalElement = createSymbolElement(finalSymbol);
          symbolsContainer.appendChild(finalElement);
          
          // 重置transform和filter
          symbolsContainer.style.transform = 'translateY(0)';
          symbolsContainer.style.filter = 'none';
          
          // 🎯 优化：最后一个滚轮停止时添加闪烁效果，增强视觉反馈
          if (reelIndex === 3) {
            const reelContainer = reel.closest('.slot-reel-container');
            if (reelContainer) {
              // 添加脉冲动画
              reelContainer.style.animation = 'pulse 0.3s ease-in-out 2';
              setTimeout(() => {
                reelContainer.style.animation = '';
              }, 600);
            }
          }
          
          resolve();
        };
      });
    }

    // 显示游戏记录
    // 全局存储所有记录（用于筛选）
    let allSlotRecords = [];
    
    async function showSlotRecords() {
      // 关闭所有下拉菜单
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');
      
      try {
        // 根据当前模式获取对应的记录
        const mode = isInAdvancedMode ? 'advanced' : 'normal';
        const modeName = isInAdvancedMode ? '高级场' : '初级场';
        
        // 并行获取抽奖记录和待发放记录
        const [recordsRes, pendingRes] = await Promise.all([
          fetch(`/api/slot/records?mode=${mode}`),
          fetch('/api/slot/pending-rewards')
        ]);
        
        const recordsData = await recordsRes.json();
        const pendingData = await pendingRes.json();

        if (!recordsData.success) {
          showToast(recordsData.message, 'error');
          return;
        }

        // 保存所有记录到全局变量
        allSlotRecords = recordsData.data;
        
        // 调试：检查win_type分布
        // console.log('[记录统计] 总记录数:', allSlotRecords.length);
        const winTypeStats = {};
        allSlotRecords.forEach(r => {
          const winType = r.win_type || 'null';
          winTypeStats[winType] = (winTypeStats[winType] || 0) + 1;
        });
        // console.log('[记录统计] win_type分布:', winTypeStats);
        
        // 更新标题显示当前场次
        document.getElementById('slotRecordsTitle').textContent = `🎰 我的抽奖记录 - ${modeName}`;
        
        // 显示模态框
        document.getElementById('slotRecordsModal').classList.remove('hidden');
        
        // 渲染记录（显示全部）
        renderSlotRecords(allSlotRecords);
        
        // 显示总记录数
        document.getElementById('filterResultHint').textContent = `📊 总记录数: ${allSlotRecords.length}`;
        document.getElementById('filterResultHint').classList.remove('hidden');
        
        // 渲染待发放记录
        if (pendingData.success && pendingData.data) {
          renderPendingRewards(pendingData.data);
        }
      } catch (error) {
        console.error('获取抽奖记录失败:', error);
        showToast('获取抽奖记录失败', 'error');
      }
    }
    
    // 刷新待发放记录
    async function refreshPendingRewards() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();
        
        if (data.success && data.data) {
          renderPendingRewards(data.data);
          showToast('待发放记录已更新', 'success');
        }
      } catch (error) {
        console.error('刷新待发放记录失败:', error);
        showToast('刷新失败', 'error');
      }
    }
    
    // 渲染待发放记录
    function renderPendingRewards(data) {
      const section = document.getElementById('pendingRewardsSection');
      const container = document.getElementById('pendingRewardsContent');
      
      const { summary, rewards } = data;
      
      // 如果没有任何记录，隐藏整个区域
      if (!rewards || rewards.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      // 显示区域
      section.classList.remove('hidden');
      
      // 筛选待发放和已成功的记录
      const pendingRewards = rewards.filter(r => 
        r.status === 'pending' || r.status === 'processing' || r.status === 'failed'
      );
      const successRewards = rewards.filter(r => r.status === 'success');
      
      let html = '';
      
      // 汇总卡片
      html += `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="bg-white rounded-lg p-3 border-2 border-orange-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">待发放</p>
            <p class="text-xl font-bold text-orange-600">$${(summary.pending_amount / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">${summary.pending_count} 笔</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-green-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">已发放</p>
            <p class="text-xl font-bold text-green-600">$${(summary.success_amount / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">${summary.success_count} 笔</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-indigo-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">总笔数</p>
            <p class="text-xl font-bold text-indigo-600">${summary.total_count}</p>
            <p class="text-xs text-slate-500">所有记录</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-purple-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">总金额</p>
            <p class="text-xl font-bold text-purple-600">$${((summary.pending_amount + summary.success_amount) / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">待发+已发</p>
          </div>
        </div>
      `;
      
      // 待发放记录列表
      if (pendingRewards.length > 0) {
        html += `
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-orange-700 mb-2 flex items-center gap-2">
              <span>⏳</span>
              <span>待发放 (${pendingRewards.length})</span>
            </h4>
            <div class="space-y-2">
        `;
        
        pendingRewards.forEach(reward => {
          const statusColor = {
            'pending': 'bg-yellow-100 text-yellow-700 border-yellow-300',
            'processing': 'bg-blue-100 text-blue-700 border-blue-300',
            'failed': 'bg-red-100 text-red-700 border-red-300'
          }[reward.status] || 'bg-gray-100 text-gray-700 border-gray-300';
          
          const statusText = {
            'pending': '等待发放',
            'processing': '发放中',
            'failed': '失败重试'
          }[reward.status] || reward.status;
          
          html += `
            <div class="bg-white rounded-lg p-3 border border-orange-200 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-900 text-sm mb-1 truncate">${reward.reason}</p>
                  <p class="text-xs text-slate-500 mb-1">${reward.created_date}</p>
                  ${reward.error_message ? `<p class="text-xs text-red-600 mt-1">⚠️ ${reward.error_message}</p>` : ''}
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-lg font-bold text-orange-600 mb-1">$${reward.amount.toFixed(2)}</p>
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium border ${statusColor}">
                    ${statusText}
                  </span>
                  ${reward.retry_count > 0 ? `<p class="text-xs text-slate-500 mt-1">重试 ${reward.retry_count} 次</p>` : ''}
                </div>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      // 已成功记录（折叠显示最近5条）
      if (successRewards.length > 0) {
        html += `
          <div>
            <h4 class="text-sm font-semibold text-green-700 mb-2 flex items-center gap-2">
              <span>✅</span>
              <span>已发放 (最近5条)</span>
            </h4>
            <div class="space-y-2">
        `;
        
        successRewards.slice(0, 5).forEach(reward => {
          html += `
            <div class="bg-white rounded-lg p-3 border border-green-200 shadow-sm opacity-75">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-700 text-sm mb-1 truncate">${reward.reason}</p>
                  <p class="text-xs text-slate-500">${reward.created_date}</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-lg font-bold text-green-600 mb-1">$${reward.amount.toFixed(2)}</p>
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700 border border-green-300">
                    已发放
                  </span>
                </div>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    // 渲染老虎机记录
    function renderSlotRecords(records) {
      const container = document.getElementById('slotRecordsContent');

        if (records.length === 0) {
          container.innerHTML = '<p class="text-center text-slate-500 py-8">暂无符合条件的记录</p>';
          return;
        }
        
        // 计算统计数据（基于筛选后的记录）
        const allRecords = records;
          const totalCount = allRecords.length;
          const winCount = allRecords.filter(r => r.win_amount > 0).length;
          const winRate = totalCount > 0 ? ((winCount / totalCount) * 100).toFixed(1) : '0.0';
          
          // 统计各种奖项
          const winTypes = {
            'super_jackpot': { name: '🏆 超级大奖', count: 0, color: 'text-yellow-600' },
            'special_combo': { name: '💎 特殊组合', count: 0, color: 'text-purple-600' },
            'quad': { name: '🎰 四连', count: 0, color: 'text-blue-600' },
            'triple': { name: '✨ 三连', count: 0, color: 'text-green-600' },
            'double': { name: '🎁 双连', count: 0, color: 'text-teal-600' },
            'punishment': { name: '⚡ 律师函', count: 0, color: 'text-red-600' },
            'none': { name: '❌ 未中奖', count: 0, color: 'text-slate-500' }
          };
          
          allRecords.forEach(r => {
            if (winTypes[r.win_type]) {
              winTypes[r.win_type].count++;
            }
          });
          
          // 计算总投注和总赢得
          const totalBet = allRecords.reduce((sum, r) => sum + r.bet_amount, 0);
          const totalWin = allRecords.reduce((sum, r) => sum + r.win_amount, 0);
          const netProfit = totalWin - totalBet;
          
          // 构建统计卡片
          const statsHtml = `
            <div class="mb-6 bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 rounded-xl p-6 border-2 border-purple-200 shadow-lg">
              <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600 flex items-center gap-2">
                  <span>📊</span>
                  <span>中奖概率统计</span>
                </h3>
                <span class="px-3 py-1 bg-white rounded-full text-sm font-semibold text-purple-600 shadow-sm">
                  共 ${totalCount} 次
                </span>
              </div>
              
              <!-- 核心数据卡片 -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
                <!-- 中奖率 -->
                <div class="bg-white rounded-xl p-4 text-center shadow-md hover:shadow-xl transition-shadow border border-purple-100">
                  <div class="flex justify-center mb-2">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 flex items-center justify-center text-white text-xl font-bold shadow-lg">
                      ${winRate}%
                    </div>
                  </div>
                  <p class="text-xs text-slate-600 mb-1">中奖率</p>
                  <p class="text-sm font-semibold text-slate-700">${winCount}/${totalCount} 次</p>
                </div>
                
                <!-- 总投注 -->
                <div class="bg-white rounded-xl p-4 text-center shadow-md hover:shadow-xl transition-shadow border border-red-100">
                  <div class="text-2xl font-bold text-red-600 mb-1">
                    $${(totalBet / 500000).toFixed(2)}
                  </div>
                  <p class="text-xs text-slate-600 mb-1">总投注</p>
                  <p class="text-sm font-semibold text-slate-700">${totalCount} 次</p>
                </div>
                
                <!-- 总赢得 -->
                <div class="bg-white rounded-xl p-4 text-center shadow-md hover:shadow-xl transition-shadow border border-green-100">
                  <div class="text-2xl font-bold text-green-600 mb-1">
                    $${(totalWin / 500000).toFixed(2)}
                  </div>
                  <p class="text-xs text-slate-600 mb-1">总赢得</p>
                  <p class="text-sm font-semibold text-slate-700">${winCount} 次</p>
                </div>
                
                <!-- 盈亏 -->
                <div class="bg-white rounded-xl p-4 text-center shadow-md hover:shadow-xl transition-shadow ${netProfit >= 0 ? 'border border-green-100' : 'border border-red-100'}">
                  <div class="text-2xl font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'} mb-1">
                    ${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}
                  </div>
                  <p class="text-xs text-slate-600 mb-1">净盈亏</p>
                  <p class="text-sm font-semibold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${netProfit >= 0 ? '📈 盈利' : '📉 亏损'}
                  </p>
                </div>
              </div>
              
              <!-- 奖项分布 -->
              <div class="bg-white rounded-xl p-5 shadow-md border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                  <p class="text-sm font-bold text-slate-700">🎁 奖项分布</p>
                  <p class="text-xs text-slate-500">各奖项获得次数及概率</p>
                </div>
                <div class="space-y-2">
                  ${Object.entries(winTypes)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([key, data]) => {
                      const percentage = totalCount > 0 ? ((data.count / totalCount) * 100).toFixed(1) : '0.0';
                      const barWidth = totalCount > 0 ? (data.count / totalCount) * 100 : 0;
                      return `
                        <div class="relative">
                          <div class="flex items-center justify-between text-xs mb-1">
                            <span class="font-medium ${data.color}">${data.name}</span>
                            <div>
                              <span class="font-bold text-slate-900">${data.count}</span>
                              <span class="text-slate-500 ml-1">(${percentage}%)</span>
                            </div>
                          </div>
                          <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-400 to-indigo-500 rounded-full transition-all duration-500" 
                                 style="width: ${barWidth}%"></div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                </div>
              </div>
              
              ${totalCount > 10 ? `
                <div class="mt-5 text-center">
                  <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm border border-purple-200">
                    <span class="text-purple-600">👇</span>
                    <span class="text-sm font-medium text-purple-700">以下显示最近 10 条记录</span>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
          
          // 只显示最近10条
          const displayRecords = records.slice(0, 10);
          
          container.innerHTML = statsHtml + displayRecords.map((r, idx) => {
            const winClass = r.win_amount > 0 ? 'text-green-600' : 'text-slate-500';
            const bgClass = r.win_amount > 0 ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200';
            const symbolsHTML = r.result_symbols.map(s => {
              const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
              return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-12 h-12 object-contain border border-slate-300 rounded">`;
            }).join('');

            // 优先显示 LinuxDo 用户名，如果没有则显示公益站用户名
            const displayName = r.linux_do_username || r.username;

            return `
              <div class="border ${bgClass} rounded-lg p-4 mb-3">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-600">#${displayRecords.length - idx}</span>
                    <span class="text-xs font-medium text-indigo-600">@${displayName}</span>
                    <span class="text-xs text-slate-500">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</span>
                    ${r.is_free_spin ? '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">免费</span>' : ''}
                  </div>
                  <span class="font-semibold ${winClass}">
                    ${r.win_type_name} ${r.multiplier}x
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex gap-2">
                    ${symbolsHTML}
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-slate-600">投注: <span class="font-semibold">$${(r.bet_amount / 500000).toFixed(2)}</span></p>
                    <p class="text-sm ${winClass}">赢得: <span class="font-bold text-lg">$${(r.win_amount / 500000).toFixed(2)}</span></p>
                    ${r.free_spin_awarded ? '<p class="text-xs text-purple-600 font-semibold">🎁 获得免费次数</p>' : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('');
    }

    // 筛选老虎机记录
    function filterSlotRecords() {
      const searchInput = document.getElementById('recordSearchInput').value.toLowerCase();
      const winTypeFilter = document.getElementById('winTypeFilter').value;
      
      let filteredRecords = allSlotRecords;
      
      // 按用户名筛选
      if (searchInput) {
        filteredRecords = filteredRecords.filter(r => {
          const username = (r.linux_do_username || r.username || '').toLowerCase();
          return username.includes(searchInput);
        });
      }
      
      // 按中奖类型筛选（修复：空字符串也要过滤）
      if (winTypeFilter && winTypeFilter !== 'all') {
        filteredRecords = filteredRecords.filter(r => {
          // 确保比较的是相同类型
          const recordWinType = r.win_type || '';
          return recordWinType === winTypeFilter;
        });
      }
      
      // 显示筛选结果提示
      const hintEl = document.getElementById('filterResultHint');
      if (searchInput || winTypeFilter !== 'all') {
        hintEl.textContent = `🔍 找到 ${filteredRecords.length} 条记录（总记录数: ${allSlotRecords.length}）`;
        hintEl.classList.remove('hidden');
      } else {
        hintEl.textContent = `📊 总记录数: ${allSlotRecords.length}`;
        hintEl.classList.remove('hidden');
      }
      
      // 渲染筛选后的记录
      renderSlotRecords(filteredRecords);
    }

    // 刷新记录（保留筛选条件）
    async function refreshSlotRecordsKeepFilter() {
      try {
        // 保存当前筛选条件
        const searchInput = document.getElementById('recordSearchInput').value;
        const winTypeFilter = document.getElementById('winTypeFilter').value;
        
        // 根据当前模式重新获取数据
        const mode = isInAdvancedMode ? 'advanced' : 'normal';
        const recordsRes = await fetch(`/api/slot/records?mode=${mode}`);
        const recordsData = await recordsRes.json();
        
        if (!recordsData.success) {
          showToast(recordsData.message, 'error');
          return;
        }
        
        // 更新全局记录
        allSlotRecords = recordsData.data;
        
        // 应用筛选条件
        filterSlotRecords();
        
        showToast('记录已刷新', 'success');
      } catch (error) {
        console.error('刷新记录失败:', error);
        showToast('刷新失败', 'error');
      }
    }

    // 清除筛选
    function clearRecordFilters() {
      document.getElementById('recordSearchInput').value = '';
      document.getElementById('winTypeFilter').value = 'all';
      
      // 显示总记录数
      const hintEl = document.getElementById('filterResultHint');
      hintEl.textContent = `📊 总记录数: ${allSlotRecords.length}`;
      hintEl.classList.remove('hidden');
      
      // 渲染所有记录
      renderSlotRecords(allSlotRecords);
    }

    // 关闭游戏记录
    function closeSlotRecords() {
      document.getElementById('slotRecordsModal').classList.add('hidden');
    }

    // 显示游戏规则
    function showSlotRules() {
      // 更新规则中的动态配置显示
      if (slotConfig) {
        const betAmountUSD = (slotConfig.bet_amount / 500000).toFixed(2);
        const minQuotaUSD = (slotConfig.min_quota_required / 500000).toFixed(2);
        const maxSpins = slotConfig.max_daily_spins;
        
        // 更新基本规则
        const basicRulesBetAmount = document.getElementById('basicRulesBetAmount');
        if (basicRulesBetAmount) basicRulesBetAmount.textContent = `$${betAmountUSD}`;
        
        const basicRulesMaxSpins = document.getElementById('basicRulesMaxSpins');
        if (basicRulesMaxSpins) basicRulesMaxSpins.textContent = `${maxSpins}次`;
        
        const basicRulesMinQuota = document.getElementById('basicRulesMinQuota');
        if (basicRulesMinQuota) basicRulesMinQuota.textContent = `$${minQuotaUSD}`;
        
        // 更新投注金额说明
        const rulesBetAmount = document.getElementById('rulesBetAmount');
        if (rulesBetAmount) rulesBetAmount.textContent = `$${betAmountUSD}`;
        
        // 更新奖励倍率（从配置中获取）
        if (slotConfig.multipliers) {
          const multipliers = slotConfig.multipliers;
          
          // 更新超级大奖倍率
          const rulesSuperJackpot = document.getElementById('rulesSuperJackpot');
          if (rulesSuperJackpot) {
            const totalAmount = (multipliers.super_jackpot * slotConfig.bet_amount / 500000).toFixed(2);
            rulesSuperJackpot.textContent = `${multipliers.super_jackpot}x$${betAmountUSD} ≈ $${totalAmount}`;
          }
          
          // 更新特殊组合倍率
          const rulesSpecialCombo = document.getElementById('rulesSpecialCombo');
          if (rulesSpecialCombo) {
            const totalAmount = (multipliers.special_combo * slotConfig.bet_amount / 500000).toFixed(2);
            rulesSpecialCombo.textContent = `${multipliers.special_combo}x$${betAmountUSD} ≈ $${totalAmount}`;
          }
          
          // 更新四连倍率
          const rulesQuad = document.getElementById('rulesQuad');
          if (rulesQuad) {
            const totalAmount = (multipliers.quad * slotConfig.bet_amount / 500000).toFixed(2);
            rulesQuad.textContent = `${multipliers.quad}x$${betAmountUSD} ≈ $${totalAmount}`;
          }
          
          // 更新三连倍率
          const rulesTriple = document.getElementById('rulesTriple');
          if (rulesTriple) {
            const totalAmount = (multipliers.triple * slotConfig.bet_amount / 500000).toFixed(2);
            rulesTriple.textContent = `${multipliers.triple}x$${betAmountUSD} ≈ $${totalAmount}`;
          }
          
          // 更新双连倍率
          const rulesDouble = document.getElementById('rulesDouble');
          if (rulesDouble) {
            const totalAmount = (multipliers.double * slotConfig.bet_amount / 500000).toFixed(2);
            rulesDouble.textContent = `${multipliers.double}x$${betAmountUSD} ≈ $${totalAmount}`;
          }
        }
      }
      document.getElementById('slotRulesModal').classList.remove('hidden');
    }

    // 关闭游戏规则
    function closeSlotRules() {
      document.getElementById('slotRulesModal').classList.add('hidden');
    }

    // 显示排行榜
    async function showLeaderboard() {
      try {
        const res = await fetch('/api/slot/leaderboard?limit=100');
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          return;
        }

        const { leaderboard, lossLeaderboard, userStats, userRank, userLossRank } = data.data;

        // 更新用户统计
        document.getElementById('myRank').textContent = userRank > 0 ? `#${userRank}` : '-';
        document.getElementById('myTotalSpins').textContent = userStats.total_spins || 0;
        document.getElementById('myTotalBet').textContent = `$${((userStats.total_bet || 0) / 500000).toFixed(2)}`;
        
        // 计算并显示用户盈亏
        const myProfit = (userStats.total_win || 0) - (userStats.total_bet || 0);
        const myProfitText = `${myProfit >= 0 ? '+' : ''}$${(myProfit / 500000).toFixed(2)}`;
        const myProfitElement = document.getElementById('myTotalProfit');
        myProfitElement.textContent = myProfitText;
        myProfitElement.className = `text-2xl font-bold ${myProfit >= 0 ? 'text-green-600' : 'text-red-600'}`;
        
        document.getElementById('myBiggestWin').textContent = `$${((userStats.biggest_win || 0) / 500000).toFixed(2)}`;
        
        const winTypeLabels = {
          'super_jackpot': '(🏆 超级大奖)',
          'special_combo': '(💎 特殊组合)',
          'quad': '(🎰 四连)',
          'triple': '(✨ 三连)',
          'double': '(🎁 双连)',
          'punishment': '(⚡ 惩罚)',
          'none': ''
        };
        document.getElementById('myBiggestWinType').textContent = winTypeLabels[userStats.biggest_win_type] || '';

        // 渲染盈利排行榜
        const container = document.getElementById('leaderboardContent');
        
        if (leaderboard.length === 0) {
          container.innerHTML = '<p class="text-center text-slate-500 py-8">暂无排行数据</p>';
        } else {
          container.innerHTML = `
            <div class="mb-4">
              <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <span>🏆</span>
                <span>盈利排行榜 TOP 20</span>
                <span class="text-sm font-normal text-slate-500">（赚最多）</span>
              </h3>
              <div class="space-y-3">
                ${leaderboard.map((user, index) => {
                const rank = index + 1;
                let rankBadge = '';
                let bgClass = 'bg-white hover:bg-slate-50';
                
                if (rank === 1) {
                  rankBadge = '<span class="text-4xl">🥇</span>';
                  bgClass = 'bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-400';
                } else if (rank === 2) {
                  rankBadge = '<span class="text-4xl">🥈</span>';
                  bgClass = 'bg-gradient-to-r from-gray-50 to-slate-100 border-2 border-gray-400';
                } else if (rank === 3) {
                  rankBadge = '<span class="text-4xl">🥉</span>';
                  bgClass = 'bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-400';
                } else {
                  rankBadge = `<span class="text-2xl font-bold text-slate-600">#${rank}</span>`;
                }

                const winTypeLabel = winTypeLabels[user.biggest_win_type] || '';
                
                // 计算盈亏
                const profit = (user.total_win || 0) - (user.total_bet || 0);
                const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';

                return `
                  <div class="p-4 rounded-lg border border-slate-200 ${bgClass} transition-all">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-4">
                        <div class="w-16 text-center">${rankBadge}</div>
                        <div>
                          <p class="font-bold text-lg text-slate-900">${user.username || user.linux_do_id}</p>
                          <p class="text-sm text-slate-600">游玩 ${user.total_spins} 次</p>
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="text-xs text-slate-500">总盈亏</p>
                        <p class="text-2xl font-bold ${profitColor}">${profitText}</p>
                        <p class="text-xs text-slate-500 mt-1">最大奖金: $${(user.biggest_win / 500000).toFixed(2)} ${winTypeLabel}</p>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
              </div>
            </div>
          `;
        }
        
        // 渲染亏损排行榜
        const lossContainer = document.getElementById('lossLeaderboardContent');
        
        if (!lossLeaderboard || lossLeaderboard.length === 0) {
          lossContainer.innerHTML = '';
        } else {
          lossContainer.innerHTML = `
            <div class="mt-8 pt-6 border-t-2 border-red-200">
              <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center gap-2">
                <span>📉</span>
                <span>亏损排行榜 TOP 20</span>
                <span class="text-sm font-normal text-slate-500">（亏最多）</span>
              </h3>
              <div class="space-y-3">
                ${lossLeaderboard.length === 0 ? 
                  '<p class="text-center text-green-600 py-8 font-semibold">🎉 暂无亏损用户，所有玩家都在盈利！</p>' :
                  lossLeaderboard.slice(0, 20).map((user, index) => {
                  const rank = index + 1;
                  let rankBadge = '';
                  let bgClass = 'bg-red-50 hover:bg-red-100 border-red-200';
                  
                  if (rank === 1) {
                    rankBadge = '<span class="text-4xl">😱</span>';
                    bgClass = 'bg-gradient-to-r from-red-100 to-rose-100 border-2 border-red-500';
                  } else if (rank === 2) {
                    rankBadge = '<span class="text-4xl">😭</span>';
                    bgClass = 'bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-400';
                  } else if (rank === 3) {
                    rankBadge = '<span class="text-4xl">😢</span>';
                    bgClass = 'bg-gradient-to-r from-orange-50 to-red-50 border-2 border-red-300';
                  } else {
                    rankBadge = `<span class="text-2xl font-bold text-red-600">#${rank}</span>`;
                  }

                  const winTypeLabel = winTypeLabels[user.biggest_win_type] || '';
                  
                  // 计算盈亏
                  const profit = (user.total_win || 0) - (user.total_bet || 0);
                  const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
                  const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-700';

                  return `
                    <div class="p-4 rounded-lg border ${bgClass} transition-all">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <div class="w-16 text-center">${rankBadge}</div>
                          <div>
                            <p class="font-bold text-lg text-slate-900">${user.username || user.linux_do_id}</p>
                            <p class="text-sm text-slate-600">游玩 ${user.total_spins} 次</p>
                          </div>
                        </div>
                        <div class="text-right">
                          <p class="text-xs text-slate-500">总盈亏</p>
                          <p class="text-2xl font-bold ${profitColor}">${profitText}</p>
                          <p class="text-xs text-slate-500 mt-1">投注: $${(user.total_bet / 500000).toFixed(2)}</p>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
        if (lossLeaderboard.length === 0) {
          lossContainer.innerHTML = `
            <div class="mt-8 pt-6 border-t-2 border-green-200">
              <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <span>🎉</span>
                <span>太棒了！所有玩家都在盈利</span>
              </h3>
              <p class="text-center text-slate-500 py-8 bg-green-50 rounded-lg border border-green-200">
                暂时没有亏损的用户<br>
                <span class="text-sm">大家都玩得很好！</span>
              </p>
            </div>
          `;
        }

        document.getElementById('leaderboardModal').classList.remove('hidden');
        // 默认显示盈利榜
        switchLeaderboardTab('profit');
      } catch (error) {
        console.error('获取排行榜失败:', error);
        showToast('获取排行榜失败', 'error');
      }
    }

    // 关闭排行榜
    function closeLeaderboard() {
      document.getElementById('leaderboardModal').classList.add('hidden');
    }

    // 切换排行榜标签页
    function switchLeaderboardTab(tab) {
      const profitTab = document.getElementById('profitTabBtn');
      const lossTab = document.getElementById('lossTabBtn');
      const profitContent = document.getElementById('leaderboardContent');
      const lossContent = document.getElementById('lossLeaderboardContent');

      if (tab === 'profit') {
        // 激活盈利榜标签
        profitTab.classList.add('border-green-500', 'bg-white', 'text-green-600');
        profitTab.classList.remove('border-transparent', 'text-slate-600');
        lossTab.classList.remove('border-red-500', 'bg-white', 'text-red-600');
        lossTab.classList.add('border-transparent', 'text-slate-600');
        
        // 显示盈利榜内容
        profitContent.classList.remove('hidden');
        lossContent.classList.add('hidden');
      } else if (tab === 'loss') {
        // 激活亏损榜标签
        lossTab.classList.add('border-red-500', 'bg-white', 'text-red-600');
        lossTab.classList.remove('border-transparent', 'text-slate-600');
        profitTab.classList.remove('border-green-500', 'bg-white', 'text-green-600');
        profitTab.classList.add('border-transparent', 'text-slate-600');
        
        // 显示亏损榜内容
        lossContent.classList.remove('hidden');
        profitContent.classList.add('hidden');
      }
    }

    // ========== 待发放奖金功能 ==========

    // 显示待发放奖金弹窗
    async function showPendingRewardsModal() {
      // 关闭所有下拉菜单
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');

      document.getElementById('pendingRewardsModal').classList.remove('hidden');
      await loadPendingRewards();
    }

    // 关闭待发放奖金弹窗
    function closePendingRewards() {
      document.getElementById('pendingRewardsModal').classList.add('hidden');
    }

    // 加载待发放奖金记录
    async function loadPendingRewards() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          return;
        }

        const { summary, rewards } = data.data;
        
        // 更新统计信息（模态框内）
        document.getElementById('modalPendingCount').textContent = summary.pending_count;
        document.getElementById('modalPendingAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;
        document.getElementById('modalSuccessAmount').textContent = `$${(summary.success_amount / 500000).toFixed(2)}`;
        
        // 获取当前用户信息（包含余额）
        const userRes = await fetch('/api/user/quota');
        const userData = await userRes.json();
        if (userData.success && userData.data) {
          const currentQuota = userData.data.quota || 0;
          document.getElementById('modalCurrentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
          
          // 同时更新底部的当前余额显示
          document.getElementById('currentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
        }
        
        // 更新底部统计栏的待发放信息
        document.getElementById('pendingRewardsCount').textContent = summary.pending_count;
        document.getElementById('pendingRewardsAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;

        // 渲染记录列表
        const container = document.getElementById('pendingRewardsList');
        
        if (rewards.length === 0) {
          container.innerHTML = '<div class="text-center text-slate-500 py-8"><p class="text-xl">🎉</p><p class="mt-2">暂无待发放记录</p></div>';
          return;
        }

        // 状态标签
        const statusLabels = {
          'pending': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⏳ 待处理</span>',
          'processing': '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">⚙️ 处理中</span>',
          'success': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ 成功</span>',
          'failed': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">❌ 失败</span>'
        };

        container.innerHTML = `
          <div class="space-y-3">
            ${rewards.map(reward => {
              const statusBadge = statusLabels[reward.status] || statusLabels['pending'];
              const amountClass = reward.status === 'success' ? 'text-green-600' : 
                                 reward.status === 'failed' ? 'text-red-600' : 'text-orange-600';
              
              // 申请补发按钮（仅失败和待处理状态显示）
              let actionButton = '';
              if (reward.status === 'failed' || reward.status === 'pending') {
                actionButton = `
                  <button 
                    id="retryBtn_${reward.id}"
                    onclick="retryUserPendingReward(${reward.id}, ${reward.amount.toFixed(2)})" 
                    class="mt-3 w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">
                    🔄 申请补发
                  </button>
                `;
              } else if (reward.status === 'processing') {
                actionButton = `
                  <div class="mt-3 w-full px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-center text-sm font-semibold">
                    ⚙️ 申请中...
                  </div>
                `;
              } else if (reward.status === 'success') {
                actionButton = `
                  <div class="mt-3 w-full px-4 py-2 bg-green-100 text-green-700 rounded-lg text-center text-sm font-semibold">
                    ✅ 已发放到账
                  </div>
                `;
              }
              
              return `
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:border-slate-300 transition-colors">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                        <span class="font-semibold text-${amountClass} text-lg">$${reward.amount.toFixed(2)}</span>
                        ${statusBadge}
                      </div>
                      <p class="text-sm text-slate-700 mb-1">
                        <span class="font-medium">原因：</span>${reward.reason}
                      </p>
                      <p class="text-xs text-slate-500">
                        创建时间：${reward.created_date}
                        ${reward.retry_count > 0 ? `<span class="ml-2 text-orange-600">• 已重试 ${reward.retry_count} 次</span>` : ''}
                      </p>
                      ${reward.error_message ? `
                        <p class="text-xs text-red-600 mt-1 p-2 bg-red-50 rounded border border-red-200">
                          ⚠️ ${reward.error_message}
                        </p>
                      ` : ''}
                      ${actionButton}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;

      } catch (error) {
        console.error('加载待发放记录失败:', error);
        showToast('加载待发放记录失败', 'error');
        document.getElementById('pendingRewardsList').innerHTML = 
          '<div class="text-center text-red-500 py-8"><p>加载失败，请重试</p></div>';
      }
    }

    // 刷新待发放记录
    async function refreshPendingRewards() {
      await loadPendingRewards();
      showToast('已刷新', 'success');
    }

    // 用户申请补发待发放奖金
    async function retryUserPendingReward(rewardId, amount) {
      if (!confirm(`确认申请补发 $${amount} 的奖金吗？\n\n系统将立即尝试为您发放到账。`)) {
        return;
      }

      const btn = document.getElementById(`retryBtn_${rewardId}`);
      if (!btn) return;

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">⚙️</span> 申请中...';

      try {
        const res = await fetch(`/api/slot/pending-rewards/${rewardId}/retry`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          // 成功
          showToast(`✅ ${data.message}`, 'success');
          
          // 等待1秒后刷新列表和额度
          setTimeout(async () => {
            await Promise.all([
              loadPendingRewards(),
              loadQuota()  // 刷新当前余额
            ]);
          }, 1000);
        } else {
          // 失败 - 显示详细错误信息
          let errorMsg = data.message;
          
          // 如果是429错误，给出更明确的提示
          if (data.httpStatus === 429 || data.details?.includes('429')) {
            errorMsg = '⚠️ API请求过于频繁，请5分钟后再试';
          } else if (data.details) {
            // 显示详细错误信息（开发调试用）
            console.error('[申请补发失败] 详细信息:', data.details);
          }
          
          showToast(`❌ ${errorMsg}`, 'error');
          
          // 刷新列表显示最新状态
          setTimeout(() => loadPendingRewards(), 500);
        }
      } catch (error) {
        console.error('申请补发失败:', error);
        showToast('❌ 网络错误，请重试', 'error');
        
        // 恢复按钮
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // 初始化时加载待发放统计（不打开弹窗）
    async function loadPendingRewardsSummary() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();

        if (data.success && data.data) {
          const { summary } = data.data;
          document.getElementById('pendingRewardsCount').textContent = summary.pending_count;
          document.getElementById('pendingRewardsAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;
        }
        
        // 同时获取当前余额
        const userRes = await fetch('/api/user/quota');
        const userData = await userRes.json();
        if (userData.success && userData.data) {
          const currentQuota = userData.data.quota || 0;
          document.getElementById('currentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
        }
      } catch (error) {
        console.error('加载待发放统计失败:', error);
      }
    }

    // ========== 结束：老虎机相关功能 ==========

    window.onload = async () => {
      const isOAuthCallback = document.referrer.includes('connect.linux.do') || sessionStorage.getItem('oauth_loading');

      if (!isOAuthCallback) {
        document.getElementById('loadingPage').classList.add('hidden');
      }

      try {
        const res = await fetch('/api/user/quota');
        const data = await res.json();
        
        if (res.ok) {
          document.getElementById('loadingPage').classList.add('hidden');
          
          // 恢复之前的模式
          const restoredMode = restoreMode();
          currentMode = restoredMode;
          
          if (restoredMode === 'entertain') {
            // 如果之前在老虎机页面，直接打开老虎机
            document.getElementById('mainSection').classList.add('hidden');
            await loadQuota();
            updateSwitchButtons('entertain');
            showSlotMachine();
            // 加载待发放记录统计
            loadPendingRewardsSummary();
          } else {
            // 默认显示加油站
            document.getElementById('mainSection').classList.remove('hidden');
            await loadQuota();
            updateSwitchButtons('refuel');
            // 加载待发放记录统计
            loadPendingRewardsSummary();
          }
          
          if (isOAuthCallback) {
            showToast('登录成功', 'success');
            sessionStorage.removeItem('oauth_loading');
          }
        } else if (res.status === 403 && data.banned) {
          // 用户被封禁
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
          alert('⚠️ ' + data.message);
        } else if (res.status === 400) {
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('bindSection').classList.remove('hidden');
        } else {
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
        }
      } catch (e) {
        document.getElementById('loadingPage').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
      }
    };
  </script>
</body>
</html>


