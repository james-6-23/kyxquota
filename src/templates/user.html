<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="KYX API å…¬ç›ŠåŠ æ²¹ç«™">
  <title>KYX API Refueling Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>âš¡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #0F9D58 0%, #0b7a42 100%);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 25%, #8b5cf6 75%, #ec4899 100%);
      position: relative;
      overflow: hidden;
    }

    .gradient-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(10%, 10%) rotate(90deg); }
      50% { transform: translate(0, 20%) rotate(180deg); }
      75% { transform: translate(-10%, 10%) rotate(270deg); }
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .animate-in {
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }

    /* ğŸ† æˆå°±Toastæ ·å¼ï¼ˆå·¦ä¸Šè§’ï¼‰ */
    .achievement-toast {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10000;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(251, 191, 36, 0.5);
      animation: achievementSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* æˆå°±Toastè¿›å…¥åŠ¨ç”»ï¼ˆä»å·¦ä¾§æ»‘å…¥ï¼‰ */
    @keyframes achievementSlideIn {
      from {
        opacity: 0;
        transform: translateX(-100px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    /* æˆå°±Toasté€€å‡ºåŠ¨ç”»ï¼ˆå‘å·¦ä¾§æ»‘å‡ºï¼‰ */
    @keyframes achievementSlideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(-100px) scale(0.8);
      }
    }

    /* æˆå°±å›¾æ ‡å¼¹è·³åŠ¨ç”» */
    @keyframes achievementBounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .achievement-toast {
        top: 10px;
        left: 10px;
        right: 10px;
        min-width: auto;
        max-width: none;
      }
    }

    /* è€è™æœºæ ·å¼ */
    .slot-reel-container {
      width: 180px;
      height: 180px;
      border: 5px solid #fbbf24;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .slot-reel {
      position: relative;
      height: 100%;
      width: 100%;
      overflow: hidden;
      /* ğŸ¯ ä¼˜åŒ–ï¼šå¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }

    .slot-symbols {
      position: relative;
      width: 100%;
      display: flex;
      flex-direction: column;
      /* ğŸ¯ ä¼˜åŒ–ï¼šå¯ç”¨ç¡¬ä»¶åŠ é€Ÿå’Œæ€§èƒ½ä¼˜åŒ– */
      will-change: transform, filter;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .slot-symbol {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      flex-shrink: 0;
      /* ğŸ¯ ä¼˜åŒ–ï¼šå‡å°‘é‡æ’å’Œé‡ç»˜ */
      contain: layout style paint;
    }

    .slot-symbol img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
      /* ğŸ¯ ä¼˜åŒ–ï¼šå›¾ç‰‡æ¸²æŸ“ä¼˜åŒ– */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      transform: translateZ(0);
    }

    /* è€è™æœºåŠ¨ç”»ä¼˜åŒ– */
    @media (prefers-reduced-motion: reduce) {
      .slot-symbols {
        animation: none !important;
      }
    }

    /* å“åº”å¼è°ƒæ•´ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media only screen and (max-width: 768px) {
      /* è€è™æœºæ»šè½® */
      .slot-reel-container {
        width: 70px;
        height: 70px;
      }
      
      .slot-symbol {
        height: 70px;
        padding: 5px;
      }
      
      .slot-symbol img {
        max-width: 100%;
        max-height: 100%;
        /* ğŸ¯ ç§»åŠ¨ç«¯ï¼šé™ä½æ¨¡ç³Šå¼ºåº¦ï¼Œæå‡æ€§èƒ½ */
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.3));
      }
      
      /* éšè—ä¾§è¾¹æ æ’è¡Œæ¦œå’Œç›ˆäºæ¦œ */
      #slotSidebarLeaderboard,
      #slotSidebarProfitBoard {
        display: none !important;
      }
      
      /* Toastæ¶ˆæ¯ä½ç½®è°ƒæ•´ */
      .toast {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: calc(100vw - 20px);
      }
      
      /* æ¨¡æ€æ¡†å†…è¾¹è·è°ƒæ•´ */
      .modal-content {
        padding: 1rem;
      }
    }
    
    /* å¹³æ¿ç«¯é€‚é… */
    @media only screen and (min-width: 769px) and (max-width: 1024px) {
      .slot-reel-container {
        width: 100px;
        height: 100px;
      }
      
      .slot-symbol {
        height: 100px;
        padding: 8px;
      }
      
      /* æ’è¡Œæ¦œçª„ä¸€äº› */
      #slotSidebarLeaderboard {
        width: 280px !important;
      }
    }

    /* ç•Œé¢åˆ‡æ¢è¿‡æ¸¡åŠ¨ç”» */
    .fade-enter {
      opacity: 0;
      transform: scale(0.95);
    }
    
    .fade-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    
    .fade-exit {
      opacity: 1;
      transform: scale(1);
    }
    
    .fade-exit-active {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 0.2s ease-in, transform 0.2s ease-in;
    }
    
    /* Loadingé®ç½© */
    .slot-loading-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #8b5cf6 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.3s ease-out;
    }
    
    /* ğŸ”¥ UIå…ƒç´ å¹³æ»‘è¿‡æ¸¡ */
    #advancedBetSelector,
    #advancedTicketBar,
    #normalModeSpinsDisplay,
    #advancedModeTitle,
    #normalModeTitle,
    #advancedModeIndicator {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    /* ğŸ”¥ éšè—çŠ¶æ€æ—¶çš„å¹³æ»‘æ¶ˆå¤± */
    .smooth-hide {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
    }
    
    /* ğŸ”¥ æ˜¾ç¤ºçŠ¶æ€æ—¶çš„å¹³æ»‘å‡ºç° */
    .smooth-show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    /* è€è™æœºèƒŒæ™¯ - é»˜è®¤æ¸å˜ï¼ˆå¯é€šè¿‡é…ç½®åˆ‡æ¢ä¸ºGIFï¼‰ */
    .slot-machine-bg {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 50%, rgba(139, 92, 246, 0.9) 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    /* ç¡®ä¿èƒŒæ™¯åœ¨æ‰€æœ‰å­å…ƒç´ åé¢ */
    .slot-machine-bg > * {
      position: relative;
      z-index: 1;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* ğŸ¯ ä¼˜åŒ–ï¼šæ»šè½®åœæ­¢æ—¶çš„è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 50px rgba(251, 191, 36, 0.9), inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 80px rgba(251, 191, 36, 0.4);
      }
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* æˆå°±ç³»ç»Ÿæ ·å¼ */
    .achievement-card {
      @apply bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden;
      position: relative;
      border: 2px solid transparent;
    }

    .achievement-card.unlocked {
      border: 2px solid #fbbf24;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      box-shadow: 0 4px 20px rgba(251, 191, 36, 0.2);
    }
    
    .achievement-card.unlocked::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #f59e0b 0%, #eab308 50%, #f59e0b 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .achievement-card.locked {
      opacity: 0.65;
      filter: grayscale(0.5);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .achievement-card:hover {
      transform: translateY(-4px);
    }
    
    .achievement-card.locked:hover {
      transform: translateY(-2px);
    }

    .achievement-filter-btn {
      @apply text-slate-600 hover:bg-slate-100 px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200;
      border: 2px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }
    
    .achievement-filter-btn:hover {
      border-color: #e2e8f0;
      background: #f1f5f9;
    }

    .achievement-filter-btn.active {
      background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      border: 2px solid #fbbf24;
      transform: scale(1.05);
    }
    
    .achievement-filter-btn.active:hover {
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
      transform: scale(1.08);
    }

    .achievement-progress-bar {
      height: 8px;
      background: linear-gradient(90deg, #f59e0b 0%, #eab308 50%, #fbbf24 100%);
      background-size: 200% 100%;
      transition: width 0.5s ease;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
      animation: progressShine 2s linear infinite;
    }
    
    @keyframes progressShine {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ç¨€æœ‰åº¦è¾¹æ¡†é¢œè‰² - å·¦ä¾§åŠ ç²—è¾¹æ¡† + å¾®å…‰æ•ˆæœ */
    .rarity-common { 
      border-left: 5px solid #9ca3af;
    }
    .rarity-rare { 
      border-left: 5px solid #3b82f6;
      box-shadow: -2px 0 10px rgba(59, 130, 246, 0.2);
    }
    .rarity-epic { 
      border-left: 5px solid #a855f7;
      box-shadow: -2px 0 10px rgba(168, 85, 247, 0.3);
    }
    .rarity-legendary { 
      border-left: 5px solid #f97316;
      box-shadow: -2px 0 10px rgba(249, 115, 22, 0.3);
    }
    .rarity-mythic { 
      border-left: 5px solid #ef4444;
      box-shadow: -2px 0 10px rgba(239, 68, 68, 0.4);
      animation: mythicGlow 2s ease-in-out infinite;
    }
    
    @keyframes mythicGlow {
      0%, 100% { box-shadow: -2px 0 10px rgba(239, 68, 68, 0.4); }
      50% { box-shadow: -2px 0 20px rgba(239, 68, 68, 0.6); }
    }
    
    /* æˆå°±å›¾æ ‡åŠ¨ç”» */
    .achievement-icon {
      transition: transform 0.3s ease;
    }
    
    .achievement-card:hover .achievement-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .achievement-card.unlocked .achievement-icon {
      filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.5));
    }
    
    /* æ–‡æœ¬æˆªæ–­ - å¤šè¡Œçœç•¥å· */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* æˆå°±å¡ç‰‡å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
      .achievement-card {
        margin-bottom: 0.5rem;
      }
      
      .achievement-icon {
        font-size: 2.5rem !important;
      }
      
      .achievement-card h3 {
        font-size: 1rem !important;
      }
    }
    
    /* æˆå°±è§£é”åŠ¨ç”» */
    @keyframes achievementUnlock {
      0% {
        transform: scale(0.9);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .achievement-unlocked-animation {
      animation: achievementUnlock 0.6s ease-out;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  
  <!-- æˆå°±è§£é”é€šçŸ¥å¼¹çª— -->
  <div id="achievementUnlockNotification" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9999]">
    <div class="bg-gradient-to-br from-amber-500 via-yellow-500 to-orange-500 rounded-3xl p-8 shadow-2xl border-4 border-yellow-300 max-w-md">
      <div class="text-center">
        <div class="text-7xl mb-4 animate-bounce" id="unlockIcon">ğŸ†</div>
        <h2 class="text-3xl font-bold text-white mb-2">ğŸ‰ æˆå°±è§£é”ï¼</h2>
        <p id="unlockName" class="text-xl font-semibold text-yellow-100 mb-3"></p>
        <p id="unlockDesc" class="text-sm text-white/90 mb-4"></p>
        <div class="flex items-center justify-center gap-3 text-white">
          <span id="unlockRarity" class="px-4 py-2 bg-white/20 rounded-full font-bold text-sm"></span>
          <span id="unlockReward" class="px-4 py-2 bg-white/30 rounded-full font-bold text-sm"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Page -->
  <div id="loadingPage" class="fixed inset-0 gradient-bg flex flex-col items-center justify-center z-50">
    <div class="relative">
      <div class="absolute inset-0 bg-white/20 rounded-full blur-2xl"></div>
      <div class="relative">
        <div class="spinner"></div>
      </div>
    </div>
    <p class="text-white text-xl font-semibold mt-6 tracking-wide">æ­£åœ¨åŠ è½½...</p>
    <div class="flex gap-2 mt-3">
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="hidden min-h-screen gradient-bg flex items-center justify-center p-6">
    <div class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl p-12 max-w-md w-full animate-in border border-white/20">
      <div class="flex justify-center mb-8">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur-2xl opacity-60 animate-pulse"></div>
          <div class="relative bg-white p-3 rounded-full shadow-2xl ring-4 ring-white/50">
            <img src="https://lh3.googleusercontent.com/a/ACg8ocJmyq3J-RuNfGv7J430fFiZ6EYQ0AB_phVlIPwm265e9HC1vJc=s288-c-no" alt="Logo" class="w-20 h-20 rounded-full object-cover">
          </div>
        </div>
      </div>
      <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3 whitespace-nowrap">KYX API Refueling Station</h1>
      <p class="text-center text-slate-600 mb-8 text-sm">âš¡ å…¬ç›Šç«™é¢åº¦åŠ æ²¹ç«™</p>
      
      <button onclick="login()" class="group relative w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white py-4 px-6 rounded-xl font-semibold overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl active:scale-[0.98]">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-700 via-purple-700 to-pink-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        <div class="relative flex items-center justify-center gap-3">
          <img src="https://linux.do/uploads/default/original/4X/c/c/d/ccd8c210609d498cbeb3d5201d4c259348447562.png" alt="Linux Do" class="w-6 h-6">
          <span class="text-lg">ä½¿ç”¨ Linux Do è´¦æˆ·ç™»å½•</span>
          <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </div>
      </button>
      
      <div class="mt-8 flex items-center justify-center gap-2 text-xs text-slate-500">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        <span>å®‰å…¨ç™»å½•ï¼Œä¿æŠ¤æ‚¨çš„éšç§</span>
      </div>
      
      <p class="text-xs text-slate-400 text-center mt-4">ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–</p>
    </div>
  </div>

  <!-- Bind Section -->
  <div id="bindSection" class="hidden min-h-screen gradient-bg flex items-center justify-center p-6">
    <div class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl p-12 max-w-md w-full animate-in border border-white/20">
      <div class="flex justify-center mb-6">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-r from-green-600 to-blue-600 rounded-full blur-xl opacity-50 animate-pulse"></div>
          <div class="relative bg-gradient-to-br from-green-500 to-blue-600 p-4 rounded-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      <h2 class="text-2xl font-bold text-center bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-2">ç»‘å®šå…¬ç›Šç«™è´¦å·</h2>
      <p class="text-sm text-slate-600 text-center mb-8">ğŸ”— è¯·è¾“å…¥æ‚¨åœ¨å…¬ç›Šç«™çš„ç”¨æˆ·å</p>
      <div id="bindMessage" class="hidden mb-4 p-3 rounded-lg"></div>
      <input type="text" id="username" placeholder="è¾“å…¥æ‚¨çš„å…¬ç›Šç«™ç”¨æˆ·å" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-6 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 outline-none text-lg">
      <button onclick="bindAccount()" class="group relative w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl font-semibold overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl active:scale-[0.98]">
        <div class="absolute inset-0 bg-gradient-to-r from-green-700 to-blue-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        <div class="relative flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          <span class="text-lg">ç¡®è®¤ç»‘å®š</span>
        </div>
      </button>
    </div>
  </div>

  <!-- Main Section -->
  <div id="mainSection" class="hidden">
    <!-- Navbar - å›ºå®šåœ¨é¡¶éƒ¨ -->
    <nav class="bg-white shadow-sm border-b border-slate-200 fixed top-0 left-0 right-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center h-16">
          <!-- Logo -->
          <div class="flex items-center gap-8">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">KYX API</h1>
            
            <!-- å¯¼èˆªé€‰é¡¹å¡ -->
            <div class="flex items-center gap-1" data-switch-container>
              <!-- åŠ æ²¹ç«™ -->
              <button data-btn="refuel" onclick="switchToRefuel()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md">
                <span>â›½</span>
                <span>åŠ æ²¹ç«™</span>
              </button>

              <!-- å¨±ä¹ç«™ -->
              <button data-btn="entertain" onclick="switchToEntertain()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>ğŸ°</span>
                <span>å¨±ä¹ç«™</span>
              </button>

              <!-- äº¤æ˜“æ‰€ -->
              <a href="/trading" class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>ğŸ’°</span>
                <span>äº¤æ˜“æ‰€</span>
              </a>

              <!-- æˆå°± -->
              <button data-btn="achievement" onclick="switchToAchievement()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>ğŸ†</span>
                <span>æˆå°±</span>
              </button>
            </div>
          </div>
          
          <!-- å³ä¾§ï¼šç”¨æˆ·èœå• -->
          <div class="flex items-center gap-3 ml-auto">
            <div class="relative">
              <button onclick="toggleDropdown()" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center text-white font-semibold">
                  <span id="userInitial">U</span>
                </div>
                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
              <div class="px-4 py-3 border-b border-slate-200">
                <p id="linuxDoUsername" class="font-semibold text-slate-900 text-sm">@ç”¨æˆ·å</p>
                <p id="userName" class="text-sm text-slate-600">å…¬ç›Šç«™: ç”¨æˆ·å</p>
                <p id="userId" class="text-xs text-slate-500">ID: xxx</p>
              </div>
              <button onclick="showSlotRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                <span>ğŸ°</span> æŠ½å¥–è®°å½•
              </button>
              <button onclick="showMyRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                <span>ğŸ“Š</span> æˆ‘çš„è®°å½•
              </button>
              <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2">
                <span>ğŸšª</span> é€€å‡ºç™»å½•
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Content - æ·»åŠ é¡¶éƒ¨paddingé¿å…è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ -->
    <div class="max-w-4xl mx-auto p-6 pt-24">
      <div id="message" class="hidden mb-4 p-4 rounded-lg animate-in"></div>

      <!-- Quota Display -->
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white mb-6 shadow-xl animate-in">
        <p class="text-sm opacity-90 mb-2">å½“å‰å‰©ä½™é¢åº¦</p>
        <h2 id="quotaValue" class="text-5xl font-bold mb-4">--</h2>
        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/20">
          <div>
            <p class="text-xs opacity-75">å·²ä½¿ç”¨</p>
            <p id="quotaUsage" class="text-lg font-semibold">--</p>
          </div>
          <div>
            <p class="text-xs opacity-75">çŠ¶æ€</p>
            <p id="quotaStatus" class="text-lg font-semibold">æ­£å¸¸</p>
          </div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-in card-hover">
        <h3 class="text-xl font-bold text-slate-900 mb-4">ğŸ’° æ¯æ—¥é¢åº¦é¢†å–</h3>
        <p class="text-sm text-slate-600 mb-2">å½“æ‚¨çš„å‰©ä½™é¢åº¦ä½äº $20 æ—¶ï¼Œå¯ä»¥æ¯å¤©é¢†å–é¢åº¦è¡¥å……</p>
        
        <!-- é¢†å–æ¬¡æ•°æ˜¾ç¤º -->
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-xs text-blue-800">
              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
              </svg>
              <span>ä»Šæ—¥é¢†å–æƒ…å†µ</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-blue-700">
                å·²é¢†å– <span id="todayClaimCount" class="text-lg">0</span>/<span id="maxDailyClaims">1</span> æ¬¡
              </span>
              <span id="remainingClaims" class="px-2 py-1 bg-blue-600 text-white rounded-full text-xs font-semibold">å‰©ä½™ 1 æ¬¡</span>
            </div>
          </div>
        </div>
        
        <button id="claimBtn" onclick="claimQuota()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
          é¢†å–ä»Šæ—¥é¢åº¦
        </button>
      </div>

      <!-- Donate Cards Container -->
      <div class="bg-white rounded-2xl shadow-lg p-6 animate-in card-hover">
        <h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">ğŸ’ æŠ•å–‚ API Keys</h3>
        <p id="donateDescription" class="text-sm text-slate-600 mb-6 text-center">æ¯ä¸ªæœ‰æ•ˆçš„ API Key å¯ä¸ºæ‚¨å¢åŠ  $50 é¢åº¦å¹¶ä¸”è·å¾—ä¸€æ¬¡å…è´¹æŠ½å¥–æœºä¼š Â· æ¯ç§ç±»å‹æ¯å¤©å¯æŠ•å–‚ 1 ä¸ª</p>
        
        <!-- ä¸¤åˆ—å¸ƒå±€ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <!-- ModelScope Card -->
          <div class="border-2 border-indigo-200 rounded-xl p-5 hover:border-indigo-400 transition-colors">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">ğŸ</span>
              <h4 class="text-lg font-bold text-slate-900">ModelScope Key</h4>
            </div>
            
            <!-- æŠ•å–‚é™åˆ¶è¯´æ˜ -->
            <div id="donateWarning" class="mb-3 p-2 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-red-800">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span><strong>æ¯å¤©åªèƒ½æäº¤ 1 ä¸ª</strong></span>
              </div>
            </div>

            <!-- ä»Šæ—¥å·²æŠ•å–‚æç¤º -->
            <div id="donatedToday" class="hidden mb-3 p-2 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-green-800">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>âœ“ <strong>ä»Šæ—¥å·²æŠ•å–‚</strong></span>
              </div>
            </div>
            
            <textarea id="keysInput" placeholder="ms-xxxxx-xxxx-xxxx-xxxx" class="w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm resize-none"></textarea>
            <button id="donateBtn" onclick="donateKeys()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3">
              ğŸš€ æäº¤ ModelScope Key
            </button>
            <a href="https://www.modelscope.cn/my/myaccesstoken" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 text-xs text-indigo-600 hover:text-indigo-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              <span class="font-medium">è·å– ModelScope API Key</span>
            </a>
          </div>

          <!-- iFlow Card -->
          <div class="border-2 border-emerald-200 rounded-xl p-5 hover:border-emerald-400 transition-colors">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">âœ¨</span>
              <h4 class="text-lg font-bold text-slate-900">iFlow API Key</h4>
            </div>
            
            <!-- æŠ•å–‚é™åˆ¶è¯´æ˜ -->
            <div id="donateIflowWarning" class="mb-3 p-2 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-red-800">
                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span><strong>æ¯å¤©åªèƒ½æäº¤ 1 ä¸ª</strong></span>
              </div>
            </div>

            <!-- ä»Šæ—¥å·²æŠ•å–‚æç¤º -->
            <div id="donatedIflowToday" class="hidden mb-3 p-2 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center gap-2 text-xs text-green-800">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>âœ“ <strong>ä»Šæ—¥å·²æŠ•å–‚</strong></span>
              </div>
            </div>
            
            <textarea id="iflowKeysInput" placeholder="sk-xxxxx-xxxx-xxxx-xxxx" class="w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-emerald-500 focus:border-transparent font-mono text-sm resize-none"></textarea>
            <button id="donateIflowBtn" onclick="donateIflowKeys()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3">
              ğŸš€ æäº¤ iFlow Key
            </button>
            <a href="https://platform.iflow.cn/profile?tab=apiKey" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 text-xs text-emerald-600 hover:text-emerald-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              <span class="font-medium">è·å– iFlow API Key</span>
            </a>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Records Modal -->
  <div id="recordsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl animate-in">
      <div class="flex justify-between items-center p-6 border-b border-slate-200">
        <h2 class="text-2xl font-bold text-slate-900">æˆ‘çš„è®°å½•</h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-6">
        <div class="flex gap-2 mb-6 border-b border-slate-200">
          <button onclick="showTab('claim')" class="tab-btn px-4 py-2 font-semibold border-b-2 border-indigo-600 text-indigo-600">é¢†å–è®°å½•</button>
          <button onclick="showTab('donate')" class="tab-btn px-4 py-2 font-semibold border-b-2 border-transparent text-slate-500 hover:text-slate-900">æŠ•å–‚è®°å½•</button>
        </div>
        <div id="claimRecords" class="tab-content overflow-y-auto max-h-96"></div>
        <div id="donateRecords" class="tab-content hidden overflow-y-auto max-h-96"></div>
      </div>
    </div>
  </div>

  <!-- æˆå°±ç³»ç»Ÿç•Œé¢ -->
  <div id="achievementSection" class="hidden fixed inset-0 bg-slate-50 z-50 overflow-y-auto">
    <!-- å›ºå®šé¡¶éƒ¨å¯¼èˆªæ ï¼ˆå¤ç”¨ä¸»ç•Œé¢å¯¼èˆªæ æ ·å¼ï¼‰-->
    <nav class="bg-white shadow-sm border-b border-slate-200 fixed top-0 left-0 right-0 z-[60]">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center h-16">
          <!-- Logo -->
          <div class="flex items-center gap-8">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">KYX API</h1>
            
            <!-- å¯¼èˆªé€‰é¡¹å¡ -->
            <div class="flex items-center gap-1" data-switch-container>
              <!-- åŠ æ²¹ç«™ -->
              <button data-btn="refuel" onclick="switchToRefuel()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>â›½</span>
                <span>åŠ æ²¹ç«™</span>
              </button>

              <!-- å¨±ä¹ç«™ -->
              <button data-btn="entertain" onclick="switchToEntertain()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>ğŸ°</span>
                <span>å¨±ä¹ç«™</span>
              </button>

              <!-- äº¤æ˜“æ‰€ -->
              <a href="/trading" class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100">
                <span>ğŸ’°</span>
                <span>äº¤æ˜“æ‰€</span>
              </a>

              <!-- æˆå°± -->
              <button data-btn="achievement" onclick="switchToAchievement()"
                      class="px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-amber-500 to-yellow-500 text-white shadow-md">
                <span>ğŸ†</span>
                <span>æˆå°±</span>
              </button>
            </div>
          </div>
          
          <!-- å³ä¾§ï¼šç”¨æˆ·èœå• -->
          <div class="flex items-center gap-3 ml-auto">
            <div class="relative">
              <button onclick="toggleDropdown()" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
                <div id="achievementUserAvatar" class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center text-white font-semibold">
                  <span id="achievementUserInitial">U</span>
                </div>
                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div id="achievementDropdownMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
                <div class="px-4 py-3 border-b border-slate-200">
                  <p id="achievementLinuxDoUsername" class="font-semibold text-slate-900 text-sm">@ç”¨æˆ·å</p>
                  <p id="achievementUserName" class="text-sm text-slate-600">å…¬ç›Šç«™: ç”¨æˆ·å</p>
                  <p id="achievementUserId" class="text-xs text-slate-500">ID: xxx</p>
                </div>
                <button onclick="showSlotRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                  <span>ğŸ°</span> æŠ½å¥–è®°å½•
                </button>
                <button onclick="showMyRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2">
                  <span>ğŸ“Š</span> æˆ‘çš„è®°å½•
                </button>
                <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2">
                  <span>ğŸšª</span> é€€å‡ºç™»å½•
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- å†…å®¹åŒºåŸŸ - æ·»åŠ é¡¶éƒ¨padding -->
    <div class="max-w-6xl mx-auto p-6 pt-24">
      <!-- æˆå°±ç»Ÿè®¡é¢æ¿ - ä¼˜åŒ–å¸ƒå±€ -->
      <div class="bg-gradient-to-r from-amber-500 via-yellow-500 to-orange-500 rounded-2xl p-6 md:p-8 text-white mb-6 shadow-xl animate-in relative overflow-hidden">
        <!-- èƒŒæ™¯è£…é¥° -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full blur-2xl translate-y-1/2 -translate-x-1/2"></div>
        
        <!-- å†…å®¹ -->
        <div class="relative z-10">
          <!-- å¤´éƒ¨ä¿¡æ¯ -->
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div>
              <h2 class="text-3xl md:text-4xl font-bold mb-2 flex items-center gap-3">
                <span class="text-4xl">ğŸ†</span>
                <span>æˆ‘çš„æˆå°±</span>
              </h2>
              <p class="text-sm md:text-base opacity-90">æ”¶é›†æˆå°±ï¼Œè§£é”å¥–åŠ±ï¼Œæˆä¸ºä¼ å¥‡ç©å®¶</p>
            </div>
            <div class="text-center md:text-right bg-white/20 backdrop-blur-md rounded-2xl p-4 min-w-[120px]">
              <p class="text-xs md:text-sm opacity-90 mb-1">å®Œæˆåº¦</p>
              <p id="achievementCompletion" class="text-4xl md:text-5xl font-bold text-yellow-200">0%</p>
            </div>
          </div>

          <!-- ç»Ÿè®¡å¡ç‰‡ - å“åº”å¼ç½‘æ ¼ -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
            <!-- æ€»æˆå°±æ•° -->
            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 hover:bg-white/30 transition-all group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ“š</span>
                <p class="text-xs opacity-75">æ€»æ•°</p>
              </div>
              <p id="totalAchievements" class="text-3xl font-bold">0</p>
            </div>
            
            <!-- å·²è§£é” -->
            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 hover:bg-white/30 transition-all group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ”“</span>
                <p class="text-xs opacity-75">è§£é”</p>
              </div>
              <p id="unlockedAchievements" class="text-3xl font-bold text-green-200">0</p>
            </div>
            
            <!-- æ€»å¥–åŠ± -->
            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 hover:bg-white/30 transition-all group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ’°</span>
                <p class="text-xs opacity-75">å¥–åŠ±</p>
              </div>
              <p id="totalRewards" class="text-3xl font-bold text-yellow-200">0</p>
            </div>
            
            <!-- å·²é¢†å– -->
            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 hover:bg-white/30 transition-all group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">âœ…</span>
                <p class="text-xs opacity-75">å·²é¢†</p>
              </div>
              <p id="claimedRewards" class="text-3xl font-bold text-emerald-200">0</p>
            </div>
          </div>

          <!-- ä¸€é”®é¢†å–æŒ‰é’® - ä¼˜åŒ–æ ·å¼ -->
          <button id="claimAllRewardsBtn" onclick="claimAllAchievementRewards()" 
                  class="w-full bg-white hover:bg-yellow-50 text-amber-600 py-4 rounded-xl font-bold text-base
                         shadow-xl hover:shadow-2xl transition-all duration-200
                         flex items-center justify-center gap-3
                         disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white
                         transform hover:scale-[1.02] active:scale-[0.98]
                         border-2 border-white/50">
            <span class="text-2xl">ğŸ’</span>
            <span>ä¸€é”®é¢†å–æ‰€æœ‰å¥–åŠ±</span>
          </button>
        </div>
      </div>

      <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
      <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
        <div class="flex items-center gap-3">
          <span class="text-xl">ğŸ‘€</span>
          <h3 class="text-lg font-bold text-slate-900">è§†å›¾æ¨¡å¼</h3>
          <div class="ml-auto flex gap-2">
            <button id="viewAchievementsBtn" onclick="switchAchievementView('achievements')" 
                    class="px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-lg font-semibold shadow-md text-sm flex items-center gap-2">
              <span>ğŸ†</span>
              <span>æˆå°±åˆ—è¡¨</span>
            </button>
            <button id="viewLeaderboardBtn" onclick="switchAchievementView('leaderboard')" 
                    class="px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all">
              <span>ğŸ“Š</span>
              <span>æ’è¡Œæ¦œ</span>
            </button>
          </div>
        </div>
      </div>

      <!-- åˆ†ç±»ç­›é€‰ - ä¼˜åŒ–å¸ƒå±€ï¼ˆä»…åœ¨æˆå°±åˆ—è¡¨è§†å›¾æ˜¾ç¤ºï¼‰-->
      <div id="achievementFilters" class="bg-white rounded-xl shadow-lg p-5 mb-6">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-xl">ğŸ·ï¸</span>
          <h3 class="text-lg font-bold text-slate-900">åˆ†ç±»ç­›é€‰</h3>
          <span id="filterCount" class="ml-auto text-sm text-slate-500"></span>
        </div>
        <div class="flex flex-wrap gap-2">
          <button onclick="filterAchievements('all', event)" class="achievement-filter-btn active">
            <span>ğŸ“‹</span>
            <span>å…¨éƒ¨</span>
          </button>
          <button onclick="filterAchievements('beginner', event)" class="achievement-filter-btn">
            <span>ğŸ‰</span>
            <span>æ–°æ‰‹</span>
          </button>
          <button onclick="filterAchievements('gaming', event)" class="achievement-filter-btn">
            <span>ğŸ®</span>
            <span>æ¸¸æˆ</span>
          </button>
          <button onclick="filterAchievements('wealth', event)" class="achievement-filter-btn">
            <span>ğŸ’°</span>
            <span>è´¢å¯Œ</span>
          </button>
          <button onclick="filterAchievements('jackpot', event)" class="achievement-filter-btn">
            <span>ğŸ°</span>
            <span>ä¸­å¥–</span>
          </button>
          <button onclick="filterAchievements('explorer', event)" class="achievement-filter-btn">
            <span>ğŸ«</span>
            <span>æ¢ç´¢</span>
          </button>
          <button onclick="filterAchievements('social', event)" class="achievement-filter-btn">
            <span>ğŸ’</span>
            <span>ç¤¾äº¤</span>
          </button>
          <button onclick="filterAchievements('challenge', event)" class="achievement-filter-btn">
            <span>ğŸ’ª</span>
            <span>æŒ‘æˆ˜</span>
          </button>
          <button onclick="filterAchievements('collection', event)" class="achievement-filter-btn">
            <span>ğŸ“š</span>
            <span>æ”¶è—</span>
          </button>
          <button onclick="filterAchievements('kunbei', event)" class="achievement-filter-btn">
            <span>ğŸ¦</span>
            <span>å¤å‘—</span>
          </button>
          <button onclick="filterAchievements('punishment', event)" class="achievement-filter-btn">
            <span>âš–ï¸</span>
            <span>æƒ©ç½š</span>
          </button>
        </div>
      </div>

      <!-- æˆå°±åˆ—è¡¨ - ä¼˜åŒ–å“åº”å¼å¸ƒå±€ -->
      <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- æˆå°±å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>

      <!-- æˆå°±æ’è¡Œæ¦œ - é»˜è®¤éšè— -->
      <div id="achievementLeaderboard" class="hidden">
        <!-- æ’è¡Œæ¦œå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
      <button id="backToTopBtn" onclick="scrollToTop()" 
              class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-amber-500 to-yellow-500 
                     text-white rounded-full shadow-xl hover:shadow-2xl transition-all duration-200
                     flex items-center justify-center z-50
                     transform hover:scale-110 active:scale-95">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- è€è™æœºå…¨å±ç•Œé¢ -->
  <div id="slotMachineModal" class="hidden fixed inset-0 z-50 slot-machine-bg">
    
    <!-- Loadingé®ç½© -->
    <div id="slotLoadingOverlay" class="slot-loading-overlay hidden">
      <div class="relative">
        <div class="spinner"></div>
      </div>
      <p class="text-white text-xl font-semibold mt-6 tracking-wide">åŠ è½½å¨±ä¹ç«™...</p>
      <div class="flex gap-2 mt-3">
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
      </div>
    </div>
    
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä¸ä¸»ç•Œé¢ä¸€è‡´ï¼‰-->
    <nav class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
        <div class="flex items-center h-16">
          <!-- Logoå’Œå¯¼èˆª - å“åº”å¼ -->
          <div class="flex items-center gap-2 sm:gap-4 md:gap-8">
            <h1 class="text-base sm:text-lg md:text-xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">KYX API</h1>
            
            <!-- å¯¼èˆªé€‰é¡¹å¡ - å“åº”å¼ -->
            <div class="flex items-center gap-1" data-switch-container>
              <!-- åŠ æ²¹ç«™ -->
              <button data-btn="refuel" onclick="switchToRefuel()" 
                      class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 text-white/70 hover:bg-white/10">
                <span class="text-base sm:text-lg">â›½</span>
                <span class="hidden sm:inline">åŠ æ²¹ç«™</span>
              </button>
              
              <!-- å¨±ä¹ç«™ -->
              <button data-btn="entertain" onclick="switchToEntertain()" 
                      class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-lg">
                <span class="text-base sm:text-lg">ğŸ°</span>
                <span class="hidden sm:inline">å¨±ä¹ç«™</span>
              </button>
              
              <!-- äº¤æ˜“æ‰€ -->
              <a href="/trading" class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 text-white/70 hover:bg-white/10">
                <span class="text-base sm:text-lg">ğŸ’°</span>
                <span class="hidden sm:inline">äº¤æ˜“æ‰€</span>
              </a>
              
              <!-- æˆå°± -->
              <button data-btn="achievement" onclick="switchToAchievement()" 
                      class="px-3 sm:px-4 py-2 rounded-lg font-medium text-xs sm:text-sm flex items-center gap-1 sm:gap-2 transition-all duration-200 text-white/70 hover:bg-white/10">
                <span class="text-base sm:text-lg">ğŸ†</span>
                <span class="hidden sm:inline">æˆå°±</span>
              </button>
            </div>
          </div>
          
          <!-- ğŸ”¥ é«˜çº§åœºæ ‡é¢˜ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰-->
          <div id="advancedModeTitle" class="hidden absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
            <span class="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent animate-pulse whitespace-nowrap">
              <span class="hidden sm:inline">ğŸ”¥ </span>é«˜çº§åœºæ¨¡å¼
            </span>
          </div>
          
          <!-- ğŸ° åˆçº§åœºæ ‡é¢˜ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰-->
          <div id="normalModeTitle" class="hidden absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
            <span class="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent whitespace-nowrap">
              <span class="hidden sm:inline">ğŸ° </span>åˆçº§åœº
            </span>
          </div>
          
          <!-- ğŸ’ è‡³å°Šåœºæ ‡é¢˜ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰-->
          <div id="supremeModeTitle" class="hidden absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2">
            <span class="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-purple-500 via-pink-500 to-yellow-500 bg-clip-text text-transparent animate-pulse whitespace-nowrap">
              <span class="hidden sm:inline">ğŸ’ </span>è‡³å°Šåœº
            </span>
          </div>
          
          <!-- å³ä¾§ï¼šç”¨æˆ·èœå•å’Œé«˜çº§åœºä¿¡æ¯ -->
          <div class="flex items-center gap-2 sm:gap-3 ml-auto">
            <!-- éŸ³æ•ˆæ§åˆ¶æŒ‰é’® -->
            <button id="soundToggleBtn" onclick="toggleSound()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="éŸ³æ•ˆå¼€å…³">
              <span id="soundIcon" class="text-xl">ğŸ”Š</span>
            </button>
            
            <!-- ç§»åŠ¨ç«¯æ’è¡Œæ¦œæŒ‰é’® -->
            <button onclick="showLeaderboard()" class="md:hidden p-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 transition-colors" title="æŸ¥çœ‹æ’è¡Œæ¦œ">
              <span class="text-xl">ğŸ†</span>
            </button>
            
            <div class="flex items-center gap-2">
              <!-- æ¡Œé¢ç«¯é¢åº¦æ˜¾ç¤º -->
              <div class="text-white text-right hidden sm:block">
                <p class="text-xs opacity-75">å‰©ä½™é¢åº¦</p>
                <p id="slotQuota" class="text-lg font-bold text-yellow-400">$0.00</p>
              </div>
              <!-- ç§»åŠ¨ç«¯ç®€åŒ–æ˜¾ç¤º -->
              <div class="text-white text-right sm:hidden">
                <p id="slotQuotaMobile" class="text-sm font-bold text-yellow-400">$0.00</p>
              </div>
              
              <!-- ğŸ”„ åˆ·æ–°æŒ‰é’® -->
              <button 
                id="refreshQuotaBtn"
                onclick="refreshQuota()" 
                class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all" 
                title="åˆ·æ–°é¢åº¦"
              >
                <svg id="refreshQuotaIcon" class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
            </div>
            
            <div class="relative">
              <button onclick="toggleSlotDropdown()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors">
                <div id="slotUserAvatar" class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center text-white font-semibold border-2 border-white/30">
                  <span id="slotUserInitial">U</span>
                </div>
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div id="slotDropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-50">
              <div class="px-4 py-3 border-b border-slate-200">
                <p id="slotLinuxDoUsername" class="font-semibold text-slate-900 text-sm">@ç”¨æˆ·å</p>
                <p id="slotUserName" class="text-sm text-slate-600">å…¬ç›Šç«™: ç”¨æˆ·å</p>
                <p id="slotUserId" class="text-xs text-slate-500">ID: xxx</p>
              </div>
                <button onclick="showSlotRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>ğŸ°</span> æŠ½å¥–è®°å½•
                </button>
                <button onclick="showMyRecords()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>ğŸ“Š</span> æˆ‘çš„è®°å½•
                </button>
                <button onclick="showPendingRewardsModal()" class="w-full text-left px-4 py-2 hover:bg-slate-100 transition-colors flex items-center gap-2 text-slate-900">
                  <span>ğŸ’°</span> å¾…å‘æ”¾è®°å½•
                </button>
                <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2">
                  <span>ğŸšª</span> é€€å‡ºç™»å½•
                </button>
              </div>
            </div>
            
            <!-- ğŸ”¥ é«˜çº§åœºå€’è®¡æ—¶å’Œè¿”å›æŒ‰é’® -->
            <div id="advancedModeIndicator" class="hidden flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg shadow-lg ml-2">
              <div class="text-white">
                <p class="text-xs opacity-75 leading-tight">å‰©ä½™æ—¶é—´</p>
                <p id="advancedTimeRemaining" class="text-sm font-mono font-bold text-yellow-300 leading-tight">23:59:59</p>
              </div>
              <button onclick="exitAdvancedMode()" class="px-2.5 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-bold rounded transition-all whitespace-nowrap">
                è¿”å›åˆçº§åœº
              </button>
            </div>
            
            <!-- ğŸ’ è‡³å°Šåœºå€’è®¡æ—¶å’Œè¿”å›æŒ‰é’® -->
            <div id="supremeModeIndicator" class="hidden flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 rounded-lg shadow-lg ml-2">
              <div class="text-white">
                <p class="text-xs opacity-75 leading-tight">å‰©ä½™æ—¶é—´</p>
                <p id="supremeTimeRemaining" class="text-sm font-mono font-bold text-yellow-300 leading-tight">23:59:59</p>
              </div>
              <button onclick="exitSupremeMode()" class="px-2.5 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-bold rounded transition-all whitespace-nowrap">
                è¿”å›é«˜çº§åœº
              </button>
            </div>
            
          </div>
        </div>
      </div>
    </nav>

    <!-- ğŸ”¥ å…¥åœºåˆ¸ä¿¡æ¯æ ï¼ˆä¿ç•™åŸæœ‰æ¨ªæ¡ï¼Œå¤‡ç”¨ï¼‰-->
    <div id="advancedTicketBar" class="hidden bg-gradient-to-r from-purple-600/90 to-blue-600/90 backdrop-blur-md border-b border-white/20">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex items-center justify-center py-1.5">
          <!-- ç´§å‡‘ä¸”æ¸…æ™°çš„å¸ƒå±€ -->
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- å…¥åœºåˆ¸ -->
            <div class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded">
              <span class="text-sm">ğŸŸï¸</span>
              <span class="text-white font-medium text-sm">
                <span id="ticketCount">0</span>/<span id="ticketMax" class="text-white/70">2</span>
              </span>
              <span id="dailyTicketGrantInfo" class="text-xs text-white/60 ml-1 hidden"></span>
            </div>
            
            <!-- ç¢ç‰‡ -->
            <div class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded">
              <span class="text-sm">ğŸ€</span>
              <span class="text-white font-medium text-sm">
                <span id="fragmentCount">0</span>/<span id="fragmentsNeeded" class="text-white/70">5</span>
              </span>
            </div>
            
            <!-- æ¯æ—¥è¿›å…¥æ¬¡æ•° -->
            <div id="dailyEntryInfo" class="flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded hidden">
              <span class="text-sm">ğŸ“…</span>
              <span class="text-white font-medium text-sm">
                ä»Šæ—¥è¿›å…¥: <span id="todayEntryCount">0</span>/<span id="dailyEntryLimit" class="text-white/70">2</span>
              </span>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <button id="synthesizeButton" onclick="synthesizeTicket()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              ğŸ”¨ åˆæˆ
            </button>
            
            <button id="enterAdvancedButton" onclick="enterAdvancedMode()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              ğŸ”¥ è¿›å…¥
            </button>
            
            <!-- è¿‡æœŸæ—¶é—´ -->
            <span id="ticketExpiry" class="text-white/60 text-xs hidden sm:inline"></span>
            
            <!-- æç¤ºï¼ˆç§»åŠ¨ç«¯éšè—ï¼‰-->
            <div class="hidden sm:block text-white/50 text-xs">
              äºŒè¿â†’ç¢ç‰‡ ä¸‰/å››è¿â†’åˆ¸
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ’ è‡³å°Šåœºä»¤ç‰Œä¿¡æ¯æ ï¼ˆåœ¨å¯¼èˆªæ ä¸‹æ–¹ï¼‰-->
    <div id="supremeTokenBar" class="hidden bg-gradient-to-r from-purple-900/90 via-pink-900/90 to-amber-900/90 backdrop-blur-md border-b border-amber-400/30">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex items-center justify-center py-1.5">
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- è‡³å°Šä»¤ç‰Œ -->
            <div class="flex items-center gap-1 bg-black/30 px-2 py-0.5 rounded border border-amber-400/50">
              <span class="text-sm">ğŸ’</span>
              <span class="text-amber-300 font-bold text-sm">
                ä»¤ç‰Œ: <span id="supremeTokenCount">0</span>/<span id="supremeTokenMax" class="text-amber-400/70">3</span>
              </span>
            </div>
            
            <!-- è‡³å°Šç¢ç‰‡ -->
            <div class="flex items-center gap-1 bg-black/30 px-2 py-0.5 rounded border border-blue-400/50">
              <span class="text-sm">ğŸ’ </span>
              <span class="text-blue-300 font-bold text-sm">
                ç¢ç‰‡: <span id="supremeFragmentCount">0</span>/<span id="supremeFragmentsNeeded" class="text-blue-400/70">10</span>
              </span>
            </div>
            
            <!-- ä»Šæ—¥è¿›å…¥æ¬¡æ•° -->
            <div class="flex items-center gap-1 bg-black/30 px-2 py-0.5 rounded">
              <span class="text-sm">ğŸ“…</span>
              <span class="text-white font-medium text-sm">
                ä»Šæ—¥: <span id="supremeTodayEntry">0</span>/<span id="supremeDailyLimit" class="text-white/70">3</span>
              </span>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <button id="synthesizeSupremeTokenButton" onclick="synthesizeSupremeToken()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200 shadow-lg
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
              ğŸ”¨ åˆæˆä»¤ç‰Œ
            </button>
            
            <button id="enterSupremeButton" onclick="enterSupremeMode()" 
                    class="px-2 py-0.5 bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 text-white text-xs font-bold rounded 
                           hover:scale-105 transition-transform duration-200 shadow-xl animate-pulse
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:animate-none">
              ğŸ’ è¿›å…¥è‡³å°Šåœº
            </button>
            
            <!-- æç¤º -->
            <div class="hidden sm:block text-amber-300/60 text-xs">
              æ”¶é›†ç¢ç‰‡â†’åˆæˆä»¤ç‰Œâ†’è§£é”è‡³å°Šåœº
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è€è™æœºä¸»ä½“ -->
    <div class="relative flex flex-col" style="min-height: calc(100vh - 64px);">
      
      <!-- ========== ğŸ° åˆçº§åœºå®¹å™¨ ========== -->
      <div id="normalModeContainer" class="hidden flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto pb-[100px] transition-opacity duration-300">
        
        <!-- æ ‡é¢˜ - å“åº”å¼å­—ä½“ -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-yellow-400 mb-3 sm:mb-4 drop-shadow-lg animate-pulse">
          ğŸ° KYX-Slot-Machine
        </h1>
        
        <!-- æ¬¡æ•°æ˜¾ç¤º - å“åº”å¼ï¼ˆä»…åˆçº§åœºæ˜¾ç¤ºï¼‰-->
        <div id="normalModeSpinsDisplay" class="bg-white/10 backdrop-blur-md rounded-lg px-4 sm:px-8 py-2 sm:py-3 mb-4 sm:mb-6">
          <p class="text-white text-center text-sm sm:text-base md:text-lg">
            ä»Šæ—¥å‰©ä½™ï¼š<span id="spinsRemaining" class="text-yellow-400 font-bold text-lg sm:text-xl md:text-2xl">5</span> æ¬¡
            <span class="mx-2 sm:mx-3">|</span>
            å…è´¹æ¬¡æ•°ï¼š<span id="freeSpinsCount" class="text-green-400 font-bold text-lg sm:text-xl md:text-2xl">0</span> æ¬¡
          </p>

          <!-- è´­ä¹°æ¬¡æ•°åŠŸèƒ½åŒº -->
          <div id="buySpinsSection" class="hidden mt-3 p-4 bg-gradient-to-r from-orange-500/20 to-yellow-500/20 rounded-lg border border-orange-400/30">
            <div class="flex flex-col gap-3">
              <!-- é¡¶éƒ¨ä¿¡æ¯ -->
              <div class="flex flex-row items-center justify-between text-white text-sm">
                <span>ğŸ’° å•ä»·ï¼š<span id="buySpinsPrice" class="text-orange-300 font-bold">$40</span>/æ¬¡</span>
                <span class="text-white/70">ä»Šæ—¥å·²è´­ï¼š<span id="buySpinsToday" class="text-orange-300">0</span>/<span id="buySpinsMax" class="text-orange-300">5</span></span>
              </div>
              
              <!-- æ»‘å—åŒºåŸŸ -->
              <div class="flex flex-col gap-2">
                <div class="flex items-center justify-between">
                  <label class="text-white/80 text-sm">è´­ä¹°æ•°é‡</label>
                  <span class="text-orange-300 font-bold text-lg">Ã—<span id="buySpinsCount">1</span></span>
                </div>
                <input type="range" id="buySpinsSlider" min="1" max="5" value="1" step="1"
                       oninput="updateBuySpinsDisplay(this.value)"
                       class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer
                              [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 
                              [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-orange-500
                              [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:shadow-lg
                              [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full 
                              [&::-moz-range-thumb]:bg-orange-500 [&::-moz-range-thumb]:cursor-pointer [&::-moz-range-thumb]:border-0">
              </div>
              
              <!-- è´­ä¹°æŒ‰é’® -->
              <button id="buySpinsButton" onclick="buySpins()"
                      class="w-full px-4 py-2.5 bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600
                             text-white font-bold rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200
                             disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 text-sm">
                ğŸ›’ è´­ä¹° <span id="buySpinsBtnCount">1</span> æ¬¡ (æ€»è®¡ $<span id="buySpinsBtnPrice">40</span>)
              </button>
            </div>
          </div>

          <!-- ç¦æ­¢çŠ¶æ€æç¤º -->
          <div id="bannedNotice" class="hidden mt-3 p-3 bg-red-500/90 rounded-lg border border-red-300">
            <p class="text-white text-sm text-center font-semibold">
              ğŸš« æ‚¨å·²è¢«ç¦æ­¢æŠ½å¥–
              <br>
              <span id="bannedUntilText" class="text-xs">è§£ç¦æ—¶é—´ï¼š--</span>
            </p>
          </div>
        </div>
        
        <!-- ğŸ° åˆçº§åœºä¸“å±ï¼šè€è™æœºæ»šè½® -->
        <div id="slotReelsContainer" class="bg-black/50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 lg:p-10 shadow-2xl mb-4 sm:mb-6 md:mb-8">
          <div id="slotReels" class="flex gap-2 sm:gap-3 md:gap-4 lg:gap-6 justify-center">
            <!-- æ»šè½®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ğŸ° åˆçº§åœºä¸“å±ï¼šç»“æœæ˜¾ç¤º -->
        <div id="slotResult" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 
                                         rounded-lg sm:rounded-xl px-4 sm:px-6 md:px-10 py-3 sm:py-4 md:py-5 mb-4 sm:mb-6 shadow-xl">
          <p id="slotResultText" class="text-white text-base sm:text-xl md:text-2xl lg:text-3xl font-bold text-center drop-shadow-lg"></p>
        </div>

        <!-- ğŸ° åˆçº§åœºä¸“å±ï¼šæ§åˆ¶æŒ‰é’® -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 md:gap-6 w-full sm:w-auto px-4 sm:px-0">
          <button id="spinButton" onclick="spinSlot(false)"
                  class="px-8 sm:px-12 md:px-16 py-3 sm:py-4 md:py-5 bg-gradient-to-r from-green-500 to-emerald-600
                         text-white text-xl sm:text-2xl md:text-3xl font-bold rounded-lg sm:rounded-xl shadow-lg
                         transform hover:scale-105 transition-all duration-200
                         active:scale-95
                         disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:active:scale-100">
            <span>ğŸ° spin</span> <span id="spinButtonPrice">($20)</span>
          </button>
          
          <button id="freeSpinButton" onclick="spinSlot(true)"
                  class="hidden px-8 sm:px-12 md:px-16 py-3 sm:py-4 md:py-5 bg-gradient-to-r from-purple-500 to-pink-600
                         text-white text-xl sm:text-2xl md:text-3xl font-bold rounded-lg sm:rounded-xl shadow-lg
                         transform hover:scale-105 transition-all duration-200
                         active:scale-95
                         disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:active:scale-100">
            âœ¨ free spin
          </button>
        </div>

        <!-- ğŸ”¥ å¤å‘—buffæç¤º -->
        <div id="kunbeiBuffTip" class="hidden mt-3 px-4 py-2 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
          <p class="text-yellow-300 text-sm sm:text-base font-bold text-center">
            ğŸ’° å¤å‘—buffåŠ æˆ Ã—<span id="kunbeiBuffMultiplier">2.5</span>
          </p>
        </div>

        <!-- ğŸ° åˆçº§åœºä¸“å±ï¼šè§„åˆ™è¯´æ˜æŒ‰é’® -->
        <button onclick="showSlotRules()" class="mt-4 sm:mt-6 text-white/70 hover:text-white text-sm sm:text-base transition-colors">
          ğŸ“– æŸ¥çœ‹æ¸¸æˆè§„åˆ™
        </button>
      </div>
      <!-- ========== ğŸ° åˆçº§åœºå®¹å™¨ç»“æŸ ========== -->

      <!-- ========== ğŸ”¥ é«˜çº§åœºå®¹å™¨ ========== -->
      <div id="advancedModeContainer" class="hidden flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto pb-[100px] transition-opacity duration-300">
        
        <!-- æ ‡é¢˜ -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-yellow-400 mb-3 sm:mb-4 drop-shadow-lg animate-pulse">
          ğŸ° KYX-Slot-Machine
        </h1>
        
        <!-- ğŸ”¥ é«˜çº§åœºä¸“å±ï¼šè€è™æœºæ»šè½® -->
        <div id="advancedSlotReelsContainer" class="bg-black/50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 lg:p-10 shadow-2xl mb-4 sm:mb-6 md:mb-8">
          <div id="advancedSlotReels" class="flex gap-2 sm:gap-3 md:gap-4 lg:gap-6 justify-center">
            <!-- æ»šè½®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ğŸ”¥ é«˜çº§åœºä¸“å±ï¼šç»“æœæ˜¾ç¤º -->
        <div id="advancedSlotResult" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 
                                         rounded-lg sm:rounded-xl px-4 sm:px-6 md:px-10 py-3 sm:py-4 md:py-5 mb-4 sm:mb-6 shadow-xl">
          <p id="advancedSlotResultText" class="text-white text-base sm:text-xl md:text-2xl lg:text-3xl font-bold text-center drop-shadow-lg"></p>
        </div>

        <!-- ğŸ”¥ é«˜çº§åœºä¸“å±ï¼šæŠ•æ³¨é€‰æ‹©å™¨å’ŒæŒ‰é’® -->
        <div id="advancedBetSelector" class="mb-6">
          <div class="max-w-xl mx-auto">
            <!-- å¿«æ·é‡‘é¢æŒ‰é’®ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰-->
            <div id="advancedBetOptions" class="flex items-center justify-center gap-2 mb-3">
              <!-- æŒ‰é’®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ»‘å—ï¼ˆç´§å‡‘ç‰ˆï¼‰-->
            <div class="px-4 mb-3">
              <input type="range" id="advancedBetSlider" min="100" max="500" step="10" value="100" 
                     class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
                     oninput="updateAdvancedBetDisplay(this.value)">
            </div>
            
            <!-- ğŸ”¥ é«˜çº§åœºå°ç¦çŠ¶æ€æç¤º -->
            <div id="advancedBannedNotice" class="hidden mb-3 p-3 bg-red-500/90 rounded-lg border border-red-300">
              <p class="text-white text-sm text-center font-semibold">
                ğŸš« æ‚¨å·²è¢«ç¦æ­¢æŠ½å¥–
                <br>
                <span id="advancedBannedUntilText" class="text-xs">è§£ç¦æ—¶é—´ï¼š--</span>
              </p>
            </div>
            
            <!-- æŠ•æ³¨æŒ‰é’® -->
            <button id="advancedSpinButton" onclick="spinSlot(false)"
                    class="w-full px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700
                           text-white text-xl font-bold rounded-lg shadow-lg
                           transform hover:scale-105 transition-all duration-200
                           active:scale-95
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:active:scale-100">
              <span class="flex items-center justify-center gap-2">
                <span>ğŸ°</span>
                <span>æŠ•æ³¨</span>
                <span id="advancedBetDisplay" class="text-yellow-300">$100</span>
              </span>
            </button>

            <!-- ğŸ”¥ å¤å‘—buffæç¤º -->
            <div id="advancedKunbeiBuffTip" class="hidden mt-3 px-4 py-2 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
              <p class="text-yellow-300 text-sm sm:text-base font-bold text-center">
                ğŸ’° å¤å‘—buffåŠ æˆ Ã—<span id="advancedKunbeiBuffMultiplier">2.5</span>
              </p>
            </div>
          </div>
        </div>

        <!-- ğŸ”¥ é«˜çº§åœºä¸“å±ï¼šè§„åˆ™è¯´æ˜æŒ‰é’® -->
        <button onclick="showSlotRules()" class="mt-4 sm:mt-6 text-white/70 hover:text-white text-sm sm:text-base transition-colors">
          ğŸ“– æŸ¥çœ‹æ¸¸æˆè§„åˆ™
        </button>
        
        <!-- ğŸ”¥ é«˜çº§åœºä¸“å±ï¼šæŠ•æ³¨é™é¢è¿›åº¦æ¡ -->
        <div id="advancedDailyBetLimitBar" class="mt-6 max-w-xl mx-auto">
          <div class="bg-white/10 backdrop-blur-md rounded-lg px-6 py-3">
            <div class="flex items-center justify-between mb-2 text-xs sm:text-sm">
              <span class="text-white/80 font-medium">ğŸ”¥ é«˜çº§åœºä»Šæ—¥æŠ•æ³¨é™é¢</span>
              <span id="advancedDailyBetProgress" class="text-white font-bold">$0 / $5,000</span>
            </div>
            <div class="w-full h-2.5 bg-white/10 rounded-full overflow-hidden">
              <div id="advancedDailyBetProgressBar" class="h-full bg-gradient-to-r from-green-500 to-yellow-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="advancedDailyBetWarning" class="hidden text-xs sm:text-sm text-orange-400 mt-2 text-center font-medium">âš ï¸ æ¥è¿‘æŠ•æ³¨é™é¢</p>
          </div>
        </div>
      </div>
      <!-- ========== ğŸ”¥ é«˜çº§åœºå®¹å™¨ç»“æŸ ========== -->

      <!-- ========== ğŸ’ è‡³å°Šåœºå®¹å™¨ ========== -->
      <div id="supremeModeContainer" class="hidden flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto pb-[100px] transition-opacity duration-300">
        
        <!-- æ ‡é¢˜ -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-yellow-400 mb-3 sm:mb-4 drop-shadow-lg animate-pulse">
          ğŸ° KYX-Slot-Machine
        </h1>
        
        <!-- ğŸ’ è‡³å°Šåœºä¸“å±ï¼šè€è™æœºæ»šè½® -->
        <div id="supremeSlotReelsContainer" class="bg-black/50 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 lg:p-10 shadow-2xl mb-4 sm:mb-6 md:mb-8">
          <div id="supremeSlotReels" class="flex gap-2 sm:gap-3 md:gap-4 lg:gap-6 justify-center">
            <!-- æ»šè½®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ğŸ’ è‡³å°Šåœºä¸“å±ï¼šç»“æœæ˜¾ç¤º -->
        <div id="supremeSlotResult" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 
                                         rounded-lg sm:rounded-xl px-4 sm:px-6 md:px-10 py-3 sm:py-4 md:py-5 mb-4 sm:mb-6 shadow-xl">
          <p id="supremeSlotResultText" class="text-white text-base sm:text-xl md:text-2xl lg:text-3xl font-bold text-center drop-shadow-lg"></p>
        </div>

        <!-- ğŸ’ è‡³å°Šåœºä¸“å±ï¼šæŠ•æ³¨æŒ‰é’®å’ŒçŠ¶æ€ -->
        <div id="supremeBetSelector" class="mb-6">
          <div class="max-w-xl mx-auto">
            <!-- å¿«æ·é‡‘é¢æŒ‰é’®ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰-->
            <div id="supremeBetOptions" class="flex items-center justify-center gap-2 mb-3">
              <!-- æŒ‰é’®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ»‘å—ï¼ˆç´§å‡‘ç‰ˆï¼‰-->
            <div class="px-4 mb-3">
              <input type="range" id="supremeBetSlider" min="1000" max="10000" step="100" value="1000" 
                     class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
                     oninput="updateSupremeBetDisplay(this.value)">
            </div>
            
            <!-- è‡³å°Šåœºå°ç¦çŠ¶æ€æç¤º -->
            <div id="supremeBannedNotice" class="hidden mb-3 p-3 bg-red-500/90 rounded-lg border border-red-300">
              <p class="text-white text-sm text-center font-semibold">
                ğŸš« æ‚¨å·²è¢«ç¦æ­¢è¿›å…¥è‡³å°Šåœº
                <br>
                <span id="supremeBannedUntilText" class="text-xs">è§£ç¦æ—¶é—´ï¼š--</span>
              </p>
            </div>
            
            <!-- æŠ•æ³¨æŒ‰é’® -->
            <button id="supremeSpinButton" onclick="spinSupremeSlot()"
                    class="w-full px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700
                           text-white text-xl font-bold rounded-lg shadow-lg
                           transform hover:scale-105 transition-all duration-200
                           active:scale-95
                           disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:active:scale-100">
              <span class="flex items-center justify-center gap-2">
                <span>ğŸ°</span>
                <span>æŠ•æ³¨</span>
                <span id="supremeBetDisplay" class="text-yellow-300">$1000</span>
              </span>
            </button>

            <!-- ğŸ”¥ å¤å‘—buffæç¤º -->
            <div id="supremeKunbeiBuffTip" class="hidden mt-3 px-4 py-2 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
              <p class="text-yellow-300 text-sm sm:text-base font-bold text-center">
                ğŸ’° å¤å‘—buffåŠ æˆ Ã—<span id="supremeKunbeiBuffMultiplier">2.5</span>
              </p>
            </div>
          </div>
        </div>

        <!-- ğŸ’ è‡³å°Šåœºä¸“å±ï¼šè§„åˆ™è¯´æ˜æŒ‰é’® -->
        <button id="supremeRulesButton" onclick="showSupremeRules()" class="mt-4 sm:mt-6 text-amber-300/90 hover:text-amber-200 text-sm sm:text-base transition-colors font-bold">
          ğŸ’ è‡³å°Šåœºè§„åˆ™
        </button>
        
        <!-- ğŸ’ è‡³å°Šåœºä¸“å±ï¼šæŠ•æ³¨é™é¢è¿›åº¦æ¡ -->
        <div id="supremeDailyBetLimitBar" class="mt-6 max-w-xl mx-auto">
          <div class="bg-white/10 backdrop-blur-md rounded-lg px-6 py-3">
            <div class="flex items-center justify-between mb-2 text-xs sm:text-sm">
              <span class="text-white/80 font-medium">ğŸ’ è‡³å°Šåœºä»Šæ—¥æŠ•æ³¨é™é¢</span>
              <span id="supremeDailyBetProgress" class="text-white font-bold">$0 / $50,000</span>
            </div>
            <div class="w-full h-2.5 bg-white/10 rounded-full overflow-hidden">
              <div id="supremeDailyBetProgressBar" class="h-full bg-gradient-to-r from-green-500 to-yellow-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="supremeDailyBetWarning" class="hidden text-xs sm:text-sm text-orange-400 mt-2 text-center font-medium">âš ï¸ æ¥è¿‘æŠ•æ³¨é™é¢</p>
          </div>
        </div>
      </div>
      <!-- ========== ğŸ’ è‡³å°Šåœºå®¹å™¨ç»“æŸ ========== -->

      <!-- å·¦ä¾§ï¼šäºæŸæ¦œï¼ˆæ‚¬æµ®æ˜¾ç¤ºï¼‰- ç§»åŠ¨ç«¯éšè— -->
      <div id="slotSidebarProfitBoard" class="absolute top-4 left-4 w-[360px] max-h-[calc(100vh-200px)] bg-gradient-to-b from-red-950/90 to-rose-950/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-red-500/30 overflow-hidden flex flex-col">
        <div class="p-4 bg-gradient-to-r from-red-600/30 to-rose-600/30 border-b border-red-500/30">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-red-400 flex items-center gap-2">
              <span>ğŸ“‰</span>
              <span>äºæŸæ¦œ TOP 20</span>
            </h2>
            <div class="flex gap-1">
              <button onclick="loadSidebarLeaderboard(true)" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="åˆ·æ–°">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
              <button onclick="toggleLossBoard()" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="æ”¶èµ·/å±•å¼€">
                <svg id="lossBoardToggleIcon" class="w-4 h-4 text-white transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
          </div>
          <!-- æ¦œå•ç±»å‹é€‰æ‹© -->
          <div class="mb-2 relative">
            <select 
              id="lossBoardRangeSelect" 
              onchange="switchSidebarLeaderboardRange(this.value)"
              class="w-full px-3 py-2 text-sm font-bold rounded-lg bg-red-900/60 text-white border-2 border-red-500/60 hover:bg-red-900/80 hover:border-red-400 focus:outline-none focus:ring-2 focus:ring-red-300 focus:border-red-300 shadow-lg shadow-red-900/30 transition-all duration-200 cursor-pointer appearance-none backdrop-blur-sm"
              style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23fca5a5%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.2em; padding-right: 2rem;">
              <option value="daily" style="background-color: #7f1d1d; color: #fecaca; padding: 0.5rem;">ğŸ“… æ—¥æ¦œï¼ˆä»Šæ—¥æ•°æ®ï¼‰</option>
              <option value="weekly" style="background-color: #7f1d1d; color: #fecaca; padding: 0.5rem;">ğŸ“Š å‘¨æ¦œï¼ˆæœ¬å‘¨æ•°æ®ï¼‰</option>
              <option value="total" style="background-color: #7f1d1d; color: #fecaca; padding: 0.5rem;">ğŸ† æ€»æ¦œï¼ˆå†å²ç´¯è®¡ï¼‰</option>
            </select>
          </div>
          <p class="text-xs text-white/70 text-center">æœ€äºæŸç”¨æˆ·top20</p>
          <p id="profitBoardLastUpdate" class="text-xs text-white/50 text-center mt-1">--</p>
        </div>
        
        <!-- ç”¨æˆ·è‡ªå·±çš„ç›ˆäºï¼ˆå›ºå®šåœ¨ä¸Šæ–¹ï¼‰-->
        <div id="lossBoardContent" class="transition-all duration-300">
          <div class="px-4 py-3 bg-gradient-to-r from-red-600/20 to-rose-600/20 border-b border-red-500/20">
            <div class="text-white text-sm space-y-1">
              <div class="flex justify-between items-center">
                <span class="opacity-90">æˆ‘çš„äºæŸæ’åï¼š</span>
                <span id="profitBoardMyRank" class="font-bold text-yellow-300">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="opacity-90">æˆ‘çš„ç›ˆäºï¼š</span>
                <span id="profitBoardMyProfit" class="font-bold">$0</span>
              </div>
            </div>
          </div>

          <!-- ç›ˆäºæ¦œåˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰-->
          <div id="profitBoardList" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent" style="max-height: calc(100vh - 380px);">
            <div class="text-center text-white/50 py-8">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šç›ˆåˆ©æ¦œï¼ˆæ‚¬æµ®æ˜¾ç¤ºï¼‰- ç§»åŠ¨ç«¯éšè— -->
      <div id="slotSidebarLeaderboard" class="absolute top-4 right-4 w-[360px] max-h-[calc(100vh-200px)] bg-gradient-to-b from-emerald-900/90 to-green-900/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-green-500/30 overflow-hidden flex flex-col transition-all duration-300">
        <div class="p-4 bg-gradient-to-r from-green-600/30 to-emerald-600/30 border-b border-green-500/30">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-green-400 flex items-center gap-2">
              <span>ğŸ†</span>
              <span>ç›ˆåˆ©æ¦œ TOP 20</span>
            </h2>
            <div class="flex gap-1">
              <button onclick="loadSidebarLeaderboard(true)" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="åˆ·æ–°æ’è¡Œæ¦œ">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
              <button onclick="toggleProfitBoard()" class="p-1.5 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="æ”¶èµ·/å±•å¼€">
                <svg id="profitBoardToggleIcon" class="w-4 h-4 text-white transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
          </div>
          <!-- æ¦œå•ç±»å‹é€‰æ‹© -->
          <div class="mb-2 relative">
            <select 
              id="sidebarLeaderboardRangeSelect" 
              onchange="switchSidebarLeaderboardRange(this.value)"
              class="w-full px-3 py-2 text-sm font-bold rounded-lg bg-green-800/60 text-white border-2 border-green-500/60 hover:bg-green-800/80 hover:border-green-400 focus:outline-none focus:ring-2 focus:ring-green-300 focus:border-green-300 shadow-lg shadow-green-900/30 transition-all duration-200 cursor-pointer appearance-none backdrop-blur-sm"
              style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23a7f3d0%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.2em; padding-right: 2rem;">
              <option value="daily" style="background-color: #065f46; color: #d1fae5; padding: 0.5rem;">ğŸ“… æ—¥æ¦œï¼ˆä»Šæ—¥æ•°æ®ï¼‰</option>
              <option value="weekly" style="background-color: #065f46; color: #d1fae5; padding: 0.5rem;">ğŸ“Š å‘¨æ¦œï¼ˆæœ¬å‘¨æ•°æ®ï¼‰</option>
              <option value="total" style="background-color: #065f46; color: #d1fae5; padding: 0.5rem;">ğŸ† æ€»æ¦œï¼ˆå†å²ç´¯è®¡ï¼‰</option>
            </select>
          </div>
          <p class="text-xs text-white/70 text-center">æŒ‰æ€»ç›ˆäºæ’åï¼ˆæ€»èµ¢å¾— - æ€»æŠ•æ³¨ï¼‰</p>
          <p id="leaderboardLastUpdate" class="text-xs text-white/50 text-center mt-1">--</p>
        </div>
        
        <!-- ç”¨æˆ·è‡ªå·±çš„ç»Ÿè®¡ï¼ˆå›ºå®šåœ¨ä¸Šæ–¹ï¼‰-->
        <div id="profitBoardContent" class="transition-all duration-300">
          <div id="myLeaderboardStats" class="px-4 py-3 bg-gradient-to-r from-green-600/20 to-emerald-600/20 border-b border-green-500/20">
            <div class="text-white text-sm space-y-1">
              <div class="flex justify-between items-center">
                <span class="opacity-90">æˆ‘çš„ç›ˆåˆ©æ’åï¼š</span>
                <span id="sidebarMyRank" class="font-bold text-yellow-300">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="opacity-90">æˆ‘çš„ç›ˆäºï¼š</span>
                <span id="sidebarMyProfit" class="font-bold">$0</span>
              </div>
            </div>
          </div>

          <!-- æ’è¡Œæ¦œåˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰-->
          <div id="sidebarLeaderboard" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent" style="max-height: calc(100vh - 380px);">
            <div class="text-center text-white/50 py-8">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- ğŸµ èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’®ï¼ˆå·¦ä¸‹è§’ï¼‰-->
    <button 
      id="bgMusicToggleBtn" 
      onclick="toggleBgMusic()"
      class="fixed bottom-4 left-6 w-16 h-16 bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 rounded-2xl shadow-2xl hover:scale-110 transition-all duration-300 flex flex-col items-center justify-center z-40"
      title="èƒŒæ™¯éŸ³ä¹">
      <div id="bgMusicIcon" class="text-3xl mb-1">ğŸµ</div>
      <div class="text-xs font-bold text-white">éŸ³ä¹</div>
    </button>

    <!-- ğŸµ èƒŒæ™¯éŸ³ä¹audioå…ƒç´  -->
    <audio id="bgMusicPlayer" preload="auto">
      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>

    <!-- ğŸ” å¤å‘—æ‚¬æµ®æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰-->
    <button 
      id="kunbeiFloatingButton" 
      onclick="openKunbeiModal()"
      class="fixed bottom-4 right-6 w-16 h-16 bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 rounded-2xl shadow-2xl hover:scale-110 transition-all duration-300 flex flex-col items-center justify-center z-40 animate-pulse"
      title="å¤å‘—å€Ÿæ¬¾">
      <div class="text-3xl mb-1">ğŸ”</div>
      <div class="text-xs font-bold text-white">å¤å‘—</div>
    </button>

    <!-- åº•éƒ¨ç»Ÿè®¡ï¼ˆå›ºå®šåº•éƒ¨ï¼‰- å“åº”å¼ -->
    <div class="bg-black/30 backdrop-blur-md p-2 sm:p-3 md:p-4 text-center text-white border-t border-white/10">
      <!-- ä»Šæ—¥ç»Ÿè®¡ -->
      <div class="mb-1 sm:mb-2">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">ğŸ“… ä»Šæ—¥æ•°æ®</p>
        <p class="text-xs sm:text-sm md:text-base">
          å·²ç© <span id="todayPlayed" class="font-bold text-yellow-400">0</span> æ¬¡ 
          <span class="mx-1 sm:mx-2 text-white/40">|</span> 
          æŠ•æ³¨ <span id="todayBet" class="font-bold text-red-400">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          èµ¢å¾— <span id="todayWon" class="font-bold text-green-400">$0</span>
        </p>
      </div>
      <!-- å†å²æ€»è®¡ -->
      <div class="pt-1 sm:pt-2 border-t border-white/20">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">ğŸ“Š å†å²æ€»è®¡</p>
        <p class="text-xs sm:text-sm md:text-base">
          æ€»æ¬¡æ•° <span id="totalPlayed" class="font-bold text-yellow-300">0</span> æ¬¡
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          æ€»æŠ•æ³¨ <span id="totalBet" class="font-bold text-red-300">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          æ€»è·å¾— <span id="totalWon" class="font-bold text-green-300">$0</span>
        </p>
      </div>
      <!-- å½“å‰ä½™é¢å’Œå¾…å‘æ”¾ -->
      <div class="pt-1 sm:pt-2 border-t border-white/20">
        <p class="text-xs text-white/60 mb-0.5 sm:mb-1">ğŸ’° è´¦æˆ·ä¿¡æ¯</p>
        <p class="text-xs sm:text-sm md:text-base">
          å½“å‰ä½™é¢ <span id="currentBalance" class="font-bold text-blue-300">$0</span>
          <span class="mx-1 sm:mx-2 text-white/40">|</span>
          å¾…å‘æ”¾ <span id="pendingRewardsCount" class="font-bold text-orange-300">0</span> æ¡ (<span id="pendingRewardsAmount" class="font-bold text-orange-300">$0</span>)
          <button onclick="showPendingRewardsModal()" class="ml-2 px-2 py-0.5 bg-orange-500/30 hover:bg-orange-500/50 rounded text-xs transition-colors">
            æŸ¥çœ‹è¯¦æƒ…
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- ğŸ” å¤å‘—å€Ÿæ¬¾æ¨¡æ€æ¡† -->
  <div id="kunbeiModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
      <!-- å¤´éƒ¨ -->
      <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 px-6 py-4 relative">
        <button onclick="closeKunbeiModal()" class="absolute top-4 right-4 text-white/80 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="text-center">
          <div class="text-5xl mb-2">ğŸ”</div>
          <h3 class="text-2xl font-bold text-white">å¤å‘—ä¿¡ç”¨ä¸­å¿ƒ</h3>
          <p class="text-sm text-white/90 mt-1">æ€¥ç”¨é’±ï¼Ÿå¤å‘—æ‡‚ä½ ã€‚</p>
        </div>
      </div>
      
      <!-- é¢åº¦æ˜¾ç¤º -->
      <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50">
        <div class="flex items-center justify-between text-sm">
          <div>
            <span class="text-slate-600">å¯ç”¨</span>
            <span id="kunbeiAvailable" class="font-bold text-green-600 ml-1">$0</span>
          </div>
          <div>
            <span class="text-slate-600">å·²å ç”¨</span>
            <span id="kunbeiUsed" class="font-bold text-red-600 ml-1">$0</span>
          </div>
          <div>
            <span class="text-slate-600">æˆä¿¡</span>
            <span id="kunbeiCredit" class="font-bold text-blue-600 ml-1">$100</span>
          </div>
        </div>
        <div class="mt-2">
          <div class="h-2 bg-white/50 rounded-full overflow-hidden">
            <div id="kunbeiUsageBar" class="h-full bg-gradient-to-r from-yellow-500 to-red-500 transition-all" style="width: 0%"></div>
          </div>
          <p class="text-xs text-slate-500 text-right mt-1">
            <span id="kunbeiUsagePercent">0%</span>
          </p>
        </div>
      </div>
      
      <!-- Tabåˆ‡æ¢ -->
      <div class="px-6 pt-4">
        <div class="flex border-b border-slate-200">
          <button id="kunbeiTabBorrow" onclick="switchKunbeiTab('borrow')" class="flex-1 pb-3 text-sm font-semibold border-b-2 border-orange-500 text-orange-600">
            â–£ å€Ÿæ¬¾
          </button>
          <button id="kunbeiTabRepay" onclick="switchKunbeiTab('repay')" class="flex-1 pb-3 text-sm font-semibold border-b-2 border-transparent text-slate-400">
            â–¢ è¿˜æ¬¾
          </button>
          <button id="kunbeiTabRecords" onclick="switchKunbeiTab('records')" class="flex-1 pb-3 text-sm font-semibold border-b-2 border-transparent text-slate-400">
            â–¢ è®°å½•
          </button>
        </div>
      </div>
      
      <!-- å€Ÿæ¬¾é¢æ¿ -->
      <div id="kunbeiBorrowPanel" class="px-6 py-4">
        <!-- å¿«æ·é‡‘é¢ -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">é‡‘é¢</label>
          <div class="flex gap-2 mb-3">
            <button onclick="adjustKunbeiAmount(-500)" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-semibold">-$1</button>
            <button onclick="setKunbeiAmount(25000000)" class="flex-1 px-3 py-2 bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 rounded-lg text-sm font-semibold">$50</button>
            <button onclick="setKunbeiAmount(50000000)" class="flex-1 px-3 py-2 bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 rounded-lg text-sm font-semibold">$100</button>
            <button onclick="setKunbeiAmount('max')" class="flex-1 px-3 py-2 bg-gradient-to-r from-yellow-100 to-orange-100 hover:from-yellow-200 hover:to-orange-200 rounded-lg text-sm font-semibold">å€Ÿæ»¡</button>
            <button onclick="adjustKunbeiAmount(500)" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-semibold">+$1</button>
          </div>
          
          <!-- æ»‘å— -->
          <input 
            type="range" 
            id="kunbeiAmountSlider" 
            min="10" 
            max="100" 
            value="50" 
            step="10"
            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
            oninput="updateKunbeiSlider(this.value)"
          >
          <div class="flex justify-between text-xs text-slate-500 mt-1">
            <span>$10</span>
            <span id="kunbeiSliderValue" class="font-bold text-orange-600">$50</span>
            <span>$100</span>
          </div>
        </div>
        
        <!-- é¢„è§ˆ -->
        <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-xl p-4 mb-4">
          <div class="text-sm space-y-2">
            <div class="flex justify-between">
              <span class="text-slate-700">è¿˜æ¬¾é‡‘é¢:</span>
              <span id="kunbeiPreviewRepay" class="font-bold text-red-600">$125.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-700">åˆ°æœŸæ—¶é—´:</span>
              <span id="kunbeiPreviewDue" class="text-sm text-slate-600">72å°æ—¶å</span>
            </div>
            <div class="flex justify-between text-green-600">
              <span>âœ¨ è¿”ç°:</span>
              <span id="kunbeiPreviewCashback" class="font-bold">$3.13</span>
            </div>
          </div>
        </div>
        
        <!-- è­¦å‘Š -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
          <p class="text-xs text-red-800">
            âš ï¸ <strong>é€¾æœŸåæœï¼š</strong>ç¦æ­¢é«˜çº§åœº60å°æ—¶ã€ä¿¡ç”¨åˆ†-10
          </p>
        </div>
        
        <!-- æŒ‰é’® -->
        <button 
          id="kunbeiConfirmBorrowBtn"
          onclick="confirmKunbeiBorrow()" 
          class="w-full py-3 bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 text-white rounded-xl font-bold text-lg hover:shadow-xl transition-all">
          ğŸ” ç¡®è®¤å€Ÿæ¬¾
        </button>
      </div>
      
      <!-- è¿˜æ¬¾é¢æ¿ -->
      <div id="kunbeiRepayPanel" class="hidden px-6 py-4">
        <div id="kunbeiActiveLoanInfo">
          <!-- æœ‰å€Ÿæ¬¾æ—¶æ˜¾ç¤º -->
          <div id="kunbeiHasLoan" class="hidden">
            <div class="bg-amber-50 border border-amber-300 rounded-xl p-4 mb-4">
              <div class="text-sm space-y-2">
                <div class="flex justify-between">
                  <span class="text-slate-700">å€Ÿæ¬¾é‡‘é¢:</span>
                  <span id="activeLoanAmount" class="font-bold">$0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-700">åº”è¿˜é‡‘é¢:</span>
                  <span id="activeRepayAmount" class="font-bold text-red-600">$0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-700">å‰©ä½™æ—¶é—´:</span>
                  <span id="activeRemaining" class="font-bold text-orange-600">--</span>
                </div>
                <div class="flex justify-between text-green-600" id="kunbeiEarlyRepayInfo">
                  <span>âœ¨ æå‰è¿˜æ¬¾:</span>
                  <span id="activeEarlyRepay" class="font-bold">$0</span>
                </div>
              </div>
            </div>
            
            <button 
              onclick="confirmKunbeiRepay()" 
              class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold text-lg hover:shadow-xl transition-all">
              ğŸ’° ç«‹å³è¿˜æ¬¾
            </button>
          </div>
          
          <!-- æ— å€Ÿæ¬¾æ—¶æ˜¾ç¤º -->
          <div id="kunbeiNoLoan" class="hidden">
            <div class="text-center py-8 text-slate-500">
              <div class="text-4xl mb-2">âœ…</div>
              <p>æ‚¨å½“å‰æ²¡æœ‰å€Ÿæ¬¾</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- è®°å½•é¢æ¿ -->
      <div id="kunbeiRecordsPanel" class="hidden px-6 py-4 max-h-96 overflow-y-auto">
        <div id="kunbeiRecordsList">
          <!-- åŠ è½½ä¸­ -->
          <div class="text-center py-8 text-slate-500">
            <div class="spinner mx-auto mb-2"></div>
            <p class="text-sm">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
      
      <!-- åº•éƒ¨é“¾æ¥ -->
      <div class="px-6 py-3 bg-slate-50 border-t border-slate-200 text-center">
        <p class="text-xs text-slate-500">
          ä¿¡ç”¨åˆ†: <span id="kunbeiCreditScore" class="font-bold text-purple-600">100</span> åˆ†
          <span class="mx-2">|</span>
          <button onclick="showKunbeiRules()" class="text-indigo-600 hover:text-indigo-700 font-medium">
            ğŸ“– ä½¿ç”¨è§„åˆ™
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- å¤å‘—ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="kunbeiConfirmDialog" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[80] p-4" onclick="if(event.target === this) kunbeiConfirmResolve(false)">
    <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl transform transition-all">
      <div class="p-6">
        <!-- å›¾æ ‡ -->
        <div class="text-center mb-4">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl">
            <span class="text-3xl">ğŸ”</span>
          </div>
        </div>
        
        <!-- æ ‡é¢˜ -->
        <h3 id="kunbeiConfirmTitle" class="text-xl font-bold text-center mb-4 text-slate-800">ç¡®è®¤æ“ä½œ</h3>
        
        <!-- å†…å®¹ -->
        <div id="kunbeiConfirmContent" class="text-center mb-6 text-slate-600 space-y-2">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
        
        <!-- æŒ‰é’® -->
        <div class="flex gap-3">
          <button onclick="kunbeiConfirmResolve(false)" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-medium transition-colors">
            å–æ¶ˆ
          </button>
          <button onclick="kunbeiConfirmResolve(true)" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-xl font-bold transition-all transform hover:scale-105">
            ç¡®è®¤
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å¤å‘—è§„åˆ™å¼¹çª— -->
  <div id="kunbeiRulesModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[75] p-4" onclick="if(event.target === this) document.getElementById('kunbeiRulesModal').classList.add('hidden')">
    <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl">
      <!-- æ ‡é¢˜ -->
      <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 px-6 py-4 relative">
        <button onclick="document.getElementById('kunbeiRulesModal').classList.add('hidden')" class="absolute top-4 right-4 text-white/80 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div class="text-center">
          <div class="text-4xl mb-2">ğŸ”</div>
          <h3 class="text-xl font-bold text-white">å¤å‘—ä½¿ç”¨è§„åˆ™</h3>
        </div>
      </div>
      
      <!-- å†…å®¹ -->
      <div class="p-6 overflow-y-auto max-h-[60vh] space-y-6">
        <!-- å€Ÿæ¬¾è§„åˆ™ -->
        <div class="bg-blue-50 rounded-xl p-4">
          <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
            <span class="text-xl">ğŸ’°</span> å€Ÿæ¬¾è§„åˆ™
          </h4>
          <ul class="space-y-2 text-sm text-slate-700">
            <li class="flex items-start gap-2">
              <span class="text-blue-500">â€¢</span>
              <span>æ‚¨çš„æœ€å¤§å¯å€Ÿé¢åº¦: <span id="rulesUserMaxLoan" class="font-semibold text-blue-600">-</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-blue-500">â€¢</span>
              <span>è¿˜æ¬¾å€æ•°: <span id="rulesRepayMultiplier" class="font-semibold text-orange-600">-</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-blue-500">â€¢</span>
              <span>å€Ÿæ¬¾æœŸé™: <span id="rulesLoanDuration" class="font-semibold">-</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-blue-500">â€¢</span>
              <span class="font-semibold text-purple-600">æ¯æ—¥é¦–æ¬¡å€Ÿæ¬¾è·å¾—æŠ½å¥–å€ç‡ Ã—2.5 ğŸ°</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-blue-500">â€¢</span>
              <span class="text-xs text-slate-500">ğŸ’¡ æœ€å¤§å¯å€Ÿé¢åº¦æ ¹æ®æ‚¨çš„ä½™é¢åŠ¨æ€è°ƒæ•´</span>
            </li>
          </ul>
        </div>
        
        <!-- è¿˜æ¬¾ä¼˜æƒ  -->
        <div class="bg-green-50 rounded-xl p-4">
          <h4 class="font-bold text-green-800 mb-3 flex items-center gap-2">
            <span class="text-xl">âœ¨</span> è¿˜æ¬¾ä¼˜æƒ 
          </h4>
          <ul class="space-y-2 text-sm text-slate-700">
            <li class="flex items-start gap-2">
              <span class="text-green-500">â€¢</span>
              <span>æå‰è¿˜æ¬¾: å…é™¤<span id="rulesEarlyDiscount" class="font-semibold text-green-600">-</span>ï¼ˆè¿”ç°ï¼‰</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">â€¢</span>
              <span>æŒ‰æ—¶è¿˜æ¬¾: ä¿¡ç”¨åˆ†<span class="font-semibold text-green-600">+5</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">â€¢</span>
              <span>æå‰è¿˜æ¬¾: ä¿¡ç”¨åˆ†<span class="font-semibold text-green-600">+10</span></span>
            </li>
          </ul>
        </div>
        
        <!-- é€¾æœŸåæœ -->
        <div class="bg-red-50 rounded-xl p-4">
          <h4 class="font-bold text-red-800 mb-3 flex items-center gap-2">
            <span class="text-xl">âš ï¸</span> é€¾æœŸåæœ
          </h4>
          <ul class="space-y-2 text-sm text-slate-700">
            <li class="flex items-start gap-2">
              <span class="text-red-500">â€¢</span>
              <span>ç¦æ­¢è¿›å…¥é«˜çº§åœº<span id="rulesPenaltyHours" class="font-semibold text-red-600">-</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-red-500">â€¢</span>
              <span>ä¿¡ç”¨åˆ†<span class="font-semibold text-red-600">-10</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-red-500">â€¢</span>
              <span>éœ€å…¨é¢è¿˜æ¬¾ï¼ˆæ— ä¼˜æƒ ï¼‰</span>
            </li>
          </ul>
        </div>
        
        <!-- ä¿¡ç”¨åˆ† -->
        <div class="bg-purple-50 rounded-xl p-4">
          <h4 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
            <span class="text-xl">â­</span> ä¿¡ç”¨åˆ†
          </h4>
          <ul class="space-y-2 text-sm text-slate-700">
            <li class="flex items-start gap-2">
              <span class="text-purple-500">â€¢</span>
              <span>åˆå§‹: <span class="font-semibold text-purple-600">100åˆ†</span></span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-purple-500">â€¢</span>
              <span>ä½äº<span class="font-semibold text-red-600">60åˆ†</span>å°†ç¦ç”¨å¤å‘—åŠŸèƒ½</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-purple-500">â€¢</span>
              <span>æŒ‰æ—¶è¿˜æ¬¾å¯æå‡ä¿¡ç”¨åˆ†</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- å¾…å‘æ”¾å¥–é‡‘å¼¹çª— -->
  <div id="pendingRewardsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
      <!-- æ ‡é¢˜æ  -->
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-orange-600 to-amber-600">
        <div>
          <h2 class="text-2xl font-bold text-white">ğŸ’° å¾…å‘æ”¾å¥–é‡‘è®°å½•</h2>
          <p class="text-sm text-white/90 mt-1">æŸ¥çœ‹æ‚¨çš„å¥–é‡‘å‘æ”¾çŠ¶æ€</p>
        </div>
        <button onclick="closePendingRewards()" class="text-white hover:text-yellow-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="p-6 bg-gradient-to-r from-orange-50 to-amber-50 border-b border-slate-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">å½“å‰ä½™é¢</p>
            <p id="modalCurrentBalance" class="text-2xl font-bold text-blue-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">å¾…å‘æ”¾æ€»æ•°</p>
            <p id="modalPendingCount" class="text-2xl font-bold text-orange-600">0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">å¾…å‘æ”¾é‡‘é¢</p>
            <p id="modalPendingAmount" class="text-2xl font-bold text-green-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">å·²å‘æ”¾é‡‘é¢</p>
            <p id="modalSuccessAmount" class="text-2xl font-bold text-purple-600">$0</p>
          </div>
        </div>
      </div>

      <!-- è¯´æ˜ -->
      <div class="px-6 py-3 bg-blue-50 border-b border-blue-200">
        <div class="flex items-start gap-2 text-sm text-blue-800">
          <span>â„¹ï¸</span>
          <div>
            <p><strong>è¯´æ˜ï¼š</strong>å¥–é‡‘å‘æ”¾å¤±è´¥æ—¶ä¼šè®°å½•åˆ°å¾…å‘æ”¾åˆ—è¡¨ï¼Œç³»ç»Ÿæ¯60ç§’è‡ªåŠ¨é‡è¯•ä¸€æ¬¡ã€‚</p>
            <p class="mt-1">â€¢ <strong>å¾…å¤„ç†</strong>ï¼šç³»ç»Ÿæ­£åœ¨è‡ªåŠ¨å¤„ç†ä¸­</p>
            <p>â€¢ <strong>å¤„ç†ä¸­</strong>ï¼šå½“å‰æ­£åœ¨å‘æ”¾</p>
            <p>â€¢ <strong>æˆåŠŸ</strong>ï¼šå·²æˆåŠŸå‘æ”¾åˆ°æ‚¨çš„è´¦æˆ·</p>
            <p>â€¢ <strong>å¤±è´¥</strong>ï¼šå¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</p>
          </div>
        </div>
      </div>

      <!-- è®°å½•åˆ—è¡¨ -->
      <div class="p-6 overflow-y-auto flex-1">
        <div id="pendingRewardsList">
          <div class="text-center text-slate-500 py-8">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
        <button onclick="refreshPendingRewards()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          åˆ·æ–°
        </button>
        <button onclick="closePendingRewards()" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors">
          å…³é—­
        </button>
      </div>
    </div>
  </div>

  <!-- è€è™æœºè®°å½•å¼¹çª— -->
  <div id="slotRecordsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
      <!-- æ ‡é¢˜æ  -->
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-purple-600 to-indigo-600">
        <h2 id="slotRecordsTitle" class="text-2xl font-bold text-white">ğŸ° æˆ‘çš„æŠ½å¥–è®°å½•</h2>
        <button onclick="closeSlotRecords()" class="text-white hover:text-yellow-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- æœç´¢ç­›é€‰æ å·²ç§»é™¤ï¼Œä½¿ç”¨æç®€æ¨¡å¼ -->
      
      <!-- è®°å½•å†…å®¹ -->
      <div class="overflow-y-auto flex-1">
        <!-- å¾…å‘æ”¾è®°å½•åŒºåŸŸ -->
        <div id="pendingRewardsSection" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 border-b-2 border-orange-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-orange-700 flex items-center gap-2">
              <span>â³</span>
              <span>å¾…å‘æ”¾å¥–é‡‘</span>
            </h3>
            <button onclick="refreshPendingRewards()" class="text-sm text-orange-600 hover:text-orange-700 font-medium flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              åˆ·æ–°
            </button>
          </div>
          <div id="pendingRewardsContent">
            <!-- å¾…å‘æ”¾è®°å½•å°†é€šè¿‡ JavaScript åŠ è½½ -->
          </div>
        </div>
        
        <!-- æŠ½å¥–è®°å½• -->
        <div id="slotRecordsContent" class="p-6">
          <!-- è®°å½•å°†é€šè¿‡ JavaScript åŠ è½½ -->
        </div>
      </div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œå¼¹çª— -->
  <div id="leaderboardModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
      <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-emerald-500 to-green-600">
        <div>
          <h2 class="text-2xl font-bold text-white">ğŸ† æ’è¡Œæ¦œ</h2>
          <p class="text-sm text-white/90 mt-1">æŸ¥çœ‹ç›ˆåˆ©æ¦œå’ŒäºæŸæ¦œï¼ˆæ€»èµ¢å¾— - æ€»æŠ•æ³¨ï¼‰</p>
        </div>
        <button onclick="closeLeaderboard()" class="text-white hover:text-gray-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- æ—¶é—´èŒƒå›´åˆ‡æ¢ - ä¸‹æ‹‰æ¡† -->
      <div class="flex items-center gap-3 p-4 bg-gradient-to-r from-indigo-600 to-blue-600 border-b border-indigo-700">
        <label for="leaderboardRangeSelect" class="text-sm font-bold text-white whitespace-nowrap flex items-center gap-1">
          <span class="text-lg">ğŸ“Š</span>
          <span>æ¦œå•ç±»å‹</span>
        </label>
        <div class="flex-1 relative">
          <select 
            id="leaderboardRangeSelect" 
            onchange="switchLeaderboardRange(this.value)"
            class="w-full pl-4 pr-10 py-3 text-sm font-bold rounded-xl border-2 border-indigo-400/60 bg-indigo-800/50 text-white shadow-md hover:shadow-lg hover:bg-indigo-800/70 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300 transition-all duration-200 cursor-pointer appearance-none backdrop-blur-sm"
            style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23c7d2fe%27 stroke-width=%272.5%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.3em;">
            <option value="daily" style="background-color: #3730a3; color: #e0e7ff; padding: 0.75rem; font-weight: bold;">ğŸ“… æ—¥æ¦œï¼ˆä»Šæ—¥æ•°æ®ï¼‰</option>
            <option value="weekly" style="background-color: #3730a3; color: #e0e7ff; padding: 0.75rem; font-weight: bold;">ğŸ“Š å‘¨æ¦œï¼ˆæœ¬å‘¨æ•°æ®ï¼‰</option>
            <option value="total" style="background-color: #3730a3; color: #e0e7ff; padding: 0.75rem; font-weight: bold;">ğŸ† æ€»æ¦œï¼ˆå†å²ç´¯è®¡ï¼‰</option>
          </select>
        </div>
      </div>

      <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
      <div class="flex border-b border-slate-200 bg-slate-50">
        <button id="profitTabBtn" onclick="switchLeaderboardTab('profit')" class="flex-1 px-6 py-4 text-center font-semibold transition-all border-b-2 border-green-500 bg-white text-green-600">
          ğŸ† ç›ˆåˆ©æ’è¡Œæ¦œ
        </button>
        <button id="lossTabBtn" onclick="switchLeaderboardTab('loss')" class="flex-1 px-6 py-4 text-center font-semibold transition-all border-b-2 border-transparent text-slate-600 hover:text-slate-900">
          ğŸ“‰ äºæŸæ’è¡Œæ¦œ
        </button>
      </div>

      <!-- ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ -->
      <div class="p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-slate-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">æˆ‘çš„æ’å</p>
            <p id="myRank" class="text-2xl font-bold text-indigo-600">-</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">æ€»æ¸¸ç©æ¬¡æ•°</p>
            <p id="myTotalSpins" class="text-2xl font-bold text-purple-600">0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">æ€»æŠ•æ³¨</p>
            <p id="myTotalBet" class="text-2xl font-bold text-red-600">$0</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-slate-600 mb-1">æ€»ç›ˆäº</p>
            <p id="myTotalProfit" class="text-2xl font-bold">$0</p>
          </div>
        </div>
        <div class="mt-4 text-center">
          <p class="text-sm text-slate-600">æœ€å¤§å•æ¬¡å¥–é‡‘ï¼š<span id="myBiggestWin" class="text-lg font-bold text-orange-600">$0</span> <span id="myBiggestWinType" class="text-sm text-slate-500"></span></p>
        </div>
      </div>

      <!-- æ’è¡Œæ¦œå†…å®¹åŒº -->
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-350px)]">
        <!-- ç›ˆåˆ©æ’è¡Œæ¦œ -->
        <div id="leaderboardContent">
          <!-- æ’è¡Œæ¦œå†…å®¹ -->
        </div>
        
        <!-- äºæŸæ’è¡Œæ¦œ -->
        <div id="lossLeaderboardContent" class="hidden">
          <!-- äºæŸæ¦œå†…å®¹ -->
        </div>
      </div>
    </div>
  </div>

  <!-- è´­ä¹°ç¡®è®¤å¼¹çª— -->
  <div id="buySpinsConfirmModal" onclick="if(event.target === this) cancelBuySpins()" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl animate-in">
      <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-orange-500 to-yellow-600">
        <h3 class="text-xl font-bold text-white flex items-center gap-2">
          <span>ğŸ’°</span>
          <span>ç¡®è®¤è´­ä¹°</span>
        </h3>
      </div>
      <div class="p-6">
        <div class="mb-6 text-center">
          <p class="text-lg text-slate-900 mb-3">ç¡®è®¤è´­ä¹°æŠ½å¥–æœºä¼šå—ï¼Ÿ</p>
          <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-200">
            <p class="text-sm text-slate-700 mb-2">
              <span id="confirmBuyPrice" class="text-lg font-bold text-orange-600">è´­ä¹° 1 æ¬¡æŠ½å¥–æœºä¼šï¼ŒèŠ±è´¹ $40.00</span>
            </p>
            <p class="text-xs text-slate-600 mt-2">
              âš ï¸ è´­ä¹°åä»Šæ—¥å‰©ä½™æ¬¡æ•°+1ï¼ˆä»éœ€æŠ•æ³¨ $20ï¼‰
            </p>
          </div>
        </div>
        <div class="flex gap-3">
          <button onclick="cancelBuySpins()" class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-semibold transition-colors">
            å–æ¶ˆ
          </button>
          <button onclick="confirmBuySpins()" class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-yellow-600 hover:from-orange-600 hover:to-yellow-700 text-white rounded-lg font-semibold transition-all shadow-lg">
            ç¡®è®¤è´­ä¹°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ’ è‡³å°Šåœºè§„åˆ™å¼¹çª— -->
  <div id="supremeRulesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div class="bg-gradient-to-br from-red-900 to-rose-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-red-400">
      <div class="flex justify-between items-center p-6 border-b border-red-400/30 bg-gradient-to-r from-red-600 via-rose-600 to-red-500">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          <span>ğŸ’</span>
          <span>è‡³å°Šåœºæ¸¸æˆè§„åˆ™</span>
        </h2>
        <button onclick="closeSupremeRules()" class="text-white hover:text-red-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-100px)] bg-gradient-to-b from-red-900/50 to-black/50">
        <div id="supremeRulesDisplay" class="space-y-4 text-white">
          <div class="text-center text-amber-300 py-4">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- è€è™æœºè§„åˆ™å¼¹çª— -->
  <div id="slotRulesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
    <div id="slotRulesModalContent" class="bg-gradient-to-br from-blue-900 to-cyan-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-blue-400">
      <div id="slotRulesModalHeader" class="flex justify-between items-center p-6 border-b border-blue-400/30 bg-gradient-to-r from-blue-600 via-cyan-600 to-blue-500">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          <span id="rulesModalIcon">ğŸ“–</span>
          <span id="rulesModalTitle">æ¸¸æˆè§„åˆ™</span>
        </h2>
        <button onclick="closeSlotRules()" id="slotRulesCloseBtn" class="text-white hover:text-blue-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="slotRulesModalBody" class="p-6 overflow-y-auto max-h-[calc(90vh-100px)] bg-gradient-to-b from-blue-900/50 to-black/50">
        <div class="space-y-4 text-white">
          <!-- ğŸ”¥ å½“å‰åœºæ¬¡è§„åˆ™ï¼ˆåŠ¨æ€åŠ è½½ï¼‰- ç»Ÿä¸€æ˜¾ç¤ºæ‰€æœ‰åœºæ¬¡çš„è§„åˆ™ -->
          <div id="currentRulesDisplay" class="mb-6">
            <div class="text-center text-slate-400 py-4">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== éŸ³æ•ˆç³»ç»Ÿ ==========
    
    // ğŸµ éŸ³æ•ˆç®¡ç†å™¨ï¼ˆå‡çº§ç‰ˆ - ä½¿ç”¨çœŸå®éŸ³é¢‘æ–‡ä»¶ï¼‰
    class SoundManager {
      constructor() {
        this.sounds = {};
        this.muted = localStorage.getItem('slotSoundMuted') === 'true';
        this.volume = parseFloat(localStorage.getItem('slotSoundVolume') || '0.5');
        this.initialized = false;
      }
      
      // åˆå§‹åŒ–éŸ³æ•ˆ
      init() {
        if (this.initialized) return;
        
        try {
          // ğŸµ åŠ è½½çœŸå®éŸ³é¢‘æ–‡ä»¶
          this.sounds.spin = new Audio('/sounds/mixkit-slot-machine-win-1928.wav');
          this.sounds.win = new Audio('/sounds/mixkit-coin-win-notification-1992.wav');
          this.sounds.lose = new Audio('/sounds/ngmhhy.mp3');
          
          // è®¾ç½®éŸ³é‡
          Object.values(this.sounds).forEach(audio => {
            audio.volume = this.volume;
            audio.load(); // é¢„åŠ è½½
          });
          
          this.initialized = true;
          // console.log('ğŸ”Š éŸ³æ•ˆç³»ç»Ÿå·²åˆå§‹åŒ–ï¼ˆä½¿ç”¨çœŸå®éŸ³é¢‘æ–‡ä»¶ï¼‰');
        } catch (error) {
          console.error('âŒ éŸ³æ•ˆåˆå§‹åŒ–å¤±è´¥:', error);
        }
      }
      
      // æ’­æ”¾æŒ‡å®šéŸ³æ•ˆ
      playAudio(soundName, volumeMultiplier = 1.0) {
        if (this.muted || !this.initialized) return;
        
        try {
          const audio = this.sounds[soundName];
          if (!audio) {
            // console.warn(`éŸ³æ•ˆ ${soundName} ä¸å­˜åœ¨`);
            return;
          }
          
          // é‡ç½®æ’­æ”¾ä½ç½®
          audio.pause();
          audio.currentTime = 0;
          
          // è®¾ç½®éŸ³é‡
          audio.volume = Math.max(0, Math.min(1, this.volume * volumeMultiplier));
          
          // æ’­æ”¾éŸ³æ•ˆ
          audio.play().catch(err => {
            // console.warn('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', err.message);
          });
        } catch (error) {
          console.error('æ’­æ”¾éŸ³æ•ˆå‡ºé”™:', error);
        }
      }
      
      // åœæ­¢æŒ‡å®šéŸ³æ•ˆ
      stopAudio(soundName) {
        try {
          const audio = this.sounds[soundName];
          if (audio) {
            audio.pause();
            audio.currentTime = 0;
          }
        } catch (error) {
          console.error('åœæ­¢éŸ³æ•ˆå‡ºé”™:', error);
        }
      }
      
      // æ—‹è½¬éŸ³æ•ˆï¼ˆ5.5-6ç§’ï¼‰
      playSpin() {
        this.init();
        this.playAudio('spin', 0.6); // éŸ³é‡ç¨å¤§ï¼Œè¥é€ æ°›å›´
      }
      
      // ä¸­å¥–éŸ³æ•ˆ
      playWin(multiplier) {
        this.init();
        
        // ğŸ¯ æ ¹æ®å€ç‡è°ƒæ•´éŸ³é‡ï¼Œè¶…çº§å¤§å¥–æ»¡éŸ³é‡
        if (multiplier >= 256) {
          this.playJackpot(); // è¶…çº§å¤§å¥–ç‰¹æ®Šå¤„ç†
        } else if (multiplier >= 32) {
          this.playAudio('win', 0.9); // å¤§å¥–
        } else {
          this.playAudio('win', 0.8); // æ™®é€šä¸­å¥–
        }
      }
      
      // è¶…çº§å¤§å¥–éŸ³æ•ˆï¼ˆæ»¡éŸ³é‡ï¼ï¼‰
      playJackpot() {
        this.init();
        this.playAudio('win', 1.0); // ğŸ”¥ æ»¡éŸ³é‡ï¼Œæœ€éœ‡æ’¼ï¼
      }
      
      // æœªä¸­å¥–/æƒ©ç½šéŸ³æ•ˆ
      playLose() {
        this.init();
        this.playAudio('lose', 1.0);
      }
      
      // æƒ©ç½šéŸ³æ•ˆï¼ˆä¸æœªä¸­å¥–ä½¿ç”¨ç›¸åŒéŸ³æ•ˆï¼‰
      playPunishment() {
        this.init();
        this.playAudio('lose', 1.0);
      }
      
      // æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆï¼ˆä¿ç•™ç®€å•éŸ³è°ƒï¼‰
      playClick() {
        this.init();
        // ä½¿ç”¨Web Audio APIç”Ÿæˆç®€çŸ­çš„ç‚¹å‡»éŸ³
        if (!this.muted && this.audioContext) {
          try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.frequency.value = 600;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(this.volume * 0.3, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + 0.05);
          } catch (e) {
            console.error('æ’­æ”¾ç‚¹å‡»éŸ³å¤±è´¥:', e);
          }
        }
      }
      
      // åˆ‡æ¢é™éŸ³
      toggleMute() {
        this.muted = !this.muted;
        localStorage.setItem('slotSoundMuted', this.muted);
        
        // å¦‚æœé™éŸ³ï¼Œåœæ­¢æ‰€æœ‰éŸ³æ•ˆ
        if (this.muted) {
          Object.values(this.sounds).forEach(audio => {
            if (audio && audio.pause) {
              audio.pause();
            }
          });
        }
        
        return this.muted;
      }
      
      // è®¾ç½®éŸ³é‡
      setVolume(vol) {
        this.volume = Math.max(0, Math.min(1, vol));
        localStorage.setItem('slotSoundVolume', this.volume);
        
        // æ›´æ–°æ‰€æœ‰éŸ³é¢‘çš„éŸ³é‡
        Object.values(this.sounds).forEach(audio => {
          if (audio) {
            audio.volume = this.volume;
          }
        });
      }
    }
    
    // åˆ›å»ºå…¨å±€éŸ³æ•ˆç®¡ç†å™¨
    const soundManager = new SoundManager();

    // ========== ğŸµ èƒŒæ™¯éŸ³ä¹ç®¡ç†å™¨ ==========
    
    class BackgroundMusicManager {
      constructor() {
        this.player = null;
        this.isPlaying = false;
        this.volume = parseFloat(localStorage.getItem('bgMusicVolume') || '0.3');
        this.muted = localStorage.getItem('bgMusicMuted') === 'true';
        
        // ğŸµ æ’­æ”¾åˆ—è¡¨ï¼ˆéšæœºé¡ºåºï¼‰
        this.playlist = [
          '/sounds/llh.mp3',
          '/sounds/sjsdehjm.mp3',
          '/sounds/mb.mp3',
          '/sounds/Deadman.mp3'
        ];
        this.currentTrackIndex = 0;
        
        // éšæœºæ‰“ä¹±æ’­æ”¾åˆ—è¡¨
        this.shufflePlaylist();
      }

      // éšæœºæ‰“ä¹±æ’­æ”¾åˆ—è¡¨
      shufflePlaylist() {
        for (let i = this.playlist.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [this.playlist[i], this.playlist[j]] = [this.playlist[j], this.playlist[i]];
        }
        console.log('ğŸµ æ’­æ”¾åˆ—è¡¨å·²éšæœºåŒ–:', this.playlist.map(p => p.split('/').pop()));
      }

      // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
      init() {
        if (this.player) return;
        
        this.player = document.getElementById('bgMusicPlayer');
        if (!this.player) {
          console.error('âŒ èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨æœªæ‰¾åˆ°');
          return;
        }
        
        // è®¾ç½®éŸ³é‡
        this.player.volume = this.volume;
        
        // ğŸµ ç›‘å¬éŸ³ä¹æ’­æ”¾ç»“æŸäº‹ä»¶ï¼Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        this.player.addEventListener('ended', () => {
          console.log('ğŸµ å½“å‰éŸ³ä¹æ’­æ”¾å®Œæ¯•ï¼Œåˆ‡æ¢ä¸‹ä¸€é¦–');
          this.playNext();
        });
        
        // åŠ è½½ç¬¬ä¸€é¦–éŸ³ä¹
        this.loadTrack(this.currentTrackIndex);
        
        // ğŸµ åªåœ¨å¨±ä¹ç«™æ¨¡å¼ä¸”æœªé™éŸ³æ—¶æ’­æ”¾
        if (!this.muted && currentMode === 'entertain') {
          this.play();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        this.updateButton();
      }

      // åŠ è½½æŒ‡å®šéŸ³è½¨
      loadTrack(index) {
        if (!this.player || index < 0 || index >= this.playlist.length) return;
        
        this.currentTrackIndex = index;
        const trackUrl = this.playlist[index];
        const trackName = trackUrl.split('/').pop();
        
        this.player.src = trackUrl;
        this.player.load();
        
        console.log(`ğŸµ å·²åŠ è½½éŸ³ä¹: ${trackName} (${index + 1}/${this.playlist.length})`);
      }

      // æ’­æ”¾ä¸‹ä¸€é¦–
      playNext() {
        // å¾ªç¯æ’­æ”¾åˆ—è¡¨
        this.currentTrackIndex = (this.currentTrackIndex + 1) % this.playlist.length;
        
        // å¦‚æœæ’­æ”¾å®Œæ•´ä¸ªåˆ—è¡¨ï¼Œé‡æ–°éšæœºæ‰“ä¹±
        if (this.currentTrackIndex === 0) {
          console.log('ğŸµ æ’­æ”¾åˆ—è¡¨å·²æ’­æ”¾å®Œæ¯•ï¼Œé‡æ–°éšæœºåŒ–');
          this.shufflePlaylist();
        }
        
        this.loadTrack(this.currentTrackIndex);
        
        // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾ä¸‹ä¸€é¦–
        if (this.isPlaying && !this.muted) {
          this.play();
        }
      }

      // æ’­æ”¾éŸ³ä¹
      play() {
        if (!this.player) this.init();
        if (!this.player || this.muted) return;
        
        this.player.play().then(() => {
          this.isPlaying = true;
          this.updateButton();
          const trackName = this.player.src.split('/').pop();
          console.log(`ğŸµ èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾: ${trackName}`);
        }).catch(err => {
          console.warn('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', err.message);
          // æµè§ˆå™¨ç­–ç•¥ï¼šéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾
        });
      }

      // æš‚åœéŸ³ä¹
      pause() {
        if (!this.player) return;
        
        this.player.pause();
        this.isPlaying = false;
        this.updateButton();
        console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å·²æš‚åœ');
      }

      // æš‚åœä½†ä¿æŒè¿›åº¦ï¼ˆåˆ‡æ¢ç•Œé¢æ—¶ä½¿ç”¨ï¼‰
      pauseKeepProgress() {
        if (!this.player || this.muted) return;
        
        this.player.pause();
        this.isPlaying = false;
        // æ³¨æ„ï¼šä¸è°ƒç”¨updateButton()ï¼Œä¿æŒæŒ‰é’®æ˜¾ç¤ºä¸ºæ’­æ”¾çŠ¶æ€
        console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å·²æš‚åœï¼ˆä¿æŒè¿›åº¦ï¼‰');
      }

      // ä»å½“å‰è¿›åº¦æ¢å¤æ’­æ”¾ï¼ˆåˆ‡å›å¨±ä¹ç«™æ—¶ä½¿ç”¨ï¼‰
      resumeFromProgress() {
        if (!this.player || this.muted) return;
        
        // ä»å½“å‰ä½ç½®ç»§ç»­æ’­æ”¾
        this.player.play().then(() => {
          this.isPlaying = true;
          console.log('ğŸµ èƒŒæ™¯éŸ³ä¹æ¢å¤æ’­æ”¾ï¼ˆä»è¿›åº¦ç»§ç»­ï¼‰');
        }).catch(err => {
          console.warn('æ¢å¤æ’­æ”¾å¤±è´¥:', err.message);
        });
      }

      // åˆ‡æ¢æ’­æ”¾/æš‚åœï¼ˆç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ï¼‰
      toggle() {
        if (!this.player) this.init();
        
        if (this.muted || !this.isPlaying) {
          // å–æ¶ˆé™éŸ³
          this.muted = false;
          localStorage.setItem('bgMusicMuted', 'false');
          
          // ğŸµ åªåœ¨å¨±ä¹ç«™æ—¶æ’­æ”¾ï¼Œå…¶ä»–ç•Œé¢åªå–æ¶ˆé™éŸ³çŠ¶æ€
          if (currentMode === 'entertain') {
            this.play();
          }
        } else {
          // æš‚åœå¹¶é™éŸ³
          this.muted = true;
          localStorage.setItem('bgMusicMuted', 'true');
          this.pause();
        }
        
        this.updateButton();
      }

      // è®¾ç½®éŸ³é‡
      setVolume(vol) {
        this.volume = Math.max(0, Math.min(1, vol));
        localStorage.setItem('bgMusicVolume', this.volume.toString());
        
        if (this.player) {
          this.player.volume = this.volume;
        }
      }

      // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
      updateButton() {
        const icon = document.getElementById('bgMusicIcon');
        const btn = document.getElementById('bgMusicToggleBtn');
        
        if (!icon || !btn) return;
        
        // ğŸµ æ ¹æ®é™éŸ³çŠ¶æ€å’Œå½“å‰ç•Œé¢æ˜¾ç¤º
        if (this.muted) {
          // ç”¨æˆ·æ‰‹åŠ¨é™éŸ³
          icon.textContent = 'ğŸ”‡';
          btn.classList.remove('animate-pulse');
          btn.title = 'èƒŒæ™¯éŸ³ä¹ï¼šå·²å…³é—­';
        } else if (currentMode === 'entertain' && this.isPlaying) {
          // å¨±ä¹ç«™æ’­æ”¾ä¸­
          icon.textContent = 'ğŸµ';
          btn.classList.add('animate-pulse');
          btn.title = 'èƒŒæ™¯éŸ³ä¹ï¼šæ’­æ”¾ä¸­';
        } else {
          // å…¶ä»–ç•Œé¢ï¼ˆå·²æš‚åœä½†æœªé™éŸ³ï¼‰
          icon.textContent = 'ğŸµ';
          btn.classList.remove('animate-pulse');
          btn.title = 'èƒŒæ™¯éŸ³ä¹ï¼šå·²æš‚åœï¼ˆåˆ‡æ¢åˆ°å¨±ä¹ç«™è‡ªåŠ¨æ’­æ”¾ï¼‰';
        }
      }
    }

    // åˆ›å»ºå…¨å±€èƒŒæ™¯éŸ³ä¹ç®¡ç†å™¨å®ä¾‹
    const bgMusicManager = new BackgroundMusicManager();

    // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
    function toggleBgMusic() {
      bgMusicManager.toggle();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹
    document.addEventListener('DOMContentLoaded', () => {
      // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡é¡µé¢åŠ è½½
      setTimeout(() => {
        bgMusicManager.init();
      }, 1000);
    });
    
    // éŸ³æ•ˆæ§åˆ¶å‡½æ•°
    function toggleSound() {
      const muted = soundManager.toggleMute();
      const icon = document.getElementById('soundIcon');
      icon.textContent = muted ? 'ğŸ”‡' : 'ğŸ”Š';
      showToast(muted ? 'éŸ³æ•ˆå·²å…³é—­' : 'éŸ³æ•ˆå·²å¼€å¯', 'success');
    }
    
    // ========== é…ç½® ==========
    
    const CONFIG = {
      LINUX_DO_AUTH_URL: 'https://connect.linux.do/oauth2/authorize',
      LINUX_DO_CLIENT_ID: '',
      LINUX_DO_REDIRECT_URI: window.location.origin + '/oauth/callback',
    };

    // å¼€å‘æ¨¡å¼æ ‡å¿— - è®¾ç½®ä¸º false ä»¥å…³é—­è¯¦ç»†è°ƒè¯•æ—¥å¿—
    const DEBUG_MODE = false;

    // å°è£…æ—¥å¿—å‡½æ•°
    const debugLog = (...args) => {
      if (DEBUG_MODE) console.log(...args);
    };

    let currentUser = null;
    let currentMode = 'refuel'; // 'refuel' or 'entertain'

    // ä¿å­˜å½“å‰æ¨¡å¼åˆ° URL hash
    function saveCurrentMode(mode) {
      currentMode = mode;
      // ä½¿ç”¨ history.replaceState é¿å…å¢åŠ å†å²è®°å½•
      if (mode === 'entertain') {
        window.location.hash = 'slot';
      } else if (mode === 'achievement') {
        window.location.hash = 'achievement';  // âœ… æ”¯æŒæˆå°±é¡µé¢hash
      } else {
        window.location.hash = '';
      }
    }

    // ä» URL hash æ¢å¤æ¨¡å¼
    function restoreMode() {
      const hash = window.location.hash.slice(1); // ç§»é™¤ #
      if (hash === 'slot') {
        return 'entertain';
      } else if (hash === 'achievement') {
        return 'achievement';  // âœ… æ”¯æŒæ¢å¤æˆå°±é¡µé¢
      }
      return 'refuel';
    }

    // åˆ‡æ¢åˆ°åŠ æ²¹ç«™æ¨¡å¼
    async function switchToRefuel() {
      if (currentMode === 'refuel') return;

      saveCurrentMode('refuel');

      // ğŸµ æš‚åœèƒŒæ™¯éŸ³ä¹ï¼ˆä¿æŒè¿›åº¦ï¼‰
      if (bgMusicManager) {
        bgMusicManager.pauseKeepProgress();
      }

      // æ›´æ–°ä¸»ç•Œé¢çš„åˆ‡æ¢æŒ‰é’®
      updateSwitchButtons('refuel');

      const mainSection = document.getElementById('mainSection');
      const achievementSection = document.getElementById('achievementSection');
      const slotModal = document.getElementById('slotMachineModal');
      const backToTopBtn = document.getElementById('backToTopBtn');

      // éšè—æˆå°±ç•Œé¢
      if (achievementSection && !achievementSection.classList.contains('hidden')) {
        achievementSection.classList.add('hidden');
      }
      
      // âœ… éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
      if (backToTopBtn) {
        backToTopBtn.classList.add('hidden');
      }

      // æ·»åŠ é€€å‡ºåŠ¨ç”»
      slotModal.classList.add('fade-exit');

      // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      await new Promise(resolve => setTimeout(resolve, 200));

      // åˆ‡æ¢æ˜¾ç¤º
      slotModal.classList.add('hidden');
      slotModal.classList.remove('fade-exit');

      mainSection.classList.remove('hidden');
      mainSection.classList.add('fade-enter');

      // è§¦å‘è¿›å…¥åŠ¨ç”»
      requestAnimationFrame(() => {
        mainSection.classList.add('fade-enter-active');
      });

      // å®ŒæˆåŠ¨ç”»åæ¸…ç†
      setTimeout(() => {
        mainSection.classList.remove('fade-enter', 'fade-enter-active');
      }, 300);

      // åˆ·æ–°é¢åº¦
      loadQuota();
    }

    // åˆ‡æ¢åˆ°å¨±ä¹ç«™æ¨¡å¼
    function switchToEntertain() {
      if (currentMode === 'entertain') return;

      saveCurrentMode('entertain');

      // ğŸµ æ¢å¤èƒŒæ™¯éŸ³ä¹æ’­æ”¾ï¼ˆä»è¿›åº¦ç»§ç»­ï¼‰
      if (bgMusicManager && !bgMusicManager.muted) {
        bgMusicManager.resumeFromProgress();
      }

      // æ›´æ–°ä¸»ç•Œé¢çš„åˆ‡æ¢æŒ‰é’®
      updateSwitchButtons('entertain');

      // âœ… éšè—æˆå°±ç•Œé¢
      const achievementSection = document.getElementById('achievementSection');
      if (achievementSection && !achievementSection.classList.contains('hidden')) {
        achievementSection.classList.add('hidden');
      }

      // âœ… éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
      const backToTopBtn = document.getElementById('backToTopBtn');
      if (backToTopBtn) {
        backToTopBtn.classList.add('hidden');
      }

      // æ‰“å¼€è€è™æœº
      showSlotMachine();
    }

    // åˆ‡æ¢åˆ°æˆå°±æ¨¡å¼
    async function switchToAchievement() {
      if (currentMode === 'achievement') return;

      saveCurrentMode('achievement');

      // ğŸµ æš‚åœèƒŒæ™¯éŸ³ä¹ï¼ˆä¿æŒè¿›åº¦ï¼‰
      if (bgMusicManager) {
        bgMusicManager.pauseKeepProgress();
      }

      // æ›´æ–°ä¸»ç•Œé¢çš„åˆ‡æ¢æŒ‰é’®
      updateSwitchButtons('achievement');

      const mainSection = document.getElementById('mainSection');
      const achievementSection = document.getElementById('achievementSection');
      const slotModal = document.getElementById('slotMachineModal');

      // å…³é—­è€è™æœºç•Œé¢ï¼ˆå¦‚æœæ‰“å¼€ï¼‰
      if (!slotModal.classList.contains('hidden')) {
        slotModal.classList.add('fade-exit');
        await new Promise(resolve => setTimeout(resolve, 200));
        slotModal.classList.add('hidden');
        slotModal.classList.remove('fade-exit');
      }

      // éšè—åŠ æ²¹ç«™ç•Œé¢
      mainSection.classList.add('hidden');

      // æ˜¾ç¤ºæˆå°±ç•Œé¢
      achievementSection.classList.remove('hidden');
      achievementSection.classList.add('fade-enter');

      // è§¦å‘è¿›å…¥åŠ¨ç”»
      requestAnimationFrame(() => {
        achievementSection.classList.add('fade-enter-active');
      });

      // å®ŒæˆåŠ¨ç”»åæ¸…ç†
      setTimeout(() => {
        achievementSection.classList.remove('fade-enter', 'fade-enter-active');
      }, 300);

      // âœ… åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°æˆå°±ç•Œé¢
      syncUserInfoToAchievement();

      // åŠ è½½æˆå°±æ•°æ®
      loadAchievements();
    }

    // æ›´æ–°æ‰€æœ‰åˆ‡æ¢æŒ‰é’®çš„æ ·å¼ï¼ˆä¸»ç•Œé¢å’Œè€è™æœºç•Œé¢åŒæ­¥ï¼‰
    function updateSwitchButtons(mode) {
      // è·å–æ‰€æœ‰åˆ‡æ¢æŒ‰é’®å®¹å™¨
      const containers = document.querySelectorAll('[data-switch-container]');

      containers.forEach((container) => {
        const refuelBtn = container.querySelector('[data-btn="refuel"]');
        const entertainBtn = container.querySelector('[data-btn="entertain"]');
        const achievementBtn = container.querySelector('[data-btn="achievement"]');

        // æ£€æŸ¥æ˜¯å¦åœ¨è€è™æœºç•Œé¢ï¼ˆæš—è‰²ä¸»é¢˜ï¼‰
        const isDarkTheme = container.closest('#slotMachineModal') !== null;

        if (mode === 'refuel') {
          // åŠ æ²¹ç«™æ¨¡å¼æ¿€æ´»
          if (isDarkTheme) {
            // è€è™æœºç•Œé¢ - æš—è‰²ä¸»é¢˜
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
            if (achievementBtn) achievementBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
          } else {
            // ä¸»ç•Œé¢ - äº®è‰²ä¸»é¢˜
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
            if (achievementBtn) achievementBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
          }
        } else if (mode === 'entertain') {
          // å¨±ä¹ç«™æ¨¡å¼æ¿€æ´»
          if (isDarkTheme) {
            // è€è™æœºç•Œé¢ - æš—è‰²ä¸»é¢˜
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-lg';
            if (achievementBtn) achievementBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-white/70 hover:bg-white/10';
          } else {
            // ä¸»ç•Œé¢ - äº®è‰²ä¸»é¢˜
            refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
            entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-yellow-500 to-orange-600 text-white shadow-md';
            if (achievementBtn) achievementBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
          }
        } else if (mode === 'achievement') {
          // æˆå°±æ¨¡å¼æ¿€æ´»
          refuelBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
          entertainBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 text-slate-600 hover:bg-slate-100';
          if (achievementBtn) achievementBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all duration-200 bg-gradient-to-r from-amber-500 to-yellow-500 text-white shadow-md';
        }
      });
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600';
      toast.className = `toast px-6 py-4 rounded-xl ${bgColor} text-white min-w-[300px]`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-6 h-6 rounded-full ${type === 'success' ? 'bg-white/20' : 'bg-white/20'} flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
            </svg>
          </div>
          <span class="font-medium">${message}</span>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /**
     * ğŸ† æ˜¾ç¤ºæˆå°±è§£é”Toastï¼ˆå·¦ä¸Šè§’ï¼‰
     * @param {Object} achievement - æˆå°±å¯¹è±¡
     */
    function showAchievementToast(achievement) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');

      // ç¨€æœ‰åº¦é¢œè‰²æ˜ å°„
      const rarityColors = {
        'common': 'from-gray-500 to-gray-600',
        'uncommon': 'from-green-500 to-emerald-600',
        'rare': 'from-blue-500 to-indigo-600',
        'epic': 'from-purple-500 to-violet-600',
        'legendary': 'from-amber-500 to-orange-600'
      };

      const bgGradient = rarityColors[achievement.rarity] || rarityColors['common'];

      toast.className = `achievement-toast px-8 py-6 rounded-2xl bg-gradient-to-r ${bgGradient} text-white shadow-2xl border-4 border-yellow-300 min-w-[350px] max-w-[450px]`;

      // æ ¼å¼åŒ–å¥–åŠ±é¢åº¦
      const rewardAmount = achievement.reward_quota ? (achievement.reward_quota / 500000).toFixed(2) : '0.00';

      toast.innerHTML = `
        <div class="flex items-start gap-4">
          <!-- å›¾æ ‡ -->
          <div class="flex-shrink-0 text-5xl" style="animation: achievementBounce 1s ease-in-out infinite;">
            ${achievement.icon || 'ğŸ†'}
          </div>

          <!-- å†…å®¹ -->
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-bold uppercase tracking-wider opacity-90">
                ğŸ‰ æˆå°±è§£é”
              </span>
              <span class="text-xs px-2 py-0.5 rounded-full bg-white/20">
                ${achievement.rarity_name || 'æ™®é€š'}
              </span>
            </div>
            <div class="text-xl font-bold mb-1">
              ${achievement.achievement_name || 'æœªçŸ¥æˆå°±'}
            </div>
            <div class="text-sm opacity-90 mb-2">
              ${achievement.description || ''}
            </div>
            <div class="flex items-center gap-2 text-sm font-semibold">
              <span>ğŸ’° å¥–åŠ±:</span>
              <span class="text-yellow-200">+$${rewardAmount}</span>
            </div>
          </div>

          <!-- å…³é—­æŒ‰é’® -->
          <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;

      container.appendChild(toast);

      // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        toast.style.animation = 'achievementSlideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    function showThankYouToast() {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 z-[10000] px-12 py-10 rounded-3xl bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white shadow-2xl';
      toast.style.animation = 'fadeInScale 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      toast.innerHTML = `
        <div class="relative">
          <!-- ç²’å­å®¹å™¨ï¼ˆåœ¨æœ€åº•å±‚ï¼‰ -->
          <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none" style="z-index: 0;">
            ${Array.from({length: 25}, (_, i) => `
              <div class="particle absolute w-1.5 h-1.5 bg-white rounded-full" style="
                left: ${Math.random() * 100}%;
                top: ${Math.random() * 100}%;
                opacity: ${0.15 + Math.random() * 0.2};
                animation: float ${2 + Math.random() * 3}s ease-in-out infinite;
                animation-delay: ${Math.random() * 2}s;
              "></div>
            `).join('')}
          </div>
          
          <!-- å†…å®¹ï¼ˆåœ¨æœ€ä¸Šå±‚ï¼‰ -->
          <div class="relative text-center" style="z-index: 10;">
            <div class="text-6xl mb-4 animate-bounce">ğŸ‰</div>
            <div class="text-3xl font-bold mb-3 drop-shadow-lg">æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼</div>
            <div class="text-lg opacity-95 mb-2 drop-shadow-md">æ‚¨çš„æŠ•å–‚è®©å…¬ç›Šç«™æ›´å¥½è¿è¡Œ</div>
            <div class="flex items-center justify-center gap-2 text-sm opacity-90 drop-shadow-md">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
              </svg>
              <span>å…¬ç›Šæœ‰ä½ ï¼Œæœªæ¥å¯æœŸ</span>
            </div>
          </div>
        </div>
      `;
      
      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeInScale {
          from {
            opacity: 0;
            transform: translate(-50%, -30px) scale(0.8);
          }
          to {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
          }
        }
        @keyframes fadeOutScale {
          from {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
          }
          to {
            opacity: 0;
            transform: translate(-50%, -30px) scale(0.8);
          }
        }
        @keyframes float {
          0%, 100% {
            transform: translateY(0) translateX(0);
          }
          25% {
            transform: translateY(-10px) translateX(5px);
          }
          50% {
            transform: translateY(-20px) translateX(-5px);
          }
          75% {
            transform: translateY(-10px) translateX(5px);
          }
        }
        .particle {
          pointer-events: none;
        }
      `;
      if (!document.querySelector('#thankYouToastStyle')) {
        style.id = 'thankYouToastStyle';
        document.head.appendChild(style);
      }
      
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOutScale 0.5s ease-in forwards';
        setTimeout(() => toast.remove(), 500);
      }, 4000);
    }

    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      const achievementDropdown = document.getElementById('achievementDropdownMenu');
      
      // æ£€æŸ¥å½“å‰åœ¨å“ªä¸ªé¡µé¢
      const achievementSection = document.getElementById('achievementSection');
      const isInAchievementPage = achievementSection && !achievementSection.classList.contains('hidden');
      
      if (isInAchievementPage && achievementDropdown) {
        achievementDropdown.classList.toggle('hidden');
      } else if (dropdown) {
        dropdown.classList.toggle('hidden');
      }
    }

    function toggleSlotDropdown() {
      document.getElementById('slotDropdownMenu').classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('dropdownMenu');
      const slotDropdown = document.getElementById('slotDropdownMenu');
      const achievementDropdown = document.getElementById('achievementDropdownMenu');
      
      if (dropdown && !e.target.closest('button[onclick="toggleDropdown()"]') && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
      
      if (slotDropdown && !e.target.closest('button[onclick="toggleSlotDropdown()"]') && !slotDropdown.contains(e.target)) {
        slotDropdown.classList.add('hidden');
      }
      
      if (achievementDropdown && !e.target.closest('button[onclick="toggleDropdown()"]') && !achievementDropdown.contains(e.target)) {
        achievementDropdown.classList.add('hidden');
      }
    });

    function login() {
      sessionStorage.setItem('oauth_loading', 'true');
      const authUrl = `${CONFIG.LINUX_DO_AUTH_URL}?client_id=${CONFIG.LINUX_DO_CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.LINUX_DO_REDIRECT_URI)}&response_type=code&scope=user`;
      window.location.href = authUrl;
    }

    async function bindAccount() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        showMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error', 'bind');
        return;
      }

      try {
        const res = await fetch('/api/auth/bind', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('bindSection').classList.add('hidden');
          document.getElementById('mainSection').classList.remove('hidden');
          await loadQuota();
          showToast(data.message, 'success');
        } else {
          showMessage(data.message, 'error', 'bind');
        }
      } catch (e) {
        showMessage('ç»‘å®šå¤±è´¥', 'error', 'bind');
      }
    }

    // ğŸ”„ åˆ·æ–°é¢åº¦ï¼ˆå¸¦æ—‹è½¬åŠ¨ç”»ï¼‰
    async function refreshQuota() {
      const refreshBtn = document.getElementById('refreshQuotaBtn');
      const refreshIcon = document.getElementById('refreshQuotaIcon');
      
      if (!refreshBtn || !refreshIcon) return;
      
      // ç¦ç”¨æŒ‰é’®å¹¶æ·»åŠ æ—‹è½¬åŠ¨ç”»
      refreshBtn.disabled = true;
      refreshIcon.classList.add('animate-spin');
      
      try {
        // è°ƒç”¨loadQuotaåˆ·æ–°æ•°æ®
        await loadQuota();
        
        // åŒæ—¶åˆ·æ–°è€è™æœºé…ç½®å’Œç”¨æˆ·æ•°æ®
        if (currentMode === 'entertain') {
          try {
            const configRes = await fetch('/api/slot/config');
            const configData = await configRes.json();
            if (configData.success) {
              slotUserData = configData.data.user;
              updateSlotUI();
            }
          } catch (err) {
            console.error('åˆ·æ–°è€è™æœºæ•°æ®å¤±è´¥:', err);
          }
        }
        
        showToast('é¢åº¦å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('åˆ·æ–°é¢åº¦å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥', 'error');
      } finally {
        // ç§»é™¤æ—‹è½¬åŠ¨ç”»å¹¶å¯ç”¨æŒ‰é’®
        setTimeout(() => {
          refreshIcon.classList.remove('animate-spin');
          refreshBtn.disabled = false;
        }, 500);
      }
    }

    async function loadQuota() {
      try {
        const res = await fetch('/api/user/quota');
        const data = await res.json();

        // æ£€æŸ¥æ˜¯å¦è¢«å°ç¦
        if (res.status === 403 && data.banned) {
          document.getElementById('mainSection').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
          alert('âš ï¸ ' + data.message);
          await logout();
          return;
        }

        if (data.success) {
          const { quota, used_quota, total, username, linux_do_id, linux_do_username, avatar_url } = data.data;

          // æ˜¾ç¤ºLinuxDoç”¨æˆ·åå’Œå…¬ç›Šç«™ç”¨æˆ·å
          // ä¼˜å…ˆæ˜¾ç¤º LinuxDo ç”¨æˆ·åï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºå…¬ç›Šç«™ç”¨æˆ·å
          const displayName = linux_do_username && linux_do_username.trim() ? linux_do_username : username;
          document.getElementById('linuxDoUsername').textContent = `@${displayName}`;
          document.getElementById('userName').textContent = `å…¬ç›Šç«™: ${username}`;
          document.getElementById('userId').textContent = 'ID: ' + linux_do_id;
          document.getElementById('userInitial').textContent = displayName[0].toUpperCase();

          // è®¾ç½®ç”¨æˆ·å¤´åƒ
          if (avatar_url && avatar_url.trim()) {
            const userAvatar = document.getElementById('userAvatar');
            
            // ä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½ï¼Œç¡®ä¿å›¾ç‰‡èƒ½æ­£å¸¸åŠ è½½
            const img = new Image();
            img.onload = function() {
              userAvatar.style.backgroundImage = `url(${avatar_url})`;
              userAvatar.style.backgroundSize = 'cover';
              userAvatar.style.backgroundPosition = 'center';
              document.getElementById('userInitial').textContent = '';
            };
            img.onerror = function() {
              // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨LinuxDoçš„letter_avatarï¼ˆå­—æ¯å¤´åƒï¼‰
              const firstLetter = (linux_do_username || username).charAt(0).toLowerCase();
              const colorCode = firstLetter.charCodeAt(0) % 10;
              const fallbackUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/120.png`;
              const fallbackImg = new Image();
              fallbackImg.onload = function() {
                userAvatar.style.backgroundImage = `url(${fallbackUrl})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
                document.getElementById('userInitial').textContent = '';
              };
              fallbackImg.onerror = function() {
                console.error('[å¤´åƒåŠ è½½å¤±è´¥]', avatar_url);
              };
              fallbackImg.src = fallbackUrl;
            };
            img.src = avatar_url;
          } else {
            // å¦‚æœæ²¡æœ‰avatar_urlï¼Œç›´æ¥ä½¿ç”¨letter_avatar
            const firstLetter = (linux_do_username || username).charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            const letterAvatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/120.png`;
            const img = new Image();
            img.onload = function() {
              // console.log('[å¤´åƒåŠ è½½] Letter avataråŠ è½½æˆåŠŸ');
              const userAvatar = document.getElementById('userAvatar');
              userAvatar.style.backgroundImage = `url(${letterAvatarUrl})`;
              userAvatar.style.backgroundSize = 'cover';
              userAvatar.style.backgroundPosition = 'center';
              document.getElementById('userInitial').textContent = '';
            };
            img.onerror = function() {
              console.error('[å¤´åƒåŠ è½½] Letter avatarå¤±è´¥ï¼Œä½¿ç”¨é¦–å­—æ¯');
            };
            img.src = letterAvatarUrl;
          }

          const quotaUSD = (quota / 500000).toFixed(2);
          document.getElementById('quotaValue').textContent = '$' + quotaUSD;
          document.getElementById('quotaUsage').textContent = ((used_quota / total * 100).toFixed(2)) + '%';
          document.getElementById('quotaStatus').textContent = quota < 10000000 ? 'é¢åº¦ä¸è¶³' : 'å……è¶³';
          
          // æ›´æ–°æŠ•å–‚è¯´æ˜ï¼ˆåœ¨è·å–é…ç½®åï¼‰
          const maxModelscope = data.data.max_daily_donate_modelscope || 1;
          const maxIflow = data.data.max_daily_donate_iflow || 1;
          if (maxModelscope === maxIflow) {
            document.getElementById('donateDescription').textContent = `æ¯ä¸ªæœ‰æ•ˆçš„ API Key å¯ä¸ºæ‚¨å¢åŠ  $50 é¢åº¦å¹¶è·å¾—1æ¬¡å…è´¹æŠ½å¥– Â· æ¯ç§ç±»å‹æ¯å¤©å¯æŠ•å–‚ ${maxModelscope} ä¸ª`;
          } else {
            document.getElementById('donateDescription').textContent = `æ¯ä¸ªæœ‰æ•ˆçš„ API Key å¯ä¸ºæ‚¨å¢åŠ  $50 é¢åº¦å¹¶è·å¾—1æ¬¡å…è´¹æŠ½å¥– Â· ModelScope æ¯å¤©å¯æŠ•å–‚ ${maxModelscope} ä¸ªï¼ŒiFlow æ¯å¤©å¯æŠ•å–‚ ${maxIflow} ä¸ª`;
          }

          // æ›´æ–°é¢†å–æ¬¡æ•°ä¿¡æ¯
          const todayClaimCount = data.data.today_claim_count || 0;
          const maxDailyClaims = data.data.max_daily_claims || 1;
          const remainingClaims = data.data.remaining_claims || 0;
          
          document.getElementById('todayClaimCount').textContent = todayClaimCount;
          document.getElementById('maxDailyClaims').textContent = maxDailyClaims;
          document.getElementById('remainingClaims').textContent = remainingClaims > 0 ? `å‰©ä½™ ${remainingClaims} æ¬¡` : 'å·²ç”¨å®Œ';
          document.getElementById('remainingClaims').className = remainingClaims > 0 
            ? 'px-2 py-1 bg-blue-600 text-white rounded-full text-xs font-semibold'
            : 'px-2 py-1 bg-slate-400 text-white rounded-full text-xs font-semibold';

          const claimBtn = document.getElementById('claimBtn');
          if (remainingClaims === 0) {
            claimBtn.disabled = true;
            claimBtn.textContent = 'âœ“ ä»Šæ—¥å·²è¾¾ä¸Šé™';
            claimBtn.className = 'w-full bg-slate-400 text-white py-3 rounded-lg font-semibold cursor-not-allowed';
          } else if (!data.data.can_claim) {
            claimBtn.disabled = true;
            claimBtn.textContent = 'âŒ é¢åº¦å……è¶³';
            claimBtn.className = 'w-full bg-slate-400 text-white py-3 rounded-lg font-semibold cursor-not-allowed';
          } else {
            claimBtn.disabled = false;
            claimBtn.textContent = 'é¢†å–ä»Šæ—¥é¢åº¦';
            claimBtn.className = 'w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all';
          }

          // å¤„ç† ModelScope æŠ•å–‚çŠ¶æ€
          const donateBtn = document.getElementById('donateBtn');
          const donateWarning = document.getElementById('donateWarning');
          const donatedToday = document.getElementById('donatedToday');
          const keysInput = document.getElementById('keysInput');
          
          const todayDonateModelscope = data.data.today_donate_modelscope_count || 0;
          const maxDonateModelscope = data.data.max_daily_donate_modelscope || 1;
          const remainingDonateModelscope = data.data.remaining_donate_modelscope || 0;
          
          // æ›´æ–°æŠ•å–‚é™åˆ¶è¯´æ˜
          donateWarning.querySelector('span').innerHTML = `<strong>æ¯å¤©å¯ä»¥æŠ•å–‚ ${maxDonateModelscope} ä¸ª</strong>`;
          
          if (remainingDonateModelscope <= 0) {
            // ä»Šæ—¥å·²è¾¾ä¸Šé™
            donateWarning.classList.add('hidden');
            donatedToday.classList.remove('hidden');
            donatedToday.querySelector('span').innerHTML = `âœ“ <strong>ä»Šæ—¥å·²æŠ•å–‚ ${todayDonateModelscope}/${maxDonateModelscope} ä¸ª</strong>`;
            donateBtn.disabled = true;
            donateBtn.textContent = 'âœ“ ä»Šæ—¥å·²æŠ•å–‚';
            donateBtn.className = 'w-full bg-slate-400 text-white py-2.5 rounded-lg font-semibold cursor-not-allowed text-sm mb-3';
            keysInput.disabled = true;
            keysInput.className = 'w-full h-24 px-3 py-2 border border-slate-200 rounded-lg mb-3 font-mono text-sm bg-slate-50 cursor-not-allowed resize-none';
          } else {
            // å¯ä»¥ç»§ç»­æŠ•å–‚
            donateWarning.classList.remove('hidden');
            donatedToday.classList.add('hidden');
            donateBtn.disabled = false;
            donateBtn.textContent = `ğŸš€ æäº¤ ModelScope Keyï¼ˆè¿˜å¯æŠ•å–‚ ${remainingDonateModelscope} ä¸ªï¼‰`;
            donateBtn.className = 'w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3';
            keysInput.disabled = false;
            keysInput.className = 'w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm resize-none';
          }

          // å¤„ç† iFlow æŠ•å–‚çŠ¶æ€
          const donateIflowBtn = document.getElementById('donateIflowBtn');
          const donateIflowWarning = document.getElementById('donateIflowWarning');
          const donatedIflowToday = document.getElementById('donatedIflowToday');
          const iflowKeysInput = document.getElementById('iflowKeysInput');
          
          const todayDonateIflow = data.data.today_donate_iflow_count || 0;
          const maxDonateIflow = data.data.max_daily_donate_iflow || 1;
          const remainingDonateIflow = data.data.remaining_donate_iflow || 0;
          
          // æ›´æ–°æŠ•å–‚é™åˆ¶è¯´æ˜
          donateIflowWarning.querySelector('span').innerHTML = `<strong>æ¯å¤©å¯ä»¥æŠ•å–‚ ${maxDonateIflow} ä¸ª</strong>`;
          
          if (remainingDonateIflow <= 0) {
            // ä»Šæ—¥å·²è¾¾ä¸Šé™
            donateIflowWarning.classList.add('hidden');
            donatedIflowToday.classList.remove('hidden');
            donatedIflowToday.querySelector('span').innerHTML = `âœ“ <strong>ä»Šæ—¥å·²æŠ•å–‚ ${todayDonateIflow}/${maxDonateIflow} ä¸ª</strong>`;
            donateIflowBtn.disabled = true;
            donateIflowBtn.textContent = 'âœ“ ä»Šæ—¥å·²æŠ•å–‚';
            donateIflowBtn.className = 'w-full bg-slate-400 text-white py-2.5 rounded-lg font-semibold cursor-not-allowed text-sm mb-3';
            iflowKeysInput.disabled = true;
            iflowKeysInput.className = 'w-full h-24 px-3 py-2 border border-slate-200 rounded-lg mb-3 font-mono text-sm bg-slate-50 cursor-not-allowed resize-none';
          } else {
            // å¯ä»¥ç»§ç»­æŠ•å–‚
            donateIflowWarning.classList.remove('hidden');
            donatedIflowToday.classList.add('hidden');
            donateIflowBtn.disabled = false;
            donateIflowBtn.textContent = `ğŸš€ æäº¤ iFlow Keyï¼ˆè¿˜å¯æŠ•å–‚ ${remainingDonateIflow} ä¸ªï¼‰`;
            donateIflowBtn.className = 'w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-2.5 rounded-lg font-semibold hover:shadow-lg transition-all text-sm mb-3';
            iflowKeysInput.disabled = false;
            iflowKeysInput.className = 'w-full h-24 px-3 py-2 border border-slate-300 rounded-lg mb-3 focus:ring-2 focus:ring-emerald-500 focus:border-transparent font-mono text-sm resize-none';
          }
        } else if (res.status === 400) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('bindSection').classList.remove('hidden');
        }
      } catch (e) {
        console.error('åŠ è½½é¢åº¦å¤±è´¥', e);
      }
    }

    async function claimQuota() {
      const btn = document.getElementById('claimBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> é¢†å–ä¸­...';

      try {
        const res = await fetch('/api/claim/daily', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          await loadQuota();
        } else {
          showToast(data.message, 'error');
          btn.disabled = false;
          btn.textContent = originalText;
        }
      } catch (e) {
        showToast('é¢†å–å¤±è´¥', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function donateKeys() {
      const keysText = document.getElementById('keysInput').value.trim();
      if (!keysText) {
        showToast('è¯·è¾“å…¥ Keys', 'error');
        return;
      }

      const keys = keysText.split('\n').map(k => k.trim()).filter(k => k);
      if (keys.length === 0) {
        showToast('æ²¡æœ‰æœ‰æ•ˆçš„ Key', 'error');
        return;
      }

      // æç¤ºï¼šæ¯å¤©åªèƒ½æäº¤1ä¸ªKey
      if (keys.length > 1) {
        showToast('æ¯å¤©åªèƒ½æäº¤ 1 ä¸ª Keyï¼Œå·²è‡ªåŠ¨æå–ç¬¬ä¸€ä¸ª', 'error');
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> éªŒè¯ä¸­...';

      try {
        const res = await fetch('/api/donate/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys }),
        });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          if (data.show_thanks) {
            setTimeout(() => showThankYouToast(), 500);
          }
          document.getElementById('keysInput').value = '';
          await loadQuota();
          
          // âœ… å¦‚æœæŠ•å–‚æˆåŠŸå¹¶è¿”å›äº†å…è´¹æ¬¡æ•°ï¼Œæ˜¾ç¤ºæç¤º
          if (data.free_spins !== undefined) {
            setTimeout(() => {
              showToast(`ğŸ æŠ•å–‚æˆåŠŸï¼è·å¾—1æ¬¡å…è´¹æŠ½å¥–æœºä¼šï¼ˆå½“å‰å…±${data.free_spins}æ¬¡ï¼‰`, 'success');
            }, 1500);
            
            // å¦‚æœè€è™æœºç•Œé¢å·²æ‰“å¼€ï¼Œåˆ·æ–°é…ç½®
            const slotModal = document.getElementById('slotModal');
            if (slotModal && !slotModal.classList.contains('hidden')) {
              try {
                const configRes = await fetch('/api/slot/config');
                const configData = await configRes.json();
                if (configData.success) {
                  slotUserData = configData.data.user;
                  updateSlotUI();
                }
              } catch (error) {
                console.error('[å…è´¹æ¬¡æ•°åŒæ­¥å¤±è´¥]', error);
              }
            }
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (e) {
        showToast('æäº¤å¤±è´¥', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function donateIflowKeys() {
      const keysText = document.getElementById('iflowKeysInput').value.trim();
      if (!keysText) {
        showToast('è¯·è¾“å…¥ iFlow Keys', 'error');
        return;
      }

      const keys = keysText.split('\n').map(k => k.trim()).filter(k => k);
      if (keys.length === 0) {
        showToast('æ²¡æœ‰æœ‰æ•ˆçš„ iFlow Key', 'error');
        return;
      }

      // æç¤ºï¼šæ¯å¤©åªèƒ½æäº¤1ä¸ªKey
      if (keys.length > 1) {
        showToast('æ¯å¤©åªèƒ½æäº¤ 1 ä¸ª iFlow Keyï¼Œå·²è‡ªåŠ¨æå–ç¬¬ä¸€ä¸ª', 'error');
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner inline-block"></div> éªŒè¯ä¸­...';

      try {
        const res = await fetch('/api/donate/iflow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys }),
        });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          if (data.show_thanks) {
            setTimeout(() => showThankYouToast(), 500);
          }
          document.getElementById('iflowKeysInput').value = '';
          await loadQuota();
          
          // âœ… å¦‚æœæŠ•å–‚æˆåŠŸå¹¶è¿”å›äº†å…è´¹æ¬¡æ•°ï¼Œæ˜¾ç¤ºæç¤º
          if (data.free_spins !== undefined) {
            setTimeout(() => {
              showToast(`ğŸ iFlowæŠ•å–‚æˆåŠŸï¼è·å¾—1æ¬¡å…è´¹æŠ½å¥–æœºä¼šï¼ˆå½“å‰å…±${data.free_spins}æ¬¡ï¼‰`, 'success');
            }, 1500);
            
            // å¦‚æœè€è™æœºç•Œé¢å·²æ‰“å¼€ï¼Œåˆ·æ–°é…ç½®
            const slotModal = document.getElementById('slotModal');
            if (slotModal && !slotModal.classList.contains('hidden')) {
              try {
                const configRes = await fetch('/api/slot/config');
                const configData = await configRes.json();
                if (configData.success) {
                  slotUserData = configData.data.user;
                  updateSlotUI();
                }
              } catch (error) {
                console.error('[å…è´¹æ¬¡æ•°åŒæ­¥å¤±è´¥]', error);
              }
            }
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (e) {
        showToast('æäº¤å¤±è´¥', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function showMessage(text, type, section = 'main') {
      const msgId = section === 'bind' ? 'bindMessage' : 'message';
      const msg = document.getElementById(msgId);
      msg.textContent = text;
      msg.className = `p-4 rounded-lg mb-4 ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    async function showMyRecords() {
      // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');
      
      document.getElementById('recordsModal').classList.remove('hidden');
      await loadMyRecords();
    }

    async function loadMyRecords() {
      try {
        const [claimRes, donateRes] = await Promise.all([
          fetch('/api/user/records/claim'),
          fetch('/api/user/records/donate')
        ]);
        const claimData = await claimRes.json();
        const donateData = await donateRes.json();

        const claimContainer = document.getElementById('claimRecords');
        const donateContainer = document.getElementById('donateRecords');

        // æ¸²æŸ“é¢†å–è®°å½•
        if (claimData.success && claimData.data.length > 0) {
          claimContainer.innerHTML = claimData.data.map(r => {
            const quotaUSD = (r.quota_added / 500000).toFixed(2);
            const isBindingBonus = r.quota_added === 50000000; // ç»‘å®šå¥–åŠ±æ˜¯ $100

            const typeLabel = isBindingBonus
              ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-semibold">ğŸ ç»‘å®šå¥–åŠ±</span>'
              : '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">ğŸ“… æ¯æ—¥é¢†å–</span>';

            return `
              <div class="border-b border-slate-200 py-3">
                <div class="flex items-center justify-between mb-1">
                  <p class="text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</p>
                  ${typeLabel}
                </div>
                <p class="font-semibold text-slate-900">é¢†å–é¢åº¦: <span class="text-lg text-green-600">$${quotaUSD}</span></p>
              </div>
            `;
          }).join('');
        } else {
          claimContainer.innerHTML = '<p class="text-center text-slate-500 py-8">æš‚æ— é¢†å–è®°å½•</p>';
        }

        // æ¸²æŸ“æŠ•å–‚è®°å½•
        if (donateData.success && donateData.data.length > 0) {
          donateContainer.innerHTML = donateData.data.map(r => {
            const keyTypeLabel = r.key_type === 'iflow'
              ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold">âœ¨ iFlow</span>'
              : '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">ğŸ ModelScope</span>';

            return `
              <div class="border-b border-slate-200 py-3">
                <div class="flex items-center justify-between mb-1">
                  <p class="text-sm text-slate-600">${new Date(r.timestamp).toLocaleString('zh-CN', { hour12: false })}</p>
                  ${keyTypeLabel}
                </div>
                <p class="font-semibold text-slate-900">æŠ•å–‚ ${r.keys_count} ä¸ª Keyï¼Œå¢åŠ é¢åº¦: <span class="text-lg text-green-600">$${(r.total_quota_added / 500000).toFixed(2)}</span></p>
              </div>
            `;
          }).join('');
        } else {
          donateContainer.innerHTML = '<p class="text-center text-slate-500 py-8">æš‚æ— æŠ•å–‚è®°å½•</p>';
        }
      } catch (e) {
        console.error('åŠ è½½è®°å½•å¤±è´¥', e);
      }
    }

    function closeModal() {
      document.getElementById('recordsModal').classList.add('hidden');
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-600', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-slate-500');
      });
      event.target.classList.add('border-indigo-600', 'text-indigo-600');
      event.target.classList.remove('border-transparent', 'text-slate-500');

      if (tab === 'claim') {
        document.getElementById('claimRecords').classList.remove('hidden');
        document.getElementById('donateRecords').classList.add('hidden');
      } else {
        document.getElementById('claimRecords').classList.add('hidden');
        document.getElementById('donateRecords').classList.remove('hidden');
      }
    }

    async function logout() {
      if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.reload();
      } catch (e) {
        showToast('ç™»å‡ºå¤±è´¥', 'error');
      }
    }

    // ========== è€è™æœºç›¸å…³åŠŸèƒ½ ==========

    const SLOT_SYMBOLS = ['m', 't', 'n', 'j', 'lq', 'bj', 'zft', 'bdk', 'lsh', 'man'];
    let slotConfig = null;
    let slotUserData = null;
    let isSpinning = false;
    
    // ğŸ”¥ é«˜çº§åœºç›¸å…³å˜é‡
    let advancedTicketsData = null;  // å…¥åœºåˆ¸å’Œç¢ç‰‡æ•°æ®
    let advancedModeTimer = null;    // é«˜çº§åœºå€’è®¡æ—¶å®šæ—¶å™¨
    let isInAdvancedMode = false;    // æ˜¯å¦åœ¨é«˜çº§åœº
    let advancedBetAmount = 100;     // é«˜çº§åœºæŠ•æ³¨é‡‘é¢ï¼ˆç¾å…ƒï¼Œé»˜è®¤$100ï¼‰
    let advancedBetMin = 100;        // é«˜çº§åœºæœ€å°æŠ•æ³¨
    let advancedBetMax = 500;        // é«˜çº§åœºæœ€å¤§æŠ•æ³¨
    
    // ğŸ’ è‡³å°Šåœºç›¸å…³å˜é‡
    let supremeTokensData = null;    // è‡³å°Šä»¤ç‰Œå’Œç¢ç‰‡æ•°æ®
    let supremeModeTimer = null;     // è‡³å°Šåœºå€’è®¡æ—¶å®šæ—¶å™¨
    let isInSupremeMode = false;     // æ˜¯å¦åœ¨è‡³å°Šåœº
    let supremeBetAmount = 1000;     // è‡³å°ŠåœºæŠ•æ³¨é‡‘é¢ï¼ˆå¤å¸ï¼Œé»˜è®¤1000ï¼‰
    let supremeBetMin = 1000;        // è‡³å°Šåœºæœ€å°æŠ•æ³¨
    let supremeBetMax = 10000;       // è‡³å°Šåœºæœ€å¤§æŠ•æ³¨

    // ğŸ”¥ åŠ¨æ€ç”ŸæˆæŠ•æ³¨é€‰é¡¹æŒ‰é’®
    function generateAdvancedBetOptions(minBet, maxBet) {
      const container = document.getElementById('advancedBetOptions');
      if (!container) return;
      
      // æ¸…ç©ºç°æœ‰æŒ‰é’®
      container.innerHTML = '';
      
      // è®¡ç®—åˆé€‚çš„é€‰é¡¹ï¼ˆå‡åŒ€åˆ†å¸ƒ4ä¸ªé€‰é¡¹ï¼‰
      const range = maxBet - minBet;
      const options = [];
      
      if (range <= 100) {
        // èŒƒå›´å¾ˆå°ï¼Œç›´æ¥ä½¿ç”¨æœ€å°å’Œæœ€å¤§å€¼
        options.push(minBet, maxBet);
      } else if (range <= 400) {
        // ä¸­ç­‰èŒƒå›´ï¼Œç”Ÿæˆ3-4ä¸ªé€‰é¡¹
        options.push(minBet);
        const step = Math.floor(range / 3);
        options.push(minBet + step);
        options.push(minBet + step * 2);
        options.push(maxBet);
      } else {
        // å¤§èŒƒå›´ï¼Œç”Ÿæˆ4ä¸ªå‡åŒ€åˆ†å¸ƒçš„é€‰é¡¹
        const step = Math.floor(range / 3);
        options.push(minBet);
        options.push(minBet + step);
        options.push(minBet + step * 2);
        options.push(maxBet);
      }
      
      // å»é‡å¹¶æ’åº
      const uniqueOptions = [...new Set(options)].sort((a, b) => a - b);
      
      // ç”ŸæˆæŒ‰é’®
      uniqueOptions.forEach(amount => {
        const button = document.createElement('button');
        button.onclick = () => setAdvancedBet(amount);
        button.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        button.setAttribute('data-amount', amount);
        button.textContent = `$${amount}`;
        container.appendChild(button);
      });
      
      // console.log('[é«˜çº§åœº] åŠ¨æ€ç”ŸæˆæŠ•æ³¨é€‰é¡¹:', uniqueOptions);
    }
    
    // ğŸ”¥ è®¾ç½®é«˜çº§åœºæŠ•æ³¨é‡‘é¢
    function setAdvancedBet(amount) {
      advancedBetAmount = amount;
      document.getElementById('advancedBetSlider').value = amount;
      document.getElementById('advancedBetDisplay').textContent = `$${amount}`;
      
      // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
      document.querySelectorAll('.advanced-bet-option').forEach(btn => {
        if (parseInt(btn.dataset.amount) === amount) {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-lg font-bold transition-all shadow-lg text-sm';
        } else {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        }
      });
      
      // ğŸ”¥ æ›´æ–°æŠ•æ³¨æŒ‰é’®çŠ¶æ€
      updateAdvancedSpinButtonState();
      
      // console.log('[é«˜çº§åœº] æŠ•æ³¨é‡‘é¢è®¾ç½®ä¸º:', amount);
    }

    // ğŸ”¥ æ›´æ–°æŠ•æ³¨é‡‘é¢æ˜¾ç¤ºï¼ˆæ»‘å—ï¼‰
    function updateAdvancedBetDisplay(value) {
      advancedBetAmount = parseInt(value);
      document.getElementById('advancedBetDisplay').textContent = `$${value}`;
      
      // æ›´æ–°æŒ‰é’®é«˜äº®ï¼ˆåªæœ‰ç²¾ç¡®åŒ¹é…çš„æ‰é«˜äº®ï¼‰
      const presets = [100, 200, 300, 500];
      
      document.querySelectorAll('.advanced-bet-option').forEach(btn => {
        const amount = parseInt(btn.dataset.amount);
        if (amount === advancedBetAmount) {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-lg font-bold transition-all shadow-lg text-sm';
        } else {
          btn.className = 'advanced-bet-option px-4 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg font-bold transition-all text-sm';
        }
      });
      
      // ğŸ”¥ æ›´æ–°æŠ•æ³¨æŒ‰é’®çŠ¶æ€
      updateAdvancedSpinButtonState();
    }

    // ğŸ”¥ æ›´æ–°é«˜çº§åœºæŠ•æ³¨æŒ‰é’®çŠ¶æ€ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
    function updateAdvancedSpinButtonState() {
      if (!isInAdvancedMode || !slotUserData) return;
      
      const advSpinBtn = document.getElementById('advancedSpinButton');
      if (!advSpinBtn) return;
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦æ­¢
      if (slotUserData.is_banned) {
        advSpinBtn.disabled = true;
        // console.log('[é«˜çº§åœº] æŠ•æ³¨æŒ‰é’®ç¦ç”¨ï¼šç”¨æˆ·è¢«ç¦æ­¢');
        return;
      }
      
      // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤ŸæŠ•æ³¨
      const requiredQuota = advancedBetAmount * 500000;
      if (slotUserData.quota >= requiredQuota) {
        advSpinBtn.disabled = false;
        // console.log('[é«˜çº§åœº] æŠ•æ³¨æŒ‰é’®å·²å¯ç”¨');
      } else {
        advSpinBtn.disabled = true;
        // console.log('[é«˜çº§åœº] æŠ•æ³¨æŒ‰é’®ç¦ç”¨ï¼šä½™é¢ä¸è¶³ï¼Œéœ€è¦', requiredQuota, 'å½“å‰', slotUserData.quota);
      }
    }

    // ğŸ”¥ æ–°ç‰ˆï¼šæ›´æ–°æŠ•æ³¨é™é¢è¿›åº¦æ¡ï¼ˆæ”¯æŒä¸‰ä¸ªç‹¬ç«‹çš„è¿›åº¦æ¡ï¼‰
    function updateBetLimitProgressBar() {
      if (!slotUserData) {
        console.warn('[è¿›åº¦æ¡] slotUserData ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°');
        return;
      }
      
      if (isInSupremeMode) {
        // ğŸ’ è‡³å°Šåœºï¼šæ›´æ–°è‡³å°Šåœºè¿›åº¦æ¡
        updateProgressBarForMode('supreme');
      } else if (isInAdvancedMode) {
        // ğŸ”¥ é«˜çº§åœºï¼šæ›´æ–°é«˜çº§åœºè¿›åº¦æ¡
        updateProgressBarForMode('advanced');
      }
      // åˆçº§åœºä¸æ˜¾ç¤ºè¿›åº¦æ¡
    }
    
    // ğŸ”¥ æ›´æ–°æŒ‡å®šåœºæ¬¡çš„è¿›åº¦æ¡
    function updateProgressBarForMode(mode) {
      let progressText, progressBar, warningText, betLimit, todayBetAmount;
      
      if (mode === 'supreme') {
        progressText = document.getElementById('supremeDailyBetProgress');
        progressBar = document.getElementById('supremeDailyBetProgressBar');
        warningText = document.getElementById('supremeDailyBetWarning');
        betLimit = supremeTokensData?.config?.daily_bet_limit 
          ? supremeTokensData.config.daily_bet_limit / 500000 
          : 50000;
        todayBetAmount = (slotUserData.today_supreme_bet || 0) / 500000;
      } else if (mode === 'advanced') {
        progressText = document.getElementById('advancedDailyBetProgress');
        progressBar = document.getElementById('advancedDailyBetProgressBar');
        warningText = document.getElementById('advancedDailyBetWarning');
        betLimit = advancedTicketsData?.config?.daily_bet_limit 
          ? advancedTicketsData.config.daily_bet_limit / 500000 
          : 5000;
        todayBetAmount = (slotUserData.today_bet || 0) / 500000;
      }
      
      if (!progressText || !progressBar) return;
      
      const betPercentage = Math.min((todayBetAmount / betLimit) * 100, 100);
      
      progressText.textContent = `$${todayBetAmount.toFixed(2)} / $${betLimit.toLocaleString()}`;
      progressBar.style.width = `${betPercentage}%`;
      
      // æ ¹æ®è¿›åº¦æ”¹å˜é¢œè‰²
      if (betPercentage >= 100) {
        progressBar.className = 'h-full bg-gradient-to-r from-red-600 to-red-800 transition-all duration-300';
      } else if (betPercentage >= 80) {
        progressBar.className = 'h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-300';
      } else if (betPercentage >= 60) {
        progressBar.className = 'h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-300';
      } else {
        progressBar.className = 'h-full bg-gradient-to-r from-green-500 to-yellow-500 transition-all duration-300';
      }
      
      // æ˜¾ç¤ºè­¦å‘Š
      if (warningText) {
        if (betPercentage >= 80) {
          warningText.classList.remove('hidden');
          if (betPercentage >= 100) {
            warningText.textContent = 'â›” å·²è¾¾åˆ°æŠ•æ³¨é™é¢';
          } else {
            warningText.textContent = 'âš ï¸ æ¥è¿‘æŠ•æ³¨é™é¢';
          }
        } else {
          warningText.classList.add('hidden');
        }
      }
      
      console.log(`[è¿›åº¦æ¡] ${mode}åœºè¿›åº¦æ›´æ–°:`, `${betPercentage.toFixed(1)}%`);
    }
    
    // ğŸ”¥ åŠ è½½å…¥åœºåˆ¸ä¿¡æ¯
    async function loadAdvancedTickets() {
      try {
        const res = await fetch('/api/slot/tickets');
        const data = await res.json();
        
        if (data.success) {
          advancedTicketsData = data.data;
          updateAdvancedTicketsUI();
          // console.log('[é«˜çº§åœº] å…¥åœºåˆ¸ä¿¡æ¯:', advancedTicketsData);
        }
      } catch (error) {
        console.error('[é«˜çº§åœº] åŠ è½½å…¥åœºåˆ¸ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // ğŸ”¥ æ›´æ–°å…¥åœºåˆ¸UI
    function updateAdvancedTicketsUI() {
      if (!advancedTicketsData) return;
      
      const { tickets, fragments, can_synthesize, in_advanced_mode, fragments_needed, max_tickets_hold, config } = advancedTicketsData;
      
      // ğŸ”¥ é‡è¦ï¼šç«‹å³è®¾ç½®é«˜çº§åœºçŠ¶æ€ï¼Œé¿å…UIé—ªçƒ
      if (in_advanced_mode) {
        isInAdvancedMode = true;
        startAdvancedModeTimer();
      } else {
        isInAdvancedMode = false;
        stopAdvancedModeTimer();
      }
      
      // æ›´æ–°æ•°æ®æ˜¾ç¤º
      document.getElementById('ticketCount').textContent = tickets;
      document.getElementById('ticketMax').textContent = max_tickets_hold;
      document.getElementById('fragmentCount').textContent = fragments;
      document.getElementById('fragmentsNeeded').textContent = fragments_needed;
      
      // ğŸ”¥ æ›´æ–°æ¯æ—¥é™åˆ¶ä¿¡æ¯ï¼ˆå¦‚æœé…ç½®å­˜åœ¨ï¼‰
      if (config) {
        // æ˜¾ç¤ºæ¯æ—¥è¿›å…¥é™åˆ¶ä¿¡æ¯
        const dailyEntryInfo = document.getElementById('dailyEntryInfo');
        const dailyEntryLimit = document.getElementById('dailyEntryLimit');
        const todayEntryCount = document.getElementById('todayEntryCount');
        if (dailyEntryInfo && dailyEntryLimit && config.daily_entry_limit) {
          dailyEntryLimit.textContent = config.daily_entry_limit;
          // æ›´æ–°ä»Šæ—¥å·²è¿›å…¥æ¬¡æ•°
          if (todayEntryCount && advancedTicketsData.today_entry_count !== undefined) {
            todayEntryCount.textContent = advancedTicketsData.today_entry_count;
          }
          // åªåœ¨æœªè¿›å…¥é«˜çº§åœºæ—¶æ˜¾ç¤ºæ¯æ—¥è¿›å…¥æ¬¡æ•°ä¿¡æ¯
          if (!in_advanced_mode) {
            dailyEntryInfo.classList.remove('hidden');
          } else {
            dailyEntryInfo.classList.add('hidden');
          }
        }
        
        // æ˜¾ç¤ºæ¯æ—¥å…¥åœºåˆ¸è·å¾—é™åˆ¶ï¼ˆä½œä¸ºå·¥å…·æç¤ºï¼‰
        const dailyTicketGrantInfo = document.getElementById('dailyTicketGrantInfo');
        if (dailyTicketGrantInfo && config.daily_ticket_grant_limit) {
          const grantedText = advancedTicketsData.today_ticket_granted !== undefined 
            ? `(ä»Šæ—¥å·²è·${advancedTicketsData.today_ticket_granted}/${config.daily_ticket_grant_limit}å¼ )`
            : `(æ¯æ—¥é™${config.daily_ticket_grant_limit}å¼ )`;
          dailyTicketGrantInfo.textContent = grantedText;
          dailyTicketGrantInfo.classList.remove('hidden');
        }
      }
      
      // æ›´æ–°è¿‡æœŸæ—¶é—´
      const expiryEl = document.getElementById('ticketExpiry');
      if (advancedTicketsData.tickets_expires_at && tickets > 0) {
        const expiryDate = new Date(advancedTicketsData.tickets_expires_at);
        expiryEl.textContent = `è¿‡æœŸ: ${expiryDate.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
      } else {
        expiryEl.textContent = '';
      }
      
      // ğŸ”¥ æ›´æ–°åˆæˆæŒ‰é’®çŠ¶æ€ï¼ˆè€ƒè™‘ä»Šæ—¥è·å¾—é™é¢ï¼‰
      const synthesizeBtn = document.getElementById('synthesizeButton');
      const todayGranted = advancedTicketsData.today_ticket_granted || 0;
      const dailyLimit = config?.daily_ticket_grant_limit || 2;
      
      // å¯ä»¥åˆæˆçš„æ¡ä»¶ï¼š
      // 1. ç¢ç‰‡è¶³å¤Ÿ (can_synthesize)
      // 2. æœªè¾¾æŒæœ‰ä¸Šé™ (tickets < max_tickets_hold)
      // 3. ğŸ”¥ ä»Šæ—¥è·å¾—æœªè¾¾é™é¢ (todayGranted < dailyLimit)
      if (can_synthesize && tickets < max_tickets_hold && todayGranted < dailyLimit) {
        synthesizeBtn.disabled = false;
        synthesizeBtn.title = 'ç‚¹å‡»åˆæˆå…¥åœºåˆ¸';
      } else {
        synthesizeBtn.disabled = true;
        
        // ğŸ”¥ æ ¹æ®ä¸åŒåŸå› æ˜¾ç¤ºæç¤º
        if (!can_synthesize) {
          synthesizeBtn.title = `ç¢ç‰‡ä¸è¶³ï¼ˆéœ€è¦${fragments_needed}ä¸ªï¼‰`;
        } else if (tickets >= max_tickets_hold) {
          synthesizeBtn.title = `å·²è¾¾æŒæœ‰ä¸Šé™ï¼ˆ${max_tickets_hold}å¼ ï¼‰`;
        } else if (todayGranted >= dailyLimit) {
          synthesizeBtn.title = `ä»Šæ—¥è·å¾—å·²è¾¾ä¸Šé™ï¼ˆ${dailyLimit}å¼ ï¼‰`;
        }
      }
      
      // æ›´æ–°è¿›å…¥é«˜çº§åœºæŒ‰é’®çŠ¶æ€
      const enterBtn = document.getElementById('enterAdvancedButton');
      enterBtn.disabled = tickets < 1;
      
      // ğŸ”¥ åŒæ­¥æ•°æ®åˆ°å¯¼èˆªæ å¡ç‰‡ - å·²ç§»é™¤
      // const ticketCountNav = document.getElementById('ticketCountNav');
      // const fragmentCountNav = document.getElementById('fragmentCountNav');
      // const synthesizeButtonNav = document.getElementById('synthesizeButtonNav');
      // const enterAdvancedButtonNav = document.getElementById('enterAdvancedButtonNav');
      // 
      // if (ticketCountNav) ticketCountNav.textContent = tickets;
      // if (fragmentCountNav) fragmentCountNav.textContent = fragments;
      // 
      // // æ›´æ–°å¯¼èˆªæ æŒ‰é’®çŠ¶æ€
      // if (synthesizeButtonNav) {
      //   synthesizeButtonNav.disabled = !can_synthesize || tickets >= max_tickets_hold || todayGranted >= dailyLimit;
      // }
      // if (enterAdvancedButtonNav) {
      //   enterAdvancedButtonNav.disabled = tickets < 1;
      // }
      
      // ğŸ¯ æ”¹è¿›ï¼šæ˜¾ç¤º/éšè—å…¥åœºåˆ¸æ å’Œé«˜çº§åœºæŒ‡ç¤ºå™¨
      const ticketBar = document.getElementById('advancedTicketBar');
      const modeIndicator = document.getElementById('advancedModeIndicator');  // ğŸ”¥ å¯¼èˆªæ å³ä¸Šè§’çš„æŒ‡ç¤ºå™¨
      const betSelector = document.getElementById('advancedBetSelector');
      const freeSpinButton = document.getElementById('freeSpinButton');
      const normalSpinButton = document.getElementById('spinButton');
      
      if (in_advanced_mode) {
        // console.log('[é«˜çº§åœº] æ›´æ–°UIä¸ºé«˜çº§åœºæ¨¡å¼');
        // ğŸ”¥ ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡ï¼šå…ˆéšè—åˆçº§åœºå…ƒç´ 
        const normalSpinsDisplay = document.getElementById('normalModeSpinsDisplay');
        const normalTitle = document.getElementById('normalModeTitle');
        const advancedTitle = document.getElementById('advancedModeTitle');
        const supremeBar = document.getElementById('supremeTokenBar');
        
        // å…ˆè®¾ç½®åˆçº§åœºå…ƒç´ ä¸ºå¹³æ»‘éšè—
        if (normalSpinsDisplay) {
          normalSpinsDisplay.classList.add('smooth-hide');
          setTimeout(() => normalSpinsDisplay.classList.add('hidden'), 300);
        }
        if (normalTitle) {
          normalTitle.classList.add('smooth-hide');
          setTimeout(() => normalTitle.classList.add('hidden'), 300);
        }
        if (freeSpinButton) {
          freeSpinButton.classList.add('smooth-hide');
          setTimeout(() => freeSpinButton.classList.add('hidden'), 300);
        }
        if (normalSpinButton) {
          normalSpinButton.classList.add('smooth-hide');
          setTimeout(() => normalSpinButton.classList.add('hidden'), 300);
        }
        
        // éšè—å…¥åœºåˆ¸æ 
        ticketBar.classList.add('smooth-hide');
        setTimeout(() => ticketBar.classList.add('hidden'), 300);
        
        // å»¶è¿Ÿæ˜¾ç¤ºé«˜çº§åœºå…ƒç´ ï¼ˆç­‰å¾…åˆçº§åœºå…ƒç´ éšè—ï¼‰
        setTimeout(() => {
          modeIndicator.classList.remove('hidden');
          betSelector.classList.remove('hidden');
          if (advancedTitle) advancedTitle.classList.remove('hidden');
          
          // ğŸ”¥ åœ¨é«˜çº§åœºæ¨¡å¼ä¸‹æ˜¾ç¤ºè‡³å°Šåœºä»¤ç‰Œæ 
          if (supremeBar) {
            supremeBar.classList.remove('hidden');
          }
          
          // è§¦å‘å¹³æ»‘æ˜¾ç¤º
          requestAnimationFrame(() => {
            modeIndicator.classList.add('smooth-show');
            betSelector.classList.add('smooth-show');
            if (advancedTitle) advancedTitle.classList.add('smooth-show');
            if (supremeBar) supremeBar.classList.add('smooth-show');
          });
        }, 150);
        
        // ğŸ”¥ ä»é«˜çº§åœºçŠ¶æ€ä¸­è·å–æŠ•æ³¨èŒƒå›´å¹¶åŠ¨æ€ç”Ÿæˆé€‰é¡¹
        if (advancedTicketsData.config) {
          advancedBetMin = advancedTicketsData.config.bet_min / 500000;
          advancedBetMax = advancedTicketsData.config.bet_max / 500000;
          
          // ğŸ”¥ åŠ¨æ€ç”ŸæˆæŠ•æ³¨é€‰é¡¹æŒ‰é’®
          generateAdvancedBetOptions(advancedBetMin, advancedBetMax);
          
          // æ›´æ–°æ»‘å—èŒƒå›´å’Œæ­¥é•¿
          const slider = document.getElementById('advancedBetSlider');
          slider.min = advancedBetMin;
          slider.max = advancedBetMax;
          // åŠ¨æ€è®¡ç®—åˆé€‚çš„æ­¥é•¿
          const range = advancedBetMax - advancedBetMin;
          slider.step = range <= 100 ? 5 : (range <= 500 ? 10 : 50);
          
          // å¦‚æœå½“å‰æŠ•æ³¨è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®ä¸ºæœ€å°å€¼
          if (advancedBetAmount < advancedBetMin || advancedBetAmount > advancedBetMax) {
            setAdvancedBet(advancedBetMin);
          }
          
          // console.log(`[é«˜çº§åœº] æŠ•æ³¨èŒƒå›´: $${advancedBetMin} ~ $${advancedBetMax}, æ­¥é•¿: ${slider.step}`);
        }
        
        // ğŸ”¥ ç«‹å³æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤ºï¼ˆç¡®ä¿é«˜çº§åœºè¿›åº¦æ¡æ˜¾ç¤ºï¼‰
        updateBetLimitProgressBar();
        
        // ğŸ”¥ æ›´æ–°æŠ•æ³¨æŒ‰é’®çŠ¶æ€ï¼ˆç¡®ä¿æŒ‰é’®åœ¨è¿›å…¥é«˜çº§åœºåæ­£ç¡®å¯ç”¨ï¼‰
        updateAdvancedSpinButtonState();
      } else {
        // ä¸åœ¨é«˜çº§åœºï¼šå¸¸é©»æ˜¾ç¤ºå…¥åœºåˆ¸æ ï¼Œéšè—é«˜çº§åœºæŒ‡ç¤ºå™¨å’ŒæŠ•æ³¨é€‰æ‹©å™¨
        // ğŸ”¥ ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡ï¼šå…ˆéšè—é«˜çº§åœºå…ƒç´ 
        const normalSpinsDisplay = document.getElementById('normalModeSpinsDisplay');
        const normalTitle = document.getElementById('normalModeTitle');
        const advancedTitle = document.getElementById('advancedModeTitle');
        const supremeBar = document.getElementById('supremeTokenBar');
        
        // å…ˆè®¾ç½®é«˜çº§åœºå…ƒç´ ä¸ºå¹³æ»‘éšè—
        modeIndicator.classList.add('smooth-hide');
        betSelector.classList.add('smooth-hide');
        if (advancedTitle) advancedTitle.classList.add('smooth-hide');
        
        // ğŸ”¥ é€€å‡ºé«˜çº§åœºæ—¶ä¹Ÿéšè—è‡³å°Šåœºä»¤ç‰Œæ 
        if (supremeBar && !isInSupremeMode) {
          supremeBar.classList.add('smooth-hide');
        }
        
        setTimeout(() => {
          modeIndicator.classList.add('hidden');
          betSelector.classList.add('hidden');
          if (advancedTitle) advancedTitle.classList.add('hidden');
          if (supremeBar && !isInSupremeMode) supremeBar.classList.add('hidden');
        }, 300);
        
        // å»¶è¿Ÿæ˜¾ç¤ºåˆçº§åœºå…ƒç´ ï¼ˆç­‰å¾…é«˜çº§åœºå…ƒç´ éšè—ï¼‰
        setTimeout(() => {
          ticketBar.classList.remove('hidden');
          if (normalSpinsDisplay) normalSpinsDisplay.classList.remove('hidden');
          if (normalTitle) normalTitle.classList.remove('hidden');
          // ğŸ”¥ ä¿®å¤ï¼šåªæœ‰åœ¨æœ‰å…è´¹æ¬¡æ•°æ—¶æ‰æ˜¾ç¤º free spin æŒ‰é’®
          if (freeSpinButton) {
            // ç¡®ä¿æ•°æ®å·²åŠ è½½ä¸”æœ‰å…è´¹æ¬¡æ•°
            if (slotUserData && slotUserData.free_spins > 0) {
              freeSpinButton.classList.remove('hidden');
            } else {
              // å¦‚æœæ²¡æœ‰æ•°æ®æˆ–æ²¡æœ‰å…è´¹æ¬¡æ•°ï¼Œç¡®ä¿æŒ‰é’®éšè—
              freeSpinButton.classList.add('hidden');
            }
          }
          normalSpinButton.classList.remove('hidden');
          
          // è§¦å‘å¹³æ»‘æ˜¾ç¤º
          requestAnimationFrame(() => {
            ticketBar.classList.add('smooth-show');
            if (normalSpinsDisplay) normalSpinsDisplay.classList.add('smooth-show');
            if (normalTitle) normalTitle.classList.add('smooth-show');
            // ğŸ”¥ ä¿®å¤ï¼šåªæœ‰åœ¨æœ‰å…è´¹æ¬¡æ•°æ—¶æ‰æ·»åŠ å¹³æ»‘æ˜¾ç¤ºæ•ˆæœ
            if (freeSpinButton && slotUserData && slotUserData.free_spins > 0) {
              freeSpinButton.classList.add('smooth-show');
            }
            normalSpinButton.classList.add('smooth-show');
          });
        }, 150);
        
        // ğŸ”¥ æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤ºï¼ˆç¡®ä¿åˆçº§åœºè¿›åº¦æ¡éšè—ï¼‰
        updateBetLimitProgressBar();
      }
      
      // ğŸ¯ å»¶è¿Ÿè°ƒç”¨ç»Ÿä¸€æ›´æ–°å‡½æ•°ï¼Œç¡®ä¿æœ€ç»ˆçŠ¶æ€æ­£ç¡®ï¼ˆç­‰å¾…åŠ¨ç”»å®Œæˆï¼‰
      setTimeout(() => {
        updateGameRulesButton();
      }, 400);
    }

    // ğŸ”¥ åˆæˆå…¥åœºåˆ¸
    async function synthesizeTicket() {
      if (!advancedTicketsData || !advancedTicketsData.can_synthesize) {
        showToast('ç¢ç‰‡ä¸è¶³ï¼Œæ— æ³•åˆæˆ', 'error');
        return;
      }
      
      const btn = document.getElementById('synthesizeButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ åˆæˆä¸­...';
      
      try {
        const res = await fetch('/api/slot/tickets/synthesize', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          // åˆ·æ–°å…¥åœºåˆ¸ä¿¡æ¯
          await loadAdvancedTickets();
          
          // ğŸ‰ åˆæˆæˆåŠŸç‰¹æ•ˆ
          playTicketSynthesizeAnimation();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[é«˜çº§åœº] åˆæˆå¤±è´¥:', error);
        showToast('åˆæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // ğŸ”¥ è¿›å…¥é«˜çº§åœº
    async function enterAdvancedMode() {
      // console.log('[é«˜çº§åœº] å°è¯•è¿›å…¥é«˜çº§åœº...');
      if (!advancedTicketsData || advancedTicketsData.tickets < 1) {
        showToast('å…¥åœºåˆ¸ä¸è¶³', 'error');
        return;
      }
      
      const btn = document.getElementById('enterAdvancedButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ è¿›å…¥ä¸­...';
      
      try {
        const res = await fetch('/api/slot/advanced/enter', {
          method: 'POST'
        });
        const data = await res.json();
        // console.log('[é«˜çº§åœº] è¿›å…¥é«˜çº§åœºå“åº”:', data);
        
        if (data.success) {
          showToast('ğŸ”¥ ' + data.message, 'success');

          // ğŸ”¥ ç«‹å³è®¾ç½®é«˜çº§åœºçŠ¶æ€
          isInAdvancedMode = true;

          // ğŸ”¥ å¹¶è¡ŒåŠ è½½é…ç½®å’Œå…¥åœºåˆ¸ä¿¡æ¯
          const [configRes, _] = await Promise.all([
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // è¿™ä¼šè°ƒç”¨ updateAdvancedTicketsUI
          ]);

          // ğŸ”¥ ä¿å­˜åŠ è½½çš„é…ç½®æ•°æ®
          if (configRes && configRes.success) {
            slotConfig = configRes.data.config;
            slotUserData = configRes.data.user;
          }

          // ğŸ”¥ ç­‰å¾…ä¸‹ä¸€å¸§ï¼Œç¡®ä¿ updateAdvancedTicketsUI å®Œå…¨æ‰§è¡Œå®Œæ¯•
          await new Promise(resolve => requestAnimationFrame(resolve));

          // ğŸ”¥ å¼ºåˆ¶ç¡®ä¿é«˜çº§åœºçŠ¶æ€ä¸ºtrueï¼ˆé˜²æ­¢ç«æ€æ¡ä»¶è¦†ç›–ï¼‰
          console.log('[enterAdvancedMode] ç¡®è®¤è¿›å…¥çŠ¶æ€ - isInAdvancedMode:', isInAdvancedMode);
          isInAdvancedMode = true;

          // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘
          switchToModeContainer('advanced');
          updateSlotUI();
          updateBetLimitProgressBar();
          
          // ğŸ”¥ å¼ºåˆ¶æ›´æ–°é«˜çº§åœºUIï¼ˆç¡®ä¿æ˜¾ç¤ºæ­£ç¡®ï¼‰
          if (advancedTicketsData) {
            updateAdvancedTicketsUI();
          }
          
          // ğŸ‰ è¿›å…¥é«˜çº§åœºç‰¹æ•ˆ
          playEnterAdvancedAnimation();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[é«˜çº§åœº] è¿›å…¥å¤±è´¥:', error);
        showToast('è¿›å…¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // ğŸ”¥ é€€å‡ºé«˜çº§åœº
    async function exitAdvancedMode() {
      if (!confirm('ç¡®å®šè¦é€€å‡ºé«˜çº§åœºå—ï¼Ÿ\né€€å‡ºåå°†è¿”å›åˆçº§åœºï¼Œéœ€è¦é‡æ–°ä½¿ç”¨å…¥åœºåˆ¸æ‰èƒ½è¿›å…¥ã€‚')) {
        return;
      }
      
      try {
        const res = await fetch('/api/slot/advanced/exit', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          
          // ğŸ”¥ ç«‹å³è®¾ç½®ä¸ºåˆçº§åœºçŠ¶æ€
          isInAdvancedMode = false;
          
          // ğŸ”¥ å¹¶è¡ŒåŠ è½½é…ç½®å’Œå…¥åœºåˆ¸ä¿¡æ¯
          const [configRes, _] = await Promise.all([
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // è¿™ä¼šè°ƒç”¨ updateAdvancedTicketsUI
          ]);
          
          // ğŸ”¥ ä¿å­˜åŠ è½½çš„é…ç½®æ•°æ®
          if (configRes && configRes.success) {
            slotConfig = configRes.data.config;
            slotUserData = configRes.data.user;
          }
          
          // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘
          switchToModeContainer('normal');
          updateSlotUI();
          
          // ğŸ”¥ å¼ºåˆ¶æ›´æ–°UIï¼ˆç¡®ä¿é€€å‡ºé«˜çº§åœºåUIæ­£ç¡®ï¼‰
          if (advancedTicketsData) {
            updateAdvancedTicketsUI();
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[é«˜çº§åœº] é€€å‡ºå¤±è´¥:', error);
        showToast('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // ğŸ”¥ å¯åŠ¨é«˜çº§åœºå€’è®¡æ—¶
    function startAdvancedModeTimer() {
      stopAdvancedModeTimer(); // å…ˆåœæ­¢æ—§çš„å®šæ—¶å™¨
      
      if (!advancedTicketsData || !advancedTicketsData.advanced_mode_until) return;
      
      const updateTimer = () => {
        const now = Date.now();
        const remaining = advancedTicketsData.advanced_mode_until - now;
        
        if (remaining <= 0) {
          // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨é€€å‡ºé«˜çº§åœº
          const timeEl = document.getElementById('advancedTimeRemaining');
          if (timeEl) timeEl.textContent = '00:00:00';
          stopAdvancedModeTimer();
          showToast('é«˜çº§åœºæ—¶é—´å·²åˆ°ï¼Œå·²è‡ªåŠ¨é€€å‡º', 'error');
          
          // ğŸ”¥ ç«‹å³è®¾ç½®ä¸ºåˆçº§åœºçŠ¶æ€
          isInAdvancedMode = false;
          
          // ğŸ”¥ å¹¶è¡Œåˆ·æ–°çŠ¶æ€å’Œé‡æ–°åŠ è½½é…ç½®
          Promise.all([
            loadAdvancedTickets(),  // è¿™ä¼šè°ƒç”¨ updateAdvancedTicketsUI
            fetch('/api/slot/config').then(res => res.json())
          ]).then(([_, configData]) => {
            if (configData && configData.success) {
              slotConfig = configData.data.config;
              slotUserData = configData.data.user;
            }
            
            // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘
            switchToModeContainer('normal');
            updateSlotUI();
            
            // ğŸ”¥ å¼ºåˆ¶æ›´æ–°UIï¼ˆç¡®ä¿é€€å‡ºé«˜çº§åœºåUIæ­£ç¡®ï¼‰
            if (advancedTicketsData) {
              updateAdvancedTicketsUI();
            }
          }).catch(error => {
            console.error('[é«˜çº§åœº] è‡ªåŠ¨é€€å‡ºæ—¶é‡æ–°åŠ è½½é…ç½®å¤±è´¥:', error);
          });
          
          return;
        }
        
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // ğŸ”¥ æ›´æ–°å¯¼èˆªæ ä¸­çš„å€’è®¡æ—¶
        const timeEl = document.getElementById('advancedTimeRemaining');
        if (timeEl) timeEl.textContent = timeStr;
      };
      
      updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
      advancedModeTimer = setInterval(updateTimer, 1000);
    }

    // ğŸ”¥ åœæ­¢é«˜çº§åœºå€’è®¡æ—¶
    function stopAdvancedModeTimer() {
      if (advancedModeTimer) {
        clearInterval(advancedModeTimer);
        advancedModeTimer = null;
      }
    }

    // ğŸ‰ åˆæˆæˆåŠŸåŠ¨ç”»
    function playTicketSynthesizeAnimation() {
      // TODO: æ·»åŠ ç‚«é…·çš„åˆæˆåŠ¨ç”»ç‰¹æ•ˆ
      // console.log('[åŠ¨ç”»] æ’­æ”¾åˆæˆæˆåŠŸåŠ¨ç”»');
    }

    // ğŸ‰ è¿›å…¥é«˜çº§åœºåŠ¨ç”»
    function playEnterAdvancedAnimation() {
      // TODO: æ·»åŠ è¿›å…¥é«˜çº§åœºçš„ç‰¹æ•ˆ
      // console.log('[åŠ¨ç”»] æ’­æ”¾è¿›å…¥é«˜çº§åœºåŠ¨ç”»');
    }

    // ğŸ‰ æ‰è½åŠ¨ç”»
    function playTicketDropAnimation(dropType, dropCount) {
      // ğŸ”¥ æ”¯æŒå››ç§æ‰è½ç±»å‹
      let icon, name, gradient;
      
      switch(dropType) {
        case 'ticket':
          icon = 'ğŸŸï¸';
          name = 'å…¥åœºåˆ¸';
          gradient = 'from-purple-600 to-blue-600';
          break;
        case 'fragment':
          icon = 'ğŸ€';
          name = 'ç¢ç‰‡';
          gradient = 'from-green-600 to-emerald-600';
          break;
        case 'supreme_token':
          icon = 'ğŸ’';
          name = 'è‡³å°Šä»¤ç‰Œ';
          gradient = 'from-purple-600 via-pink-600 to-amber-500';
          break;
        case 'supreme_fragment':
          icon = 'ğŸ’ ';
          name = 'è‡³å°Šç¢ç‰‡';
          gradient = 'from-blue-600 to-cyan-600';
          break;
        default:
          icon = 'ğŸ';
          name = 'å¥–åŠ±';
          gradient = 'from-purple-600 to-blue-600';
      }
      
      // åˆ›å»ºæ‰è½ç‰¹æ•ˆå…ƒç´ 
      const dropEffect = document.createElement('div');
      dropEffect.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[10000]';
      dropEffect.style.animation = 'fadeInScale 0.5s ease-out, fadeOutScale 0.5s ease-in 1.5s';
      dropEffect.innerHTML = `
        <div class="bg-gradient-to-r ${gradient} rounded-2xl px-12 py-8 shadow-2xl border-4 border-yellow-400">
          <div class="text-center">
            <div class="text-8xl mb-4 animate-bounce">${icon}</div>
            <div class="text-3xl font-bold text-white mb-2">æ­å–œè·å¾—ï¼</div>
            <div class="text-2xl text-yellow-300">${name} Ã— ${dropCount}</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(dropEffect);
      
      setTimeout(() => {
        dropEffect.remove();
      }, 2000);
      
      console.log(`[æ‰è½åŠ¨ç”»] ${icon} ${name} Ã— ${dropCount}`);
    }

    // ğŸ”¥ æ–°ç‰ˆï¼šåˆå§‹åŒ–æ‰€æœ‰åœºæ¬¡çš„è€è™æœºæ»šè½®
    function initSlotReels() {
      // åˆå§‹åŒ–ä¸‰ä¸ªåœºæ¬¡çš„æ»šè½®å®¹å™¨
      initReelsForMode('slotReels');           // åˆçº§åœº
      initReelsForMode('advancedSlotReels');   // é«˜çº§åœº
      initReelsForMode('supremeSlotReels');    // è‡³å°Šåœº
    }
    
    // ğŸ”¥ ä¸ºæŒ‡å®šåœºæ¬¡åˆå§‹åŒ–æ»šè½®
    function initReelsForMode(reelsContainerId) {
      const reelsContainer = document.getElementById(reelsContainerId);
      if (!reelsContainer) {
        console.warn('[initReelsForMode] å®¹å™¨ä¸å­˜åœ¨:', reelsContainerId);
        return;
      }
      
      reelsContainer.innerHTML = '';

      for (let i = 0; i < 4; i++) {
        const reelContainer = document.createElement('div');
        reelContainer.className = 'slot-reel-container';
        reelContainer.innerHTML = `
          <div class="slot-reel" data-reel="${i}" data-mode="${reelsContainerId}">
            <div class="slot-symbols"></div>
          </div>
        `;
        reelsContainer.appendChild(reelContainer);
      }

      // ä¸ºæ¯ä¸ªæ»šè½®å¡«å……åˆå§‹ç¬¦å·ï¼ˆæ˜¾ç¤ºä¸€ä¸ªéšæœºç¬¦å·ï¼‰
      reelsContainer.querySelectorAll('.slot-reel').forEach((reel, idx) => {
        const symbolsContainer = reel.querySelector('.slot-symbols');
        // åˆå§‹æ˜¾ç¤ºä¸€ä¸ªéšæœºç¬¦å·
        const initialSymbol = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
        symbolsContainer.appendChild(createSymbolElement(initialSymbol));
        
        // ç¡®ä¿å®¹å™¨æ ·å¼æ­£ç¡®
        symbolsContainer.style.transform = 'translateY(0)';
        symbolsContainer.style.filter = 'none';
      });
      
      console.log('[initReelsForMode] æ»šè½®åˆå§‹åŒ–å®Œæˆ:', reelsContainerId);
    }

    // åˆ›å»ºç¬¦å·å…ƒç´ 
    function createSymbolElement(symbolName) {
      const div = document.createElement('div');
      div.className = 'slot-symbol';
      div.setAttribute('data-symbol', symbolName);
      
      const img = document.createElement('img');
      const ext = ['lq', 'bj', 'bdk'].includes(symbolName) ? 'jpg' : 'png';
      img.src = `/slot-symbols/${symbolName}.${ext}`;
      img.alt = symbolName;
      img.loading = 'eager'; // ç«‹å³åŠ è½½
      
      img.onerror = () => {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', symbolName, `æ‰©å±•å: ${ext}`);
        // åˆ›å»ºä¸€ä¸ªå¸¦æ–‡å­—çš„å ä½ç¬¦
        img.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="150" height="150" fill="%23667eea"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="24" fill="white">${symbolName}</text></svg>`;
      };
      
      img.onload = () => {
        // console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', symbolName);
      };
      
      div.appendChild(img);
      return div;
    }

    // æ‰“å¼€è€è™æœº
    async function showSlotMachine() {
      try {
        const mainSection = document.getElementById('mainSection');
        const slotModal = document.getElementById('slotMachineModal');
        const loadingOverlay = document.getElementById('slotLoadingOverlay');

        // 1. ç«‹å³æ˜¾ç¤ºè€è™æœºç•Œé¢ï¼ˆå¸¦loadingé®ç½©ï¼‰- æä¾›å³æ—¶åé¦ˆ
        mainSection.classList.add('fade-exit');
        
        // ç­‰å¾…é€€å‡ºåŠ¨ç”»å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 200));
        
        mainSection.classList.add('hidden');
        mainSection.classList.remove('fade-exit');
        
        // æ˜¾ç¤ºè€è™æœºç•Œé¢å’Œloading
        slotModal.classList.remove('hidden');
        loadingOverlay.classList.remove('hidden');
        slotModal.classList.add('fade-enter');
        
        // è§¦å‘è¿›å…¥åŠ¨ç”»
        requestAnimationFrame(() => {
          slotModal.classList.add('fade-enter-active');
        });

        // 2. å¼‚æ­¥åŠ è½½é…ç½®æ•°æ®ï¼ˆä¸é˜»å¡ç•Œé¢æ˜¾ç¤ºï¼‰
        const [configData] = await Promise.all([
          fetch('/api/slot/config').then(res => res.json()),
          // æ·»åŠ ä¸€ä¸ªæœ€å°å»¶è¿Ÿï¼Œç¡®ä¿åŠ¨ç”»æµç•…
          new Promise(resolve => setTimeout(resolve, 300))
        ]);

        if (!configData.success) {
          loadingOverlay.classList.add('hidden');
          showToast(configData.message, 'error');
          // å¦‚æœæœªç™»å½•æˆ–å…¶ä»–é”™è¯¯ï¼Œåˆ‡æ¢å›åŠ æ²¹ç«™æ¨¡å¼
          if (currentMode === 'entertain') {
            switchToRefuel();
          }
          return;
        }

        slotConfig = configData.data.config;
        slotUserData = configData.data.user;

        // åº”ç”¨èƒŒæ™¯é…ç½®
        const slotBg = document.querySelector('.slot-machine-bg');
        if (slotBg && slotConfig.background_type) {
          if (slotConfig.background_type === 'gif') {
            const backgroundAssetUrl = slotConfig.background_asset_url || '/ctrl.gif';
            slotBg.style.background = `linear-gradient(135deg, rgba(30, 58, 138, 0.7) 0%, rgba(59, 130, 246, 0.7) 50%, rgba(139, 92, 246, 0.7) 100%), url('${backgroundAssetUrl}')`;
            slotBg.style.backgroundSize = 'cover, cover';
            slotBg.style.backgroundPosition = 'center, center';
            slotBg.style.backgroundRepeat = 'no-repeat, no-repeat';
          } else {
            slotBg.style.background = 'linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 50%, rgba(139, 92, 246, 0.9) 100%)';
            slotBg.style.backgroundSize = 'cover';
            slotBg.style.backgroundPosition = 'center';
            slotBg.style.backgroundRepeat = 'no-repeat';
          }
        }

        // 3. ğŸ”¥ å…ˆåŠ è½½å…¥åœºåˆ¸ä¿¡æ¯å’Œè‡³å°Šä»¤ç‰Œï¼Œåˆ¤æ–­æ˜¯å¦åœ¨é«˜çº§åœº/è‡³å°Šåœºï¼ˆé¿å…UIé—ªçƒï¼‰
        await Promise.all([
          loadAdvancedTickets(),        // è¿™ä¼šè®¾ç½® isInAdvancedMode
          loadSupremeTokens(true)       // ğŸ’ åŠ è½½è‡³å°Šä»¤ç‰Œä¿¡æ¯ï¼Œè·³è¿‡UIæ›´æ–°
        ]);
        
        // 4. ğŸ’ åœ¨æ•°æ®åŠ è½½å®Œæˆåï¼Œç«‹å³è®¾ç½®æ­£ç¡®çš„å®¹å™¨å’Œæ ‡é¢˜æ˜¾ç¤ºçŠ¶æ€ï¼ˆåœ¨åˆå§‹åŒ–å‰ï¼‰
        // è¿™æ ·å¯ä»¥é¿å…é—ªç°å…¶ä»–åœºæ¬¡çš„å†…å®¹
        const normalContainer = document.getElementById('normalModeContainer');
        const advancedContainer = document.getElementById('advancedModeContainer');
        const supremeContainer = document.getElementById('supremeModeContainer');
        const normalModeTitle = document.getElementById('normalModeTitle');
        const advancedModeTitle = document.getElementById('advancedModeTitle');
        const supremeModeTitle = document.getElementById('supremeModeTitle');
        
        // å…ˆå…¨éƒ¨éšè—å®¹å™¨å’Œæ ‡é¢˜
        if (normalContainer) normalContainer.classList.add('hidden');
        if (advancedContainer) advancedContainer.classList.add('hidden');
        if (supremeContainer) supremeContainer.classList.add('hidden');
        if (normalModeTitle) normalModeTitle.classList.add('hidden');
        if (advancedModeTitle) advancedModeTitle.classList.add('hidden');
        if (supremeModeTitle) supremeModeTitle.classList.add('hidden');
        
        // æ ¹æ®çŠ¶æ€åªæ˜¾ç¤ºå¯¹åº”å®¹å™¨å’Œæ ‡é¢˜
        if (isInSupremeMode && supremeContainer && supremeModeTitle) {
          supremeContainer.classList.remove('hidden');
          supremeModeTitle.classList.remove('hidden');
        } else if (isInAdvancedMode && advancedContainer && advancedModeTitle) {
          advancedContainer.classList.remove('hidden');
          advancedModeTitle.classList.remove('hidden');
        } else if (normalContainer && normalModeTitle) {
          normalContainer.classList.remove('hidden');
          normalModeTitle.classList.remove('hidden');
        }
        
        // 5. åˆå§‹åŒ–UIï¼ˆæ­¤æ—¶å·²ç»çŸ¥é“æ˜¯å¦åœ¨é«˜çº§åœº/è‡³å°Šåœºï¼Œä¸”å®¹å™¨å·²æ­£ç¡®æ˜¾ç¤ºï¼‰
        initSlotReels();
        
        // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘ï¼Œç¡®ä¿åˆ·æ–°é¡µé¢åUIæ­£ç¡®
        if (isInSupremeMode) {
          switchToModeContainer('supreme');
        } else if (isInAdvancedMode) {
          switchToModeContainer('advanced');
        } else {
          switchToModeContainer('normal');
        }
        
        updateSlotUI();  // ğŸ”¥ ç°åœ¨ä¼šæ ¹æ® isInAdvancedMode/isInSupremeMode æ˜¾ç¤ºæ­£ç¡®çš„UI
        syncUserInfoToSlot();
        
        // ğŸµ é¢„åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿï¼ˆé¦–æ¬¡æ’­æ”¾æ—¶è‡ªåŠ¨åˆå§‹åŒ–ï¼‰
        soundManager.init();

        // 5. éšè—loadingé®ç½©
        loadingOverlay.style.animation = 'fadeOut 0.3s ease-in forwards';
        await new Promise(resolve => setTimeout(resolve, 300));
        loadingOverlay.classList.add('hidden');
        loadingOverlay.style.animation = '';

        // 6. å¼‚æ­¥åŠ è½½æ’è¡Œæ¦œå’Œå¤å‘—çŠ¶æ€ï¼ˆä¸é˜»å¡ä¸»ç•Œé¢ï¼‰
        setTimeout(() => {
          loadSidebarLeaderboard();
          // console.log('[åˆå§‹åŒ–] æ’è¡Œæ¦œåŠ è½½å®Œæˆ');
          
          // ğŸ”¥ é»˜è®¤æŠ˜å æ’è¡Œæ¦œ
          const lossBoardContent = document.getElementById('lossBoardContent');
          const profitBoardContent = document.getElementById('profitBoardContent');
          const lossBoardToggleIcon = document.getElementById('lossBoardToggleIcon');
          const profitBoardToggleIcon = document.getElementById('profitBoardToggleIcon');
          
          if (lossBoardContent && lossBoardToggleIcon) {
            lossBoardContent.style.display = 'none';
            lossBoardToggleIcon.style.transform = 'rotate(180deg)';
          }
          
          if (profitBoardContent && profitBoardToggleIcon) {
            profitBoardContent.style.display = 'none';
            profitBoardToggleIcon.style.transform = 'rotate(180deg)';
          }
          
          // ğŸ”¥ å¦‚æœç”¨æˆ·åœ¨é«˜çº§åœºï¼Œç¡®ä¿UIæ­£ç¡®æ˜¾ç¤º
          if (isInAdvancedMode && advancedTicketsData) {
            // console.log('[åˆå§‹åŒ–] ç”¨æˆ·åœ¨é«˜çº§åœºï¼Œå¼ºåˆ¶æ›´æ–°UI');
            updateAdvancedTicketsUI();  // ç¡®ä¿é«˜çº§åœºUIæ˜¾ç¤ºæ­£ç¡®
          }
          
          // ğŸ’ å¦‚æœå·²åŠ è½½è‡³å°Šä»¤ç‰Œæ•°æ®ï¼Œæ›´æ–°è‡³å°ŠåœºUI
          if (supremeTokensData) {
            // console.log('[åˆå§‹åŒ–] æ›´æ–°è‡³å°ŠåœºUI');
            updateSupremeTokensUI();  // ç¡®ä¿è‡³å°ŠåœºUIæ˜¾ç¤ºæ­£ç¡®
          }
          
          // ğŸ”¥ åŠ è½½å®Œå…¥åœºåˆ¸åå†æ¬¡æ›´æ–°UIï¼Œç¡®ä¿è¿›åº¦æ¡æ­£ç¡®æ˜¾ç¤º
          updateSlotUI();
          
          // ğŸ” åŠ è½½å¤å‘—çŠ¶æ€
          loadKunbeiStatus();
          
          // ğŸ”¥ å†æ¬¡å¼ºåˆ¶æ›´æ–°è¿›åº¦æ¡ï¼ˆç¡®ä¿æ˜¾ç¤ºï¼‰
          setTimeout(() => {
            // console.log('[åˆå§‹åŒ–] å»¶è¿Ÿæ›´æ–°è¿›åº¦æ¡');
            updateBetLimitProgressBar();
            
            // ğŸ”¥ æœ€ç»ˆæ£€æŸ¥ï¼šå†æ¬¡è°ƒç”¨ resetAllModeUI ç¡®ä¿UIå®Œå…¨æ­£ç¡®
            setTimeout(() => {
              debugLog('[åˆå§‹åŒ–] æœ€ç»ˆUIæ£€æŸ¥ï¼Œå½“å‰çŠ¶æ€:', {
                isInSupremeMode,
                isInAdvancedMode,
                hasSupremeConfig: !!supremeTokensData?.config,
                hasAdvancedConfig: !!advancedTicketsData?.config
              });

              // ğŸ”¥ æœ€ç»ˆç¡®ä¿å®¹å™¨æ˜¾ç¤ºæ­£ç¡®
              if (isInSupremeMode) {
                switchToModeContainer('supreme');
              } else if (isInAdvancedMode) {
                switchToModeContainer('advanced');
              } else {
                switchToModeContainer('normal');
              }

              // ğŸ”¥ å¦‚æœåœ¨è‡³å°Šåœºï¼Œç¡®ä¿å¿«æ·æŒ‰é’®å·²ç”Ÿæˆå’ŒæŒ‰é’®æ–‡æœ¬æ­£ç¡®
              if (isInSupremeMode && supremeTokensData?.config) {
                const config = supremeTokensData.config;
                debugLog('[åˆå§‹åŒ–] è‡³å°Šåœºæœ€ç»ˆæ£€æŸ¥ï¼Œé…ç½®:', {
                  min_bet_amount: config.min_bet_amount,
                  max_bet_amount: config.max_bet_amount,
                  in_supreme_mode: supremeTokensData.in_supreme_mode
                });
                
                // ğŸ”¥ å¼ºåˆ¶ç”Ÿæˆå¿«æ·æŒ‰é’®ï¼ˆæ— è®ºæ˜¯å¦å·²æœ‰ï¼‰
                if (config.min_bet_amount && config.max_bet_amount) {
                  supremeBetMin = config.min_bet_amount / 500000;
                  supremeBetMax = config.max_bet_amount / 500000;

                  debugLog('[åˆå§‹åŒ–] å¼ºåˆ¶ç”Ÿæˆå¿«æ·æŒ‰é’®ï¼ŒèŒƒå›´:', supremeBetMin, '~', supremeBetMax);

                  if (!isNaN(supremeBetMin) && !isNaN(supremeBetMax) && supremeBetMin > 0 && supremeBetMax > 0) {
                    // å…ˆæ¸…ç©ºå®¹å™¨
                    const container = document.getElementById('supremeBetOptions');
                    if (container) {
                      container.innerHTML = '';
                      debugLog('[åˆå§‹åŒ–] å·²æ¸…ç©ºå¿«æ·æŒ‰é’®å®¹å™¨');
                    }

                    // é‡æ–°ç”Ÿæˆ
                    generateSupremeBetOptions(supremeBetMin, supremeBetMax);

                    // æ›´æ–°æ»‘å—
                    const slider = document.getElementById('supremeBetSlider');
                    if (slider) {
                      slider.min = supremeBetMin;
                      slider.max = supremeBetMax;
                      slider.value = supremeBetMin;
                      // ğŸ”¥ åŠ¨æ€è®¡ç®—æ­¥é•¿ï¼Œç¡®ä¿èƒ½ç²¾ç¡®åˆ°è¾¾æœ€å¤§å€¼
                      slider.step = calculateOptimalStep(supremeBetMin, supremeBetMax);
                      updateSupremeBetDisplay(supremeBetMin);
                    }

                    // éªŒè¯ç”Ÿæˆç»“æœ
                    setTimeout(() => {
                      const container = document.getElementById('supremeBetOptions');
                      debugLog('[åˆå§‹åŒ–] å¿«æ·æŒ‰é’®ç”Ÿæˆåï¼Œå®¹å™¨å­å…ƒç´ æ•°é‡:', container?.children.length);
                    }, 50);
                  } else {
                    console.error('[åˆå§‹åŒ–] æŠ•æ³¨èŒƒå›´è®¡ç®—æ— æ•ˆ:', { supremeBetMin, supremeBetMax });
                  }
                } else {
                  console.error('[åˆå§‹åŒ–] é…ç½®æ•°æ®ç¼ºå¤±:', config);
                }
                
                // ğŸ”¥ å¼ºåˆ¶æ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼ˆåœ¨æœ€åæ‰§è¡Œï¼Œç¡®ä¿ä¸è¢«è¦†ç›–ï¼‰
                setTimeout(async () => {
                  // å…ˆæ›´æ–°ä»¤ç‰ŒUIï¼ˆè¿™ä¼šæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼‰
                  await loadSupremeTokens();
                  
                  // ç„¶åå†æ¬¡ç¡®è®¤æŒ‰é’®çŠ¶æ€
                  const enterBtn = document.getElementById('enterSupremeButton');
                  if (enterBtn) {
                    debugLog('[åˆå§‹åŒ–] æŒ‰é’®å½“å‰æ–‡æœ¬:', enterBtn.textContent);
                    if (isInSupremeMode && supremeTokensData?.in_supreme_mode) {
                      debugLog('[åˆå§‹åŒ–] æœ€ç»ˆç¡®è®¤æŒ‰é’®æ–‡æœ¬ä¸ºï¼šé€€å‡ºè‡³å°Šåœº');
                      enterBtn.textContent = 'ğŸ’ é€€å‡ºè‡³å°Šåœº';
                      enterBtn.onclick = exitSupremeMode;
                      enterBtn.disabled = false;
                      enterBtn.classList.remove('animate-pulse');
                    }
                  } else {
                    console.error('[åˆå§‹åŒ–] æ‰¾ä¸åˆ° enterSupremeButton');
                  }
                }, 300);
              }
            }, 100);
          }, 50);
        }, 100);

        // å®ŒæˆåŠ¨ç”»
        slotModal.classList.remove('fade-enter', 'fade-enter-active');
      } catch (error) {
        console.error('æ‰“å¼€è€è™æœºå¤±è´¥:', error);
        document.getElementById('slotLoadingOverlay').classList.add('hidden');
        showToast('æ‰“å¼€è€è™æœºå¤±è´¥', 'error');
        // å‡ºé”™æ—¶åˆ‡æ¢å›åŠ æ²¹ç«™æ¨¡å¼
        if (currentMode === 'entertain') {
          switchToRefuel();
        }
      }
    }

    // åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°è€è™æœºç•Œé¢
    function syncUserInfoToSlot() {
      // ä»ä¸»ç•Œé¢å¤åˆ¶ç”¨æˆ·ä¿¡æ¯åˆ°è€è™æœºç•Œé¢
      const linuxDoUsername = document.getElementById('linuxDoUsername')?.textContent;
      const userName = document.getElementById('userName')?.textContent;
      const userId = document.getElementById('userId')?.textContent;
      const userAvatar = document.getElementById('userAvatar');
      const userInitial = document.getElementById('userInitial')?.textContent;
      
      // console.log('[åŒæ­¥ç”¨æˆ·ä¿¡æ¯] LinuxDoç”¨æˆ·å:', linuxDoUsername, 'å…¬ç›Šç«™ç”¨æˆ·å:', userName, 'ID:', userId, 'å¤´åƒå…ƒç´ :', userAvatar);
      
      // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·å
      if (linuxDoUsername) {
        document.getElementById('slotLinuxDoUsername').textContent = linuxDoUsername;
        // console.log('[åŒæ­¥] è®¾ç½®è€è™æœºLinuxDoç”¨æˆ·åä¸º:', linuxDoUsername);
      }
      if (userName) document.getElementById('slotUserName').textContent = userName;
      if (userId) document.getElementById('slotUserId').textContent = userId;
      if (userInitial && !userAvatar?.style.backgroundImage) {
        document.getElementById('slotUserInitial').textContent = userInitial;
      }
      
      // å¤åˆ¶å¤´åƒæ ·å¼
      if (userAvatar) {
        const slotAvatar = document.getElementById('slotUserAvatar');
        if (slotAvatar) {
          const bgImage = userAvatar.style.backgroundImage;
          // console.log('[åŒæ­¥å¤´åƒ] èƒŒæ™¯å›¾ç‰‡:', bgImage);
          
          if (bgImage) {
            slotAvatar.style.backgroundImage = bgImage;
            slotAvatar.style.backgroundSize = 'cover';
            slotAvatar.style.backgroundPosition = 'center';
            document.getElementById('slotUserInitial').textContent = '';
          } else if (userInitial) {
            // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé¦–å­—æ¯
            document.getElementById('slotUserInitial').textContent = userInitial;
          }
        }
      }
    }
    
    // âœ… åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°æˆå°±ç•Œé¢
    function syncUserInfoToAchievement() {
      // ä»ä¸»ç•Œé¢å¤åˆ¶ç”¨æˆ·ä¿¡æ¯åˆ°æˆå°±ç•Œé¢
      const linuxDoUsername = document.getElementById('linuxDoUsername')?.textContent;
      const userName = document.getElementById('userName')?.textContent;
      const userId = document.getElementById('userId')?.textContent;
      const userAvatar = document.getElementById('userAvatar');
      const userInitial = document.getElementById('userInitial')?.textContent;
      
      // åŒæ­¥ç”¨æˆ·å
      const achievementLinuxDoUsername = document.getElementById('achievementLinuxDoUsername');
      const achievementUserName = document.getElementById('achievementUserName');
      const achievementUserId = document.getElementById('achievementUserId');
      
      if (achievementLinuxDoUsername && linuxDoUsername) {
        achievementLinuxDoUsername.textContent = linuxDoUsername;
      }
      if (achievementUserName && userName) {
        achievementUserName.textContent = userName;
      }
      if (achievementUserId && userId) {
        achievementUserId.textContent = userId;
      }
      
      // å¤åˆ¶å¤´åƒæ ·å¼
      const achievementAvatar = document.getElementById('achievementUserAvatar');
      const achievementInitial = document.getElementById('achievementUserInitial');
      
      if (userAvatar && achievementAvatar) {
        const bgImage = userAvatar.style.backgroundImage;
        
        if (bgImage) {
          achievementAvatar.style.backgroundImage = bgImage;
          achievementAvatar.style.backgroundSize = 'cover';
          achievementAvatar.style.backgroundPosition = 'center';
          if (achievementInitial) achievementInitial.textContent = '';
        } else if (userInitial && achievementInitial) {
          // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé¦–å­—æ¯
          achievementInitial.textContent = userInitial;
        }
      }
    }

    // å…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºè·å–å¤´åƒï¼‰
    let userDataCache = {};

    // åŠ è½½ä¾§è¾¹æ æ’è¡Œæ¦œ
    // ä¾§è¾¹æ æ’è¡Œæ¦œå½“å‰ç±»å‹ï¼ˆä»localStorageè¯»å–ï¼Œé»˜è®¤æ—¥æ¦œï¼‰
    let currentSidebarLeaderboardRange = localStorage.getItem('sidebarLeaderboardRange') || 'daily';

    async function loadSidebarLeaderboard(forceRefresh = false, range) {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥rangeï¼Œä½¿ç”¨å½“å‰ä¿å­˜çš„é€‰æ‹©
      if (!range) {
        range = currentSidebarLeaderboardRange;
      }
      currentSidebarLeaderboardRange = range;
      
      // æ›´æ–°ä¸¤ä¸ªä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼
      const rightSelect = document.getElementById('sidebarLeaderboardRangeSelect');
      const leftSelect = document.getElementById('lossBoardRangeSelect');
      if (rightSelect) rightSelect.value = range;
      if (leftSelect) leftSelect.value = range;
      
      try {
        const res = await fetch(`/api/slot/leaderboard?limit=10&type=${range}`);
        const data = await res.json();

        if (!data.success) {
          document.getElementById('sidebarLeaderboard').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">åŠ è½½å¤±è´¥</div>';
          document.getElementById('profitBoardList').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">åŠ è½½å¤±è´¥</div>';
          return;
        }

        const { leaderboard, lossLeaderboard, userStats, userRank, userLossRank } = data.data;

        // è®¡ç®—ç”¨æˆ·ç›ˆäº
        const userProfit = (userStats.total_win || 0) - (userStats.total_bet || 0);
        const userProfitText = `${userProfit >= 0 ? '+' : ''}$${(userProfit / 500000).toFixed(2)}`;
        const userProfitColor = userProfit >= 0 ? 'text-green-300' : 'text-red-300';

        // æ›´æ–°å³ä¾§æ’è¡Œæ¦œçš„ç”¨æˆ·ç»Ÿè®¡
        document.getElementById('sidebarMyRank').textContent = userRank > 0 ? `#${userRank}` : 'æœªä¸Šæ¦œ';
        const sidebarMyProfit = document.getElementById('sidebarMyProfit');
        sidebarMyProfit.textContent = userProfitText;
        sidebarMyProfit.className = `font-bold ${userProfitColor}`;

        // æ›´æ–°å·¦ä¾§äºæŸæ¦œçš„ç”¨æˆ·ç»Ÿè®¡
        document.getElementById('profitBoardMyRank').textContent = userLossRank > 0 ? `#${userLossRank}` : 'æœªä¸Šæ¦œ';
        const profitBoardMyProfit = document.getElementById('profitBoardMyProfit');
        profitBoardMyProfit.textContent = userProfitText;
        profitBoardMyProfit.className = `font-bold ${userProfitColor}`;

        // æ›´æ–°åˆ·æ–°æ—¶é—´
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('leaderboardLastUpdate').textContent = `æœ€åæ›´æ–°ï¼š${timeStr}`;
        document.getElementById('profitBoardLastUpdate').textContent = `æœ€åæ›´æ–°ï¼š${timeStr}`;
        
        // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºæç¤º
        if (forceRefresh) {
          showToast('æ’è¡Œæ¦œå·²åˆ·æ–°', 'success');
        }

        // è°ƒè¯•ï¼šè¾“å‡ºå®Œæ•´çš„æ’è¡Œæ¦œæ•°æ®
        // console.log('[ç›ˆäºæ’è¡Œæ¦œæ•°æ®]', leaderboard);

        // æ¸²æŸ“ç›ˆåˆ©æ¦œçš„å‡½æ•°ï¼ˆç»¿è‰²ä¸»é¢˜ï¼Œå¥–ç‰Œå›¾æ ‡ï¼‰
        const renderProfitLeaderboardItem = (user, index) => {
          const rank = index + 1;
          let rankDisplay = '';
          let bgClass = 'bg-white/5 hover:bg-white/10';
          
          if (rank === 1) {
            rankDisplay = '<span class="text-xl">ğŸ¥‡</span>';
            bgClass = 'bg-gradient-to-r from-green-500/30 to-emerald-500/30 border border-green-400/50 shadow-lg';
          } else if (rank === 2) {
            rankDisplay = '<span class="text-xl">ğŸ¥ˆ</span>';
            bgClass = 'bg-gradient-to-r from-green-400/30 to-emerald-400/30 border border-green-300/50 shadow-lg';
          } else if (rank === 3) {
            rankDisplay = '<span class="text-xl">ğŸ¥‰</span>';
            bgClass = 'bg-gradient-to-r from-green-500/30 to-teal-500/30 border border-green-400/50 shadow-lg';
          } else {
            rankDisplay = `<span class="text-xs font-bold text-white/50">#${rank}</span>`;
          }

          // æ„å»ºå¤´åƒHTML
          const username = user.username || user.linux_do_id;
          
          let avatarUrl = '';
          if (user.avatar_url && user.avatar_url.trim()) {
            avatarUrl = user.avatar_url;
          } else {
            const firstLetter = username.charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            avatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/48.png`;
          }
          
          // è®¡ç®—ç›ˆäº
          const profit = (user.total_win || 0) - (user.total_bet || 0);
          const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
          const profitColor = profit >= 0 ? 'text-green-300' : 'text-red-300';
          
          return `
            <div class="p-2 rounded-lg ${bgClass} transition-all">
              <div class="flex items-center gap-2">
                <div class="w-8 text-center flex-shrink-0">${rankDisplay}</div>
                <img src="${avatarUrl}" 
                     alt="${username}" 
                     class="w-7 h-7 rounded-full flex-shrink-0 border border-white/30 object-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-7 h-7 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold border border-white/30 flex-shrink-0" style="display:none;">
                  ${username.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-xs text-white truncate">${username}</p>
                  <p class="text-xs text-white/50">${user.total_spins} æ¬¡</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs font-bold ${profitColor}">${profitText}</p>
                </div>
              </div>
            </div>
          `;
        };

        // æ¸²æŸ“äºæŸæ¦œçš„å‡½æ•°ï¼ˆçº¢è‰²ä¸»é¢˜ï¼Œè¡¨æƒ…å›¾æ ‡ï¼‰
        const renderLossLeaderboardItem = (user, index) => {
          const rank = index + 1;
          let rankDisplay = '';
          let bgClass = 'bg-white/5 hover:bg-white/10';
          
          if (rank === 1) {
            rankDisplay = '<span class="text-xl">ğŸ˜±</span>';
            bgClass = 'bg-gradient-to-r from-red-500/30 to-rose-500/30 border border-red-400/50 shadow-lg';
          } else if (rank === 2) {
            rankDisplay = '<span class="text-xl">ğŸ˜­</span>';
            bgClass = 'bg-gradient-to-r from-red-400/30 to-rose-400/30 border border-red-300/50 shadow-lg';
          } else if (rank === 3) {
            rankDisplay = '<span class="text-xl">ğŸ˜¢</span>';
            bgClass = 'bg-gradient-to-r from-orange-500/30 to-red-500/30 border border-red-400/50 shadow-lg';
          } else {
            rankDisplay = `<span class="text-xs font-bold text-white/50">#${rank}</span>`;
          }

          // æ„å»ºå¤´åƒHTML
          const username = user.username || user.linux_do_id;
          
          let avatarUrl = '';
          if (user.avatar_url && user.avatar_url.trim()) {
            avatarUrl = user.avatar_url;
          } else {
            const firstLetter = username.charAt(0).toLowerCase();
            const colorCode = firstLetter.charCodeAt(0) % 10;
            avatarUrl = `https://linux.do/letter_avatar_proxy/v4/letter/${firstLetter}/${colorCode}/48.png`;
          }
          
          // è®¡ç®—ç›ˆäº
          const profit = (user.total_win || 0) - (user.total_bet || 0);
          const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
          const profitColor = profit >= 0 ? 'text-green-300' : 'text-red-300';
          
          return `
            <div class="p-2 rounded-lg ${bgClass} transition-all">
              <div class="flex items-center gap-2">
                <div class="w-8 text-center flex-shrink-0">${rankDisplay}</div>
                <img src="${avatarUrl}" 
                     alt="${username}" 
                     class="w-7 h-7 rounded-full flex-shrink-0 border border-white/30 object-cover"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-7 h-7 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold border border-white/30 flex-shrink-0" style="display:none;">
                  ${username.charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-xs text-white truncate">${username}</p>
                  <p class="text-xs text-white/50">${user.total_spins} æ¬¡</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-xs font-bold ${profitColor}">${profitText}</p>
                </div>
              </div>
            </div>
          `;
        };

        // æ¸²æŸ“å³ä¾§ç›ˆåˆ©æ¦œï¼ˆç»¿è‰²ä¸»é¢˜ï¼Œå¥–ç‰Œå›¾æ ‡ï¼‰
        const rightContainer = document.getElementById('sidebarLeaderboard');
        if (leaderboard.length === 0) {
          rightContainer.innerHTML = '<div class="text-center text-white/50 py-4 text-sm">æš‚æ— æ’è¡Œæ•°æ®</div>';
        } else {
          rightContainer.innerHTML = leaderboard.map(renderProfitLeaderboardItem).join('');
        }

        // æ¸²æŸ“å·¦ä¾§äºæŸæ¦œï¼ˆçº¢è‰²ä¸»é¢˜ï¼Œè¡¨æƒ…å›¾æ ‡ï¼‰
        const leftContainer = document.getElementById('profitBoardList');
        if (!lossLeaderboard || lossLeaderboard.length === 0) {
          leftContainer.innerHTML = '<div class="text-center text-white/50 py-8 text-sm">ğŸ‰ æš‚æ— äºæŸç”¨æˆ·<br><span class="text-xs opacity-75 mt-1">æ‰€æœ‰ç©å®¶éƒ½åœ¨ç›ˆåˆ©ï¼</span></div>';
        } else {
          leftContainer.innerHTML = lossLeaderboard.map(renderLossLeaderboardItem).join('');
        }

      } catch (error) {
        console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
        document.getElementById('sidebarLeaderboard').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">åŠ è½½å¤±è´¥</div>';
        document.getElementById('profitBoardList').innerHTML = '<div class="text-center text-white/50 py-4 text-sm">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ”¶èµ·/å±•å¼€äºæŸæ¦œ
    function toggleLossBoard() {
      const content = document.getElementById('lossBoardContent');
      const icon = document.getElementById('lossBoardToggleIcon');
      const isCollapsed = content.style.display === 'none';
      
      if (isCollapsed) {
        // å±•å¼€
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        // æ”¶èµ·
        content.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
      }
    }

    // åˆ‡æ¢ä¾§è¾¹æ æ’è¡Œæ¦œç±»å‹
    function switchSidebarLeaderboardRange(range) {
      // ä¿å­˜ç”¨æˆ·é€‰æ‹©åˆ°localStorage
      localStorage.setItem('sidebarLeaderboardRange', range);
      
      // æ›´æ–°å½“å‰èŒƒå›´
      currentSidebarLeaderboardRange = range;
      
      // åŒæ­¥æ›´æ–°ä¸¤ä¸ªä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼
      const rightSelect = document.getElementById('sidebarLeaderboardRangeSelect');
      const leftSelect = document.getElementById('lossBoardRangeSelect');
      if (rightSelect) rightSelect.value = range;
      if (leftSelect) leftSelect.value = range;
      
      // é‡æ–°åŠ è½½æ’è¡Œæ¦œæ•°æ®
      loadSidebarLeaderboard(false, range);
      
      console.log(`ğŸ“Š ä¾§è¾¹æ æ’è¡Œæ¦œç±»å‹å·²åˆ‡æ¢: ${range === 'daily' ? 'æ—¥æ¦œ' : range === 'weekly' ? 'å‘¨æ¦œ' : 'æ€»æ¦œ'}`);
    }

    // æ”¶èµ·/å±•å¼€ç›ˆåˆ©æ¦œ
    function toggleProfitBoard() {
      const content = document.getElementById('profitBoardContent');
      const icon = document.getElementById('profitBoardToggleIcon');
      const isCollapsed = content.style.display === 'none';
      
      if (isCollapsed) {
        // å±•å¼€
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        // æ”¶èµ·
        content.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
      }
    }

    // å…³é—­è€è™æœº
    async function closeSlotMachine() {
      // åˆ‡æ¢å›åŠ æ²¹ç«™æ¨¡å¼
      await switchToRefuel();
    }

    // æ›´æ–°è€è™æœºç•Œé¢æ•°æ®
    function updateSlotUI() {
      if (!slotUserData || !slotConfig) {
        // console.warn('[updateSlotUI] ç¼ºå°‘å¿…è¦æ•°æ®:', { slotUserData, slotConfig });
        return;
      }

      // console.log('[updateSlotUI] æ›´æ–°UIï¼Œå½“å‰æ•°æ®:', {
      //   remaining_spins: slotUserData.remaining_spins,
      //   free_spins: slotUserData.free_spins,
      //   quota: slotUserData.quota,
      //   bought_today: slotUserData.bought_today
      // });

      const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
      document.getElementById('slotQuota').textContent = quotaText;
      // åŒæ­¥æ›´æ–°ç§»åŠ¨ç«¯é¢åº¦æ˜¾ç¤º
      const slotQuotaMobile = document.getElementById('slotQuotaMobile');
      if (slotQuotaMobile) {
        slotQuotaMobile.textContent = quotaText;
      }

      const spinsRemainingEl = document.getElementById('spinsRemaining');
      const freeSpinsCountEl = document.getElementById('freeSpinsCount');

      // ğŸ¯ å¢å¼ºï¼šç¡®ä¿å…ƒç´ å­˜åœ¨ä¸”æ­£ç¡®æ›´æ–°
      if (spinsRemainingEl) {
        const newValue = slotUserData.remaining_spins || 0;
        const oldValue = parseInt(spinsRemainingEl.textContent) || 0;
        spinsRemainingEl.textContent = newValue;
        
        // å¦‚æœå€¼å‘ç”Ÿå˜åŒ–ï¼Œæ·»åŠ æ—¥å¿—
        if (oldValue !== newValue) {
          // console.log(`[updateSlotUI] ğŸ”„ å‰©ä½™æ¬¡æ•°æ›´æ–°: ${oldValue} â†’ ${newValue}`);
        }
      } else {
        // console.error('[updateSlotUI] âŒ æ‰¾ä¸åˆ° spinsRemaining å…ƒç´ ï¼');
      }
      
      if (freeSpinsCountEl) {
        freeSpinsCountEl.textContent = slotUserData.free_spins || 0;
      } else {
        // console.error('[updateSlotUI] âŒ æ‰¾ä¸åˆ° freeSpinsCount å…ƒç´ ï¼');
      }

      // console.log('[updateSlotUI] DOMæ›´æ–°å®Œæˆ:', {
      //   spinsRemainingEl_text: spinsRemainingEl?.textContent || 'N/A',
      //   freeSpinsCountEl_text: freeSpinsCountEl?.textContent || 'N/A',
      //   remaining_spins_value: slotUserData.remaining_spins,
      //   free_spins_value: slotUserData.free_spins
      // });
      
      // ä»Šæ—¥ç»Ÿè®¡
      document.getElementById('todayPlayed').textContent = slotUserData.today_count || 0;
      document.getElementById('todayBet').textContent = `$${((slotUserData.today_bet || 0) / 500000).toFixed(2)}`;
      document.getElementById('todayWon').textContent = `$${((slotUserData.today_win || 0) / 500000).toFixed(2)}`;
      
      // å†å²æ€»è®¡
      document.getElementById('totalPlayed').textContent = slotUserData.total_spins || 0;
      document.getElementById('totalBet').textContent = `$${((slotUserData.total_bet || 0) / 500000).toFixed(2)}`;
      document.getElementById('totalWon').textContent = `$${((slotUserData.total_win || 0) / 500000).toFixed(2)}`;
      
      // ğŸ”¥ æ›´æ–°æŠ•æ³¨é™é¢è¿›åº¦æ¡ï¼ˆåœ¨ updateSlotUI ä¸­ç›´æ¥è°ƒç”¨ï¼‰
      // console.log('[updateSlotUI] å‡†å¤‡æ›´æ–°è¿›åº¦æ¡ï¼ŒisInAdvancedMode:', isInAdvancedMode);
      updateBetLimitProgressBar();

      // ğŸ”¥ æ˜¾ç¤ºç¦æ­¢çŠ¶æ€ï¼ˆå¾‹å¸ˆå‡½åªç¦æ­¢é«˜çº§åœºå’Œè‡³å°Šåœºï¼Œåˆçº§åœºä¸å—å½±å“ï¼‰
      const bannedNotice = document.getElementById('bannedNotice');
      const bannedUntilText = document.getElementById('bannedUntilText');
      const advancedBannedNotice = document.getElementById('advancedBannedNotice');
      const advancedBannedUntilText = document.getElementById('advancedBannedUntilText');
      const supremeBannedNotice = document.getElementById('supremeBannedNotice');
      const supremeBannedUntilText = document.getElementById('supremeBannedUntilText');
      
      if (slotUserData.is_banned && slotUserData.banned_until > Date.now()) {
        // ğŸ”¥ éªŒè¯ banned_until æ˜¯å¦ä¸ºåˆç†çš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        const bannedUntil = slotUserData.banned_until;
        
        // éªŒè¯æ—¶é—´æˆ³èŒƒå›´ï¼ˆ2020å¹´åˆ°2100å¹´ä¹‹é—´ï¼‰
        const minTimestamp = new Date('2020-01-01').getTime();
        const maxTimestamp = new Date('2100-01-01').getTime();
        
        if (bannedUntil < minTimestamp || bannedUntil > maxTimestamp) {
          console.error('[å°ç¦æ—¶é—´] å¼‚å¸¸çš„æ—¶é—´æˆ³:', bannedUntil, '(åº”è¯¥åœ¨', minTimestamp, 'åˆ°', maxTimestamp, 'ä¹‹é—´)');
          // å¼‚å¸¸å€¼ï¼Œéšè—å°ç¦æç¤ºå¹¶æŠ¥é”™
          if (bannedNotice) bannedNotice.classList.add('hidden');
          if (advancedBannedNotice) advancedBannedNotice.classList.add('hidden');
          if (supremeBannedNotice) supremeBannedNotice.classList.add('hidden');
          showToast('å°ç¦æ—¶é—´æ•°æ®å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
          return;
        }
        
        const bannedDate = new Date(bannedUntil);
        const remainingHours = Math.ceil((bannedUntil - Date.now()) / 3600000);
        const banText = `è§£ç¦æ—¶é—´ï¼š${bannedDate.toLocaleString('zh-CN', { hour12: false })} (å‰©ä½™çº¦${remainingHours}å°æ—¶)`;
        
        console.log('[å°ç¦æ—¶é—´] æ˜¾ç¤ºé«˜çº§åœºå’Œè‡³å°Šåœºå°ç¦æç¤º - å°ç¦è‡³:', bannedDate.toLocaleString('zh-CN'), 'å‰©ä½™:', remainingHours, 'å°æ—¶');
        
        // ğŸ”¥ åˆçº§åœºä¸å—å¾‹å¸ˆå‡½æƒ©ç½šå½±å“ï¼Œå§‹ç»ˆå¯ç”¨
        if (bannedNotice) {
          bannedNotice.classList.add('hidden');
        }
        
        // ğŸ”¥ é«˜çº§åœºå°ç¦æç¤º
        if (advancedBannedNotice && advancedBannedUntilText) {
          advancedBannedNotice.classList.remove('hidden');
          advancedBannedUntilText.textContent = banText;
        }
        
        // ğŸ”¥ è‡³å°Šåœºå°ç¦æç¤º
        if (supremeBannedNotice && supremeBannedUntilText) {
          supremeBannedNotice.classList.remove('hidden');
          supremeBannedUntilText.textContent = banText;
        }
      } else {
        // éšè—æ‰€æœ‰å°ç¦æç¤º
        if (bannedNotice) bannedNotice.classList.add('hidden');
        if (advancedBannedNotice) advancedBannedNotice.classList.add('hidden');
        if (supremeBannedNotice) supremeBannedNotice.classList.add('hidden');
      }

      // æ›´æ–°æŠ•æ³¨é‡‘é¢æ˜¾ç¤ºï¼ˆæ ¹æ®ç®¡ç†å‘˜é…ç½®æˆ–é«˜çº§åœºé€‰æ‹©ï¼‰
      const spinButtonPrice = document.getElementById('spinButtonPrice');
      if (spinButtonPrice) {
        if (isInAdvancedMode) {
          // ğŸ”¥ é«˜çº§åœºæ˜¾ç¤ºé€‰æ‹©çš„æŠ•æ³¨é‡‘é¢
          spinButtonPrice.textContent = `($${advancedBetAmount})`;
        } else {
          // åˆçº§åœºæ˜¾ç¤ºé…ç½®çš„æŠ•æ³¨é‡‘é¢
          const betAmountUSD = (slotConfig.bet_amount / 500000).toFixed(2);
          spinButtonPrice.textContent = `($${betAmountUSD})`;
        }
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const spinButton = document.getElementById('spinButton');
      const freeSpinButton = document.getElementById('freeSpinButton');

      // æ™®é€šæ—‹è½¬æŒ‰é’®
      const hasSpins = slotUserData.remaining_spins > 0;
      const hasQuota = slotUserData.quota >= slotConfig.min_quota_required;

      // console.log('[updateSlotUI] SpinæŒ‰é’®çŠ¶æ€æ£€æŸ¥:', {
      //   remaining_spins: slotUserData.remaining_spins,
      //   hasSpins: hasSpins,
      //   quota: slotUserData.quota,
      //   min_quota_required: slotConfig.min_quota_required,
      //   hasQuota: hasQuota,
      //   quotaUSD: `$${(slotUserData.quota / 500000).toFixed(2)}`,
      //   minQuotaUSD: `$${(slotConfig.min_quota_required / 500000).toFixed(2)}`,
      //   shouldEnable: hasSpins && hasQuota
      // });

      if (hasSpins && hasQuota) {
        spinButton.disabled = false;
        // console.log('[updateSlotUI] âœ… SpinæŒ‰é’®å·²å¯ç”¨');
      } else {
        spinButton.disabled = true;
        if (!hasSpins) {
          // console.log('[updateSlotUI] âŒ SpinæŒ‰é’®ç¦ç”¨ï¼šæ²¡æœ‰å‰©ä½™æ¬¡æ•°');
        }
        if (!hasQuota) {
          // console.log('[updateSlotUI] âŒ SpinæŒ‰é’®ç¦ç”¨ï¼šé¢åº¦ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘ $' + (slotConfig.min_quota_required / 500000).toFixed(2) + 'ï¼‰');
        }
      }

      // å…è´¹æ—‹è½¬æŒ‰é’®ï¼ˆğŸ”¥ é«˜çº§åœºä¸æ˜¾ç¤ºå…è´¹æŠ½å¥–ï¼‰
      if (!isInAdvancedMode && slotUserData.free_spins > 0 && !slotUserData.is_banned) {
        freeSpinButton.classList.remove('hidden');
        freeSpinButton.disabled = false;
      } else {
        freeSpinButton.classList.add('hidden');
        freeSpinButton.disabled = true;
      }

      // ğŸ”¥ é«˜çº§åœºæŠ•æ³¨æŒ‰é’®çŠ¶æ€æ›´æ–°
      updateAdvancedSpinButtonState();

      // è´­ä¹°æ¬¡æ•°åŠŸèƒ½åŒº
      const buySpinsSection = document.getElementById('buySpinsSection');
      const buySpinsButton = document.getElementById('buySpinsButton');

      if (buySpinsSection && slotConfig.buy_spins_enabled && !slotUserData.is_banned && !isInAdvancedMode) {
        // æ˜¾ç¤ºè´­ä¹°åŒºåŸŸï¼ˆé«˜çº§åœºä¸æ˜¾ç¤ºï¼‰
        buySpinsSection.classList.remove('hidden');

        // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
        const buyPriceUSD = parseFloat((slotConfig.buy_spins_price / 500000).toFixed(2));
        const buySpinsPriceEl = document.getElementById('buySpinsPrice');
        if (buySpinsPriceEl) buySpinsPriceEl.textContent = `$${buyPriceUSD}`;

        // æ›´æ–°å·²è´­æ¬¡æ•°å’Œæ»‘å—æœ€å¤§å€¼
        const buySpinsTodayEl = document.getElementById('buySpinsToday');
        const buySpinsMaxEl = document.getElementById('buySpinsMax');
        const boughtToday = slotUserData.bought_today || 0;
        if (buySpinsTodayEl) buySpinsTodayEl.textContent = boughtToday;
        if (buySpinsMaxEl) buySpinsMaxEl.textContent = slotConfig.max_daily_buy_spins;

        // ğŸ”¥ æ›´æ–°æ»‘å—æœ€å¤§å€¼ï¼ˆå‰©ä½™å¯è´­ä¹°æ¬¡æ•°ï¼‰
        const buySpinsSlider = document.getElementById('buySpinsSlider');
        const remainingBuyCount = Math.max(1, slotConfig.max_daily_buy_spins - boughtToday);
        if (buySpinsSlider) {
          buySpinsSlider.max = remainingBuyCount;
          // å¦‚æœå½“å‰å€¼è¶…è¿‡æœ€å¤§å€¼ï¼Œé‡ç½®ä¸ºæœ€å¤§å€¼
          if (parseInt(buySpinsSlider.value) > remainingBuyCount) {
            buySpinsSlider.value = remainingBuyCount;
            updateBuySpinsDisplay(remainingBuyCount);
          } else {
            // ç¡®ä¿æ˜¾ç¤ºå’Œæ»‘å—å€¼ä¸€è‡´
            updateBuySpinsDisplay(buySpinsSlider.value);
          }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (buySpinsButton) {
          const currentBuyCount = buySpinsSlider ? parseInt(buySpinsSlider.value) : 1;
          const totalPrice = slotConfig.buy_spins_price * currentBuyCount;
          
          if (boughtToday >= slotConfig.max_daily_buy_spins) {
            buySpinsButton.disabled = true;
          } else if (slotUserData.quota < totalPrice) {
            buySpinsButton.disabled = true;
          } else {
            buySpinsButton.disabled = false;
          }
        }
      } else if (buySpinsSection) {
        // éšè—è´­ä¹°åŒºåŸŸï¼ˆé«˜çº§åœºæˆ–å…¶ä»–åŸå› ï¼‰
        buySpinsSection.classList.add('hidden');
      }

      // ğŸ”¥ æ£€æŸ¥å¹¶æ˜¾ç¤ºå¤å‘—buffæç¤º
      checkAndShowKunbeiBuff();
    }
    
    // ğŸ”¥ æ›´æ–°è´­ä¹°æ¬¡æ•°æ˜¾ç¤º
    function updateBuySpinsDisplay(count) {
      const buyCount = parseInt(count) || 1;
      const buyCountEl = document.getElementById('buySpinsCount');
      const buyBtnCountEl = document.getElementById('buySpinsBtnCount');
      const buyBtnPriceEl = document.getElementById('buySpinsBtnPrice');
      
      if (buyCountEl) buyCountEl.textContent = buyCount;
      if (buyBtnCountEl) buyBtnCountEl.textContent = buyCount;
      
      // æ›´æ–°æ€»ä»·æ ¼
      if (slotConfig && buyBtnPriceEl) {
        const totalPrice = (slotConfig.buy_spins_price * buyCount / 500000).toFixed(2);
        buyBtnPriceEl.textContent = totalPrice;
      }
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ£€æŸ¥é¢åº¦æ˜¯å¦è¶³å¤Ÿï¼‰
      const buySpinsButton = document.getElementById('buySpinsButton');
      if (buySpinsButton && slotConfig && slotUserData) {
        const totalPrice = slotConfig.buy_spins_price * buyCount;
        const boughtToday = slotUserData.bought_today || 0;
        
        if (boughtToday >= slotConfig.max_daily_buy_spins) {
          buySpinsButton.disabled = true;
        } else if (slotUserData.quota < totalPrice) {
          buySpinsButton.disabled = true;
        } else {
          buySpinsButton.disabled = false;
        }
      }
    }

    // è´­ä¹°æŠ½å¥–æ¬¡æ•° - æ˜¾ç¤ºç¡®è®¤å¼¹çª—
    function buySpins() {
      const button = document.getElementById('buySpinsButton');
      if (!button) {
        showToast('æŒ‰é’®åŠ è½½å¤±è´¥', 'error');
        return;
      }
      if (button.disabled) return;

      if (!slotConfig || !slotUserData) {
        showToast('é…ç½®åŠ è½½å¤±è´¥', 'error');
        return;
      }

      // ğŸ”¥ è·å–è´­ä¹°æ•°é‡
      const buySpinsSlider = document.getElementById('buySpinsSlider');
      const buyCount = buySpinsSlider ? parseInt(buySpinsSlider.value) : 1;
      const totalPrice = slotConfig.buy_spins_price * buyCount;
      const buyPriceUSD = (totalPrice / 500000).toFixed(2);

      console.log('[è´­ä¹°æ¬¡æ•°] æ˜¾ç¤ºç¡®è®¤å¼¹çª— - æ»‘å—å€¼:', buySpinsSlider?.value, 'è´­ä¹°æ•°é‡:', buyCount, 'æ€»ä»·:', buyPriceUSD);

      // æ›´æ–°å¼¹çª—ä¸­çš„ä»·æ ¼æ˜¾ç¤º
      const confirmPriceEl = document.getElementById('confirmBuyPrice');
      if (confirmPriceEl) {
        confirmPriceEl.textContent = `è´­ä¹° ${buyCount} æ¬¡æŠ½å¥–æœºä¼šï¼ŒèŠ±è´¹ $${buyPriceUSD}`;
      }

      // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
      document.getElementById('buySpinsConfirmModal').classList.remove('hidden');
    }

    // å–æ¶ˆè´­ä¹°
    function cancelBuySpins() {
      document.getElementById('buySpinsConfirmModal').classList.add('hidden');
    }

    // ç¡®è®¤è´­ä¹° - æ‰§è¡Œè´­ä¹°é€»è¾‘
    async function confirmBuySpins() {
      // éšè—ç¡®è®¤å¼¹çª—
      document.getElementById('buySpinsConfirmModal').classList.add('hidden');

      const button = document.getElementById('buySpinsButton');
      if (!button) return;

      // ğŸ”¥ è·å–è´­ä¹°æ•°é‡
      const buySpinsSlider = document.getElementById('buySpinsSlider');
      const buyCount = buySpinsSlider ? parseInt(buySpinsSlider.value) : 1;

      console.log('[è´­ä¹°æ¬¡æ•°] å‰ç«¯å‘èµ·è´­ä¹° - æ»‘å—å€¼:', buySpinsSlider?.value, 'è§£æåæ•°é‡:', buyCount);

      // ç¦ç”¨æŒ‰é’®
      button.disabled = true;
      const originalText = button.innerHTML;
      button.innerHTML = 'â³ è´­ä¹°ä¸­...';

      try {
        const requestBody = { count: buyCount };
        console.log('[è´­ä¹°æ¬¡æ•°] å‘é€è¯·æ±‚ - body:', JSON.stringify(requestBody));
        
        const res = await fetch('/api/slot/buy-spins', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody) // ğŸ”¥ ä¼ é€’è´­ä¹°æ•°é‡
        });

        const data = await res.json();

        if (data.success) {
          // ğŸ¯ ä¿å­˜è´­ä¹°å‰çš„å‰©ä½™æ¬¡æ•°ï¼Œç”¨äºè§†è§‰å¯¹æ¯”
          const oldRemainingSpins = slotUserData.remaining_spins || 0;

          // ğŸ”¥ è·å–æœ¬æ¬¡è´­ä¹°çš„æ•°é‡ï¼ˆåç«¯è¿”å›ï¼‰
          const buyCount = data.data.buy_count || 1;

          // ğŸ”¥ è·å–åç«¯è¿”å›çš„æ–°å‰©ä½™æ¬¡æ•°
          const newRemainingSpins = data.data.remaining_spins;

          // âœ… éªŒè¯è´­ä¹°æ˜¯å¦çœŸçš„æˆåŠŸï¼šæ£€æŸ¥æ¬¡æ•°æ˜¯å¦å¢åŠ 
          const expectedMinSpins = oldRemainingSpins + buyCount;

          console.log('[è´­ä¹°éªŒè¯] è´­ä¹°å‰æ¬¡æ•°:', oldRemainingSpins, 'è´­ä¹°æ•°é‡:', buyCount, 'åç«¯è¿”å›æ¬¡æ•°:', newRemainingSpins, 'é¢„æœŸè‡³å°‘:', expectedMinSpins);
          
          // ğŸš¨ å¦‚æœè´­ä¹°åæ¬¡æ•°è¿˜æ˜¯0ï¼Œæˆ–è€…æ¬¡æ•°æ²¡æœ‰å¢åŠ ï¼Œåˆ™æ‹’ç»æ›´æ–°
          if (newRemainingSpins === 0 || newRemainingSpins < expectedMinSpins) {
            console.error('[è´­ä¹°éªŒè¯å¤±è´¥] æ¬¡æ•°æœªå¢åŠ ï¼è´­ä¹°å‰:', oldRemainingSpins, 'è´­ä¹°å:', newRemainingSpins, 'è´­ä¹°æ•°é‡:', buyCount);

            showToast(`âš ï¸ è´­ä¹°éªŒè¯å¤±è´¥ï¼å‰©ä½™æ¬¡æ•°æœªå¢åŠ ï¼ˆå½“å‰: ${newRemainingSpins}ï¼‰ï¼Œé¢åº¦å¯èƒ½å·²æ‰£é™¤ä½†æ¬¡æ•°æœªåˆ°è´¦ã€‚è¯·åˆ·æ–°é¡µé¢æ£€æŸ¥ï¼Œå¦‚é—®é¢˜æŒç»­è¯·è”ç³»ç®¡ç†å‘˜`, 'error', 8000);

            // ğŸ”¥ ä¸æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œä¿æŒåŸçŠ¶æ€
            button.disabled = false;
            button.innerHTML = originalText;
            return; // ç»ˆæ­¢æ‰§è¡Œ
          }

          // âœ… éªŒè¯é€šè¿‡ï¼Œæ›´æ–°ç”¨æˆ·æ•°æ®
          slotUserData.quota = data.data.quota_after;
          slotUserData.remaining_spins = data.data.remaining_spins;
          slotUserData.bought_today = data.data.bought_today;

          // console.log('[è´­ä¹°æˆåŠŸ] APIè¿”å›æ•°æ®:', data.data);
          // console.log('[è´­ä¹°æˆåŠŸ] æ›´æ–°å‰å‰©ä½™æ¬¡æ•°:', oldRemainingSpins);
          // console.log('[è´­ä¹°æˆåŠŸ] æ›´æ–°åå‰©ä½™æ¬¡æ•°:', slotUserData.remaining_spins);
          // console.log('[è´­ä¹°æˆåŠŸ] æœ¬æ¬¡è´­ä¹°æ•°é‡:', buyCount);
          // console.log('[è´­ä¹°æˆåŠŸ] æ›´æ–°åçš„ slotUserData:', {
          //   quota: slotUserData.quota,
          //   remaining_spins: slotUserData.remaining_spins,
          //   bought_today: slotUserData.bought_today,
          //   free_spins: slotUserData.free_spins
          // });

          // ğŸ”¥ é‡ç½®æ»‘å—åˆ°1
          if (buySpinsSlider) {
            buySpinsSlider.value = 1;
            updateBuySpinsDisplay(1);
          }

          // ç«‹å³æ›´æ–°UI
          updateSlotUI();

          // ğŸ¯ æ·»åŠ è§†è§‰åé¦ˆï¼šé«˜äº®æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
          const spinsRemainingEl = document.getElementById('spinsRemaining');
          if (spinsRemainingEl) {
            // æ·»åŠ é—ªçƒåŠ¨ç”»
            spinsRemainingEl.style.animation = 'pulse 0.5s ease-in-out 3';
            setTimeout(() => {
              spinsRemainingEl.style.animation = '';
            }, 1500);
          }

          // ğŸ¯ æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸæ¶ˆæ¯ï¼ˆä½¿ç”¨åç«¯è¿”å›çš„è´­ä¹°æ•°é‡ä½œä¸ºå¢é‡ï¼‰
          setTimeout(() => {
            showToast(`âœ… ${data.message} å‰©ä½™æ¬¡æ•°ï¼š${oldRemainingSpins} â†’ ${slotUserData.remaining_spins} (+${buyCount})`, 'success');
          }, 500);
          
        } else {
          showToast(data.message, 'error');
          // å¤±è´¥æ—¶ä¹Ÿè¦æ¢å¤æŒ‰é’®çŠ¶æ€
          button.disabled = false;
        }
      } catch (error) {
        console.error('è´­ä¹°å¤±è´¥:', error);
        showToast('è´­ä¹°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        // å¤±è´¥æ—¶æ¢å¤æŒ‰é’®çŠ¶æ€
        button.disabled = false;
      } finally {
        // ğŸ¯ ä¿®å¤ï¼šæ¢å¤æŒ‰é’®æ–‡æœ¬ï¼Œä½†ä¸åœ¨è¿™é‡Œè®¾ç½® disabled çŠ¶æ€
        // è®© updateSlotUI() æ¥å†³å®šæœ€ç»ˆçš„æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 100);
      }
    }

    // æ—‹è½¬è€è™æœºï¼ˆå¸¦ä¸æ»‘åŠ¨ç”»ï¼‰
    async function spinSlot(useFreeSpinn = false) {
      if (isSpinning) return;

      // ğŸ”¥ æ ¹æ®å½“å‰åœºæ¬¡è·å–å¯¹åº”çš„UIå…ƒç´ 
      let resultDiv, resultText, spinButton, freeSpinButton;
      
      if (isInSupremeMode) {
        resultDiv = document.getElementById('supremeSlotResult');
        resultText = document.getElementById('supremeSlotResultText');
        spinButton = document.getElementById('supremeSpinButton');
        freeSpinButton = null; // è‡³å°Šåœºæ²¡æœ‰å…è´¹æŒ‰é’®
      } else if (isInAdvancedMode) {
        resultDiv = document.getElementById('advancedSlotResult');
        resultText = document.getElementById('advancedSlotResultText');
        spinButton = document.getElementById('advancedSpinButton');
        freeSpinButton = null; // é«˜çº§åœºæ²¡æœ‰å…è´¹æŒ‰é’®
      } else {
        resultDiv = document.getElementById('slotResult');
        resultText = document.getElementById('slotResultText');
        spinButton = document.getElementById('spinButton');
        freeSpinButton = document.getElementById('freeSpinButton');
      }
      
      if (!resultDiv || !resultText) {
        console.error('[spinSlot] æ‰¾ä¸åˆ°ç»“æœæ˜¾ç¤ºå…ƒç´ ');
        return;
      }

      // âœ… æ–°å¢ï¼šä½¿ç”¨å…è´¹æ¬¡æ•°æ—¶å…ˆæ£€æŸ¥
      if (useFreeSpinn) {
        if (!slotUserData || slotUserData.free_spins <= 0) {
          showToast('æ²¡æœ‰å…è´¹æ¬¡æ•°', 'error');
          
          // é‡æ–°åŒæ­¥æ•°æ®
          try {
            const configRes = await fetch('/api/slot/config');
            const configData = await configRes.json();
            if (configData.success) {
              slotUserData = configData.data.user;
              updateSlotUI();
            }
          } catch (error) {
            console.error('[å‰ç«¯] åŒæ­¥æ•°æ®å¤±è´¥:', error);
          }
          return;
        }
      }

      // éšè—ä¸Šæ¬¡ç»“æœ
      if (resultDiv) resultDiv.classList.add('hidden');

      // ç¦ç”¨æ‰€æœ‰æŒ‰é’®å¹¶æ˜¾ç¤ºè½¬åŠ¨ä¸­çŠ¶æ€
      const originalSpinText = spinButton ? spinButton.innerHTML : '';
      const originalFreeSpinText = freeSpinButton ? freeSpinButton.innerHTML : '';

      if (spinButton) {
        spinButton.disabled = true;
        // ğŸ”¥ æ·»åŠ è½¬åŠ¨ä¸­çŠ¶æ€æ˜¾ç¤º
        if (isInAdvancedMode) {
          spinButton.innerHTML = '<span class="flex items-center justify-center gap-2"><span class="animate-spin">âš™ï¸</span><span>è½¬åŠ¨ä¸­...</span></span>';
        } else {
          spinButton.innerHTML = '<span class="animate-spin">âš™ï¸</span> è½¬åŠ¨ä¸­...';
        }
      }
      if (freeSpinButton) {
        freeSpinButton.disabled = true;
        // ğŸ”¥ æ·»åŠ è½¬åŠ¨ä¸­çŠ¶æ€æ˜¾ç¤º
        freeSpinButton.innerHTML = '<span class="animate-spin">âš™ï¸</span> è½¬åŠ¨ä¸­...';
      }
      isSpinning = true;

      try {
        // ğŸ¯ ä¼˜åŒ–ï¼šå…ˆè°ƒç”¨ APIï¼Œæ‰£æ¬¾æˆåŠŸåå†æ’­æ”¾éŸ³æ•ˆå’ŒåŠ¨ç”»
        let apiEndpoint = '/api/slot/spin';
        let requestBody = { useFreeSpinn };
        
        // ğŸ’ è‡³å°Šåœºä½¿ç”¨ä¸“ç”¨API
        if (isInSupremeMode) {
          apiEndpoint = '/api/supreme/spin';
          requestBody = { betAmount: supremeBetAmount * 500000 };  // å¤å¸è½¬èª
          // console.log(`[è‡³å°Šåœº] æŠ•æ³¨é‡‘é¢: ${supremeBetAmount}å¤å¸ (${requestBody.betAmount}èª)`);
        } 
        // ğŸ”¥ é«˜çº§åœºä¼ é€’è‡ªå®šä¹‰æŠ•æ³¨é‡‘é¢
        else if (isInAdvancedMode) {
          requestBody.advancedBetAmount = advancedBetAmount * 500000;  // ç¾å…ƒè½¬èª
          // console.log(`[é«˜çº§åœº] æŠ•æ³¨é‡‘é¢: $${advancedBetAmount} (${requestBody.advancedBetAmount}èª)`);
        }
        
        const res = await fetch(apiEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          isSpinning = false;

          // ğŸ”¥ æ¢å¤æŒ‰é’®æ–‡æœ¬
          if (spinButton) spinButton.innerHTML = originalSpinText;
          if (freeSpinButton) freeSpinButton.innerHTML = originalFreeSpinText;

          // ä»»ä½•é”™è¯¯éƒ½é‡æ–°åŠ è½½é…ç½®ä»¥åŒæ­¥æœ€æ–°æ•°æ®
          try {
            const configRes = await fetch('/api/slot/config');
            const configData = await configRes.json();
            if (configData.success) {
              slotUserData = configData.data.user;
              updateSlotUI();
            }
          } catch (error) {
            console.error('[é…ç½®åŒæ­¥å¤±è´¥]', error);
          }

          // æ ¹æ®æœ€æ–°æ•°æ®æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆå·²ç»è°ƒç”¨äº† updateSlotUIï¼‰
          // updateSlotUI ä¼šè‡ªåŠ¨å¤„ç†æŒ‰é’®çš„æ˜¾ç¤º/éšè—å’Œå¯ç”¨/ç¦ç”¨
          return;
        }

        const result = data.data;

        // ğŸ¯ ä¼˜åŒ–ï¼šAPIæˆåŠŸåå†æ’­æ”¾éŸ³æ•ˆ
        soundManager.playSpin();

        // å¼€å§‹åŠ¨ç”»ï¼ˆéŸ³æ•ˆå’ŒåŠ¨ç”»åŒæ­¥ï¼‰
        await playSpinAnimation(result.symbols);

        // æ›´æ–°ç”¨æˆ·æ•°æ®
        slotUserData.quota = result.quota_after;
        slotUserData.remaining_spins = result.spins_remaining;
        slotUserData.free_spins = result.free_spins_remaining;
        if (!useFreeSpinn) {
          slotUserData.today_count++;
          slotUserData.today_bet += result.bet_amount;
        }
        slotUserData.today_win += result.win_amount;

        updateSlotUI();

        // ğŸ”¥ æŠ•æ³¨åéšè—å¤å‘—buffæç¤ºï¼ˆbuffå·²ä½¿ç”¨ï¼‰
        hideAllKunbeiBuffTips();

        // ğŸ”¥ å¤„ç†å…¥åœºåˆ¸/ç¢ç‰‡æ‰è½ & ğŸ’ è‡³å°Šä»¤ç‰Œ/ç¢ç‰‡æ‰è½
        if (result.ticket_dropped && result.drop_type) {
          // console.log('[æ‰è½] æ£€æµ‹åˆ°æ‰è½:', result.drop_type, result.drop_count);
          // å»¶è¿Ÿæ˜¾ç¤ºæ‰è½åŠ¨ç”»ï¼ˆåœ¨æ—‹è½¬åŠ¨ç”»ä¹‹åï¼‰
          setTimeout(() => {
            playTicketDropAnimation(result.drop_type, result.drop_count);
          }, 500);
          
          // åˆ·æ–°å…¥åœºåˆ¸ä¿¡æ¯å’Œè‡³å°Šä»¤ç‰Œä¿¡æ¯
          setTimeout(() => {
            loadAdvancedTickets();
            loadSupremeTokens();  // ğŸ’ åˆ·æ–°è‡³å°Šä»¤ç‰Œ
          }, 1000);
        }

        // åˆ·æ–°æ’è¡Œæ¦œï¼ˆå¦‚æœä¸­å¥–ï¼‰
        if (result.win_amount > 0) {
          setTimeout(() => loadSidebarLeaderboard(), 1000);
        }

        // æ›´æ–°å¾…å‘æ”¾è®°å½•å’Œä½™é¢
        setTimeout(() => loadPendingRewardsSummary(), 500);

        // æ’­æ”¾ç»“æœéŸ³æ•ˆ
        if (result.multiplier < 0) {
          // æƒ©ç½šéŸ³æ•ˆ
          soundManager.playPunishment();
        } else if (result.multiplier > 0) {
          // ä¸­å¥–éŸ³æ•ˆ
          soundManager.playWin(result.multiplier);
        } else {
          // æœªä¸­å¥–éŸ³æ•ˆ
          soundManager.playLose();
        }
        
        // ğŸ”¥ æ˜¾ç¤ºç»“æœï¼ˆä½¿ç”¨å¯¹åº”åœºæ¬¡çš„ç»“æœå®¹å™¨ï¼‰
        if (resultText) resultText.textContent = data.message;
        if (resultDiv) resultDiv.classList.remove('hidden');

        // ğŸ”¥ æ ¹æ®å€ç‡åŠ¨æ€è®¾ç½®æç¤ºåœç•™æ—¶é—´ï¼ˆé€‚é…ä»»æ„è§„åˆ™é…ç½®ï¼‰
        let displayDuration = 3000; // é»˜è®¤3ç§’

        if (result.multiplier >= 100) {
          // è¶…é«˜å€ç‡ï¼ˆâ‰¥100xï¼‰ï¼š5ç§’
          displayDuration = 5000;
        } else if (result.multiplier >= 20) {
          // é«˜å€ç‡ï¼ˆ20-99xï¼‰ï¼š4.5ç§’
          displayDuration = 4500;
        } else if (result.multiplier >= 10) {
          // ä¸­é«˜å€ç‡ï¼ˆ10-19xï¼‰ï¼š4ç§’
          displayDuration = 4000;
        } else if (result.multiplier >= 5) {
          // ä¸­ç­‰å€ç‡ï¼ˆ5-9xï¼‰ï¼š3.5ç§’
          displayDuration = 3500;
        } else if (result.multiplier >= 2) {
          // ä½å€ç‡ï¼ˆ2-4xï¼‰ï¼š3ç§’
          displayDuration = 3000;
        } else if (result.multiplier < 0) {
          // æƒ©ç½šï¼š3ç§’ï¼ˆè®©ç©å®¶çœ‹æ¸…æ¥šæ‰£æ¬¾ï¼‰
          displayDuration = 3000;
        } else {
          // æœªä¸­å¥–ï¼š1ç§’
          displayDuration = 1000;
        }

        setTimeout(() => {
          resultDiv.classList.add('hidden');
        }, displayDuration);

        // å¦‚æœä¸­å¥–ï¼Œæ˜¾ç¤ºToast
        if (result.win_amount > 0) {
          setTimeout(() => {
            showToast(data.message, 'success');
          }, 500);
        }

        // ğŸ† æ˜¾ç¤ºæˆå°±è§£é”Toastï¼ˆå·¦ä¸Šè§’ï¼‰
        if (result.unlocked_achievements && result.unlocked_achievements.length > 0) {
          // å»¶è¿Ÿæ˜¾ç¤ºæˆå°±Toastï¼Œé¿å…ä¸ä¸­å¥–Toastå†²çª
          // å¦‚æœæœ‰ä¸­å¥–Toastï¼Œå»¶è¿Ÿ2ç§’ï¼›å¦åˆ™å»¶è¿Ÿ1ç§’
          const achievementDelay = result.win_amount > 0 ? 2000 : 1000;

          result.unlocked_achievements.forEach((achievement, index) => {
            setTimeout(() => {
              showAchievementToast(achievement);
            }, achievementDelay + (index * 1000));  // æ¯ä¸ªæˆå°±é—´éš”1ç§’
          });
        }

      } catch (error) {
        console.error('æ—‹è½¬å¤±è´¥:', error);
        showToast('æ—‹è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');

        // ğŸ”¥ æ¢å¤æŒ‰é’®æ–‡æœ¬
        if (spinButton) spinButton.innerHTML = originalSpinText;
        if (freeSpinButton) freeSpinButton.innerHTML = originalFreeSpinText;
      } finally {
        isSpinning = false;

        // ğŸ”¥ æ¢å¤æŒ‰é’®æ–‡æœ¬
        if (spinButton) spinButton.innerHTML = originalSpinText;
        if (freeSpinButton) freeSpinButton.innerHTML = originalFreeSpinText;

        // ğŸ”¥ æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆåŒºåˆ†é«˜çº§åœºå’Œåˆçº§åœºï¼‰
        if (isInAdvancedMode) {
          // é«˜çº§åœºï¼šæ§åˆ¶æŠ•æ³¨é€‰æ‹©å™¨å†…çš„æŒ‰é’®
          const advSpinBtn = document.getElementById('advancedSpinButton');
          if (advSpinBtn && slotUserData.quota >= (advancedBetAmount * 500000)) {
            advSpinBtn.disabled = false;
          }
        } else {
          // åˆçº§åœºï¼šæ§åˆ¶æ™®é€šspinæŒ‰é’®
          if (slotUserData.remaining_spins > 0 && slotUserData.quota >= slotConfig.min_quota_required) {
            spinButton.disabled = false;
          }
          if (slotUserData.free_spins > 0) {
            freeSpinButton.disabled = false;
          }
        }
      }
    }

    // ğŸ”¥ æ–°ç‰ˆï¼šæ’­æ”¾æ—‹è½¬åŠ¨ç”»ï¼ˆæ”¯æŒä¸‰ä¸ªåœºæ¬¡çš„ç‹¬ç«‹æ»šè½®ï¼‰
    async function playSpinAnimation(finalSymbols) {
      // ğŸ”¥ æ ¹æ®å½“å‰åœºæ¬¡é€‰æ‹©å¯¹åº”çš„æ»šè½®å®¹å™¨
      let reelsContainerId;
      if (isInSupremeMode) {
        reelsContainerId = 'supremeSlotReels';
      } else if (isInAdvancedMode) {
        reelsContainerId = 'advancedSlotReels';
      } else {
        reelsContainerId = 'slotReels';
      }
      
      const reelsContainer = document.getElementById(reelsContainerId);
      if (!reelsContainer) {
        console.error('[playSpinAnimation] æ‰¾ä¸åˆ°æ»šè½®å®¹å™¨:', reelsContainerId);
        return;
      }

      const reels = reelsContainer.querySelectorAll('.slot-reel');
      
      // ğŸ¯ ä¼˜åŒ–ï¼šæ‰€æœ‰æ»šè½®åŒæ—¶å¯åŠ¨ï¼Œåˆ¶é€ åŒæ­¥æ„Ÿ
      const startTime = Date.now();
      const animationPromises = [];
      
      reels.forEach((reel, idx) => {
        animationPromises.push(animateReel(reel, finalSymbols[idx], idx, startTime));
      });

      // ç­‰å¾…æ‰€æœ‰æ»šè½®åŠ¨ç”»å®Œæˆ
      await Promise.all(animationPromises);
    }

    // å•ä¸ªæ»šè½®åŠ¨ç”»ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function animateReel(reel, finalSymbol, reelIndex, startTime) {
      return new Promise((resolve) => {
        const symbolsContainer = reel.querySelector('.slot-symbols');

        // ğŸ¯ ä¼˜åŒ–ï¼šå“åº”å¼ç¬¦å·é«˜åº¦ï¼ˆæ ¹æ®å±å¹•å¤§å°è‡ªé€‚åº”ï¼‰
        const isMobile = window.innerWidth <= 768;
        const symbolHeight = isMobile ? 70 : (window.innerWidth <= 1024 ? 100 : 180);

        // æ¸…ç©ºç°æœ‰ç¬¦å·
        symbolsContainer.innerHTML = '';
        symbolsContainer.style.transform = '';
        symbolsContainer.style.filter = '';

        // ğŸ¯ è‡³å°Šåœºä¸“å±ä¼˜åŒ–ï¼šæ›´å¿«èŠ‚å¥ï¼Œé»„é‡‘æ‚¬å¿µæ„Ÿï¼ˆ3ç§’æ€»æ—¶é•¿ï¼‰
        // ğŸ¯ åˆçº§åœº/é«˜çº§åœºï¼šä¿æŒåŸæœ‰èŠ‚å¥ï¼ˆ3.8ç§’æ€»æ—¶é•¿ï¼‰
        let baseDuration, durationIncrement, baseSymbolCount, blurIntensity;

        if (isInSupremeMode) {
          // ğŸ’ è‡³å°Šåœºé…ç½® - æ–¹æ¡ˆ3ã€Œæ¸è¿›å¼æ‚¬å¿µã€
          // è®¾è®¡ç†å¿µï¼šæ¸è¿›å¼å‡é€Ÿï¼Œæœ€åä¸€ä¸ªæ»šè½®è¶…ç¼“æ…¢æ»‘åŠ¨ï¼Œè¥é€ æè‡´æ‚¬å¿µ
          baseDuration = 1600;        // åŸºç¡€1.6ç§’ï¼ˆç¬¬ä¸€ä¸ªæ›´å¿«ï¼‰
          durationIncrement = 800;    // æ¯ä¸ªæ»šè½®é€’å¢800msï¼ˆæ¢¯åº¦æ›´æ˜æ˜¾ï¼‰
          baseSymbolCount = 22;       // èµ·å§‹ç¬¦å·æ•°
          blurIntensity = reelIndex === 3 ? 6 : 5;  // é€‚åº¦æ¨¡ç³Š
          // æ€»æ—¶é•¿: 1.6s, 2.4s, 3.2s, 5.0s
          // ç¬¬4ä¸ªæ»šè½®ç‰¹æ®Šå¤„ç†ï¼š5ç§’è¶…æ…¢æ»‘åŠ¨ï¼Œè®©ç”¨æˆ·èƒ½æ¸…æ™°çœ‹åˆ°ç¬¦å·ä¸€ä¸ªä¸ªç¼“æ…¢ç»è¿‡
        } else {
          // ğŸ° åˆçº§åœº/é«˜çº§åœºé…ç½® - ä¿æŒåŸæœ‰ä½“éªŒ
          baseDuration = 2000;        // åŸºç¡€2ç§’
          durationIncrement = 600;    // æ¯ä¸ªæ»šè½®å¢åŠ 600ms
          baseSymbolCount = 25;       // èµ·å§‹ç¬¦å·æ•°
          blurIntensity = reelIndex === 3 ? 6 : 5;  // æ ‡å‡†æ¨¡ç³Š
          // æ€»æ—¶é•¿: 2s, 2.6s, 3.2s, 3.8s
        }

        let duration = baseDuration + (reelIndex * durationIncrement);

        // ğŸ¯ è‡³å°Šåœºç¬¬4ä¸ªæ»šè½®ç‰¹æ®Šå¤„ç†ï¼šè¶…é•¿æ—¶é—´è¥é€ æè‡´æ‚¬å¿µ
        if (isInSupremeMode && reelIndex === 3) {
          duration = 5000;  // 5ç§’ï¼Œè¶…ç¼“æ…¢æ»‘åŠ¨ï¼Œè®©ç”¨æˆ·ç»å†å¸Œæœ›ä¸ç»æœ›çš„äº¤æ›¿
        }

        // ğŸ¯ ä¼˜åŒ–ï¼šæœ€åä¸€ä¸ªæ»šè½®æ—‹è½¬æ›´å¤šç¬¦å·ï¼Œå¢åŠ æ‚¬å¿µæ„Ÿ
        const symbolCount = Math.floor(baseSymbolCount + (reelIndex * 8)); // é€’å¢ç¬¦å·æ•°é‡
        
        // ç”Ÿæˆç¬¦å·åºåˆ—ï¼ˆéšæœºç¬¦å· + æœ€ç»ˆç¬¦å·ï¼‰
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < symbolCount; i++) {
          const symbol = i === symbolCount - 1 
            ? finalSymbol 
            : SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
          fragment.appendChild(createSymbolElement(symbol));
        }
        symbolsContainer.appendChild(fragment); // ä¸€æ¬¡æ€§æ·»åŠ ï¼Œæ€§èƒ½æ›´å¥½

        // ğŸ¯ ä¼˜åŒ–ï¼šä¸åŒç¼“åŠ¨å‡½æ•°ï¼Œæœ€åä¸€ä¸ªæ»šè½®æ›´å¹³æ»‘å‡é€Ÿ
        const easingFunctions = [
          'cubic-bezier(0.25, 0.46, 0.45, 0.94)',  // reel 0: ease-out-quad
          'cubic-bezier(0.42, 0, 0.58, 1)',        // reel 1: ease-in-out
          'cubic-bezier(0.65, 0, 0.35, 1)',        // reel 2: ease-in-out-cubic
          'cubic-bezier(0.22, 0.61, 0.36, 1)'      // reel 3: ease-out-expo (æœ€å¹³æ»‘)
        ];
        const easing = easingFunctions[reelIndex] || easingFunctions[3];

        // ğŸ¯ ä¼˜åŒ–ï¼šæ›´ä¸æ»‘çš„æ¨¡ç³Šæ•ˆæœå’Œå…³é”®å¸§ (blurIntensityå·²åœ¨ä¸Šæ–¹æ ¹æ®åœºæ¬¡é…ç½®)

        // ğŸ¯ è‡³å°Šåœºç¬¬4ä¸ªæ»šè½®ï¼šç‰¹æ®Š"æ¸è¿›å¼æ‚¬å¿µ"åŠ¨ç”»ï¼Œè¶…ç¼“æ…¢æ»‘åŠ¨è¥é€ æè‡´æ‚¬å¿µæ„Ÿ
        let animation;
        if (isInSupremeMode && reelIndex === 3) {
          // è®¾è®¡ç†å¿µï¼šè®©ç¬¦å·ä¸€ä¸ªä¸ªç¼“æ…¢ç»è¿‡ï¼Œç”¨æˆ·èƒ½æ¸…æ™°çœ‹åˆ°æ¯ä¸ªç¬¦å·ï¼Œåˆ¶é€ "å¸Œæœ›â†’ç»æœ›â†’å¸Œæœ›"çš„å¿ƒç†æ³¢åŠ¨
          animation = symbolsContainer.animate([
            // é˜¶æ®µ1ï¼šå¿«é€Ÿå¯åŠ¨ (0-10%, 0-500ms)
            {
              transform: 'translateY(0px)',
              filter: 'blur(0px)',
              offset: 0
            },
            {
              transform: 'translateY(-100px)',
              filter: `blur(${blurIntensity}px)`,
              offset: 0.1  // 500msï¼Œå¿«é€ŸåŠ é€Ÿ
            },
            // é˜¶æ®µ2ï¼šé«˜é€Ÿæ—‹è½¬ (10-60%, 500-3000ms)
            {
              transform: `translateY(-${(symbolCount - 12) * symbolHeight}px)`,
              filter: `blur(${blurIntensity}px)`,
              offset: 0.6  // ä¿æŒé«˜é€Ÿ2.5ç§’
            },
            // é˜¶æ®µ3ï¼šå¼€å§‹æ˜æ˜¾å‡é€Ÿ (60-75%, 3000-3750ms)
            {
              transform: `translateY(-${(symbolCount - 6) * symbolHeight}px)`,
              filter: 'blur(3px)',
              offset: 0.75  // å‡é€Ÿï¼Œæ¨¡ç³Šå‡å¼±
            },
            // ğŸ¯ é˜¶æ®µ4ï¼šç¼“æ…¢æ»‘åŠ¨åŒºåŸŸå¼€å§‹ (75-82%, 3750-4100ms)
            // ç”¨æˆ·èƒ½å¼€å§‹çœ‹æ¸…ç¬¦å·äº†
            {
              transform: `translateY(-${(symbolCount - 4.5) * symbolHeight}px)`,
              filter: 'blur(1px)',
              offset: 0.82  // å¾ˆæ…¢ï¼Œå¾®æ¨¡ç³Š
            },
            // ğŸ¯ é˜¶æ®µ5ï¼šè¶…çº§ç¼“æ…¢æ»‘åŠ¨ (82-88%, 4100-4400ms)
            // ç»è¿‡å€’æ•°ç¬¬4ä¸ªç¬¦å·ï¼Œçœ‹å¾—éå¸¸æ¸…æ¥š
            {
              transform: `translateY(-${(symbolCount - 3.5) * symbolHeight}px)`,
              filter: 'blur(0px)',
              offset: 0.88  // è¶…æ…¢ï¼Œå®Œå…¨æ¸…æ™°ï¼Œ"æ˜¯manå—ï¼Ÿ"
            },
            // ğŸ¯ é˜¶æ®µ6ï¼šç»§ç»­ç¼“æ…¢æ»‘åŠ¨ (88-93%, 4400-4650ms)
            // ç»è¿‡å€’æ•°ç¬¬3ä¸ªç¬¦å·ï¼Œ"å“¦ä¸ï¼Œæ»‘è¿‡å»äº†..."
            {
              transform: `translateY(-${(symbolCount - 2.3) * symbolHeight}px)`,
              filter: 'blur(0px)',
              offset: 0.93  // ç»§ç»­ç¼“æ…¢ï¼Œ"è¿˜æœ‰å¸Œæœ›å—ï¼Ÿ"
            },
            // ğŸ¯ é˜¶æ®µ7ï¼šæœ€åçš„ç¼“æ…¢ (93-97%, 4650-4850ms)
            // ç»è¿‡å€’æ•°ç¬¬2ä¸ªç¬¦å·ï¼Œ"è¿™ä¸ªä¹Ÿä¸æ˜¯..."
            {
              transform: `translateY(-${(symbolCount - 1.5) * symbolHeight}px)`,
              filter: 'blur(0px)',
              offset: 0.97  // ææ…¢ï¼Œå¿ƒç†ç…ç†¬è¾¾åˆ°é¡¶ç‚¹
            },
            // ğŸ¯ é˜¶æ®µ8ï¼šæœ€ç»ˆåœæ­¢ (97-100%, 4850-5000ms)
            {
              transform: `translateY(-${(symbolCount - 1) * symbolHeight}px)`,
              filter: 'blur(0px)',
              offset: 1  // ç»ˆäºåœäº†ï¼
            }
          ], {
            duration: duration,  // 5000ms
            easing: 'cubic-bezier(0.16, 0.84, 0.44, 1)',  // è¶…å¹³æ»‘çš„ease-outï¼Œæ²¡æœ‰å›å¼¹
            fill: 'forwards'
          });
        } else {
          // ğŸ° æ™®é€šåŠ¨ç”»ï¼ˆåˆçº§åœº/é«˜çº§åœºï¼Œä»¥åŠè‡³å°Šåœºå‰3ä¸ªæ»šè½®ï¼‰
          animation = symbolsContainer.animate([
            {
              transform: 'translateY(0px)',
              filter: 'blur(0px)',
              offset: 0
            },
            {
              transform: 'translateY(-80px)',
              filter: `blur(${blurIntensity}px)`,
              offset: 0.1  // å¿«é€ŸåŠ é€Ÿ
            },
            {
              transform: `translateY(-${(symbolCount - 10) * symbolHeight}px)`,
              filter: `blur(${blurIntensity}px)`,
              offset: 0.7  // ä¿æŒé«˜é€Ÿ
            },
            {
              transform: `translateY(-${(symbolCount - 3) * symbolHeight}px)`,
              filter: 'blur(2px)',
              offset: 0.92  // å¼€å§‹å‡é€Ÿå¹¶å‡å°‘æ¨¡ç³Š
            },
            {
              transform: `translateY(-${(symbolCount - 1) * symbolHeight}px)`,
              filter: 'blur(0px)',
              offset: 1  // å®Œå…¨åœæ­¢ï¼Œæ¸…æ™°æ˜¾ç¤º
            }
          ], {
            duration: duration,
            easing: easing,
            fill: 'forwards'
          });
        }

        // ğŸ¯ ä¼˜åŒ–ï¼šæ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œé˜²æ­¢åŠ¨ç”»å¡æ­»
        const timeoutId = setTimeout(() => {
          if (animation.playState !== 'finished') {
            animation.finish();
          }
        }, duration + 500);

        // åŠ¨ç”»ç»“æŸå
        animation.onfinish = () => {
          clearTimeout(timeoutId);
          
          // åœæ­¢åŠ¨ç”»
          animation.cancel();
          
          // åªä¿ç•™æœ€ç»ˆç¬¦å·ï¼Œæ¸…ç©ºå…¶ä»–ï¼ŒèŠ‚çœå†…å­˜
          symbolsContainer.innerHTML = '';
          const finalElement = createSymbolElement(finalSymbol);
          symbolsContainer.appendChild(finalElement);
          
          // é‡ç½®transformå’Œfilter
          symbolsContainer.style.transform = 'translateY(0)';
          symbolsContainer.style.filter = 'none';
          
          // ğŸ¯ ä¼˜åŒ–ï¼šæœ€åä¸€ä¸ªæ»šè½®åœæ­¢æ—¶æ·»åŠ é—ªçƒæ•ˆæœï¼Œå¢å¼ºè§†è§‰åé¦ˆ
          if (reelIndex === 3) {
            const reelContainer = reel.closest('.slot-reel-container');
            if (reelContainer) {
              // æ·»åŠ è„‰å†²åŠ¨ç”»
              reelContainer.style.animation = 'pulse 0.3s ease-in-out 2';
              setTimeout(() => {
                reelContainer.style.animation = '';
              }, 600);
            }
          }
          
          resolve();
        };
      });
    }

    // æ˜¾ç¤ºæ¸¸æˆè®°å½•
    // å…¨å±€å­˜å‚¨æ‰€æœ‰è®°å½•ï¼ˆç”¨äºç­›é€‰ï¼‰
    let allSlotRecords = [];
    
    async function showSlotRecords() {
      // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');
      
      try {
        // ğŸ”¥ æ ¹æ®å½“å‰æ¨¡å¼è·å–å¯¹åº”çš„è®°å½•ï¼ˆæ”¯æŒè‡³å°Šåœºï¼‰
        let mode, modeName;
        if (isInSupremeMode) {
          mode = 'supreme';
          modeName = 'è‡³å°Šåœº';
        } else if (isInAdvancedMode) {
          mode = 'advanced';
          modeName = 'é«˜çº§åœº';
        } else {
          mode = 'normal';
          modeName = 'åˆçº§åœº';
        }
        
        // å¹¶è¡Œè·å–æŠ½å¥–è®°å½•å’Œå¾…å‘æ”¾è®°å½•
        const [recordsRes, pendingRes] = await Promise.all([
          fetch(`/api/slot/records?mode=${mode}`),
          fetch('/api/slot/pending-rewards')
        ]);
        
        const recordsData = await recordsRes.json();
        const pendingData = await pendingRes.json();

        if (!recordsData.success) {
          showToast(recordsData.message, 'error');
          return;
        }

        // ä¿å­˜æ‰€æœ‰è®°å½•åˆ°å…¨å±€å˜é‡
        allSlotRecords = recordsData.data;
        
        // è°ƒè¯•ï¼šæ£€æŸ¥win_typeåˆ†å¸ƒ
        // console.log('[è®°å½•ç»Ÿè®¡] æ€»è®°å½•æ•°:', allSlotRecords.length);
        const winTypeStats = {};
        allSlotRecords.forEach(r => {
          const winType = r.win_type || 'null';
          winTypeStats[winType] = (winTypeStats[winType] || 0) + 1;
        });
        // console.log('[è®°å½•ç»Ÿè®¡] win_typeåˆ†å¸ƒ:', winTypeStats);
        
        // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºå½“å‰åœºæ¬¡
        document.getElementById('slotRecordsTitle').textContent = `ğŸ° æˆ‘çš„æŠ½å¥–è®°å½• - ${modeName}`;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('slotRecordsModal').classList.remove('hidden');

        // æ¸²æŸ“è®°å½•ï¼ˆæ˜¾ç¤ºå…¨éƒ¨ï¼‰
        renderSlotRecords(allSlotRecords);

        // ğŸ”¥ ç§»é™¤å·²åˆ é™¤çš„ filterResultHint å…ƒç´ å¼•ç”¨ï¼ˆè¯¥å…ƒç´ åœ¨æç®€æ¨¡å¼ä¸­å·²è¢«ç§»é™¤ï¼‰
        // document.getElementById('filterResultHint').textContent = `ğŸ“Š æ€»è®°å½•æ•°: ${allSlotRecords.length}`;
        // document.getElementById('filterResultHint').classList.remove('hidden');

        // æ¸²æŸ“å¾…å‘æ”¾è®°å½•
        if (pendingData.success && pendingData.data) {
          renderPendingRewards(pendingData.data);
        }
      } catch (error) {
        console.error('è·å–æŠ½å¥–è®°å½•å¤±è´¥:', error);
        showToast('è·å–æŠ½å¥–è®°å½•å¤±è´¥', 'error');
      }
    }
    
    // åˆ·æ–°å¾…å‘æ”¾è®°å½•
    async function refreshPendingRewards() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();
        
        if (data.success && data.data) {
          renderPendingRewards(data.data);
          showToast('å¾…å‘æ”¾è®°å½•å·²æ›´æ–°', 'success');
        }
      } catch (error) {
        console.error('åˆ·æ–°å¾…å‘æ”¾è®°å½•å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥', 'error');
      }
    }
    
    // æ¸²æŸ“å¾…å‘æ”¾è®°å½•
    function renderPendingRewards(data) {
      const section = document.getElementById('pendingRewardsSection');
      const container = document.getElementById('pendingRewardsContent');
      
      const { summary, rewards } = data;
      
      // å¦‚æœæ²¡æœ‰ä»»ä½•è®°å½•ï¼Œéšè—æ•´ä¸ªåŒºåŸŸ
      if (!rewards || rewards.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      // æ˜¾ç¤ºåŒºåŸŸ
      section.classList.remove('hidden');
      
      // ç­›é€‰å¾…å‘æ”¾å’Œå·²æˆåŠŸçš„è®°å½•
      const pendingRewards = rewards.filter(r => 
        r.status === 'pending' || r.status === 'processing' || r.status === 'failed'
      );
      const successRewards = rewards.filter(r => r.status === 'success');
      
      let html = '';
      
      // æ±‡æ€»å¡ç‰‡
      html += `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="bg-white rounded-lg p-3 border-2 border-orange-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">å¾…å‘æ”¾</p>
            <p class="text-xl font-bold text-orange-600">$${(summary.pending_amount / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">${summary.pending_count} ç¬”</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-green-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">å·²å‘æ”¾</p>
            <p class="text-xl font-bold text-green-600">$${(summary.success_amount / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">${summary.success_count} ç¬”</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-indigo-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">æ€»ç¬”æ•°</p>
            <p class="text-xl font-bold text-indigo-600">${summary.total_count}</p>
            <p class="text-xs text-slate-500">æ‰€æœ‰è®°å½•</p>
          </div>
          <div class="bg-white rounded-lg p-3 border-2 border-purple-200 shadow-sm">
            <p class="text-xs text-slate-600 mb-1">æ€»é‡‘é¢</p>
            <p class="text-xl font-bold text-purple-600">$${((summary.pending_amount + summary.success_amount) / 500000).toFixed(2)}</p>
            <p class="text-xs text-slate-500">å¾…å‘+å·²å‘</p>
          </div>
        </div>
      `;
      
      // å¾…å‘æ”¾è®°å½•åˆ—è¡¨
      if (pendingRewards.length > 0) {
        html += `
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-orange-700 mb-2 flex items-center gap-2">
              <span>â³</span>
              <span>å¾…å‘æ”¾ (${pendingRewards.length})</span>
            </h4>
            <div class="space-y-2">
        `;
        
        pendingRewards.forEach(reward => {
          const statusColor = {
            'pending': 'bg-yellow-100 text-yellow-700 border-yellow-300',
            'processing': 'bg-blue-100 text-blue-700 border-blue-300',
            'failed': 'bg-red-100 text-red-700 border-red-300'
          }[reward.status] || 'bg-gray-100 text-gray-700 border-gray-300';
          
          const statusText = {
            'pending': 'ç­‰å¾…å‘æ”¾',
            'processing': 'å‘æ”¾ä¸­',
            'failed': 'å¤±è´¥é‡è¯•'
          }[reward.status] || reward.status;
          
          html += `
            <div class="bg-white rounded-lg p-3 border border-orange-200 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-900 text-sm mb-1 truncate">${reward.reason}</p>
                  <p class="text-xs text-slate-500 mb-1">ğŸ• ${formatTimestamp(reward.created_at)}</p>
                  ${reward.error_message ? `<p class="text-xs text-red-600 mt-1">âš ï¸ ${reward.error_message}</p>` : ''}
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-lg font-bold text-orange-600 mb-1">$${reward.amount.toFixed(2)}</p>
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium border ${statusColor}">
                    ${statusText}
                  </span>
                  ${reward.retry_count > 0 ? `<p class="text-xs text-slate-500 mt-1">é‡è¯• ${reward.retry_count} æ¬¡</p>` : ''}
                </div>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      // å·²æˆåŠŸè®°å½•ï¼ˆæŠ˜å æ˜¾ç¤ºæœ€è¿‘5æ¡ï¼‰
      if (successRewards.length > 0) {
        html += `
          <div>
            <h4 class="text-sm font-semibold text-green-700 mb-2 flex items-center gap-2">
              <span>âœ…</span>
              <span>å·²å‘æ”¾ (æœ€è¿‘5æ¡)</span>
            </h4>
            <div class="space-y-2">
        `;
        
        successRewards.slice(0, 5).forEach(reward => {
          html += `
            <div class="bg-white rounded-lg p-3 border border-green-200 shadow-sm opacity-75">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-700 text-sm mb-1 truncate">${reward.reason}</p>
                  <p class="text-xs text-slate-500">ğŸ• ${formatTimestamp(reward.created_at)}</p>
                </div>
                <div class="text-right flex-shrink-0">
                  <p class="text-lg font-bold text-green-600 mb-1">$${reward.amount.toFixed(2)}</p>
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700 border border-green-300">
                    å·²å‘æ”¾
                  </span>
                </div>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    // ğŸ”¥ å…¨å±€æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      // æ ¼å¼åŒ–åŒ—äº¬æ—¶é—´çš„è¾…åŠ©å‡½æ•°
      const formatBeijingTime = (date, options) => {
        return date.toLocaleString('zh-CN', {
          timeZone: 'Asia/Shanghai',
          ...options
        });
      };

      // å¦‚æœæ˜¯ä»Šå¤©
      if (diffDays === 0) {
        if (diffMins < 1) {
          const fullTime = formatBeijingTime(date, {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          return `åˆšåˆš (${fullTime})`;
        }
        if (diffMins < 60) {
          const fullTime = formatBeijingTime(date, {
            hour: '2-digit',
            minute: '2-digit'
          });
          return `${diffMins}åˆ†é’Ÿå‰ (${fullTime})`;
        }
        if (diffHours < 24) {
          const fullTime = formatBeijingTime(date, {
            hour: '2-digit',
            minute: '2-digit'
          });
          return `${diffHours}å°æ—¶å‰ (${fullTime})`;
        }
      }

      // å¦‚æœæ˜¯æ˜¨å¤©
      if (diffDays === 1) {
        const fullTime = formatBeijingTime(date, {
          hour: '2-digit',
          minute: '2-digit'
        });
        return `æ˜¨å¤© ${fullTime}`;
      }

      // å¦‚æœæ˜¯æœ€è¿‘7å¤©å†…
      if (diffDays < 7) {
        const fullTime = formatBeijingTime(date, {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        return `${diffDays}å¤©å‰ (${fullTime})`;
      }

      // è¶…è¿‡7å¤©æ˜¾ç¤ºå®Œæ•´åŒ—äº¬æ—¶é—´
      return formatBeijingTime(date, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // æ¸²æŸ“è€è™æœºè®°å½•
    function renderSlotRecords(records) {
      const container = document.getElementById('slotRecordsContent');

        if (records.length === 0) {
          container.innerHTML = '<p class="text-center text-slate-500 py-8">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>';
          return;
        }
        
        // è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆåŸºäºç­›é€‰åçš„è®°å½•ï¼‰
        const allRecords = records;
          const totalCount = allRecords.length;
          const winCount = allRecords.filter(r => r.win_amount > 0).length;
          const winRate = totalCount > 0 ? ((winCount / totalCount) * 100).toFixed(1) : '0.0';
          
          // ç»Ÿè®¡å„ç§å¥–é¡¹
          const winTypes = {
            'super_jackpot': { name: 'ğŸ† è¶…çº§å¤§å¥–', count: 0, color: 'text-yellow-600' },
            'special_combo': { name: 'ğŸ’ ç‰¹æ®Šç»„åˆ', count: 0, color: 'text-purple-600' },
            'quad': { name: 'ğŸ° å››è¿', count: 0, color: 'text-blue-600' },
            'triple': { name: 'âœ¨ ä¸‰è¿', count: 0, color: 'text-green-600' },
            'double': { name: 'ğŸ åŒè¿', count: 0, color: 'text-teal-600' },
            'man_only': { name: 'ğŸ¯ Manç»„åˆ', count: 0, color: 'text-amber-600' },
            'man_quad': { name: 'ğŸ° ManÃ—4', count: 0, color: 'text-orange-600' },
            'symmetric': { name: 'ğŸ”„ å¯¹ç§°ABBA', count: 0, color: 'text-cyan-600' },
            'consecutive': { name: 'â­ è¿ç»­', count: 0, color: 'text-blue-500' },
            'combination': { name: 'ğŸ ç»„åˆ', count: 0, color: 'text-pink-600' },
            'any': { name: 'ğŸ² ä»»æ„', count: 0, color: 'text-indigo-600' },
            'double_pair': { name: 'ğŸ­ ä¸¤å¯¹', count: 0, color: 'text-violet-600' },
            'punishment': { name: 'âš¡ å¾‹å¸ˆå‡½', count: 0, color: 'text-red-600' },
            'none': { name: 'âŒ æœªä¸­å¥–', count: 0, color: 'text-slate-500' }
          };
          
          allRecords.forEach(r => {
            if (winTypes[r.win_type]) {
              winTypes[r.win_type].count++;
            }
          });
          
          // è®¡ç®—æ€»æŠ•æ³¨å’Œæ€»èµ¢å¾—
          const totalBet = allRecords.reduce((sum, r) => sum + r.bet_amount, 0);
          const totalWin = allRecords.reduce((sum, r) => sum + r.win_amount, 0);
          const netProfit = totalWin - totalBet;
          
          // æ„å»ºç²¾ç®€ç»Ÿè®¡å¡ç‰‡
          const statsHtml = `
            <div class="mb-4 bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 rounded-lg p-4 border border-purple-200">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-bold text-purple-700 flex items-center gap-2">
                  <span>ğŸ“Š</span>
                  <span>æ€»è®°å½•: ${totalCount}æ¬¡ Â· ä¸­å¥–ç‡: ${winRate}% Â· ç›ˆäº: ${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}</span>
                </h3>
              </div>
              
              <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ - ç²¾ç®€ç‰ˆ -->
              <div class="grid grid-cols-4 gap-2 mb-3">
                <!-- ä¸­å¥–ç‡ -->
                <div class="bg-white rounded-lg p-2 text-center shadow-sm border border-purple-100">
                  <div class="text-xl font-bold text-green-600">${winRate}%</div>
                  <p class="text-xs text-slate-600">ä¸­å¥–ç‡</p>
                </div>
                
                <!-- æ€»æŠ•æ³¨ -->
                <div class="bg-white rounded-lg p-2 text-center shadow-sm border border-red-100">
                  <div class="text-xl font-bold text-red-600">$${(totalBet / 500000).toFixed(2)}</div>
                  <p class="text-xs text-slate-600">æ€»æŠ•æ³¨</p>
                </div>
                
                <!-- æ€»èµ¢å¾— -->
                <div class="bg-white rounded-lg p-2 text-center shadow-sm border border-green-100">
                  <div class="text-xl font-bold text-green-600">$${(totalWin / 500000).toFixed(2)}</div>
                  <p class="text-xs text-slate-600">æ€»èµ¢å¾—</p>
                </div>
                
                <!-- ç›ˆäº -->
                <div class="bg-white rounded-lg p-2 text-center shadow-sm ${netProfit >= 0 ? 'border border-green-100' : 'border border-red-100'}">
                  <div class="text-xl font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${netProfit >= 0 ? '+' : ''}$${(netProfit / 500000).toFixed(2)}
                  </div>
                  <p class="text-xs text-slate-600">å‡€ç›ˆäº</p>
                </div>
              </div>
              
              <!-- å¥–é¡¹åˆ†å¸ƒ - æ ‡ç­¾å¼ -->
              <div class="bg-white rounded-lg p-3 shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-700 mb-2">ğŸ å¥–é¡¹åˆ†å¸ƒ</p>
                <div class="flex flex-wrap gap-1.5">
                  ${Object.entries(winTypes)
                    .filter(([key, data]) => data.count > 0)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([key, data]) => {
                      const percentage = totalCount > 0 ? ((data.count / totalCount) * 100).toFixed(1) : '0.0';
                      return `
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-md text-xs font-medium ${data.color}">
                          <span>${data.name.split(' ')[0]}</span>
                          <span class="font-bold">${data.count}</span>
                          <span class="text-slate-500">(${percentage}%)</span>
                        </span>
                      `;
                    }).join('')}
                </div>
              </div>
              
              ${totalCount > 10 ? `
                <div class="mt-3 text-center">
                  <span class="text-xs font-medium text-purple-600">ğŸ‘‡ ä»¥ä¸‹æ˜¾ç¤ºæœ€è¿‘ 10 æ¡è®°å½•</span>
                </div>
              ` : ''}
            </div>
          `;
          
          // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
          const displayRecords = records.slice(0, 10);
          
          container.innerHTML = statsHtml + displayRecords.map((r, idx) => {
            const isWin = r.win_amount > 0;
            const isLoss = r.win_amount < 0;
            const netAmount = r.win_amount - r.bet_amount;
            
            // ğŸ¨ æ ¹æ®ç»“æœç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
            let cardClass, headerClass, amountClass, badgeClass, iconEmoji;
            if (isWin) {
              cardClass = 'bg-gradient-to-br from-green-50 via-emerald-50 to-green-50 border-green-300 hover:shadow-green-200';
              headerClass = 'bg-gradient-to-r from-green-500 to-emerald-600';
              amountClass = 'text-green-600';
              badgeClass = 'bg-green-100 text-green-700 border-green-300';
              iconEmoji = 'ğŸ‰';
            } else if (isLoss) {
              cardClass = 'bg-gradient-to-br from-red-50 via-rose-50 to-red-50 border-red-300 hover:shadow-red-200';
              headerClass = 'bg-gradient-to-r from-red-500 to-rose-600';
              amountClass = 'text-red-600';
              badgeClass = 'bg-red-100 text-red-700 border-red-300';
              iconEmoji = 'âš¡';
            } else {
              cardClass = 'bg-gradient-to-br from-slate-50 via-gray-50 to-slate-50 border-slate-300 hover:shadow-slate-200';
              headerClass = 'bg-gradient-to-r from-slate-500 to-gray-600';
              amountClass = 'text-slate-600';
              badgeClass = 'bg-slate-100 text-slate-700 border-slate-300';
              iconEmoji = 'â–';
            }

            const symbolsHTML = r.result_symbols.map(s => {
              const ext = ['lq', 'bj', 'bdk'].includes(s) ? 'jpg' : 'png';
              return `<img src="/slot-symbols/${s}.${ext}" alt="${s}" class="w-10 h-10 object-contain border border-white shadow-md rounded-md">`;
            }).join('');

            // ä¼˜å…ˆæ˜¾ç¤º LinuxDo ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºå…¬ç›Šç«™ç”¨æˆ·å
            const displayName = r.linux_do_username || r.username;

            return `
              <div class="border ${cardClass} rounded-lg overflow-hidden mb-3 shadow-sm hover:shadow-md transition-all duration-200">
                <!-- ğŸ¯ ç²¾ç®€å¤´éƒ¨ -->
                <div class="${headerClass} px-3 py-2 flex items-center justify-between text-white">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">${iconEmoji}</span>
                    <span class="font-semibold text-sm">@${displayName}</span>
                    ${r.is_free_spin ? '<span class="px-1.5 py-0.5 bg-white/30 text-white rounded text-xs font-bold">âœ¨</span>' : ''}
                    <span class="text-xs opacity-80">Ã—${r.win_multiplier}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs opacity-90">ğŸ• ${formatTimestamp(r.timestamp)}</span>
                    <span class="text-xs opacity-80">#${displayRecords.length - idx}</span>
                  </div>
                </div>

                <!-- ğŸ“Š ç´§å‡‘å†…å®¹ -->
                <div class="p-3 flex items-center gap-3">
                  <!-- ç¬¦å·æ¨ªå‘æ’åˆ— -->
                  <div class="flex gap-1 flex-shrink-0">
                    ${symbolsHTML}
                  </div>
                  
                  <!-- ä¿¡æ¯åŒºåŸŸ -->
                  <div class="flex-1 min-w-0">
                    <div class="mb-1.5">
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 ${badgeClass} rounded text-xs font-bold">
                        <span>ğŸ¯</span>
                        <span>${r.win_type_name}</span>
                      </span>
                    </div>
                    <div class="text-xs text-slate-600 leading-relaxed">
                      <span class="text-slate-700">æŠ•æ³¨</span> <span class="font-semibold text-slate-900">$${(r.bet_amount / 500000).toFixed(2)}</span>
                      <span class="mx-1">Â·</span>
                      <span class="text-slate-700">èµ¢å¾—</span> <span class="font-semibold ${amountClass}">$${(r.win_amount / 500000).toFixed(2)}</span>
                      <span class="mx-1">Â·</span>
                      <span class="font-semibold ${netAmount >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${netAmount >= 0 ? '+' : ''}$${(netAmount / 500000).toFixed(2)}
                      </span>
                    </div>
                    ${r.free_spin_awarded ? `
                      <div class="mt-1.5 text-xs text-purple-700 font-semibold">
                        ğŸ è·å¾—å…è´¹æŠ½å¥–æ¬¡æ•°ï¼
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('');
    }

    // ç­›é€‰è€è™æœºè®°å½•
    // ç­›é€‰åŠŸèƒ½å·²ç®€åŒ–ï¼ˆæç®€æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è®°å½•ï¼‰
    function filterSlotRecords() {
      // ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è®°å½•
      renderSlotRecords(allSlotRecords);
    }

    // åˆ·æ–°è®°å½•ï¼ˆæç®€æ¨¡å¼ï¼‰
    async function refreshSlotRecordsKeepFilter() {
      try {
        // æ ¹æ®å½“å‰æ¨¡å¼é‡æ–°è·å–æ•°æ®
        const mode = isInAdvancedMode ? 'advanced' : 'normal';
        const recordsRes = await fetch(`/api/slot/records?mode=${mode}`);
        const recordsData = await recordsRes.json();
        
        if (!recordsData.success) {
          showToast(recordsData.message, 'error');
          return;
        }
        
        // æ›´æ–°å…¨å±€è®°å½•
        allSlotRecords = recordsData.data;
        
        // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
        renderSlotRecords(allSlotRecords);
        
        showToast('è®°å½•å·²åˆ·æ–°', 'success');
      } catch (error) {
        console.error('åˆ·æ–°è®°å½•å¤±è´¥:', error);
        showToast('åˆ·æ–°å¤±è´¥', 'error');
      }
    }

    // æ¸…é™¤ç­›é€‰ï¼ˆæç®€æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è®°å½•ï¼‰
    function clearRecordFilters() {
      // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
      renderSlotRecords(allSlotRecords);
    }

    // å…³é—­æ¸¸æˆè®°å½•
    function closeSlotRecords() {
      document.getElementById('slotRecordsModal').classList.add('hidden');
    }

    // æ˜¾ç¤ºæ¸¸æˆè§„åˆ™
    async function showSlotRules() {
      // ğŸ”¥ åŠ è½½å½“å‰åœºæ¬¡çš„å®é™…é…ç½®è§„åˆ™
      try {
        const res = await fetch('/api/slot/rules');
        const data = await res.json();
        
        if (data.success) {
          const { mode, rules, punishments, weightConfig, totalWeight } = data.data;
          
          // æ›´æ–°è§„åˆ™åˆ—è¡¨æ˜¾ç¤º
          const rulesContainer = document.getElementById('currentRulesDisplay');
          if (rulesContainer) {
            const modeText = mode === 'advanced' ? 'ğŸ”¥ é«˜çº§åœºæ¨¡å¼' : 'ğŸ° åˆçº§åœºæ¨¡å¼';
            
            // æ›´æ–°æ¨¡æ€æ¡†ä¸»é¢˜æ ·å¼
            const modalContent = document.getElementById('slotRulesModalContent');
            const modalHeader = document.getElementById('slotRulesModalHeader');
            const modalBody = document.getElementById('slotRulesModalBody');
            const closeBtn = document.getElementById('slotRulesCloseBtn');
            const titleIcon = document.getElementById('rulesModalIcon');
            const titleText = document.getElementById('rulesModalTitle');
            
            // å®šä¹‰åœºæ¬¡ä¸»é¢˜é¢œè‰²
            let themeColors = {
              headerBg: 'from-blue-500/20 to-cyan-500/20',
              headerBorder: 'border-blue-400/50',
              headerTitle: 'text-blue-300',
              headerDesc: 'text-blue-200',
              sectionBg: 'bg-blue-900/50',
              sectionBorder: 'border-blue-500/30',
              sectionTitle: 'text-blue-300'
            };
            
            if (mode === 'advanced') {
              if (titleIcon) titleIcon.textContent = 'ğŸ”¥';
              if (titleText) titleText.textContent = 'é«˜çº§åœºæ¸¸æˆè§„åˆ™';
              // é«˜çº§åœºï¼šé‡‘è‰²ä¸»é¢˜
              themeColors = {
                headerBg: 'from-amber-500/20 to-yellow-500/20',
                headerBorder: 'border-amber-400/50',
                headerTitle: 'text-amber-300',
                headerDesc: 'text-amber-200',
                sectionBg: 'bg-amber-900/50',
                sectionBorder: 'border-amber-500/30',
                sectionTitle: 'text-amber-300'
              };
              // æ›´æ–°æ¨¡æ€æ¡†æ ·å¼ä¸ºé‡‘è‰²
              if (modalContent) {
                modalContent.className = 'bg-gradient-to-br from-amber-900 to-yellow-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-amber-400';
              }
              if (modalHeader) {
                modalHeader.className = 'flex justify-between items-center p-6 border-b border-amber-400/30 bg-gradient-to-r from-amber-600 via-yellow-600 to-amber-500';
              }
              if (modalBody) {
                modalBody.className = 'p-6 overflow-y-auto max-h-[calc(90vh-100px)] bg-gradient-to-b from-amber-900/50 to-black/50';
              }
              if (closeBtn) {
                closeBtn.className = 'text-white hover:text-amber-200 transition-colors';
              }
            } else {
              if (titleIcon) titleIcon.textContent = 'ğŸ°';
              if (titleText) titleText.textContent = 'åˆçº§åœºæ¸¸æˆè§„åˆ™';
              // åˆçº§åœºï¼šè“è‰²ä¸»é¢˜
              // æ›´æ–°æ¨¡æ€æ¡†æ ·å¼ä¸ºè“è‰²
              if (modalContent) {
                modalContent.className = 'bg-gradient-to-br from-blue-900 to-cyan-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl border-2 border-blue-400';
              }
              if (modalHeader) {
                modalHeader.className = 'flex justify-between items-center p-6 border-b border-blue-400/30 bg-gradient-to-r from-blue-600 via-cyan-600 to-blue-500';
              }
              if (modalBody) {
                modalBody.className = 'p-6 overflow-y-auto max-h-[calc(90vh-100px)] bg-gradient-to-b from-blue-900/50 to-black/50';
              }
              if (closeBtn) {
                closeBtn.className = 'text-white hover:text-blue-200 transition-colors';
              }
            }
            
            let rulesHTML = `
              <div class="bg-gradient-to-r ${themeColors.headerBg} backdrop-blur-md rounded-xl p-5 border-2 ${themeColors.headerBorder} mb-6">
                <div class="flex items-center justify-center gap-3 mb-3">
                  <span class="text-3xl">${mode === 'advanced' ? 'ğŸ”¥' : 'ğŸ°'}</span>
                  <h3 class="text-2xl font-bold ${themeColors.headerTitle}">${mode === 'advanced' ? 'é«˜çº§åœº' : 'åˆçº§åœº'}</h3>
                  <span class="text-3xl">${mode === 'advanced' ? 'ğŸ”¥' : 'ğŸ°'}</span>
                </div>
                <p class="text-center ${themeColors.headerDesc} text-sm">${mode === 'advanced' ? 'é«˜å€å¥–åŠ± Â· åˆºæ¿€ä½“éªŒ Â· éœ€è¦å…¥åœºåˆ¸' : 'æ ‡å‡†æ¨¡å¼ Â· æ¯æ—¥é™å®š Â· é€‚åˆæ–°æ‰‹'}</p>
              </div>
            `;
            
            // åŸºç¡€é…ç½®
            rulesHTML += `
              <div class="${themeColors.sectionBg} rounded-xl p-4 mb-4 border ${themeColors.sectionBorder}">
                <h4 class="font-bold ${themeColors.sectionTitle} mb-3 text-lg">âš™ï¸ åŸºç¡€é…ç½®</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
            `;
            
            if (mode === 'advanced') {
              const advConfig = data.data.advancedConfig;
              if (advConfig) {
                rulesHTML += `
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">æŠ•æ³¨èŒƒå›´</p>
                    <p class="text-white font-bold">$${advConfig.bet_min / 500000} - $${advConfig.bet_max / 500000}</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">ä¼šè¯æ—¶é•¿</p>
                    <p class="text-white font-bold">2å°æ—¶</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">å¥–åŠ±å€æ•°</p>
                    <p class="text-white font-bold">${advConfig.reward_multiplier}å€</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">é¢åº¦è¦æ±‚</p>
                    <p class="text-white font-bold">æ— è¦æ±‚</p>
                  </div>
                `;
              }
            } else {
              const normalConfig = data.data.normalConfig;
              if (normalConfig) {
                rulesHTML += `
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">æŠ•æ³¨é‡‘é¢</p>
                    <p class="text-white font-bold">$${normalConfig.bet_amount / 500000}</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">æ¯æ—¥æ¬¡æ•°</p>
                    <p class="text-white font-bold">${normalConfig.max_spins}æ¬¡</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">æœ€ä½é¢åº¦</p>
                    <p class="text-white font-bold">$${normalConfig.min_quota_required / 500000}</p>
                  </div>
                  <div class="bg-black/30 p-3 rounded-lg">
                    <p class="${themeColors.sectionTitle}">è´­ä¹°åŠŸèƒ½</p>
                    <p class="text-white font-bold">${normalConfig.buy_spins_enabled ? 'âœ… å¼€å¯' : 'âŒ å…³é—­'}</p>
                  </div>
                `;
              }
            }
            rulesHTML += '</div></div>';
            
            // ä¸­å¥–è§„åˆ™
            if (rules.length > 0) {
              rulesHTML += '<div class="bg-green-900/30 rounded-xl p-4 mb-4 border border-green-500/30">';
              rulesHTML += '<h4 class="font-bold text-green-300 mb-3 text-lg">ğŸ ä¸­å¥–è§„åˆ™</h4>';
              rulesHTML += '<div class="space-y-2">';
              rules.forEach((rule, index) => {
                rulesHTML += `
                  <div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/40 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                      <div class="flex items-center gap-2">
                        <span class="text-amber-300 font-bold">${index + 1}.</span>
                        <span class="text-white font-bold">${rule.rule_name}</span>
                      </div>
                      <div class="text-right">
                        <div class="text-green-300 font-bold text-xl">${rule.win_multiplier}x</div>
                        ${rule.probability ? `<div class="text-xs text-purple-300 mt-1">ğŸ“Š ${rule.probability}</div>` : ''}
                      </div>
                    </div>
                    ${rule.description ? `<p class="text-sm text-green-200/70 mt-1 ml-6">${rule.description}</p>` : ''}
                    ${rule.grant_free_spin > 0 ? `<p class="text-xs text-amber-300 mt-1 ml-6">ğŸ èµ é€${rule.grant_free_spin}æ¬¡å…è´¹</p>` : ''}
                  </div>
                `;
              });
              rulesHTML += '</div></div>';
            } else {
              rulesHTML += `<div class="bg-yellow-900/30 rounded-xl p-6 mb-4 border border-yellow-500/30 text-center">
                <p class="text-yellow-300 font-bold">âš ï¸ å½“å‰åœºæ¬¡æ²¡æœ‰é…ç½®ä¸­å¥–è§„åˆ™</p>
              </div>`;
            }
            
            // æ˜¾ç¤ºå¾‹å¸ˆå‡½æƒ©ç½š
            if (punishments.length > 0) {
              rulesHTML += '<div class="bg-red-900/30 rounded-xl p-4 mb-4 border border-red-500/30">';
              rulesHTML += '<h4 class="font-bold text-red-300 mb-3 text-lg">âš–ï¸ å¾‹å¸ˆå‡½æƒ©ç½š</h4>';
              rulesHTML += '<div class="space-y-2">';
              punishments.forEach(p => {
                rulesHTML += `
                  <div class="bg-red-500/20 border border-red-400/40 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                      <div>
                        <span class="text-red-200 font-semibold">${p.lsh_count}ä¸ªå¾‹å¸ˆå‡½</span>
                        ${p.probability ? `<div class="text-xs text-purple-300 mt-1">ğŸ“Š ${p.probability}</div>` : ''}
                      </div>
                      <span class="text-red-300 font-bold">æ‰£é™¤${p.deduct_multiplier}å€</span>
                    </div>
                    <div class="text-xs text-red-200/70 mt-1">
                      ${p.ban_hours > 0 ? `ğŸ”’ å°ç¦${p.ban_hours}å°æ—¶` : 'ä¸å°ç¦'}
                      <span class="mx-2">Â·</span>
                      æ¦‚ç‡: ${p.probability}
                    </div>
                  </div>
                `;
              });
              rulesHTML += '</div></div>';
            }
            
            // ç¬¦å·æƒé‡
            if (weightConfig) {
              const weightBg = mode === 'advanced' ? 'bg-amber-900/30' : 'bg-blue-900/30';
              const weightBorder = mode === 'advanced' ? 'border-amber-500/30' : 'border-blue-500/30';
              const weightTitle = mode === 'advanced' ? 'text-amber-300' : 'text-blue-300';
              
              rulesHTML += `<div class="${weightBg} rounded-xl p-4 mb-4 border ${weightBorder}">`;
              rulesHTML += `<h4 class="font-bold ${weightTitle} mb-3 text-lg">âš–ï¸ ç¬¦å·æƒé‡é…ç½®</h4>`;
              rulesHTML += '<div class="grid grid-cols-3 gap-2 text-xs">';
              
              const symbols = [
                { key: 'm', name: 'ç¾', weight: weightConfig.weight_m },
                { key: 't', name: 'å¤ª', weight: weightConfig.weight_t },
                { key: 'n', name: 'ä½ ', weight: weightConfig.weight_n },
                { key: 'j', name: 'é¸¡', weight: weightConfig.weight_j },
                { key: 'lq', name: 'ç¯®çƒ', weight: weightConfig.weight_lq },
                { key: 'bj', name: 'èƒŒæ™¯', weight: weightConfig.weight_bj },
                { key: 'zft', name: 'ä¸­åˆ†å¤´', weight: weightConfig.weight_zft },
                { key: 'bdk', name: 'èƒŒå¸¦è£¤', weight: weightConfig.weight_bdk },
                { key: 'lsh', name: 'å¾‹å¸ˆå‡½', weight: weightConfig.weight_lsh },
                { key: 'man', name: 'ç”·äºº', weight: weightConfig.weight_man }
              ];
              
              const symbolNormalBg = mode === 'advanced' ? 'bg-amber-500/20 border-amber-400/50' : 'bg-blue-500/20 border-blue-400/50';
              const symbolNormalText = mode === 'advanced' ? 'text-amber-200' : 'text-blue-200';
              const symbolNormalTextLight = mode === 'advanced' ? 'text-amber-200/70' : 'text-blue-200/70';
              
              symbols.forEach(s => {
                const prob = ((s.weight / totalWeight) * 100).toFixed(2);
                const isLsh = s.key === 'lsh';
                rulesHTML += `
                  <div class="${isLsh ? 'bg-red-500/20 border-red-400/50' : symbolNormalBg} border rounded-lg p-2">
                    <div class="${isLsh ? 'text-red-300' : symbolNormalText} font-medium">${s.name}</div>
                    <div class="text-white font-bold">${s.weight}</div>
                    <div class="${isLsh ? 'text-red-200/70' : symbolNormalTextLight}">${prob}%</div>
                  </div>
                `;
              });
              
              rulesHTML += '</div>';
              rulesHTML += `<p class="text-xs ${symbolNormalTextLight} mt-3 text-center">æ€»æƒé‡: ${totalWeight}</p>`;
              rulesHTML += '</div>';
            }

            // ğŸ’ æ˜¾ç¤ºRTPå’Œæœªä¸­å¥–æ¦‚ç‡
            if (data.data.rtp || data.data.noWinProbability) {
              const statBg = mode === 'advanced' ? 'bg-amber-900/30' : 'bg-blue-900/30';
              const statBorder = mode === 'advanced' ? 'border-amber-500/30' : 'border-blue-500/30';
              const statTitle = mode === 'advanced' ? 'text-amber-300' : 'text-blue-300';
              const statCardBg = mode === 'advanced' ? 'bg-amber-500/20 border-amber-400/50' : 'bg-blue-500/20 border-blue-400/50';
              const statTextColor = mode === 'advanced' ? 'text-amber-200' : 'text-blue-200';
              const statValueColor = mode === 'advanced' ? 'text-amber-300' : 'text-blue-300';

              rulesHTML += `<div class="${statBg} rounded-xl p-4 mb-4 border ${statBorder}">`;
              rulesHTML += `<h4 class="font-bold ${statTitle} mb-3 text-lg">ğŸ“Š æ¦‚ç‡ç»Ÿè®¡</h4>`;
              rulesHTML += '<div class="grid grid-cols-2 gap-3">';

              if (data.data.rtp) {
                rulesHTML += `
                  <div class="${statCardBg} border rounded-lg p-3 text-center">
                    <div class="${statTextColor} text-xs mb-1">ç©å®¶å›æŠ¥ç‡</div>
                    <div class="${statValueColor} font-bold text-2xl">${data.data.rtp}</div>
                    <div class="${statTextColor} text-xs mt-1">RTP</div>
                  </div>
                `;
              }

              if (data.data.noWinProbability) {
                rulesHTML += `
                  <div class="bg-red-500/20 border border-red-400/50 rounded-lg p-3 text-center">
                    <div class="text-red-200 text-xs mb-1">æœªä¸­å¥–æ¦‚ç‡</div>
                    <div class="text-red-300 font-bold text-2xl">${data.data.noWinProbability}</div>
                    <div class="text-red-200/70 text-xs mt-1">ä¸ä¸­å¥–</div>
                  </div>
                `;
              }

              rulesHTML += '</div></div>';
            }

            // æç¤ºä¿¡æ¯
            const tipBg = mode === 'advanced' ? 'bg-amber-500/20 border-amber-400/50' : 'bg-blue-500/20 border-blue-400/50';
            rulesHTML += `
              <div class="${tipBg} border-2 rounded-xl p-4">
                <p class="font-bold ${themeColors.headerTitle} mb-2">ğŸ’¡ æ¸©é¦¨æç¤º</p>
                <ul class="text-sm ${themeColors.headerDesc} space-y-1">
                  ${mode === 'advanced' ? 
                    `<li>â€¢ é«˜çº§åœºéœ€è¦æ¶ˆè€—å…¥åœºåˆ¸è¿›å…¥</li>
                     <li>â€¢ æ¯æ¬¡ä¼šè¯æ—¶é•¿2å°æ—¶ï¼Œè¯·åˆç†å®‰æ’</li>
                     <li>â€¢ å¥–åŠ±å’Œæƒ©ç½šéƒ½ä¼šæ”¾å¤§${data.data.advancedConfig?.reward_multiplier || 2}å€</li>` :
                    `<li>â€¢ æ¯å¤©æœ‰é™å®šçš„æ¸¸ç©æ¬¡æ•°</li>
                     <li>â€¢ éœ€è¦æœ€ä½é¢åº¦æ‰èƒ½æ¸¸æˆ</li>
                     <li>â€¢ å¯ä»¥é€šè¿‡è´­ä¹°è·å¾—æ›´å¤šæ¬¡æ•°</li>`
                  }
                  <li>â€¢ ç†æ€§æ¸¸æˆï¼Œé€‚åº¦å¨±ä¹ï¼</li>
                </ul>
              </div>
            `;
            
            rulesContainer.innerHTML = rulesHTML;
          }
        }
      } catch (error) {
        console.error('[æ¸¸æˆè§„åˆ™] åŠ è½½å¤±è´¥:', error);
      }
      
      // ğŸ”¥ é™æ€è§„åˆ™å…ƒç´ å·²åˆ é™¤ï¼Œåªæ˜¾ç¤ºåŠ¨æ€åŠ è½½çš„è§„åˆ™
      document.getElementById('slotRulesModal').classList.remove('hidden');
    }

    // å…³é—­æ¸¸æˆè§„åˆ™
    function closeSlotRules() {
      document.getElementById('slotRulesModal').classList.add('hidden');
    }
    
    // ğŸ’ æ˜¾ç¤ºè‡³å°Šåœºæ¸¸æˆè§„åˆ™
    async function showSupremeRules() {
      try {
        const res = await fetch('/api/supreme/rules');
        const data = await res.json();
        
        if (data.success) {
          const { mode, in_supreme_mode, rules, punishments, weightConfig, totalWeight, config, noWinProbability, rtp } = data.data;
          
          const rulesContainer = document.getElementById('supremeRulesDisplay');
          if (!rulesContainer) return;
          
          // è‡³å°Šåœºï¼šçº¢è‰²ä¸»é¢˜
          let html = `
            <div class="bg-gradient-to-r from-red-500/20 to-rose-500/20 backdrop-blur-md rounded-xl p-5 border-2 border-red-400/50 mb-6">
              <div class="flex items-center justify-center gap-3 mb-3">
                <span class="text-3xl">ğŸ’</span>
                <h3 class="text-2xl font-bold text-red-300">è‡³å°Šåœº</h3>
                <span class="text-3xl">ğŸ’</span>
              </div>
              <p class="text-center text-red-200 text-sm">è¶…é«˜å€ç‡ Â· é¡¶çº§å¥–åŠ± Â· è‡³å°Šä½“éªŒ</p>
            </div>
            
            <div class="bg-red-900/50 rounded-xl p-4 mb-4 border border-red-500/30">
              <h4 class="font-bold text-red-300 mb-3 text-lg">âš™ï¸ åŸºç¡€é…ç½®</h4>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-black/30 p-3 rounded-lg">
                  <p class="text-red-300">æŠ•æ³¨èŒƒå›´</p>
                  <p class="text-white font-bold">$${config.min_bet} - $${config.max_bet}</p>
                </div>
                <div class="bg-black/30 p-3 rounded-lg">
                  <p class="text-red-300">æ¯æ—¥è¿›å…¥</p>
                  <p class="text-white font-bold">${config.daily_entry_limit}æ¬¡</p>
                </div>
                <div class="bg-black/30 p-3 rounded-lg col-span-2">
                  <p class="text-red-300">ä¼šè¯æ—¶é•¿</p>
                  <p class="text-white font-bold">${config.session_valid_hours}å°æ—¶</p>
                </div>
              </div>
            </div>
          `;
          
          // æ˜¾ç¤ºä¸­å¥–è§„åˆ™
          if (rules.length > 0) {
            html += '<div class="bg-green-900/30 rounded-xl p-4 mb-4 border border-green-500/30">';
            html += '<h4 class="font-bold text-green-300 mb-3 text-lg">ğŸ ä¸­å¥–è§„åˆ™</h4>';
            html += '<div class="space-y-2">';
            
            rules.forEach((rule, index) => {
              html += `
                <div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/40 rounded-lg p-3">
                  <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                      <span class="text-amber-300 font-bold">${index + 1}.</span>
                      <span class="text-white font-bold">${rule.rule_name}</span>
                    </div>
                    <div class="text-right">
                      <div class="text-green-300 font-bold text-xl">${rule.win_multiplier}x</div>
                      ${rule.probability ? `<div class="text-xs text-purple-300 mt-1">ğŸ“Š ${rule.probability}</div>` : ''}
                    </div>
                  </div>
                  ${rule.description ? `<p class="text-sm text-green-200/70 mt-1 ml-6">${rule.description}</p>` : ''}
                  ${rule.grant_free_spin > 0 ? `<p class="text-xs text-amber-300 mt-1 ml-6">ğŸ èµ é€${rule.grant_free_spin}æ¬¡å…è´¹</p>` : ''}
                </div>
              `;
            });
            
            html += '</div></div>';
          } else {
            html += `
              <div class="bg-yellow-900/30 rounded-xl p-6 mb-4 border border-yellow-500/30 text-center">
                <p class="text-yellow-300 font-bold">âš ï¸ å½“å‰è‡³å°Šåœºæ²¡æœ‰é…ç½®ä¸­å¥–è§„åˆ™</p>
                <p class="text-yellow-200/70 text-sm mt-2">è¯·è”ç³»ç®¡ç†å‘˜é…ç½®</p>
              </div>
            `;
          }
          
          // æ˜¾ç¤ºå¾‹å¸ˆå‡½æƒ©ç½š
          if (punishments.length > 0) {
            html += '<div class="bg-red-900/30 rounded-xl p-4 mb-4 border border-red-500/30">';
            html += '<h4 class="font-bold text-red-300 mb-3 text-lg">âš–ï¸ å¾‹å¸ˆå‡½æƒ©ç½š</h4>';
            html += '<div class="space-y-2">';
            
            punishments.forEach(p => {
              html += `
                <div class="bg-red-500/20 border border-red-400/40 rounded-lg p-3">
                  <div class="flex justify-between items-center">
                    <span class="text-red-200 font-semibold">${p.lsh_count}ä¸ªå¾‹å¸ˆå‡½</span>
                    <span class="text-red-300 font-bold">æ‰£é™¤${p.deduct_multiplier}å€</span>
                  </div>
                  <div class="text-xs text-red-200/70 mt-1">
                    ${p.ban_hours > 0 ? `ğŸ”’ å°ç¦${p.ban_hours}å°æ—¶` : 'ä¸å°ç¦'}
                    <span class="mx-2">Â·</span>
                    æ¦‚ç‡: ${p.probability}
                  </div>
                </div>
              `;
            });
            
            html += '</div></div>';
          }
          
          // ğŸ’ æ˜¾ç¤ºRTPå’Œæœªä¸­å¥–æ¦‚ç‡
          if (rtp || noWinProbability) {
            html += '<div class="bg-purple-900/30 rounded-xl p-4 mb-4 border border-purple-500/30">';
            html += '<h4 class="font-bold text-purple-300 mb-3 text-lg">ğŸ“Š æ¦‚ç‡ç»Ÿè®¡</h4>';
            html += '<div class="grid grid-cols-2 gap-3">';
            
            if (rtp) {
              html += `
                <div class="bg-purple-500/20 border border-purple-400/50 rounded-lg p-3 text-center">
                  <div class="text-purple-200 text-xs mb-1">ç©å®¶å›æŠ¥ç‡</div>
                  <div class="text-purple-300 font-bold text-2xl">${rtp}</div>
                  <div class="text-purple-200/70 text-xs mt-1">RTP</div>
                </div>
              `;
            }
            
            if (noWinProbability) {
              html += `
                <div class="bg-red-500/20 border border-red-400/50 rounded-lg p-3 text-center">
                  <div class="text-red-200 text-xs mb-1">æœªä¸­å¥–æ¦‚ç‡</div>
                  <div class="text-red-300 font-bold text-2xl">${noWinProbability}</div>
                  <div class="text-red-200/70 text-xs mt-1">Miss Rate</div>
                </div>
              `;
            }
            
            html += '</div></div>';
          }
          
          // æ˜¾ç¤ºç¬¦å·æƒé‡
          if (weightConfig) {
            html += '<div class="bg-red-900/30 rounded-xl p-4 border border-red-500/30">';
            html += '<h4 class="font-bold text-red-300 mb-3 text-lg">âš–ï¸ ç¬¦å·æƒé‡é…ç½®</h4>';
            html += '<div class="grid grid-cols-3 gap-2 text-xs">';
            
            const symbols = [
              { key: 'm', name: 'ç¾', weight: weightConfig.weight_m },
              { key: 't', name: 'å¤', weight: weightConfig.weight_t },
              { key: 'n', name: 'ä½ ', weight: weightConfig.weight_n },
              { key: 'j', name: 'å¤ª', weight: weightConfig.weight_j },
              { key: 'lq', name: 'é²¤é±¼', weight: weightConfig.weight_lq },
              { key: 'bj', name: 'èƒŒæ™¯', weight: weightConfig.weight_bj },
              { key: 'zft', name: 'çœŸç²‰å¤´', weight: weightConfig.weight_zft },
              { key: 'bdk', name: 'ä¸æ‰“å·¥', weight: weightConfig.weight_bdk },
              { key: 'lsh', name: 'å¾‹å¸ˆå‡½', weight: weightConfig.weight_lsh },
              { key: 'man', name: 'ç”·äºº', weight: weightConfig.weight_man }
            ];
            
            symbols.forEach(s => {
              const prob = ((s.weight / totalWeight) * 100).toFixed(2);
              const isLsh = s.key === 'lsh';
              html += `
                <div class="${isLsh ? 'bg-rose-500/20 border-rose-400/50' : 'bg-red-500/20 border-red-400/50'} border rounded-lg p-2">
                  <div class="${isLsh ? 'text-rose-300' : 'text-red-200'} font-medium">${s.name}</div>
                  <div class="text-white font-bold">${s.weight}</div>
                  <div class="${isLsh ? 'text-rose-200/70' : 'text-red-200/70'}">${prob}%</div>
                </div>
              `;
            });
            
            html += '</div>';
            html += `<p class="text-xs text-red-200/70 mt-3 text-center">æ€»æƒé‡: ${totalWeight}</p>`;
            html += '</div>';
          }
          
          // æç¤ºä¿¡æ¯
          html += `
            <div class="bg-red-500/20 border-2 border-red-400/50 rounded-xl p-4">
              <p class="font-bold text-red-300 mb-2">ğŸ’¡ æ¸©é¦¨æç¤º</p>
              <ul class="text-sm text-red-200 space-y-1">
                <li>â€¢ è‡³å°Šåœºéœ€è¦æ¶ˆè€—è‡³å°Šä»¤ç‰Œè¿›å…¥</li>
                <li>â€¢ æ¯æ¬¡ä¼šè¯æ—¶é•¿æœ‰é™ï¼Œè¯·åˆç†å®‰æ’</li>
                <li>â€¢ æŠ•æ³¨é‡‘é¢å¯è‡ªå®šä¹‰é€‰æ‹©</li>
                <li>â€¢ ç†æ€§æ¸¸æˆï¼Œé€‚åº¦å¨±ä¹ï¼</li>
              </ul>
            </div>
          `;
          
          rulesContainer.innerHTML = html;
        }
      } catch (error) {
        console.error('[è‡³å°Šåœºè§„åˆ™] åŠ è½½å¤±è´¥:', error);
        showToast('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
      }
      
      document.getElementById('supremeRulesModal').classList.remove('hidden');
    }
    
    // ğŸ’ å…³é—­è‡³å°Šåœºè§„åˆ™
    function closeSupremeRules() {
      document.getElementById('supremeRulesModal').classList.add('hidden');
    }
    
    // æ˜¾ç¤ºæ’è¡Œæ¦œ
    // å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´ï¼ˆä»localStorageè¯»å–ï¼Œé»˜è®¤æ—¥æ¦œï¼‰
    let currentLeaderboardRange = localStorage.getItem('leaderboardRange') || 'daily';

    async function showLeaderboard(range) {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥rangeï¼Œä½¿ç”¨å½“å‰ä¿å­˜çš„é€‰æ‹©
      if (!range) {
        range = currentLeaderboardRange;
      }
      currentLeaderboardRange = range;
      
      // æ›´æ–°ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼
      const select = document.getElementById('leaderboardRangeSelect');
      if (select) {
        select.value = range;
      }
      
      try {
        const res = await fetch(`/api/slot/leaderboard?limit=100&type=${range}`);
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          return;
        }

        const { leaderboard, lossLeaderboard, userStats, userRank, userLossRank } = data.data;

        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        document.getElementById('myRank').textContent = userRank > 0 ? `#${userRank}` : '-';
        document.getElementById('myTotalSpins').textContent = userStats.total_spins || 0;
        document.getElementById('myTotalBet').textContent = `$${((userStats.total_bet || 0) / 500000).toFixed(2)}`;
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºç”¨æˆ·ç›ˆäº
        const myProfit = (userStats.total_win || 0) - (userStats.total_bet || 0);
        const myProfitText = `${myProfit >= 0 ? '+' : ''}$${(myProfit / 500000).toFixed(2)}`;
        const myProfitElement = document.getElementById('myTotalProfit');
        myProfitElement.textContent = myProfitText;
        myProfitElement.className = `text-2xl font-bold ${myProfit >= 0 ? 'text-green-600' : 'text-red-600'}`;
        
        document.getElementById('myBiggestWin').textContent = `$${((userStats.biggest_win || 0) / 500000).toFixed(2)}`;
        
        const winTypeLabels = {
          'super_jackpot': '(ğŸ† è¶…çº§å¤§å¥–)',
          'special_combo': '(ğŸ’ ç‰¹æ®Šç»„åˆ)',
          'quad': '(ğŸ° å››è¿)',
          'triple': '(âœ¨ ä¸‰è¿)',
          'double': '(ğŸ åŒè¿)',
          'man_only': '(ğŸ¯ Manç»„åˆ)',
          'man_quad': '(ğŸ° ManÃ—4)',
          'symmetric': '(ğŸ”„ å¯¹ç§°ABBA)',
          'consecutive': '(â­ è¿ç»­)',
          'combination': '(ğŸ ç»„åˆ)',
          'any': '(ğŸ² ä»»æ„)',
          'double_pair': '(ğŸ­ ä¸¤å¯¹)',
          'punishment': '(âš¡ æƒ©ç½š)',
          'none': ''
        };
        document.getElementById('myBiggestWinType').textContent = winTypeLabels[userStats.biggest_win_type] || '';

        // æ¸²æŸ“ç›ˆåˆ©æ’è¡Œæ¦œ
        const container = document.getElementById('leaderboardContent');
        
        if (leaderboard.length === 0) {
          container.innerHTML = '<p class="text-center text-slate-500 py-8">æš‚æ— æ’è¡Œæ•°æ®</p>';
        } else {
          container.innerHTML = `
            <div class="mb-4">
              <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <span>ğŸ†</span>
                <span>ç›ˆåˆ©æ’è¡Œæ¦œ TOP 20</span>
                <span class="text-sm font-normal text-slate-500">ï¼ˆèµšæœ€å¤šï¼‰</span>
              </h3>
              <div class="space-y-3">
                ${leaderboard.map((user, index) => {
                const rank = index + 1;
                let rankBadge = '';
                let bgClass = 'bg-white hover:bg-slate-50';
                
                if (rank === 1) {
                  rankBadge = '<span class="text-4xl">ğŸ¥‡</span>';
                  bgClass = 'bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-400';
                } else if (rank === 2) {
                  rankBadge = '<span class="text-4xl">ğŸ¥ˆ</span>';
                  bgClass = 'bg-gradient-to-r from-gray-50 to-slate-100 border-2 border-gray-400';
                } else if (rank === 3) {
                  rankBadge = '<span class="text-4xl">ğŸ¥‰</span>';
                  bgClass = 'bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-400';
                } else {
                  rankBadge = `<span class="text-2xl font-bold text-slate-600">#${rank}</span>`;
                }

                const winTypeLabel = winTypeLabels[user.biggest_win_type] || '';
                
                // è®¡ç®—ç›ˆäº
                const profit = (user.total_win || 0) - (user.total_bet || 0);
                const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';

                return `
                  <div class="p-4 rounded-lg border border-slate-200 ${bgClass} transition-all">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-4">
                        <div class="w-16 text-center">${rankBadge}</div>
                        <div>
                          <p class="font-bold text-lg text-slate-900">${user.username || user.linux_do_id}</p>
                          <p class="text-sm text-slate-600">æ¸¸ç© ${user.total_spins} æ¬¡</p>
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="text-xs text-slate-500">æ€»ç›ˆäº</p>
                        <p class="text-2xl font-bold ${profitColor}">${profitText}</p>
                        <p class="text-xs text-slate-500 mt-1">æœ€å¤§å¥–é‡‘: $${(user.biggest_win / 500000).toFixed(2)} ${winTypeLabel}</p>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
              </div>
            </div>
          `;
        }
        
        // æ¸²æŸ“äºæŸæ’è¡Œæ¦œ
        const lossContainer = document.getElementById('lossLeaderboardContent');
        
        if (!lossLeaderboard || lossLeaderboard.length === 0) {
          lossContainer.innerHTML = '';
        } else {
          lossContainer.innerHTML = `
            <div class="mt-8 pt-6 border-t-2 border-red-200">
              <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center gap-2">
                <span>ğŸ“‰</span>
                <span>äºæŸæ’è¡Œæ¦œ TOP 20</span>
                <span class="text-sm font-normal text-slate-500">ï¼ˆäºæœ€å¤šï¼‰</span>
              </h3>
              <div class="space-y-3">
                ${lossLeaderboard.length === 0 ? 
                  '<p class="text-center text-green-600 py-8 font-semibold">ğŸ‰ æš‚æ— äºæŸç”¨æˆ·ï¼Œæ‰€æœ‰ç©å®¶éƒ½åœ¨ç›ˆåˆ©ï¼</p>' :
                  lossLeaderboard.slice(0, 20).map((user, index) => {
                  const rank = index + 1;
                  let rankBadge = '';
                  let bgClass = 'bg-red-50 hover:bg-red-100 border-red-200';
                  
                  if (rank === 1) {
                    rankBadge = '<span class="text-4xl">ğŸ˜±</span>';
                    bgClass = 'bg-gradient-to-r from-red-100 to-rose-100 border-2 border-red-500';
                  } else if (rank === 2) {
                    rankBadge = '<span class="text-4xl">ğŸ˜­</span>';
                    bgClass = 'bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-400';
                  } else if (rank === 3) {
                    rankBadge = '<span class="text-4xl">ğŸ˜¢</span>';
                    bgClass = 'bg-gradient-to-r from-orange-50 to-red-50 border-2 border-red-300';
                  } else {
                    rankBadge = `<span class="text-2xl font-bold text-red-600">#${rank}</span>`;
                  }

                  const winTypeLabel = winTypeLabels[user.biggest_win_type] || '';
                  
                  // è®¡ç®—ç›ˆäº
                  const profit = (user.total_win || 0) - (user.total_bet || 0);
                  const profitText = `${profit >= 0 ? '+' : ''}$${(profit / 500000).toFixed(2)}`;
                  const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-700';

                  return `
                    <div class="p-4 rounded-lg border ${bgClass} transition-all">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <div class="w-16 text-center">${rankBadge}</div>
                          <div>
                            <p class="font-bold text-lg text-slate-900">${user.username || user.linux_do_id}</p>
                            <p class="text-sm text-slate-600">æ¸¸ç© ${user.total_spins} æ¬¡</p>
                          </div>
                        </div>
                        <div class="text-right">
                          <p class="text-xs text-slate-500">æ€»ç›ˆäº</p>
                          <p class="text-2xl font-bold ${profitColor}">${profitText}</p>
                          <p class="text-xs text-slate-500 mt-1">æŠ•æ³¨: $${(user.total_bet / 500000).toFixed(2)}</p>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
        if (lossLeaderboard.length === 0) {
          lossContainer.innerHTML = `
            <div class="mt-8 pt-6 border-t-2 border-green-200">
              <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <span>ğŸ‰</span>
                <span>å¤ªæ£’äº†ï¼æ‰€æœ‰ç©å®¶éƒ½åœ¨ç›ˆåˆ©</span>
              </h3>
              <p class="text-center text-slate-500 py-8 bg-green-50 rounded-lg border border-green-200">
                æš‚æ—¶æ²¡æœ‰äºæŸçš„ç”¨æˆ·<br>
                <span class="text-sm">å¤§å®¶éƒ½ç©å¾—å¾ˆå¥½ï¼</span>
              </p>
            </div>
          `;
        }

        document.getElementById('leaderboardModal').classList.remove('hidden');
        // é»˜è®¤æ˜¾ç¤ºç›ˆåˆ©æ¦œ
        switchLeaderboardTab('profit');
      } catch (error) {
        console.error('è·å–æ’è¡Œæ¦œå¤±è´¥:', error);
        showToast('è·å–æ’è¡Œæ¦œå¤±è´¥', 'error');
      }
    }

    // å…³é—­æ’è¡Œæ¦œ
    function closeLeaderboard() {
      document.getElementById('leaderboardModal').classList.add('hidden');
    }

    // åˆ‡æ¢æ’è¡Œæ¦œæ—¶é—´èŒƒå›´
    function switchLeaderboardRange(range) {
      // ä¿å­˜ç”¨æˆ·é€‰æ‹©åˆ°localStorage
      localStorage.setItem('leaderboardRange', range);
      
      // æ›´æ–°å½“å‰èŒƒå›´
      currentLeaderboardRange = range;
      
      // é‡æ–°åŠ è½½æ’è¡Œæ¦œæ•°æ®
      showLeaderboard(range);
      
      console.log(`ğŸ“Š æ’è¡Œæ¦œç±»å‹å·²åˆ‡æ¢: ${range === 'daily' ? 'æ—¥æ¦œ' : range === 'weekly' ? 'å‘¨æ¦œ' : 'æ€»æ¦œ'}`);
    }

    // åˆ‡æ¢æ’è¡Œæ¦œæ ‡ç­¾é¡µ
    function switchLeaderboardTab(tab) {
      const profitTab = document.getElementById('profitTabBtn');
      const lossTab = document.getElementById('lossTabBtn');
      const profitContent = document.getElementById('leaderboardContent');
      const lossContent = document.getElementById('lossLeaderboardContent');

      if (tab === 'profit') {
        // æ¿€æ´»ç›ˆåˆ©æ¦œæ ‡ç­¾
        profitTab.classList.add('border-green-500', 'bg-white', 'text-green-600');
        profitTab.classList.remove('border-transparent', 'text-slate-600');
        lossTab.classList.remove('border-red-500', 'bg-white', 'text-red-600');
        lossTab.classList.add('border-transparent', 'text-slate-600');
        
        // æ˜¾ç¤ºç›ˆåˆ©æ¦œå†…å®¹
        profitContent.classList.remove('hidden');
        lossContent.classList.add('hidden');
      } else if (tab === 'loss') {
        // æ¿€æ´»äºæŸæ¦œæ ‡ç­¾
        lossTab.classList.add('border-red-500', 'bg-white', 'text-red-600');
        lossTab.classList.remove('border-transparent', 'text-slate-600');
        profitTab.classList.remove('border-green-500', 'bg-white', 'text-green-600');
        profitTab.classList.add('border-transparent', 'text-slate-600');
        
        // æ˜¾ç¤ºäºæŸæ¦œå†…å®¹
        lossContent.classList.remove('hidden');
        profitContent.classList.add('hidden');
      }
    }

    // ========== å¾…å‘æ”¾å¥–é‡‘åŠŸèƒ½ ==========

    // æ˜¾ç¤ºå¾…å‘æ”¾å¥–é‡‘å¼¹çª—
    async function showPendingRewardsModal() {
      // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
      const dropdownMenu = document.getElementById('dropdownMenu');
      const slotDropdownMenu = document.getElementById('slotDropdownMenu');
      if (dropdownMenu) dropdownMenu.classList.add('hidden');
      if (slotDropdownMenu) slotDropdownMenu.classList.add('hidden');

      document.getElementById('pendingRewardsModal').classList.remove('hidden');
      await loadPendingRewards();
    }

    // å…³é—­å¾…å‘æ”¾å¥–é‡‘å¼¹çª—
    function closePendingRewards() {
      document.getElementById('pendingRewardsModal').classList.add('hidden');
    }

    // åŠ è½½å¾…å‘æ”¾å¥–é‡‘è®°å½•
    async function loadPendingRewards() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();

        if (!data.success) {
          showToast(data.message, 'error');
          return;
        }

        const { summary, rewards } = data.data;
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¨¡æ€æ¡†å†…ï¼‰
        document.getElementById('modalPendingCount').textContent = summary.pending_count;
        document.getElementById('modalPendingAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;
        document.getElementById('modalSuccessAmount').textContent = `$${(summary.success_amount / 500000).toFixed(2)}`;
        
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ä½™é¢ï¼‰
        const userRes = await fetch('/api/user/quota');
        const userData = await userRes.json();
        if (userData.success && userData.data) {
          const currentQuota = userData.data.quota || 0;
          document.getElementById('modalCurrentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
          
          // åŒæ—¶æ›´æ–°åº•éƒ¨çš„å½“å‰ä½™é¢æ˜¾ç¤º
          document.getElementById('currentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
        }
        
        // æ›´æ–°åº•éƒ¨ç»Ÿè®¡æ çš„å¾…å‘æ”¾ä¿¡æ¯
        document.getElementById('pendingRewardsCount').textContent = summary.pending_count;
        document.getElementById('pendingRewardsAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;

        // æ¸²æŸ“è®°å½•åˆ—è¡¨
        const container = document.getElementById('pendingRewardsList');
        
        if (rewards.length === 0) {
          container.innerHTML = '<div class="text-center text-slate-500 py-8"><p class="text-xl">ğŸ‰</p><p class="mt-2">æš‚æ— å¾…å‘æ”¾è®°å½•</p></div>';
          return;
        }

        // çŠ¶æ€æ ‡ç­¾
        const statusLabels = {
          'pending': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">â³ å¾…å¤„ç†</span>',
          'processing': '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">âš™ï¸ å¤„ç†ä¸­</span>',
          'success': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">âœ… æˆåŠŸ</span>',
          'failed': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">âŒ å¤±è´¥</span>'
        };

        container.innerHTML = `
          <div class="space-y-3">
            ${rewards.map(reward => {
              const statusBadge = statusLabels[reward.status] || statusLabels['pending'];
              const amountClass = reward.status === 'success' ? 'text-green-600' : 
                                 reward.status === 'failed' ? 'text-red-600' : 'text-orange-600';
              
              // ç”³è¯·è¡¥å‘æŒ‰é’®ï¼ˆä»…å¤±è´¥å’Œå¾…å¤„ç†çŠ¶æ€æ˜¾ç¤ºï¼‰
              let actionButton = '';
              if (reward.status === 'failed' || reward.status === 'pending') {
                actionButton = `
                  <button 
                    id="retryBtn_${reward.id}"
                    onclick="retryUserPendingReward(${reward.id}, ${reward.amount.toFixed(2)})" 
                    class="mt-3 w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">
                    ğŸ”„ ç”³è¯·è¡¥å‘
                  </button>
                `;
              } else if (reward.status === 'processing') {
                actionButton = `
                  <div class="mt-3 w-full px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-center text-sm font-semibold">
                    âš™ï¸ ç”³è¯·ä¸­...
                  </div>
                `;
              } else if (reward.status === 'success') {
                actionButton = `
                  <div class="mt-3 w-full px-4 py-2 bg-green-100 text-green-700 rounded-lg text-center text-sm font-semibold">
                    âœ… å·²å‘æ”¾åˆ°è´¦
                  </div>
                `;
              }
              
              return `
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:border-slate-300 transition-colors">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                        <span class="font-semibold text-${amountClass} text-lg">$${reward.amount.toFixed(2)}</span>
                        ${statusBadge}
                      </div>
                      <p class="text-sm text-slate-700 mb-1">
                        <span class="font-medium">åŸå› ï¼š</span>${reward.reason}
                      </p>
                      <p class="text-xs text-slate-500">
                        åˆ›å»ºæ—¶é—´ï¼š${reward.created_date}
                        ${reward.retry_count > 0 ? `<span class="ml-2 text-orange-600">â€¢ å·²é‡è¯• ${reward.retry_count} æ¬¡</span>` : ''}
                      </p>
                      ${reward.error_message ? `
                        <p class="text-xs text-red-600 mt-1 p-2 bg-red-50 rounded border border-red-200">
                          âš ï¸ ${reward.error_message}
                        </p>
                      ` : ''}
                      ${actionButton}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;

      } catch (error) {
        console.error('åŠ è½½å¾…å‘æ”¾è®°å½•å¤±è´¥:', error);
        showToast('åŠ è½½å¾…å‘æ”¾è®°å½•å¤±è´¥', 'error');
        document.getElementById('pendingRewardsList').innerHTML = 
          '<div class="text-center text-red-500 py-8"><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
      }
    }

    // åˆ·æ–°å¾…å‘æ”¾è®°å½•
    async function refreshPendingRewards() {
      await loadPendingRewards();
      showToast('å·²åˆ·æ–°', 'success');
    }

    // ç”¨æˆ·ç”³è¯·è¡¥å‘å¾…å‘æ”¾å¥–é‡‘
    async function retryUserPendingReward(rewardId, amount) {
      if (!confirm(`ç¡®è®¤ç”³è¯·è¡¥å‘ $${amount} çš„å¥–é‡‘å—ï¼Ÿ\n\nç³»ç»Ÿå°†ç«‹å³å°è¯•ä¸ºæ‚¨å‘æ”¾åˆ°è´¦ã€‚`)) {
        return;
      }

      const btn = document.getElementById(`retryBtn_${rewardId}`);
      if (!btn) return;

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">âš™ï¸</span> ç”³è¯·ä¸­...';

      try {
        const res = await fetch(`/api/slot/pending-rewards/${rewardId}/retry`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        
        if (data.success) {
          // æˆåŠŸ
          showToast(`âœ… ${data.message}`, 'success');
          
          // ç­‰å¾…1ç§’ååˆ·æ–°åˆ—è¡¨å’Œé¢åº¦
          setTimeout(async () => {
            await Promise.all([
              loadPendingRewards(),
              loadQuota()  // åˆ·æ–°å½“å‰ä½™é¢
            ]);
          }, 1000);
        } else {
          // å¤±è´¥ - æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
          let errorMsg = data.message;
          
          // å¦‚æœæ˜¯429é”™è¯¯ï¼Œç»™å‡ºæ›´æ˜ç¡®çš„æç¤º
          if (data.httpStatus === 429 || data.details?.includes('429')) {
            errorMsg = 'âš ï¸ APIè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·5åˆ†é’Ÿåå†è¯•';
          } else if (data.details) {
            // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
            console.error('[ç”³è¯·è¡¥å‘å¤±è´¥] è¯¦ç»†ä¿¡æ¯:', data.details);
          }
          
          showToast(`âŒ ${errorMsg}`, 'error');
          
          // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
          setTimeout(() => loadPendingRewards(), 500);
        }
      } catch (error) {
        console.error('ç”³è¯·è¡¥å‘å¤±è´¥:', error);
        showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // åˆå§‹åŒ–æ—¶åŠ è½½å¾…å‘æ”¾ç»Ÿè®¡ï¼ˆä¸æ‰“å¼€å¼¹çª—ï¼‰
    async function loadPendingRewardsSummary() {
      try {
        const res = await fetch('/api/slot/pending-rewards');
        const data = await res.json();

        if (data.success && data.data) {
          const { summary } = data.data;
          document.getElementById('pendingRewardsCount').textContent = summary.pending_count;
          document.getElementById('pendingRewardsAmount').textContent = `$${(summary.pending_amount / 500000).toFixed(2)}`;
        }
        
        // åŒæ—¶è·å–å½“å‰ä½™é¢
        const userRes = await fetch('/api/user/quota');
        const userData = await userRes.json();
        if (userData.success && userData.data) {
          const currentQuota = userData.data.quota || 0;
          document.getElementById('currentBalance').textContent = `$${(currentQuota / 500000).toFixed(2)}`;
        }
      } catch (error) {
        console.error('åŠ è½½å¾…å‘æ”¾ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    // ========== ğŸ’ è‡³å°Šåœºç³»ç»Ÿ ==========
    
    // ğŸ’ åŠ è½½è‡³å°Šä»¤ç‰Œä¿¡æ¯
    async function loadSupremeTokens(skipUIUpdate = false) {
      try {
        const res = await fetch('/api/supreme/tokens');
        const data = await res.json();

        if (data.success) {
          supremeTokensData = data.data;
          debugLog('[loadSupremeTokens] ä»¤ç‰Œæ•°æ®åŠ è½½æˆåŠŸï¼ŒskipUIUpdate:', skipUIUpdate);

          // ğŸ”¥ åŒæ­¥ä»Šæ—¥æŠ•æ³¨é‡‘é¢åˆ° slotUserDataï¼Œç”¨äºè¿›åº¦æ¡æ˜¾ç¤º
          if (slotUserData && data.data.today_bet_amount !== undefined) {
            slotUserData.today_supreme_bet = data.data.today_bet_amount;
            debugLog('[loadSupremeTokens] åŒæ­¥ä»Šæ—¥æŠ•æ³¨é‡‘é¢:', data.data.today_bet_amount / 500000, 'USD');
          }

          // ğŸ”¥ å¯é€‰ï¼šè·³è¿‡UIæ›´æ–°ï¼ˆé¿å…è¦†ç›–æ‰‹åŠ¨è®¾ç½®çš„çŠ¶æ€ï¼‰
          if (!skipUIUpdate) {
            updateSupremeTokensUI();
          }
          return data.data;
        } else {
          console.error('[è‡³å°Šåœº] åŠ è½½ä»¤ç‰Œå¤±è´¥:', data.message);
          return null;
        }
      } catch (error) {
        console.error('[è‡³å°Šåœº] åŠ è½½ä»¤ç‰Œå¤±è´¥:', error);
        return null;
      }
    }
    
    // ğŸ’ æ›´æ–°è‡³å°Šä»¤ç‰ŒUI
    function updateSupremeTokensUI() {
      if (!supremeTokensData) return;
      
      const {
        tokens,
        fragments,
        fragments_needed,
        can_synthesize,
        max_tokens_hold,
        tokens_expires_at,
        supreme_mode_until,
        in_supreme_mode,
        today_entry_count,
        today_tokens_granted,
        config
      } = supremeTokensData;
      
      // æ›´æ–°ä»¤ç‰Œæ æ˜¾ç¤º
      const tokenBar = document.getElementById('supremeTokenBar');
      const tokenCount = document.getElementById('supremeTokenCount');
      const tokenMax = document.getElementById('supremeTokenMax');
      const fragmentCount = document.getElementById('supremeFragmentCount');
      const fragmentsNeeded = document.getElementById('supremeFragmentsNeeded');
      const todayEntry = document.getElementById('supremeTodayEntry');
      const dailyLimit = document.getElementById('supremeDailyLimit');
      
      if (tokenCount) tokenCount.textContent = tokens || 0;
      if (tokenMax) tokenMax.textContent = max_tokens_hold || 3;
      if (fragmentCount) fragmentCount.textContent = fragments || 0;
      if (fragmentsNeeded) fragmentsNeeded.textContent = fragments_needed || 10;
      if (todayEntry) todayEntry.textContent = today_entry_count || 0;
      if (dailyLimit) dailyLimit.textContent = config?.daily_entry_limit || 3;
      
      // ğŸ”¥ åŒæ­¥æ•°æ®åˆ°å¯¼èˆªæ å¡ç‰‡ - å·²ç§»é™¤
      // const supremeTokenCountNav = document.getElementById('supremeTokenCountNav');
      // const supremeFragmentCountNav = document.getElementById('supremeFragmentCountNav');
      // const synthesizeSupremeButtonNav = document.getElementById('synthesizeSupremeButtonNav');
      // const enterSupremeButtonNav = document.getElementById('enterSupremeButtonNav');
      // 
      // if (supremeTokenCountNav) supremeTokenCountNav.textContent = tokens || 0;
      // if (supremeFragmentCountNav) supremeFragmentCountNav.textContent = fragments || 0;
      // 
      // // æ›´æ–°å¯¼èˆªæ æŒ‰é’®çŠ¶æ€
      // if (synthesizeSupremeButtonNav) {
      //   synthesizeSupremeButtonNav.disabled = !can_synthesize || tokens >= max_tokens_hold || todayGranted >= grantLimit;
      // }
      // if (enterSupremeButtonNav) {
      //   if (in_supreme_mode) {
      //     enterSupremeButtonNav.textContent = 'ğŸšª';
      //     enterSupremeButtonNav.title = 'é€€å‡ºè‡³å°Šåœº';
      //     enterSupremeButtonNav.onclick = exitSupremeMode;
      //   } else {
      //     enterSupremeButtonNav.textContent = 'ğŸ’';
      //     enterSupremeButtonNav.title = 'è¿›å…¥è‡³å°Šåœº';
      //     enterSupremeButtonNav.onclick = enterSupremeMode;
      //     enterSupremeButtonNav.disabled = tokens < 1 || (today_entry_count >= config?.daily_entry_limit);
      //   }
      // }
      
      // ğŸ”¥ æ˜¾ç¤º/éšè—ä»¤ç‰Œæ 
      // åœ¨é«˜çº§åœºæ¨¡å¼ä¸‹å§‹ç»ˆæ˜¾ç¤ºï¼ˆè®©ç”¨æˆ·çœ‹åˆ°è‡³å°Šåœºå…¥å£ï¼‰
      // åœ¨åˆçº§åœºæ¨¡å¼ä¸‹ï¼Œåªæœ‰æ‹¥æœ‰ç¢ç‰‡æˆ–ä»¤ç‰Œæ—¶æ‰æ˜¾ç¤º
      if (tokenBar) {
        if (isInAdvancedMode || tokens > 0 || fragments > 0 || in_supreme_mode) {
          tokenBar.classList.remove('hidden');
        } else {
          tokenBar.classList.add('hidden');
        }
      }
      
      // æ›´æ–°åˆæˆæŒ‰é’®çŠ¶æ€
      const synthesizeBtn = document.getElementById('synthesizeSupremeTokenButton');
      const todayGranted = today_tokens_granted || 0;
      const grantLimit = config?.daily_token_grant_limit || 1;
      
      if (synthesizeBtn) {
        if (can_synthesize && tokens < max_tokens_hold && todayGranted < grantLimit) {
          synthesizeBtn.disabled = false;
          synthesizeBtn.title = 'ç‚¹å‡»åˆæˆè‡³å°Šä»¤ç‰Œ';
        } else {
          synthesizeBtn.disabled = true;
          if (!can_synthesize) {
            synthesizeBtn.title = `ç¢ç‰‡ä¸è¶³ï¼ˆéœ€è¦${fragments_needed}ä¸ªï¼‰`;
          } else if (tokens >= max_tokens_hold) {
            synthesizeBtn.title = `å·²è¾¾æŒæœ‰ä¸Šé™ï¼ˆ${max_tokens_hold}ä¸ªï¼‰`;
          } else if (todayGranted >= grantLimit) {
            synthesizeBtn.title = `ä»Šæ—¥è·å¾—å·²è¾¾ä¸Šé™ï¼ˆ${grantLimit}ä¸ªï¼‰`;
          }
        }
      }
      
      // æ›´æ–°è¿›å…¥è‡³å°ŠåœºæŒ‰é’®çŠ¶æ€
      const enterBtn = document.getElementById('enterSupremeButton');
      if (enterBtn) {
        if (in_supreme_mode) {
          enterBtn.textContent = 'ğŸ’ é€€å‡ºè‡³å°Šåœº';
          enterBtn.onclick = exitSupremeMode;
          enterBtn.disabled = false;
          enterBtn.classList.remove('animate-pulse');
        } else {
          enterBtn.textContent = 'ğŸ’ è¿›å…¥è‡³å°Šåœº';
          enterBtn.onclick = enterSupremeMode;
          enterBtn.disabled = tokens < 1 || (today_entry_count >= config?.daily_entry_limit);
          if (tokens >= 1 && today_entry_count < config?.daily_entry_limit) {
            enterBtn.classList.add('animate-pulse');
          } else {
            enterBtn.classList.remove('animate-pulse');
          }
          if (tokens < 1) {
            enterBtn.title = 'ä»¤ç‰Œä¸è¶³';
          } else if (today_entry_count >= config?.daily_entry_limit) {
            enterBtn.title = `ä»Šæ—¥è¿›å…¥æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${config?.daily_entry_limit}æ¬¡ï¼‰`;
          }
        }
      } else {
        console.error('[updateSupremeTokensUI] æ‰¾ä¸åˆ° enterSupremeButton å…ƒç´ ');
      }
      
      // æ›´æ–°è‡³å°ŠåœºUIçŠ¶æ€
      const betSelector = document.getElementById('supremeBetSelector');
      const modeTitle = document.getElementById('supremeModeTitle');
      const normalModeTitle = document.getElementById('normalModeTitle');
      const advancedModeTitle = document.getElementById('advancedModeTitle');
      const normalRulesBtn = document.querySelector('button[onclick="showSlotRules()"]');
      const supremeRulesBtn = document.getElementById('supremeRulesButton');
      
      if (in_supreme_mode) {
        isInSupremeMode = true;
        if (betSelector) betSelector.classList.remove('hidden');
        
        // ğŸ”¥ è‡³å°Šåœºæ—¶ï¼Œå®Œå…¨éšè—é«˜çº§åœºå’Œåˆçº§åœºUIå…ƒç´ 
        const advancedModeIndicator = document.getElementById('advancedModeIndicator');
        const advancedBetSelector = document.getElementById('advancedBetSelector');
        const advancedTicketBar = document.getElementById('advancedTicketBar');
        const normalModeSpinsDisplay = document.getElementById('normalModeSpinsDisplay');
        const spinButton = document.getElementById('spinButton');
        const freeSpinButton = document.getElementById('freeSpinButton');
        
        if (advancedModeIndicator) advancedModeIndicator.classList.add('hidden');
        if (advancedBetSelector) advancedBetSelector.classList.add('hidden');
        if (advancedTicketBar) advancedTicketBar.classList.add('hidden');
        if (normalModeSpinsDisplay) normalModeSpinsDisplay.classList.add('hidden');
        if (spinButton) spinButton.classList.add('hidden');
        if (freeSpinButton) freeSpinButton.classList.add('hidden');

        // ğŸ”¥ æ›´æ–°æŠ•æ³¨èŒƒå›´å¹¶ç”Ÿæˆé€‰é¡¹
        if (config && config.min_bet_amount && config.max_bet_amount) {
          supremeBetMin = config.min_bet_amount / 500000;
          supremeBetMax = config.max_bet_amount / 500000;

          // ğŸ”¥ æ£€æŸ¥è®¡ç®—åçš„å€¼æ˜¯å¦æœ‰æ•ˆ
          if (!isNaN(supremeBetMin) && !isNaN(supremeBetMax) && supremeBetMin > 0 && supremeBetMax > 0) {
            generateSupremeBetOptions(supremeBetMin, supremeBetMax);

            // æ›´æ–°æ»‘å—èŒƒå›´
            const slider = document.getElementById('supremeBetSlider');
            if (slider) {
              // ğŸ”¥ ä¿å­˜ç”¨æˆ·å½“å‰é€‰æ‹©çš„æŠ•æ³¨é¢åº¦
              const currentValue = parseInt(slider.value) || supremeBetMin;

              slider.min = supremeBetMin;
              slider.max = supremeBetMax;
              // ğŸ”¥ åŠ¨æ€è®¡ç®—æ­¥é•¿ï¼Œç¡®ä¿èƒ½ç²¾ç¡®åˆ°è¾¾æœ€å¤§å€¼
              slider.step = calculateOptimalStep(supremeBetMin, supremeBetMax);

              // ğŸ”¥ å¦‚æœå½“å‰å€¼åœ¨æ–°çš„èŒƒå›´å†…ï¼Œä¿æŒä¸å˜ï¼›å¦åˆ™é‡ç½®ä¸ºæœ€å°å€¼
              if (currentValue >= supremeBetMin && currentValue <= supremeBetMax) {
                slider.value = currentValue;
                updateSupremeBetDisplay(currentValue);
              } else {
                slider.value = supremeBetMin;
                updateSupremeBetDisplay(supremeBetMin);
              }
            }
          } else {
            console.error('[è‡³å°Šåœº] è®¡ç®—çš„æŠ•æ³¨èŒƒå›´æ— æ•ˆ:', { supremeBetMin, supremeBetMax });
          }
        } else {
          console.warn('[è‡³å°Šåœº] ç¼ºå°‘é…ç½®æ•°æ®:', config);
        }
        
        // å¯åŠ¨å€’è®¡æ—¶
        if (supreme_mode_until) {
          startSupremeModeTimer();
        }
        
        // ğŸ”¥ æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
        updateBetLimitProgressBar();
      } else {
        isInSupremeMode = false;
        if (betSelector) betSelector.classList.add('hidden');
        
        stopSupremeModeTimer();
        
        // ğŸ”¥ æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
        updateBetLimitProgressBar();
      }
      
      // ğŸ”¥ ä¸åœ¨è¿™é‡Œè°ƒç”¨ updateModeTitles()ï¼Œå› ä¸ºå·²ç»é€šè¿‡ resetAllModeUI() æˆ– enterSupremeMode() ç»Ÿä¸€ç®¡ç†
      // updateModeTitles();
      // updateGameRulesButton();
    }
    
    // ğŸ’ åˆæˆè‡³å°Šä»¤ç‰Œ
    async function synthesizeSupremeToken() {
      if (!supremeTokensData || !supremeTokensData.can_synthesize) {
        showToast('ç¢ç‰‡ä¸è¶³ï¼Œæ— æ³•åˆæˆ', 'error');
        return;
      }
      
      const btn = document.getElementById('synthesizeSupremeTokenButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ åˆæˆä¸­...';
      
      try {
        const res = await fetch('/api/supreme/tokens/synthesize', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('âœ¨ ' + data.message, 'success');
          await loadSupremeTokens();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[è‡³å°Šåœº] åˆæˆå¤±è´¥:', error);
        showToast('åˆæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    // ğŸ’ è¿›å…¥è‡³å°Šåœº
    async function enterSupremeMode() {
      if (!supremeTokensData || supremeTokensData.tokens < 1) {
        showToast('ä»¤ç‰Œä¸è¶³', 'error');
        return;
      }
      
      const btn = document.getElementById('enterSupremeButton');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ è¿›å…¥ä¸­...';
      
      try {
        const res = await fetch('/api/supreme/enter', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('ğŸ’ ' + data.message, 'success');
          isInSupremeMode = true;
          
          // ğŸ”¥ å…ˆåŠ è½½ä»¤ç‰Œæ•°æ®ï¼ˆä¸è°ƒç”¨UIæ›´æ–°ï¼‰
          const res2 = await fetch('/api/supreme/tokens');
          const tokenData = await res2.json();
          if (tokenData.success) {
            supremeTokensData = tokenData.data;
          }
          
          // ğŸ”¥ åŠ è½½é…ç½®æ•°æ®
          const configRes = await fetch('/api/slot/config');
          const configData = await configRes.json();
          if (configData.success) {
            slotConfig = configData.data.config;
            slotUserData = configData.data.user;
          }
          
          // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘
          switchToModeContainer('supreme');
          
          // ğŸ”¥ å¼ºåˆ¶æ›´æ–°è‡³å°ŠåœºæŠ•æ³¨é€‰é¡¹ï¼ˆä½¿ç”¨APIè¿”å›çš„configï¼‰
          console.log('[enterSupremeMode] æ£€æŸ¥è‡³å°Šåœºé…ç½®:', {
            hasSupremeTokensData: !!supremeTokensData,
            hasConfig: !!supremeTokensData?.config,
            config: supremeTokensData?.config
          });
          
          if (supremeTokensData && supremeTokensData.config) {
            const config = supremeTokensData.config;
            console.log('[enterSupremeMode] è‡³å°Šåœºé…ç½®è¯¦æƒ…:', config);
            
            if (config.min_bet_amount && config.max_bet_amount) {
              supremeBetMin = config.min_bet_amount / 500000;
              supremeBetMax = config.max_bet_amount / 500000;
              
              console.log('[enterSupremeMode] è¿›å…¥åç”ŸæˆæŠ•æ³¨é€‰é¡¹ï¼ŒèŒƒå›´:', supremeBetMin, '~', supremeBetMax);
              
              if (!isNaN(supremeBetMin) && !isNaN(supremeBetMax) && supremeBetMin > 0 && supremeBetMax > 0) {
                generateSupremeBetOptions(supremeBetMin, supremeBetMax);

                const slider = document.getElementById('supremeBetSlider');
                if (slider) {
                  slider.min = supremeBetMin;
                  slider.max = supremeBetMax;
                  slider.value = supremeBetMin;
                  // ğŸ”¥ åŠ¨æ€è®¡ç®—æ­¥é•¿ï¼Œç¡®ä¿èƒ½ç²¾ç¡®åˆ°è¾¾æœ€å¤§å€¼
                  slider.step = calculateOptimalStep(supremeBetMin, supremeBetMax);
                  updateSupremeBetDisplay(supremeBetMin);
                }
              } else {
                console.error('[enterSupremeMode] æŠ•æ³¨èŒƒå›´æ— æ•ˆ');
              }
            } else {
              console.error('[enterSupremeMode] config ç¼ºå°‘ min_bet_amount æˆ– max_bet_amount');
            }
          } else {
            console.error('[enterSupremeMode] supremeTokensData æˆ– config ä¸å­˜åœ¨');
          }
          
          // ğŸ”¥ æ›´æ–°è‡³å°ŠåœºUIçŠ¶æ€
          updateSlotUI();
          updateBetLimitProgressBar();
          
          // ğŸ’ å¯åŠ¨è‡³å°Šåœºå€’è®¡æ—¶ï¼ˆæ˜¾ç¤ºåœ¨å¯¼èˆªæ ï¼‰
          startSupremeModeTimer();
          
          // ğŸ”¥ ç«‹å³è°ƒç”¨æ›´æ–°UIï¼ˆåŒ…æ‹¬æŒ‰é’®æ–‡æœ¬ï¼‰
          await loadSupremeTokens();  // è¿™ä¼šè°ƒç”¨updateSupremeTokensUI
          
          // ğŸ”¥ å»¶è¿Ÿç¡®ä¿å¿«æ·æŒ‰é’®ç”Ÿæˆ
          setTimeout(() => {
            // å†æ¬¡æ£€æŸ¥å¿«æ·æŒ‰é’®æ˜¯å¦ç”Ÿæˆ
            const container = document.getElementById('supremeBetOptions');
            if (container) {
              console.log('[enterSupremeMode] å¿«æ·æŒ‰é’®å®¹å™¨å­å…ƒç´ æ•°é‡:', container.children.length);
              if (container.children.length === 0) {
                console.error('[enterSupremeMode] å¿«æ·æŒ‰é’®æœªç”Ÿæˆï¼é‡æ–°å°è¯•ç”Ÿæˆ');
                if (supremeBetMin && supremeBetMax && !isNaN(supremeBetMin) && !isNaN(supremeBetMax)) {
                  generateSupremeBetOptions(supremeBetMin, supremeBetMax);
                }
              }
            }
            
            // ğŸ”¥ å†æ¬¡å¼ºåˆ¶ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®ï¼ˆä»¥é˜²è¢«å…¶ä»–å‡½æ•°è¦†ç›–ï¼‰
            const enterBtn = document.getElementById('enterSupremeButton');
            if (enterBtn && isInSupremeMode) {
              console.log('[enterSupremeMode] æœ€ç»ˆç¡®è®¤æŒ‰é’®æ–‡æœ¬ä¸ºï¼šé€€å‡ºè‡³å°Šåœº');
              enterBtn.textContent = 'ğŸ’ é€€å‡ºè‡³å°Šåœº';
              enterBtn.onclick = exitSupremeMode;
              enterBtn.disabled = false;
              enterBtn.classList.remove('animate-pulse');
            }
          }, 200);
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[è‡³å°Šåœº] è¿›å…¥å¤±è´¥:', error);
        showToast('è¿›å…¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    // ğŸ’ è‡³å°Šåœºæ—‹è½¬
    async function spinSupremeSlot() {
      if (!isInSupremeMode) {
        showToast('æ‚¨è¿˜æœªè¿›å…¥è‡³å°Šåœº', 'error');
        return;
      }
      
      // ğŸ”¥ æ£€æŸ¥æ˜¯å¦è¢«ç¦æ­¢ä½¿ç”¨è‡³å°Šåœºï¼ˆå¾‹å¸ˆå‡½æƒ©ç½šï¼‰
      if (slotUserData && slotUserData.is_banned && slotUserData.banned_until > Date.now()) {
        const bannedDate = new Date(slotUserData.banned_until);
        const remainingHours = Math.ceil((slotUserData.banned_until - Date.now()) / 3600000);
        showToast(`âš¡ æ‚¨å› æ”¶åˆ°è¿‡å¤šå¾‹å¸ˆå‡½ï¼Œå·²è¢«ç¦æ­¢ä½¿ç”¨è‡³å°Šåœºã€‚è§£ç¦æ—¶é—´ï¼š${bannedDate.toLocaleString('zh-CN', { hour12: false })} (å‰©ä½™çº¦${remainingHours}å°æ—¶)ã€‚æ‚¨å¯ä»¥ç»§ç»­ä½¿ç”¨åˆçº§åœºã€‚`, 'error', 5000);
        return;
      }
      
      const button = document.getElementById('supremeSpinButton');
      if (!button || button.disabled) return;
      
      button.disabled = true;
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="flex items-center justify-center gap-2"><span class="animate-spin">âš™ï¸</span><span>è½¬åŠ¨ä¸­...</span></span>';
      
      // è·å–å½“å‰é€‰æ‹©çš„æŠ•æ³¨é‡‘é¢ï¼ˆå¤å¸ï¼‰
      const betAmount = parseInt(document.getElementById('supremeBetSlider')?.value || '1000') * 500000;
      
      try {
        const res = await fetch('/api/supreme/spin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ betAmount })
        });
        
        const data = await res.json();
        
        if (data.success) {
          const { symbols, win_type: winType, multiplier, win_amount: winAmount, quota_after: quotaAfter } = data.data;

          // ğŸµ æ’­æ”¾è½¬åŠ¨éŸ³æ•ˆ
          soundManager.playSpin();

          // ğŸ”¥ æ’­æ”¾è½¬åŠ¨åŠ¨ç”»ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„åŠ¨ç”»å‡½æ•°ï¼‰
          await playSpinAnimation(symbols);
          
          // ğŸ”¥ æ›´æ–°ç”¨æˆ·é¢åº¦å¹¶åŒæ­¥åˆ°UI
          if (slotUserData) {
            slotUserData.quota = quotaAfter;
          } else {
            console.warn('[è‡³å°Šåœº] slotUserData ä¸å­˜åœ¨ï¼Œå°è¯•åˆå§‹åŒ–');
            // å¦‚æœ slotUserData ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬å¯¹è±¡
            slotUserData = {
              quota: quotaAfter,
              remaining_spins: 0,
              free_spins: 0,
              today_count: 0,
              today_bet: 0,
              today_win: 0,
              total_spins: 0,
              total_bet: 0,
              total_win: 0
            };
          }
          
          // ğŸ”¥ æ›´æ–°è€è™æœºç•Œé¢ä½™é¢æ˜¾ç¤º
          updateSlotUI();

          // ğŸ”¥ æŠ•æ³¨åéšè—å¤å‘—buffæç¤ºï¼ˆbuffå·²ä½¿ç”¨ï¼‰
          hideAllKunbeiBuffTips();
          
          // ğŸ”¥ åŒæ­¥ä½™é¢åˆ°ä¸»ç•Œé¢å³ä¸Šè§’ï¼ˆåŠ æ²¹ç«™é¡µé¢çš„ä½™é¢æ˜¾ç¤ºï¼‰
          const quotaValueEl = document.getElementById('quotaValue');
          if (quotaValueEl) {
            quotaValueEl.textContent = `$${(quotaAfter / 500000).toFixed(2)}`;
          }
          
          // ğŸ”¥ æ›´æ–°å¾…å‘æ”¾ç»Ÿè®¡å’Œä½™é¢æ˜¾ç¤º
          setTimeout(() => loadPendingRewardsSummary(), 500);

          // ğŸ”¥ æ˜¾ç¤ºç»“æœï¼ˆä½¿ç”¨è‡³å°Šåœºçš„ç»“æœå®¹å™¨ï¼‰
          const supremeResultDiv = document.getElementById('supremeSlotResult');
          const supremeResultText = document.getElementById('supremeSlotResultText');

          if (supremeResultText) supremeResultText.textContent = data.message;
          if (supremeResultDiv) supremeResultDiv.classList.remove('hidden');

          // ğŸ”¥ æ ¹æ®å€ç‡åŠ¨æ€è®¾ç½®æç¤ºåœç•™æ—¶é—´ï¼ˆé€‚é…ä»»æ„è§„åˆ™é…ç½®ï¼‰
          let displayDuration = 3000; // é»˜è®¤3ç§’

          if (multiplier >= 100) {
            // è¶…é«˜å€ç‡ï¼ˆâ‰¥100xï¼‰ï¼š5ç§’
            displayDuration = 5000;
          } else if (multiplier >= 20) {
            // é«˜å€ç‡ï¼ˆ20-99xï¼‰ï¼š4.5ç§’
            displayDuration = 4500;
          } else if (multiplier >= 10) {
            // ä¸­é«˜å€ç‡ï¼ˆ10-19xï¼‰ï¼š4ç§’
            displayDuration = 4000;
          } else if (multiplier >= 5) {
            // ä¸­ç­‰å€ç‡ï¼ˆ5-9xï¼‰ï¼š3.5ç§’
            displayDuration = 3500;
          } else if (multiplier >= 2) {
            // ä½å€ç‡ï¼ˆ2-4xï¼‰ï¼š3ç§’
            displayDuration = 3000;
          } else if (multiplier < 0) {
            // æƒ©ç½šï¼š3ç§’ï¼ˆè®©ç©å®¶çœ‹æ¸…æ¥šæ‰£æ¬¾ï¼‰
            displayDuration = 3000;
          } else {
            // æœªä¸­å¥–ï¼š1ç§’
            displayDuration = 1000;
          }

          setTimeout(() => {
            if (supremeResultDiv) supremeResultDiv.classList.add('hidden');
          }, displayDuration);

          // æ’­æ”¾éŸ³æ•ˆå’Œæ˜¾ç¤ºToast
          const winAmountUSD = (Math.abs(winAmount) / 500000).toFixed(2);
          if (multiplier > 0) {
            soundManager.playWin(multiplier);
            showToast(`ğŸ’ æ­å–œä¸­å¥–ï¼${multiplier}x èµ¢å¾— $${winAmountUSD}`, 'success');
          } else if (multiplier < 0) {
            soundManager.playPunishment();
            showToast(`âš–ï¸ å¾‹å¸ˆå‡½æƒ©ç½šï¼æ‰£é™¤ $${winAmountUSD}`, 'error');
          } else {
            soundManager.playLose();
            showToast('æœªä¸­å¥–', 'error');
          }
          
          // ğŸ”¥ é‡æ–°åŠ è½½è‡³å°Šä»¤ç‰Œä¿¡æ¯
          await loadSupremeTokens();
          
          // ğŸ”¥ åˆ·æ–°æ’è¡Œæ¦œï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
          if (winAmount !== 0) {
            setTimeout(() => loadSidebarLeaderboard(), 1000);
          }

          // ğŸ† æ˜¾ç¤ºæˆå°±è§£é”Toastï¼ˆå·¦ä¸Šè§’ï¼‰
          if (data.data.unlocked_achievements && data.data.unlocked_achievements.length > 0) {
            const achievementDelay = winAmount > 0 ? 2000 : 1000;

            data.data.unlocked_achievements.forEach((achievement, index) => {
              setTimeout(() => {
                showAchievementToast(achievement);
              }, achievementDelay + (index * 1000));
            });
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[è‡³å°Šåœº] æ—‹è½¬å¤±è´¥:', error);
        showToast('æ—‹è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        // ğŸ”¥ æ¢å¤æŒ‰é’®çŠ¶æ€
        if (button) {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }
    }
    
    // ğŸ’ é€€å‡ºè‡³å°Šåœº
    async function exitSupremeMode() {
      if (!confirm('ç¡®å®šè¦é€€å‡ºè‡³å°Šåœºå—ï¼Ÿ\né€€å‡ºåå°†è¿”å›é«˜çº§åœºã€‚')) {
        return;
      }
      
      try {
        const res = await fetch('/api/supreme/exit', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          isInSupremeMode = false;
          
          // ğŸ”¥ å¹¶è¡ŒåŠ è½½é…ç½®å’ŒçŠ¶æ€ï¼Œå¹¶æ­£ç¡®ä¿å­˜é…ç½®
          const [_, configRes, __] = await Promise.all([
            loadSupremeTokens(),
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨é«˜çº§åœº
          ]);
          
          // ğŸ”¥ ä¿å­˜åŠ è½½çš„é…ç½®æ•°æ®
          if (configRes && configRes.success) {
            slotConfig = configRes.data.config;
            slotUserData = configRes.data.user;
          }
          
          // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘ï¼ˆé€€å‡ºè‡³å°Šåœºå›åˆ°é«˜çº§åœºæˆ–åˆçº§åœºï¼‰
          if (isInAdvancedMode) {
            switchToModeContainer('advanced');
          } else {
            switchToModeContainer('normal');
          }
          updateSlotUI();
          updateBetLimitProgressBar();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('[è‡³å°Šåœº] é€€å‡ºå¤±è´¥:', error);
        showToast('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // ğŸ”¥ æ–°ç‰ˆï¼šç®€åŒ–çš„æ›´æ–°åœºå¼æ ‡é¢˜å‡½æ•°ï¼ˆä½¿ç”¨å®¹å™¨æ¶æ„ï¼‰
    function updateModeTitles() {
      console.log('[updateModeTitles] è°ƒç”¨æ–°ç‰ˆå®¹å™¨åˆ‡æ¢é€»è¾‘');
      
      // ç›´æ¥è°ƒç”¨å®¹å™¨åˆ‡æ¢å‡½æ•°
      if (isInSupremeMode) {
        switchToModeContainer('supreme');
      } else if (isInAdvancedMode) {
        switchToModeContainer('advanced');
      } else {
        switchToModeContainer('normal');
      }
    }
    
    // ğŸ¯ ç»Ÿä¸€æ›´æ–°æ¸¸æˆè§„åˆ™æŒ‰é’®æ˜¾ç¤ºï¼ˆé¿å…é‡å ï¼‰
    function updateGameRulesButton() {
      const normalRulesBtn = document.querySelector('button[onclick="showSlotRules()"]');
      const supremeRulesBtn = document.getElementById('supremeRulesButton');
      
      // å…ˆéšè—æ‰€æœ‰è§„åˆ™æŒ‰é’®
      if (normalRulesBtn) normalRulesBtn.classList.add('hidden');
      if (supremeRulesBtn) supremeRulesBtn.classList.add('hidden');
      
      // æ ¹æ®å½“å‰çŠ¶æ€æ˜¾ç¤ºç›¸åº”çš„è§„åˆ™æŒ‰é’®
      if (isInSupremeMode) {
        // ğŸ’ è‡³å°Šåœºï¼šæ˜¾ç¤ºè‡³å°Šåœºè§„åˆ™æŒ‰é’®
        if (supremeRulesBtn) supremeRulesBtn.classList.remove('hidden');
      } else {
        // ğŸ”¥ é«˜çº§åœºæˆ–åˆçº§åœºï¼šæ˜¾ç¤ºé€šç”¨è§„åˆ™æŒ‰é’®ï¼ˆä¼šæ ¹æ®åœºæ¬¡åŠ¨æ€åŠ è½½è§„åˆ™ï¼‰
        if (normalRulesBtn) normalRulesBtn.classList.remove('hidden');
      }
    }
    
    // ğŸ”¥ æ–°ç‰ˆï¼šç®€åŒ–çš„åœºæ¬¡å®¹å™¨åˆ‡æ¢ï¼ˆæ–¹æ¡ˆCæ¶æ„ï¼‰+ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
    function switchToModeContainer(mode) {
      console.log('[switchToModeContainer] åˆ‡æ¢åˆ°:', mode);
      
      // è·å–ä¸‰ä¸ªåœºæ¬¡å®¹å™¨
      const normalContainer = document.getElementById('normalModeContainer');
      const advancedContainer = document.getElementById('advancedModeContainer');
      const supremeContainer = document.getElementById('supremeModeContainer');
      
      // è·å–å¯¼èˆªæ å…ƒç´ 
      const normalModeTitle = document.getElementById('normalModeTitle');
      const advancedModeTitle = document.getElementById('advancedModeTitle');
      const supremeModeTitle = document.getElementById('supremeModeTitle');
      const advancedModeIndicator = document.getElementById('advancedModeIndicator');
      const supremeModeIndicator = document.getElementById('supremeModeIndicator');
      const advancedTicketBar = document.getElementById('advancedTicketBar');
      const supremeTokenBar = document.getElementById('supremeTokenBar');
      
      // ğŸ”¥ å…ˆè®©å½“å‰æ˜¾ç¤ºçš„å®¹å™¨æ·¡å‡º
      [normalContainer, advancedContainer, supremeContainer].forEach(container => {
        if (container && !container.classList.contains('hidden')) {
          container.style.opacity = '0';
        }
      });
      
      // çŸ­æš‚å»¶è¿Ÿåéšè—
      setTimeout(() => {
        // éšè—æ‰€æœ‰å®¹å™¨å’Œå¯¼èˆªå…ƒç´ 
        if (normalContainer) normalContainer.classList.add('hidden');
        if (advancedContainer) advancedContainer.classList.add('hidden');
        if (supremeContainer) supremeContainer.classList.add('hidden');
        if (normalModeTitle) normalModeTitle.classList.add('hidden');
        if (advancedModeTitle) advancedModeTitle.classList.add('hidden');
        if (supremeModeTitle) supremeModeTitle.classList.add('hidden');
        if (advancedModeIndicator) advancedModeIndicator.classList.add('hidden');
        if (supremeModeIndicator) supremeModeIndicator.classList.add('hidden');
        if (advancedTicketBar) advancedTicketBar.classList.add('hidden');
        if (supremeTokenBar) supremeTokenBar.classList.add('hidden');
        
        // ğŸ”¥ æ ¹æ®æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„å®¹å™¨å’Œå¯¼èˆªå…ƒç´ 
        let targetContainer;
        if (mode === 'normal') {
          // ğŸ° åˆçº§åœº
          if (normalContainer) normalContainer.classList.remove('hidden');
          if (normalModeTitle) normalModeTitle.classList.remove('hidden');
          if (advancedTicketBar) advancedTicketBar.classList.remove('hidden');
          targetContainer = normalContainer;
        } else if (mode === 'advanced') {
          // ğŸ”¥ é«˜çº§åœº
          if (advancedContainer) advancedContainer.classList.remove('hidden');
          if (advancedModeTitle) advancedModeTitle.classList.remove('hidden');
          if (advancedModeIndicator) advancedModeIndicator.classList.remove('hidden');
          if (supremeTokenBar) supremeTokenBar.classList.remove('hidden');
          targetContainer = advancedContainer;
        } else if (mode === 'supreme') {
          // ğŸ’ è‡³å°Šåœº
          if (supremeContainer) supremeContainer.classList.remove('hidden');
          if (supremeModeTitle) supremeModeTitle.classList.remove('hidden');
          if (supremeModeIndicator) supremeModeIndicator.classList.remove('hidden');
          if (supremeTokenBar) supremeTokenBar.classList.remove('hidden');
          targetContainer = supremeContainer;
        }
        
        // ğŸ’ æ·¡å…¥æ–°å®¹å™¨
        if (targetContainer) {
          targetContainer.style.opacity = '0';
          requestAnimationFrame(() => {
            targetContainer.style.opacity = '1';
          });
        }
        
        // ğŸ”¥ æ›´æ–°æ¸¸æˆè§„åˆ™æŒ‰é’®æ˜¾ç¤º
        updateGameRulesButton();
        
        console.log('[switchToModeContainer] åˆ‡æ¢å®Œæˆï¼Œå½“å‰æ˜¾ç¤º:', mode);
      }, 150);  // æ·¡å‡ºåŠ¨ç”»æ—¶é—´
    }
    
    // ğŸ”¥ æ—§ç‰ˆï¼šä¿ç•™ç”¨äºå…¼å®¹ï¼ˆå°†è¢«é€æ­¥æ›¿æ¢ï¼‰
    function resetAllModeUI() {
      console.log('[resetAllModeUI] è°ƒç”¨æ–°ç‰ˆ switchToModeContainer');
      
      // æ ¹æ®å½“å‰çŠ¶æ€è°ƒç”¨æ–°çš„åˆ‡æ¢å‡½æ•°
      if (isInSupremeMode) {
        switchToModeContainer('supreme');
      } else if (isInAdvancedMode) {
        switchToModeContainer('advanced');
      } else {
        switchToModeContainer('normal');
      }
    }
    
    // ğŸ’ å¯åŠ¨è‡³å°Šåœºå€’è®¡æ—¶
    function startSupremeModeTimer() {
      stopSupremeModeTimer();
      
      if (!supremeTokensData || !supremeTokensData.supreme_mode_until) return;
      
      const updateTimer = () => {
        const now = Date.now();
        const remaining = supremeTokensData.supreme_mode_until - now;
        
        if (remaining <= 0) {
          // æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨é€€å‡ºè‡³å°Šåœº
          const timeEl = document.getElementById('supremeTimeRemaining');
          if (timeEl) timeEl.textContent = '00:00:00';
          stopSupremeModeTimer();
          showToast('è‡³å°Šåœºæ—¶é—´å·²åˆ°ï¼Œå·²è‡ªåŠ¨é€€å‡º', 'error');
          isInSupremeMode = false;
          
          Promise.all([
            loadSupremeTokens(),
            fetch('/api/slot/config').then(res => res.json()),
            loadAdvancedTickets()  // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨é«˜çº§åœº
          ]).then(([_, configRes, __]) => {
            // ä¿å­˜é…ç½®æ•°æ®
            if (configRes && configRes.success) {
              slotConfig = configRes.data.config;
              slotUserData = configRes.data.user;
            }
            // ğŸ”¥ ä½¿ç”¨æ–°çš„å®¹å™¨åˆ‡æ¢é€»è¾‘ï¼ˆæ ¹æ®æ˜¯å¦åœ¨é«˜çº§åœºè¿”å›å¯¹åº”åœºæ¬¡ï¼‰
            if (isInAdvancedMode) {
              switchToModeContainer('advanced');
            } else {
              switchToModeContainer('normal');
            }
            updateSlotUI();
            updateBetLimitProgressBar();
          });
          
          return;
        }
        
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // ğŸ”¥ æ›´æ–°å¯¼èˆªæ ä¸­çš„å€’è®¡æ—¶
        const timeEl = document.getElementById('supremeTimeRemaining');
        if (timeEl) timeEl.textContent = timeStr;
      };
      
      updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
      supremeModeTimer = setInterval(updateTimer, 1000);
    }
    
    // ğŸ’ åœæ­¢è‡³å°Šåœºå€’è®¡æ—¶
    function stopSupremeModeTimer() {
      if (supremeModeTimer) {
        clearInterval(supremeModeTimer);
        supremeModeTimer = null;
      }
    }
    
    // ğŸ’ åŠ¨æ€è®¡ç®—æ»‘å—æ­¥é•¿ï¼ˆç¡®ä¿èƒ½ç²¾ç¡®åˆ°è¾¾æœ€å¤§å€¼ï¼‰
    function calculateOptimalStep(minValue, maxValue) {
      const range = maxValue - minValue;
      
      // å€™é€‰æ­¥é•¿ï¼ˆä»å°åˆ°å¤§çš„"å¥½çœ‹"æ•°å­—ï¼‰
      const candidates = [1, 2, 4, 5, 10, 20, 25, 50, 100, 200, 250, 500, 1000, 2000, 2500, 5000, 10000];
      
      // ä¼˜å…ˆæ‰¾åˆ°èƒ½æ•´é™¤ range çš„æœ€å¤§æ­¥é•¿ï¼Œæ¡£ä½æ•°åˆç†ï¼ˆ20-200æ¡£æœ€ä½³ï¼‰
      for (let i = candidates.length - 1; i >= 0; i--) {
        const step = candidates[i];
        if (range % step === 0) {
          const levels = range / step;
          if (levels >= 20 && levels <= 200) {
            return step;
          }
        }
      }
      
      // æ”¾å®½é™åˆ¶ï¼š10-1000æ¡£ä¹Ÿå¯ä»¥æ¥å—
      for (let i = candidates.length - 1; i >= 0; i--) {
        const step = candidates[i];
        if (range % step === 0) {
          const levels = range / step;
          if (levels >= 10 && levels <= 1000) {
            return step;
          }
        }
      }
      
      // å¦‚æœå€™é€‰åˆ—è¡¨ä¸­æ²¡æœ‰åˆé€‚çš„ï¼Œè®¡ç®— range çš„å› æ•°ï¼Œä»å¤§åˆ°å°å°è¯•
      const findDivisor = (target, minLevels, maxLevels) => {
        for (let divisor = Math.floor(target / minLevels); divisor >= 1; divisor--) {
          if (target % divisor === 0) {
            const levels = target / divisor;
            if (levels >= minLevels && levels <= maxLevels) {
              return divisor;
            }
          }
        }
        return null;
      };
      
      // å°è¯•æ‰¾åˆ°äº§ç”Ÿ 50-200 æ¡£ä½çš„å› æ•°
      let step = findDivisor(range, 50, 200);
      if (step) {
        return step;
      }
      
      // æ”¾å®½åˆ° 20-500 æ¡£ä½
      step = findDivisor(range, 20, 500);
      if (step) {
        return step;
      }

      // å…œåº•ï¼šè¿”å›1ï¼ˆå§‹ç»ˆèƒ½æ•´é™¤ï¼Œä½†æ¡£ä½å¯èƒ½å¾ˆå¤šï¼‰
      return 1;
    }
    
    // ğŸ’ ç”Ÿæˆè‡³å°ŠåœºæŠ•æ³¨é€‰é¡¹æŒ‰é’®ï¼ˆç´§å‡‘ç‰ˆï¼Œç±»ä¼¼é«˜çº§åœºï¼‰
    function generateSupremeBetOptions(minBet, maxBet) {
      const container = document.getElementById('supremeBetOptions');
      if (!container) {
        console.error('[generateSupremeBetOptions] supremeBetOptions å®¹å™¨ä¸å­˜åœ¨ï¼');
        return;
      }

      // ğŸ”¥ æ£€æŸ¥å‚æ•°æ˜¯å¦æœ‰æ•ˆ
      if (isNaN(minBet) || isNaN(maxBet) || minBet <= 0 || maxBet <= 0 || minBet > maxBet) {
        console.error('[è‡³å°Šåœº] æ— æ•ˆçš„æŠ•æ³¨èŒƒå›´:', { minBet, maxBet });
        container.innerHTML = '<p class="text-white/70 text-sm text-center">é…ç½®åŠ è½½ä¸­...</p>';
        return;
      }

      container.innerHTML = '';
      
      const range = maxBet - minBet;
      const options = [];
      
      // ğŸ”¥ åƒé«˜çº§åœºä¸€æ ·ï¼Œå§‹ç»ˆç”Ÿæˆ4ä¸ªé€‰é¡¹
      if (range <= 100) {
        options.push(minBet, maxBet);
      } else {
        const step = Math.floor(range / 3);
        options.push(minBet);
        options.push(minBet + step);
        options.push(minBet + step * 2);
        options.push(maxBet);
      }
      
      const uniqueOptions = [...new Set(options)].sort((a, b) => a - b);

      uniqueOptions.forEach((amount, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white font-semibold rounded-lg transition-all duration-200 text-sm';
        btn.textContent = `$${amount}`;
        btn.onclick = () => selectSupremeBet(amount);
        container.appendChild(btn);
      });

      // æ›´æ–°æ»‘å—èŒƒå›´
      const slider = document.getElementById('supremeBetSlider');
      if (slider) {
        slider.min = minBet;
        slider.max = maxBet;
        slider.value = supremeBetAmount || minBet;
        // ğŸ”¥ åŠ¨æ€è®¡ç®—æ­¥é•¿ï¼Œç¡®ä¿èƒ½ç²¾ç¡®åˆ°è¾¾æœ€å¤§å€¼
        slider.step = calculateOptimalStep(minBet, maxBet);
      } else {
        console.error('[è‡³å°Šåœº] æ‰¾ä¸åˆ° supremeBetSlider å…ƒç´ ');
      }
    }
    
    // ğŸ’ é€‰æ‹©è‡³å°ŠåœºæŠ•æ³¨é‡‘é¢
    function selectSupremeBet(amount) {
      // ğŸ”¥ æ£€æŸ¥é‡‘é¢æ˜¯å¦æœ‰æ•ˆ
      if (isNaN(amount) || amount <= 0) {
        console.warn('[è‡³å°Šåœº] æ— æ•ˆçš„æŠ•æ³¨é‡‘é¢:', amount);
        return;
      }
      
      supremeBetAmount = amount;
      const slider = document.getElementById('supremeBetSlider');
      const betDisplay = document.getElementById('supremeBetDisplay');
      
      if (slider) slider.value = amount;
      if (betDisplay) betDisplay.textContent = `$${amount}`;  // ğŸ”¥ æŒ‰é’®ä¸Šæ˜¾ç¤ºç¾å…ƒ
    }
    
    // ğŸ’ æ›´æ–°è‡³å°ŠåœºæŠ•æ³¨æ˜¾ç¤º
    function updateSupremeBetDisplay(value) {
      const parsedValue = parseInt(value);
      // ğŸ”¥ æ£€æŸ¥å€¼æ˜¯å¦æœ‰æ•ˆ
      if (isNaN(parsedValue) || parsedValue < supremeBetMin || parsedValue > supremeBetMax) {
        console.warn('[è‡³å°Šåœº] æ— æ•ˆçš„æŠ•æ³¨é‡‘é¢:', value);
        supremeBetAmount = supremeBetMin || 1000;  // ä½¿ç”¨æœ€å°å€¼æˆ–é»˜è®¤å€¼
      } else {
        supremeBetAmount = parsedValue;
      }
      selectSupremeBet(supremeBetAmount);  // ğŸ”¥ ç»Ÿä¸€è°ƒç”¨
    }

    // ========== ç»“æŸï¼šè€è™æœºç›¸å…³åŠŸèƒ½ ==========

    window.onload = async () => {
      const isOAuthCallback = document.referrer.includes('connect.linux.do') || sessionStorage.getItem('oauth_loading');

      if (!isOAuthCallback) {
        document.getElementById('loadingPage').classList.add('hidden');
      }

      try {
        const res = await fetch('/api/user/quota');
        const data = await res.json();
        
        if (res.ok) {
          document.getElementById('loadingPage').classList.add('hidden');
          
          // æ¢å¤ä¹‹å‰çš„æ¨¡å¼
          const restoredMode = restoreMode();
          currentMode = restoredMode;
          
          if (restoredMode === 'entertain') {
            // å¦‚æœä¹‹å‰åœ¨è€è™æœºé¡µé¢ï¼Œç›´æ¥æ‰“å¼€è€è™æœº
            document.getElementById('mainSection').classList.add('hidden');
            await loadQuota();
            updateSwitchButtons('entertain');
            showSlotMachine();
            // åŠ è½½å¾…å‘æ”¾è®°å½•ç»Ÿè®¡
            loadPendingRewardsSummary();
          } else if (restoredMode === 'achievement') {
            // âœ… å¦‚æœä¹‹å‰åœ¨æˆå°±é¡µé¢ï¼Œæ¢å¤åˆ°æˆå°±é¡µé¢
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('achievementSection').classList.remove('hidden');
            await loadQuota();
            updateSwitchButtons('achievement');
            // âœ… åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°æˆå°±ç•Œé¢
            syncUserInfoToAchievement();
            // åŠ è½½æˆå°±æ•°æ®
            loadAchievements();
            // åŠ è½½å¾…å‘æ”¾è®°å½•ç»Ÿè®¡
            loadPendingRewardsSummary();
          } else {
            // é»˜è®¤æ˜¾ç¤ºåŠ æ²¹ç«™
            document.getElementById('mainSection').classList.remove('hidden');
            await loadQuota();
            updateSwitchButtons('refuel');
            // åŠ è½½å¾…å‘æ”¾è®°å½•ç»Ÿè®¡
            loadPendingRewardsSummary();
          }
          
          if (isOAuthCallback) {
            showToast('ç™»å½•æˆåŠŸ', 'success');
            sessionStorage.removeItem('oauth_loading');
          }
        } else if (res.status === 403 && data.banned) {
          // ç”¨æˆ·è¢«å°ç¦
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
          alert('âš ï¸ ' + data.message);
        } else if (res.status === 400) {
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('bindSection').classList.remove('hidden');
        } else {
          document.getElementById('loadingPage').classList.add('hidden');
          document.getElementById('loginSection').classList.remove('hidden');
        }
      } catch (e) {
        document.getElementById('loadingPage').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
      }
    };
    
    // ========== å¤å‘—å€Ÿæ¬¾ç³»ç»Ÿ ==========
    
    let kunbeiData = null;
    let kunbeiCurrentAmount = 25000000;  // é»˜è®¤$50
    let kunbeiConfig = null;
    let kunbeiConfirmResolver = null;  // ç”¨äºå¤„ç†ç¡®è®¤å¯¹è¯æ¡†çš„Promise
    let kunbeiUpdateTimer = null;      // å¤å‘—ä¿¡æ¯æ›´æ–°å®šæ—¶å™¨
    
    // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
    function kunbeiConfirm(title, content) {
      return new Promise((resolve) => {
        kunbeiConfirmResolver = resolve;
        document.getElementById('kunbeiConfirmTitle').textContent = title;
        
        // å¤„ç†å†…å®¹ - æ”¯æŒHTML
        if (typeof content === 'object') {
          // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ„å»ºHTMLå†…å®¹
          const contentHtml = Object.entries(content).map(([key, value]) => {
            return `<div class="flex justify-between items-center py-1">
              <span class="text-slate-600">${key}:</span>
              <span class="font-semibold ${value.class || ''}">${value.text || value}</span>
            </div>`;
          }).join('');
          document.getElementById('kunbeiConfirmContent').innerHTML = contentHtml;
        } else {
          document.getElementById('kunbeiConfirmContent').innerHTML = content;
        }
        
        document.getElementById('kunbeiConfirmDialog').classList.remove('hidden');
      });
    }
    
    // ç¡®è®¤å¯¹è¯æ¡†å›è°ƒ
    function kunbeiConfirmResolve(result) {
      document.getElementById('kunbeiConfirmDialog').classList.add('hidden');
      if (kunbeiConfirmResolver) {
        kunbeiConfirmResolver(result);
        kunbeiConfirmResolver = null;
      }
    }
    
    // åŠ è½½å¤å‘—çŠ¶æ€ï¼ˆç”¨äºæ›´æ–°æ‚¬æµ®æŒ‰é’®ï¼‰
    async function loadKunbeiStatus() {
      try {
        const [configRes, statusRes] = await Promise.all([
          fetch('/api/kunbei/config'),
          fetch('/api/kunbei/status')
        ]);
        
        const configData = await configRes.json();
        const statusData = await statusRes.json();
        
        if (configData.success && statusData.success) {
          kunbeiConfig = configData.data;
          kunbeiData = statusData.data;
          
          // æ›´æ–°æ‚¬æµ®æŒ‰é’®çš„title
          const kunbeiFloatingButton = document.getElementById('kunbeiFloatingButton');
          if (kunbeiFloatingButton) {
            if (kunbeiData.has_active_loan) {
              kunbeiFloatingButton.title = "ç‚¹å‡»è¿˜æ¬¾";
            } else {
              kunbeiFloatingButton.title = "æ€¥ç”¨é’±ï¼Ÿå¤å‘—æ‡‚ä½ ã€‚";
            }
          }
        }
      } catch (error) {
        console.error('åŠ è½½å¤å‘—çŠ¶æ€å¤±è´¥:', error);
      }
    }

    // ğŸ”¥ æ£€æŸ¥å¹¶æ˜¾ç¤ºå¤å‘—buffæç¤º
    async function checkAndShowKunbeiBuff() {
      try {
        const res = await fetch('/api/kunbei/check-buff');
        const data = await res.json();
        
        if (data.success && data.data.has_buff) {
          const multiplier = data.data.buff_multiplier;
          
          // æ ¹æ®å½“å‰åœºæ¬¡æ˜¾ç¤ºå¯¹åº”çš„buffæç¤º
          if (isInSupremeMode) {
            // è‡³å°Šåœº
            const tip = document.getElementById('supremeKunbeiBuffTip');
            const multiplierSpan = document.getElementById('supremeKunbeiBuffMultiplier');
            if (tip && multiplierSpan) {
              multiplierSpan.textContent = multiplier;
              tip.classList.remove('hidden');
            }
          } else if (isInAdvancedMode) {
            // é«˜çº§åœº
            const tip = document.getElementById('advancedKunbeiBuffTip');
            const multiplierSpan = document.getElementById('advancedKunbeiBuffMultiplier');
            if (tip && multiplierSpan) {
              multiplierSpan.textContent = multiplier;
              tip.classList.remove('hidden');
            }
          } else {
            // åˆçº§åœº
            const tip = document.getElementById('kunbeiBuffTip');
            const multiplierSpan = document.getElementById('kunbeiBuffMultiplier');
            if (tip && multiplierSpan) {
              multiplierSpan.textContent = multiplier;
              tip.classList.remove('hidden');
            }
          }
        } else {
          // æ²¡æœ‰buffï¼Œéšè—æ‰€æœ‰æç¤º
          hideAllKunbeiBuffTips();
        }
      } catch (error) {
        console.error('æ£€æŸ¥å¤å‘—buffå¤±è´¥:', error);
      }
    }

    // ğŸ”¥ éšè—æ‰€æœ‰å¤å‘—buffæç¤º
    function hideAllKunbeiBuffTips() {
      const tips = [
        document.getElementById('kunbeiBuffTip'),
        document.getElementById('advancedKunbeiBuffTip'),
        document.getElementById('supremeKunbeiBuffTip')
      ];
      tips.forEach(tip => {
        if (tip) tip.classList.add('hidden');
      });
    }
    
    // æ‰“å¼€å¤å‘—æ¨¡æ€æ¡†
    async function openKunbeiModal() {
      try {
        // åŠ è½½é…ç½®å’ŒçŠ¶æ€
        const [configRes, statusRes] = await Promise.all([
          fetch('/api/kunbei/config'),
          fetch('/api/kunbei/status')
        ]);
        
        const configData = await configRes.json();
        const statusData = await statusRes.json();
        
        if (!configData.success || !statusData.success) {
          showToast('åŠ è½½å¤å‘—ä¿¡æ¯å¤±è´¥', 'error');
          return;
        }
        
        kunbeiConfig = configData.data;
        kunbeiData = statusData.data;
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨
        if (!kunbeiConfig.enabled) {
          showToast('å¤å‘—åŠŸèƒ½å·²å…³é—­', 'error');
          return;
        }
        
        // æ›´æ–°UI
        updateKunbeiUI();
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('kunbeiModal').classList.remove('hidden');
        
        // é»˜è®¤æ˜¾ç¤ºå€Ÿæ¬¾é¢æ¿
        switchKunbeiTab('borrow');
        
        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼Œä»¥å®æ—¶æ˜¾ç¤ºå‰©ä½™æ—¶é—´ï¼‰
        if (kunbeiUpdateTimer) {
          clearInterval(kunbeiUpdateTimer);
        }
        kunbeiUpdateTimer = setInterval(async () => {
          // æ›´æ–°è¿˜æ¬¾é¢æ¿çš„æ—¶é—´æ˜¾ç¤º
          if (kunbeiData && kunbeiData.has_active_loan) {
            updateRepayPanel();
          }
          
          // æ¯30ç§’é‡æ–°åŠ è½½ä¸€æ¬¡æ•°æ®ï¼Œä»¥è·å–æœ€æ–°çŠ¶æ€
          if (Date.now() % 30000 < 1000) {
            try {
              const statusRes = await fetch('/api/kunbei/status');
              const statusData = await statusRes.json();
              if (statusData.success) {
                kunbeiData = statusData.data;
                updateKunbeiUI();
              }
            } catch (error) {
              console.error('æ›´æ–°å¤å‘—çŠ¶æ€å¤±è´¥:', error);
            }
          }
        }, 1000);
      } catch (error) {
        console.error('æ‰“å¼€å¤å‘—å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeKunbeiModal() {
      document.getElementById('kunbeiModal').classList.add('hidden');
      
      // æ¸…é™¤å®šæ—¶å™¨
      if (kunbeiUpdateTimer) {
        clearInterval(kunbeiUpdateTimer);
        kunbeiUpdateTimer = null;
      }
    }
    
    // åˆ‡æ¢Tab
    function switchKunbeiTab(tab) {
      const tabs = { borrow: 'Borrow', repay: 'Repay', records: 'Records' };
      const tabNames = { borrow: 'å€Ÿæ¬¾', repay: 'è¿˜æ¬¾', records: 'è®°å½•' };
      
      Object.keys(tabs).forEach(t => {
        const tabBtn = document.getElementById(`kunbeiTab${tabs[t]}`);
        const panel = document.getElementById(`kunbei${tabs[t]}Panel`);
        
        if (t === tab) {
          tabBtn.className = 'flex-1 pb-3 text-sm font-semibold border-b-2 border-orange-500 text-orange-600';
          tabBtn.innerHTML = `â–£ ${tabNames[t]}`;  // é€‰ä¸­æ—¶ä½¿ç”¨å®å¿ƒæ–¹æ¡†
          panel.classList.remove('hidden');
        } else {
          tabBtn.className = 'flex-1 pb-3 text-sm font-semibold border-b-2 border-transparent text-slate-400';
          tabBtn.innerHTML = `â–¢ ${tabNames[t]}`;  // æœªé€‰ä¸­æ—¶ä½¿ç”¨ç©ºå¿ƒæ–¹æ¡†
          panel.classList.add('hidden');
        }
      });
      
      if (tab === 'repay') updateRepayPanel();
      else if (tab === 'records') loadKunbeiRecords();
    }
    
    // æ›´æ–°UI
    function updateKunbeiUI() {
      if (!kunbeiData || !kunbeiConfig) return;
      
      const maxLoanUsd = kunbeiData.max_loan_amount ? kunbeiData.max_loan_amount / 500000 : kunbeiConfig.max_loan_amount / 500000;
      const activeLoanUsd = kunbeiData.active_loan ? kunbeiData.active_loan.loan_amount / 500000 : 0;
      const availableUsd = maxLoanUsd - activeLoanUsd;
      const usagePercent = maxLoanUsd > 0 ? (activeLoanUsd / maxLoanUsd * 100).toFixed(0) : 0;
      
      document.getElementById('kunbeiAvailable').textContent = `$${availableUsd.toFixed(0)}`;
      document.getElementById('kunbeiUsed').textContent = `$${activeLoanUsd.toFixed(0)}`;
      document.getElementById('kunbeiCredit').textContent = `$${maxLoanUsd.toFixed(0)}`;
      document.getElementById('kunbeiUsageBar').style.width = `${usagePercent}%`;
      document.getElementById('kunbeiUsagePercent').textContent = `${usagePercent}%`;
      document.getElementById('kunbeiCreditScore').textContent = kunbeiData.stats?.credit_score || 100;
      
      const borrowBtn = document.getElementById('kunbeiConfirmBorrowBtn');
      if (borrowBtn) {
        borrowBtn.disabled = !kunbeiData.can_borrow;
        borrowBtn.title = kunbeiData.can_borrow ? 'ç‚¹å‡»å€Ÿæ¬¾' : (kunbeiData.ban_reason || 'æ— æ³•å€Ÿæ¬¾');
      }
      
      const slider = document.getElementById('kunbeiAmountSlider');
      if (slider && kunbeiConfig) {
        slider.min = kunbeiConfig.min_loan_amount / 500000;
        slider.max = maxLoanUsd;
      }
      
      updateKunbeiPreview();
      
      // æ›´æ–°æ‚¬æµ®æŒ‰é’®çš„title
      const kunbeiFloatingButton = document.getElementById('kunbeiFloatingButton');
      if (kunbeiFloatingButton) {
        if (kunbeiData.has_active_loan) {
          kunbeiFloatingButton.title = "ç‚¹å‡»è¿˜æ¬¾";
        } else {
          kunbeiFloatingButton.title = "æ€¥ç”¨é’±ï¼Ÿå¤å‘—æ‡‚ä½ ã€‚";
        }
      }
    }
    
    // è®¾ç½®å€Ÿæ¬¾é‡‘é¢
    function setKunbeiAmount(amount) {
      if (!kunbeiConfig) return;
      if (amount === 'max') {
        kunbeiCurrentAmount = kunbeiData.max_loan_amount || kunbeiConfig.max_loan_amount;
      } else {
        kunbeiCurrentAmount = amount;
      }
      document.getElementById('kunbeiAmountSlider').value = kunbeiCurrentAmount / 500000;
      updateKunbeiPreview();
    }
    
    // è°ƒæ•´é‡‘é¢
    function adjustKunbeiAmount(delta) {
      if (!kunbeiConfig) return;
      const deltaInSats = delta * 1000;
      const maxLoan = kunbeiData.max_loan_amount || kunbeiConfig.max_loan_amount;
      kunbeiCurrentAmount = Math.max(
        kunbeiConfig.min_loan_amount,
        Math.min(maxLoan, kunbeiCurrentAmount + deltaInSats)
      );
      document.getElementById('kunbeiAmountSlider').value = kunbeiCurrentAmount / 500000;
      updateKunbeiPreview();
    }
    
    // æ›´æ–°æ»‘å—
    function updateKunbeiSlider(value) {
      kunbeiCurrentAmount = parseInt(value) * 500000;
      updateKunbeiPreview();
    }
    
    // æ›´æ–°é¢„è§ˆ
    function updateKunbeiPreview() {
      if (!kunbeiConfig) return;
      
      const loanUsd = kunbeiCurrentAmount / 500000;
      const repayUsd = loanUsd * kunbeiConfig.repay_multiplier;
      const cashbackUsd = repayUsd * kunbeiConfig.early_repay_discount;
      
      document.getElementById('kunbeiSliderValue').textContent = `$${loanUsd.toFixed(0)}`;
      document.getElementById('kunbeiPreviewRepay').textContent = `$${repayUsd.toFixed(2)}`;
      document.getElementById('kunbeiPreviewCashback').textContent = `$${cashbackUsd.toFixed(2)}`;
      
      const dueDate = new Date(Date.now() + kunbeiConfig.loan_duration_hours * 3600000);
      document.getElementById('kunbeiPreviewDue').textContent = 
        dueDate.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }
    
    // ç¡®è®¤å€Ÿæ¬¾
    async function confirmKunbeiBorrow() {
      if (!kunbeiData.can_borrow) {
        showToast(kunbeiData.ban_reason || 'æ— æ³•å€Ÿæ¬¾', 'error');
        return;
      }
      
      const loanUsd = kunbeiCurrentAmount / 500000;
      const repayUsd = loanUsd * kunbeiConfig.repay_multiplier;
      
      const confirmed = await kunbeiConfirm('ç¡®è®¤å€Ÿæ¬¾', {
        'å€Ÿæ¬¾é‡‘é¢': { text: `$${loanUsd.toFixed(2)}`, class: 'text-green-600' },
        'éœ€è¿˜é‡‘é¢': { text: `$${repayUsd.toFixed(2)}`, class: 'text-red-600' },
        'å€Ÿæ¬¾æœŸé™': { text: `${kunbeiConfig.loan_duration_hours}å°æ—¶` },
        'æå‰è¿˜æ¬¾ä¼˜æƒ ': { text: `${(kunbeiConfig.early_repay_discount * 100).toFixed(0)}%`, class: 'text-blue-600' }
      });
      
      if (!confirmed) {
        return;
      }
      
      try {
        const res = await fetch('/api/kunbei/borrow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: kunbeiCurrentAmount })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          
          // ğŸ”¥ å¦‚æœæ˜¯é¦–æ¬¡å€Ÿæ¬¾ï¼Œé¢å¤–æç¤ºbuff
          if (data.is_first_today) {
            setTimeout(() => {
              showToast('ä¸‹æ¬¡æŠ½å¥–å€ç‡ Ã—2.5 ğŸ°', 'success');
            }, 1500);
          }
          
          closeKunbeiModal();
          loadQuota();
          
          // ğŸ”¥ æ›´æ–°è€è™æœºé¡µé¢çš„é¢åº¦æ˜¾ç¤º
          if (currentMode === 'entertain' && slotUserData) {
            // å¢åŠ é¢åº¦
            slotUserData.quota = (slotUserData.quota || 0) + kunbeiCurrentAmount;
            // ç«‹å³æ›´æ–°UIæ˜¾ç¤º
            const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
            const slotQuotaEl = document.getElementById('slotQuota');
            const slotQuotaMobileEl = document.getElementById('slotQuotaMobile');
            if (slotQuotaEl) slotQuotaEl.textContent = quotaText;
            if (slotQuotaMobileEl) slotQuotaMobileEl.textContent = quotaText;
            
            // ğŸ”¥ å¦‚æœæ˜¯é¦–æ¬¡å€Ÿæ¬¾ï¼Œæ˜¾ç¤ºbuffæç¤º
            if (data.is_first_today) {
              setTimeout(() => {
                checkAndShowKunbeiBuff();
              }, 500);
            }
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('å€Ÿæ¬¾å¤±è´¥:', error);
        showToast('å€Ÿæ¬¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // æ›´æ–°è¿˜æ¬¾é¢æ¿
    function updateRepayPanel() {
      if (!kunbeiData) return;
      
      if (kunbeiData.has_active_loan && kunbeiData.active_loan) {
        const loan = kunbeiData.active_loan;
        const now = Date.now();
        const remaining = loan.due_at - now;
        
        document.getElementById('kunbeiHasLoan').classList.remove('hidden');
        document.getElementById('kunbeiNoLoan').classList.add('hidden');
        
        document.getElementById('activeLoanAmount').textContent = `$${(loan.loan_amount / 500000).toFixed(2)}`;
        document.getElementById('activeRepayAmount').textContent = `$${(loan.repay_amount / 500000).toFixed(2)}`;
        
        // å¤„ç†é€¾æœŸæ—¶é—´æ˜¾ç¤º
        if (remaining < 0) {
          // å·²é€¾æœŸï¼Œæ˜¾ç¤ºé€¾æœŸæ—¶é—´
          const overdueTime = Math.abs(remaining);
          const hours = Math.floor(overdueTime / 3600000);
          const minutes = Math.floor((overdueTime % 3600000) / 60000);
          const seconds = Math.floor((overdueTime % 60000) / 1000);
          document.getElementById('activeRemaining').textContent = 
            `å·²é€¾æœŸ ${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’`;
          document.getElementById('activeRemaining').classList.add('text-red-600', 'font-bold');
        } else {
          // æœªé€¾æœŸï¼Œæ­£å¸¸æ˜¾ç¤ºå‰©ä½™æ—¶é—´
          const hours = Math.floor(remaining / 3600000);
          const minutes = Math.floor((remaining % 3600000) / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          document.getElementById('activeRemaining').textContent = 
            `${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’`;
          document.getElementById('activeRemaining').classList.remove('text-red-600', 'font-bold');
        }
        
        if (now < loan.due_at) {
          const cashback = loan.repay_amount * kunbeiConfig.early_repay_discount;
          const earlyAmount = loan.repay_amount - cashback;
          document.getElementById('kunbeiEarlyRepayInfo').classList.remove('hidden');
          document.getElementById('activeEarlyRepay').textContent = `$${(earlyAmount / 500000).toFixed(2)}`;
        } else {
          document.getElementById('kunbeiEarlyRepayInfo').classList.add('hidden');
        }
      } else {
        document.getElementById('kunbeiHasLoan').classList.add('hidden');
        document.getElementById('kunbeiNoLoan').classList.remove('hidden');
      }
    }
    
    // ç¡®è®¤è¿˜æ¬¾
    async function confirmKunbeiRepay() {
      if (!kunbeiData.active_loan) {
        showToast('æ²¡æœ‰éœ€è¦è¿˜æ¬¾çš„å€Ÿæ¬¾', 'error');
        return;
      }
      
      const loan = kunbeiData.active_loan;
      const loanUsd = loan.loan_amount / 500000;
      const repayUsd = loan.repay_amount / 500000;
      const now = Date.now();
      const isEarly = now < loan.due_at;
      
      let confirmContent = {
        'å€Ÿæ¬¾é‡‘é¢': { text: `$${loanUsd.toFixed(2)}` },
        'åº”è¿˜é‡‘é¢': { text: `$${repayUsd.toFixed(2)}`, class: 'text-orange-600' }
      };
      
      if (isEarly) {
        const cashback = loan.repay_amount * kunbeiConfig.early_repay_discount;
        const actualRepay = (loan.repay_amount - cashback) / 500000;
        confirmContent['æå‰è¿˜æ¬¾'] = { text: `$${actualRepay.toFixed(2)}`, class: 'text-green-600' };
        confirmContent['è¿”ç°é‡‘é¢'] = { text: `$${(cashback / 500000).toFixed(2)}`, class: 'text-blue-600' };
      }
      
      const confirmed = await kunbeiConfirm('ç¡®è®¤è¿˜æ¬¾', confirmContent);
      
      if (!confirmed) {
        return;
      }
      
      try {
        const res = await fetch(`/api/kunbei/repay/${loan.id}`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message, 'success');
          closeKunbeiModal();
          loadQuota();
          
          // ğŸ”¥ æ›´æ–°è€è™æœºé¡µé¢çš„é¢åº¦æ˜¾ç¤º
          if (currentMode === 'entertain' && slotUserData && data.data) {
            // æ‰£é™¤å®é™…è¿˜æ¬¾é‡‘é¢
            const actualRepayAmount = data.data.actual_amount || loan.repay_amount;
            slotUserData.quota = Math.max(0, (slotUserData.quota || 0) - actualRepayAmount);
            // ç«‹å³æ›´æ–°UIæ˜¾ç¤º
            const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
            const slotQuotaEl = document.getElementById('slotQuota');
            const slotQuotaMobileEl = document.getElementById('slotQuotaMobile');
            if (slotQuotaEl) slotQuotaEl.textContent = quotaText;
            if (slotQuotaMobileEl) slotQuotaMobileEl.textContent = quotaText;
          }
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        console.error('è¿˜æ¬¾å¤±è´¥:', error);
        showToast('è¿˜æ¬¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åŠ è½½å€Ÿæ¬¾è®°å½•
    async function loadKunbeiRecords() {
      try {
        const res = await fetch('/api/kunbei/my-loans');
        const data = await res.json();
        
        if (data.success) {
          renderKunbeiRecords(data.data.loans);
        }
      } catch (error) {
        console.error('åŠ è½½å€Ÿæ¬¾è®°å½•å¤±è´¥:', error);
      }
    }
    
    // æ¸²æŸ“å€Ÿæ¬¾è®°å½•
    function renderKunbeiRecords(loans) {
      const container = document.getElementById('kunbeiRecordsList');
      
      if (loans.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-slate-500"><div class="text-4xl mb-2">ğŸ“</div><p>æš‚æ— å€Ÿæ¬¾è®°å½•</p></div>';
        return;
      }
      
      // æ ¹æ®çŠ¶æ€å’Œå®é™…è¿˜æ¬¾é‡‘é¢åˆ¤æ–­æ˜¾ç¤ºçš„æ ‡ç­¾
      const getStatusLabel = (loan) => {
        if (loan.status === 'repaid' && loan.actual_repay_amount === 0) {
          return '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">ç³»ç»Ÿè±å…</span>';
        }
        const labels = {
          'active': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">è¿›è¡Œä¸­</span>',
          'repaid': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">å·²è¿˜æ¬¾</span>',
          'overdue': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">å·²é€¾æœŸ</span>'
        };
        return labels[loan.status] || '';
      };
      
      container.innerHTML = loans.map(loan => {
        const borrowTime = new Date(loan.borrowed_at).toLocaleString('zh-CN', { hour12: false });
        const dueTime = new Date(loan.due_at).toLocaleString('zh-CN', { hour12: false });
        const repaidTime = loan.repaid_at ? new Date(loan.repaid_at).toLocaleString('zh-CN', { hour12: false }) : null;

        return `
          <div class="border border-slate-200 rounded-lg p-3 mb-2">
            <div class="flex justify-between items-start mb-2">
              <div class="text-sm">
                <div class="font-semibold text-slate-900">
                  å€Ÿ $${loan.loan_amount_usd} â†’ è¿˜ $${loan.repay_amount_usd}
                </div>
                <div class="text-xs text-slate-500 mt-1">
                  å€Ÿæ¬¾: ${borrowTime}<br>åˆ°æœŸ: ${dueTime}${repaidTime ? `<br>è¿˜æ¬¾: ${repaidTime}` : ''}
                </div>
              </div>
              <div>${getStatusLabel(loan)}</div>
            </div>
            ${loan.status === 'repaid' && loan.actual_repay_amount !== null ? (
              loan.actual_repay_amount === 0 ? 
              '<div class="text-xs text-purple-600">ç®¡ç†å‘˜å·²è±å…æ­¤å€Ÿæ¬¾</div>' :
              `<div class="text-xs text-green-600">
                å®è¿˜: $${loan.actual_repay_amount_usd}
                ${loan.actual_repay_amount < loan.repay_amount ? 
                  `Â· è¿”ç° $${((loan.repay_amount - loan.actual_repay_amount) / 500000).toFixed(2)}` : ''
                }
              </div>`
            ) : ''}
            ${loan.status === 'overdue' && loan.auto_deducted_amount !== null && loan.auto_deducted_amount !== undefined ? 
              (() => {
                const deductedAmount = loan.auto_deducted_amount || 0;
                const balanceAfter = loan.balance_after_deduct || 0;
                // ğŸ”¥ ä»é…ç½®è·å–é€¾æœŸæ‰£æ¬¾å€æ•°ï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰
                const multiplier = kunbeiConfig?.overdue_deduct_multiplier || 2.5;
                
                return `<div class="text-xs text-red-600 mt-1">
                  ç³»ç»Ÿæ‰£é™¤: $${(deductedAmount / 500000).toFixed(2)}ï¼ˆæ¬ æ¬¾Ã—${multiplier}ï¼‰Â· ä½™é¢: $${(balanceAfter / 500000).toFixed(2)}
                </div>`;
              })() : 
              ''
            }
          </div>
        `;
      }).join('');
    }
    
    // æ˜¾ç¤ºè§„åˆ™
    function showKunbeiRules() {
      if (!kunbeiConfig) return;
      
      // æ›´æ–°è§„åˆ™å†…å®¹
      const maxLoanUsd = kunbeiData.max_loan_amount ? kunbeiData.max_loan_amount / 500000 : kunbeiConfig.max_loan_amount / 500000;
      document.getElementById('rulesUserMaxLoan').textContent = `$${maxLoanUsd.toFixed(0)}`;
      document.getElementById('rulesRepayMultiplier').textContent = `${kunbeiConfig.repay_multiplier}å€`;
      document.getElementById('rulesLoanDuration').textContent = `${kunbeiConfig.loan_duration_hours}å°æ—¶`;
      document.getElementById('rulesEarlyDiscount').textContent = `${(kunbeiConfig.early_repay_discount * 100).toFixed(1)}%`;
      document.getElementById('rulesPenaltyHours').textContent = `${kunbeiConfig.overdue_penalty_hours}å°æ—¶`;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('kunbeiRulesModal').classList.remove('hidden');
    }

    // ========== æˆå°±ç³»ç»Ÿç›¸å…³åŠŸèƒ½ ==========

    // âœ… ç»Ÿä¸€ä½¿ç”¨ window.achievementsDataï¼Œé¿å…å…¨å±€å˜é‡å†²çª
    let currentFilter = 'all';

    // âœ… HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    // âœ… æ•°å­—åŠ¨ç”»è®¡æ•°æ•ˆæœ
    function animateNumber(element, target, duration = 1000) {
      if (!element) return;
      
      const start = parseInt(element.textContent) || 0;
      const startTime = Date.now();
      
      const updateNumber = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
        const easeOutQuad = progress => 1 - (1 - progress) * (1 - progress);
        const current = Math.floor(start + (target - start) * easeOutQuad(progress));
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(updateNumber);
        } else {
          element.textContent = target;
        }
      };
      
      requestAnimationFrame(updateNumber);
    }
    
    // âœ… ç™¾åˆ†æ¯”åŠ¨ç”»æ•ˆæœ
    function animatePercentage(element, target, duration = 1000) {
      if (!element) return;
      
      const startValue = parseFloat(element.textContent) || 0;
      const startTime = Date.now();
      
      const updatePercentage = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOutQuad = progress => 1 - (1 - progress) * (1 - progress);
        const current = startValue + (target - startValue) * easeOutQuad(progress);
        
        element.textContent = current.toFixed(1) + '%';
        
        if (progress < 1) {
          requestAnimationFrame(updatePercentage);
        } else {
          element.textContent = target.toFixed(1) + '%';
        }
      };
      
      requestAnimationFrame(updatePercentage);
    }
    
    // âœ… æ˜¾ç¤ºæˆå°±è§£é”é€šçŸ¥
    function showAchievementUnlockNotification(achievement) {
      if (!achievement) return;
      
      const notification = document.getElementById('achievementUnlockNotification');
      if (!notification) return;
      
      // æ›´æ–°é€šçŸ¥å†…å®¹
      const iconEl = document.getElementById('unlockIcon');
      const nameEl = document.getElementById('unlockName');
      const descEl = document.getElementById('unlockDesc');
      const rarityEl = document.getElementById('unlockRarity');
      const rewardEl = document.getElementById('unlockReward');
      
      if (iconEl) iconEl.textContent = achievement.icon || 'ğŸ†';
      if (nameEl) nameEl.textContent = achievement.achievement_name || '';
      if (descEl) descEl.textContent = achievement.achievement_desc || '';
      if (rarityEl) rarityEl.textContent = `${getRarityIcon(achievement.rarity)} ${getRarityName(achievement.rarity)}`;
      if (rewardEl) rewardEl.textContent = `ğŸ’° +${formatAchievementQuota(achievement.reward_quota || 0)}`;
      
      // æ˜¾ç¤ºé€šçŸ¥
      notification.classList.remove('hidden');
      notification.style.animation = 'achievementUnlock 0.6s ease-out';
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease-in forwards';
        setTimeout(() => {
          notification.classList.add('hidden');
          notification.style.animation = '';
        }, 300);
      }, 3000);
    }
    
    // âœ… æ»šåŠ¨åˆ°é¡¶éƒ¨
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    
    // âœ… ç›‘å¬æ»šåŠ¨ï¼Œæ˜¾ç¤º/éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const backToTopBtn = document.getElementById('backToTopBtn');
        if (backToTopBtn) {
          // åªåœ¨æˆå°±é¡µé¢æ˜¾ç¤ºè¿”å›é¡¶éƒ¨æŒ‰é’®
          const achievementSection = document.getElementById('achievementSection');
          if (achievementSection && !achievementSection.classList.contains('hidden')) {
            if (window.scrollY > 300) {
              backToTopBtn.classList.remove('hidden');
            } else {
              backToTopBtn.classList.add('hidden');
            }
          } else {
            backToTopBtn.classList.add('hidden');
          }
        }
      }, 100);
    });

    // åŠ è½½æˆå°±æ•°æ®
    async function loadAchievements() {
      // âœ… æ˜¾ç¤ºåŠ è½½çŠ¶æ€ - ä¼˜åŒ–æ ·å¼
      const container = document.getElementById('achievementsList');
      if (container) {
        container.innerHTML = `
          <div class="col-span-full">
            <div class="bg-white rounded-2xl shadow-lg p-16 text-center">
              <div class="spinner mx-auto mb-6"></div>
              <p class="text-slate-600 text-xl font-semibold mb-2">æ­£åœ¨åŠ è½½æˆå°±...</p>
              <p class="text-slate-400 text-sm">è¯·ç¨å€™ï¼Œç²¾å½©å³å°†å‘ˆç°</p>
            </div>
          </div>
        `;
      }
      
      try {
        // âœ… ä½¿ç”¨æ–°çš„ /all ç«¯ç‚¹ï¼ŒåŒæ—¶è·å–æˆå°±æ•°æ®å’Œè¾¾æˆç‡ç»Ÿè®¡
        const [achievementsRes, statsRes] = await Promise.all([
          fetch('/api/achievement/all'),
          fetch('/api/achievement/stats')
        ]);

        // âœ… åŠ è½½æˆå°±åˆ—è¡¨ï¼ˆåŒ…å«è¾¾æˆç‡ï¼‰
        if (achievementsRes.ok) {
          const achievementsResult = await achievementsRes.json();
          if (achievementsResult.success) {
            // âœ… ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„
            window.achievementsData = Array.isArray(achievementsResult.data) 
              ? achievementsResult.data 
              : [];
            renderAchievements(window.achievementsData);
            
            // âœ… æ›´æ–°ç­›é€‰è®¡æ•°
            const filterCountEl = document.getElementById('filterCount');
            if (filterCountEl) {
              filterCountEl.textContent = `å…± ${window.achievementsData.length} ä¸ªæˆå°±`;
            }
          } else {
            console.error('è·å–æˆå°±åˆ—è¡¨å¤±è´¥:', achievementsResult.message);
            window.achievementsData = [];
            renderAchievements([]);
          }
        } else {
          console.error('æˆå°±APIå“åº”é”™è¯¯:', achievementsRes.status);
          window.achievementsData = [];
          renderAchievements([]);
        }

        // âœ… åŠ è½½æˆå°±ç»Ÿè®¡
        if (statsRes.ok) {
          const statsData = await statsRes.json();
          if (statsData.success && statsData.data) {
            updateAchievementStats(statsData.data);
          } else {
            console.error('è·å–æˆå°±ç»Ÿè®¡å¤±è´¥:', statsData.message);
          }
        } else {
          console.error('ç»Ÿè®¡APIå“åº”é”™è¯¯:', statsRes.status);
        }
      } catch (error) {
        console.error('åŠ è½½æˆå°±å¤±è´¥:', error);
        showToast('åŠ è½½æˆå°±å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        
        // âœ… å‡ºé”™æ—¶åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼Œé¿å…åç»­å´©æºƒ
        window.achievementsData = [];
        renderAchievements([]);
      }
    }

    // æ›´æ–°æˆå°±ç»Ÿè®¡
    function updateAchievementStats(stats) {
      if (!stats) {
        console.warn('[æˆå°±ç»Ÿè®¡] ç»Ÿè®¡æ•°æ®ä¸ºç©º');
        return;
      }

      // âœ… å®‰å…¨æ›´æ–°DOMï¼Œæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      const totalEl = document.getElementById('totalAchievements');
      const unlockedEl = document.getElementById('unlockedAchievements');
      const totalRewardsEl = document.getElementById('totalRewards');
      const claimedRewardsEl = document.getElementById('claimedRewards');
      const completionEl = document.getElementById('achievementCompletion');
      
      // âœ… ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ›´æ–°æ•°å­—ï¼ˆæ›´æœ‰è§†è§‰å†²å‡»åŠ›ï¼‰
      if (totalEl) {
        animateNumber(totalEl, stats.total_achievements || 0, 800);
      }
      if (unlockedEl) {
        animateNumber(unlockedEl, stats.unlocked_achievements || 0, 800);
      }
      
      // å¥–åŠ±æ•°å­—ç›´æ¥æ˜¾ç¤ºï¼ˆå› ä¸ºæ˜¯æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼‰
      if (totalRewardsEl) {
        totalRewardsEl.textContent = formatAchievementQuota(stats.total_rewards || 0);
      }
      if (claimedRewardsEl) {
        claimedRewardsEl.textContent = formatAchievementQuota(stats.claimed_rewards || 0);
      }
      
      // âœ… å®Œæˆåº¦ä½¿ç”¨ç™¾åˆ†æ¯”åŠ¨ç”»
      if (completionEl) {
        const completionRate = Math.min(100, Math.max(0, stats.completion_rate || 0));
        animatePercentage(completionEl, completionRate, 1000);
      }

      // æ›´æ–°ä¸€é”®é¢†å–æŒ‰é’®çŠ¶æ€
      const unclaimedRewards = (stats.total_rewards || 0) - (stats.claimed_rewards || 0);
      const claimAllBtn = document.getElementById('claimAllRewardsBtn');
      
      if (claimAllBtn) {
        const btnText = claimAllBtn.querySelector('span:last-child');
        
        if (unclaimedRewards > 0) {
          claimAllBtn.disabled = false;
          if (btnText) {
            btnText.textContent = `ä¸€é”®é¢†å–æ‰€æœ‰å¥–åŠ± (${formatAchievementQuota(unclaimedRewards)})`;
          }
        } else {
          claimAllBtn.disabled = true;
          if (btnText) {
            btnText.textContent = 'æš‚æ— å¯é¢†å–å¥–åŠ±';
          }
        }
      }
    }

    // æ¸²æŸ“æˆå°±åˆ—è¡¨
    function renderAchievements(achievements) {
      const container = document.getElementById('achievementsList');
      if (!container) {
        console.error('[renderAchievements] achievementsList å®¹å™¨ä¸å­˜åœ¨');
        return;
      }

      // âœ… ç¡®ä¿ achievements æ˜¯æ•°ç»„
      if (!Array.isArray(achievements)) {
        console.error('[renderAchievements] achievements ä¸æ˜¯æ•°ç»„:', achievements);
        achievements = [];
      }

      // ç­›é€‰æˆå°±
      let filteredAchievements = currentFilter === 'all'
        ? achievements
        : achievements.filter(a => a && a.category === currentFilter);
      
      // âœ… æ’åºï¼šå·²è§£é”æœªé¢†å– > æœªè§£é”ï¼ˆæŒ‰è¿›åº¦ï¼‰ > å·²é¢†å–
      filteredAchievements.sort((a, b) => {
        // å·²è§£é”æœªé¢†å–çš„æ’æœ€å‰
        if (a.unlocked && !a.reward_claimed && !(b.unlocked && !b.reward_claimed)) return -1;
        if (b.unlocked && !b.reward_claimed && !(a.unlocked && !a.reward_claimed)) return 1;
        
        // æœªè§£é”çš„æŒ‰è¿›åº¦æ’åº
        if (!a.unlocked && !b.unlocked) {
          const aProgress = a.progress?.percentage || 0;
          const bProgress = b.progress?.percentage || 0;
          return bProgress - aProgress;  // è¿›åº¦é«˜çš„æ’å‰é¢
        }
        
        // å…¶ä»–æƒ…å†µä¿æŒåŸé¡ºåº
        return 0;
      });

      if (filteredAchievements.length === 0) {
        const filterText = currentFilter === 'all' ? 'æš‚æ— æˆå°±' : `æš‚æ— "${getCategoryName(currentFilter)}"åˆ†ç±»çš„æˆå°±`;
        container.innerHTML = `
          <div class="col-span-full">
            <div class="bg-white rounded-2xl shadow-lg p-12 text-center border-2 border-dashed border-slate-200">
              <div class="text-8xl mb-6 opacity-50">ğŸ†</div>
              <p class="text-slate-600 text-xl font-bold mb-2">${filterText}</p>
              ${currentFilter !== 'all' ? `
                <p class="text-slate-400 text-sm mb-6">è¯•è¯•åˆ‡æ¢å…¶ä»–åˆ†ç±»ï¼Œæˆ–è€…å¤šç©å‡ å±€æ¸¸æˆè§£é”æ›´å¤šæˆå°±</p>
                <button onclick="filterAchievements('all', event)" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all">
                  æŸ¥çœ‹æ‰€æœ‰æˆå°±
                </button>
              ` : `
                <p class="text-slate-400 text-sm mb-6">å¼€å§‹ä½ çš„å†’é™©ä¹‹æ—…ï¼Œè§£é”ç¬¬ä¸€ä¸ªæˆå°±ï¼</p>
                <div class="flex gap-3 justify-center">
                  <button onclick="switchToRefuel()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all">
                    å»åŠ æ²¹ç«™
                  </button>
                  <button onclick="switchToEntertain()" class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all">
                    å»å¨±ä¹ç«™
                  </button>
                </div>
              `}
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredAchievements.map(achievement => {
        // âœ… éªŒè¯æˆå°±æ•°æ®å®Œæ•´æ€§
        if (!achievement || !achievement.achievement_key) {
          console.warn('[renderAchievements] æ— æ•ˆçš„æˆå°±æ•°æ®:', achievement);
          return '';
        }
        
        const isUnlocked = achievement.unlocked;
        const isClaimed = achievement.reward_claimed;
        const progress = achievement.progress;

        // âœ… éªŒè¯ç¨€æœ‰åº¦ï¼Œé˜²æ­¢CSSç±»åé”™è¯¯
        const validRarities = ['common', 'rare', 'epic', 'legendary', 'mythic'];
        const rarityClass = validRarities.includes(achievement.rarity) 
          ? `rarity-${achievement.rarity}` 
          : 'rarity-common';

        let progressHTML = '';
        if (!isUnlocked && progress) {
          // âœ… å®‰å…¨è·å–å€¼å¹¶é™åˆ¶èŒƒå›´
          const current = progress.current || 0;
          const target = progress.target || 1;
          const percentage = Math.min(100, Math.max(0, progress.percentage || 0));
          
          progressHTML = `
            <div class="mt-3 bg-slate-50 rounded-lg p-2.5 border border-slate-200">
              <div class="flex justify-between items-center text-xs mb-1.5">
                <span class="text-slate-600 font-medium flex items-center gap-1">
                  <span>ğŸ“Š</span>
                  <span>è¿›åº¦</span>
                </span>
                <span class="font-bold ${percentage >= 100 ? 'text-green-600' : 'text-amber-600'}">
                  ${current}/${target} (${percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden shadow-inner">
                <div class="achievement-progress-bar h-full rounded-full" style="width: ${percentage}%"></div>
              </div>
              ${percentage >= 80 && percentage < 100 ? '<p class="text-xs text-amber-600 mt-1.5 font-medium">ğŸ”¥ å³å°†å®Œæˆï¼</p>' : ''}
            </div>
          `;
        }

        let actionButton = '';
        if (isUnlocked && !isClaimed) {
          actionButton = `
            <button onclick="claimAchievementReward('${escapeHtml(achievement.achievement_key)}')"
                    class="w-full bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-600 hover:from-amber-600 hover:via-yellow-600 hover:to-amber-700 
                           text-white py-2 rounded-lg font-bold text-xs shadow-lg hover:shadow-xl 
                           transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200
                           flex items-center justify-center gap-1.5">
              <span class="text-sm">ğŸ’</span>
              <span>é¢†å–å¥–åŠ±</span>
              <span class="font-bold text-yellow-200">+${formatAchievementQuota(achievement.reward_quota)}</span>
            </button>
          `;
        } else if (isClaimed) {
          actionButton = `
            <div class="w-full bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 py-2 rounded-lg font-bold text-xs text-center border-2 border-green-300 flex items-center justify-center gap-1.5">
              <span class="text-sm">âœ…</span>
              <span>å·²é¢†å–å¥–åŠ±</span>
            </div>
          `;
        }

        return `
          <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'} ${rarityClass}">
            <!-- å¡ç‰‡å¤´éƒ¨ -->
            <div class="p-4 pb-3">
              <div class="flex items-start gap-3">
                <!-- æˆå°±å›¾æ ‡ -->
                <div class="achievement-icon text-3xl flex-shrink-0 ${isUnlocked ? 'animate-bounce' : ''}" style="animation-duration: 2s;">
                  ${escapeHtml(achievement.icon)}
                </div>
                
                <!-- æˆå°±ä¿¡æ¯ -->
                <div class="flex-1 min-w-0">
                  <!-- æ ‡é¢˜è¡Œ -->
                  <div class="flex items-start justify-between gap-2 mb-1.5">
                    <h3 class="text-base font-bold text-slate-900 leading-tight">
                      ${escapeHtml(achievement.achievement_name)}
                    </h3>
                    ${isUnlocked ? '<div class="flex-shrink-0"><span class="text-xl drop-shadow-lg">ğŸ†</span></div>' : ''}
                  </div>
                  
                  <!-- æè¿° -->
                  <p class="text-xs text-slate-600 mb-2 line-clamp-2">
                    ${escapeHtml(achievement.achievement_desc)}
                  </p>
                  
                  <!-- æ ‡ç­¾ç»„ -->
                  <div class="flex items-center gap-1.5 flex-wrap mb-2.5">
                    <!-- åˆ†ç±»æ ‡ç­¾ -->
                    <span class="inline-flex items-center gap-0.5 px-2 py-0.5 bg-slate-100 text-slate-700 rounded-full text-xs font-medium border border-slate-200">
                      ${getCategoryName(achievement.category)}
                    </span>
                    
                    <!-- ç¨€æœ‰åº¦æ ‡ç­¾ - å¸¦é¢œè‰² -->
                    <span class="inline-flex items-center gap-0.5 px-2 py-0.5 ${getRarityBadgeClass(achievement.rarity)} rounded-full text-xs font-bold shadow-sm">
                      ${getRarityIcon(achievement.rarity)} ${getRarityName(achievement.rarity)}
                    </span>
                    
                    <!-- å¥–åŠ±é‡‘é¢ - çªå‡ºæ˜¾ç¤º -->
                    <span class="inline-flex items-center gap-0.5 px-2 py-0.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full text-xs font-bold shadow-md">
                      <span>ğŸ’°</span>
                      <span>+${formatAchievementQuota(achievement.reward_quota)}</span>
                    </span>
                    
                    <!-- è¾¾æˆç‡ - æ˜¾ç¤ºç™¾åˆ†ä¹‹å¤šå°‘çš„ç©å®¶è¾¾æˆ -->
                    ${achievement.unlock_rate !== undefined ? `
                      <span class="inline-flex items-center gap-0.5 px-2 py-0.5 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-full text-xs font-medium border border-blue-200 shadow-sm" title="${achievement.unlock_count || 0} äººè¾¾æˆ">
                        <span>ğŸ“Š</span>
                        <span>${achievement.unlock_rate.toFixed(1)}%</span>
                      </span>
                    ` : ''}
                  </div>
                  
                  ${progressHTML}
                </div>
              </div>
            </div>
            
            <!-- å¡ç‰‡åº•éƒ¨ - æ“ä½œæŒ‰é’® -->
            ${actionButton ? `<div class="px-4 pb-3">${actionButton}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // åˆ‡æ¢æˆå°±è§†å›¾
    function switchAchievementView(view) {
      const achievementsList = document.getElementById('achievementsList');
      const achievementLeaderboard = document.getElementById('achievementLeaderboard');
      const achievementFilters = document.getElementById('achievementFilters');
      const viewAchievementsBtn = document.getElementById('viewAchievementsBtn');
      const viewLeaderboardBtn = document.getElementById('viewLeaderboardBtn');

      if (view === 'achievements') {
        // æ˜¾ç¤ºæˆå°±åˆ—è¡¨
        achievementsList.classList.remove('hidden');
        achievementFilters.classList.remove('hidden');
        achievementLeaderboard.classList.add('hidden');
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        viewAchievementsBtn.className = 'px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-lg font-semibold shadow-md text-sm flex items-center gap-2';
        viewLeaderboardBtn.className = 'px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all';
      } else if (view === 'leaderboard') {
        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        achievementsList.classList.add('hidden');
        achievementFilters.classList.add('hidden');
        achievementLeaderboard.classList.remove('hidden');
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        viewAchievementsBtn.className = 'px-4 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all';
        viewLeaderboardBtn.className = 'px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-lg font-semibold shadow-md text-sm flex items-center gap-2';
        
        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        loadAchievementLeaderboard();
      }
    }

    // åŠ è½½æˆå°±æ’è¡Œæ¦œ
    async function loadAchievementLeaderboard() {
      const container = document.getElementById('achievementLeaderboard');
      if (!container) return;

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      container.innerHTML = `
        <div class="bg-white rounded-2xl shadow-lg p-16 text-center">
          <div class="spinner mx-auto mb-6"></div>
          <p class="text-slate-600 text-xl font-semibold">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...</p>
        </div>
      `;

      try {
        const response = await fetch('/api/achievement/leaderboard?limit=100');
        const result = await response.json();

        if (result.success && result.data) {
          renderAchievementLeaderboard(result.data);
        } else {
          container.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
              <div class="text-6xl mb-4">ğŸ˜•</div>
              <p class="text-slate-600 text-lg font-semibold">åŠ è½½æ’è¡Œæ¦œå¤±è´¥</p>
              <p class="text-slate-400 text-sm mt-2">${result.message || 'æœªçŸ¥é”™è¯¯'}</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
        container.innerHTML = `
          <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
            <div class="text-6xl mb-4">âŒ</div>
            <p class="text-slate-600 text-lg font-semibold">ç½‘ç»œé”™è¯¯</p>
            <p class="text-slate-400 text-sm mt-2">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
            <button onclick="loadAchievementLeaderboard()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `;
      }
    }

    // æ¸²æŸ“æˆå°±æ’è¡Œæ¦œ
    function renderAchievementLeaderboard(leaderboard) {
      const container = document.getElementById('achievementLeaderboard');
      if (!container) return;

      if (leaderboard.length === 0) {
        container.innerHTML = `
          <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
            <div class="text-6xl mb-4">ğŸ†</div>
            <p class="text-slate-600 text-lg font-semibold">æš‚æ— æ’è¡Œæ¦œæ•°æ®</p>
          </div>
        `;
        return;
      }

      // ç”Ÿæˆæ’è¡Œæ¦œHTML
      container.innerHTML = `
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <!-- æ’è¡Œæ¦œæ ‡é¢˜ -->
          <div class="bg-gradient-to-r from-amber-500 to-yellow-500 p-6 text-white">
            <h2 class="text-2xl font-bold flex items-center gap-3">
              <span>ğŸ†</span>
              <span>æˆå°±æ’è¡Œæ¦œ</span>
            </h2>
            <p class="text-yellow-100 text-sm mt-2">æ ¹æ®è§£é”æˆå°±æ•°é‡å’Œç´¯è®¡å¥–åŠ±æ’å</p>
          </div>

          <!-- æ’è¡Œæ¦œè¡¨æ ¼ -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 border-b-2 border-slate-200">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">æ’å</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">ç©å®¶</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">è§£é”æˆå°±</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">å®Œæˆåº¦</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">å·²é¢†å¥–åŠ±</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-600 uppercase tracking-wider">å¾½ç« </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                ${leaderboard.map((player, index) => {
                  const rank = index + 1;
                  const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                  const rankClass = rank <= 3 ? 'text-yellow-600 font-bold' : 'text-slate-600';
                  
                  return `
                    <tr class="hover:bg-slate-50 transition-colors ${rank <= 3 ? 'bg-yellow-50/30' : ''}">
                      <!-- æ’å -->
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                          <span class="text-2xl">${rankIcon}</span>
                          <span class="${rankClass} text-lg font-semibold">${rank}</span>
                        </div>
                      </td>
                      
                      <!-- ç©å®¶ -->
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                          <div class="text-sm font-semibold text-slate-900">${escapeHtml(player.linux_do_username || player.username)}</div>
                          ${player.username !== player.linux_do_username ? `<div class="text-xs text-slate-500">${escapeHtml(player.username)}</div>` : ''}
                        </div>
                      </td>
                      
                      <!-- è§£é”æˆå°± -->
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center gap-1">
                          <span class="text-base">ğŸ†</span>
                          <span class="text-sm font-bold text-slate-900">${player.unlocked_achievements}</span>
                          <span class="text-xs text-slate-400">/ ${player.total_achievements}</span>
                        </div>
                      </td>
                      
                      <!-- å®Œæˆåº¦ -->
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex flex-col items-center gap-1">
                          <span class="text-sm font-semibold ${player.completion_rate >= 80 ? 'text-green-600' : player.completion_rate >= 50 ? 'text-blue-600' : 'text-slate-600'}">
                            ${player.completion_rate.toFixed(1)}%
                          </span>
                          <div class="w-24 bg-slate-200 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-amber-500 to-yellow-500 rounded-full" style="width: ${player.completion_rate}%"></div>
                          </div>
                        </div>
                      </td>
                      
                      <!-- å·²é¢†å¥–åŠ± -->
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center gap-1">
                          <span class="text-base">ğŸ’°</span>
                          <span class="text-sm font-bold text-green-600">${formatAchievementQuota(player.claimed_rewards)}</span>
                        </div>
                      </td>
                      
                      <!-- å¾½ç«  -->
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center gap-1">
                          ${player.badge_slot_1 ? `<span class="text-lg" title="${player.badge_slot_1}">ğŸ…</span>` : ''}
                          ${player.badge_slot_2 ? `<span class="text-lg" title="${player.badge_slot_2}">ğŸ…</span>` : ''}
                          ${player.badge_slot_3 ? `<span class="text-lg" title="${player.badge_slot_3}">ğŸ…</span>` : ''}
                          ${!player.badge_slot_1 && !player.badge_slot_2 && !player.badge_slot_3 ? '<span class="text-slate-300 text-sm">-</span>' : ''}
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ç­›é€‰æˆå°±
    function filterAchievements(category, evt) {  // âœ… æ˜¾å¼ä¼ é€’ event å‚æ•°
      currentFilter = category;

      // æ›´æ–°ç­›é€‰æŒ‰é’®æ ·å¼
      document.querySelectorAll('.achievement-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // âœ… å®‰å…¨æ£€æŸ¥ event å’Œ target
      if (evt && evt.target) {
        evt.target.classList.add('active');
      } else if (evt) {
        // å¦‚æœæ˜¯æŒ‰é’®æœ¬èº«ï¼Œå‘ä¸ŠæŸ¥æ‰¾æŒ‰é’®å…ƒç´ 
        const btn = evt.currentTarget || evt.target?.closest('.achievement-filter-btn');
        if (btn) btn.classList.add('active');
      }

      // âœ… ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„
      const data = Array.isArray(window.achievementsData) ? window.achievementsData : [];
      
      // âœ… æ›´æ–°ç­›é€‰è®¡æ•°
      const filteredCount = category === 'all' 
        ? data.length 
        : data.filter(a => a && a.category === category).length;
      
      const filterCountEl = document.getElementById('filterCount');
      if (filterCountEl) {
        filterCountEl.textContent = category === 'all' 
          ? `å…± ${data.length} ä¸ªæˆå°±` 
          : `æ‰¾åˆ° ${filteredCount} ä¸ª`;
      }
      
      renderAchievements(data);
    }

    // é¢†å–å•ä¸ªæˆå°±å¥–åŠ±
    async function claimAchievementReward(achievementKey) {
      // âœ… é˜²æ­¢é‡å¤ç‚¹å‡»
      const btn = event.target;
      if (btn && btn.disabled) return;
      
      if (btn) {
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="animate-spin inline-block">âš™ï¸</span> é¢†å–ä¸­...';
      }
      
      try {
        const response = await fetch('/api/achievement/claim', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ achievement_key: achievementKey })
        });

        const data = await response.json();

        if (data.success) {
          showToast(`æˆåŠŸé¢†å–å¥–åŠ± +${formatAchievementQuota(data.reward)}`, 'success');
          
          // é‡æ–°åŠ è½½æˆå°±æ•°æ®
          loadAchievements();
          
          // åˆ·æ–°é¢åº¦
          loadQuota();
          
          // âœ… å¦‚æœåœ¨è€è™æœºç•Œé¢ï¼ŒåŒæ­¥æ›´æ–°ä½™é¢
          if (currentMode === 'entertain' && slotUserData && data.reward) {
            slotUserData.quota = (slotUserData.quota || 0) + data.reward;
            updateSlotUI();
            
            // æ›´æ–°è€è™æœºç•Œé¢çš„é¢åº¦æ˜¾ç¤º
            const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
            const slotQuotaEl = document.getElementById('slotQuota');
            const slotQuotaMobileEl = document.getElementById('slotQuotaMobile');
            if (slotQuotaEl) slotQuotaEl.textContent = quotaText;
            if (slotQuotaMobileEl) slotQuotaMobileEl.textContent = quotaText;
          }
        } else {
          showToast(data.message || 'é¢†å–å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('é¢†å–å¥–åŠ±å¤±è´¥:', error);
        showToast('é¢†å–å¥–åŠ±å¤±è´¥', 'error');
      }
    }

    // æ‰¹é‡é¢†å–æ‰€æœ‰å¥–åŠ±
    async function claimAllAchievementRewards() {
      // âœ… é˜²æ­¢é‡å¤ç‚¹å‡»
      const btn = document.getElementById('claimAllRewardsBtn');
      if (!btn || btn.disabled) return;
      
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="animate-spin inline-block">âš™ï¸</span> <span>é¢†å–ä¸­...</span>';
      
      try {
        const response = await fetch('/api/achievement/claim-all', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showToast(`æˆåŠŸé¢†å– ${data.count} ä¸ªå¥–åŠ±ï¼Œå…± +${formatAchievementQuota(data.totalReward)}`, 'success');
          
          // é‡æ–°åŠ è½½æˆå°±æ•°æ®
          loadAchievements();
          
          // åˆ·æ–°é¢åº¦
          loadQuota();
          
          // âœ… å¦‚æœåœ¨è€è™æœºç•Œé¢ï¼ŒåŒæ­¥æ›´æ–°ä½™é¢
          if (currentMode === 'entertain' && slotUserData && data.totalReward) {
            slotUserData.quota = (slotUserData.quota || 0) + data.totalReward;
            updateSlotUI();
            
            // æ›´æ–°è€è™æœºç•Œé¢çš„é¢åº¦æ˜¾ç¤º
            const quotaText = `$${(slotUserData.quota / 500000).toFixed(2)}`;
            const slotQuotaEl = document.getElementById('slotQuota');
            const slotQuotaMobileEl = document.getElementById('slotQuotaMobile');
            if (slotQuotaEl) slotQuotaEl.textContent = quotaText;
            if (slotQuotaMobileEl) slotQuotaMobileEl.textContent = quotaText;
          }
        } else {
          showToast(data.message || 'é¢†å–å¤±è´¥', 'error');
          // âœ… å¤±è´¥æ—¶æ¢å¤æŒ‰é’®
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        }
      } catch (error) {
        console.error('æ‰¹é‡é¢†å–å¤±è´¥:', error);
        showToast('æ‰¹é‡é¢†å–å¤±è´¥', 'error');
        
        // âœ… å‡ºé”™æ—¶æ¢å¤æŒ‰é’®
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
    }

    // è·å–åˆ†ç±»åç§°
    function getCategoryName(category) {
      const names = {
        beginner: 'æ–°æ‰‹',
        gaming: 'æ¸¸æˆ',
        wealth: 'è´¢å¯Œ',
        jackpot: 'ä¸­å¥–',
        explorer: 'æ¢ç´¢',
        social: 'ç¤¾äº¤',
        challenge: 'æŒ‘æˆ˜',
        collection: 'æ”¶è—',
        kunbei: 'å¤å‘—',
        punishment: 'æƒ©ç½š'
      };
      return names[category] || category;
    }

    // è·å–ç¨€æœ‰åº¦åç§°
    function getRarityName(rarity) {
      const names = {
        common: 'æ™®é€š',
        rare: 'ç¨€æœ‰',
        epic: 'å²è¯—',
        legendary: 'ä¼ è¯´',
        mythic: 'ç¥è¯'
      };
      return names[rarity] || rarity;
    }
    
    // è·å–ç¨€æœ‰åº¦å›¾æ ‡
    function getRarityIcon(rarity) {
      const icons = {
        common: 'âšª',
        rare: 'ğŸ”µ',
        epic: 'ğŸŸ£',
        legendary: 'ğŸŸ ',
        mythic: 'ğŸ”´'
      };
      return icons[rarity] || 'âšª';
    }
    
    // è·å–ç¨€æœ‰åº¦å¾½ç« æ ·å¼ç±»
    function getRarityBadgeClass(rarity) {
      const classes = {
        common: 'bg-slate-100 text-slate-700 border border-slate-300',
        rare: 'bg-blue-100 text-blue-700 border border-blue-300',
        epic: 'bg-purple-100 text-purple-700 border border-purple-300',
        legendary: 'bg-orange-100 text-orange-700 border border-orange-300',
        mythic: 'bg-red-100 text-red-700 border border-red-300'
      };
      return classes[rarity] || classes.common;
    }

    // æ ¼å¼åŒ–é¢åº¦æ˜¾ç¤ºï¼ˆæˆå°±ç³»ç»Ÿä¸“ç”¨ - æ˜¾ç¤ºä¸ºç¾å…ƒï¼‰
    // ğŸ“Œ æ³¨æ„ï¼šæ­¤å‡½æ•°æ¥æ”¶çš„æ˜¯åŸå§‹èªå€¼ï¼ˆsatoshisï¼‰ï¼Œè½¬æ¢ä¸ºç¾å…ƒæ˜¾ç¤º
    // ä¾‹å¦‚ï¼š500000èª = $1ï¼Œæ˜¾ç¤ºä¸º "$1"
    // ä¾‹å¦‚ï¼š50000000èª = $100ï¼Œæ˜¾ç¤ºä¸º "$100"
    // ä¾‹å¦‚ï¼š2500000000èª = $5000ï¼Œæ˜¾ç¤ºä¸º "$5.0K"
    function formatAchievementQuota(quota) {
      // è½¬æ¢ä¸ºç¾å…ƒ
      const usd = quota / 500000;
      
      if (usd >= 1000) {
        return '$' + (usd / 1000).toFixed(1) + 'K';  // $5.0K
      } else if (usd >= 1) {
        return '$' + usd.toFixed(0);  // $100
      } else {
        return '$' + usd.toFixed(2);  // $0.50
      }
    }

    // ========== ç»“æŸï¼šæˆå°±ç³»ç»Ÿç›¸å…³åŠŸèƒ½ ==========

    // ========== å…¨å±€æ¸…ç†å‡½æ•° - é˜²æ­¢å†…å­˜æ³„æ¼ ==========
    
    // âœ… é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    window.addEventListener('beforeunload', () => {
      // æ¸…ç†è€è™æœºç›¸å…³å®šæ—¶å™¨
      if (advancedModeTimer) {
        clearInterval(advancedModeTimer);
        advancedModeTimer = null;
      }
      if (supremeModeTimer) {
        clearInterval(supremeModeTimer);
        supremeModeTimer = null;
      }
      
      // æ¸…ç†å¤å‘—å®šæ—¶å™¨
      if (kunbeiUpdateTimer) {
        clearInterval(kunbeiUpdateTimer);
        kunbeiUpdateTimer = null;
      }
      
      console.log('[æ¸…ç†] æ‰€æœ‰å®šæ—¶å™¨å·²æ¸…ç†');
    });

  </script>
</body>
</html>