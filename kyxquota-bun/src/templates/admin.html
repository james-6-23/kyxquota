<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - KYX API Quota Bridge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #6366f1;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Login Section -->
  <div id="loginSection" class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-md w-full">
      <h1 class="text-3xl font-bold text-center text-slate-900 mb-8">ç®¡ç†å‘˜åå°</h1>
      <div id="loginMessage" class="hidden mb-4 p-3 rounded-lg"></div>
      <input type="password" id="password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " class="w-full px-4 py-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
      <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
        ç™»å½•
      </button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminSection" class="hidden min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <h1 class="text-xl font-bold text-slate-900">KYX API ç®¡ç†åå°</h1>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-semibold">ç®¡ç†å‘˜</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="flex">
      <aside class="w-64 bg-white min-h-screen border-r border-slate-200">
        <nav class="p-4">
          <button onclick="showSection('dashboard')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 bg-indigo-100 text-indigo-700 font-semibold flex items-center gap-2">
            <span>ğŸ“Š</span> ä»ªè¡¨æ¿
          </button>
          <button onclick="showSection('config')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>âš™ï¸</span> ç³»ç»Ÿé…ç½®
          </button>
          <button onclick="showSection('keys')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>ğŸ”‘</span> Keys ç®¡ç†
          </button>
          <button onclick="showSection('claims')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>ğŸ“¥</span> é¢†å–è®°å½•
          </button>
          <button onclick="showSection('donates')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>ğŸ</span> æŠ•å–‚è®°å½•
          </button>
          <button onclick="showSection('users')" class="nav-link w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-slate-100 text-slate-700 flex items-center gap-2">
            <span>ğŸ‘¥</span> ç”¨æˆ·åˆ—è¡¨
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6">
        <div id="message" class="hidden mb-4 p-4 rounded-lg"></div>

        <!-- Dashboard -->
        <div id="dashboardSection">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ä»ªè¡¨æ¿</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">ğŸ“¥</div>
                <div>
                  <p class="text-sm text-slate-600">é¢†å–è®°å½•æ€»æ•°</p>
                  <p id="claimCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">ğŸ</div>
                <div>
                  <p class="text-sm text-slate-600">æŠ•å–‚è®°å½•æ€»æ•°</p>
                  <p id="donateCount" class="text-2xl font-bold text-slate-900">0</p>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 card-hover">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">ğŸ’°</div>
                <div>
                  <p class="text-sm text-slate-600">å½“å‰é¢†å–é¢åº¦</p>
                  <p id="currentQuota" class="text-2xl font-bold text-slate-900">--</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Config Section -->
        <div id="configSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ç³»ç»Ÿé…ç½®</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <!-- é¢åº¦è¯´æ˜ -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm text-blue-900">
                  <p class="font-semibold mb-1">ğŸ’° é¢åº¦å•ä½æ¢ç®—</p>
                  <p class="text-blue-800">500,000 quota = <strong>$1 ç¾å…ƒ</strong></p>
                  <p class="text-blue-700 text-xs mt-1">ç¤ºä¾‹ï¼š20,000,000 quota = $40</p>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ¯æ—¥é¢†å–é¢åº¦</label>
              <div class="flex gap-2 items-center">
                <input type="number" id="claimQuota" placeholder="20000000" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <span class="text-sm text-slate-600 whitespace-nowrap">â‰ˆ $<span id="quotaUSD">40.00</span></span>
                <button onclick="updateQuota()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">å½“å‰å•ä½ï¼šquotaï¼ˆ500,000 = $1ï¼‰</p>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">æ¯æ—¥æœ€å¤§é¢†å–æ¬¡æ•°</label>
              <div class="flex gap-2 items-center">
                <input type="number" id="maxDailyClaims" placeholder="1" min="1" max="10" class="w-32 px-4 py-2 border border-slate-300 rounded-lg">
                <span class="text-sm text-slate-600">æ¬¡/å¤©</span>
                <button onclick="updateMaxDailyClaims()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">æ›´æ–°</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">å»ºè®®è®¾ç½®ï¼š1-3æ¬¡ï¼ˆè®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´é¢åº¦æ»¥ç”¨ï¼‰</p>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">API Session</label>
              <div class="flex gap-2">
                <input type="text" id="sessionValue" placeholder="è¾“å…¥æ–°çš„ Session" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateSession()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys API URL</label>
              <div class="flex gap-2">
                <input type="text" id="keysApiUrl" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysApiUrl()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Keys Authorization</label>
              <div class="flex gap-2">
                <input type="text" id="keysAuthorization" placeholder="è¾“å…¥ Authorization Token" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateKeysAuthorization()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">Group ID</label>
              <div class="flex gap-2">
                <input type="number" id="groupId" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg">
                <button onclick="updateGroupId()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ›´æ–°</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Keys Section -->
        <div id="keysSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">Keys ç®¡ç†</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <div class="flex gap-2 mb-4">
              <button onclick="exportKeys()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰</button>
              <button onclick="copyAllKeys()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ğŸ“‹ å¤åˆ¶æ‰€æœ‰</button>
            </div>
            <p class="text-sm text-slate-600">æ€»è®¡: <span id="totalKeysCount">0</span> ä¸ª Key</p>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Key</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æŠ•å–‚ç”¨æˆ·</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æŠ•å–‚æ—¶é—´</th>
                  </tr>
                </thead>
                <tbody id="keysListBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Claims Section -->
        <div id="claimsSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">é¢†å–è®°å½•</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">é¢†å–é¢åº¦</th>
                  </tr>
                </thead>
                <tbody id="claimTableBody"></tbody>
              </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="claimPagination" class="border-t border-slate-200 px-4 py-3 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                å…± <span id="claimTotal">0</span> æ¡è®°å½•ï¼Œç¬¬ <span id="claimCurrentPage">1</span> / <span id="claimTotalPages">1</span> é¡µ
              </div>
              <div class="flex gap-2">
                <button onclick="loadClaimRecords(claimCurrentPage - 1)" id="claimPrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸Šä¸€é¡µ</button>
                <button onclick="loadClaimRecords(claimCurrentPage + 1)" id="claimNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Donates Section -->
        <div id="donatesSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">æŠ•å–‚è®°å½•</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">æ—¶é—´</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">Key æ•°é‡</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">å¢åŠ é¢åº¦</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æ¨é€çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody id="donateTableBody"></tbody>
              </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="donatePagination" class="border-t border-slate-200 px-4 py-3 flex items-center justify-between">
              <div class="text-sm text-slate-600">
                å…± <span id="donateTotal">0</span> æ¡è®°å½•ï¼Œç¬¬ <span id="donateCurrentPage">1</span> / <span id="donateTotalPages">1</span> é¡µ
              </div>
              <div class="flex gap-2">
                <button onclick="loadDonateRecords(donateCurrentPage - 1)" id="donatePrevBtn" class="px-3 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸Šä¸€é¡µ</button>
                <button onclick="loadDonateRecords(donateCurrentPage + 1)" id="donateNextBtn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é¡µ</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ç”¨æˆ·åˆ—è¡¨</h2>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-4">
            <button onclick="exportUsersData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ“¥ å¯¼å‡ºç”¨æˆ·æ•°æ®</button>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">#</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">ç”¨æˆ·å</th>
                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Linux Do ID</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">æŠ•å–‚æ¬¡æ•°</th>
                    <th class="px-4 py-3 text-center font-semibold text-slate-700">é¢†å–æ¬¡æ•°</th>
                    <th class="px-4 py-3 text-right font-semibold text-slate-700">æ€»è·å¾—é¢åº¦</th>
                  </tr>
                </thead>
                <tbody id="usersListBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `p-4 rounded-lg mb-4 ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    async function adminLogin() {
      const password = document.getElementById('password').value;
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          await loadAdminData();
        } else {
          const msg = document.getElementById('loginMessage');
          msg.textContent = data.message;
          msg.className = 'p-3 rounded-lg mb-4 bg-red-50 text-red-800 border border-red-200';
          msg.classList.remove('hidden');
        }
      } catch (e) {
        showMessage('ç™»å½•å¤±è´¥', 'error');
      }
    }

    async function loadAdminData() {
      await loadConfig();
      await loadClaimRecords();
      await loadDonateRecords();
      await loadKeysList();
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/admin/config');
        const data = await res.json();

        if (data.success) {
          const claimQuota = data.data.claim_quota;
          document.getElementById('claimQuota').value = claimQuota;
          document.getElementById('currentQuota').textContent = '$' + (claimQuota / 500000).toFixed(2);
          document.getElementById('quotaUSD').textContent = (claimQuota / 500000).toFixed(2);
          document.getElementById('maxDailyClaims').value = data.data.max_daily_claims || 1;
          document.getElementById('keysApiUrl').value = data.data.keys_api_url || '';
          document.getElementById('groupId').value = data.data.group_id || 26;
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
      }
    }

    // å®æ—¶è®¡ç®—ç¾å…ƒæ˜¾ç¤º
    document.addEventListener('DOMContentLoaded', () => {
      const claimQuotaInput = document.getElementById('claimQuota');
      if (claimQuotaInput) {
        claimQuotaInput.addEventListener('input', (e) => {
          const quota = parseInt(e.target.value) || 0;
          const usd = (quota / 500000).toFixed(2);
          const usdEl = document.getElementById('quotaUSD');
          if (usdEl) {
            usdEl.textContent = usd;
          }
        });
      }
    });

    async function updateQuota() {
      const quota = parseInt(document.getElementById('claimQuota').value);
      if (!quota || quota <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢åº¦å€¼', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/quota', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ claim_quota: quota }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateMaxDailyClaims() {
      const maxClaims = parseInt(document.getElementById('maxDailyClaims').value);
      if (!maxClaims || maxClaims <= 0) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢†å–æ¬¡æ•°', 'error');
        return;
      }
      if (maxClaims > 10) {
        showMessage('æ¯æ—¥é¢†å–æ¬¡æ•°ä¸èƒ½è¶…è¿‡10æ¬¡', 'error');
        return;
      }
      try {
        const res = await fetch('/api/admin/config/max-daily-claims', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_daily_claims: maxClaims }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) await loadConfig();
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateSession() {
      const session = document.getElementById('sessionValue').value.trim();
      try {
        const res = await fetch('/api/admin/config/session', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) document.getElementById('sessionValue').value = '';
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateKeysApiUrl() {
      const keys_api_url = document.getElementById('keysApiUrl').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-api-url', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_api_url }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateKeysAuthorization() {
      const keys_authorization = document.getElementById('keysAuthorization').value.trim();
      try {
        const res = await fetch('/api/admin/config/keys-authorization', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys_authorization }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
        if (data.success) document.getElementById('keysAuthorization').value = '';
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function updateGroupId() {
      const group_id = parseInt(document.getElementById('groupId').value);
      try {
        const res = await fetch('/api/admin/config/group-id', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ group_id }),
        });
        const data = await res.json();
        showMessage(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showMessage('æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function loadKeysList() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          document.getElementById('totalKeysCount').textContent = data.data.length;
          const tbody = document.getElementById('keysListBody');

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-slate-500">æš‚æ— Keys</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(item => `
            <tr class="border-b border-slate-100">
              <td class="px-4 py-3 font-mono text-xs">${item.key}</td>
              <td class="px-4 py-3">${item.username || '-'}</td>
              <td class="px-4 py-3">${new Date(item.timestamp).toLocaleString('zh-CN')}</td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error('åŠ è½½Keyså¤±è´¥', e);
      }
    }

    async function exportKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          const keys = data.data.map(item => item.key).join('\n');
          const blob = new Blob([keys], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `donated-keys-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          showMessage(`æˆåŠŸå¯¼å‡º ${data.data.length} ä¸ª Key`, 'success');
        }
      } catch (e) {
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    async function copyAllKeys() {
      try {
        const res = await fetch('/api/admin/keys/export');
        const data = await res.json();

        if (data.success) {
          const keys = data.data.map(item => item.key).join('\n');
          await navigator.clipboard.writeText(keys);
          showMessage(`æˆåŠŸå¤åˆ¶ ${data.data.length} ä¸ª Key`, 'success');
        }
      } catch (e) {
        showMessage('å¤åˆ¶å¤±è´¥', 'error');
      }
    }

    let claimCurrentPage = 1;
    const claimPageSize = 50;

    async function loadClaimRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/claim?page=${page}&pageSize=${claimPageSize}`);
        const data = await res.json();

        if (data.success) {
          claimCurrentPage = data.pagination.page;
          const tbody = document.getElementById('claimTableBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('claimCount').textContent = data.pagination.total;
          document.getElementById('claimTotal').textContent = data.pagination.total;
          document.getElementById('claimCurrentPage').textContent = data.pagination.page;
          document.getElementById('claimTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('claimPrevBtn').disabled = page === 1;
          document.getElementById('claimNextBtn').disabled = !data.pagination.hasMore;

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-500">æš‚æ— æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
              <td class="px-4 py-3">${r.username}</td>
              <td class="px-4 py-3 font-mono text-xs">${r.linux_do_id}</td>
              <td class="px-4 py-3 text-right font-semibold">$${(r.quota_added / 500000).toFixed(2)}</td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error('åŠ è½½é¢†å–è®°å½•å¤±è´¥', e);
      }
    }

    let donateCurrentPage = 1;
    const donatePageSize = 50;

    async function loadDonateRecords(page = 1) {
      if (page < 1) return;
      
      try {
        const res = await fetch(`/api/admin/records/donate?page=${page}&pageSize=${donatePageSize}`);
        const data = await res.json();

        if (data.success) {
          donateCurrentPage = data.pagination.page;
          const tbody = document.getElementById('donateTableBody');

          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          document.getElementById('donateCount').textContent = data.pagination.total;
          document.getElementById('donateTotal').textContent = data.pagination.total;
          document.getElementById('donateCurrentPage').textContent = data.pagination.page;
          document.getElementById('donateTotalPages').textContent = data.pagination.totalPages;

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('donatePrevBtn').disabled = page === 1;
          document.getElementById('donateNextBtn').disabled = !data.pagination.hasMore;

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">æš‚æ— æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(r => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="px-4 py-3">${new Date(r.timestamp).toLocaleString('zh-CN')}</td>
              <td class="px-4 py-3">${r.username}</td>
              <td class="px-4 py-3 text-center">${r.keys_count}</td>
              <td class="px-4 py-3 text-right font-semibold">$${(r.total_quota_added / 500000).toFixed(2)}</td>
              <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs ${r.push_status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${r.push_status === 'success' ? 'âœ“ æˆåŠŸ' : 'âœ• å¤±è´¥'}
                </span>
              </td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error('åŠ è½½æŠ•å–‚è®°å½•å¤±è´¥', e);
      }
    }

    async function loadUsersList() {
      try {
        const res = await fetch('/api/admin/users');
        const data = await res.json();

        if (data.success) {
          const tbody = document.getElementById('usersListBody');

          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">æš‚æ— ç”¨æˆ·</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map((user, index) => `
            <tr class="border-b border-slate-100">
              <td class="px-4 py-3">${index + 1}</td>
              <td class="px-4 py-3 font-semibold">${user.username}</td>
              <td class="px-4 py-3 font-mono text-xs">${user.linux_do_id}</td>
              <td class="px-4 py-3 text-center">${user.donate_count}</td>
              <td class="px-4 py-3 text-center">${user.claim_count}</td>
              <td class="px-4 py-3 text-right font-semibold">Â¥${(user.total_quota / 500000).toFixed(2)}</td>
            </tr>
          `).join('');
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', e);
      }
    }

    async function exportUsersData() {
      try {
        const link = document.createElement('a');
        link.href = '/api/admin/export/users';
        link.download = `users_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => showMessage('ç”¨æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success'), 500);
      } catch (e) {
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    function showSection(section) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
        link.classList.add('text-slate-700');
      });
      event.target.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
      event.target.classList.remove('text-slate-700');

      ['dashboard', 'config', 'keys', 'claims', 'donates', 'users'].forEach(s => {
        document.getElementById(s + 'Section').classList.add('hidden');
      });
      document.getElementById(section + 'Section').classList.remove('hidden');

      if (section === 'users') loadUsersList();
    }

    window.onload = async () => {
      try {
        const res = await fetch('/api/admin/config');
        if (res.ok) {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          await loadAdminData();
        }
      } catch (e) {
        console.log('éœ€è¦ç™»å½•');
      }
    };
  </script>
</body>
</html>

